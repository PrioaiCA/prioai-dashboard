<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile Picture | Prio AI</title>
    <link rel="icon" type="image/png" href="/assets/favicon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600&family=Plus+Jakarta+Sans:wght@600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/assets/styles.css">
    <link rel="stylesheet" href="/assets/auth.css">
    <style>
        .setup-page {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--space-6);
            background: var(--bg-primary);
        }
        .setup-card {
            width: 100%;
            max-width: 480px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-secondary);
            border-radius: var(--radius-xl);
            padding: var(--space-8);
            text-align: center;
        }
        @media (min-width: 640px) {
            .setup-card { padding: var(--space-10); }
        }
        .setup-step {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            background: var(--accent-muted);
            color: var(--accent);
            font-size: var(--text-xs);
            font-weight: 600;
            padding: var(--space-1) var(--space-3);
            border-radius: 999px;
            margin-bottom: var(--space-5);
        }
        .setup-card h1 {
            font-family: var(--font-heading);
            font-size: var(--text-2xl);
            font-weight: 700;
            margin-bottom: var(--space-2);
        }
        .setup-card .subtitle {
            font-size: var(--text-sm);
            color: var(--text-secondary);
            margin-bottom: var(--space-8);
        }

        /* Avatar upload area */
        .avatar-upload {
            position: relative;
            width: 140px;
            height: 140px;
            margin: 0 auto var(--space-6);
        }
        .avatar-preview {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            border: 3px dashed var(--border-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            cursor: pointer;
            transition: all var(--transition-base);
        }
        .avatar-preview:hover {
            border-color: var(--accent);
            background: var(--accent-muted);
        }
        .avatar-preview.has-image {
            border-style: solid;
            border-color: var(--accent);
        }
        .avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .avatar-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-2);
            color: var(--text-tertiary);
        }
        .avatar-placeholder svg {
            width: 40px;
            height: 40px;
            stroke: var(--text-tertiary);
            fill: none;
        }
        .avatar-placeholder span {
            font-size: var(--text-xs);
            font-weight: 500;
        }
        .avatar-preview:hover .avatar-placeholder svg { stroke: var(--accent); }
        .avatar-preview:hover .avatar-placeholder span { color: var(--accent); }
        .avatar-preview:hover .avatar-placeholder { color: var(--accent); }

        .avatar-edit-badge {
            position: absolute;
            bottom: 4px;
            right: 4px;
            width: 36px;
            height: 36px;
            background: var(--accent);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 3px solid var(--bg-secondary);
        }
        .avatar-edit-badge svg {
            width: 16px;
            height: 16px;
            stroke: #000;
            fill: none;
        }

        .avatar-hint {
            font-size: var(--text-xs);
            color: var(--text-tertiary);
            margin-bottom: var(--space-6);
        }

        .setup-actions {
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
        }
        .btn-continue {
            width: 100%;
            padding: var(--space-3) var(--space-5);
            font-size: var(--text-sm);
            font-weight: 600;
            border-radius: var(--radius-md);
            background: var(--accent);
            color: #000;
            transition: all var(--transition-fast);
        }
        .btn-continue:hover { background: var(--accent-hover); }
        .btn-continue:disabled { opacity: .5; cursor: not-allowed; }
        .btn-skip {
            width: 100%;
            padding: var(--space-3) var(--space-5);
            font-size: var(--text-sm);
            font-weight: 500;
            border-radius: var(--radius-md);
            color: var(--text-tertiary);
            transition: all var(--transition-fast);
        }
        .btn-skip:hover { color: var(--text-primary); background: var(--bg-tertiary); }

        .upload-status {
            font-size: var(--text-sm);
            margin-bottom: var(--space-4);
            min-height: 20px;
        }

        /* Crop modal */
        .crop-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,.8);
            backdrop-filter: blur(4px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: var(--space-5);
        }
        .crop-overlay.active { display: flex; }
        .crop-modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-xl);
            padding: var(--space-6);
            max-width: 400px;
            width: 100%;
        }
        .crop-modal h3 {
            font-size: var(--text-lg);
            font-weight: 600;
            margin-bottom: var(--space-4);
            text-align: center;
        }
        .crop-container {
            width: 100%;
            aspect-ratio: 1;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            overflow: hidden;
            margin-bottom: var(--space-4);
            position: relative;
        }
        .crop-container canvas {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .crop-actions {
            display: flex;
            gap: var(--space-3);
        }
        .crop-actions button {
            flex: 1;
            padding: var(--space-3);
            font-size: var(--text-sm);
            font-weight: 500;
            border-radius: var(--radius-md);
        }
        .crop-cancel {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-primary);
        }
        .crop-cancel:hover { background: var(--bg-elevated); }
        .crop-save {
            background: var(--accent);
            color: #000;
            font-weight: 600;
        }
        .crop-save:hover { background: var(--accent-hover); }
        .crop-save:disabled { opacity: .5; cursor: not-allowed; }
    </style>
</head>
<body>
    <main class="setup-page">
        <div class="setup-card">
            <img src="/assets/logo_white.png" alt="Prio AI" class="auth-logo">
            <div class="setup-step">Step 3 of 6</div>
            <h1>Add a profile picture</h1>
            <p class="subtitle">Help your team recognize you. You can always change this later in settings.</p>

            <div class="avatar-upload">
                <div class="avatar-preview" id="avatarPreview">
                    <div class="avatar-placeholder" id="avatarPlaceholder">
                        <svg viewBox="0 0 24 24" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                        <span>Click to upload</span>
                    </div>
                </div>
                <div class="avatar-edit-badge" id="editBadge" style="display:none;">
                    <svg viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                </div>
            </div>
            <p class="avatar-hint">JPG, PNG, or GIF â€” max 5 MB</p>

            <input type="file" id="photoInput" accept="image/*" style="display:none;">

            <div class="upload-status" id="uploadStatus"></div>

            <div class="setup-actions">
                <button class="btn-continue" id="continueBtn" style="display:none;">Continue</button>
                <button class="btn-continue" id="uploadAndContinueBtn" style="display:none;">Upload & Continue</button>
                <button class="btn-skip" id="skipBtn">Skip for now</button>
                <button class="btn-skip" id="backBtn" style="color:var(--text-tertiary);">Back</button>
            </div>
        </div>
    </main>

    <!-- Crop Modal -->
    <div class="crop-overlay" id="cropOverlay">
        <div class="crop-modal">
            <h3>Crop your photo</h3>
            <div class="crop-container">
                <canvas id="cropCanvas"></canvas>
            </div>
            <div class="crop-actions">
                <button class="crop-cancel" id="cropCancel">Cancel</button>
                <button class="crop-save" id="cropSave">Save</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
    var savedTheme = localStorage.getItem('theme') || 'dark';
    document.documentElement.setAttribute('data-theme', savedTheme);

    var SUPABASE_URL = "https://bflmikgoafdffezrfpgb.supabase.co";
    var SUPABASE_KEY = "sb_publishable_e4DbIJ2T-9QAMtXzYo4o8Q_x135R40k";
    var sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    var currentUser = null;
    var croppedBlob = null;

    // Auth guard
    sb.auth.getSession().then(function(res) {
        if (!res.data.session) {
            window.location.href = '/login/';
            return;
        }
        currentUser = res.data.session.user;
        // If user already has a profile picture, show it
        var existing = currentUser.user_metadata?.profile_picture;
        if (existing) {
            showPreviewImage(existing);
            document.getElementById('continueBtn').style.display = '';
        }
    });

    // Elements
    var preview = document.getElementById('avatarPreview');
    var placeholder = document.getElementById('avatarPlaceholder');
    var editBadge = document.getElementById('editBadge');
    var photoInput = document.getElementById('photoInput');
    var uploadBtn = document.getElementById('uploadAndContinueBtn');
    var continueBtn = document.getElementById('continueBtn');
    var skipBtn = document.getElementById('skipBtn');
    var statusEl = document.getElementById('uploadStatus');
    var cropOverlay = document.getElementById('cropOverlay');
    var cropCanvas = document.getElementById('cropCanvas');
    var cropSaveBtn = document.getElementById('cropSave');
    var cropCancelBtn = document.getElementById('cropCancel');

    // Click to upload
    preview.addEventListener('click', function() { photoInput.click(); });
    editBadge.addEventListener('click', function() { photoInput.click(); });

    // File selected
    photoInput.addEventListener('change', function() {
        if (!this.files || !this.files[0]) return;
        var file = this.files[0];
        if (file.size > 5 * 1024 * 1024) {
            statusEl.innerHTML = '<span style="color:#ef4444">Image too large (max 5 MB)</span>';
            return;
        }
        var reader = new FileReader();
        reader.onload = function(e) { openCropModal(e.target.result); };
        reader.readAsDataURL(file);
    });

    // Crop modal
    var sourceImage = null;
    function openCropModal(src) {
        cropOverlay.classList.add('active');
        sourceImage = new Image();
        sourceImage.onload = function() { drawCrop(); };
        sourceImage.src = src;
    }

    function drawCrop() {
        var ctx = cropCanvas.getContext('2d');
        var size = Math.min(sourceImage.width, sourceImage.height);
        var sx = (sourceImage.width - size) / 2;
        var sy = (sourceImage.height - size) / 2;
        cropCanvas.width = 400;
        cropCanvas.height = 400;
        ctx.drawImage(sourceImage, sx, sy, size, size, 0, 0, 400, 400);
    }

    cropCancelBtn.addEventListener('click', function() {
        cropOverlay.classList.remove('active');
        photoInput.value = '';
    });

    cropSaveBtn.addEventListener('click', function() {
        // Create 200x200 output
        var outCanvas = document.createElement('canvas');
        outCanvas.width = 200;
        outCanvas.height = 200;
        var ctx = outCanvas.getContext('2d');
        var size = Math.min(sourceImage.width, sourceImage.height);
        var sx = (sourceImage.width - size) / 2;
        var sy = (sourceImage.height - size) / 2;
        ctx.drawImage(sourceImage, sx, sy, size, size, 0, 0, 200, 200);

        outCanvas.toBlob(function(blob) {
            croppedBlob = blob;
            var url = URL.createObjectURL(blob);
            showPreviewImage(url);
            cropOverlay.classList.remove('active');

            // Show upload button, hide continue
            uploadBtn.style.display = '';
            continueBtn.style.display = 'none';
            statusEl.innerHTML = '';
        }, 'image/jpeg', 0.9);
    });

    function showPreviewImage(url) {
        placeholder.style.display = 'none';
        var existing = preview.querySelector('img');
        if (existing) existing.remove();
        var img = document.createElement('img');
        img.src = url;
        img.alt = 'Profile';
        preview.appendChild(img);
        preview.classList.add('has-image');
        editBadge.style.display = '';
    }

    // Upload & Continue
    uploadBtn.addEventListener('click', async function() {
        if (!croppedBlob || !currentUser) return;
        uploadBtn.disabled = true;
        uploadBtn.textContent = 'Uploading...';
        statusEl.innerHTML = '<span style="color:rgb(52,211,153)">Uploading your photo...</span>';

        try {
            var fileName = 'avatars/' + currentUser.id + '_' + Date.now() + '.jpg';
            var uploadResult = await sb.storage.from('profile-pictures').upload(fileName, croppedBlob, {
                contentType: 'image/jpeg',
                upsert: true
            });
            if (uploadResult.error) throw uploadResult.error;

            var urlData = sb.storage.from('profile-pictures').getPublicUrl(fileName);
            var publicUrl = urlData.data.publicUrl;

            // Delete old avatar
            var oldUrl = currentUser.user_metadata?.profile_picture;
            if (oldUrl && oldUrl.includes('profile-pictures')) {
                var oldPath = oldUrl.split('profile-pictures/')[1];
                if (oldPath) await sb.storage.from('profile-pictures').remove([oldPath]);
            }

            // Save to user metadata
            var updateResult = await sb.auth.updateUser({ data: { profile_picture: publicUrl } });
            if (updateResult.error) throw updateResult.error;

            statusEl.innerHTML = '<span style="color:rgb(52,211,153)">Photo saved!</span>';
            window.location.href = '/pricing/';
        } catch (err) {
            console.error('Upload error:', err);
            statusEl.innerHTML = '<span style="color:#ef4444">Upload failed: ' + (err.message || 'Unknown error') + '</span>';
            uploadBtn.disabled = false;
            uploadBtn.textContent = 'Upload & Continue';
        }
    });

    // Continue (already has picture)
    continueBtn.addEventListener('click', function() {
        window.location.href = '/pricing/';
    });

    // Skip
    skipBtn.addEventListener('click', function() {
        window.location.href = '/pricing/';
    });

    // Back
    document.getElementById('backBtn').addEventListener('click', function() {
        window.location.href = '/onboarding/';
    });
    </script>
</body>
</html>
