<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Prio AI Dashboard - Manage your leads and grow your business.">
    <title>Dashboard | Prio AI</title>
    <link rel="icon" type="image/png" href="/assets/favicon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Outfit:wght@600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/assets/styles.css">
    <style>
        /* Critical inline styles for immediate rendering */
        .stats-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:1rem;margin-bottom:2rem}
        @media(min-width:768px){.stats-grid{grid-template-columns:repeat(4,1fr)}}
        .stat-card{background:#111;border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:1.25rem;display:flex;align-items:center;gap:1rem}
        .stat-card.accent{background:rgba(52,211,153,0.1);border-color:rgb(52,211,153)}
        .stat-icon{font-size:1.5rem}
        .stat-value{font-size:1.5rem;font-weight:700;line-height:1}
        .stat-label{font-size:0.75rem;color:rgba(255,255,255,0.6);text-transform:uppercase}
        .quick-actions{display:grid;grid-template-columns:repeat(2,1fr);gap:0.75rem;margin-bottom:2rem}
        @media(min-width:768px){.quick-actions{grid-template-columns:repeat(4,1fr)}}
        .quick-action{display:flex;flex-direction:column;align-items:center;gap:0.5rem;padding:1.25rem;background:#111;border:1px solid rgba(255,255,255,0.1);border-radius:12px;color:#fff;cursor:pointer}
        .quick-action:hover{border-color:rgb(52,211,153);background:rgba(52,211,153,0.1)}
        .quick-action-icon{font-size:1.5rem}
        .quick-action-text{font-size:0.875rem;font-weight:500}
        .welcome-banner{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:2rem;flex-wrap:wrap;gap:1rem}
        .welcome-text h2{font-size:1.5rem;margin-bottom:0.5rem}
        .welcome-text p{color:rgba(255,255,255,0.7)}
        .welcome-date{font-size:0.875rem;color:rgba(255,255,255,0.5);background:#111;padding:0.5rem 1rem;border-radius:8px}
        .section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem}
        .section-header h3{font-size:1.125rem;font-weight:600}
        .prio-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:1.5rem;flex-wrap:wrap;gap:1rem}
        .prio-filters{display:flex;gap:0.5rem;margin-bottom:1.25rem;flex-wrap:wrap}
        .prio-filter{padding:0.5rem 1rem;font-size:0.875rem;font-weight:500;color:rgba(255,255,255,0.7);background:#111;border:1px solid rgba(255,255,255,0.1);border-radius:8px;cursor:pointer}
        .prio-filter.active{background:rgb(52,211,153);border-color:rgb(52,211,153);color:#000}
        .prio-list{display:flex;flex-direction:column;gap:0.75rem}
        .prio-card{background:#111;border:1px solid rgba(255,255,255,0.1);border-radius:12px;overflow:hidden;cursor:pointer;transition:all 0.2s}
        .prio-card:hover{border-color:rgb(52,211,153);transform:translateY(-2px);box-shadow:0 4px 20px rgba(52,211,153,0.1)}
        .prio-card-header{display:flex;align-items:center;gap:1rem;padding:1.25rem}
        .prio-rank{width:32px;height:32px;background:rgba(52,211,153,0.15);color:rgb(52,211,153);border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:0.875rem;flex-shrink:0}
        .prio-lead-info{flex:1;min-width:0}
        .prio-name{font-weight:600;font-size:1rem;margin-bottom:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .prio-meta{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
        .prio-phone{font-size:0.8125rem;color:rgba(255,255,255,0.6)}
        .prio-status{font-size:0.6875rem;padding:3px 8px;border-radius:4px;font-weight:500;text-transform:uppercase;letter-spacing:0.02em}
        .prio-status.status-booked,.prio-status.status-callback{background:rgba(52,211,153,0.15);color:rgb(52,211,153)}
        .prio-status.status-interested,.prio-status.status-timeline{background:rgba(59,130,246,0.15);color:#3B82F6}
        .prio-status.status-follow-up,.prio-status.status-new{background:rgba(245,158,11,0.15);color:#f59e0b}
        .prio-next-call{text-align:right;flex-shrink:0}
        .next-call-label{display:block;font-size:0.6875rem;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:0.03em;margin-bottom:2px}
        .next-call-value{font-size:0.8125rem;font-weight:500;color:rgb(52,211,153)}
        .prio-arrow{font-size:1.5rem;color:rgba(255,255,255,0.3);margin-left:8px;transition:transform 0.2s}
        .prio-card:hover .prio-arrow{transform:translateX(4px);color:rgb(52,211,153)}
        .prio-card-body{padding:0 1.25rem 1.25rem;border-top:1px solid rgba(255,255,255,0.05);margin-top:-4px;padding-top:1rem}
        .prio-summary,.prio-notes{font-size:0.8125rem;color:rgba(255,255,255,0.6);line-height:1.5;margin-bottom:8px}
        .prio-summary:last-child,.prio-notes:last-child{margin-bottom:0}
        .summary-label,.notes-label{color:rgba(255,255,255,0.4);font-weight:500}
        @media(max-width:640px){.prio-card-header{flex-wrap:wrap}.prio-next-call{width:100%;text-align:left;margin-top:8px;padding-top:8px;border-top:1px solid rgba(255,255,255,0.05)}.prio-arrow{display:none}}
        .spinner{width:32px;height:32px;border:3px solid rgba(255,255,255,0.1);border-top-color:rgb(52,211,153);border-radius:50%;animation:spin 0.8s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
        .overview-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:1rem;margin-bottom:2rem}
        @media(min-width:768px){.overview-grid{grid-template-columns:repeat(4,1fr)}}
        .overview-card{background:#111;border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:1.25rem;cursor:pointer;transition:all 0.15s}
        .overview-card:hover{border-color:rgb(52,211,153);transform:translateY(-2px)}
        .overview-card.highlight{background:rgba(52,211,153,0.1);border-color:rgb(52,211,153)}
        .overview-card-header{display:flex;align-items:center;gap:0.5rem;margin-bottom:0.75rem}
        .overview-card-header h4{font-size:0.875rem;font-weight:600;color:rgba(255,255,255,0.8)}
        .overview-card-icon{font-size:1rem}
        .overview-card-value{font-size:2rem;font-weight:700;margin-bottom:0.25rem}
        .overview-card-desc{font-size:0.75rem;color:rgba(255,255,255,0.5)}
        .meetings-list{display:flex;flex-direction:column;gap:0.5rem}
        .meetings-empty{text-align:center;padding:2rem;color:rgba(255,255,255,0.5);background:#111;border-radius:12px}
        .meeting-card{background:#111;border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:1rem;display:flex;align-items:center;gap:1rem}
        .meeting-time{background:rgba(52,211,153,0.15);color:rgb(52,211,153);padding:0.5rem 0.75rem;border-radius:8px;font-weight:600;font-size:0.875rem}
        .meeting-info{flex:1}
        .meeting-name{font-weight:600;margin-bottom:0.25rem}
        .meeting-details{font-size:0.875rem;color:rgba(255,255,255,0.6)}
        .prio-empty{text-align:center;padding:3rem;color:rgba(255,255,255,0.5)}
        
        /* Profile Menu */
        .profile-menu{position:absolute;bottom:100%;left:0;right:0;background:#151515;border:1px solid rgba(255,255,255,0.1);border-radius:12px;margin:0 0.5rem 0.5rem;padding:0.5rem;opacity:0;visibility:hidden;transform:translateY(10px);transition:all 0.2s}
        .profile-menu.active{opacity:1;visibility:visible;transform:translateY(0)}
        .profile-menu-item{display:flex;align-items:center;gap:0.75rem;padding:0.75rem 1rem;border-radius:8px;cursor:pointer;font-size:0.875rem;color:rgba(255,255,255,0.8);transition:all 0.15s}
        .profile-menu-item:hover{background:rgba(255,255,255,0.05)}
        .profile-menu-item.logout{color:#ef4444}
        .profile-menu-item.logout:hover{background:rgba(239,68,68,0.1)}
        .profile-menu-divider{height:1px;background:rgba(255,255,255,0.1);margin:0.5rem 0}
        
        /* Notifications Popup */
        .notifications-popup{position:absolute;bottom:100%;right:0;width:280px;background:#151515;border:1px solid rgba(255,255,255,0.1);border-radius:12px;margin-bottom:0.5rem;opacity:0;visibility:hidden;transform:translateY(10px);transition:all 0.2s}
        .notifications-popup.active{opacity:1;visibility:visible;transform:translateY(0)}
        .notifications-header{padding:1rem;border-bottom:1px solid rgba(255,255,255,0.1);font-weight:600;font-size:0.875rem}
        .notifications-empty{padding:2rem;text-align:center;color:rgba(255,255,255,0.5);font-size:0.875rem}
        
        .sidebar-footer{position:relative}
        
        /* Settings Page */
        .settings-card{background:#111;border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:1.5rem;margin-bottom:1rem}
        .settings-card.danger{border-color:rgba(239,68,68,0.3)}
        .settings-title{font-size:1rem;font-weight:600;margin-bottom:1rem}
        .profile-header{display:flex;align-items:center;gap:1.5rem;flex-wrap:wrap}
        .profile-avatar-lg{width:80px;height:80px;border-radius:50%;background:rgb(52,211,153);display:flex;align-items:center;justify-content:center;font-size:2rem;font-weight:600;color:#000;overflow:hidden;flex-shrink:0}
        .profile-avatar-lg img{width:100%;height:100%;object-fit:cover}
        .profile-info h2{font-size:1.25rem;margin-bottom:0.25rem}
        .profile-info p{color:rgba(255,255,255,0.6);font-size:0.875rem;margin-bottom:0.75rem}
        .profile-actions{display:flex;gap:0.5rem}
        .form-row{display:grid;grid-template-columns:1fr;gap:1rem;margin-bottom:1rem}
        @media(min-width:640px){.form-row{grid-template-columns:repeat(2,1fr)}}
        .form-group{margin-bottom:1rem}
        .form-group:last-child{margin-bottom:0}
        .form-group label{display:block;font-size:0.875rem;font-weight:500;color:rgba(255,255,255,0.7);margin-bottom:0.5rem}
        .form-group input,.form-group select{width:100%;padding:0.75rem 1rem;background:#1a1a1a;border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:#fff;font-size:0.9375rem}
        .form-group input:focus,.form-group select:focus{outline:none;border-color:rgb(52,211,153)}
        .form-group input::placeholder{color:rgba(255,255,255,0.4)}
        .form-message{font-size:0.875rem;padding:0.75rem;border-radius:8px;margin-bottom:1rem;display:none}
        .form-message:not(:empty){display:block}
        .form-message.success{background:rgba(52,211,153,0.1);color:rgb(52,211,153);border:1px solid rgba(52,211,153,0.3)}
        .form-message.error{background:rgba(239,68,68,0.1);color:#ef4444;border:1px solid rgba(239,68,68,0.3)}
        
        /* Synced Input Styles */
        .sync-badge{font-size:0.625rem;background:rgba(52,211,153,0.15);color:rgb(52,211,153);padding:2px 6px;border-radius:4px;margin-left:8px}
        .input-synced{background:#0a0a0a !important;color:rgba(255,255,255,0.5) !important;cursor:not-allowed}
        .sync-notice{font-size:0.75rem;color:rgba(255,255,255,0.4);margin:8px 0 16px;padding:10px 12px;background:rgba(52,211,153,0.05);border-radius:6px;border-left:3px solid rgb(52,211,153)}
        
        /* Billing Styles */
        .billing-plan-card{background:#0a0a0a;border-radius:10px;padding:20px}
        .billing-plan-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:12px}
        .billing-plan-info{display:flex;align-items:center;gap:12px}
        .billing-plan-name{font-size:1.25rem;font-weight:600;color:rgb(52,211,153)}
        .billing-status-badge{padding:4px 10px;border-radius:6px;font-size:0.75rem;font-weight:500}
        .billing-status-badge.active{background:rgba(52,211,153,0.15);color:rgb(52,211,153)}
        .billing-status-badge.paused{background:rgba(245,158,11,0.15);color:#f59e0b}
        .billing-plan-price{display:flex;align-items:baseline;gap:2px}
        .price-amount{font-size:1.5rem;font-weight:700}
        .price-period{font-size:0.875rem;color:rgba(255,255,255,0.5)}
        .billing-plan-details{display:flex;gap:24px;margin-bottom:16px;flex-wrap:wrap}
        .billing-detail{display:flex;flex-direction:column;gap:4px}
        .detail-label{font-size:0.75rem;color:rgba(255,255,255,0.4)}
        .detail-value{font-size:0.9rem;font-weight:500}
        .billing-payment-card{display:flex;align-items:center;gap:16px;background:#0a0a0a;border-radius:10px;padding:16px 20px}
        .payment-icon{font-size:1.5rem}
        .payment-details{flex:1}
        .payment-brand{font-weight:600;font-size:0.9rem;display:block}
        .payment-number{font-size:0.8rem;color:rgba(255,255,255,0.5)}
        .billing-usage{background:#0a0a0a;border-radius:10px;padding:20px}
        .usage-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:12px;text-align:center}
        .usage-value{font-size:1.5rem;font-weight:700;display:block}
        .usage-label{font-size:0.75rem;color:rgba(255,255,255,0.4)}
        .usage-bar{height:8px;background:#1a1a1a;border-radius:4px;overflow:hidden}
        .usage-fill{height:100%;background:linear-gradient(90deg,rgb(52,211,153),#8B5CF6);border-radius:4px;transition:width 0.3s}
        .billing-history{max-height:200px;overflow-y:auto}
        .billing-actions{display:flex;gap:12px;flex-wrap:wrap}
        
        /* Help Styles */
        .help-search{position:relative;margin-bottom:20px}
        .help-search input{width:100%;padding:12px 16px 12px 44px;background:#0a0a0a;border:1px solid rgba(255,255,255,0.1);border-radius:10px;color:#fff;font-size:0.9375rem}
        .help-search input:focus{outline:none;border-color:rgb(52,211,153)}
        .help-search-icon{position:absolute;left:16px;top:50%;transform:translateY(-50%);opacity:0.5}
        .help-quick-links{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;margin-bottom:24px}
        .help-quick-link{padding:12px;background:#0a0a0a;border:1px solid rgba(255,255,255,0.1);border-radius:8px;text-align:center;font-size:0.8125rem;cursor:pointer;transition:all 0.2s}
        .help-quick-link:hover{border-color:rgb(52,211,153);background:rgba(52,211,153,0.05)}
        .help-category{background:#111;border:1px solid rgba(255,255,255,0.1);border-radius:10px;margin-bottom:12px;overflow:hidden}
        .help-category-header{display:flex;align-items:center;gap:12px;padding:16px;cursor:pointer;transition:background 0.2s}
        .help-category-header:hover{background:rgba(255,255,255,0.03)}
        .help-category-icon{font-size:1.25rem}
        .help-category-title{flex:1;font-weight:600}
        .help-category-arrow{color:rgba(255,255,255,0.4);transition:transform 0.2s}
        .help-category.open .help-category-arrow{transform:rotate(180deg)}
        .help-category-content{display:none;border-top:1px solid rgba(255,255,255,0.1)}
        .help-category.open .help-category-content{display:block}
        .help-item{border-bottom:1px solid rgba(255,255,255,0.05)}
        .help-item:last-child{border-bottom:none}
        .help-item-header{display:flex;align-items:center;gap:12px;padding:14px 16px;cursor:pointer}
        .help-item-header:hover{background:rgba(52,211,153,0.03)}
        .help-question{flex:1;font-size:0.9rem}
        .help-toggle{color:rgb(52,211,153);font-size:1.25rem}
        .help-item.open .help-toggle{transform:rotate(45deg)}
        .help-answer{display:none;padding:0 16px 16px;color:rgba(255,255,255,0.7);font-size:0.875rem;line-height:1.6}
        .help-item.open .help-answer{display:block}
        .help-answer ul{margin:8px 0 8px 20px}
        .help-answer li{margin-bottom:6px}
        .help-support{display:flex;align-items:center;gap:16px;margin-bottom:16px}
        .help-support-icon{font-size:2rem}
        .help-support h4{margin-bottom:4px}
        .help-support-actions{display:flex;gap:12px;flex-wrap:wrap}
        
        @media(max-width:640px){
            .usage-stats{grid-template-columns:1fr}
            .billing-plan-details{flex-direction:column;gap:12px}
            .billing-actions{flex-direction:column}
            .billing-actions .btn{width:100%}
            .help-support-actions{flex-direction:column}
            .help-support-actions .btn{width:100%}
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar Overlay (mobile) -->
        <div class="sidebar-overlay" id="sidebarOverlay"></div>

        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <img src="/assets/logo_white.png" alt="Prio AI" class="sidebar-logo logo-dark">
                <img src="/assets/logo_black.png" alt="Prio AI" class="sidebar-logo logo-light" style="display:none;">
                <button class="sidebar-close" id="sidebarClose">&times;</button>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-item active" data-page="overview">
                        <span class="nav-item-icon">üìä</span>
                        <span>Overview</span>
                    </div>
                    <div class="nav-item" data-page="prio">
                        <span class="nav-item-icon">‚ö°</span>
                        <span>PRIO</span>
                    </div>
                    <div class="nav-item" data-page="prospects">
                        <span class="nav-item-icon">üìã</span>
                        <span>Prospects</span>
                    </div>
                    <div class="nav-item" data-page="pipeline">
                        <span class="nav-item-icon">ü§ñ</span>
                        <span>AI Pipeline</span>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Tools</div>
                    <div class="nav-item" data-page="import">
                        <span class="nav-item-icon">üì•</span>
                        <span>Import Leads</span>
                    </div>
                    <div class="nav-item" data-page="search">
                        <span class="nav-item-icon">üîç</span>
                        <span>Search</span>
                    </div>
                    <div class="nav-item" data-page="analytics">
                        <span class="nav-item-icon">üìà</span>
                        <span>Analytics</span>
                    </div>
                </div>

<!-- Account section moved to profile popup -->
            </nav>

            <div class="sidebar-footer">
                <!-- Profile Menu (slides up) -->
                <div class="profile-menu" id="profileMenu">
                    <div class="profile-menu-item" data-page="settings">
                        <span>‚öôÔ∏è</span> Settings
                    </div>
                    <div class="profile-menu-item" data-page="billing">
                        <span>üí≥</span> Billing
                    </div>
                    <div class="profile-menu-item" data-page="help">
                        <span>‚ùì</span> Help
                    </div>
                    <div class="profile-menu-divider"></div>
                    <div class="profile-menu-item logout" id="sidebarLogout">
                        <span>üö™</span> Sign Out
                    </div>
                </div>
                
                <!-- Notifications Popup -->
                <div class="notifications-popup" id="notificationsPopup">
                    <div class="notifications-header">
                        <span>Notifications</span>
                    </div>
                    <div class="notifications-empty">
                        No new notifications
                    </div>
                </div>
                
                <div class="sidebar-footer-row">
                    <div class="user-card" id="userCard">
                        <div class="user-avatar" id="userAvatar">U</div>
                        <div class="user-info">
                            <div class="user-name" id="userName">Guest</div>
                            <div class="user-email" id="userEmail">Not signed in</div>
                        </div>
                    </div>
                    <button class="notification-btn" id="notificationBtn" title="Notifications">
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                            <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                        </svg>
                        <span class="notification-badge" id="notificationBadge" style="display:none;">0</span>
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="header">
                <div class="header-left">
                    <button class="menu-toggle" id="menuToggle">
                        <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none">
                            <line x1="3" y1="12" x2="21" y2="12"></line>
                            <line x1="3" y1="6" x2="21" y2="6"></line>
                            <line x1="3" y1="18" x2="21" y2="18"></line>
                        </svg>
                    </button>
                    <h1 class="header-title" id="pageTitle">Overview</h1>
                </div>
                <div class="header-right">
                    <button class="header-btn" id="themeToggle" title="Toggle theme">
                        <svg class="sun-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                        <svg class="moon-icon" viewBox="0 0 24 24" style="display:none;"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                    </button>
                    <button class="btn btn-primary btn-sm" id="loginBtn">Sign In</button>
                </div>
            </header>

            <div class="page-content">
                <!-- Loading State -->
                <div class="loading" id="loadingState">
                    <div class="spinner"></div>
                    <p class="text-muted">Loading...</p>
                </div>

                <!-- Guest State -->
                <div id="guestState" class="hidden">
                    <div class="card" style="max-width: 500px; margin: 0 auto; text-align: center;">
                        <h2 style="margin-bottom: var(--space-4);">Welcome to Prio AI</h2>
                        <p style="color: var(--text-secondary); margin-bottom: var(--space-6);">Sign in to access your dashboard and start converting more leads.</p>
                        <button class="btn btn-primary btn-lg" id="guestLoginBtn">Get Started</button>
                    </div>
                </div>

                <!-- Dashboard Content -->
                <div id="dashboardContent" class="hidden">
                    <!-- Page: Overview -->
                    <div class="page" id="page-overview">
                        <!-- Welcome Banner -->
                        <div class="welcome-banner">
                            <div class="welcome-text">
                                <h2>Welcome back, <span id="welcomeName">there</span> üëã</h2>
                                <p>Here's what's happening with your leads today.</p>
                            </div>
                            <div class="welcome-date" id="welcomeDate"></div>
                        </div>

                        <!-- Stats Grid -->
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-icon">üìã</div>
                                <div class="stat-content">
                                    <div class="stat-value" id="statProspects">-</div>
                                    <div class="stat-label">Total Prospects</div>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon">üìû</div>
                                <div class="stat-content">
                                    <div class="stat-value" id="statCalls">-</div>
                                    <div class="stat-label">Calls Made</div>
                                </div>
                            </div>
                            <div class="stat-card accent">
                                <div class="stat-icon">üìÖ</div>
                                <div class="stat-content">
                                    <div class="stat-value" id="statAppointments">-</div>
                                    <div class="stat-label">Appointments Booked</div>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon">üìà</div>
                                <div class="stat-content">
                                    <div class="stat-value" id="statConversion">-</div>
                                    <div class="stat-label">Conversion Rate</div>
                                </div>
                            </div>
                        </div>

                        <!-- Overview Cards -->
                        <div class="overview-grid">
                            <div class="overview-card" onclick="switchPage('prio')">
                                <div class="overview-card-header">
                                    <span class="overview-card-icon">‚ö°</span>
                                    <h4>PRIO Leads</h4>
                                </div>
                                <div class="overview-card-value" id="overviewPrio">0</div>
                                <div class="overview-card-desc">Priority leads to focus on</div>
                            </div>
                            <div class="overview-card" onclick="switchPage('prospects')">
                                <div class="overview-card-header">
                                    <span class="overview-card-icon">üìã</span>
                                    <h4>Prospects</h4>
                                </div>
                                <div class="overview-card-value" id="overviewProspects">0</div>
                                <div class="overview-card-desc">Total leads in your database</div>
                            </div>
                            <div class="overview-card" onclick="switchPage('pipeline')">
                                <div class="overview-card-header">
                                    <span class="overview-card-icon">ü§ñ</span>
                                    <h4>AI Pipeline</h4>
                                </div>
                                <div class="overview-card-value" id="overviewPipeline">0</div>
                                <div class="overview-card-desc">Leads being called by AI</div>
                            </div>
                            <div class="overview-card highlight" onclick="switchPage('meetings')">
                                <div class="overview-card-header">
                                    <span class="overview-card-icon">üìÖ</span>
                                    <h4>Today's Meetings</h4>
                                </div>
                                <div class="overview-card-value" id="overviewMeetings">0</div>
                                <div class="overview-card-desc">Callbacks scheduled for today</div>
                            </div>
                        </div>

                        <!-- Today's Meetings List -->
                        <div class="section-header">
                            <h3>Today's Callbacks</h3>
                        </div>
                        <div class="meetings-list" id="todayMeetings">
                            <div class="meetings-empty">
                                <p>No callbacks scheduled for today</p>
                            </div>
                        </div>
                    </div>

                    <!-- Page: PRIO -->
                    <div class="page hidden" id="page-prio">
                        <!-- PRIO Header -->
                        <div class="prio-header">
                            <div class="prio-header-text">
                                <h2>‚ö° PRIO Leads</h2>
                                <p>Your priority leads ranked by engagement. Focus here first.</p>
                            </div>
                            <div class="prio-header-stats">
                                <div class="prio-stat">
                                    <span class="prio-stat-value" id="prioCount">0</span>
                                    <span class="prio-stat-label">Priority Leads</span>
                                </div>
                            </div>
                        </div>

                        <!-- PRIO List -->
                        <div class="prio-list" id="prioList">
                            <div class="prio-empty">No priority leads yet</div>
                        </div>
                    </div>

                    <!-- Page: Prospects -->
                    <div class="page hidden" id="page-prospects">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Prospects</h3>
                                <button class="btn btn-primary btn-sm">+ Add Lead</button>
                            </div>
                            <p class="text-muted">Your prospects will appear here.</p>
                        </div>
                    </div>

                    <!-- Page: Pipeline -->
                    <div class="page hidden" id="page-pipeline">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">AI Pipeline</h3>
                            </div>
                            <p class="text-muted">Your AI calling pipeline will appear here.</p>
                        </div>
                    </div>

                    <!-- Page: Analytics -->
                    <div class="page hidden" id="page-analytics">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Analytics</h3>
                            </div>
                            <p class="text-muted">Your analytics and reports will appear here.</p>
                        </div>
                    </div>

                    <!-- Page: Import -->
                    <div class="page hidden" id="page-import">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Import Leads</h3>
                            </div>
                            <p class="text-muted">Upload CSV or Excel files to import leads.</p>
                        </div>
                    </div>

                    <!-- Page: Search -->
                    <div class="page hidden" id="page-search">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Search</h3>
                            </div>
                            <p class="text-muted">Search across all your leads.</p>
                        </div>
                    </div>

                    <!-- Page: Settings -->
                    <div class="page hidden" id="page-settings">
                        <!-- Profile Card -->
                        <div class="settings-card">
                            <div class="profile-header">
                                <div class="profile-avatar-lg" id="settingsAvatar">
                                    <span id="settingsInitial">U</span>
                                </div>
                                <div class="profile-info">
                                    <h2 id="settingsName">-</h2>
                                    <p id="settingsEmail">-</p>
                                    <div class="profile-actions">
                                        <input type="file" id="settingsPhotoInput" accept="image/*" style="display:none;">
                                        <button class="btn btn-sm btn-secondary" id="settingsUploadBtn">Upload Photo</button>
                                        <button class="btn btn-sm btn-ghost" id="settingsRemoveBtn" style="display:none;">Remove</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Display Name -->
                        <div class="settings-card">
                            <h3 class="settings-title">Display Name</h3>
                            <form id="displayNameForm">
                                <div class="form-group">
                                    <label for="settingsDisplayName">How should we greet you?</label>
                                    <input type="text" id="settingsDisplayName" placeholder="e.g. Sahib">
                                </div>
                                <div class="form-message success" id="displaySuccess"></div>
                                <div class="form-message error" id="displayError"></div>
                                <button type="submit" class="btn btn-primary">Save</button>
                            </form>
                        </div>

                        <!-- Calling Preferences -->
                        <div class="settings-card">
                            <h3 class="settings-title">Calling Preferences</h3>
                            <form id="callingPrefsForm">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="settingsPhone">Your Phone Number <span class="sync-badge">üîÑ Synced</span></label>
                                        <input type="tel" id="settingsPhone" placeholder="+1 (555) 123-4567" readonly class="input-synced">
                                    </div>
                                    <div class="form-group">
                                        <label for="settingsCalendar">Calendar Email <span class="sync-badge">üîÑ Synced</span></label>
                                        <input type="email" id="settingsCalendar" placeholder="calendar@gmail.com" readonly class="input-synced">
                                    </div>
                                </div>
                                <p class="sync-notice">Phone and email are synced from your account. Contact support to update.</p>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="settingsStart">Available Start</label>
                                        <select id="settingsStart">
                                            <option value="8:00 AM">8:00 AM</option>
                                            <option value="9:00 AM" selected>9:00 AM</option>
                                            <option value="10:00 AM">10:00 AM</option>
                                            <option value="11:00 AM">11:00 AM</option>
                                            <option value="12:00 PM">12:00 PM</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="settingsEnd">Available End</label>
                                        <select id="settingsEnd">
                                            <option value="5:00 PM">5:00 PM</option>
                                            <option value="6:00 PM" selected>6:00 PM</option>
                                            <option value="7:00 PM">7:00 PM</option>
                                            <option value="8:00 PM">8:00 PM</option>
                                            <option value="9:00 PM">9:00 PM</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-message success" id="callingSuccess"></div>
                                <div class="form-message error" id="callingError"></div>
                                <button type="submit" class="btn btn-primary">Save Changes</button>
                            </form>
                        </div>

                        <!-- Change Password -->
                        <div class="settings-card">
                            <h3 class="settings-title">Change Password</h3>
                            <form id="passwordForm">
                                <div class="form-group">
                                    <label for="currentPassword">Current Password</label>
                                    <input type="password" id="currentPassword" placeholder="Enter your current password" required>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="newPassword">New Password</label>
                                        <input type="password" id="newPassword" placeholder="Min. 8 characters" minlength="8" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="confirmNewPassword">Confirm New Password</label>
                                        <input type="password" id="confirmNewPassword" placeholder="Confirm password" minlength="8" required>
                                    </div>
                                </div>
                                <div class="form-message success" id="passwordSuccess"></div>
                                <div class="form-message error" id="passwordError"></div>
                                <button type="submit" class="btn btn-secondary">Update Password</button>
                            </form>
                        </div>

                        <!-- Danger Zone -->
                        <div class="settings-card danger">
                            <h3 class="settings-title" style="color:#ef4444;">Danger Zone</h3>
                            <p class="text-muted" style="margin-bottom:1rem;">Need to pause or cancel your subscription?</p>
                            <button class="btn btn-secondary" onclick="window.location.href='mailto:info@prioai.ca?subject=Account Change Request'">Contact Support</button>
                        </div>
                    </div>

                    <!-- Page: Billing -->
                    <div class="page hidden" id="page-billing">
                        <!-- Current Plan -->
                        <div class="settings-card">
                            <h3 class="settings-title">Current Plan</h3>
                            <div class="billing-plan-card">
                                <div class="billing-plan-header">
                                    <div class="billing-plan-info">
                                        <span class="billing-plan-name" id="billingPlanName">Starter</span>
                                        <span class="billing-status-badge active" id="billingPlanStatus">Active</span>
                                    </div>
                                    <div class="billing-plan-price">
                                        <span class="price-amount" id="billingPlanPrice">$149</span>
                                        <span class="price-period">/month</span>
                                    </div>
                                </div>
                                <div class="billing-plan-details">
                                    <div class="billing-detail">
                                        <span class="detail-label">Call Limit</span>
                                        <span class="detail-value" id="billingCallLimit">1,000 calls/mo</span>
                                    </div>
                                    <div class="billing-detail">
                                        <span class="detail-label">Next Billing</span>
                                        <span class="detail-value" id="billingNextDate">-</span>
                                    </div>
                                </div>
                                <button class="btn btn-secondary btn-sm" id="upgradePlanBtn">Upgrade Plan</button>
                            </div>
                        </div>

                        <!-- Payment Method -->
                        <div class="settings-card">
                            <h3 class="settings-title">Payment Method</h3>
                            <div class="billing-payment-card" id="billingPaymentCard">
                                <div class="payment-icon">üí≥</div>
                                <div class="payment-details">
                                    <span class="payment-brand" id="paymentCardBrand">No payment method</span>
                                    <span class="payment-number" id="paymentCardNumber">Add a card to continue</span>
                                </div>
                                <button class="btn btn-secondary btn-sm" id="updatePaymentBtn">Add Card</button>
                            </div>
                        </div>

                        <!-- Usage This Month -->
                        <div class="settings-card">
                            <h3 class="settings-title">Usage This Month</h3>
                            <div class="billing-usage">
                                <div class="usage-stats">
                                    <div class="usage-stat">
                                        <span class="usage-value" id="billingUsageCalls">0</span>
                                        <span class="usage-label">Calls Made</span>
                                    </div>
                                    <div class="usage-stat">
                                        <span class="usage-value" id="billingUsageLimit">1,000</span>
                                        <span class="usage-label">Call Limit</span>
                                    </div>
                                    <div class="usage-stat">
                                        <span class="usage-value" id="billingUsagePercent">0%</span>
                                        <span class="usage-label">Used</span>
                                    </div>
                                </div>
                                <div class="usage-bar">
                                    <div class="usage-fill" id="billingUsageFill" style="width:0%"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Billing History -->
                        <div class="settings-card">
                            <h3 class="settings-title">Billing History</h3>
                            <div class="billing-history" id="billingHistoryList">
                                <p class="text-muted" style="text-align:center;padding:24px;">No billing history yet</p>
                            </div>
                            <button class="btn btn-secondary btn-sm" id="viewAllInvoicesBtn" style="margin-top:12px;">View All Invoices</button>
                        </div>

                        <!-- Actions -->
                        <div class="settings-card">
                            <div class="billing-actions">
                                <button class="btn btn-primary" id="manageBillingBtn">Manage Subscription</button>
                                <button class="btn btn-secondary" id="downloadReceiptBtn">Download Receipt</button>
                            </div>
                            <p id="billingStatus" class="text-muted" style="margin-top:12px;font-size:0.875rem;"></p>
                        </div>
                    </div>

                    <!-- Page: Help -->
                    <div class="page hidden" id="page-help">
                        <div class="settings-card">
                            <h3 class="settings-title">üìö Help Center</h3>
                            <p class="text-muted" style="margin-bottom:20px;">Everything you need to know about using Prio AI.</p>
                            
                            <!-- Search -->
                            <div class="help-search">
                                <span class="help-search-icon">üîç</span>
                                <input type="text" id="helpSearchInput" placeholder="Search for help topics...">
                            </div>
                            
                            <!-- Quick Links -->
                            <div class="help-quick-links">
                                <div class="help-quick-link" data-topic="getting-started">üöÄ Getting Started</div>
                                <div class="help-quick-link" data-topic="prio-leads">‚≠ê PRIO Leads</div>
                                <div class="help-quick-link" data-topic="ai-pipeline">ü§ñ AI Pipeline</div>
                                <div class="help-quick-link" data-topic="importing">üì• Importing</div>
                            </div>
                        </div>
                        
                        <!-- FAQ Categories -->
                        <div id="helpCategories">
                            <!-- Getting Started -->
                            <div class="help-category" data-category="getting-started">
                                <div class="help-category-header">
                                    <span class="help-category-icon">üöÄ</span>
                                    <span class="help-category-title">Getting Started</span>
                                    <span class="help-category-arrow">‚ñº</span>
                                </div>
                                <div class="help-category-content">
                                    <div class="help-item">
                                        <div class="help-item-header">
                                            <span class="help-question">How do I navigate the dashboard?</span>
                                            <span class="help-toggle">+</span>
                                        </div>
                                        <div class="help-answer">
                                            <p>The sidebar on the left has all your main sections:</p>
                                            <ul>
                                                <li><strong>Overview</strong> ‚Äì Your daily snapshot and quick actions</li>
                                                <li><strong>PRIO</strong> ‚Äì Priority leads needing immediate attention</li>
                                                <li><strong>Prospects</strong> ‚Äì All your leads in one searchable table</li>
                                                <li><strong>Pipeline</strong> ‚Äì Leads being nurtured by AI</li>
                                                <li><strong>Import</strong> ‚Äì Add new leads</li>
                                            </ul>
                                        </div>
                                    </div>
                                    <div class="help-item">
                                        <div class="help-item-header">
                                            <span class="help-question">What do the different lead statuses mean?</span>
                                            <span class="help-toggle">+</span>
                                        </div>
                                        <div class="help-answer">
                                            <ul>
                                                <li><strong>Booked</strong> ‚Äì Meeting scheduled with you</li>
                                                <li><strong>Callback</strong> ‚Äì Lead wants YOU to call them</li>
                                                <li><strong>Timeline</strong> ‚Äì Has a future buying timeline</li>
                                                <li><strong>Follow Up</strong> ‚Äì AI is continuing to nurture</li>
                                                <li><strong>Not Interested</strong> ‚Äì Declined or not a fit</li>
                                                <li><strong>DNC</strong> ‚Äì Do Not Call requested</li>
                                            </ul>
                                        </div>
                                    </div>
                                    <div class="help-item">
                                        <div class="help-item-header">
                                            <span class="help-question">How do I check my call usage?</span>
                                            <span class="help-toggle">+</span>
                                        </div>
                                        <div class="help-answer">
                                            <p>Your call usage is shown in the header at the top right. You can also see detailed usage in the <strong>Billing</strong> section.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- PRIO Leads -->
                            <div class="help-category" data-category="prio-leads">
                                <div class="help-category-header">
                                    <span class="help-category-icon">‚≠ê</span>
                                    <span class="help-category-title">PRIO Leads</span>
                                    <span class="help-category-arrow">‚ñº</span>
                                </div>
                                <div class="help-category-content">
                                    <div class="help-item">
                                        <div class="help-item-header">
                                            <span class="help-question">What is a PRIO lead?</span>
                                            <span class="help-toggle">+</span>
                                        </div>
                                        <div class="help-answer">
                                            <p>PRIO (Priority) leads are your hottest opportunities. The AI automatically marks leads as PRIO when they book a meeting or request a callback. You can also manually mark any lead as PRIO.</p>
                                        </div>
                                    </div>
                                    <div class="help-item">
                                        <div class="help-item-header">
                                            <span class="help-question">How do I mark a lead as PRIO?</span>
                                            <span class="help-toggle">+</span>
                                        </div>
                                        <div class="help-answer">
                                            <p>Click on any lead to open the detail view, then click the yellow <strong>‚≠ê PRIO</strong> button at the top.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- AI Pipeline -->
                            <div class="help-category" data-category="ai-pipeline">
                                <div class="help-category-header">
                                    <span class="help-category-icon">ü§ñ</span>
                                    <span class="help-category-title">AI Pipeline</span>
                                    <span class="help-category-arrow">‚ñº</span>
                                </div>
                                <div class="help-category-content">
                                    <div class="help-item">
                                        <div class="help-item-header">
                                            <span class="help-question">What is the AI Pipeline?</span>
                                            <span class="help-toggle">+</span>
                                        </div>
                                        <div class="help-answer">
                                            <p>The AI Pipeline shows leads being automatically nurtured by Sarah (our AI). These are leads with status "Timeline" or "Follow Up" who aren't ready to meet yet but are being kept warm.</p>
                                        </div>
                                    </div>
                                    <div class="help-item">
                                        <div class="help-item-header">
                                            <span class="help-question">How do I send a lead back to the AI?</span>
                                            <span class="help-toggle">+</span>
                                        </div>
                                        <div class="help-answer">
                                            <p>Open the lead detail view and click <strong>üîÑ Send Back to AI</strong>. Add notes first so the AI has context!</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Importing -->
                            <div class="help-category" data-category="importing">
                                <div class="help-category-header">
                                    <span class="help-category-icon">üì•</span>
                                    <span class="help-category-title">Importing Leads</span>
                                    <span class="help-category-arrow">‚ñº</span>
                                </div>
                                <div class="help-category-content">
                                    <div class="help-item">
                                        <div class="help-item-header">
                                            <span class="help-question">How do I add leads?</span>
                                            <span class="help-toggle">+</span>
                                        </div>
                                        <div class="help-answer">
                                            <p>Go to the <strong>Import</strong> section. You can add a single lead manually or upload a CSV file for bulk import.</p>
                                        </div>
                                    </div>
                                    <div class="help-item">
                                        <div class="help-item-header">
                                            <span class="help-question">What CSV format should I use?</span>
                                            <span class="help-toggle">+</span>
                                        </div>
                                        <div class="help-answer">
                                            <p>Download our template from the Import page. Required columns: First Name, Phone. Optional: Last Name, Email.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Troubleshooting -->
                            <div class="help-category" data-category="troubleshooting">
                                <div class="help-category-header">
                                    <span class="help-category-icon">üîß</span>
                                    <span class="help-category-title">Troubleshooting</span>
                                    <span class="help-category-arrow">‚ñº</span>
                                </div>
                                <div class="help-category-content">
                                    <div class="help-item">
                                        <div class="help-item-header">
                                            <span class="help-question">My lead isn't showing up?</span>
                                            <span class="help-toggle">+</span>
                                        </div>
                                        <div class="help-answer">
                                            <p>Check your filters! Make sure you're not filtering by a status that excludes them. Use the Search tab to find any lead by name or phone.</p>
                                        </div>
                                    </div>
                                    <div class="help-item">
                                        <div class="help-item-header">
                                            <span class="help-question">How do I contact support?</span>
                                            <span class="help-toggle">+</span>
                                        </div>
                                        <div class="help-answer">
                                            <p>Email us at <a href="mailto:info@prioai.ca" style="color:rgb(52,211,153);">info@prioai.ca</a> ‚Äì we typically respond within 24 hours.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Contact Support -->
                        <div class="settings-card" style="margin-top:24px;">
                            <div class="help-support">
                                <span class="help-support-icon">üí¨</span>
                                <div>
                                    <h4>Still need help?</h4>
                                    <p class="text-muted">Our team is here to support you</p>
                                </div>
                            </div>
                            <div class="help-support-actions">
                                <a href="mailto:info@prioai.ca?subject=Support Request" class="btn btn-primary">üìß Email Support</a>
                                <button class="btn btn-secondary" onclick="switchPage('feedback')">üí¨ Send Feedback</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Auth Modal -->
    <div class="modal-overlay" id="authModal">
        <div class="modal">
            <button class="modal-close" id="authModalClose">&times;</button>
            <div class="modal-content">
                <div class="modal-header">
                    <img src="/assets/logo_white.png" alt="Prio AI" class="modal-logo logo-dark">
                    <img src="/assets/logo_black.png" alt="Prio AI" class="modal-logo logo-light" style="display:none;">
                    <h2 id="authTitle">Welcome to Prio AI</h2>
                    <p id="authSubtitle">Sign in to your account</p>
                </div>

                <!-- Login Form -->
                <form id="loginForm">
                    <div class="form-group">
                        <label for="loginEmail">Email</label>
                        <input type="email" id="loginEmail" placeholder="you@example.com" required>
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                    </div>
                    <div class="form-error" id="loginError"></div>
                    <button type="submit" class="btn btn-primary btn-block btn-lg" id="loginSubmit">Sign In</button>
                </form>

                <!-- Signup Form (hidden by default) -->
                <form id="signupForm" class="hidden">
                    <div class="form-group">
                        <label for="signupName">Full Name</label>
                        <input type="text" id="signupName" placeholder="John Smith" required>
                    </div>
                    <div class="form-group">
                        <label for="signupEmail">Email</label>
                        <input type="email" id="signupEmail" placeholder="you@example.com" required>
                    </div>
                    <div class="form-group">
                        <label for="signupPassword">Password</label>
                        <input type="password" id="signupPassword" placeholder="Min. 8 characters" required minlength="8">
                    </div>
                    <div class="form-error" id="signupError"></div>
                    <div class="form-success" id="signupSuccess"></div>
                    <button type="submit" class="btn btn-primary btn-block btn-lg" id="signupSubmit">Create Account</button>
                </form>

                <div class="auth-divider"><span>or</span></div>

                <button class="btn btn-google btn-block" id="googleAuthBtn">
                    <svg viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                    Continue with Google
                </button>

                <div class="auth-footer">
                    <p id="authSwitch">Don't have an account? <a href="#" id="switchToSignup">Sign up</a></p>
                    <p style="margin-top: var(--space-2);"><a href="#" id="forgotPassword">Forgot password?</a></p>
                </div>
            </div>
        </div>
    </div>

<!-- User modal removed - using sidebar profile popup instead -->

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
    // Supabase Setup
    var SUPABASE_URL = "https://bflmikgoafdffezrfpgb.supabase.co";
    var SUPABASE_KEY = "sb_publishable_e4DbIJ2T-9QAMtXzYo4o8Q_x135R40k";
    var supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // State
    var currentUser = null;
    var currentPage = 'overview';

    // Elements
    var sidebar = document.getElementById('sidebar');
    var sidebarOverlay = document.getElementById('sidebarOverlay');
    var authModal = document.getElementById('authModal');
    // userModal removed
    var loginForm = document.getElementById('loginForm');
    var signupForm = document.getElementById('signupForm');

    // Toast
    function showToast(message, type) {
        var toast = document.createElement('div');
        toast.className = 'toast ' + (type || '');
        toast.textContent = message;
        document.getElementById('toastContainer').appendChild(toast);
        setTimeout(function() { toast.remove(); }, 4000);
    }

    // Theme
    (function() {
        var html = document.documentElement;
        var saved = localStorage.getItem('theme') || 'dark';
        html.setAttribute('data-theme', saved);
        updateThemeIcons();
        
        document.getElementById('themeToggle').addEventListener('click', function() {
            var next = html.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', next);
            localStorage.setItem('theme', next);
            updateThemeIcons();
        });
        
        function updateThemeIcons() {
            var isDark = html.getAttribute('data-theme') === 'dark';
            document.querySelectorAll('.sun-icon').forEach(function(el) { el.style.display = isDark ? 'block' : 'none'; });
            document.querySelectorAll('.moon-icon').forEach(function(el) { el.style.display = isDark ? 'none' : 'block'; });
            document.querySelectorAll('.logo-dark').forEach(function(el) { el.style.display = isDark ? 'block' : 'none'; });
            document.querySelectorAll('.logo-light').forEach(function(el) { el.style.display = isDark ? 'none' : 'block'; });
        }
    })();

    // Sidebar Toggle (mobile)
    document.getElementById('menuToggle').addEventListener('click', function() {
        sidebar.classList.add('open');
        sidebarOverlay.classList.add('active');
    });
    
    document.getElementById('sidebarClose').addEventListener('click', closeSidebar);
    sidebarOverlay.addEventListener('click', closeSidebar);
    
    function closeSidebar() {
        sidebar.classList.remove('open');
        sidebarOverlay.classList.remove('active');
    }

    // Navigation
    document.querySelectorAll('.nav-item[data-page]').forEach(function(item) {
        item.addEventListener('click', function() {
            switchPage(this.dataset.page);
            closeSidebar();
        });
    });

    function switchPage(page) {
        currentPage = page;
        
        // Update nav
        document.querySelectorAll('.nav-item').forEach(function(item) {
            item.classList.toggle('active', item.dataset.page === page);
        });
        
        // Update title
        var titles = {
            overview: 'Overview', prio: 'PRIO', prospects: 'Prospects', pipeline: 'AI Pipeline',
            analytics: 'Analytics', import: 'Import Leads', search: 'Search',
            settings: 'Settings', billing: 'Billing', help: 'Help'
        };
        document.getElementById('pageTitle').textContent = titles[page] || page;
        
        // Show page
        document.querySelectorAll('.page').forEach(function(p) { p.classList.add('hidden'); });
        var pageEl = document.getElementById('page-' + page);
        if (pageEl) pageEl.classList.remove('hidden');
        
        // Update hash
        window.location.hash = page;
    }

    // Auth Modal
    function openAuthModal(mode) {
        authModal.classList.add('active');
        if (mode === 'signup') {
            loginForm.classList.add('hidden');
            signupForm.classList.remove('hidden');
            document.getElementById('authTitle').textContent = 'Create Account';
            document.getElementById('authSubtitle').textContent = 'Start converting more leads';
            document.getElementById('authSwitch').innerHTML = 'Already have an account? <a href="#" id="switchToLogin">Sign in</a>';
            document.getElementById('switchToLogin').addEventListener('click', function(e) { e.preventDefault(); openAuthModal('login'); });
        } else {
            signupForm.classList.add('hidden');
            loginForm.classList.remove('hidden');
            document.getElementById('authTitle').textContent = 'Welcome to Prio AI';
            document.getElementById('authSubtitle').textContent = 'Sign in to your account';
            document.getElementById('authSwitch').innerHTML = "Don't have an account? <a href=\"#\" id=\"switchToSignup\">Sign up</a>";
            document.getElementById('switchToSignup').addEventListener('click', function(e) { e.preventDefault(); openAuthModal('signup'); });
        }
    }

    function closeAuthModal() {
        authModal.classList.remove('active');
        loginForm.reset();
        signupForm.reset();
        document.getElementById('loginError').textContent = '';
        document.getElementById('signupError').textContent = '';
        document.getElementById('signupSuccess').textContent = '';
    }

    document.getElementById('loginBtn').addEventListener('click', function() { openAuthModal('login'); });
    document.getElementById('guestLoginBtn').addEventListener('click', function() { openAuthModal('signup'); });
    document.getElementById('authModalClose').addEventListener('click', closeAuthModal);
    authModal.addEventListener('click', function(e) { if (e.target === authModal) closeAuthModal(); });

    // User card click handled by profile popup code below

    // Login
    loginForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        var btn = document.getElementById('loginSubmit');
        var err = document.getElementById('loginError');
        err.textContent = '';
        btn.disabled = true;
        btn.textContent = 'Signing in...';
        
        try {
            var result = await supabase.auth.signInWithPassword({
                email: document.getElementById('loginEmail').value,
                password: document.getElementById('loginPassword').value
            });
            if (result.error) throw result.error;
            closeAuthModal();
            checkAuth();
        } catch (ex) {
            err.textContent = ex.message || 'Login failed';
        }
        
        btn.disabled = false;
        btn.textContent = 'Sign In';
    });

    // Signup
    signupForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        var btn = document.getElementById('signupSubmit');
        var err = document.getElementById('signupError');
        var suc = document.getElementById('signupSuccess');
        err.textContent = '';
        suc.textContent = '';
        btn.disabled = true;
        btn.textContent = 'Creating account...';
        
        try {
            var result = await supabase.auth.signUp({
                email: document.getElementById('signupEmail').value,
                password: document.getElementById('signupPassword').value,
                options: {
                    data: { full_name: document.getElementById('signupName').value },
                    emailRedirectTo: window.location.origin
                }
            });
            if (result.error) throw result.error;
            if (result.data.user && !result.data.session) {
                suc.textContent = '‚úì Check your email to confirm your account';
                btn.textContent = 'Email Sent';
            } else {
                closeAuthModal();
                checkAuth();
            }
        } catch (ex) {
            err.textContent = ex.message || 'Signup failed';
            btn.disabled = false;
            btn.textContent = 'Create Account';
        }
    });

    // Google Auth
    document.getElementById('googleAuthBtn').addEventListener('click', function() {
        supabase.auth.signInWithOAuth({
            provider: 'google',
            options: { redirectTo: window.location.origin }
        });
    });

<!-- Old logout button removed -->
    
    // Sidebar logout
    document.getElementById('sidebarLogout').addEventListener('click', async function() {
        await supabase.auth.signOut();
        currentUser = null;
        document.getElementById('profileMenu').classList.remove('active');
        checkAuth();
        showToast('Signed out', 'success');
    });
    
    // Profile menu toggle
    document.getElementById('userCard').addEventListener('click', function(e) {
        e.stopPropagation();
        document.getElementById('notificationsPopup').classList.remove('active');
        document.getElementById('profileMenu').classList.toggle('active');
    });
    
    // Profile menu items
    document.querySelectorAll('.profile-menu-item[data-page]').forEach(function(item) {
        item.addEventListener('click', function() {
            switchPage(this.dataset.page);
            document.getElementById('profileMenu').classList.remove('active');
        });
    });
    
    // Notifications toggle
    document.getElementById('notificationBtn').addEventListener('click', function(e) {
        e.stopPropagation();
        document.getElementById('profileMenu').classList.remove('active');
        document.getElementById('notificationsPopup').classList.toggle('active');
    });
    
    // Close popups when clicking outside
    document.addEventListener('click', function() {
        document.getElementById('profileMenu').classList.remove('active');
        document.getElementById('notificationsPopup').classList.remove('active');
    });

    // Auth Check (returns promise)
    function checkAuth() {
        return (async function() {
        document.getElementById('loadingState').classList.remove('hidden');
        document.getElementById('guestState').classList.add('hidden');
        document.getElementById('dashboardContent').classList.add('hidden');
        
        var result = await supabase.auth.getSession();
        currentUser = result.data.session?.user || null;
        
        document.getElementById('loadingState').classList.add('hidden');
        
        if (currentUser) {
            var name = currentUser.user_metadata?.full_name || currentUser.user_metadata?.display_name || currentUser.email.split('@')[0];
            var avatar = currentUser.user_metadata?.profile_picture;
            
            document.getElementById('userName').textContent = name;
            document.getElementById('userEmail').textContent = currentUser.email;
            
            if (avatar) {
                document.getElementById('userAvatar').innerHTML = '<img src="' + avatar + '" alt="">';
            } else {
                document.getElementById('userAvatar').textContent = name.charAt(0).toUpperCase();
            }
            
            document.getElementById('loginBtn').classList.add('hidden');
            document.getElementById('dashboardContent').classList.remove('hidden');
        } else {
            document.getElementById('userName').textContent = 'Guest';
            document.getElementById('userEmail').textContent = 'Not signed in';
            document.getElementById('userAvatar').textContent = 'G';
            document.getElementById('loginBtn').classList.remove('hidden');
            document.getElementById('guestState').classList.remove('hidden');
        }
        })();
    }

    // Airtable Config
    var _a = ['cGF0N0c3SURnT2lSNnJiTFEuM2E5ZGIyMmM1MTcwYjkwMzA1Yjc1MDRhNjNlNjkzM2JkNTQwMTFiMDI4YWMzODRmM2QyOWU5YWQ3YmNkYzBjMw=='];
    var AIRTABLE_TOKEN = atob(_a[0]);
    var AIRTABLE_BASE = 'applOjDjhH0RqLtBH';
    var AIRTABLE_CLIENTS_TABLE = 'tblMptC862PyL7Znw';
    var AIRTABLE_LEADS_TABLE = 'tblLpN4wceakfNFpq';
    
    var currentUserRecord = null;
    var allLeads = [];

    // Update welcome date
    function updateWelcomeDate() {
        var now = new Date();
        var options = { weekday: 'long', month: 'long', day: 'numeric' };
        document.getElementById('welcomeDate').textContent = now.toLocaleDateString('en-US', options);
    }
    updateWelcomeDate();

    // Only fetch fields we actually use
    var LEAD_FIELDS = ['Full Name', 'First Name', 'Last Name', 'Phone', 'Email', 'Status', 'Disposition', 'Is Prio', 'Summary', 'Call Summary', 'AI Summary', 'Agent Notes', 'Your Notes', 'Notes', 'Next AI Call', 'Next Call', 'Follow Up Date', 'Last Call Timestamp', 'Callback Date', 'Call Count', 'Call Status'].map(function(f) { return 'fields[]=' + encodeURIComponent(f); }).join('&');
    
    // Try to load cached data first for instant display
    function loadCachedData() {
        try {
            var cached = sessionStorage.getItem('prio_leads_' + currentUser.email);
            if (cached) {
                var data = JSON.parse(cached);
                if (Date.now() - data.timestamp < 60000) { // Cache valid for 1 minute
                    allLeads = data.leads;
                    updateDashboard();
                    updatePrioList();
                    return true;
                }
            }
        } catch (e) {}
        return false;
    }
    
    function cacheData() {
        try {
            sessionStorage.setItem('prio_leads_' + currentUser.email, JSON.stringify({
                timestamp: Date.now(),
                leads: allLeads
            }));
        } catch (e) {}
    }

    // Load user data from Airtable
    async function loadUserData() {
        if (!currentUser) return;
        
        // Show cached data immediately if available
        var hasCached = loadCachedData();
        
        // Show loading state only if no cache
        if (!hasCached) {
            document.getElementById('statProspects').textContent = '...';
            document.getElementById('statCalls').textContent = '...';
            document.getElementById('statAppointments').textContent = '...';
            document.getElementById('statConversion').textContent = '...';
        }
        
        try {
            var filterFormula = encodeURIComponent('({Email} = "' + currentUser.email + '")');
            var response = await fetch('https://api.airtable.com/v0/' + AIRTABLE_BASE + '/' + AIRTABLE_CLIENTS_TABLE + '?filterByFormula=' + filterFormula, {
                headers: { 'Authorization': 'Bearer ' + AIRTABLE_TOKEN }
            });
            var data = await response.json();
            
            if (data.records && data.records.length > 0) {
                currentUserRecord = data.records[0];
                loadLeadsData();
            } else {
                document.getElementById('statProspects').textContent = '0';
                document.getElementById('statCalls').textContent = '0';
                document.getElementById('statAppointments').textContent = '0';
                document.getElementById('statConversion').textContent = '0%';
                document.getElementById('prioList').innerHTML = '<div class="prio-empty">No leads yet. Import some to get started!</div>';
            }
        } catch (err) {
            console.error('Failed to load user data:', err);
            if (!hasCached) {
                document.getElementById('statProspects').textContent = '0';
                document.getElementById('statCalls').textContent = '0';
                document.getElementById('statAppointments').textContent = '0';
                document.getElementById('statConversion').textContent = '0%';
            }
        }
    }

    // Load leads data with optimizations
    async function loadLeadsData() {
        if (!currentUserRecord) return;
        
        try {
            var email = currentUser.email.toLowerCase();
            var filterFormula = 'FIND("' + email + '", LOWER(ARRAYJOIN({Client Email})))';
            var baseUrl = 'https://api.airtable.com/v0/' + AIRTABLE_BASE + '/' + AIRTABLE_LEADS_TABLE + '?' + LEAD_FIELDS + '&filterByFormula=' + encodeURIComponent(filterFormula) + '&pageSize=100';
            
            allLeads = [];
            var offset = null;
            var isFirstPage = true;
            
            do {
                var fetchUrl = baseUrl + (offset ? '&offset=' + offset : '');
                var response = await fetch(fetchUrl, { headers: { 'Authorization': 'Bearer ' + AIRTABLE_TOKEN } });
                var data = await response.json();
                
                if (data.records) {
                    allLeads = allLeads.concat(data.records);
                }
                offset = data.offset;
                
                // Render after first page so user sees data fast
                if (isFirstPage && allLeads.length > 0) {
                    isFirstPage = false;
                    updateDashboard();
                    updatePrioList();
                }
            } while (offset);
            
            // Final update with all data & cache it
            updateDashboard();
            updatePrioList();
            cacheData();
        } catch (err) {
            console.error('Failed to load leads:', err);
        }
    }
    
    function updateDashboard() {
        updateStats();
    }

    // Update stats
    function updateStats() {
        var totalProspects = allLeads.length;
        document.getElementById('statProspects').textContent = totalProspects;
        document.getElementById('overviewProspects').textContent = totalProspects;
        
        var callsMade = allLeads.filter(function(l) { return l.fields['Call Count'] > 0; }).length;
        document.getElementById('statCalls').textContent = callsMade;
        
        var appointments = allLeads.filter(function(l) { 
            return l.fields['Disposition'] === 'Appointment Booked' || l.fields['Booking Status'] === 'Booked';
        }).length;
        document.getElementById('statAppointments').textContent = appointments;
        
        var convRate = totalProspects > 0 ? Math.round((appointments / totalProspects) * 100) : 0;
        document.getElementById('statConversion').textContent = convRate + '%';
        
        // PRIO leads (Is Prio = true from Airtable)
        var prioLeads = allLeads.filter(function(l) {
            return l.fields['Is Prio'] === true;
        });
        document.getElementById('overviewPrio').textContent = prioLeads.length;
        
        // AI Pipeline (leads in queue)
        var pipelineLeads = allLeads.filter(function(l) {
            var status = l.fields['Call Status'] || l.fields['Status'] || '';
            return status === 'Queued' || status === 'In Progress' || status === 'Retry';
        });
        document.getElementById('overviewPipeline').textContent = pipelineLeads.length;
        
        // Today's meetings (callbacks scheduled for today)
        var today = new Date().toISOString().split('T')[0];
        var todayMeetings = allLeads.filter(function(l) {
            var callbackDate = l.fields['Callback Date'] || l.fields['Follow Up Date'] || '';
            return callbackDate && callbackDate.startsWith(today);
        });
        document.getElementById('overviewMeetings').textContent = todayMeetings.length;
        updateTodayMeetings(todayMeetings);
        
        // Update welcome name
        var name = currentUser?.user_metadata?.full_name || currentUser?.user_metadata?.display_name || 'there';
        document.getElementById('welcomeName').textContent = name.split(' ')[0];
    }
    
    // Update today's meetings list
    function updateTodayMeetings(meetings) {
        var list = document.getElementById('todayMeetings');
        if (meetings.length === 0) {
            list.innerHTML = '<div class="meetings-empty"><p>No callbacks scheduled for today</p></div>';
            return;
        }
        
        list.innerHTML = meetings.map(function(lead) {
            var f = lead.fields;
            var name = f['Full Name'] || (f['First Name'] + ' ' + (f['Last Name'] || ''));
            var phone = f['Phone'] || '-';
            var time = f['Callback Time'] || 'TBD';
            
            return '<div class="meeting-card">' +
                '<div class="meeting-time">' + escapeHtml(time) + '</div>' +
                '<div class="meeting-info">' +
                    '<div class="meeting-name">' + escapeHtml(name) + '</div>' +
                    '<div class="meeting-details">' + escapeHtml(phone) + '</div>' +
                '</div>' +
                '<button class="btn btn-sm btn-primary" onclick="alert(\'Call feature coming soon\')">Call</button>' +
            '</div>';
        }).join('');
    }

    // Update PRIO list
    function updatePrioList() {
        var prioList = document.getElementById('prioList');
        
        // Get leads where Is Prio = true, sorted by priority score
        var prioLeads = allLeads.filter(function(l) {
            return l.fields['Is Prio'] === true;
        }).map(function(l) {
            var d = l.fields['Disposition'] || l.fields['Status'] || '';
            var score = 0;
            if (d === 'Booked' || d === 'Appointment Booked') score = 95;
            else if (d === 'Callback' || d === 'Callback Requested') score = 90;
            else if (d === 'Interested') score = 85;
            else if (d === 'Timeline') score = 70;
            else if (d === 'Follow Up') score = 60;
            else score = 50;
            l._score = score;
            return l;
        }).sort(function(a, b) {
            return b._score - a._score;
        });
        
        document.getElementById('prioCount').textContent = prioLeads.length;
        
        if (prioLeads.length === 0) {
            prioList.innerHTML = '<div class="prio-empty">No priority leads yet. Import some leads to get started!</div>';
            return;
        }
        
        prioList.innerHTML = prioLeads.map(function(lead, index) {
            var f = lead.fields;
            var name = f['Full Name'] || ((f['First Name'] || '') + ' ' + (f['Last Name'] || '')).trim() || 'Unknown';
            var phone = f['Phone'] || '-';
            var status = f['Status'] || f['Disposition'] || 'New';
            var nextCall = f['Next AI Call'] || f['Next Call'] || f['Follow Up Date'] || null;
            var summary = f['Summary'] || f['Call Summary'] || f['AI Summary'] || '';
            var notes = f['Agent Notes'] || f['Your Notes'] || f['Notes'] || '';
            
            // Format next call date
            var nextCallDisplay = '-';
            if (nextCall) {
                var d = new Date(nextCall);
                var today = new Date();
                var tomorrow = new Date(today);
                tomorrow.setDate(tomorrow.getDate() + 1);
                if (d.toDateString() === today.toDateString()) nextCallDisplay = 'Today ' + d.toLocaleTimeString('en-US', {hour: 'numeric', minute: '2-digit'});
                else if (d.toDateString() === tomorrow.toDateString()) nextCallDisplay = 'Tomorrow ' + d.toLocaleTimeString('en-US', {hour: 'numeric', minute: '2-digit'});
                else nextCallDisplay = d.toLocaleDateString('en-US', {month: 'short', day: 'numeric'}) + ' ' + d.toLocaleTimeString('en-US', {hour: 'numeric', minute: '2-digit'});
            }
            
            // Truncate summary and notes
            var summaryTrunc = summary.length > 120 ? summary.substring(0, 120) + '...' : summary;
            var notesTrunc = notes.length > 80 ? notes.substring(0, 80) + '...' : notes;
            
            return '<div class="prio-card" data-id="' + lead.id + '">' +
                '<div class="prio-card-header">' +
                    '<div class="prio-rank">' + (index + 1) + '</div>' +
                    '<div class="prio-lead-info">' +
                        '<div class="prio-name">' + escapeHtml(name) + '</div>' +
                        '<div class="prio-meta">' +
                            '<span class="prio-phone">üìû ' + escapeHtml(phone) + '</span>' +
                            '<span class="prio-status status-' + status.toLowerCase().replace(/\s+/g, '-') + '">' + escapeHtml(status) + '</span>' +
                        '</div>' +
                    '</div>' +
                    '<div class="prio-next-call">' +
                        '<span class="next-call-label">Next Call</span>' +
                        '<span class="next-call-value">' + nextCallDisplay + '</span>' +
                    '</div>' +
                    '<div class="prio-arrow">‚Ä∫</div>' +
                '</div>' +
                (summary || notes ? '<div class="prio-card-body">' +
                    (summary ? '<div class="prio-summary"><span class="summary-label">ü§ñ Summary:</span> ' + escapeHtml(summaryTrunc) + '</div>' : '') +
                    (notes ? '<div class="prio-notes"><span class="notes-label">üìù Notes:</span> ' + escapeHtml(notesTrunc) + '</div>' : '') +
                '</div>' : '') +
            '</div>';
        }).join('');
    }

    // Helpers
    function escapeHtml(text) {
        if (!text) return '';
        var div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function formatTimeAgo(dateStr) {
        if (!dateStr) return '';
        var date = new Date(dateStr);
        var now = new Date();
        var diff = Math.floor((now - date) / 1000);
        
        if (diff < 60) return 'Just now';
        if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
        if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
        if (diff < 604800) return Math.floor(diff / 86400) + 'd ago';
        return date.toLocaleDateString();
    }

    // Settings - populate profile info
    function updateSettingsProfile() {
        if (!currentUser) return;
        var name = currentUser.user_metadata?.full_name || currentUser.user_metadata?.display_name || currentUser.email.split('@')[0];
        var avatar = currentUser.user_metadata?.profile_picture;
        
        document.getElementById('settingsName').textContent = name;
        document.getElementById('settingsEmail').textContent = currentUser.email;
        document.getElementById('settingsDisplayName').value = currentUser.user_metadata?.display_name || '';
        
        if (avatar) {
            document.getElementById('settingsAvatar').innerHTML = '<img src="' + avatar + '" alt="">';
            document.getElementById('settingsRemoveBtn').style.display = 'inline-flex';
        } else {
            document.getElementById('settingsInitial').textContent = name.charAt(0).toUpperCase();
            document.getElementById('settingsRemoveBtn').style.display = 'none';
        }
        
        // Populate from Airtable client record
        if (currentUserRecord && currentUserRecord.fields) {
            var f = currentUserRecord.fields;
            document.getElementById('settingsPhone').value = f['Phone'] || '';
            document.getElementById('settingsCalendar').value = f['Google Calendar Email'] || '';
            if (f['Available Start']) document.getElementById('settingsStart').value = f['Available Start'];
            if (f['Available End']) document.getElementById('settingsEnd').value = f['Available End'];
        }
    }

    // Display Name form
    document.getElementById('displayNameForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        var btn = this.querySelector('button');
        var suc = document.getElementById('displaySuccess');
        var err = document.getElementById('displayError');
        suc.textContent = ''; err.textContent = '';
        btn.disabled = true; btn.textContent = 'Saving...';
        
        try {
            var displayName = document.getElementById('settingsDisplayName').value.trim();
            var result = await supabase.auth.updateUser({ data: { display_name: displayName } });
            if (result.error) throw result.error;
            suc.textContent = '‚úì Display name updated';
            document.getElementById('userName').textContent = displayName || currentUser.email.split('@')[0];
            document.getElementById('settingsName').textContent = displayName || currentUser.email.split('@')[0];
        } catch (ex) {
            err.textContent = ex.message || 'Failed to save';
        }
        btn.disabled = false; btn.textContent = 'Save';
    });

    // Calling Preferences form
    document.getElementById('callingPrefsForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        var btn = this.querySelector('button');
        var suc = document.getElementById('callingSuccess');
        var err = document.getElementById('callingError');
        suc.textContent = ''; err.textContent = '';
        btn.disabled = true; btn.textContent = 'Saving...';
        
        try {
            if (!currentUserRecord) throw new Error('No client record found');
            var response = await fetch('https://api.airtable.com/v0/' + AIRTABLE_BASE + '/' + AIRTABLE_CLIENTS_TABLE + '/' + currentUserRecord.id, {
                method: 'PATCH',
                headers: { 'Authorization': 'Bearer ' + AIRTABLE_TOKEN, 'Content-Type': 'application/json' },
                body: JSON.stringify({ fields: {
                    'Phone': document.getElementById('settingsPhone').value,
                    'Google Calendar Email': document.getElementById('settingsCalendar').value,
                    'Available Start': document.getElementById('settingsStart').value,
                    'Available End': document.getElementById('settingsEnd').value
                }})
            });
            if (!response.ok) throw new Error('Failed to update');
            suc.textContent = '‚úì Preferences saved';
        } catch (ex) {
            err.textContent = ex.message || 'Failed to save';
        }
        btn.disabled = false; btn.textContent = 'Save Changes';
    });

    // Password form
    document.getElementById('passwordForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        var btn = this.querySelector('button');
        var suc = document.getElementById('passwordSuccess');
        var err = document.getElementById('passwordError');
        suc.textContent = ''; err.textContent = '';
        
        var currentPass = document.getElementById('currentPassword').value;
        var newPass = document.getElementById('newPassword').value;
        var confirmPass = document.getElementById('confirmNewPassword').value;
        
        if (!currentPass) {
            err.textContent = 'Please enter your current password';
            return;
        }
        if (newPass !== confirmPass) {
            err.textContent = 'New passwords do not match';
            return;
        }
        if (newPass.length < 8) {
            err.textContent = 'New password must be at least 8 characters';
            return;
        }
        if (currentPass === newPass) {
            err.textContent = 'New password must be different from current';
            return;
        }
        
        btn.disabled = true; btn.textContent = 'Verifying...';
        
        try {
            // Verify current password
            var verifyResult = await supabase.auth.signInWithPassword({
                email: currentUser.email,
                password: currentPass
            });
            if (verifyResult.error) throw new Error('Current password is incorrect');
            
            btn.textContent = 'Updating...';
            var result = await supabase.auth.updateUser({ password: newPass });
            if (result.error) throw result.error;
            suc.textContent = '‚úì Password updated successfully';
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmNewPassword').value = '';
        } catch (ex) {
            err.textContent = ex.message || 'Failed to update password';
        }
        btn.disabled = false; btn.textContent = 'Update Password';
    });

    // Photo upload
    document.getElementById('settingsUploadBtn').addEventListener('click', function() {
        document.getElementById('settingsPhotoInput').click();
    });
    
    document.getElementById('settingsPhotoInput').addEventListener('change', async function() {
        if (!this.files || !this.files[0]) return;
        var file = this.files[0];
        if (file.size > 5 * 1024 * 1024) { showToast('Image too large (max 5MB)', 'error'); return; }
        
        // Simple base64 upload for now
        var reader = new FileReader();
        reader.onload = async function(e) {
            try {
                // Resize to 200x200
                var img = new Image();
                img.onload = async function() {
                    var canvas = document.createElement('canvas');
                    canvas.width = 200; canvas.height = 200;
                    var ctx = canvas.getContext('2d');
                    var size = Math.min(img.width, img.height);
                    var x = (img.width - size) / 2;
                    var y = (img.height - size) / 2;
                    ctx.drawImage(img, x, y, size, size, 0, 0, 200, 200);
                    var resized = canvas.toDataURL('image/jpeg', 0.85);
                    
                    var result = await supabase.auth.updateUser({ data: { profile_picture: resized } });
                    if (result.error) throw result.error;
                    
                    document.getElementById('settingsAvatar').innerHTML = '<img src="' + resized + '" alt="">';
                    document.getElementById('userAvatar').innerHTML = '<img src="' + resized + '" alt="">';
                    document.getElementById('settingsRemoveBtn').style.display = 'inline-flex';
                    showToast('Photo updated', 'success');
                };
                img.src = e.target.result;
            } catch (ex) {
                showToast('Failed to upload photo', 'error');
            }
        };
        reader.readAsDataURL(file);
    });
    
    document.getElementById('settingsRemoveBtn').addEventListener('click', async function() {
        try {
            var result = await supabase.auth.updateUser({ data: { profile_picture: null } });
            if (result.error) throw result.error;
            var name = currentUser.user_metadata?.display_name || currentUser.email.split('@')[0];
            document.getElementById('settingsAvatar').innerHTML = '<span id="settingsInitial">' + name.charAt(0).toUpperCase() + '</span>';
            document.getElementById('userAvatar').textContent = name.charAt(0).toUpperCase();
            this.style.display = 'none';
            showToast('Photo removed', 'success');
        } catch (ex) {
            showToast('Failed to remove photo', 'error');
        }
    });

    // Init
    checkAuth().then(function() {
        if (currentUser) {
            loadUserData().then(function() {
                updateSettingsProfile();
                populateBilling();
            });
        }
    });
    
    // Handle hash
    var hash = window.location.hash.slice(1);
    if (hash && document.getElementById('page-' + hash)) {
        switchPage(hash);
    }
    
    // === HELP SECTION ===
    // Category accordions
    document.querySelectorAll('.help-category-header').forEach(function(header) {
        header.addEventListener('click', function() {
            this.parentElement.classList.toggle('open');
        });
    });
    
    // Item accordions
    document.querySelectorAll('.help-item-header').forEach(function(header) {
        header.addEventListener('click', function() {
            this.parentElement.classList.toggle('open');
        });
    });
    
    // Quick links
    document.querySelectorAll('.help-quick-link').forEach(function(link) {
        link.addEventListener('click', function() {
            var topic = this.dataset.topic;
            var category = document.querySelector('.help-category[data-category="' + topic + '"]');
            if (category) {
                category.classList.add('open');
                category.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        });
    });
    
    // Help search
    var helpSearchInput = document.getElementById('helpSearchInput');
    if (helpSearchInput) {
        helpSearchInput.addEventListener('input', function() {
            var query = this.value.toLowerCase().trim();
            var categories = document.querySelectorAll('.help-category');
            
            if (!query) {
                categories.forEach(function(cat) { cat.style.display = ''; cat.classList.remove('open'); });
                return;
            }
            
            categories.forEach(function(cat) {
                var text = cat.textContent.toLowerCase();
                if (text.includes(query)) {
                    cat.style.display = '';
                    cat.classList.add('open');
                } else {
                    cat.style.display = 'none';
                }
            });
        });
    }
    
    // === BILLING SECTION ===
    // Populate billing data
    function populateBilling() {
        if (!currentUserRecord) return;
        var f = currentUserRecord.fields;
        
        var plan = f['Monthly Plan'] || 'Starter';
        var rate = parseFloat(f['Monthly Rate']) || 0;
        var callLimit = parseInt(f['Call Limit']) || (plan === 'Professional' ? 3000 : 1000);
        var callsUsed = parseInt(f['Calls This Month']) || 0;
        var status = f['Status'] || 'Active';
        
        var planNameEl = document.getElementById('billingPlanName');
        var planPriceEl = document.getElementById('billingPlanPrice');
        var callLimitEl = document.getElementById('billingCallLimit');
        var statusEl = document.getElementById('billingPlanStatus');
        var nextDateEl = document.getElementById('billingNextDate');
        var usageCallsEl = document.getElementById('billingUsageCalls');
        var usageLimitEl = document.getElementById('billingUsageLimit');
        var usagePercentEl = document.getElementById('billingUsagePercent');
        var usageFillEl = document.getElementById('billingUsageFill');
        
        if (planNameEl) planNameEl.textContent = plan;
        if (planPriceEl) planPriceEl.textContent = rate > 0 ? '$' + rate : 'Free';
        if (callLimitEl) callLimitEl.textContent = callLimit.toLocaleString() + ' calls/mo';
        if (statusEl) {
            statusEl.textContent = status;
            statusEl.className = 'billing-status-badge ' + status.toLowerCase();
        }
        if (nextDateEl) nextDateEl.textContent = rate > 0 ? 'Contact support' : 'N/A';
        if (usageCallsEl) usageCallsEl.textContent = callsUsed.toLocaleString();
        if (usageLimitEl) usageLimitEl.textContent = callLimit.toLocaleString();
        
        var usagePercent = callLimit > 0 ? Math.round((callsUsed / callLimit) * 100) : 0;
        if (usagePercentEl) usagePercentEl.textContent = usagePercent + '%';
        if (usageFillEl) {
            usageFillEl.style.width = Math.min(usagePercent, 100) + '%';
            if (usagePercent >= 100) usageFillEl.style.background = 'linear-gradient(90deg,#ef4444,#dc2626)';
            else if (usagePercent >= 80) usageFillEl.style.background = 'linear-gradient(90deg,#f59e0b,#d97706)';
        }
    }
    
    // Billing buttons
    var manageBillingBtn = document.getElementById('manageBillingBtn');
    if (manageBillingBtn) {
        manageBillingBtn.addEventListener('click', function() {
            window.open('mailto:info@prioai.ca?subject=Subscription Inquiry', '_blank');
        });
    }
    var updatePaymentBtn = document.getElementById('updatePaymentBtn');
    if (updatePaymentBtn) {
        updatePaymentBtn.addEventListener('click', function() {
            window.open('mailto:info@prioai.ca?subject=Update Payment Method', '_blank');
        });
    }
    var viewAllInvoicesBtn = document.getElementById('viewAllInvoicesBtn');
    if (viewAllInvoicesBtn) {
        viewAllInvoicesBtn.addEventListener('click', function() {
            window.open('mailto:info@prioai.ca?subject=Invoice Request', '_blank');
        });
    }
    var downloadReceiptBtn = document.getElementById('downloadReceiptBtn');
    if (downloadReceiptBtn) {
        downloadReceiptBtn.addEventListener('click', function() {
            window.open('mailto:info@prioai.ca?subject=Receipt Request', '_blank');
        });
    }
    var upgradePlanBtn = document.getElementById('upgradePlanBtn');
    if (upgradePlanBtn) {
        upgradePlanBtn.addEventListener('click', function() {
            window.location.href = 'https://prioai.ca/pricing';
        });
    }
    </script>
</body>
</html>
