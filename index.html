<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Prio AI Dashboard - Manage your leads and grow your business.">
    <title>Dashboard | Prio AI</title>
    <link rel="icon" type="image/png" href="/assets/favicon.png">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#0a0a0a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Prio AI">
    <link rel="apple-touch-icon" href="/assets/icon-192.png">
    <meta name="format-detection" content="telephone=no">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600&family=Plus+Jakarta+Sans:wght@600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/assets/styles.css">
    <style>
        /* Critical inline styles for immediate rendering */
        .stats-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:1rem;margin-bottom:2rem}
        @media(min-width:768px){.stats-grid{grid-template-columns:repeat(4,1fr)}}
        .stat-card{background:#111;border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:1.25rem;display:flex;align-items:center;gap:1rem}
        .stat-card.accent{background:rgba(52,211,153,0.1);border-color:rgb(52,211,153)}
        .stat-icon{font-size:1.5rem}
        .stat-value{font-family:var(--font-heading);font-size:2rem;font-weight:700;line-height:1;color:#FFFFFF}
        .stat-label{font-size:0.75rem;font-weight:400;color:#A0A0A0;text-transform:uppercase}
        .quick-actions{display:grid;grid-template-columns:repeat(2,1fr);gap:0.75rem;margin-bottom:2rem}
        @media(min-width:768px){.quick-actions{grid-template-columns:repeat(4,1fr)}}
        .quick-action{display:flex;flex-direction:column;align-items:center;gap:0.5rem;padding:1.5rem;background:#111;border:1px solid rgba(255,255,255,0.1);border-radius:12px;color:#fff;cursor:pointer}
        .quick-action:hover{border-color:rgb(52,211,153);background:rgba(52,211,153,0.1)}
        .quick-action-icon{font-size:1.5rem}
        .quick-action-text{font-size:0.8125rem;font-weight:600}
        .overview-header{margin-bottom:2.5rem;padding-bottom:1.5rem;border-bottom:1px solid rgba(255,255,255,0.08)}
        .overview-header-row{display:flex;justify-content:space-between;align-items:flex-start;gap:1.5rem;margin-bottom:1.5rem;padding-bottom:1.5rem;border-bottom:1px solid rgba(255,255,255,0.08);flex-wrap:wrap}
        .overview-header-left{flex:1;min-width:280px}
        .overview-header-right{display:flex;gap:0.75rem;flex-wrap:wrap}
        .header-stat-badge{background:#111;border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:0.75rem 1rem;min-width:85px;min-height:70px;text-align:center;display:flex;flex-direction:column;align-items:center;justify-content:center;overflow:hidden}
        .header-stat-badge.usage-badge{min-width:180px;min-height:70px;padding:0.5rem 1.25rem}
        .header-stat-badge.accent{background:rgba(52,211,153,0.1);border-color:rgba(52,211,153,0.3)}
        .header-stat-badge .badge-emoji{font-size:0.75rem;margin-bottom:1px;line-height:1}
        .header-stat-badge .badge-value{font-size:2rem;font-weight:700;margin-bottom:1px;line-height:1.2;color:#FFFFFF}
        .header-stat-badge .badge-label{font-size:0.75rem;font-weight:400;color:#A0A0A0;text-transform:uppercase;letter-spacing:0.5px;line-height:1}
        .section-label{font-size:1rem;font-weight:700;color:#A0A0A0;text-transform:uppercase;letter-spacing:0.05em;margin:1.5rem 0 0.75rem 0}
        .usage-bar-mini{width:100%;height:6px;background:rgba(255,255,255,0.1);border-radius:3px;margin-top:8px;overflow:hidden}
        .usage-bar-mini .usage-bar-fill{height:100%;border-radius:3px;transition:width 0.3s ease,background 0.3s ease;background:linear-gradient(90deg,#fff,#fff)}
        .usage-bar-mini .usage-bar-fill.warning{background:linear-gradient(90deg,#f59e0b,#eab308)}
        .usage-bar-mini .usage-bar-fill.danger{background:linear-gradient(90deg,#ef4444,#dc2626)}
        .overview-welcome{font-family:var(--font-heading);font-size:1.5rem;font-weight:800;margin-bottom:0.75rem;color:#FFFFFF}
        .overview-header-meta{display:flex;align-items:center;gap:12px;font-size:0.6875rem;font-weight:400;color:#707070}
        .usage-card .stat-content{flex:1}
        .usage-bar{height:6px;background:rgba(255,255,255,0.1);border-radius:3px;margin-top:10px;overflow:hidden}
        .usage-bar-fill{height:100%;background:rgb(52,211,153);border-radius:3px;transition:width 0.3s ease,background 0.3s ease}
        .usage-bar-fill.warning{background:#f59e0b}
        .usage-bar-fill.danger{background:#ef4444}
        .header-meta-item{display:flex;align-items:center;gap:6px}
        .header-meta-divider{opacity:0.3}
        .meta-label{color:#707070}
        .meta-value{color:rgb(52,211,153);font-family:monospace;font-weight:500}
        .analytics-section{margin-top:2rem;margin-bottom:2rem}
        .analytics-header{margin-bottom:1rem}
        .analytics-header h3{font-family:var(--font-heading);font-size:1rem;font-weight:700;text-transform:uppercase;letter-spacing:0.05em;color:#FFFFFF}
        .analytics-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:1rem}
        @media(max-width:768px){.analytics-grid{grid-template-columns:1fr}}
        .analytics-card{background:#111;border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:1.5rem;box-shadow:0 1px 2px rgba(0,0,0,0.2)}
        .analytics-row{display:flex;justify-content:space-between;align-items:center;padding:0.625rem 0;border-bottom:1px solid rgba(255,255,255,0.05)}
        .analytics-row:last-child{border-bottom:none}
        .analytics-label{font-size:0.8125rem;font-weight:400;color:#A0A0A0}
        .analytics-value{font-family:var(--font-heading);font-size:2rem;font-weight:700;color:#FFFFFF}
        .analytics-value.success{color:rgb(52,211,153)}
        .analytics-value.warning{color:#f59e0b}
        .analytics-value.muted{color:#707070}
        .priorities-section{margin-top:2rem}
        .priorities-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem}
        .priorities-header h3{font-family:var(--font-heading);font-size:1rem;font-weight:700;text-transform:uppercase;letter-spacing:0.05em;display:flex;align-items:center;gap:10px;color:#FFFFFF}
        .priorities-count{background:rgb(52,211,153);color:#000;font-size:0.875rem;font-weight:700;padding:4px 12px;border-radius:20px}
        .priorities-view-toggle{display:flex;gap:4px}
        .view-toggle{display:flex;gap:4px}
        .view-toggle-btn{width:32px;height:32px;border:1px solid rgba(255,255,255,0.15);background:#111;color:rgba(255,255,255,0.5);border-radius:8px;cursor:pointer;font-size:1rem;transition:all 150ms ease}
        .view-toggle-btn:hover{border-color:rgba(255,255,255,0.3);color:rgba(255,255,255,0.8)}
        .view-toggle-btn.active{background:rgb(52,211,153);border-color:rgb(52,211,153);color:#000}
        .font-size-toggle{height:32px;padding:0 10px;border:1px solid rgba(255,255,255,0.15);background:#111;color:rgba(255,255,255,0.5);border-radius:8px;cursor:pointer;font-size:0.6875rem;font-weight:600;transition:all 150ms ease;display:flex;align-items:center;gap:4px;white-space:nowrap;margin-left:4px}
        .font-size-toggle:hover{border-color:rgba(255,255,255,0.3);color:rgba(255,255,255,0.8)}
        .font-size-toggle .size-label{font-weight:700}
        .font-size-toggle.size-sm .size-label{font-size:0.625rem}
        .font-size-toggle.size-md .size-label{font-size:0.75rem}
        .font-size-toggle.size-lg .size-label{font-size:0.875rem}
        .font-size-md .priority-card-lg-name{font-size:1.125rem}
        .font-size-md .priority-card-lg-phone{font-size:0.9375rem}
        .font-size-md .priority-card-lg-lastcall{font-size:0.8125rem}
        .font-size-md .priority-card-lg-summary-col .col-content{font-size:0.9375rem}
        .font-size-md .priority-card-lg-notes-col .col-content{font-size:0.9375rem}
        .font-size-md .priority-card-lg-summary-col .col-label,.font-size-md .priority-card-lg-notes-col .col-label,.font-size-md .priority-card-lg-status-col .col-label{font-size:0.8125rem}
        .font-size-md .card-status-trigger{font-size:0.875rem}
        .font-size-md .card-status-menu .status-option{font-size:0.875rem}
        .font-size-md .action-label{font-size:0.6875rem}
        .font-size-md .action-icon{font-size:1rem}
        .font-size-md .priority-card-lg-badge{font-size:0.8125rem}
        .font-size-md .priority-card-lg-time-col .time-value{font-size:1.125rem}
        .font-size-md .priority-card-lg-time-col .date-value{font-size:0.875rem}
        .font-size-lg .priority-card-lg-name{font-size:1.3125rem}
        .font-size-lg .priority-card-lg-phone{font-size:1.0625rem}
        .font-size-lg .priority-card-lg-lastcall{font-size:0.9375rem}
        .font-size-lg .priority-card-lg-summary-col .col-content{font-size:1.0625rem}
        .font-size-lg .priority-card-lg-notes-col .col-content{font-size:1.0625rem}
        .font-size-lg .priority-card-lg-summary-col .col-label,.font-size-lg .priority-card-lg-notes-col .col-label,.font-size-lg .priority-card-lg-status-col .col-label{font-size:0.9375rem}
        .font-size-lg .card-status-trigger{font-size:1rem}
        .font-size-lg .card-status-menu .status-option{font-size:1rem}
        .font-size-lg .action-label{font-size:0.6875rem}
        .font-size-lg .action-icon{font-size:1rem}
        .font-size-lg .priority-card-lg-badge{font-size:0.9375rem}
        .font-size-lg .priority-card-lg-time-col .time-value{font-size:1.25rem}
        .font-size-lg .priority-card-lg-time-col .date-value{font-size:1rem}
        .font-size-lg .priority-card-lg{min-height:120px}
        .header-count-badge{background:rgb(52,211,153);color:#000;font-size:0.875rem;font-weight:700;padding:2px 10px;border-radius:20px;margin-left:10px;vertical-align:middle}
        .filters-left{display:flex;align-items:center;gap:0.5rem;flex-wrap:wrap}
        .sort-controls{display:flex;align-items:center;gap:8px}
        .sort-label{font-size:0.6875rem;font-weight:400;color:#707070;white-space:nowrap}
        .sort-select{min-width:120px}
        .sort-direction-btn{width:32px;height:32px;border:1px solid rgba(255,255,255,0.15);background:#111;color:rgba(255,255,255,0.6);border-radius:8px;cursor:pointer;font-size:1rem;display:flex;align-items:center;justify-content:center}
        .sort-direction-btn:hover{border-color:rgba(255,255,255,0.3);color:rgba(255,255,255,0.9)}
        .prio-header-actions,.prospects-header-actions,.pipeline-header-actions{display:flex;align-items:center;gap:1rem}
        .filters-bar{display:flex;gap:1rem;margin-bottom:1.5rem;flex-wrap:wrap;align-items:center;justify-content:space-between}
        .filter-group{display:flex;gap:0.5rem;flex-wrap:wrap;margin-left:auto}
        .priorities-cards{display:grid;grid-template-columns:1fr;gap:8px}
        .priorities-cards > .missed-meeting-separator{border-top:1px solid #1a1a1a}
        .priority-card-lg{background:#111;border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:0;cursor:pointer;transition:all 150ms ease;display:flex;flex-direction:row;min-height:100px;overflow:hidden;position:relative;border-left:3px solid #F59E0B;margin-bottom:0;border-radius:0 12px 12px 0;box-shadow:0 1px 2px rgba(0,0,0,0.2)}
        .priorities-cards .priority-card-lg{border-radius:0 12px 12px 0}
        .priorities-cards .priority-card-lg:first-child{border-radius:0 12px 12px 0}
        .priorities-cards .priority-card-lg:last-child{border-radius:0 12px 12px 0}
        .priorities-cards .priority-card-lg:only-child{border-radius:0 12px 12px 0}
        .priority-card-lg.meeting-done{border-left-color:#34D399}
        .priority-card-lg.missed-meeting{border-left-color:#ef4444}
        .priority-card-lg:hover{border-color:rgba(255,255,255,0.2);border-left-color:#F59E0B;background:#151515;box-shadow:0 4px 12px rgba(0,0,0,0.3)}
        .priority-card-lg.meeting-done:hover{border-left-color:#34D399}
        .priority-card-lg.missed-meeting:hover{border-left-color:#ef4444}
        .priority-card-lg-left{flex:none;min-width:0;display:flex;flex-direction:row;border-right:1px solid rgba(255,255,255,0.08)}
        .priority-card-lg-time-col{flex:0 0 85px;background:rgba(245,158,11,0.06);display:flex;flex-direction:column;align-items:center;justify-content:center;padding:12px}
        .meeting-done .priority-card-lg-time-col{background:rgba(52,211,153,0.06)}
        .priority-card-lg-time-col .time-value{font-size:0.875rem;font-weight:700;color:#F59E0B;white-space:nowrap;min-width:60px;text-align:center;background:rgba(245,158,11,0.1);padding:4px 10px;border-radius:20px}
        .meeting-done .priority-card-lg-time-col .time-value{background:rgba(52,211,153,0.1);color:rgb(52,211,153)}
        .missed-meeting .priority-card-lg-time-col .time-value{background:rgba(239,68,68,0.1);color:#ef4444}
        .priority-card-lg-time-col .date-value{font-size:0.75rem;font-weight:500;color:#F59E0B;opacity:0.8;margin-bottom:2px;text-align:center}
        .meeting-done .priority-card-lg-time-col .date-value{color:rgb(52,211,153)}
        .btn-schedule-card{background:rgba(52,211,153,0.15);color:rgb(52,211,153);border:1px solid rgba(52,211,153,0.3);padding:6px 12px;border-radius:8px;font-size:0.75rem;font-weight:600;cursor:pointer;transition:all 150ms ease}
        .btn-schedule-card:hover{background:rgb(52,211,153);color:#000}
        .btn-takeover{background:rgba(59,130,246,0.15);color:rgb(59,130,246);border:1px solid rgba(59,130,246,0.3);padding:10px 20px;border-radius:8px;font-size:0.8125rem;font-weight:600;cursor:pointer;transition:all 150ms ease;display:flex;align-items:center;gap:8px}
        .btn-takeover:hover{background:rgb(59,130,246);color:#fff}
        .btn-takeover-modal{padding:10px 16px;font-size:0.8125rem;font-weight:600;background:rgba(59,130,246,0.15);color:rgb(59,130,246);border:1px solid rgba(59,130,246,0.3);border-radius:8px;cursor:pointer;transition:all 150ms ease}
        .btn-takeover-modal:hover{background:rgba(59,130,246,0.25)}
        .card-status-badge{width:18px;height:18px;border-radius:50%;font-size:0.625rem;font-weight:700;display:inline-flex;align-items:center;justify-content:center;margin-left:6px;vertical-align:middle}
        .card-status-badge.booked{background:rgba(52,211,153,0.2);color:rgb(52,211,153)}
        .card-status-badge.callback{background:rgba(245,158,11,0.2);color:#f59e0b}
        .priority-card-lg-info{flex:0 0 280px;padding:14px;display:flex;flex-direction:column;justify-content:center;overflow:hidden}
        .priority-card-lg-top{display:flex;align-items:center;gap:10px;margin-bottom:6px}
        .priority-card-lg-name{font-family:var(--font-heading);font-size:1rem;font-weight:600;display:flex;align-items:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%}
        .priority-card-lg-badge{font-size:0.6875rem;padding:3px 10px;border-radius:20px;font-weight:600;text-transform:uppercase}
        .priority-card-lg-badge.booked{background:rgba(52,211,153,0.1);color:rgb(52,211,153)}
        .priority-card-lg-badge.callback{background:rgba(245,158,11,0.1);color:#f59e0b}
        .priority-card-lg-phone{font-size:0.8125rem;font-weight:400;color:#707070;margin-bottom:4px;font-family:monospace}
        .priority-card-lg-lastcall{font-size:0.6875rem;font-weight:400;color:#707070;display:flex;align-items:center;gap:6px}
        .priority-card-lg-lastcall .lastcall-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0}
        .priority-card-lg-summary-col{flex:1 1 0%;min-width:0;padding:14px 18px;border-right:1px solid rgba(255,255,255,0.08);display:flex;flex-direction:column}
        .priority-card-lg-summary-col .col-label{font-size:0.6875rem;text-transform:uppercase;color:#707070;margin-bottom:8px;font-weight:400}
        .priority-card-lg-summary-col .col-content{font-size:0.8125rem;font-weight:400;line-height:1.6;color:#A0A0A0;flex:1;overflow:hidden}
        .priority-card-lg-notes-col{flex:1 1 0%;min-width:0;padding:14px 18px;display:flex;flex-direction:column}
        .priority-card-lg-notes-col .col-label{font-size:0.6875rem;text-transform:uppercase;color:#707070;margin-bottom:8px;font-weight:400}
        .priority-card-lg-notes-col .col-content{font-size:0.8125rem;font-weight:400;line-height:1.5;color:#A0A0A0;flex:1;overflow:hidden}
        @media(max-width:900px){.priority-card-lg{flex-direction:column}.priority-card-lg-left{flex:none;border-right:none;border-bottom:1px solid rgba(255,255,255,0.08)}.priority-card-lg-info{flex:1}.priority-card-lg-summary-col{border-right:none;border-bottom:1px solid rgba(255,255,255,0.08)}.priority-card-lg-notes-col{flex:none}.priority-card-lg-status-col{flex:none;border-right:none;border-bottom:1px solid rgba(255,255,255,0.08)}}
        .missed-meeting-separator{display:flex;align-items:center;gap:16px;margin:24px 0 8px 0;padding:0 8px}
        .missed-meeting-separator::before,.missed-meeting-separator::after{content:'';flex:1;height:2px;background:linear-gradient(90deg,transparent,#ef4444,transparent)}
        .missed-meeting-separator span{font-size:0.8125rem;font-weight:600;color:#ef4444;text-transform:uppercase;letter-spacing:0.5px;white-space:nowrap;display:flex;align-items:center;gap:8px}
        .missed-meeting-separator .missed-count{background:#ef4444;color:#fff !important;font-size:0.75rem;padding:2px 8px;border-radius:12px;font-weight:700}
        .missed-meeting-info{font-size:0.6875rem;font-weight:400;color:#707070;text-align:center;margin-bottom:0;padding:8px 16px;background:rgba(239,68,68,0.08);border-radius:8px}
        .priority-card-lg.missed-meeting{border-color:rgba(239,68,68,0.4);background:rgba(239,68,68,0.05);border-left-color:#ef4444}
        .priority-card-lg.missed-meeting:hover{border-color:#ef4444;border-left-color:#ef4444}
        .priority-card-lg.missed-meeting .priority-card-lg-time-col{background:rgba(239,68,68,0.15)}
        .priority-card-lg.missed-meeting .priority-card-lg-time-col .time-value{color:#ef4444}
        .priority-card-lg.missed-meeting .missed-date{font-size:0.75rem;font-weight:500;opacity:0.8;margin-bottom:2px}
        .priority-card-lg.meeting-done{opacity:0.45;border-color:rgba(255,255,255,0.06);background:rgba(255,255,255,0.01);border-left-color:#34D399;filter:saturate(0.3) brightness(0.7)}
        .priority-card-lg.meeting-done:hover{opacity:0.65;border-left-color:#34D399;filter:saturate(0.5) brightness(0.85)}
        .meeting-done-badge{background:rgba(52,211,153,0.15);color:#34D399;font-size:0.5625rem;font-weight:600;padding:2px 8px;border-radius:20px;text-transform:uppercase;position:absolute;top:4px;right:4px;z-index:1;filter:brightness(1.8) saturate(2)}
        .priority-card-lg.meeting-done .priority-card-lg-name{color:rgba(255,255,255,0.45)}
        .priority-card-lg.meeting-done .priority-card-lg-phone{color:rgba(255,255,255,0.25)}
        .priority-card-lg.meeting-done .priority-card-lg-lastcall{color:rgba(255,255,255,0.25)}
        .priority-card-lg.meeting-done .col-label{color:rgba(255,255,255,0.2)}
        .priority-card-lg.meeting-done .col-content{color:rgba(255,255,255,0.3)}
        .priority-card-lg.meeting-done .action-btn{opacity:0.4}
        .prio-indicator{display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;background:linear-gradient(135deg,#8B5CF6,#7C3AED);color:white;font-size:0.75rem;font-weight:700;border-radius:8px;margin-right:8px;flex-shrink:0}
        .prio-icon{width:20px;height:20px;position:absolute;top:6px;left:6px;border-radius:4px}
        .priority-card-lg-time-col{position:relative}
        .priority-card-lg-actions{flex:0 0 200px;display:grid;grid-template-columns:1fr 1fr;gap:6px;padding:10px;border-left:1px solid rgba(255,255,255,0.08)}
        .action-btn{padding:8px 4px;border:1px solid rgba(255,255,255,0.15);background:#111;border-radius:8px;cursor:pointer;font-size:0.75rem;font-weight:600;transition:all 150ms ease;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;color:#A0A0A0}
        .action-btn .action-icon{font-size:1rem}
        .action-btn .action-label{font-size:0.6875rem;font-weight:600;white-space:nowrap}
        .action-btn:hover{transform:translateY(-2px);border-color:rgba(255,255,255,0.3);color:#fff;box-shadow:0 4px 12px rgba(0,0,0,0.3)}
        .action-btn.action-share:hover{background:rgba(59,130,246,0.2);border-color:#3B82F6}
        .action-btn.action-share.shared{background:rgba(52,211,153,0.15);border-color:rgba(52,211,153,0.3);color:rgb(52,211,153)}
        .action-btn.action-share.shared:hover{background:rgba(52,211,153,0.25);border-color:rgb(52,211,153)}
        .action-btn.action-ai:hover{background:rgba(52,211,153,0.2);border-color:rgb(52,211,153)}
        .action-btn.action-dnc:hover{background:rgba(239,68,68,0.2);border-color:#ef4444}
        .action-btn.action-reschedule:hover{background:rgba(245,158,11,0.2);border-color:#f59e0b}
        .action-btn.action-reschedule.disabled,.action-btn.action-reschedule:disabled{opacity:0.35;cursor:not-allowed;pointer-events:none;background:rgba(255,255,255,0.03);border-color:rgba(255,255,255,0.05)}
        .action-btn.action-prio:hover{background:rgba(245,158,11,0.2);border-color:#f59e0b}
        .action-btn.action-unprio:hover{background:rgba(239,68,68,0.2);border-color:#ef4444}
        .action-btn.action-takeover:hover{background:rgba(59,130,246,0.2);border-color:#3B82F6}
        .priorities-cards:not(.list-view){display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:1rem}
        .priorities-cards:not(.list-view) > .priority-card-lg + .priority-card-lg{border-top:1px solid rgba(255,255,255,0.1)}
        .priorities-cards:not(.list-view) .priority-card-lg{flex-direction:column;min-height:200px;border-radius:12px;border-left:3px solid #F59E0B}
        .priorities-cards:not(.list-view) .priority-card-lg-left{flex:none;border-right:none;border-bottom:1px solid rgba(255,255,255,0.08)}
        .priorities-cards:not(.list-view) .priority-card-lg-time-col{flex:0 0 60px}
        .priorities-cards:not(.list-view) .priority-card-lg-info{flex:1}
        .priorities-cards:not(.list-view) .priority-card-lg-summary-col,.priorities-cards:not(.list-view) .priority-card-lg-notes-col,.priorities-cards:not(.list-view) .priority-card-lg-status-col{flex:none;border-right:none;border-bottom:1px solid rgba(255,255,255,0.08)}
        .priorities-cards:not(.list-view) .priority-card-lg-actions{grid-template-columns:repeat(4,1fr);border-left:none;border-top:1px solid rgba(255,255,255,0.08);flex:none;width:auto}
        .priorities-cards:not(.list-view) .missed-meeting-separator,.priorities-cards:not(.list-view) .missed-meeting-info{grid-column:1/-1}
        .section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem}
        .section-header h3{font-family:var(--font-heading);font-size:1rem;font-weight:700;text-transform:uppercase;letter-spacing:0.05em;color:#FFFFFF}
        .prio-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:1.5rem;flex-wrap:wrap;gap:1rem}
        .prio-filters{display:flex;gap:0.5rem;margin-bottom:1.25rem;flex-wrap:wrap}
        .prio-filter{padding:0.5rem 1rem;font-size:0.8125rem;font-weight:600;color:#A0A0A0;background:#111;border:1px solid rgba(255,255,255,0.1);border-radius:8px;cursor:pointer}
        .prio-filter.active{background:rgb(52,211,153);border-color:rgb(52,211,153);color:#000}
        .prio-list{display:grid;grid-template-columns:1fr;gap:1rem;padding:0}
        .prio-list.list-view{grid-template-columns:1fr}
        .prio-list:not(.list-view){grid-template-columns:repeat(auto-fill,minmax(340px,1fr))}
        .prio-list:not(.list-view) .priority-card-lg{flex-direction:column;min-height:320px}
        .prio-list:not(.list-view) .priority-card-lg-left{flex:none;border-right:none;border-bottom:1px solid rgba(255,255,255,0.08)}
        .prio-list:not(.list-view) .priority-card-lg-time-col{flex:0 0 60px}
        .prio-list:not(.list-view) .priority-card-lg-info{flex:1}
        .prio-list:not(.list-view) .priority-card-lg-summary-col{flex:1;border-right:none;border-bottom:1px solid rgba(255,255,255,0.08);min-height:60px}
        .prio-list:not(.list-view) .priority-card-lg-notes-col{flex:1;border-right:none;border-bottom:1px solid rgba(255,255,255,0.08);min-height:60px}
        .prio-list:not(.list-view) .priority-card-lg-status-col{flex:none;border-right:none;border-bottom:1px solid rgba(255,255,255,0.08)}
        .prio-list:not(.list-view) .priority-card-lg-actions{grid-template-columns:repeat(4,1fr);border-left:none;border-top:1px solid rgba(255,255,255,0.08);min-width:auto;flex:none}
        .prio-card{background:#111;border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:0;cursor:pointer;transition:all 150ms ease;display:flex;flex-direction:column;min-height:280px}
        .prio-card:hover{border-color:rgb(52,211,153);transform:translateY(-2px)}
        .prio-card-header{padding:16px 20px;border-bottom:1px solid rgba(255,255,255,0.08)}
        .prio-card-name{font-family:var(--font-heading);font-size:1rem;font-weight:600;margin-bottom:4px;display:flex;align-items:center;gap:8px;color:#FFFFFF}
        .prio-card-name .shared-icon{color:#3B82F6;font-size:0.875rem}
        .shared-badge{display:inline-flex;align-items:center;gap:3px;font-size:0.625rem;font-weight:600;color:#3B82F6;background:rgba(59,130,246,0.12);padding:2px 8px;border-radius:20px;white-space:nowrap;vertical-align:middle;margin-left:4px}
        .shared-icon-only{font-size:0.75rem;margin-left:4px;cursor:default;vertical-align:middle}
        .priority-card-lg-status-col{flex:0 0 170px;padding:14px 12px;border-right:1px solid rgba(255,255,255,0.08);display:flex;flex-direction:column;justify-content:center;align-items:center}
        .priority-card-lg-status-col .col-label{font-size:0.6875rem;text-transform:uppercase;color:#707070;margin-bottom:8px;font-weight:400;text-align:center}
        .card-status-trigger{display:flex;align-items:center;gap:6px;padding:5px 10px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:#fff;font-size:0.75rem;font-family:var(--font-body);cursor:pointer;transition:all 150ms ease;white-space:nowrap;width:100%}
        .card-status-trigger:hover{background:rgba(255,255,255,0.08);border-color:rgba(255,255,255,0.2)}
        .card-status-trigger .status-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
        .card-status-menu,#cardStatusPortal{display:none;position:fixed;width:360px;background:#1a1a2e;border:1px solid rgba(255,255,255,0.12);border-radius:8px;padding:10px;z-index:99999;box-shadow:0 4px 12px rgba(0,0,0,0.3)}
        .card-status-menu.open,#cardStatusPortal.open{display:block;animation:statusPopIn 150ms ease}
        @keyframes statusPopIn{from{opacity:0;transform:scale(0.95)}to{opacity:1;transform:scale(1)}}
        .card-status-menu .status-popup-grid{display:grid;grid-template-columns:1fr 1fr;gap:4px}
        .card-status-menu .status-option{padding:7px 10px;font-size:0.75rem;border-radius:8px;display:flex;align-items:center;gap:6px;cursor:pointer;color:#A0A0A0;background:none;border:1px solid transparent;transition:all 150ms ease;font-family:var(--font-body);text-align:left;width:100%;min-width:0;white-space:nowrap;overflow:hidden}
        .card-status-menu .status-option span:not(.status-dot){overflow:hidden;text-overflow:ellipsis}
        .card-status-menu .status-option:hover{background:rgba(255,255,255,0.08);border-color:rgba(255,255,255,0.1);color:#fff}
        .card-status-menu .status-option.selected{background:rgba(52,211,153,0.12);border-color:rgba(52,211,153,0.25);color:#34D399}
        .card-status-menu .status-option .status-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
        .custom-status-dropdown{position:relative;width:100%;max-width:200px}
        .status-dropdown-trigger{display:flex;align-items:center;gap:8px;width:100%;padding:6px 12px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:#fff;font-size:0.8125rem;font-family:var(--font-body);cursor:pointer;transition:all 150ms ease ease}
        .status-dropdown-trigger:hover{background:rgba(255,255,255,0.08);border-color:rgba(255,255,255,0.2)}
        .status-dropdown-trigger.open{border-color:rgba(52,211,153,0.5);background:rgba(255,255,255,0.06)}
        .status-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
        .status-chevron{transition:transform 0.2s ease;opacity:0.5;margin-left:auto;flex-shrink:0}
        .status-dropdown-trigger.open .status-chevron{transform:rotate(180deg)}
        .status-dropdown-menu{display:none;position:absolute;top:calc(100% + 4px);left:0;width:100%;min-width:200px;background:#1a1a2e;border:1px solid rgba(255,255,255,0.12);border-radius:8px;padding:4px;z-index:9999;box-shadow:0 4px 12px rgba(0,0,0,0.3);backdrop-filter:blur(20px);max-height:280px;overflow-y:auto}
        .status-dropdown-menu.open{display:block;animation:statusDropIn 0.15s ease}
        @keyframes statusDropIn{from{opacity:0;transform:translateY(-4px)}to{opacity:1;transform:translateY(0)}}
        .status-option{display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:8px;cursor:pointer;font-size:0.8125rem;color:#A0A0A0;transition:all 150ms ease ease;border:none;background:none;width:100%;text-align:left;font-family:var(--font-body)}
        .status-option:hover{background:rgba(255,255,255,0.08);color:#fff}
        .status-option.selected{background:rgba(52,211,153,0.12);color:#34D399}
        .status-option .status-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
        .ai-status-badge{display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:4px;font-size:0.625rem;font-weight:700;cursor:default;flex-shrink:0;line-height:1}
        .prio-card-meta{display:flex;gap:16px;font-size:0.6875rem;font-weight:400;color:#707070}
        .prio-card-phone{font-family:monospace}
        .prio-card-lastcall{display:flex;align-items:center;gap:6px}
        .prio-card-lastcall .lastcall-dot{width:8px;height:8px;border-radius:50%}
        .lastcall-green{background:#22c55e}
        .lastcall-yellow{background:#eab308}
        .lastcall-orange{background:#f97316}
        .lastcall-red{background:#ef4444}
        .prio-card-booked{margin-top:8px;font-size:0.6875rem;font-weight:400}
        .prio-card-booked .booked-time{color:rgb(52,211,153);font-weight:600}
        .prio-card-booked .btn-schedule{font-size:0.75rem;padding:6px 12px;background:rgb(52,211,153);color:#000;border:none;border-radius:8px;cursor:pointer;font-weight:600}
        .prio-card-tabs{display:flex;border-bottom:1px solid rgba(255,255,255,0.08)}
        .prio-card-tab{flex:1;padding:10px 16px;font-size:0.8125rem;font-weight:600;text-transform:uppercase;letter-spacing:0.05em;color:#707070;background:transparent;border:none;cursor:pointer;transition:all 150ms ease;text-align:center}
        .prio-card-tab:first-child{border-right:1px solid rgba(255,255,255,0.08)}
        .prio-card-tab.active{color:rgb(52,211,153);background:rgba(52,211,153,0.05)}
        .prio-card-tab:hover:not(.active){color:rgba(255,255,255,0.8)}
        .prio-card-content{flex:1;padding:16px 20px;overflow:hidden;display:flex;flex-direction:column}
        .prio-card-panel{display:none;flex:1;overflow-y:auto}
        .prio-card-panel.active{display:block}
        .prio-card-summary{font-size:0.8125rem;font-weight:400;line-height:1.6;color:#A0A0A0}
        .prio-card-notes-list{display:flex;flex-direction:column;gap:8px}
        .prio-note-item{background:rgba(255,255,255,0.05);border-radius:12px;padding:10px 12px}
        .prio-note-text{font-size:0.8125rem;font-weight:400;line-height:1.5;color:#A0A0A0}
        .prio-note-date{font-size:0.6875rem;font-weight:400;color:#707070;margin-top:6px}
        .prio-card-footer{padding:12px 20px;border-top:1px solid rgba(255,255,255,0.08);display:flex;justify-content:space-between;align-items:center;gap:8px}
        .prio-card-footer .btn-share{padding:6px 12px;background:rgba(59,130,246,0.15);border:1px solid rgba(59,130,246,0.3);color:#3B82F6;border-radius:8px;cursor:pointer;font-size:0.8125rem;font-weight:600;transition:all 150ms ease;display:flex;align-items:center;gap:6px}
        .prio-card-footer .btn-share:hover{background:#3B82F6;color:#fff}
        .prio-card-footer .btn-unprio{font-size:0.8125rem;padding:6px 12px;background:rgba(239,68,68,0.15);color:#ef4444;border:1px solid rgba(239,68,68,0.3);border-radius:8px;cursor:pointer;font-weight:600;transition:all 150ms ease}
        .prio-card-footer .btn-unprio:hover{background:#ef4444;color:#fff}
        @media(max-width:600px){.prio-list{grid-template-columns:1fr}.prio-card{min-height:260px}}
        
        /* Section count badge */
        .section-count{display:inline-flex;align-items:center;justify-content:center;min-width:24px;height:24px;padding:0 8px;background:rgb(52,211,153);color:#000;border-radius:12px;font-size:0.75rem;font-weight:700;margin-left:8px}
        .prio-stat-value{font-family:var(--font-heading);font-size:2rem;font-weight:700;color:rgb(52,211,153)}
        
        /* Lead Detail Modal */
        .lead-modal{max-width:900px;width:95%;max-height:90vh;overflow:hidden;display:flex;flex-direction:column;background:linear-gradient(180deg,#0f0f0f 0%,#0a0a0a 100%);border:1px solid rgba(255,255,255,0.08);box-shadow:0 8px 32px rgba(0,0,0,0.5);border-radius:16px}
        .modal-nav-arrow{position:absolute;top:50%;transform:translateY(-50%);width:48px;height:48px;border-radius:50%;background:rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.2);color:#fff;font-size:2rem;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 150ms ease;z-index:10}
        .modal-nav-arrow:hover{background:rgba(52,211,153,0.2);border-color:rgb(52,211,153)}
        .modal-nav-arrow:disabled{opacity:0.3;cursor:not-allowed}
        .modal-nav-arrow:disabled:hover{background:rgba(0,0,0,0.6);border-color:rgba(255,255,255,0.2)}
        .modal-nav-prev{left:calc(50% - 520px)}
        .modal-nav-next{right:calc(50% - 520px)}
        @media(max-width:1100px){.modal-nav-arrow{display:none}}
        .lead-modal-header{display:flex;justify-content:space-between;align-items:flex-start;padding:24px 28px;border-bottom:1px solid rgba(255,255,255,0.08);background:rgba(255,255,255,0.02)}
        .modal-name-row{display:flex;align-items:center;gap:12px;margin-bottom:12px}
        .modal-prio-icon{width:28px;height:28px;border-radius:8px}
        .lead-modal-title h2{font-family:var(--font-heading);font-size:1.4rem;font-weight:600;margin:0;color:#FFFFFF}
        .lead-modal-actions{display:flex;gap:10px;flex-wrap:wrap}
        .btn-prio-toggle{padding:10px 16px;font-size:0.8125rem;font-weight:600;background:rgba(245,158,11,0.15);color:#f59e0b;border:1px solid rgba(245,158,11,0.3);border-radius:8px;cursor:pointer;transition:all 150ms ease}
        .btn-prio-toggle.active{background:#f59e0b;color:#000}
        .btn-prio-toggle:hover{background:rgba(245,158,11,0.25);transform:scale(1.02);box-shadow:0 4px 12px rgba(0,0,0,0.3)}
        .btn-send-back{padding:10px 16px;font-size:0.8125rem;font-weight:600;background:rgba(52,211,153,0.15);color:rgb(52,211,153);border:1px solid rgba(52,211,153,0.3);border-radius:8px;cursor:pointer;transition:all 150ms ease}
        .btn-send-back:hover{background:rgba(52,211,153,0.25);transform:scale(1.02);box-shadow:0 4px 12px rgba(0,0,0,0.3)}
        .btn-dnc{padding:10px 16px;font-size:0.8125rem;font-weight:600;background:rgba(239,68,68,0.15);color:#ef4444;border:1px solid rgba(239,68,68,0.3);border-radius:8px;cursor:pointer;transition:all 150ms ease}
        .btn-dnc:hover{background:rgba(239,68,68,0.25);transform:scale(1.02);box-shadow:0 4px 12px rgba(0,0,0,0.3)}
        .notes-input-container{position:relative}
        .notes-action-row{display:flex;gap:10px;margin-top:12px;justify-content:center;align-items:center}
        .voice-input-btn{width:48px;height:48px;border-radius:12px;background:#1a1a1a;border:1px solid rgba(255,255,255,0.15);color:rgba(255,255,255,0.7);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 150ms ease}
        .voice-input-btn:hover{background:rgba(52,211,153,0.15);border-color:rgb(52,211,153);color:rgb(52,211,153)}
        .voice-input-btn.recording{background:rgba(239,68,68,0.2);border-color:#ef4444;color:#ef4444;animation:pulse-recording 1.5s infinite}
        .voice-input-btn svg{width:22px;height:22px}
        @keyframes pulse-recording{0%,100%{opacity:1}50%{opacity:0.5}}
        .polish-notes-btn{padding:12px 24px;border-radius:20px;background:linear-gradient(135deg,#8B5CF6,#7C3AED);border:none;color:white;font-size:0.9375rem;font-weight:600;cursor:pointer;transition:all 150ms ease;display:flex;align-items:center;gap:8px}
        .polish-notes-btn:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.3)}
        .polish-notes-btn:disabled{opacity:0.5;cursor:not-allowed;transform:none;box-shadow:none}
        .notes-action-row .btn{padding:12px 24px;font-size:0.9375rem;border-radius:20px;transition:all 150ms ease}
        .notes-action-row .btn:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.3)}
        .polish-preview-modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:1200;opacity:0;visibility:hidden;transition:all 150ms ease}
        .polish-preview-modal.active{opacity:1;visibility:visible}
        .polish-preview-content{background:#111;border:1px solid rgba(255,255,255,0.1);border-radius:16px;padding:24px;max-width:600px;width:90%;max-height:80vh;overflow-y:auto}
        .polish-preview-content h3{font-family:var(--font-heading);margin-bottom:16px;display:flex;align-items:center;gap:8px;font-size:1.125rem;font-weight:700}
        .polish-comparison{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px}
        .polish-box{background:#0a0a0a;border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:14px}
        .polish-box-label{font-size:0.75rem;color:#707070;margin-bottom:8px;font-weight:400;text-transform:uppercase}
        .polish-box-text{font-size:0.875rem;line-height:1.6;white-space:pre-wrap;color:rgba(255,255,255,0.85)}
        .polish-actions{display:flex;gap:12px}
        .polish-actions button{flex:1;padding:12px;border-radius:12px;font-weight:600;cursor:pointer;transition:all 150ms ease;font-size:0.875rem}
        .polish-accept{background:rgb(52,211,153);border:none;color:#000}
        .polish-accept:hover{background:rgb(45,190,135)}
        .polish-reject{background:#1a1a1a;border:1px solid rgba(255,255,255,0.15);color:rgba(255,255,255,0.8)}
        .polish-reject:hover{border-color:rgba(255,255,255,0.3)}
        .send-ai-modal-overlay,.confirm-modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:1100;opacity:0;visibility:hidden;transition:all 150ms ease}
        .send-ai-modal-overlay.active,.confirm-modal-overlay.active{opacity:1;visibility:visible}
        .confirm-modal{background:linear-gradient(180deg,#111 0%,#0a0a0a 100%);border:1px solid rgba(255,255,255,0.1);border-radius:16px;padding:28px;max-width:380px;width:90%;text-align:center;box-shadow:0 8px 32px rgba(0,0,0,0.5)}
        .confirm-modal-icon{font-size:2.5rem;margin-bottom:16px}
        .confirm-modal h3{font-family:var(--font-heading);font-size:1.125rem;font-weight:700;margin-bottom:12px}
        .confirm-modal p{color:#A0A0A0;font-size:0.8125rem;font-weight:400;margin-bottom:24px;line-height:1.5}
        .confirm-modal-actions{display:flex;gap:12px}
        .confirm-modal-cancel{flex:1;padding:12px 20px;background:#1a1a1a;border:1px solid rgba(255,255,255,0.15);border-radius:12px;color:#fff;font-size:0.9375rem;font-weight:500;cursor:pointer;transition:all 150ms ease}
        .confirm-modal-cancel:hover{background:#222;border-color:rgba(255,255,255,0.25)}
        .confirm-modal-confirm{flex:1;padding:12px 20px;background:#ef4444;border:none;border-radius:12px;color:#fff;font-size:0.9375rem;font-weight:600;cursor:pointer;transition:all 150ms ease}
        .confirm-modal-confirm:hover{background:#dc2626}
        .confirm-modal-confirm.success{background:rgb(52,211,153)}
        .confirm-modal-confirm.success:hover{background:rgb(45,185,135)}
        .send-ai-modal{background:linear-gradient(180deg,#111 0%,#0a0a0a 100%);border:1px solid rgba(255,255,255,0.1);border-radius:16px;padding:28px;max-width:480px;width:90%;max-height:90vh;overflow-y:auto;box-shadow:0 8px 32px rgba(0,0,0,0.5)}
        .send-ai-modal h3{font-family:var(--font-heading);font-size:1.25rem;font-weight:700;margin-bottom:8px;display:flex;align-items:center;gap:10px}
        .send-ai-subtitle{color:#A0A0A0;font-size:0.8125rem;font-weight:400;margin-bottom:24px}
        .send-ai-section{margin-bottom:24px}
        .send-ai-label{display:block;font-size:0.75rem;font-weight:400;color:#707070;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:12px}
        .send-ai-reasons{display:flex;flex-direction:column;gap:10px}
        .reason-btn{padding:14px 18px;background:#1a1a1a;border:1px solid rgba(255,255,255,0.1);border-radius:12px;color:rgba(255,255,255,0.9);font-size:0.9375rem;text-align:left;cursor:pointer;transition:all 150ms ease;display:flex;align-items:center;gap:10px}
        .reason-btn:hover{border-color:rgba(255,255,255,0.25);background:#222}
        .reason-btn.active{border-color:rgb(52,211,153);background:rgba(52,211,153,0.1)}
        .send-ai-other-input{width:100%;margin-top:10px;padding:14px;background:#1a1a1a;border:1px solid #2a2a2a;border-radius:12px;color:#fff;font-size:0.9375rem;resize:none;min-height:80px;transition:border-color 150ms ease}
        .send-ai-other-input:focus{outline:2px solid var(--accent);outline-offset:2px;border-color:var(--accent)}
        .send-ai-timing{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
        .timing-btn{padding:12px 16px;background:#1a1a1a;border:1px solid rgba(255,255,255,0.1);border-radius:12px;color:rgba(255,255,255,0.9);font-size:0.875rem;cursor:pointer;transition:all 150ms ease}
        .timing-btn:hover{border-color:rgba(255,255,255,0.25);background:#222}
        .timing-btn.active{border-color:rgb(52,211,153);background:rgba(52,211,153,0.1)}
        .timing-btn:nth-child(5){grid-column:span 2}
        .send-ai-date-input{width:100%;margin-top:10px;padding:14px;background:#1a1a1a;border:1px solid #2a2a2a;border-radius:12px;color:#fff;font-size:0.9375rem;transition:border-color 150ms ease}
        .send-ai-date-input:focus{outline:2px solid var(--accent);outline-offset:2px;border-color:var(--accent)}
        .send-ai-time-pref{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
        .time-pref-btn{padding:12px 16px;background:#1a1a1a;border:1px solid rgba(255,255,255,0.1);border-radius:12px;color:rgba(255,255,255,0.9);font-size:0.875rem;cursor:pointer;transition:all 150ms ease}
        .time-pref-btn:hover{border-color:rgba(255,255,255,0.25);background:#222}
        .time-pref-btn.active{border-color:rgb(52,211,153);background:rgba(52,211,153,0.1)}
        .send-ai-actions{display:flex;gap:12px;margin-top:28px}
        .send-ai-cancel{flex:1;padding:14px;background:#1a1a1a;border:1px solid rgba(255,255,255,0.15);border-radius:12px;color:rgba(255,255,255,0.8);font-size:0.9375rem;font-weight:600;cursor:pointer;transition:all 150ms ease}
        .send-ai-cancel:hover{border-color:rgba(255,255,255,0.3)}
        .send-ai-confirm{flex:1.5;padding:14px;background:rgb(52,211,153);border:none;border-radius:12px;color:#000;font-size:0.9375rem;font-weight:600;cursor:pointer;transition:all 150ms ease}
        .send-ai-confirm:hover{background:rgb(45,190,135)}
        .send-ai-confirm:disabled{opacity:0.5;cursor:not-allowed}
        @media(max-width:600px){.polish-comparison{grid-template-columns:1fr}}
        .lead-modal-body{padding:24px;overflow-y:auto;flex:1}
        .lead-info-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:24px;padding:0}
        .lead-info-item{display:flex;justify-content:space-between;align-items:center;padding:12px 18px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07);border-radius:12px}
        .lead-info-item label{display:block;font-size:0.75rem;font-weight:400;color:#707070;margin-bottom:0;white-space:nowrap}
        .lead-info-item .value{font-size:0.875rem;font-weight:600;color:#FFFFFF;text-align:right}
        .send-ai-calendar{margin-top:16px;background:#1a1a1a;border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:16px}
        .lead-section{margin-bottom:20px;padding:24px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.06);border-radius:14px}
        .lead-section h3{font-family:var(--font-heading);font-size:1rem;font-weight:700;text-transform:uppercase;letter-spacing:0.05em;margin-bottom:14px;display:flex;align-items:center;gap:8px;color:#FFFFFF}
        .lead-section.collapsible-empty{padding:0;background:none;border:none;margin-bottom:12px}
        .lead-section.collapsible-empty .collapsible-header{display:flex;align-items:center;gap:8px;padding:12px 16px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.06);border-radius:12px;cursor:pointer;transition:all 150ms ease;width:100%}
        .lead-section.collapsible-empty .collapsible-header:hover{background:rgba(255,255,255,0.04);border-color:rgba(255,255,255,0.1)}
        .lead-section.collapsible-empty .collapsible-header h3{margin-bottom:0;font-size:0.8125rem;font-weight:600}
        .collapsible-chevron{transition:transform 0.2s;color:#707070;flex-shrink:0;margin-left:auto}
        .lead-section.collapsible-empty.expanded .collapsible-chevron{transform:rotate(90deg)}
        .collapsible-body{display:none;padding:12px 16px 16px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.06);border-top:none;border-radius:0 0 10px 10px;margin-top:-1px}
        .lead-section.collapsible-empty.expanded .collapsible-body{display:block}
        .lead-section.collapsible-empty.expanded .collapsible-header{border-radius:12px 10px 0 0}
        .lead-summary-content{font-size:0.8125rem;font-weight:400;line-height:1.6;color:#A0A0A0;white-space:pre-wrap}
        .lead-notes-list{max-height:150px;overflow-y:auto;margin-bottom:12px}
        .lead-note-item{padding:10px 12px;background:rgba(255,255,255,0.05);border-radius:12px;margin-bottom:8px;font-size:0.8125rem;position:relative}
        .lead-note-item:last-child{margin-bottom:0}
        .lead-note-item .note-content{margin-bottom:4px}
        .lead-note-item .note-date{font-size:0.6875rem;font-weight:400;color:#707070}
        .lead-note-item .note-actions{position:absolute;bottom:8px;right:8px;display:flex;gap:4px;opacity:0;transition:opacity 150ms ease}
        .lead-note-item:hover .note-actions{opacity:1}
        .lead-note-item .note-edit-input{width:100%;min-height:60px;padding:8px;background:#0a0a0a;border:1px solid rgba(52,211,153,0.5);border-radius:8px;color:#fff;font-size:0.8125rem;resize:vertical;margin-bottom:8px}
        .lead-note-item .note-edit-actions{display:flex;gap:8px;justify-content:flex-end}
        .lead-note-item .note-edit-actions button{padding:6px 12px;border-radius:8px;font-size:0.75rem;font-weight:600;cursor:pointer}
        .lead-note-item .btn-note-save{background:rgb(52,211,153);border:none;color:#000}
        .lead-note-item .btn-note-cancel{background:#333;border:1px solid rgba(255,255,255,0.2);color:#fff}
        .lead-note-date{font-size:0.6875rem;font-weight:400;color:#707070;margin-top:4px}
        #modalNotesInput{width:100%;min-height:80px;padding:12px;background:#0a0a0a;border:1px solid #2a2a2a;border-radius:12px;color:#fff;font-size:0.875rem;resize:vertical;margin-bottom:8px;transition:border-color 150ms ease}
#modalNotesInput:focus{outline:2px solid var(--accent);outline-offset:2px;border-color:var(--accent)}
        .lead-notes-actions{display:flex;justify-content:flex-end}
        .attempts-count{background:rgba(255,255,255,0.1);padding:2px 8px;border-radius:12px;font-size:0.75rem;font-weight:500}
        .lead-attempts-list{max-height:120px;overflow-y:auto}
        .lead-attempt-item{padding:8px 12px;background:rgba(255,255,255,0.05);border-radius:12px;margin-bottom:6px;font-size:0.8125rem;display:flex;justify-content:space-between}
        .lead-transcript{font-size:0.8125rem;font-weight:400;line-height:1.7;color:#A0A0A0;max-height:200px;overflow-y:auto;white-space:pre-wrap}
        .lead-transcript .speaker-ai{color:#fff;font-weight:600}
        .lead-transcript .speaker-prospect{color:rgb(52,211,153);font-weight:600}
        .lead-transcript-line{margin-bottom:8px}

        /* Lead Modal Centered Animation */
        #leadModal{display:flex !important;justify-content:center;align-items:center;padding:24px;visibility:hidden;opacity:0;pointer-events:none;background:rgba(0,0,0,0);backdrop-filter:blur(0px);transition:opacity 150ms ease,visibility 150ms ease,backdrop-filter 150ms ease,background 150ms ease}
        #leadModal.active{visibility:visible;opacity:1;pointer-events:auto;background:rgba(0,0,0,0.5);backdrop-filter:blur(8px)}
        #leadModal .lead-modal{max-height:90vh;height:auto;border-radius:16px;transform:scale(0.95);opacity:0;transition:transform 150ms ease,opacity 150ms ease}
        #leadModal.active .lead-modal{transform:scale(1);opacity:1;transition:transform 150ms ease,opacity 150ms ease}
        /* AI Summary Section */
        #aiSummarySection{border-left:3px solid #38BDF8;background:rgba(56,189,248,0.05)}
        #aiSummarySection .lead-summary-content{font-size:14px;font-weight:400;line-height:1.6;color:#B0B0B0}
        .ai-date-pill{font-size:11px !important;font-weight:400 !important;color:rgba(255,255,255,0.45) !important;background:rgba(255,255,255,0.06) !important;padding:2px 10px !important;border-radius:12px !important;display:inline-block}
        #aiSummarySection .ai-status-badge{font-size:11px !important;padding:2px 10px !important;border-radius:12px !important;width:auto !important;height:auto !important;opacity:0.75}
        /* Notes Timeline */
        #modalNotesList:has(.lead-note-item){position:relative;padding-left:24px}
        #modalNotesList:has(.lead-note-item)::before{content:'';position:absolute;left:7px;top:12px;bottom:12px;width:1px;background:#2a2a2a}
        #modalNotesList .lead-note-item{position:relative;background:transparent;border-radius:0;padding:8px 12px;margin-bottom:0}
        #modalNotesList .lead-note-item::before{content:'';position:absolute;left:-21px;top:10px;width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,0.2)}
        /* Transcript Speaker Colors */
        .lead-transcript{line-height:1.5}
        .lead-transcript .speaker-ai{color:#6EE7A0;font-weight:600}
        .lead-transcript .speaker-prospect{color:#F87171;font-weight:600}
        .lead-transcript-line{padding-left:12px;margin-bottom:10px}

        /* Attachments Section */
        .lead-attachments-list{display:flex;flex-direction:column;gap:8px;margin-bottom:12px;max-height:200px;overflow-y:auto}
        .lead-attachment-item{display:flex;align-items:center;gap:10px;padding:10px 12px;background:rgba(255,255,255,0.05);border-radius:12px;transition:all 150ms ease}
        .lead-attachment-item:hover{background:rgba(255,255,255,0.08)}
        .attachment-icon{font-size:1.25rem;flex-shrink:0}
        .attachment-info{flex:1;min-width:0}
        .attachment-title{font-size:0.875rem;font-weight:500;color:#fff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .attachment-url{font-size:0.6875rem;font-weight:400;color:#707070;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .attachment-actions{display:flex;gap:4px}
        .btn-attachment-open{background:rgba(59,130,246,0.15);border:1px solid rgba(59,130,246,0.3);color:#3b82f6;padding:6px 10px;border-radius:8px;font-size:0.75rem;font-weight:500;cursor:pointer;transition:all 150ms ease;text-decoration:none}
        .btn-attachment-open:hover{background:rgba(59,130,246,0.25)}
        .btn-attachment-delete{background:none;border:none;color:rgba(239,68,68,0.7);cursor:pointer;font-size:0.875rem;padding:4px 6px;border-radius:4px;transition:all 150ms ease}
        .btn-attachment-delete:hover{color:#ef4444;background:rgba(239,68,68,0.1)}
        .add-attachment-form{display:flex;flex-direction:column;gap:10px}
        .add-attachment-row{display:flex;gap:8px}
        .add-attachment-row input{flex:1;padding:10px 12px;background:#0a0a0a;border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:#fff;font-size:0.875rem}
        .add-attachment-row input::placeholder{color:rgba(255,255,255,0.4)}
        .btn-add-attachment{padding:10px 16px;background:rgb(52,211,153);border:none;color:#000;border-radius:8px;font-size:0.875rem;font-weight:600;cursor:pointer;transition:all 150ms ease;white-space:nowrap}
        .btn-add-attachment:hover{opacity:0.9}
        .btn-add-attachment:disabled{opacity:0.5;cursor:not-allowed}
        .attachments-empty{color:#707070;font-size:0.8125rem;font-weight:400;padding:12px;text-align:center}

        /* Share Button */
        .btn-share{padding:10px 16px;font-size:0.875rem;font-weight:600;background:rgba(59,130,246,0.15);color:#3b82f6;border:1px solid rgba(59,130,246,0.3);border-radius:8px;cursor:pointer;transition:all 150ms ease;display:inline-flex;align-items:center;gap:6px}
        .btn-share:hover{background:rgba(59,130,246,0.25);transform:scale(1.02);box-shadow:0 4px 12px rgba(0,0,0,0.3)}
        .btn-share.shared{background:rgba(52,211,153,0.15);color:rgb(52,211,153);border-color:rgba(52,211,153,0.3)}
        
        /* Schedule Button */
        .btn-schedule{padding:6px 12px;font-size:0.75rem;font-weight:600;background:rgba(52,211,153,0.15);color:rgb(52,211,153);border:1px solid rgba(52,211,153,0.3);border-radius:8px;cursor:pointer;transition:all 150ms ease;display:inline-flex;align-items:center;gap:4px}
        .btn-schedule:hover{background:rgba(52,211,153,0.25)}
        
        /* Booked Time Display */
        .booked-time-display{display:flex;align-items:center;gap:8px}
        .booked-time-value{font-weight:500}
        .btn-delete-booking,.btn-delete-attempt,.btn-delete-note{background:none;border:none;color:rgba(239,68,68,0.7);cursor:pointer;font-size:0.875rem;padding:2px 6px;border-radius:4px;transition:all 150ms ease}
        .btn-delete-booking:hover,.btn-delete-attempt:hover,.btn-delete-note:hover{color:#ef4444;background:rgba(239,68,68,0.1)}
        .btn-edit-booking{background:none;border:none;color:rgba(59,130,246,0.7);cursor:pointer;font-size:0.875rem;padding:2px 6px;border-radius:4px;transition:all 150ms ease}
        .btn-edit-booking:hover{color:#3b82f6;background:rgba(59,130,246,0.1)}
        .btn-reschedule{background:none;border:none;color:#3b82f6;cursor:pointer;font-size:0.75rem;font-weight:600;padding:4px 10px;border-radius:4px;transition:all 150ms ease;text-decoration:none}
        .btn-reschedule:hover{text-decoration:underline}
        .btn-edit-note{background:none;border:none;color:rgba(59,130,246,0.7);cursor:pointer;font-size:0.875rem;padding:2px 6px;border-radius:4px;transition:all 150ms ease}
        .btn-edit-note:hover{color:#3b82f6;background:rgba(59,130,246,0.1)}
        
        /* Share Popup */
        .share-popup-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);z-index:1999;display:none}
        .share-popup-overlay.active{display:block}
        .share-popup{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#1a1a1a;border:1px solid rgba(255,255,255,0.1);border-radius:16px;padding:24px;min-width:320px;max-width:380px;box-shadow:0 8px 32px rgba(0,0,0,0.5);z-index:2000;display:none}
        .share-popup.active{display:block}
        .share-popup-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
        .share-popup-header h4{font-family:var(--font-heading);font-size:1.125rem;font-weight:700}
        .share-popup-close{background:none;border:none;color:rgba(255,255,255,0.5);cursor:pointer;font-size:1.5rem;padding:0;line-height:1}
        .share-popup-close:hover{color:#fff}
        .share-popup-agents{display:flex;flex-direction:column;gap:8px;margin-bottom:16px;max-height:280px;overflow-y:auto}
        .share-agent-option{display:flex;align-items:center;gap:10px;padding:12px 14px;background:#111;border:1px solid rgba(255,255,255,0.1);border-radius:12px;cursor:pointer;transition:all 150ms ease}
        .share-agent-option:hover{border-color:rgb(52,211,153);background:rgba(52,211,153,0.05)}
        .share-agent-option.selected{border-color:rgb(52,211,153);background:rgba(52,211,153,0.1)}
        .share-agent-option input{display:none}
        .share-agent-radio{width:18px;height:18px;border:2px solid rgba(255,255,255,0.2);border-radius:50%;display:flex;align-items:center;justify-content:center;transition:all 150ms ease;flex-shrink:0}
        .share-agent-option.selected .share-agent-radio{border-color:rgb(52,211,153)}
        .share-agent-option.selected .share-agent-radio::after{content:'';width:10px;height:10px;background:rgb(52,211,153);border-radius:50%}
        .share-agent-name{font-weight:500;font-size:0.9375rem}
        .share-popup-actions{display:flex;gap:10px}
        .share-popup-actions button{flex:1;padding:12px;border-radius:12px;font-size:0.875rem;font-weight:500;cursor:pointer;transition:all 150ms ease}
        .btn-share-confirm{background:rgb(52,211,153);border:none;color:#000}
        .btn-share-confirm:hover{opacity:0.9}
        .btn-share-confirm:disabled{opacity:0.5;cursor:not-allowed}
        .btn-share-cancel{background:#222;border:1px solid rgba(255,255,255,0.1);color:#fff}
        .btn-share-cancel:hover{background:#2a2a2a}
        .share-info-content{padding:4px 0}
        .share-info-label{font-size:0.75rem;font-weight:400;color:#707070;margin-bottom:4px;text-transform:uppercase;letter-spacing:0.5px}
        .share-info-name{font-size:0.9375rem;font-weight:500;color:#fff;padding:8px 12px;background:#111;border-radius:8px;margin-bottom:12px}
        
        /* Schedule Modal */
        .schedule-modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:1100;opacity:0;visibility:hidden;transition:all 150ms ease}
        .schedule-modal-overlay.active{opacity:1;visibility:visible}
        .schedule-modal{background:#1a1a1a;border:1px solid rgba(255,255,255,0.1);border-radius:16px;padding:24px;max-width:420px;width:90%;max-height:90vh;overflow-y:auto}
        .schedule-modal h3{font-family:var(--font-heading);margin-bottom:8px;font-size:1.25rem;font-weight:700}
        .schedule-modal .form-group{margin-bottom:16px}
        .schedule-modal label{display:block;margin-bottom:8px;font-size:0.8125rem;color:#A0A0A0;font-weight:400}
        .schedule-modal-actions{display:flex;gap:12px;margin-top:20px}
        .schedule-modal-actions button{flex:1;padding:12px;border-radius:8px;font-weight:500;cursor:pointer;transition:all 150ms ease}
        .schedule-modal .btn-cancel{background:#222;border:1px solid rgba(255,255,255,0.1);color:#fff}
        .schedule-modal .btn-save{background:rgb(52,211,153);border:none;color:#000}
        .schedule-modal .btn-save:hover{opacity:0.9}
        
        /* Calendar Picker */
        .calendar-picker{background:#111;border-radius:12px;padding:16px;border:1px solid rgba(255,255,255,0.1)}
        .calendar-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
        .calendar-header button{background:none;border:none;color:#fff;cursor:pointer;padding:8px;border-radius:8px;font-size:1.25rem}
        .calendar-header button:hover{background:rgba(255,255,255,0.1)}
        .calendar-month{font-family:var(--font-heading);font-weight:700;font-size:1rem}
        .calendar-weekdays{display:grid;grid-template-columns:repeat(7,1fr);text-align:center;margin-bottom:8px}
        .calendar-weekdays span{font-size:0.6875rem;color:#707070;font-weight:400;padding:8px 0}
        .calendar-days{display:grid;grid-template-columns:repeat(7,1fr);gap:4px}
        .calendar-day{aspect-ratio:1;display:flex;align-items:center;justify-content:center;border-radius:8px;cursor:pointer;font-size:0.875rem;transition:all 150ms ease;border:none;background:none;color:#fff}
        .calendar-day:hover:not(.disabled):not(.selected){background:rgba(255,255,255,0.1)}
        .calendar-day.selected{background:rgb(52,211,153);color:#000;font-weight:600}
        .calendar-day.today:not(.selected){border:2px solid rgb(52,211,153)}
        .calendar-day.disabled{color:rgba(255,255,255,0.3);cursor:not-allowed}
        .calendar-day.other-month{opacity:0.3}
        .calendar-day.past{color:rgba(255,255,255,0.3);cursor:not-allowed}
        .calendar-day.empty{cursor:default}
        @media(max-width:640px){.lead-info-grid{grid-template-columns:1fr;gap:8px}.lead-info-item{padding:10px 16px}}
        .spinner{width:32px;height:32px;border:3px solid rgba(255,255,255,0.1);border-top-color:rgb(52,211,153);border-radius:50%;animation:spin 0.8s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}

        /* Dashboard Loading State */
        .dashboard-loading-overlay{position:absolute;top:0;left:0;right:0;bottom:0;background:#111;display:flex;align-items:center;justify-content:center;z-index:5;border-radius:12px}
        .dashboard-loading-spinner{width:24px;height:24px;border:2px solid rgba(255,255,255,0.1);border-top-color:rgb(52,211,153);border-radius:50%;animation:spin 0.8s linear infinite}
        .overview-card{position:relative;overflow:hidden}
        .stat-card{position:relative;overflow:hidden}
        .today-number-item{position:relative;overflow:hidden}
        .header-stat-badge{position:relative;overflow:hidden}
        .dashboard-loading .overview-card .dashboard-loading-overlay,
        .dashboard-loading .stat-card .dashboard-loading-overlay,
        .dashboard-loading .today-number-item .dashboard-loading-overlay,
        .dashboard-loading .header-stat-badge .dashboard-loading-overlay{display:flex}
        .overview-card .dashboard-loading-overlay,
        .stat-card .dashboard-loading-overlay,
        .today-number-item .dashboard-loading-overlay,
        .header-stat-badge .dashboard-loading-overlay{display:none}
        .overview-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:1rem;margin-bottom:2rem}
        @media(min-width:768px){.overview-grid{grid-template-columns:repeat(4,1fr)}}
        .overview-card{background:linear-gradient(180deg,rgba(255,255,255,0.03) 0%,transparent 100%);border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:1.25rem;cursor:pointer;transition:all 150ms ease;border-bottom:2px solid rgba(255,255,255,0.1);box-shadow:0 1px 2px rgba(0,0,0,0.2)}
        .overview-card:hover{border-color:rgba(255,255,255,0.2);transform:translateY(-2px)}
        .overview-card.card-green{border-bottom-color:#34D399}
        .overview-card.card-green:hover{border-color:rgba(52,211,153,0.4);border-bottom-color:#34D399}
        .overview-card.card-blue{border-bottom-color:#3B82F6}
        .overview-card.card-blue:hover{border-color:rgba(59,130,246,0.4);border-bottom-color:#3B82F6}
        .overview-card.card-orange{border-bottom-color:#F59E0B}
        .overview-card.card-orange:hover{border-color:rgba(245,158,11,0.4);border-bottom-color:#F59E0B}
        .overview-card.card-purple{border-bottom-color:#8B5CF6}
        .overview-card.card-purple:hover{border-color:rgba(139,92,246,0.4);border-bottom-color:#8B5CF6}
        .overview-card.highlight{background:rgba(52,211,153,0.1);border-color:rgb(52,211,153)}
        .overview-card-header{display:flex;align-items:center;gap:0.625rem;margin-bottom:0.75rem}
        .overview-card-header h4{font-family:var(--font-heading);font-size:0.875rem;font-weight:700;color:rgba(255,255,255,0.8)}
        .overview-card-icon{font-size:0.875rem;width:28px;height:28px;display:flex;align-items:center;justify-content:center;border-radius:50%;flex-shrink:0}
        .card-green .overview-card-icon{background:rgba(52,211,153,0.15)}
        .card-blue .overview-card-icon{background:rgba(59,130,246,0.15)}
        .card-orange .overview-card-icon{background:rgba(245,158,11,0.15)}
        .card-purple .overview-card-icon{background:rgba(139,92,246,0.15)}
        .overview-card-value{font-family:var(--font-heading);font-size:2.25rem;font-weight:700;margin-bottom:0.25rem;line-height:1}
        .overview-card-desc{font-size:0.75rem;font-weight:500;color:rgba(255,255,255,0.5);text-transform:uppercase;letter-spacing:0.04em}
        .today-numbers-bar{display:flex;align-items:stretch;background:rgba(255,255,255,0.02);border:1px solid #1a1a1a;border-radius:16px;margin-bottom:2rem;overflow:hidden;position:relative}
        .today-number-item{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:1.25rem 0.75rem;gap:0.25rem;position:relative;overflow:hidden}
        .today-number-icon{font-size:1.125rem;margin-bottom:0.125rem}
        .today-number-value{font-family:var(--font-heading);font-size:1.5rem;font-weight:700;line-height:1;color:#FFFFFF}
        .today-number-label{font-size:0.6875rem;font-weight:500;color:rgba(255,255,255,0.45);text-transform:uppercase;letter-spacing:0.04em}
        .today-numbers-divider{width:1px;background:#2a2a2a;align-self:stretch;flex-shrink:0}
        .today-number-item .dashboard-loading-overlay{border-radius:0}
        .meetings-list{display:flex;flex-direction:column;gap:0.5rem}
        .meetings-empty{text-align:center;padding:2rem;color:#707070;background:#111;border-radius:12px}
        .welcome-meta{display:flex;gap:16px;align-items:center;flex-wrap:wrap}
        .welcome-phone,.welcome-usage{background:#111;padding:8px 14px;border-radius:8px;font-size:0.8125rem;display:flex;align-items:center;gap:8px}
        .phone-label,.usage-label{color:#707070}
        .phone-value{color:rgb(52,211,153);font-weight:600;font-family:monospace}
        .usage-value{font-weight:600}
        .priorities-list{display:flex;flex-direction:column;gap:10px}
        .priorities-empty{text-align:center;padding:40px;color:#707070;background:#111;border-radius:12px}
        .priority-card{background:#111;border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:16px 20px;display:grid;grid-template-columns:auto 1fr auto auto;gap:16px;align-items:center;cursor:pointer;transition:all 150ms ease}
        .priority-card:hover{border-color:rgb(52,211,153);background:#151515}
        .priority-time{background:rgba(52,211,153,0.15);color:rgb(52,211,153);padding:8px 12px;border-radius:8px;font-weight:600;font-size:0.875rem;text-align:center;min-width:80px}
        .priority-info{min-width:0}
        .priority-name{font-family:var(--font-heading);font-weight:700;margin-bottom:2px}
        .priority-details{font-size:0.6875rem;font-weight:400;color:#707070}
        .priority-type{font-size:0.6875rem;padding:4px 10px;border-radius:4px;font-weight:600;text-transform:uppercase}
        .priority-type.booked{background:rgba(52,211,153,0.15);color:rgb(52,211,153)}
        .priority-type.callback{background:rgba(245,158,11,0.15);color:#f59e0b}
        .priority-arrow{color:rgba(255,255,255,0.3);font-size:1.25rem}
        .meeting-card{background:#111;border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:1rem;display:flex;align-items:center;gap:1rem}
        .meeting-time{background:rgba(52,211,153,0.15);color:rgb(52,211,153);padding:0.5rem 0.75rem;border-radius:8px;font-weight:600;font-size:0.875rem}
        .meeting-info{flex:1}
        .meeting-name{font-family:var(--font-heading);font-weight:700;margin-bottom:0.25rem}
        .meeting-details{font-size:0.8125rem;font-weight:400;color:#A0A0A0}
        .prio-empty{text-align:center;padding:3rem;color:#707070}
        
        /* Profile Menu */
        .profile-menu{position:absolute;bottom:100%;left:0;right:0;background:#151515;border:1px solid rgba(255,255,255,0.1);border-radius:12px;margin:0 0.5rem 0.5rem;padding:0.5rem;opacity:0;visibility:hidden;transform:translateY(10px);transition:all 150ms ease}
        .profile-menu.active{opacity:1;visibility:visible;transform:translateY(0)}
        .profile-menu-item{display:flex;align-items:center;gap:0.75rem;padding:0.75rem 1rem;border-radius:8px;cursor:pointer;font-size:0.875rem;color:rgba(255,255,255,0.8);transition:all 150ms ease}
        .profile-menu-item:hover{background:rgba(255,255,255,0.05)}
        .profile-menu-item.logout{color:#ef4444}
        .profile-menu-item.logout:hover{background:rgba(239,68,68,0.1)}
        .profile-menu-divider{height:1px;background:rgba(255,255,255,0.1);margin:0.5rem 0}
        
        /* Notifications Popup */
        .notifications-popup{position:absolute;bottom:100%;left:0;width:280px;background:#151515;border:1px solid rgba(255,255,255,0.1);border-radius:12px;margin-bottom:0.5rem;opacity:0;visibility:hidden;transform:translateY(10px);transition:all 150ms ease;z-index:1000}
        .notifications-popup.active{opacity:1;visibility:visible;transform:translateY(0)}
        .notifications-header{padding:1rem;border-bottom:1px solid rgba(255,255,255,0.1);font-weight:600;font-size:0.875rem}
        .notifications-empty{padding:2rem;text-align:center;color:#707070;font-size:0.8125rem;font-weight:400}
        
        .sidebar-footer{position:relative}
        
        /* Settings Page */
        .settings-card{background:#111;border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:1.5rem;margin-bottom:1rem}
        .settings-card.danger{border-color:rgba(239,68,68,0.3)}
        .settings-title{font-family:var(--font-heading);font-size:1rem;font-weight:700;margin-bottom:1rem}
        .profile-header{display:flex;align-items:center;gap:1.5rem;flex-wrap:wrap}
        .profile-avatar-lg{width:80px;height:80px;border-radius:50%;background:rgb(52,211,153);display:flex;align-items:center;justify-content:center;font-size:2rem;font-weight:600;color:#000;overflow:hidden;flex-shrink:0}
        .profile-avatar-lg img{width:100%;height:100%;object-fit:cover}
        .profile-info h2{font-family:var(--font-heading);font-size:1.25rem;font-weight:700;margin-bottom:0.25rem}
        .profile-info p{color:#A0A0A0;font-size:0.8125rem;font-weight:400;margin-bottom:0.75rem}
        .profile-actions{display:flex;gap:0.5rem}
        .form-row{display:grid;grid-template-columns:1fr;gap:1rem;margin-bottom:1rem}
        @media(min-width:640px){.form-row{grid-template-columns:repeat(2,1fr)}}
        .form-group{margin-bottom:1rem}
        .form-group:last-child{margin-bottom:0}
        .form-group label{display:block;font-size:0.8125rem;font-weight:400;color:#A0A0A0;margin-bottom:0.5rem}
        .form-group input,.form-group select{width:100%;padding:0.75rem 1rem;background:#1a1a1a;border:1px solid #2a2a2a;border-radius:8px;color:#fff;font-size:0.9375rem;transition:border-color 150ms ease}
        .form-group input:focus,.form-group select:focus{outline:2px solid var(--accent);outline-offset:2px;border-color:var(--accent)}
        .form-group input::placeholder{color:rgba(255,255,255,0.4)}
        .form-message{font-size:0.875rem;padding:0.75rem;border-radius:8px;margin-bottom:1rem;display:none}
        .form-message:not(:empty){display:block}
        .form-message.success{background:rgba(52,211,153,0.1);color:rgb(52,211,153);border:1px solid rgba(52,211,153,0.3)}
        .form-message.error{background:rgba(239,68,68,0.1);color:#ef4444;border:1px solid rgba(239,68,68,0.3)}
        
        /* Synced Input Styles */
        .sync-badge{font-size:0.625rem;background:rgba(52,211,153,0.15);color:rgb(52,211,153);padding:2px 6px;border-radius:4px;margin-left:8px}
        .input-synced{background:#0a0a0a !important;color:rgba(255,255,255,0.5) !important;cursor:not-allowed}
        .sync-notice{font-size:0.6875rem;font-weight:400;color:#707070;margin:8px 0 16px;padding:10px 12px;background:rgba(52,211,153,0.05);border-radius:8px;border-left:3px solid rgb(52,211,153)}
        
        /* Billing Styles */
        .billing-plan-card{background:#0a0a0a;border-radius:12px;padding:20px}
        .billing-plan-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:12px}
        .billing-plan-info{display:flex;align-items:center;gap:12px}
        .billing-plan-name{font-family:var(--font-heading);font-size:1.25rem;font-weight:700;color:rgb(52,211,153)}
        .billing-status-badge{padding:4px 10px;border-radius:8px;font-size:0.75rem;font-weight:500}
        .billing-status-badge.active{background:rgba(52,211,153,0.15);color:rgb(52,211,153)}
        .billing-status-badge.paused{background:rgba(245,158,11,0.15);color:#f59e0b}
        .billing-plan-price{display:flex;align-items:baseline;gap:2px}
        .price-amount{font-family:var(--font-heading);font-size:1.5rem;font-weight:700}
        .price-period{font-size:0.6875rem;font-weight:400;color:#707070}
        .billing-plan-details{display:flex;gap:24px;margin-bottom:16px;flex-wrap:wrap}
        .billing-detail{display:flex;flex-direction:column;gap:4px}
        .detail-label{font-size:0.75rem;font-weight:400;color:#707070}
        .detail-value{font-size:0.9rem;font-weight:500}
        .billing-payment-card{display:flex;align-items:center;gap:16px;background:#0a0a0a;border-radius:12px;padding:16px 20px}
        .payment-icon{font-size:1.5rem}
        .payment-details{flex:1}
        .payment-brand{font-weight:600;font-size:0.9rem;display:block}
        .payment-number{font-size:0.6875rem;font-weight:400;color:#707070}
        .billing-usage{background:#0a0a0a;border-radius:12px;padding:20px}
        .usage-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:12px;text-align:center}
        .usage-value{font-family:var(--font-heading);font-size:1.5rem;font-weight:700;display:block}
        .usage-label{font-size:0.75rem;font-weight:400;color:#707070}
        .usage-bar{height:8px;background:#1a1a1a;border-radius:4px;overflow:hidden}
        .usage-fill{height:100%;background:linear-gradient(90deg,rgb(52,211,153),#8B5CF6);border-radius:4px;transition:width 0.3s}
        .billing-history{max-height:200px;overflow-y:auto}
        .billing-actions{display:flex;gap:12px;flex-wrap:wrap}
        
        /* Help Styles */
        .help-search{position:relative;margin-bottom:20px}
        .help-search input{width:100%;padding:12px 16px 12px 44px;background:#0a0a0a;border:1px solid #2a2a2a;border-radius:8px;color:#fff;font-size:0.9375rem;transition:border-color 150ms ease}
        .help-search input:focus{outline:2px solid var(--accent);outline-offset:2px;border-color:var(--accent)}
        .help-search-icon{position:absolute;left:16px;top:50%;transform:translateY(-50%);opacity:0.5}
        .help-quick-links{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;margin-bottom:24px}
        .help-quick-link{padding:12px;background:#0a0a0a;border:1px solid rgba(255,255,255,0.1);border-radius:8px;text-align:center;font-size:0.8125rem;cursor:pointer;transition:all 150ms ease}
        .help-quick-link:hover{border-color:rgb(52,211,153);background:rgba(52,211,153,0.05)}
        .help-category{background:#111;border:1px solid rgba(255,255,255,0.1);border-radius:12px;margin-bottom:12px;overflow:hidden}
        .help-category-header{display:flex;align-items:center;gap:12px;padding:16px;cursor:pointer;transition:background 150ms ease}
        .help-category-header:hover{background:rgba(255,255,255,0.03)}
        .help-category-icon{font-size:1.25rem}
        .help-category-title{flex:1;font-weight:600}
        .help-category-arrow{color:rgba(255,255,255,0.4);transition:transform 150ms ease}
        .help-category.open .help-category-arrow{transform:rotate(180deg)}
        .help-category-content{display:none;border-top:1px solid rgba(255,255,255,0.1)}
        .help-category.open .help-category-content{display:block}
        .help-item{border-bottom:1px solid rgba(255,255,255,0.05)}
        .help-item:last-child{border-bottom:none}
        .help-item-header{display:flex;align-items:center;gap:12px;padding:14px 16px;cursor:pointer}
        .help-item-header:hover{background:rgba(52,211,153,0.03)}
        .help-question{flex:1;font-size:0.9rem}
        .help-toggle{color:rgb(52,211,153);font-size:1.25rem}
        .help-item.open .help-toggle{transform:rotate(45deg)}
        .help-answer{display:none;padding:0 16px 16px;color:#A0A0A0;font-size:0.8125rem;font-weight:400;line-height:1.6}
        .help-item.open .help-answer{display:block}
        .help-answer ul{margin:8px 0 8px 20px}
        .help-answer li{margin-bottom:6px}
        .help-support{display:flex;align-items:center;gap:16px;margin-bottom:16px}
        .help-support-icon{font-size:2rem}
        .help-support h4{font-family:var(--font-heading);font-weight:700;margin-bottom:4px}
        .help-support-actions{display:flex;gap:12px;flex-wrap:wrap}
        
        @media(max-width:640px){
            .usage-stats{grid-template-columns:1fr}
            .billing-plan-details{flex-direction:column;gap:12px}
            .billing-actions{flex-direction:column}
            .billing-actions .btn{width:100%}
            .help-support-actions{flex-direction:column}
            .help-support-actions .btn{width:100%}
        }

        /* Feedback Form */
        /* Contact Us Page */
        .contact-hero{background:linear-gradient(135deg,rgba(52,211,153,0.12) 0%,rgba(59,130,246,0.08) 100%);border:1px solid rgba(52,211,153,0.15);border-radius:16px;padding:40px 32px;margin-bottom:24px}
        .contact-hero-inner{max-width:500px}
        .contact-hero-text h2{font-family:var(--font-heading);font-size:1.5rem;font-weight:700;margin-bottom:8px}
        .contact-hero-text p{color:#A0A0A0;font-size:0.8125rem;font-weight:400;line-height:1.5}
        .contact-grid{display:grid;grid-template-columns:280px 1fr;gap:24px}
        .contact-card-info{display:flex;flex-direction:column;gap:16px}
        .contact-info-item{background:#111;border:1px solid rgba(255,255,255,0.08);border-radius:12px;padding:20px;display:flex;gap:14px;align-items:flex-start}
        .contact-info-icon{font-size:1.25rem;flex-shrink:0;width:36px;height:36px;background:rgba(52,211,153,0.1);border-radius:8px;display:flex;align-items:center;justify-content:center}
        .contact-info-label{font-size:0.75rem;font-weight:400;color:#707070;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px}
        .contact-info-value{font-size:0.875rem;color:rgba(255,255,255,0.85);font-weight:500}
        a.contact-info-value{color:rgb(52,211,153);text-decoration:none}
        a.contact-info-value:hover{text-decoration:underline}
        .contact-card-form{background:#111;border:1px solid rgba(255,255,255,0.08);border-radius:12px;padding:28px}
        .contact-form-group{margin-bottom:24px}
        .contact-form-label{display:block;font-size:0.875rem;font-weight:600;color:rgba(255,255,255,0.85);margin-bottom:10px}
        .contact-category-chips{display:flex;flex-wrap:wrap;gap:8px}
        .contact-chip{cursor:pointer}
        .contact-chip input{display:none}
        .contact-chip span{display:inline-block;padding:8px 16px;border:1px solid rgba(255,255,255,0.12);border-radius:20px;font-size:0.8125rem;font-weight:500;color:rgba(255,255,255,0.6);background:transparent;transition:all 150ms ease}
        .contact-chip:hover span{border-color:rgba(255,255,255,0.25);color:rgba(255,255,255,0.85)}
        .contact-chip input:checked+span{background:rgba(52,211,153,0.15);border-color:rgb(52,211,153);color:rgb(52,211,153)}
        .contact-textarea{width:100%;padding:14px 16px;background:#0a0a0a;border:1px solid #2a2a2a;border-radius:12px;color:#fff;font-size:0.9375rem;font-family:inherit;resize:vertical;min-height:120px;transition:border-color 150ms ease}
        .contact-textarea:focus{outline:2px solid var(--accent);outline-offset:2px;border-color:var(--accent)}
        .contact-textarea::placeholder{color:rgba(255,255,255,0.3)}
        .contact-submit-btn{width:100%;padding:14px;background:rgb(52,211,153);color:#000;font-size:0.9375rem;font-weight:600;border:none;border-radius:12px;cursor:pointer;transition:all 150ms ease}
        .contact-submit-btn:hover{background:rgb(74,222,170);transform:translateY(-1px)}
        .contact-submit-btn:disabled{opacity:0.6;cursor:not-allowed;transform:none}
        .contact-success{text-align:center;padding:32px;background:rgba(52,211,153,0.08);border:1px solid rgba(52,211,153,0.15);border-radius:12px;margin-top:20px}
        .contact-success p{margin-top:12px;color:rgba(255,255,255,0.7)}
        @media(max-width:768px){.contact-grid{grid-template-columns:1fr}}
        /* Lead Gen Page */
        .leadgen-hero{background:linear-gradient(135deg,rgba(52,211,153,0.15) 0%,rgba(139,92,246,0.1) 100%);border:1px solid rgba(52,211,153,0.15);border-radius:16px;padding:40px 32px;margin-bottom:24px;text-align:center}
        .leadgen-hero h2{font-family:var(--font-heading);font-size:1.5rem;font-weight:700;margin-bottom:8px}
        .leadgen-hero p{color:rgba(255,255,255,0.6);font-size:0.9375rem;max-width:500px;margin:0 auto;line-height:1.5}
        .leadgen-pricing{max-width:480px;margin:0 auto}
        .leadgen-card{background:#111;border:1px solid rgba(52,211,153,0.2);border-radius:16px;overflow:hidden}
        .leadgen-card-header{background:linear-gradient(135deg,rgba(52,211,153,0.12),rgba(52,211,153,0.04));padding:28px 28px 20px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.06)}
        .leadgen-card-header h3{font-family:var(--font-heading);font-size:1.125rem;font-weight:700;margin-bottom:12px;color:rgba(255,255,255,0.9)}
        .leadgen-price{font-family:var(--font-heading);font-size:2.5rem;font-weight:800;color:rgb(52,211,153)}
        .leadgen-price-sub{font-size:0.875rem;color:rgba(255,255,255,0.5);margin-top:4px}
        .leadgen-card-body{padding:28px}
        .leadgen-breakdown{list-style:none;padding:0;margin:0 0 24px}
        .leadgen-breakdown li{display:flex;align-items:flex-start;gap:12px;padding:10px 0;border-bottom:1px solid rgba(255,255,255,0.05);font-size:0.875rem;color:rgba(255,255,255,0.75)}
        .leadgen-breakdown li:last-child{border-bottom:none}
        .leadgen-breakdown li .li-icon{color:rgb(52,211,153);font-size:1rem;flex-shrink:0;width:20px;text-align:center}
        .leadgen-breakdown li strong{color:rgba(255,255,255,0.9)}
        .leadgen-cta{width:100%;padding:14px;background:rgb(52,211,153);color:#000;font-size:0.9375rem;font-weight:600;border:none;border-radius:12px;cursor:pointer;transition:all 150ms ease}
        .leadgen-cta:hover{background:rgb(74,222,170);transform:translateY(-1px)}
        .leadgen-note{text-align:center;margin-top:16px;font-size:0.8125rem;color:rgba(255,255,255,0.4)}

        /* Filters Bar */
        .search-box{position:relative;flex:0 0 auto;min-width:200px;max-width:300px}
        .search-box input{width:100%;padding:10px 16px 10px 40px;background:#111;border:1px solid #2a2a2a;border-radius:8px;color:#fff;font-size:0.875rem;transition:border-color 150ms ease}
        .search-box input:focus{outline:2px solid var(--accent);outline-offset:2px;border-color:var(--accent)}
        .search-box .search-icon{position:absolute;left:12px;top:50%;transform:translateY(-50%);opacity:0.5}
        .filter-select{padding:10px 16px;background:#111;border:1px solid #2a2a2a;border-radius:16px;color:#fff;font-size:0.875rem;min-width:140px;cursor:pointer;transition:border-color 150ms ease}
        .filter-select:focus{outline:2px solid var(--accent);outline-offset:2px;border-color:var(--accent)}
        
        /* Data Table */
        .table-container{background:#111;border:1px solid rgba(255,255,255,0.1);border-radius:12px;overflow:hidden}
        .data-table{width:100%;border-collapse:collapse}
        .data-table th{text-align:left;padding:12px 16px;font-size:0.75rem;text-transform:uppercase;letter-spacing:0.05em;color:rgba(255,255,255,0.5);background:#0a0a0a;border-bottom:1px solid rgba(255,255,255,0.1);font-weight:600}
        .data-table th.sortable{cursor:pointer}
        .data-table th.sortable:hover{color:rgb(52,211,153)}
        .data-table th.sorted-asc::after{content:" ";color:rgb(52,211,153)}
        .data-table th.sorted-desc::after{content:" ";color:rgb(52,211,153)}
        .data-table td{padding:14px 16px;border-bottom:1px solid rgba(255,255,255,0.05);font-size:0.875rem;vertical-align:middle}
        .data-table tr:hover td{background:rgba(255,255,255,0.02)}
        .data-table tr:last-child td{border-bottom:none}
        .data-table .empty-state{text-align:center;padding:40px;color:rgba(255,255,255,0.4)}
        
        /* Status Badges */
        .status-badge{display:inline-block;padding:4px 16px;border-radius:20px;font-size:0.6875rem;font-weight:600}
        .status-badge.booked,.status-badge.meeting-booked{background:rgba(52,211,153,0.15);color:rgb(52,211,153)}
        .status-badge.callback{background:rgba(59,130,246,0.15);color:#3B82F6}
        .status-badge.timeline{background:rgba(245,158,11,0.15);color:#f59e0b}
        .status-badge.follow-up{background:rgba(139,92,246,0.15);color:#8B5CF6}
        .status-badge.interested{background:rgba(52,211,153,0.1);color:rgb(52,211,153)}
        .status-badge.not-interested{background:rgba(239,68,68,0.1);color:#ef4444}
        
        /* Prospects Header */
        .prospects-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:1.5rem;flex-wrap:wrap;gap:1rem}
        .prospects-header-text h2{font-family:var(--font-heading);font-size:1.5rem;font-weight:800;margin-bottom:0.5rem;color:#FFFFFF}
        .prospects-header-text p{color:#A0A0A0;font-size:0.8125rem;font-weight:400}
        .prospects-list{display:grid;grid-template-columns:1fr;gap:1rem;padding:0}
        .prospects-list.list-view{grid-template-columns:1fr}
        .prospects-list:not(.list-view){grid-template-columns:repeat(auto-fill,minmax(340px,1fr))}
        .prospects-list:not(.list-view) .priority-card-lg{flex-direction:column;min-height:320px}
        .prospects-list:not(.list-view) .priority-card-lg-left{flex:none;border-right:none;border-bottom:1px solid rgba(255,255,255,0.08)}
        .prospects-list:not(.list-view) .priority-card-lg-time-col{flex:0 0 60px}
        .prospects-list:not(.list-view) .priority-card-lg-summary-col{flex:1;border-right:none;border-bottom:1px solid rgba(255,255,255,0.08);min-height:60px}
        .prospects-list:not(.list-view) .priority-card-lg-notes-col{flex:1;border-right:none;border-bottom:1px solid rgba(255,255,255,0.08);min-height:60px}
        .prospects-list:not(.list-view) .priority-card-lg-status-col{flex:none;border-right:none;border-bottom:1px solid rgba(255,255,255,0.08)}
        .prospects-list:not(.list-view) .priority-card-lg-actions{grid-template-columns:repeat(4,1fr);border-left:none;border-top:1px solid rgba(255,255,255,0.08);min-width:auto;flex:none}
        .prospects-empty{text-align:center;padding:40px;color:rgba(255,255,255,0.4);background:#111;border-radius:12px}

        /* Prospects list refinements */
        /* (1) Row breathing room */
        .prospects-list .priority-card-lg-time-col{padding:14px 12px}
        .prospects-list .priority-card-lg-info{padding:14px 24px}
        .prospects-list .priority-card-lg-summary-col{padding:14px 24px}
        .prospects-list .priority-card-lg-notes-col{padding:14px 24px}
        .prospects-list .priority-card-lg-status-col{padding:14px 16px}

        /* (2) Compact action buttons - icon-only circles */
        .prospects-list .priority-card-lg-actions{flex:0 0 200px;display:grid;grid-template-columns:1fr 1fr;gap:6px;padding:10px;border-left:1px solid rgba(255,255,255,0.08)}
        .prospects-list:not(.list-view) .priority-card-lg-actions{grid-template-columns:repeat(4,1fr);border-left:none;border-top:1px solid rgba(255,255,255,0.08);flex:none;min-width:auto}
        .action-btn-circle{width:28px;height:28px;border-radius:50%;border:1px solid #2a2a2a;background:transparent;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:0.8125rem;transition:all 200ms ease;color:#A0A0A0;position:relative;padding:0;flex-shrink:0}
        .action-btn-circle:hover{border-color:rgb(52,211,153);color:#fff}
        .action-btn-circle.action-share.shared{border-color:rgba(52,211,153,0.4);color:rgb(52,211,153)}
        .action-btn-circle.action-share.shared:hover{border-color:rgb(52,211,153);color:rgb(52,211,153)}
        .action-btn-circle .action-icon{font-size:0.75rem;line-height:1;display:flex;align-items:center;justify-content:center}
        .action-btn-circle .action-tooltip{display:none;position:absolute;bottom:calc(100% + 6px);left:50%;transform:translateX(-50%);background:#1a1a2e;color:#fff;font-size:0.6875rem;padding:4px 8px;border-radius:4px;white-space:nowrap;pointer-events:none;z-index:100;border:1px solid rgba(255,255,255,0.1)}
        .action-btn-circle:hover .action-tooltip{display:block}
        .action-overflow-wrap{position:relative;flex-shrink:0}
        .action-overflow-btn{width:28px;height:28px;border-radius:50%;border:1px solid #2a2a2a;background:transparent;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:1rem;color:#A0A0A0;transition:all 200ms ease;padding:0;letter-spacing:-1px;line-height:1}
        .action-overflow-btn:hover{border-color:rgb(52,211,153);color:#fff}
        .action-overflow-menu{display:none;position:absolute;bottom:calc(100% + 4px);right:0;background:#1a1a2e;border:1px solid rgba(255,255,255,0.12);border-radius:8px;padding:4px;min-width:150px;z-index:9999;box-shadow:0 4px 12px rgba(0,0,0,0.3)}
        .action-overflow-menu.open{display:block;animation:overflowFadeIn 150ms ease}
        @keyframes overflowFadeIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}
        .action-overflow-item{display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:8px;cursor:pointer;font-size:0.8125rem;color:#A0A0A0;background:none;border:none;width:100%;text-align:left;font-family:var(--font-body);transition:all 150ms ease}
        .action-overflow-item:hover{background:rgba(255,255,255,0.08);color:#fff}
        .action-overflow-item.overflow-dnc:hover{background:rgba(239,68,68,0.15);color:#ef4444}
        .action-overflow-item.overflow-prio:hover{background:rgba(245,158,11,0.15);color:#f59e0b}

        /* (3) Row hover state */
        .prospects-list .priority-card-lg{transition:all 200ms ease;position:relative}
        .prospects-list .priority-card-lg::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;background:rgb(52,211,153);border-radius:12px 0 0 12px;opacity:0;transition:opacity 200ms ease;z-index:1}
        .prospects-list .priority-card-lg:hover{background:rgba(255,255,255,0.03);border-color:rgba(255,255,255,0.15);box-shadow:none}
        .prospects-list .priority-card-lg:hover::before{opacity:1}
        .prospects-list .priority-card-lg:hover .priority-card-lg-name{color:rgb(52,211,153);transition:color 200ms ease}

        /* (4) Summary truncation - 2 lines max */
        .prospects-list .priority-card-lg-summary-col .col-content{display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis}
        .prospects-list .priority-card-lg-notes-col .col-content{display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis}

        /* Pipeline Styles */
        .pipeline-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:1.5rem;flex-wrap:wrap;gap:1rem}
        .pipeline-header-text h2{font-family:var(--font-heading);font-size:1.5rem;font-weight:800;margin-bottom:0.5rem;color:#FFFFFF}
        .pipeline-header-text p{color:#A0A0A0;font-size:0.8125rem;font-weight:400}
        .pipeline-stats{display:flex;gap:1.5rem}
        .pipeline-stat{text-align:center}
        .pipeline-stat-value{font-family:var(--font-heading);display:block;font-size:2rem;font-weight:700;color:rgb(52,211,153)}
        .pipeline-stat-label{font-size:0.75rem;font-weight:400;color:#A0A0A0;text-transform:uppercase}
        .pipeline-list{display:grid;grid-template-columns:1fr;gap:1rem}
        .pipeline-list.list-view{grid-template-columns:1fr}
        .pipeline-list:not(.list-view){grid-template-columns:repeat(auto-fill,minmax(340px,1fr))}
        .pipeline-list:not(.list-view) .priority-card-lg{flex-direction:column;min-height:280px}
        .pipeline-list:not(.list-view) .priority-card-lg-left{flex:none;border-right:none;border-bottom:1px solid rgba(255,255,255,0.08)}
        .pipeline-list:not(.list-view) .priority-card-lg-time-col{flex:0 0 60px}
        .pipeline-list:not(.list-view) .priority-card-lg-summary-col{flex:1;border-right:none;border-bottom:1px solid rgba(255,255,255,0.08);min-height:60px}
        .pipeline-list:not(.list-view) .priority-card-lg-actions{border-left:none;border-top:1px solid rgba(255,255,255,0.08);min-width:auto;flex:none}
        .pipeline-empty{text-align:center;padding:40px;color:rgba(255,255,255,0.4);background:#111;border-radius:12px}

        /* Shared Leads styles */
        .shared-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:1.5rem;flex-wrap:wrap;gap:1rem}
        .shared-header-text h2{font-family:var(--font-heading);font-size:1.5rem;font-weight:800;margin-bottom:0.5rem;color:#FFFFFF}
        .shared-header-text p{color:#A0A0A0;font-size:0.8125rem;font-weight:400}
        .shared-header-actions{display:flex;align-items:center;gap:1rem}
        .shared-list{display:grid;grid-template-columns:1fr;gap:1rem;padding:0}
        .shared-list.list-view{grid-template-columns:1fr}
        .shared-list:not(.list-view){grid-template-columns:repeat(auto-fill,minmax(340px,1fr))}
        .shared-list:not(.list-view) .priority-card-lg{flex-direction:column;min-height:320px}
        .shared-list:not(.list-view) .priority-card-lg-left{flex:none;border-right:none;border-bottom:1px solid rgba(255,255,255,0.08)}
        .shared-list:not(.list-view) .priority-card-lg-time-col{flex:0 0 60px}
        .shared-list:not(.list-view) .priority-card-lg-summary-col{flex:1;border-right:none;border-bottom:1px solid rgba(255,255,255,0.08);min-height:60px}
        .shared-list:not(.list-view) .priority-card-lg-notes-col{flex:1;border-right:none;border-bottom:1px solid rgba(255,255,255,0.08);min-height:60px}
        .shared-list:not(.list-view) .priority-card-lg-status-col{flex:none;border-right:none;border-bottom:1px solid rgba(255,255,255,0.08)}
        .shared-list:not(.list-view) .priority-card-lg-actions{grid-template-columns:repeat(4,1fr);border-left:none;border-top:1px solid rgba(255,255,255,0.08);min-width:auto;flex:none}
        .shared-empty{text-align:center;padding:40px;color:rgba(255,255,255,0.4);background:#111;border-radius:12px}

        /* Pipeline Card */
        .pipeline-card{background:#111;border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:20px;cursor:pointer;transition:all 150ms ease}
        .pipeline-card:hover{border-color:rgb(52,211,153);transform:translateY(-2px)}
        .pipeline-card-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px}
        .pipeline-card-name{font-family:var(--font-heading);font-size:1rem;font-weight:600;color:#FFFFFF}
        .pipeline-card-phone{font-size:0.6875rem;font-weight:400;color:#707070;font-family:monospace}
        .pipeline-card-status{margin-bottom:12px}
        .pipeline-card-nextcall{display:flex;align-items:center;gap:8px;font-size:0.875rem;color:rgba(255,255,255,0.7)}
        .pipeline-card-nextcall .date{color:rgb(52,211,153);font-weight:600}
        .pipeline-card-summary{font-size:0.8125rem;font-weight:400;line-height:1.5;color:#A0A0A0;margin-top:12px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
        
        /* Table Actions */
        .table-actions{display:flex;gap:6px}
        .table-action-btn{padding:6px 10px;border-radius:8px;border:none;cursor:pointer;font-size:0.75rem;font-weight:500;transition:all 150ms ease}
        .table-action-btn.view{background:rgba(52,211,153,0.15);color:rgb(52,211,153)}
        .table-action-btn.view:hover{background:rgb(52,211,153);color:#000}
        .table-action-btn.prio{background:rgba(245,158,11,0.15);color:#f59e0b}
        .table-action-btn.prio:hover{background:#f59e0b;color:#000}
        .table-action-btn.share{background:rgba(59,130,246,0.15);color:#3B82F6}
        .table-action-btn.share:hover{background:#3B82F6;color:#fff}
        
        /* Sharing indicator */
        .sharing-indicator{display:flex;align-items:center;gap:4px;font-size:0.8125rem}
        .sharing-indicator.shared{color:#3B82F6}
        .sharing-indicator.not-shared{color:rgba(255,255,255,0.3)}
        
        /* Summary cell */
        .summary-cell{max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-size:0.8125rem;color:rgba(255,255,255,0.7)}
        .notes-cell{max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-size:0.8125rem;color:rgba(255,255,255,0.6)}
        
        /* Prio empty state */
        .prio-empty{text-align:center;padding:40px;color:rgba(255,255,255,0.4);background:#111;border-radius:12px;grid-column:1/-1}
        
        /* Page Loading State */
        .page-loading{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:60px 20px;background:#111;border-radius:12px;grid-column:1/-1}
        .page-loading .spinner{width:40px;height:40px;border:3px solid rgba(255,255,255,0.1);border-top-color:rgb(52,211,153);border-radius:50%;animation:spin 0.8s linear infinite}
        .page-loading p{margin-top:16px;color:rgba(255,255,255,0.5);font-size:0.875rem}
        @keyframes spin{to{transform:rotate(360deg)}}
        
        /* Analytics Page - Modern Design */
        .analytics-header-modern{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;flex-wrap:wrap;gap:16px}
        .analytics-title-section h2{font-family:var(--font-heading);font-size:1.75rem;font-weight:700;margin-bottom:2px}
        .analytics-subtitle{color:rgba(255,255,255,0.5);font-size:0.875rem}
        .analytics-date-nav{display:flex;align-items:center;gap:8px}
        .date-nav-btn{background:#111;border:1px solid rgba(255,255,255,0.15);border-radius:8px;width:40px;height:40px;display:flex;align-items:center;justify-content:center;cursor:pointer;color:rgba(255,255,255,0.7);transition:all 150ms ease}
        .date-nav-btn:hover{background:rgba(255,255,255,0.1);color:#fff;border-color:rgba(255,255,255,0.25)}
        .date-display{text-align:center;min-width:180px;padding:8px 16px;background:#111;border-radius:8px;cursor:pointer}
        .date-display .date-day{display:block;font-weight:600;font-size:1rem}
        .date-display .date-full{display:block;font-size:0.75rem;color:rgba(255,255,255,0.5)}
        .date-nav-today{background:rgba(52,211,153,0.15);border:1px solid rgba(52,211,153,0.3);color:rgb(52,211,153);padding:8px 16px;border-radius:8px;font-size:0.875rem;font-weight:500;cursor:pointer;transition:all 150ms ease}
        .date-nav-today:hover{background:rgba(52,211,153,0.25)}
        .analytics-period-row{margin-bottom:24px;position:relative;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px}
        .analytics-period-tabs{display:inline-flex;gap:4px;background:#111;padding:4px;border-radius:12px}
        .analytics-period-tab{background:none;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-size:0.875rem;font-weight:500;color:rgba(255,255,255,0.6);transition:all 150ms ease}
        .analytics-view-toggle{display:flex;gap:2px;background:#111;padding:3px;border-radius:8px}
        .view-toggle-btn{background:none;border:none;width:32px;height:32px;border-radius:8px;cursor:pointer;font-size:0.875rem;font-weight:600;color:rgba(255,255,255,0.5);transition:all 150ms ease}
        .view-toggle-btn:hover{color:#fff}
        .view-toggle-btn.active{background:rgba(52,211,153,0.2);color:#22c55e}
        .analytics-period-tab:hover{color:#fff}

        /* Custom Date Picker */
        .custom-date-picker{display:none;position:absolute;top:100%;right:0;z-index:100;margin-top:8px;background:#1a1a1a;border:1px solid rgba(255,255,255,0.1);border-radius:16px;box-shadow:0 4px 12px rgba(0,0,0,0.3);overflow:hidden}
        .custom-date-picker.show{display:block}
        .picker-calendar{padding:16px;width:280px}
        .picker-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
        .picker-month{font-weight:600;font-size:0.9375rem;color:#fff}
        .picker-nav{background:none;border:none;color:rgba(255,255,255,0.6);cursor:pointer;padding:6px 10px;border-radius:8px;font-size:1rem;transition:all 150ms ease}
        .picker-nav:hover{background:rgba(255,255,255,0.1);color:#fff}
        .picker-weekdays{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;margin-bottom:8px;text-align:center}
        .picker-weekdays span{font-size:0.75rem;color:rgba(255,255,255,0.4);font-weight:500;padding:4px}
        .picker-days{display:grid;grid-template-columns:repeat(7,1fr);gap:4px}
        .picker-day{background:none;border:none;padding:8px;border-radius:8px;cursor:pointer;font-size:0.8125rem;color:rgba(255,255,255,0.7);transition:all 150ms ease;text-align:center}
        .picker-day:hover:not(:disabled){background:rgba(52,211,153,0.2);color:#fff}
        .picker-day.today{border:1px solid #22c55e;color:#22c55e}
        .picker-day.selected{background:#22c55e;color:#000;font-weight:600}
        .picker-day:disabled{color:rgba(255,255,255,0.2);cursor:not-allowed}
        .picker-day.other-month{color:rgba(255,255,255,0.3)}
        .picker-dropdown{padding:8px;max-height:300px;overflow-y:auto;width:260px}
        .picker-dropdown-list{display:flex;flex-direction:column;gap:4px}
        .picker-dropdown-item{background:none;border:none;padding:10px 14px;border-radius:8px;cursor:pointer;font-size:0.875rem;color:rgba(255,255,255,0.7);text-align:left;transition:all 150ms ease}
        .picker-dropdown-item:hover{background:rgba(52,211,153,0.15);color:#fff}
        .picker-dropdown-item.selected{background:rgba(34,197,94,0.2);color:#22c55e;font-weight:500}
        .picker-dropdown-item.current{border-left:2px solid #22c55e}
        .analytics-period-tab.active{background:rgb(52,211,153);color:#000}
        .date-picker-hidden{position:absolute;opacity:0;pointer-events:none}

        /* Hero Stats */
        .analytics-hero-stats{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:32px}
        @media(max-width:1024px){.analytics-hero-stats{grid-template-columns:repeat(2,1fr)}}
        @media(max-width:640px){.analytics-hero-stats{grid-template-columns:1fr}}
        .hero-stat-card{background:#111;border:1px solid rgba(255,255,255,0.1);border-radius:16px;padding:24px;display:flex;align-items:center;gap:16px;transition:all 150ms ease}
        .hero-stat-card:hover{border-color:rgba(255,255,255,0.2);transform:translateY(-2px)}
        .hero-stat-card.primary{background:linear-gradient(135deg,rgba(52,211,153,0.15) 0%,rgba(52,211,153,0.05) 100%);border-color:rgba(52,211,153,0.3)}
        .hero-stat-card.success{background:linear-gradient(135deg,rgba(34,197,94,0.15) 0%,rgba(34,197,94,0.05) 100%);border-color:rgba(34,197,94,0.3)}
        .hero-stat-card.accent{background:linear-gradient(135deg,rgba(59,130,246,0.15) 0%,rgba(59,130,246,0.05) 100%);border-color:rgba(59,130,246,0.3)}
        .hero-stat-icon{font-size:2rem;width:56px;height:56px;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.05);border-radius:12px}
        .hero-stat-value{font-family:var(--font-heading);font-size:2rem;font-weight:700;line-height:1}
        .hero-stat-card.primary .hero-stat-value{color:rgb(52,211,153)}
        .hero-stat-card.success .hero-stat-value{color:#22c55e}
        .hero-stat-card.accent .hero-stat-value{color:#3B82F6}
        .hero-stat-label{font-size:0.75rem;font-weight:400;color:#A0A0A0;margin-top:4px}

        /* Analytics Cards */
        .analytics-card-section{background:#111;border:1px solid rgba(255,255,255,0.1);border-radius:16px;padding:24px;margin-bottom:24px}
        .analytics-card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
        .analytics-card-header h3{font-family:var(--font-heading);font-size:1rem;font-weight:700}
        .card-period{font-size:0.75rem;color:rgba(255,255,255,0.5);background:rgba(255,255,255,0.05);padding:4px 12px;border-radius:12px}

        /* Conversion Funnel */
        .conversion-funnel{display:flex;flex-direction:column;gap:12px}
        .funnel-stage{display:flex;align-items:center;gap:16px}
        .funnel-bar{background:rgba(255,255,255,0.1);height:40px;border-radius:8px;display:flex;align-items:center;justify-content:center;min-width:60px;transition:width 0.5s ease}
        .funnel-bar.conversations{background:linear-gradient(90deg,rgba(52,211,153,0.3),rgba(52,211,153,0.1))}
        .funnel-bar.qualified{background:linear-gradient(90deg,rgba(59,130,246,0.3),rgba(59,130,246,0.1))}
        .funnel-bar.booked{background:linear-gradient(90deg,rgba(34,197,94,0.4),rgba(34,197,94,0.1))}
        .funnel-value{font-weight:700;font-size:1rem}
        .funnel-label{font-size:0.8125rem;color:rgba(255,255,255,0.6);min-width:100px;display:flex;align-items:center;gap:8px}
        .funnel-pct{color:#22c55e;font-weight:600;font-size:0.75rem;opacity:0.9}

        /* Two Column Layout */
        .analytics-two-col{display:grid;grid-template-columns:1fr 1fr;gap:24px;margin-bottom:24px}
        @media(max-width:768px){.analytics-two-col{grid-template-columns:1fr}}

        /* Outcome Stats */
        .outcome-stats-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:16px}
        .outcome-stat{padding:16px;border-radius:12px;background:rgba(255,255,255,0.03)}
        .outcome-stat.booked{border-left:3px solid #22c55e}
        .outcome-stat.callback{border-left:3px solid #3B82F6}
        .outcome-stat.timeline{border-left:3px solid #f59e0b}
        .outcome-stat.followup{border-left:3px solid #8b5cf6}
        .outcome-stat-value{font-family:var(--font-heading);font-size:2rem;font-weight:700}
        .outcome-stat.booked .outcome-stat-value{color:#22c55e}
        .outcome-stat.callback .outcome-stat-value{color:#3B82F6}
        .outcome-stat.timeline .outcome-stat-value{color:#f59e0b}
        .outcome-stat.followup .outcome-stat-value{color:#8b5cf6}
        .outcome-stat-label{font-size:0.75rem;font-weight:400;color:#A0A0A0;margin-bottom:8px}
        .outcome-stat-bar{height:4px;background:rgba(255,255,255,0.1);border-radius:2px;overflow:hidden}
        .bar-fill{height:100%;border-radius:2px;transition:width 0.5s ease}
        .bar-fill.booked{background:#22c55e}
        .bar-fill.callback{background:#3B82F6}
        .bar-fill.timeline{background:#f59e0b}
        .bar-fill.followup{background:#8b5cf6}

        /* Other Outcomes */
        .other-outcomes-list{display:flex;flex-direction:column;gap:8px}
        .other-outcome-row{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:rgba(255,255,255,0.03);border-radius:8px}
        .outcome-name{font-size:0.875rem;color:rgba(255,255,255,0.7)}
        .outcome-value{font-weight:600;font-size:0.9375rem}

        /* Booked Table */
        .booked-count{font-size:0.8125rem;color:rgb(52,211,153);background:rgba(52,211,153,0.1);padding:4px 12px;border-radius:12px}
        .booked-table-container{overflow-x:auto;border-radius:12px;border:1px solid rgba(34,197,94,0.2)}
        .analytics-booked-table{width:100%;border-collapse:collapse}
        .analytics-booked-table th{background:rgba(34,197,94,0.15);color:#22c55e;padding:14px 16px;text-align:left;font-size:0.75rem;text-transform:uppercase;letter-spacing:0.05em;font-weight:600}
        .analytics-booked-table td{padding:14px 16px;border-top:1px solid rgba(255,255,255,0.05);font-size:0.875rem}
        .analytics-booked-table tr:hover td{background:rgba(255,255,255,0.02)}
        .analytics-booked-table .empty-row td{text-align:center;color:rgba(255,255,255,0.4);padding:32px}
        .analytics-loading-overlay{position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:10;border-radius:16px}
        .analytics-loading-spinner{width:40px;height:40px;border:3px solid rgba(255,255,255,0.1);border-top-color:rgb(52,211,153);border-radius:50%;animation:spin 0.8s linear infinite}
        .analytics-loading-overlay p{margin-top:16px;color:rgba(255,255,255,0.6);font-size:0.875rem}

        /* Import Page */
        .import-header{margin-bottom:24px}
        .import-header h2{font-family:var(--font-heading);font-size:1.5rem;font-weight:700;margin-bottom:4px}
        .import-tabs{display:flex;gap:8px;margin-bottom:24px}
        .import-tab{background:#111;border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:12px 24px;font-size:0.9375rem;color:rgba(255,255,255,0.7);cursor:pointer;transition:all 150ms ease}
        .import-tab:hover{border-color:rgb(52,211,153)}
        .import-tab.active{background:rgb(52,211,153);border-color:rgb(52,211,153);color:#000}
        .import-panel{display:none}
        .import-panel.active{display:block}
        .import-single-grid{display:grid;grid-template-columns:1fr 280px;gap:24px}
        .import-single-form{background:#111;border:1px solid rgba(255,255,255,0.08);border-radius:12px;padding:28px}
        .import-single-tips{display:flex;flex-direction:column;gap:16px}
        .import-section{margin-bottom:24px}
        .import-section-label{font-size:0.75rem;font-weight:600;color:rgb(52,211,153);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:14px;padding-bottom:8px;border-bottom:1px solid rgba(52,211,153,0.15)}
        @media(max-width:768px){.import-single-grid{grid-template-columns:1fr}}
        .form-row{display:grid;grid-template-columns:repeat(2,1fr);gap:16px}
        @media(max-width:600px){.form-row{grid-template-columns:1fr}}
        .form-group{margin-bottom:16px}
        .form-group label{display:block;font-size:0.875rem;margin-bottom:6px;color:rgba(255,255,255,0.8)}
        .form-group .required{color:#ef4444}
        .form-input{width:100%;background:#0a0a0a;border:1px solid #2a2a2a;border-radius:8px;padding:12px 16px;color:#fff;font-size:0.9375rem;transition:border-color 150ms ease}
        .form-input:focus{outline:2px solid var(--accent);outline-offset:2px;border-color:var(--accent)}
        .form-hint{font-size:0.75rem;color:rgba(255,255,255,0.4);margin-top:4px}
        .btn-block{width:100%;justify-content:center}
        .template-download{background:#111;border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:20px;display:flex;justify-content:space-between;align-items:center;gap:16px;margin-bottom:24px;flex-wrap:wrap}
        .template-info h4{font-family:var(--font-heading);font-weight:700;margin-bottom:4px}
        .template-info p{font-size:0.875rem;color:rgba(255,255,255,0.5)}
        .file-upload-zone{border:2px dashed rgba(255,255,255,0.2);border-radius:12px;padding:48px;text-align:center;cursor:pointer;transition:all 150ms ease}
        .file-upload-zone:hover{border-color:rgb(52,211,153);background:rgba(52,211,153,0.05)}
        .file-upload-zone.dragover{border-color:rgb(52,211,153);background:rgba(52,211,153,0.1)}
        .file-upload-zone input{display:none}
        .file-upload-icon{font-size:3rem;margin-bottom:16px}
        .file-upload-supported{font-size:0.875rem;color:rgba(255,255,255,0.4);margin-top:8px}
        
        /* Search Page */
        .search-header{margin-bottom:24px}
        .search-header h2{font-family:var(--font-heading);font-size:1.5rem;font-weight:700;margin-bottom:4px}
        .search-box-large{display:flex;gap:12px;max-width:500px;margin-bottom:32px}
        .search-input-large{flex:1;background:#111;border:1px solid #2a2a2a;border-radius:8px;padding:14px 18px;color:#fff;font-size:1rem;transition:border-color 150ms ease}
        .search-input-large:focus{outline:2px solid var(--accent);outline-offset:2px;border-color:var(--accent)}
        .search-results-list{display:flex;flex-direction:column;gap:8px;margin-bottom:24px}
        .search-result-item{display:flex;justify-content:space-between;align-items:center;padding:16px;background:#111;border:1px solid rgba(255,255,255,0.1);border-radius:8px;cursor:pointer;transition:all 150ms ease}
        .search-result-item:hover{border-color:rgb(52,211,153);background:rgba(52,211,153,0.05)}
        .search-lead-card{background:#111;border:1px solid rgba(255,255,255,0.1);border-radius:12px;overflow:hidden}
        .search-lead-top{display:flex;align-items:center;justify-content:space-between;padding:20px 24px;flex-wrap:wrap;gap:12px;border-bottom:1px solid rgba(255,255,255,0.06)}
        .search-lead-identity{display:flex;align-items:center;gap:14px;min-width:0}
        .search-lead-avatar{width:40px;height:40px;border-radius:10px;background:rgba(52,211,153,0.12);color:rgb(52,211,153);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:1rem;flex-shrink:0}
        .search-lead-name-group{min-width:0}
        .search-lead-name-row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
        .search-lead-name-row h3{margin:0;font-size:1.0625rem;font-weight:700;font-family:var(--font-heading);white-space:nowrap}
        .search-lead-phone{font-size:0.8125rem;color:rgba(255,255,255,0.5);font-family:monospace;margin-top:2px}
        .search-lead-phone a{color:rgba(255,255,255,0.5);text-decoration:none}
        .search-lead-phone a:hover{color:rgb(52,211,153)}
        .search-lead-info-strip{display:grid;grid-template-columns:repeat(5,1fr);gap:0;border-bottom:1px solid rgba(255,255,255,0.06)}
        .search-info-cell{padding:14px 18px;border-right:1px solid rgba(255,255,255,0.06);text-align:center}
        .search-info-cell:last-child{border-right:none}
        .search-info-cell .info-label{display:block;font-size:0.6875rem;color:rgba(255,255,255,0.35);text-transform:uppercase;letter-spacing:0.3px;margin-bottom:3px}
        .search-info-cell .info-value{font-size:0.8125rem;font-weight:600;color:#fff}
        @media(max-width:768px){.search-lead-info-strip{grid-template-columns:repeat(2,1fr)}.search-info-cell{border-bottom:1px solid rgba(255,255,255,0.06)}}
        .search-lead-badges{display:flex;gap:6px;align-items:center;flex-shrink:0;flex-wrap:wrap}
        .search-action-btn{padding:8px 16px;font-size:0.8125rem;font-weight:600;border-radius:8px;cursor:pointer;transition:all 150ms ease;display:inline-flex;align-items:center;justify-content:center;gap:6px}
        .search-action-btn.share{background:rgba(255,255,255,0.05);color:#fff;border:1px solid rgba(255,255,255,0.12)}
        .search-action-btn.share:hover{background:rgba(255,255,255,0.08);border-color:rgba(255,255,255,0.2)}
        .search-action-btn.share.shared{background:rgba(52,211,153,0.1);color:rgb(52,211,153);border-color:rgba(52,211,153,0.3)}
        .search-action-btn.takeover{background:rgba(255,255,255,0.05);color:#fff;border:1px solid rgba(255,255,255,0.12)}
        .search-action-btn.takeover:hover{background:rgba(255,255,255,0.08);border-color:rgba(255,255,255,0.2)}
        .search-action-btn.dnc{background:transparent;color:rgba(239,68,68,0.6);border:none;padding:8px 12px;margin-left:auto}
        .search-action-btn.dnc:hover{color:#ef4444}
        .search-lead-body{padding:20px 24px}
        .search-section{margin-bottom:4px;border:1px solid rgba(255,255,255,0.06);border-radius:10px;overflow:hidden;background:rgba(255,255,255,0.015)}
        .search-section:last-child{margin-bottom:0}
        .search-section-toggle{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;cursor:pointer;transition:background 100ms ease;width:100%;background:none;border:none;color:#fff;text-align:left}
        .search-section-toggle:hover{background:rgba(255,255,255,0.03)}
        .search-section-toggle h4{font-family:var(--font-heading);font-size:0.8125rem;font-weight:700;text-transform:uppercase;letter-spacing:0.04em;color:rgba(255,255,255,0.7);margin:0;display:flex;align-items:center;gap:8px}
        .search-section-toggle .section-count{font-size:0.6875rem;font-weight:500;color:rgba(255,255,255,0.3);background:rgba(255,255,255,0.06);padding:2px 8px;border-radius:10px}
        .search-section-arrow{font-size:0.625rem;color:rgba(255,255,255,0.3);transition:transform 200ms ease}
        .search-section.collapsed .search-section-arrow{transform:rotate(-90deg)}
        .search-section-content{max-height:600px;overflow-y:auto;transition:max-height 250ms ease-out,padding 250ms ease-out;padding:0 18px 14px}
        .search-section.collapsed .search-section-content{max-height:0;overflow:hidden;padding:0 18px}
        .search-lead-notes-list,.search-lead-attempts-list,.search-lead-ai-calls-list{font-size:0.875rem}
        .search-note-item,.search-attempt-item,.search-ai-call-item{padding:10px 12px;background:rgba(255,255,255,0.03);border-radius:8px;margin-bottom:6px;border-left:3px solid rgba(52,211,153,0.4)}
        .search-note-item:last-child,.search-attempt-item:last-child,.search-ai-call-item:last-child{margin-bottom:0}
        .search-note-date,.search-attempt-time,.search-ai-call-time{font-size:0.6875rem;color:rgba(255,255,255,0.35);margin-bottom:3px}
        .search-note-text,.search-attempt-result{font-size:0.8125rem;line-height:1.5}
        .search-ai-call-item{border-left-color:rgba(99,102,241,0.4);position:relative}
        .search-ai-call-header{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:2px}
        .search-ai-call-title{font-weight:600;font-size:0.8125rem}
        .search-ai-call-outcome{font-size:0.6875rem;padding:2px 8px;border-radius:4px;background:rgba(255,255,255,0.1)}
        .search-ai-call-outcome.booked{background:rgba(52,211,153,0.2);color:rgb(52,211,153)}
        .search-ai-call-outcome.callback{background:rgba(245,158,11,0.2);color:#f59e0b}
        .search-ai-call-outcome.timeline,.search-ai-call-outcome.follow-up{background:rgba(99,102,241,0.2);color:#6366f1}
        .search-ai-call-outcome.not-interested,.search-ai-call-outcome.voicemail,.search-ai-call-outcome.no-answer{background:rgba(255,255,255,0.1);color:rgba(255,255,255,0.6)}
        .search-ai-call-meta{display:flex;align-items:center;gap:12px;margin-top:4px;font-size:0.75rem;color:rgba(255,255,255,0.35)}
        .search-ai-call-preview{font-size:0.8125rem;color:rgba(255,255,255,0.45);margin-top:6px;line-height:1.4;font-style:italic}
        .search-ai-call-footer{display:flex;justify-content:flex-end;margin-top:6px}
        .search-ai-view-btn{font-size:0.75rem;color:rgb(52,211,153);background:none;border:none;cursor:pointer;padding:2px 0;transition:opacity 150ms ease}
        .search-ai-view-btn:hover{opacity:0.8;text-decoration:underline}
        .search-lead-content{background:rgba(255,255,255,0.02);padding:14px;border-radius:8px;font-size:0.875rem;line-height:1.6;white-space:pre-wrap;color:rgba(255,255,255,0.7)}
        .search-lead-content.transcript{max-height:300px;overflow-y:auto}
        .call-detail-modal{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:10001;align-items:center;justify-content:center}
        .call-detail-modal.active{display:flex}
        .call-detail-content{background:#111;border:1px solid rgba(255,255,255,0.1);border-radius:12px;max-width:700px;width:90%;max-height:85vh;overflow:hidden;display:flex;flex-direction:column}
        .call-detail-header{padding:20px 24px;border-bottom:1px solid rgba(255,255,255,0.1);display:flex;justify-content:space-between;align-items:center}
        .call-detail-header h3{font-family:var(--font-heading);font-size:1.125rem;font-weight:700}
        .call-detail-close{background:none;border:none;color:rgba(255,255,255,0.5);font-size:1.5rem;cursor:pointer;padding:0;line-height:1}
        .call-detail-close:hover{color:#fff}
        .call-detail-body{padding:24px;overflow-y:auto;flex:1}
        .call-detail-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:24px}
        .call-detail-stat{background:#0a0a0a;padding:16px;border-radius:8px;text-align:center}
        .call-detail-stat-value{font-family:var(--font-heading);font-size:1.25rem;font-weight:700;color:rgb(52,211,153)}
        .call-detail-stat-label{font-size:0.75rem;color:rgba(255,255,255,0.5);margin-top:4px}
        .call-detail-section{margin-bottom:20px}
        .call-detail-section h4{font-family:var(--font-heading);font-size:0.875rem;font-weight:700;color:rgba(255,255,255,0.5);margin-bottom:8px}
        .call-detail-transcript{background:#0a0a0a;padding:16px;border-radius:8px;font-size:0.875rem;line-height:1.6;max-height:300px;overflow-y:auto;white-space:pre-wrap}

        /* Collapsible Sidebar */
        .sidebar-collapse-btn{display:none;width:28px;height:28px;border-radius:8px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);color:rgba(255,255,255,0.6);cursor:pointer;align-items:center;justify-content:center;transition:all 150ms ease;font-size:1rem;flex-shrink:0}
        .sidebar-collapse-btn:hover{background:rgba(255,255,255,0.1);color:#fff;border-color:rgba(255,255,255,0.2)}
        @media(min-width:1024px){.sidebar-collapse-btn{display:flex}}
        .sidebar.collapsed{width:64px;min-width:64px}
        .sidebar.collapsed .sidebar-logo{display:none !important}
        .sidebar.collapsed .sidebar-logo-mini{display:block !important;width:32px;height:32px;border-radius:8px;margin:0 auto}
        .sidebar.collapsed .nav-item span:not(.nav-item-icon){display:none}
        .sidebar.collapsed .nav-section-title{display:none}
        .sidebar.collapsed .nav-item{justify-content:center;padding:10px 8px}
        .sidebar.collapsed .nav-item-icon{width:32px;height:32px;font-size:20px;display:flex;align-items:center;justify-content:center}
        .sidebar.collapsed .user-info{display:none}
        .sidebar.collapsed .user-avatar{width:32px;height:32px;min-width:32px;min-height:32px;font-size:14px;flex-shrink:0}
        .sidebar.collapsed .user-card{justify-content:center;padding:8px}
        .sidebar.collapsed .notification-btn{display:none}
        .sidebar.collapsed .profile-menu{left:64px;bottom:50px;width:180px}
        .sidebar.collapsed .notifications-popup{left:64px}
        .sidebar.collapsed .sidebar-header{justify-content:center;padding:12px 10px;position:relative}
        .sidebar.collapsed .sidebar-collapse-btn{position:absolute;right:-12px;top:50%;transform:translateY(-50%);z-index:10;width:24px;height:24px;border-radius:50%;background:#1a1a1a;border:1px solid rgba(255,255,255,0.15);font-size:0.75rem}
        .sidebar.collapsed .sidebar-footer-row{justify-content:center}
        .app-container.sidebar-collapsed .main-content{margin-left:64px}
        @media(max-width:1023px){.app-container.sidebar-collapsed .main-content{margin-left:0}}

        /* Collapsible Nav Sections */
        .nav-section-collapsible .nav-section-toggle{cursor:pointer;display:flex;align-items:center;justify-content:space-between;padding-right:8px}
        .nav-section-collapsible .nav-section-toggle:hover{color:rgba(255,255,255,0.9)}
        .nav-section-arrow{font-size:0.625rem;transition:transform 0.2s ease;color:rgba(255,255,255,0.4)}
        .nav-section-collapsible.collapsed .nav-section-arrow{transform:rotate(-90deg)}
        .nav-section-items{overflow:hidden;transition:max-height 0.25s ease-out;max-height:500px}
        .nav-section-collapsible.collapsed .nav-section-items{max-height:0}
        .sidebar.collapsed .nav-section-collapsible .nav-section-toggle{display:none}
        .sidebar.collapsed .nav-section-collapsible.collapsed .nav-section-items{max-height:500px}

        /* Sidebar Resize Handle */
        .sidebar-resize-handle{position:absolute;top:0;right:-4px;width:8px;height:100%;cursor:ew-resize;z-index:100;background:transparent}
        .sidebar-resize-handle:hover,.sidebar-resize-handle.active{background:rgba(52,211,153,0.3)}
        .sidebar.collapsed .sidebar-resize-handle{display:none}

        /* Image Crop Modal */
        .crop-modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:10000;align-items:center;justify-content:center}
        .crop-modal.show{display:flex}
        .crop-modal-content{background:#1a1a1a;border-radius:16px;padding:24px;max-width:500px;width:90%;max-height:90vh;display:flex;flex-direction:column}
        .crop-modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
        .crop-modal-header h3{font-family:var(--font-heading);margin:0;font-size:1.125rem;font-weight:700;color:#fff}
        .crop-modal-close{background:none;border:none;color:rgba(255,255,255,0.5);font-size:1.5rem;cursor:pointer;padding:4px}
        .crop-modal-close:hover{color:#fff}
        .crop-container{width:100%;height:300px;background:#000;border-radius:8px;overflow:hidden;position:relative}
        .crop-container img{max-width:100%;display:block}
        .crop-controls{display:flex;gap:12px;margin-top:16px;align-items:center;justify-content:center}
        .crop-zoom-label{font-size:0.75rem;color:rgba(255,255,255,0.5)}
        .crop-zoom-slider{width:150px;accent-color:#22c55e}
        .crop-actions{display:flex;gap:12px;margin-top:20px;justify-content:flex-end}
        .crop-btn{padding:10px 20px;border-radius:8px;font-size:0.875rem;font-weight:500;cursor:pointer;transition:all 150ms ease}
        .crop-btn-cancel{background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);color:#fff}
        .crop-btn-cancel:hover{background:rgba(255,255,255,0.15)}
        .crop-btn-confirm{background:#22c55e;border:none;color:#000;font-weight:600}
        .crop-btn-confirm:hover{background:#16a34a}
        .crop-btn-confirm:disabled{opacity:0.5;cursor:not-allowed}

        /* Unqualified Leads Page */
        .unqualified-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:1.5rem;flex-wrap:wrap;gap:1rem}
        .unqualified-header-text h2{font-family:var(--font-heading);font-weight:700;margin-bottom:0.25rem}
        .unqualified-header-text p{color:rgba(255,255,255,0.5);font-size:0.875rem}
        .unqualified-header-actions{display:flex;align-items:center;gap:1rem}
        .unqualified-tabs{display:flex;gap:8px;margin-bottom:1.5rem;flex-wrap:wrap}
        .unqualified-tab{padding:10px 18px;font-size:0.875rem;font-weight:500;color:rgba(255,255,255,0.7);background:#111;border:1px solid rgba(255,255,255,0.1);border-radius:8px;cursor:pointer;transition:all 150ms ease}
        .unqualified-tab:hover{border-color:rgba(255,255,255,0.2);color:#fff}
        .unqualified-tab.active{background:rgb(52,211,153);border-color:rgb(52,211,153);color:#000;font-weight:600}
        .unqualified-list{display:grid;grid-template-columns:1fr;gap:0.75rem;padding:0}
        .unqualified-list.list-view{grid-template-columns:1fr}
        .unqualified-list .unqualified-summary-wide{flex:1 1 0;min-width:0;border-right:none}
        .unqualified-list .priority-card-lg{min-height:auto}
        .unqualified-list .priority-card-lg-actions{display:flex;flex-direction:row;gap:0;padding:0;min-width:auto;border-left:none;flex-shrink:0;align-items:stretch}
        .unqualified-list .action-btn{flex:0 0 auto;width:110px;align-self:stretch;border-radius:0;border:none;border-left:1px solid rgba(255,255,255,0.08);flex-direction:column;gap:4px;padding:14px 8px;font-size:0.75rem}
        .unqualified-list .action-btn .action-icon{font-size:1.25rem}
        .unqualified-list .action-btn .action-label{font-size:0.6875rem;white-space:nowrap}
        .unqualified-list .action-btn:last-child{border-radius:0 12px 12px 0}
        .unqualified-list:not(.list-view){grid-template-columns:repeat(auto-fill,minmax(340px,1fr))}
        .unqualified-list:not(.list-view) .priority-card-lg{flex-direction:column;min-height:200px}
        .unqualified-list:not(.list-view) .priority-card-lg-left{flex:none;border-right:none;border-bottom:1px solid rgba(255,255,255,0.08)}
        .unqualified-list:not(.list-view) .priority-card-lg-time-col{flex:0 0 60px}
        .unqualified-list:not(.list-view) .priority-card-lg-summary-col{flex:1;border-right:none;border-bottom:1px solid rgba(255,255,255,0.08);min-height:40px}
        .unqualified-list:not(.list-view) .priority-card-lg-actions{flex-direction:row;border-left:none;border-top:1px solid rgba(255,255,255,0.08)}
        .unqualified-list:not(.list-view) .action-btn{flex:1;width:auto;height:auto;border-left:none;border-right:1px solid rgba(255,255,255,0.08);border-radius:0;padding:12px 6px}
        .unqualified-list:not(.list-view) .action-btn:last-child{border-right:none;border-radius:0 0 12px 0}
        .unqualified-list:not(.list-view) .action-btn:first-child{border-radius:0 0 0 12px}

        /* Analytics Data Source Toggle */
        .analytics-data-source-row{display:flex;justify-content:center;margin-bottom:1rem}
        .analytics-data-toggle{display:flex;gap:0;background:#111;border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:4px;overflow:hidden}
        .data-toggle-btn{padding:10px 24px;font-size:0.875rem;font-weight:600;color:rgba(255,255,255,0.6);background:transparent;border:none;border-radius:8px;cursor:pointer;transition:all 150ms ease;text-transform:uppercase;letter-spacing:0.5px}
        .data-toggle-btn:hover{color:#fff}
        .data-toggle-btn.active{background:rgb(52,211,153);color:#000}

        /* Search Result Item with Next Call */
        .search-result-next-call{font-size:0.75rem;color:rgb(52,211,153);margin-top:2px}

        /* Page Transitions */
        @keyframes pageFadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
        @keyframes cardStaggerIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
        .page:not(.hidden){animation:pageFadeIn 300ms ease both}
        .page:not(.hidden) .overview-card,.page:not(.hidden) .priority-card-lg,.page:not(.hidden) .today-numbers-bar,.page:not(.hidden) .prio-card{animation:cardStaggerIn 300ms ease both}
        .page:not(.hidden) .overview-card:nth-child(1),.page:not(.hidden) .priority-card-lg:nth-child(1),.page:not(.hidden) .today-number-item:nth-child(1){animation-delay:0ms}
        .page:not(.hidden) .overview-card:nth-child(2),.page:not(.hidden) .priority-card-lg:nth-child(2),.page:not(.hidden) .today-number-item:nth-child(3){animation-delay:50ms}
        .page:not(.hidden) .overview-card:nth-child(3),.page:not(.hidden) .priority-card-lg:nth-child(3),.page:not(.hidden) .today-number-item:nth-child(5){animation-delay:100ms}
        .page:not(.hidden) .overview-card:nth-child(4),.page:not(.hidden) .priority-card-lg:nth-child(4),.page:not(.hidden) .today-number-item:nth-child(7){animation-delay:150ms}
        .page:not(.hidden) .priority-card-lg:nth-child(5){animation-delay:200ms}
        .page:not(.hidden) .priority-card-lg:nth-child(6){animation-delay:250ms}
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
</head>
<body>
    <!-- Error Fallback Page (self-contained, no external dependencies) -->
    <div id="errorFallback" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;z-index:99999;background:#0a0a0a;color:#fff;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;overflow-y:auto;">
        <div style="min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px;">
            <div style="max-width:480px;width:100%;text-align:center;">
                <!-- Inline PRIO AI Logo SVG -->
                <div style="margin-bottom:40px;">
                    <svg width="160" height="44" viewBox="0 0 160 44" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="2" y="2" width="40" height="40" rx="10" fill="#34D399" fill-opacity="0.15" stroke="#34D399" stroke-width="2"/>
                        <path d="M15 14h10a4 4 0 0 1 0 8h-10v-8z" fill="#34D399"/>
                        <path d="M15 22h4v8h-4v-8z" fill="#34D399"/>
                        <text x="52" y="30" font-family="-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif" font-size="24" font-weight="800" fill="white">PRIO</text>
                        <text x="112" y="30" font-family="-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif" font-size="24" font-weight="800" fill="#34D399">AI</text>
                    </svg>
                </div>
                <!-- Status Icon -->
                <div style="width:64px;height:64px;margin:0 auto 24px;background:rgba(52,211,153,0.1);border-radius:50%;display:flex;align-items:center;justify-content:center;">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#34D399" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="12" y1="8" x2="12" y2="12"/>
                        <line x1="12" y1="16" x2="12.01" y2="16"/>
                    </svg>
                </div>
                <!-- Message -->
                <h1 style="font-size:1.5rem;font-weight:700;margin:0 0 12px;line-height:1.3;color:#fff;">We're experiencing a temporary issue</h1>
                <p style="font-size:1rem;line-height:1.6;color:#a0a0a0;margin:0 0 32px;">Our AI calling system is still running and processing your leads. Dashboard access will be restored shortly.</p>
                <!-- Try Again Button -->
                <button onclick="window.location.reload()" style="display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:14px 32px;background:#34D399;color:#000;font-size:1rem;font-weight:600;border:none;border-radius:12px;cursor:pointer;transition:opacity 0.2s;width:100%;max-width:240px;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
                    Try Again
                </button>
                <!-- Support Info -->
                <div style="margin-top:40px;padding-top:24px;border-top:1px solid rgba(255,255,255,0.08);">
                    <p style="font-size:0.875rem;color:#707070;margin:0;">Contact support: <a href="mailto:info@prioai.ca" style="color:#34D399;text-decoration:none;">info@prioai.ca</a></p>
                </div>
            </div>
        </div>
    </div>

    <script>
    // === Error Fallback System ===
    // Self-contained error handling that works even if all JS bundles/APIs fail.
    (function() {
        var fallbackShown = false;
        window.__appMounted = false;

        function showErrorFallback() {
            if (fallbackShown) return;
            fallbackShown = true;
            var el = document.getElementById('errorFallback');
            if (el) {
                el.style.display = 'block';
                // Hide everything else
                var overlay = document.getElementById('pageLoadingOverlay');
                if (overlay) overlay.style.display = 'none';
                var app = document.getElementById('appContainer');
                if (app) app.style.display = 'none';
            }
        }
        window.__showErrorFallback = showErrorFallback;

        // Loading timeout: if the app hasn't mounted within 10 seconds, show fallback
        window.__appLoadTimer = setTimeout(function() {
            if (!window.__appMounted) {
                console.error('App failed to mount within 10 seconds');
                showErrorFallback();
            }
        }, 10000);

        // Global error handler for uncaught JS errors
        window.onerror = function(message, source, lineno, colno, error) {
            console.error('Uncaught error:', message, source, lineno, colno, error);
            // Only show fallback for critical errors (not minor issues)
            // Check if the app has already mounted  if it has, let normal error handling deal with it
            if (!window.__appMounted) {
                showErrorFallback();
            }
            return false;
        };

        // Global handler for unhandled promise rejections
        window.addEventListener('unhandledrejection', function(event) {
            console.error('Unhandled promise rejection:', event.reason);
            if (!window.__appMounted) {
                showErrorFallback();
            }
        });
    })();
    </script>

    <!-- Full Page Loading Overlay -->
    <div id="pageLoadingOverlay" style="position:fixed;top:0;left:0;right:0;bottom:0;background:#000;z-index:9999;display:none;align-items:center;justify-content:center;flex-direction:column;gap:20px;transition:opacity 0.5s ease;">
        <div class="page-loading-spinner"></div>
        <div style="color:rgba(255,255,255,0.7);font-size:14px;">Loading...</div>
    </div>
    <style>
        #pageLoadingOverlay.fade-out{opacity:0;pointer-events:none}
        .page-loading-spinner{width:48px;height:48px;border:3px solid rgba(255,255,255,0.1);border-top-color:rgb(52,211,153);border-radius:50%;animation:spin 1s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
    </style>
    
    <div class="app-container" style="opacity:0;transition:opacity 0.5s ease;" id="appContainer">
        <!-- Sidebar Overlay (mobile) -->
        <div class="sidebar-overlay" id="sidebarOverlay"></div>

        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-resize-handle" id="sidebarResizeHandle"></div>
            <div class="sidebar-header">
                <img src="/assets/logo_white.png" alt="Prio AI" class="sidebar-logo logo-dark">
                <img src="/assets/logo_black.png" alt="Prio AI" class="sidebar-logo logo-light" style="display:none;">
                <img src="/assets/favicon.png" alt="Prio AI" class="sidebar-logo-mini" style="display:none;">
                <button class="sidebar-collapse-btn" id="sidebarCollapseBtn" title="Collapse sidebar"></button>
                <button class="sidebar-close" id="sidebarClose">&times;</button>
            </div>

            <nav class="sidebar-nav">
                <!-- Overview (always at top) -->
                <div class="nav-section">
                    <div class="nav-item active" data-page="overview">
                        <span class="nav-item-icon"></span>
                        <span>Overview</span>
                    </div>
                </div>

                <!-- Prospects Section -->
                <div class="nav-section">
                    <div class="nav-section-title">Prospects</div>
                    <div class="nav-item" data-page="prio">
                        <span class="nav-item-icon"></span>
                        <span>Prio</span>
                    </div>
                    <div class="nav-item" data-page="prospects">
                        <span class="nav-item-icon"></span>
                        <span>Qualified</span>
                    </div>
                    <div class="nav-item" data-page="booked-today">
                        <span class="nav-item-icon"></span>
                        <span>Booked Today</span>
                    </div>
                    <div class="nav-item" data-page="shared">
                        <span class="nav-item-icon"></span>
                        <span>Shared</span>
                    </div>
                </div>

                <!-- AI Database Section (Collapsible) -->
                <div class="nav-section nav-section-collapsible" id="navSectionAIDatabase">
                    <div class="nav-section-title nav-section-toggle" data-section="ai-database">
                        <span>AI Database</span>
                        <span class="nav-section-arrow"></span>
                    </div>
                    <div class="nav-section-items">
                        <div class="nav-item" data-page="pipeline">
                            <span class="nav-item-icon"></span>
                            <span>AI Follow Ups</span>
                        </div>
                        <div class="nav-item" data-page="unqualified">
                            <span class="nav-item-icon"></span>
                            <span>Unqualified</span>
                        </div>
                        <div class="nav-item" data-page="search">
                            <span class="nav-item-icon"></span>
                            <span>Search</span>
                        </div>
                    </div>
                </div>

                <!-- Tools Section (Collapsible) -->
                <div class="nav-section nav-section-collapsible" id="navSectionTools">
                    <div class="nav-section-title nav-section-toggle" data-section="tools">
                        <span>Tools</span>
                        <span class="nav-section-arrow"></span>
                    </div>
                    <div class="nav-section-items">
                        <div class="nav-item" data-page="analytics">
                            <span class="nav-item-icon"></span>
                            <span>Analytics</span>
                        </div>
                        <div class="nav-item" data-page="import">
                            <span class="nav-item-icon"></span>
                            <span>Import Leads</span>
                        </div>
                        <div class="nav-item" data-page="leadgen">
                            <span class="nav-item-icon"></span>
                            <span>Lead Gen</span>
                        </div>
                        <div class="nav-item" data-page="help">
                            <span class="nav-item-icon"></span>
                            <span>Help</span>
                        </div>
                        <div class="nav-item" data-page="feedback">
                            <span class="nav-item-icon"></span>
                            <span>Contact Us</span>
                        </div>
                    </div>
                </div>
            </nav>

            <div class="sidebar-footer">
                <!-- Profile Menu (slides up) -->
                <div class="profile-menu" id="profileMenu">
                    <div class="profile-menu-item" data-page="settings">
                        <span></span> Settings
                    </div>
                    <div class="profile-menu-item" data-page="billing">
                        <span></span> Billing
                    </div>
                    <div class="profile-menu-divider"></div>
                    <div class="profile-menu-item logout" id="sidebarLogout">
                        <span></span> Sign Out
                    </div>
                </div>
                
                <!-- Notifications Popup -->
                <div class="notifications-popup" id="notificationsPopup">
                    <div class="notifications-header">
                        <span>Notifications</span>
                    </div>
                    <div class="notifications-empty">
                        No new notifications
                    </div>
                </div>
                
                <div class="sidebar-footer-row">
                    <div class="user-card" id="userCard">
                        <div class="user-avatar" id="userAvatar">U</div>
                        <div class="user-info">
                            <div class="user-name" id="userName">Guest</div>
                            <div class="user-email" id="userEmail">Not signed in</div>
                        </div>
                    </div>
                    <button class="notification-btn" id="notificationBtn" title="Notifications">
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                            <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                        </svg>
                        <span class="notification-badge" id="notificationBadge" style="display:none;">0</span>
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="header">
                <div class="header-left">
                    <button class="menu-toggle" id="menuToggle">
                        <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none">
                            <line x1="3" y1="12" x2="21" y2="12"></line>
                            <line x1="3" y1="6" x2="21" y2="6"></line>
                            <line x1="3" y1="18" x2="21" y2="18"></line>
                        </svg>
                    </button>
                    <h1 class="header-title" id="pageTitle">Overview</h1>
                </div>
                <div class="header-right">
                    <button class="btn btn-primary btn-sm" id="loginBtn">Sign In</button>
                </div>
            </header>

            <div class="page-content">
                <!-- Loading State -->
                <div class="loading" id="loadingState">
                    <div class="spinner"></div>
                    <p class="text-muted">Loading...</p>
                </div>

                <!-- Guest State -->
                <div id="guestState" class="hidden">
                    <div class="card" style="max-width: 500px; margin: 0 auto; text-align: center;">
                        <h2 style="margin-bottom: var(--space-4);">Welcome to Prio AI</h2>
                        <p style="color: var(--text-secondary); margin-bottom: var(--space-6);">Sign in to access your dashboard and start converting more leads.</p>
                        <div style="display:flex;flex-direction:column;gap:12px;align-items:center;">
                            <button class="btn btn-primary btn-lg" id="guestLoginBtn" style="width:100%;max-width:200px;">Get Started</button>
                            <button class="btn btn-secondary btn-lg" id="guestSignInBtn" style="width:100%;max-width:200px;">Sign In</button>
                        </div>
                    </div>
                </div>

                <!-- Subscription Locked State -->
                <div id="subscriptionLocked" class="hidden">
                    <div style="max-width:900px;margin:0 auto;padding:var(--space-6);">
                        <div style="text-align:center;margin-bottom:var(--space-8);">
                            <div style="font-size:3rem;margin-bottom:var(--space-4);"></div>
                            <h2 style="font-family:var(--font-heading);font-size:1.75rem;font-weight:700;margin-bottom:var(--space-3);">Your subscription is inactive</h2>
                            <p id="subscriptionLockedMsg" style="color:var(--text-secondary);font-size:var(--text-base);max-width:500px;margin:0 auto;">Choose a plan below to reactivate your dashboard and get your AI caller back to work.</p>
                        </div>
                        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:var(--space-5);margin-bottom:var(--space-8);">
                            <div class="card" style="text-align:center;padding:var(--space-6);">
                                <h3 style="font-size:var(--text-lg);font-weight:700;margin-bottom:var(--space-2);">Starter</h3>
                                <p style="color:var(--text-secondary);font-size:var(--text-sm);margin-bottom:var(--space-4);">For individual agents getting started.</p>
                                <div style="font-family:var(--font-heading);font-size:2rem;font-weight:800;margin-bottom:var(--space-1);"><span style="font-size:var(--text-lg);vertical-align:super;color:var(--text-secondary);">$</span>199</div>
                                <div style="font-size:var(--text-sm);color:var(--text-tertiary);margin-bottom:var(--space-4);">per month &middot; 1,000 calls</div>
                                <a href="https://buy.stripe.com/8x23cwa2D8IT01adTM6Ri06" class="btn btn-secondary btn-block btn-lg sub-plan-btn">Get Started</a>
                            </div>
                            <div class="card" style="text-align:center;padding:var(--space-6);border-color:#f59e0b;">
                                <div style="display:inline-block;background:#f59e0b;color:#000;font-size:var(--text-xs);font-weight:600;padding:2px 10px;border-radius:999px;margin-bottom:var(--space-3);">Founding Member</div>
                                <h3 style="font-size:var(--text-lg);font-weight:700;margin-bottom:var(--space-2);">Professional</h3>
                                <p style="color:var(--text-secondary);font-size:var(--text-sm);margin-bottom:var(--space-4);">For agents ready to scale.</p>
                                <div style="font-family:var(--font-heading);font-size:2rem;font-weight:800;margin-bottom:var(--space-1);"><span style="font-size:var(--text-sm);color:var(--text-tertiary);text-decoration:line-through;">$399</span> <span style="font-size:var(--text-lg);vertical-align:super;color:var(--text-secondary);">$</span>299</div>
                                <div style="font-size:var(--text-sm);color:var(--text-tertiary);margin-bottom:var(--space-4);">per month &middot; 3,000 calls</div>
                                <a href="https://buy.stripe.com/8x200keiT1gr29ig1U6Ri09" class="btn btn-block btn-lg sub-plan-btn" style="background:#f59e0b;color:#000;border-color:#f59e0b;">Get Started</a>
                            </div>
                            <div class="card" style="text-align:center;padding:var(--space-6);border-color:var(--accent);">
                                <div style="display:inline-block;background:var(--accent);color:#000;font-size:var(--text-xs);font-weight:600;padding:2px 10px;border-radius:999px;margin-bottom:var(--space-3);">Best Value</div>
                                <h3 style="font-size:var(--text-lg);font-weight:700;margin-bottom:var(--space-2);">Growth</h3>
                                <p style="color:var(--text-secondary);font-size:var(--text-sm);margin-bottom:var(--space-4);">Maximum call volume to scale faster.</p>
                                <div style="font-family:var(--font-heading);font-size:2rem;font-weight:800;margin-bottom:var(--space-1);"><span style="font-size:var(--text-lg);vertical-align:super;color:var(--text-secondary);">$</span>599</div>
                                <div style="font-size:var(--text-sm);color:var(--text-tertiary);margin-bottom:var(--space-4);">per month &middot; 6,000 calls</div>
                                <a href="https://buy.stripe.com/5kQ28sgr10cn15e4jc6Ri08" class="btn btn-primary btn-block btn-lg sub-plan-btn">Get Started</a>
                            </div>
                        </div>
                        <div style="text-align:center;">
                            <p style="font-size:var(--text-sm);color:var(--text-tertiary);margin-bottom:var(--space-3);">All plans billed monthly. Cancel anytime.</p>
                            <a href="#" id="subLockedLogout" style="font-size:var(--text-sm);color:var(--text-tertiary);">Log out</a>
                        </div>
                    </div>
                </div>

                <!-- Dashboard Content -->
                <div id="dashboardContent" class="hidden">
                    <!-- Page: Overview -->
                    <div class="page dashboard-loading" id="page-overview">
                        <!-- Welcome Header with Compact Stats -->
                        <div class="overview-header-row">
                            <div class="overview-header-left">
                                <h1 class="overview-welcome">Welcome back, <span id="welcomeName">there</span> </h1>
                                <div class="overview-header-meta">
                                    <span class="header-meta-item" id="welcomeDate"></span>
                                    <span class="header-meta-divider"></span>
                                    <span class="header-meta-item" id="welcomePhone"><span class="meta-label">AI:</span> <span class="meta-value" id="retellPhoneNumber">-</span></span>
                                </div>
                            </div>
                            <div class="overview-header-right">
                                <div class="header-stat-badge usage-badge" id="usageCard">
                                    <div class="dashboard-loading-overlay"><div class="dashboard-loading-spinner"></div></div>
                                    <span class="badge-emoji"></span>
                                    <div class="badge-value"><span id="usageCalls">0</span>/<span id="usageLimit">0</span></div>
                                    <div class="badge-label">Usage</div>
                                    <div class="usage-bar-mini"><div class="usage-bar-fill" id="usageBarFill"></div></div>
                                </div>
                                <div class="header-stat-badge">
                                    <div class="dashboard-loading-overlay"><div class="dashboard-loading-spinner"></div></div>
                                    <span class="badge-emoji"></span>
                                    <div class="badge-value" id="statProspects">-</div>
                                    <div class="badge-label">Leads</div>
                                </div>
                                <div class="header-stat-badge accent">
                                    <div class="dashboard-loading-overlay"><div class="dashboard-loading-spinner"></div></div>
                                    <span class="badge-emoji"></span>
                                    <div class="badge-value" id="statAppointments">-</div>
                                    <div class="badge-label">Booked</div>
                                </div>
                            </div>
                        </div>

                        <!-- Row 1: Pipeline Overview -->
                        <div class="section-label">Pipeline Overview</div>
                        <div class="overview-grid">
                            <div class="overview-card card-green" onclick="switchPage('prio')">
                                <div class="dashboard-loading-overlay"><div class="dashboard-loading-spinner"></div></div>
                                <div class="overview-card-header">
                                    <span class="overview-card-icon"></span>
                                    <h4>Prio Prospects</h4>
                                </div>
                                <div class="overview-card-value" id="overviewPrio">0</div>
                                <div class="overview-card-desc">Priority leads to focus on</div>
                            </div>
                            <div class="overview-card card-blue" onclick="switchPage('prospects')">
                                <div class="dashboard-loading-overlay"><div class="dashboard-loading-spinner"></div></div>
                                <div class="overview-card-header">
                                    <span class="overview-card-icon"></span>
                                    <h4>Prospects</h4>
                                </div>
                                <div class="overview-card-value" id="overviewScheduled">0</div>
                                <div class="overview-card-desc">Callbacks & meetings booked</div>
                            </div>
                            <div class="overview-card card-orange" style="cursor:default">
                                <div class="dashboard-loading-overlay"><div class="dashboard-loading-spinner"></div></div>
                                <div class="overview-card-header">
                                    <span class="overview-card-icon"></span>
                                    <h4>Active Leads</h4>
                                </div>
                                <div class="overview-card-value" id="overviewActive">0</div>
                                <div class="overview-card-desc">Being called by AI</div>
                            </div>
                            <div class="overview-card card-purple" onclick="switchPage('pipeline')">
                                <div class="dashboard-loading-overlay"><div class="dashboard-loading-spinner"></div></div>
                                <div class="overview-card-header">
                                    <span class="overview-card-icon"></span>
                                    <h4>AI Pipeline</h4>
                                </div>
                                <div class="overview-card-value" id="overviewPipeline">0</div>
                                <div class="overview-card-desc">Timeline & follow-ups</div>
                            </div>
                        </div>

                        <!-- Row 2: Today's Activity -->
                        <div class="section-label">Today's Numbers</div>
                        <div class="today-numbers-bar">
                            <div class="today-number-item">
                                <div class="dashboard-loading-overlay"><div class="dashboard-loading-spinner"></div></div>
                                <div class="today-number-icon"></div>
                                <div class="today-number-value" id="statCallsToday">0</div>
                                <div class="today-number-label">AI Calls</div>
                            </div>
                            <div class="today-numbers-divider"></div>
                            <div class="today-number-item">
                                <div class="dashboard-loading-overlay"><div class="dashboard-loading-spinner"></div></div>
                                <div class="today-number-icon"></div>
                                <div class="today-number-value" id="statConversationsToday">0</div>
                                <div class="today-number-label">Conversations</div>
                            </div>
                            <div class="today-numbers-divider"></div>
                            <div class="today-number-item">
                                <div class="dashboard-loading-overlay"><div class="dashboard-loading-spinner"></div></div>
                                <div class="today-number-icon"></div>
                                <div class="today-number-value" id="statMeetingsToday">0</div>
                                <div class="today-number-label">Meetings</div>
                            </div>
                            <div class="today-numbers-divider"></div>
                            <div class="today-number-item">
                                <div class="dashboard-loading-overlay"><div class="dashboard-loading-spinner"></div></div>
                                <div class="today-number-icon"></div>
                                <div class="today-number-value" id="statFollowUpsToday">0</div>
                                <div class="today-number-label">Follow Ups</div>
                            </div>
                        </div>

                        <!-- View Analytics Button -->
                        <div style="text-align:center;margin:1.5rem 0;">
                            <button class="btn btn-secondary" onclick="switchPage('analytics')" style="padding:12px 24px;">
                                 View All Analytics
                            </button>
                        </div>

                        <!-- Today's Priorities Section -->
                        <div class="priorities-section">
                            <div class="priorities-header">
                                <h3> Today's Priorities <span class="priorities-count" id="prioritiesCount">0</span></h3>
                                <div class="priorities-view-toggle">
                                    <button class="view-toggle-btn" id="viewGrid" onclick="setPrioritiesView('grid')" title="Grid view"></button>
                                    <button class="view-toggle-btn active" id="viewList" onclick="setPrioritiesView('list')" title="List view"></button>
                                    <button class="font-size-toggle size-sm" onclick="cycleFontSize()" title="Change font size"><span class="size-icon">Aa</span> <span class="size-label">S</span></button>
                                </div>
                            </div>
                            <div class="priorities-cards list-view" id="todayPriorities">
                                <div class="priorities-empty">
                                    <p>No meetings or callbacks scheduled for today</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Page: PRIO -->
                    <div class="page hidden" id="page-prio">
                        <!-- Prio Header -->
                        <div class="prio-header">
                            <div class="prio-header-text">
                                <h2> Prio Prospects <span class="header-count-badge" id="prioCount">0</span></h2>
                                <p>Your priority leads ranked by engagement. Focus here first.</p>
                            </div>
                            <div class="prio-header-actions">
                                <div class="view-toggle">
                                    <button class="view-toggle-btn active" id="prioViewList" onclick="setPrioView('list')" title="List view"></button>
                                    <button class="view-toggle-btn" id="prioViewGrid" onclick="setPrioView('grid')" title="Grid view"></button>
                                    <button class="font-size-toggle size-sm" onclick="cycleFontSize()" title="Change font size"><span class="size-icon">Aa</span> <span class="size-label">S</span></button>
                                </div>
                            </div>
                        </div>

                        <!-- Prio Filters -->
                        <div class="filters-bar">
                            <div class="filters-left">
                                <div class="search-box">
                                    <span class="search-icon"></span>
                                    <input type="text" id="prioSearch" placeholder="Search by name or phone...">
                                </div>
                                <select id="prioStatus" class="filter-select">
                                    <option value="all">All Status</option>
                                    <option value="Booked">Meeting Booked</option>
                                    <option value="Retry">Retrying</option>
                                    <option value="Callback Rescheduled">Callback Rescheduled</option>
                                    <option value="Meeting in Person">Meeting in Person</option>
                                    <option value="Sending Listings">Sending Listings</option>
                                    <option value="Listings Sent">Listings Sent</option>
                                    <option value="Scheduling Showings">Scheduling Showings</option>
                                    <option value="Viewed Properties">Viewed Properties</option>
                                    <option value="Offer Placed">Offer Placed</option>
                                    <option value="Deal Closed">Deal Closed</option>
                                </select>
                                <select id="prioOwnership" class="filter-select">
                                    <option value="all">All Leads</option>
                                    <option value="mine">My Prospects</option>
                                    <option value="shared-by">Shared By Me</option>
                                    <option value="not-shared">Not Shared</option>
                                    <option value="shared-with">Shared With Me</option>
                                </select>
                                <select id="prioTimeframe" class="filter-select">
                                    <option value="all">All Time</option>
                                    <option value="today">Today</option>
                                    <option value="7days">Last 7 Days</option>
                                    <option value="30days">Last 30 Days</option>
                                    <option value="90days">Last 90 Days</option>
                                </select>
                            </div>
                            <div class="sort-controls">
                                <span class="sort-label">Sort by</span>
                                <select id="prioSort" class="filter-select sort-select">
                                    <option value="priority">Priority</option>
                                    <option value="name">Name</option>
                                    <option value="meetingTime">Meeting Time</option>
                                    <option value="lastUpdated">Last Updated</option>
                                </select>
                                <button class="sort-direction-btn" id="prioSortDir" onclick="togglePrioSortDir()" title="Toggle sort direction"></button>
                            </div>
                        </div>

                        <!-- Prio Cards -->
                        <div class="prio-list list-view" id="prioList">
                            <div class="page-loading"><div class="spinner"></div><p>Loading priority leads...</p></div>
                        </div>
                    </div>

                    <!-- Page: Prospects -->
                    <div class="page hidden" id="page-prospects">
                        <!-- Prospects Header -->
                        <div class="prospects-header">
                            <div class="prospects-header-text">
                                <h2> Prospects <span class="header-count-badge" id="prospectsCount">0</span></h2>
                                <p>Booked meetings and callback requests.</p>
                            </div>
                            <div class="prospects-header-actions">
                                <div class="view-toggle">
                                    <button class="view-toggle-btn active" id="prospectsViewList" onclick="setProspectsView('list')" title="List view"></button>
                                    <button class="view-toggle-btn" id="prospectsViewGrid" onclick="setProspectsView('grid')" title="Grid view"></button>
                                    <button class="font-size-toggle size-sm" onclick="cycleFontSize()" title="Change font size"><span class="size-icon">Aa</span> <span class="size-label">S</span></button>
                                </div>
                            </div>
                        </div>

                        <!-- Prospects Filters -->
                        <div class="filters-bar">
                            <div class="filters-left">
                                <div class="search-box">
                                    <span class="search-icon"></span>
                                    <input type="text" id="prospectsSearch" placeholder="Search by name or phone...">
                                </div>
                                <select id="prospectsStatus" class="filter-select">
                                    <option value="all">All Status</option>
                                    <option value="Booked">Meeting Booked</option>
                                    <option value="Callback">Callback</option>
                                    <option value="Retry">Retrying</option>
                                    <option value="Callback Rescheduled">Callback Rescheduled</option>
                                    <option value="Meeting in Person">Meeting in Person</option>
                                    <option value="Sending Listings">Sending Listings</option>
                                    <option value="Listings Sent">Listings Sent</option>
                                    <option value="Scheduling Showings">Scheduling Showings</option>
                                    <option value="Viewed Properties">Viewed Properties</option>
                                    <option value="Offer Placed">Offer Placed</option>
                                    <option value="Deal Closed">Deal Closed</option>
                                </select>
                                <select id="prospectsOwnership" class="filter-select">
                                    <option value="all">All Leads</option>
                                    <option value="mine">My Prospects</option>
                                    <option value="shared-by">Shared By Me</option>
                                    <option value="not-shared">Not Shared</option>
                                    <option value="shared-with">Shared With Me</option>
                                </select>
                                <select id="prospectsTimeframe" class="filter-select">
                                    <option value="all">All Time</option>
                                    <option value="today">Today</option>
                                    <option value="7days">Last 7 Days</option>
                                    <option value="30days">Last 30 Days</option>
                                    <option value="90days">Last 90 Days</option>
                                </select>
                            </div>
                            <div class="sort-controls">
                                <span class="sort-label">Sort by</span>
                                <select id="prospectsSort" class="filter-select sort-select">
                                    <option value="bookedTime">Meeting Time</option>
                                    <option value="name">Name</option>
                                    <option value="lastUpdated">Last Updated</option>
                                </select>
                                <button class="sort-direction-btn" id="prospectsSortDir" onclick="toggleProspectsSortDir()" title="Toggle sort direction"></button>
                            </div>
                        </div>

                        <!-- Prospects Cards -->
                        <div class="prospects-list list-view" id="prospectsList">
                            <div class="page-loading"><div class="spinner"></div><p>Loading prospects...</p></div>
                        </div>
                    </div>

                    <!-- Page: Pipeline -->
                    <div class="page hidden" id="page-pipeline">
                        <!-- Pipeline Header -->
                        <div class="pipeline-header">
                            <div class="pipeline-header-text">
                                <h2> AI Follow Ups <span class="header-count-badge" id="pipelineCount">0</span></h2>
                                <p>Leads being followed up by AI. Timeline and scheduled follow-ups.</p>
                            </div>
                            <div class="pipeline-header-actions">
                                <div class="view-toggle">
                                    <button class="view-toggle-btn active" id="pipelineViewList" onclick="setPipelineView('list')" title="List view"></button>
                                    <button class="view-toggle-btn" id="pipelineViewGrid" onclick="setPipelineView('grid')" title="Grid view"></button>
                                    <button class="font-size-toggle size-sm" onclick="cycleFontSize()" title="Change font size"><span class="size-icon">Aa</span> <span class="size-label">S</span></button>
                                </div>
                            </div>
                        </div>

                        <!-- Pipeline Filters -->
                        <div class="filters-bar">
                            <div class="filters-left">
                                <div class="search-box">
                                    <span class="search-icon"></span>
                                    <input type="text" id="pipelineSearch" placeholder="Search by name or phone...">
                                </div>
                                <select id="pipelineStatus" class="filter-select">
                                    <option value="all">All Status</option>
                                    <option value="Timeline">Timeline</option>
                                    <option value="Follow Up">Follow Up</option>
                                </select>
                                <select id="pipelineTimeframe" class="filter-select">
                                    <option value="all">All Time</option>
                                    <option value="7days">Next 7 Days</option>
                                    <option value="30days">Next 30 Days</option>
                                    <option value="90days">Next 90 Days</option>
                                </select>
                            </div>
                            <div class="sort-controls">
                                <span class="sort-label">Sort by</span>
                                <select id="pipelineSort" class="filter-select sort-select">
                                    <option value="nextCall">Next Call</option>
                                    <option value="name">Name</option>
                                    <option value="lastUpdated">Last Updated</option>
                                </select>
                                <button class="sort-direction-btn" id="pipelineSortDir" onclick="togglePipelineSortDir()" title="Toggle sort direction"></button>
                            </div>
                        </div>

                        <!-- Pipeline Cards -->
                        <div class="pipeline-list list-view" id="pipelineList">
                            <div class="page-loading"><div class="spinner"></div><p>Loading AI follow ups...</p></div>
                        </div>
                    </div>

                    <!-- Page: Shared Leads -->
                    <div class="page hidden" id="page-shared">
                        <!-- Shared Header -->
                        <div class="shared-header">
                            <div class="shared-header-text">
                                <h2> Shared Leads <span class="header-count-badge" id="sharedCount">0</span></h2>
                                <p>Leads that have been shared with you.</p>
                            </div>
                            <div class="shared-header-actions">
                                <div class="view-toggle">
                                    <button class="view-toggle-btn active" id="sharedViewList" onclick="setSharedView('list')" title="List view"></button>
                                    <button class="view-toggle-btn" id="sharedViewGrid" onclick="setSharedView('grid')" title="Grid view"></button>
                                    <button class="font-size-toggle size-sm" onclick="cycleFontSize()" title="Change font size"><span class="size-icon">Aa</span> <span class="size-label">S</span></button>
                                </div>
                            </div>
                        </div>

                        <!-- Shared Filters -->
                        <div class="filters-bar">
                            <div class="filters-left">
                                <div class="search-box">
                                    <span class="search-icon"></span>
                                    <input type="text" id="sharedSearch" placeholder="Search by name or phone...">
                                </div>
                                <select id="sharedDirection" class="filter-select">
                                    <option value="all">All Shared</option>
                                    <option value="with-me">Shared with Me</option>
                                </select>
                                <select id="sharedStatus" class="filter-select">
                                    <option value="all">All Status</option>
                                    <option value="Booked">Meeting Booked</option>
                                    <option value="Callback">Callback</option>
                                    <option value="Retry">Retrying</option>
                                    <option value="Callback Rescheduled">Callback Rescheduled</option>
                                    <option value="Meeting in Person">Meeting in Person</option>
                                    <option value="Sending Listings">Sending Listings</option>
                                    <option value="Listings Sent">Listings Sent</option>
                                    <option value="Scheduling Showings">Scheduling Showings</option>
                                    <option value="Viewed Properties">Viewed Properties</option>
                                    <option value="Offer Placed">Offer Placed</option>
                                    <option value="Deal Closed">Deal Closed</option>
                                    <option value="Timeline">Timeline</option>
                                    <option value="Follow Up">Follow Up</option>
                                </select>
                                <select id="sharedTimeframe" class="filter-select">
                                    <option value="all">All Time</option>
                                    <option value="today">Today</option>
                                    <option value="7days">Last 7 Days</option>
                                    <option value="30days">Last 30 Days</option>
                                    <option value="90days">Last 90 Days</option>
                                </select>
                            </div>
                            <div class="sort-controls">
                                <span class="sort-label">Sort by</span>
                                <select id="sharedSort" class="filter-select sort-select">
                                    <option value="priority">Priority</option>
                                    <option value="name">Name</option>
                                    <option value="meetingTime">Meeting Time</option>
                                    <option value="lastUpdated">Last Updated</option>
                                </select>
                                <button class="sort-direction-btn" id="sharedSortDir" onclick="toggleSharedSortDir()" title="Toggle sort direction"></button>
                            </div>
                        </div>

                        <!-- Shared Cards -->
                        <div class="shared-list list-view" id="sharedList">
                            <div class="page-loading"><div class="spinner"></div><p>Loading shared leads...</p></div>
                        </div>
                    </div>

                    <!-- Page: Booked Today -->
                    <div class="page hidden" id="page-booked-today">
                        <!-- Booked Today Header -->
                        <div class="pipeline-header">
                            <div class="pipeline-header-text">
                                <h2> Booked Today <span class="header-count-badge" id="bookedTodayCount">0</span></h2>
                                <p>Prospects qualified and booked/callback by AI from today's conversations.</p>
                            </div>
                            <div class="pipeline-header-actions">
                                <div class="view-toggle">
                                    <button class="view-toggle-btn active" id="bookedTodayViewList" onclick="setBookedTodayView('list')" title="List view"></button>
                                    <button class="view-toggle-btn" id="bookedTodayViewGrid" onclick="setBookedTodayView('grid')" title="Grid view"></button>
                                    <button class="font-size-toggle size-sm" onclick="cycleFontSize()" title="Change font size"><span class="size-icon">Aa</span> <span class="size-label">S</span></button>
                                </div>
                            </div>
                        </div>

                        <!-- Booked Today Tabs -->
                        <div class="unqualified-tabs">
                            <button class="unqualified-tab active" data-booked-type="all">All</button>
                            <button class="unqualified-tab" data-booked-type="Booked">Booked</button>
                            <button class="unqualified-tab" data-booked-type="Callback">Callback</button>
                        </div>

                        <!-- Booked Today Filters -->
                        <div class="filters-bar">
                            <div class="filters-left">
                                <div class="search-box">
                                    <span class="search-icon"></span>
                                    <input type="text" id="bookedTodaySearch" placeholder="Search by name or phone...">
                                </div>
                            </div>
                            <div class="sort-controls">
                                <span class="sort-label">Sort by</span>
                                <select id="bookedTodaySort" class="filter-select sort-select">
                                    <option value="callTime">Call Time</option>
                                    <option value="name">Name</option>
                                    <option value="bookedTime">Booked Time</option>
                                </select>
                                <button class="sort-direction-btn" id="bookedTodaySortDir" onclick="toggleBookedTodaySortDir()" title="Toggle sort direction"></button>
                            </div>
                        </div>

                        <!-- Booked Today Cards -->
                        <div class="pipeline-list list-view" id="bookedTodayList">
                            <div class="page-loading"><div class="spinner"></div><p>Loading booked today...</p></div>
                        </div>
                    </div>

                    <!-- Page: Unqualified Leads -->
                    <div class="page hidden" id="page-unqualified">
                        <!-- Unqualified Header -->
                        <div class="unqualified-header">
                            <div class="unqualified-header-text">
                                <h2> Unqualified Leads <span class="header-count-badge" id="unqualifiedCount">0</span></h2>
                                <p>Leads that are not yet booked or in an active pipeline.</p>
                            </div>
                            <div class="unqualified-header-actions">
                                <div class="view-toggle">
                                    <button class="view-toggle-btn active" id="unqualifiedViewList" onclick="setUnqualifiedView('list')" title="List view"></button>
                                    <button class="view-toggle-btn" id="unqualifiedViewGrid" onclick="setUnqualifiedView('grid')" title="Grid view"></button>
                                    <button class="font-size-toggle size-sm" onclick="cycleFontSize()" title="Change font size"><span class="size-icon">Aa</span> <span class="size-label">S</span></button>
                                </div>
                            </div>
                        </div>

                        <!-- Unqualified Last Outcome Tabs -->
                        <div class="unqualified-tabs">
                            <button class="unqualified-tab active" data-outcome="all">All</button>
                            <button class="unqualified-tab" data-outcome="Max Attempts">Max Attempts</button>
                            <button class="unqualified-tab" data-outcome="Wrong Person">Wrong Person</button>
                            <button class="unqualified-tab" data-outcome="DNC">DNC</button>
                            <button class="unqualified-tab" data-outcome="Inconclusive">Inconclusive</button>
                        </div>

                        <!-- Unqualified Filters -->
                        <div class="filters-bar">
                            <div class="filters-left">
                                <div class="search-box">
                                    <span class="search-icon"></span>
                                    <input type="text" id="unqualifiedSearch" placeholder="Search by name or phone...">
                                </div>
                                <select id="unqualifiedOwnership" class="filter-select">
                                    <option value="all">All Leads</option>
                                    <option value="mine">My Prospects</option>
                                    <option value="shared-by">Shared By Me</option>
                                    <option value="not-shared">Not Shared</option>
                                    <option value="shared-with">Shared With Me</option>
                                </select>
                                <select id="unqualifiedTimeframe" class="filter-select">
                                    <option value="all">All Time</option>
                                    <option value="today">Today</option>
                                    <option value="7days">Last 7 Days</option>
                                    <option value="30days">Last 30 Days</option>
                                    <option value="90days">Last 90 Days</option>
                                </select>
                            </div>
                            <div class="sort-controls">
                                <span class="sort-label">Sort by</span>
                                <select id="unqualifiedSort" class="filter-select sort-select">
                                    <option value="lastUpdated">Last Updated</option>
                                    <option value="name">Name</option>
                                    <option value="nextCall">Next Call</option>
                                </select>
                                <button class="sort-direction-btn" id="unqualifiedSortDir" onclick="toggleUnqualifiedSortDir()" title="Toggle sort direction"></button>
                            </div>
                        </div>

                        <!-- Unqualified Cards -->
                        <div class="unqualified-list list-view" id="unqualifiedList">
                            <div class="page-loading"><div class="spinner"></div><p>Loading unqualified leads...</p></div>
                        </div>
                    </div>

                    <!-- Page: Open Leads -->
                    <div class="page hidden" id="page-open-leads">
                        <!-- Open Leads Header -->
                        <div class="unqualified-header">
                            <div class="unqualified-header-text">
                                <h2> Open Leads <span class="header-count-badge" id="openLeadsCount">0</span></h2>
                                <p>Leads with Status = New or Retry that are ready to be called.</p>
                            </div>
                            <div class="unqualified-header-actions">
                                <div class="view-toggle">
                                    <button class="view-toggle-btn active" id="openLeadsViewList" onclick="setOpenLeadsView('list')" title="List view"></button>
                                    <button class="view-toggle-btn" id="openLeadsViewGrid" onclick="setOpenLeadsView('grid')" title="Grid view"></button>
                                </div>
                            </div>
                        </div>

                        <!-- Open Leads Status Tabs -->
                        <div class="unqualified-tabs">
                            <button class="unqualified-tab active" data-open-status="all">All</button>
                            <button class="unqualified-tab" data-open-status="New">New</button>
                            <button class="unqualified-tab" data-open-status="Retry">Retry</button>
                        </div>

                        <!-- Open Leads Filters -->
                        <div class="filters-bar">
                            <div class="filters-left">
                                <div class="search-box">
                                    <span class="search-icon"></span>
                                    <input type="text" id="openLeadsSearch" placeholder="Search by name or phone...">
                                </div>
                                <select id="openLeadsOwnership" class="filter-select">
                                    <option value="all">All Leads</option>
                                    <option value="mine">My Prospects</option>
                                    <option value="shared-by">Shared By Me</option>
                                    <option value="not-shared">Not Shared</option>
                                    <option value="shared-with">Shared With Me</option>
                                </select>
                                <select id="openLeadsTimeframe" class="filter-select">
                                    <option value="all">All Time</option>
                                    <option value="today">Today</option>
                                    <option value="7days">Last 7 Days</option>
                                    <option value="30days">Last 30 Days</option>
                                    <option value="90days">Last 90 Days</option>
                                </select>
                            </div>
                            <div class="sort-controls">
                                <span class="sort-label">Sort by</span>
                                <select id="openLeadsSort" class="filter-select sort-select">
                                    <option value="lastUpdated">Last Updated</option>
                                    <option value="name">Name</option>
                                    <option value="nextCall">Next Call</option>
                                </select>
                                <button class="sort-direction-btn" id="openLeadsSortDir" onclick="toggleOpenLeadsSortDir()" title="Toggle sort direction"></button>
                            </div>
                        </div>

                        <!-- Open Leads Cards -->
                        <div class="unqualified-list list-view" id="openLeadsList">
                            <div class="page-loading"><div class="spinner"></div><p>Loading open leads...</p></div>
                        </div>
                    </div>

                    <!-- Page: Analytics -->
                    <div class="page hidden" id="page-analytics">
                        <!-- Modern Header with Date Navigation -->
                        <div class="analytics-header-modern">
                            <div class="analytics-title-section">
                                <h2>Analytics</h2>
                                <p class="analytics-subtitle">AI Calling Performance</p>
                            </div>
                            <div class="analytics-date-nav" style="position:relative">
                                <button class="date-nav-btn" id="analyticsPrevDay" title="Previous">
                                    <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>
                                </button>
                                <div class="date-display" id="analyticsDateDisplay">
                                    <span class="date-day">Today</span>
                                    <span class="date-full">February 4, 2025</span>
                                </div>
                                <button class="date-nav-btn" id="analyticsNextDay" title="Next">
                                    <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
                                </button>
                                <button class="date-nav-today" id="analyticsTodayBtn">Today</button>

                                <!-- Custom Date Picker Dropdown -->
                                <div class="custom-date-picker" id="customDatePicker">
                                    <!-- Daily Calendar View -->
                                    <div class="picker-calendar" id="pickerCalendar">
                                        <div class="picker-header">
                                            <button class="picker-nav" id="pickerPrevMonth">&lt;</button>
                                            <span class="picker-month" id="pickerMonthLabel">February 2026</span>
                                            <button class="picker-nav" id="pickerNextMonth">&gt;</button>
                                        </div>
                                        <div class="picker-weekdays">
                                            <span>Mo</span><span>Tu</span><span>We</span><span>Th</span><span>Fr</span><span>Sa</span><span>Su</span>
                                        </div>
                                        <div class="picker-days" id="pickerDays"></div>
                                    </div>
                                    <!-- Weekly Dropdown -->
                                    <div class="picker-dropdown" id="pickerWeekly">
                                        <div class="picker-dropdown-list" id="weeklyList"></div>
                                    </div>
                                    <!-- Monthly Dropdown -->
                                    <div class="picker-dropdown" id="pickerMonthly">
                                        <div class="picker-dropdown-list" id="monthlyList"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Data Source Toggle -->
                        <div class="analytics-data-source-row">
                            <div class="analytics-data-toggle">
                                <button class="data-toggle-btn active" id="viewCallsData" data-source="calls">CALLS DATA</button>
                                <button class="data-toggle-btn" id="viewLeadsData" data-source="leads">LEADS DATA</button>
                            </div>
                        </div>

                        <!-- Period Selector Pills -->
                        <div class="analytics-period-row">
                            <div class="analytics-period-tabs">
                                <button class="analytics-period-tab active" data-period="daily">Day</button>
                                <button class="analytics-period-tab" data-period="weekly">Week</button>
                                <button class="analytics-period-tab" data-period="monthly">Month</button>
                                <button class="analytics-period-tab" data-period="all">All Time</button>
                            </div>
                            <div class="analytics-view-toggle">
                                <button class="view-toggle-btn active" id="viewNumbers" title="Show numbers">#</button>
                                <button class="view-toggle-btn" id="viewPercents" title="Show percentages">%</button>
                            </div>
                        </div>

                        <!-- Hero Stats Row -->
                        <div class="analytics-hero-stats">
                            <div class="hero-stat-card primary">
                                <div class="hero-stat-icon"></div>
                                <div class="hero-stat-content">
                                    <div class="hero-stat-value" id="analyticsTotalCalls">0</div>
                                    <div class="hero-stat-label">Total Calls</div>
                                </div>
                            </div>
                            <div class="hero-stat-card success">
                                <div class="hero-stat-icon"></div>
                                <div class="hero-stat-content">
                                    <div class="hero-stat-value" id="analyticsConversations">0</div>
                                    <div class="hero-stat-label">Conversations</div>
                                </div>
                            </div>
                            <div class="hero-stat-card accent">
                                <div class="hero-stat-icon"></div>
                                <div class="hero-stat-content">
                                    <div class="hero-stat-value" id="analyticsBooked">0</div>
                                    <div class="hero-stat-label">Meetings Booked</div>
                                </div>
                            </div>
                            <div class="hero-stat-card">
                                <div class="hero-stat-icon"></div>
                                <div class="hero-stat-content">
                                    <div class="hero-stat-value" id="analyticsActivePipeline">0</div>
                                    <div class="hero-stat-label">In AI Pipeline</div>
                                </div>
                            </div>
                        </div>

                        <!-- Conversion Funnel -->
                        <div class="analytics-card-section">
                            <div class="analytics-card-header">
                                <h3>Conversion Funnel</h3>
                                <span class="card-period" id="analyticsFunnelPeriod">Today</span>
                            </div>
                            <div class="conversion-funnel">
                                <div class="funnel-stage">
                                    <div class="funnel-bar" style="width:100%">
                                        <span class="funnel-value" id="funnelCalls">0</span>
                                    </div>
                                    <span class="funnel-label">Calls Made</span>
                                </div>
                                <div class="funnel-stage">
                                    <div class="funnel-bar conversations" id="funnelConvBar" style="width:0%">
                                        <span class="funnel-value" id="funnelConversations">0</span>
                                    </div>
                                    <span class="funnel-label">Conversations <span class="funnel-pct" id="funnelConvPct">0%</span></span>
                                </div>
                                <div class="funnel-stage">
                                    <div class="funnel-bar qualified" id="funnelQualBar" style="width:0%">
                                        <span class="funnel-value" id="funnelQualified">0</span>
                                    </div>
                                    <span class="funnel-label">Qualified <span class="funnel-pct" id="funnelQualPct">0%</span></span>
                                </div>
                                <div class="funnel-stage">
                                    <div class="funnel-bar booked" id="funnelBookedBar" style="width:0%">
                                        <span class="funnel-value" id="funnelBooked">0</span>
                                    </div>
                                    <span class="funnel-label">Booked / Callback <span class="funnel-pct" id="funnelBookedPct">0%</span></span>
                                </div>
                            </div>
                        </div>

                        <!-- Two Column Layout -->
                        <div class="analytics-two-col">
                            <!-- Qualified Outcomes -->
                            <div class="analytics-card-section">
                                <div class="analytics-card-header">
                                    <h3>Qualified Outcomes</h3>
                                </div>
                                <div class="outcome-stats-grid">
                                    <div class="outcome-stat booked">
                                        <div class="outcome-stat-value analytics-toggleable" id="analyticsBookedStat" data-count="0" data-pct="0%">0</div>
                                        <div class="outcome-stat-label">Booked</div>
                                        <div class="outcome-stat-bar"><div class="bar-fill booked" id="bookedBar"></div></div>
                                    </div>
                                    <div class="outcome-stat callback">
                                        <div class="outcome-stat-value analytics-toggleable" id="analyticsCallbackCount" data-count="0" data-pct="0%">0</div>
                                        <div class="outcome-stat-label">Callback</div>
                                        <div class="outcome-stat-bar"><div class="bar-fill callback" id="callbackBar"></div></div>
                                    </div>
                                    <div class="outcome-stat timeline">
                                        <div class="outcome-stat-value analytics-toggleable" id="analyticsTimelineCount" data-count="0" data-pct="0%">0</div>
                                        <div class="outcome-stat-label">Timeline</div>
                                        <div class="outcome-stat-bar"><div class="bar-fill timeline" id="timelineBar"></div></div>
                                    </div>
                                    <div class="outcome-stat followup">
                                        <div class="outcome-stat-value analytics-toggleable" id="analyticsFollowUp" data-count="0" data-pct="0%">0</div>
                                        <div class="outcome-stat-label">Follow Up</div>
                                        <div class="outcome-stat-bar"><div class="bar-fill followup" id="followupBar"></div></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Other Outcomes -->
                            <div class="analytics-card-section">
                                <div class="analytics-card-header">
                                    <h3>Other Outcomes</h3>
                                </div>
                                <div class="other-outcomes-list">
                                    <div class="other-outcome-row">
                                        <span class="outcome-name">Not Interested</span>
                                        <span class="outcome-value analytics-toggleable" id="analyticsNotInterested" data-count="0" data-pct="0%">0</span>
                                    </div>
                                    <div class="other-outcome-row">
                                        <span class="outcome-name">Inconclusive</span>
                                        <span class="outcome-value analytics-toggleable" id="analyticsInconclusive" data-count="0" data-pct="0%">0</span>
                                    </div>
                                    <div class="other-outcome-row">
                                        <span class="outcome-name">No Answer</span>
                                        <span class="outcome-value analytics-toggleable" id="analyticsNoAnswer" data-count="0" data-pct="0%">0</span>
                                    </div>
                                    <div class="other-outcome-row">
                                        <span class="outcome-name">Voicemail</span>
                                        <span class="outcome-value analytics-toggleable" id="analyticsVoicemail" data-count="0" data-pct="0%">0</span>
                                    </div>
                                    <div class="other-outcome-row">
                                        <span class="outcome-name">Max Attempts</span>
                                        <span class="outcome-value analytics-toggleable" id="analyticsMaxAttempts" data-count="0" data-pct="0%">0</span>
                                    </div>
                                    <div class="other-outcome-row">
                                        <span class="outcome-name">Wrong Person</span>
                                        <span class="outcome-value analytics-toggleable" id="analyticsWrongPerson" data-count="0" data-pct="0%">0</span>
                                    </div>
                                    <div class="other-outcome-row">
                                        <span class="outcome-name">DNC</span>
                                        <span class="outcome-value analytics-toggleable" id="analyticsDNC" data-count="0" data-pct="0%">0</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Page: Import -->
                    <div class="page hidden" id="page-import">
                        <div class="contact-hero" style="margin-bottom:24px;">
                            <div class="contact-hero-inner">
                                <div class="contact-hero-text">
                                    <h2>Import Leads</h2>
                                    <p>Add new leads to your account  individually or in bulk via CSV.</p>
                                </div>
                            </div>
                        </div>

                        <!-- Import Method Tabs -->
                        <div class="import-tabs">
                            <button class="import-tab active" data-import="single">Single Lead</button>
                            <button class="import-tab" data-import="bulk">Bulk Upload</button>
                        </div>

                        <!-- Single Lead Form -->
                        <div class="import-panel active" id="importSinglePanel">
                            <div class="import-single-grid">
                                <div class="import-single-form">
                                    <div class="import-section">
                                        <div class="import-section-label">Personal Info</div>
                                        <div class="form-row">
                                            <div class="form-group">
                                                <label>First Name <span class="required">*</span></label>
                                                <input type="text" id="singleLeadFirstName" placeholder="John" class="form-input">
                                            </div>
                                            <div class="form-group">
                                                <label>Last Name</label>
                                                <input type="text" id="singleLeadLastName" placeholder="Smith" class="form-input">
                                            </div>
                                        </div>
                                        <div class="form-row">
                                            <div class="form-group">
                                                <label>Phone Number <span class="required">*</span></label>
                                                <input type="tel" id="singleLeadPhone" placeholder="(416) 555-1234" class="form-input">
                                            </div>
                                            <div class="form-group">
                                                <label>Email</label>
                                                <input type="email" id="singleLeadEmail" placeholder="john@example.com" class="form-input">
                                            </div>
                                        </div>
                                    </div>

                                    <div class="import-section">
                                        <div class="import-section-label">Lead Details</div>
                                        <div class="form-row">
                                            <div class="form-group">
                                                <label>Interest <span class="required">*</span></label>
                                                <select id="singleLeadInterest" class="form-input">
                                                    <option value="">Select interest...</option>
                                                    <option value="Buy">Buying</option>
                                                    <option value="Sell">Selling</option>
                                                    <option value="Both">Both (Buying & Selling)</option>
                                                </select>
                                            </div>
                                            <div class="form-group">
                                                <label>Max Call Attempts</label>
                                                <input type="number" id="singleLeadMaxAttempts" placeholder="5" min="1" max="10" value="5" class="form-input">
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label>Context <span style="color:rgba(255,255,255,0.4);font-weight:400;">(optional)</span></label>
                                            <textarea id="singleLeadContext" placeholder="Add any context for the AI to use when calling this lead..." class="form-input" rows="3"></textarea>
                                        </div>
                                    </div>

                                    <div class="import-section">
                                        <div class="import-section-label">Schedule First Call <span style="color:rgba(255,255,255,0.4);font-weight:400;text-transform:none;letter-spacing:0;">(optional)</span></div>
                                        <div class="form-group" style="margin-bottom:12px;">
                                            <label>Next Call Date</label>
                                            <div style="position:relative;">
                                                <button type="button" id="singleLeadCalToggle" class="form-input" style="text-align:left;cursor:pointer;display:flex;align-items:center;gap:8px;color:rgba(255,255,255,0.5);">
                                                     Pick a date
                                                </button>
                                                <div class="send-ai-calendar" id="singleLeadCalendar" style="display:none;">
                                                    <div class="calendar-header">
                                                        <button type="button" id="singleLeadCalPrev"></button>
                                                        <span class="calendar-month" id="singleLeadCalMonth"></span>
                                                        <button type="button" id="singleLeadCalNext"></button>
                                                    </div>
                                                    <div class="calendar-weekdays">
                                                        <span>Sun</span><span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span>
                                                    </div>
                                                    <div class="calendar-days" id="singleLeadCalDays"></div>
                                                </div>
                                                <input type="hidden" id="singleLeadCallDate">
                                            </div>
                                        </div>
                                        <div id="singleLeadTimeWrapper" style="display:none;">
                                            <label style="display:block;font-size:0.75rem;font-weight:400;color:#707070;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:12px;">Preferred Time of Day</label>
                                            <div class="send-ai-time-pref" id="singleLeadTimePref">
                                                <button type="button" class="time-pref-btn" data-time="Morning"> Morning</button>
                                                <button type="button" class="time-pref-btn active" data-time="Afternoon"> Afternoon</button>
                                                <button type="button" class="time-pref-btn" data-time="Evening"> Evening</button>
                                            </div>
                                        </div>
                                    </div>

                                    <div id="singleLeadStatus"></div>

                                    <button class="contact-submit-btn" id="submitSingleLeadBtn" style="margin-top:8px;">
                                        Add Lead
                                    </button>
                                </div>
                                <div class="import-single-tips">
                                    <div class="contact-info-item">
                                        <div class="contact-info-icon"></div>
                                        <div>
                                            <div class="contact-info-label">Phone Format</div>
                                            <div class="contact-info-value">10 digits  any format works (416-555-1234, 4165551234, etc.)</div>
                                        </div>
                                    </div>
                                    <div class="contact-info-item">
                                        <div class="contact-info-icon"></div>
                                        <div>
                                            <div class="contact-info-label">Max Attempts</div>
                                            <div class="contact-info-value">110 call attempts before the AI stops. Default is 5.</div>
                                        </div>
                                    </div>
                                    <div class="contact-info-item">
                                        <div class="contact-info-icon"></div>
                                        <div>
                                            <div class="contact-info-label">Context Tip</div>
                                            <div class="contact-info-value">Adding context helps Sarah personalize the call. Leave blank for default script.</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Bulk Upload -->
                        <div class="import-panel" id="importBulkPanel">
                            <div class="template-download">
                                <div class="template-info">
                                    <h4> Get the Template</h4>
                                    <p>1. Click "Get Template" to make a copy of the Google Sheet</p>
                                    <p>2. In Google Sheets, go to <strong>File  Download  Microsoft Excel (.xlsx)</strong></p>
                                    <p>3. Upload the downloaded .xlsx file below</p>
                                </div>
                                <a href="https://docs.google.com/spreadsheets/d/16VtdCtO9s93zHmpDQFIGVzmgN8-NokbCVE_rKyyI-hQ/copy" target="_blank" rel="noopener" class="btn btn-secondary" id="downloadTemplateBtn">Get Template</a>
                            </div>

                            <div class="file-upload-zone" id="fileUploadZone">
                                <input type="file" id="leadFileInput" accept=".csv,.xlsx,.xls">
                                <div class="file-upload-icon"></div>
                                <p><strong>Click to upload</strong> or drag and drop</p>
                                <p class="file-upload-supported">CSV, XLSX, or XLS (max 10MB)</p>
                            </div>

                            <div id="uploadStatus"></div>
                        </div>
                    </div>

                    <!-- Page: Search -->
                    <div class="page hidden" id="page-search">
                        <div class="search-header">
                            <h2> Search Lead</h2>
                            <p style="color:rgba(255,255,255,0.5);">Search by name or last 4 digits of phone number</p>
                        </div>
                        
                        <div class="search-box-large">
                            <input type="text" id="globalSearchInput" placeholder="Enter name or last 4 digits of phone..." class="search-input-large">
                            <button class="btn btn-primary" id="globalSearchBtn">Search</button>
                        </div>
                        
                        <!-- Multiple Results -->
                        <div id="searchMultipleResults" style="display:none;">
                            <h4 style="margin-bottom:12px;color:rgba(255,255,255,0.6);">Multiple leads found - click to view:</h4>
                            <div id="searchResultsList" class="search-results-list"></div>
                        </div>
                        
                        <!-- Single Result Detail -->
                        <div id="searchLeadDetail" style="display:none;">
                            <div class="search-lead-card">
                                <!-- Compact Header -->
                                <div class="search-lead-top">
                                    <div class="search-lead-identity">
                                        <div class="search-lead-avatar" id="searchLeadAvatar">?</div>
                                        <div class="search-lead-name-group">
                                            <div class="search-lead-name-row">
                                                <h3 id="searchLeadName">-</h3>
                                                <span id="searchLeadStatusBadge" class="status-badge">-</span>
                                                <span id="searchLeadOutcomeBadge" class="status-badge" style="display:none;">-</span>
                                            </div>
                                            <div class="search-lead-phone" id="searchLeadPhoneDisplay">-</div>
                                        </div>
                                    </div>
                                    <div class="search-lead-badges">
                                        <button class="search-action-btn share" id="searchShareBtn" onclick="shareFromSearch()"> Share</button>
                                        <button class="search-action-btn takeover" id="searchTakeOverBtn" onclick="takeOverFromSearch()"> Take Over</button>
                                        <button class="search-action-btn dnc" id="searchDNCBtn" onclick="dncFromSearch()"> DNC</button>
                                    </div>
                                </div>

                                <!-- Info Strip -->
                                <div class="search-lead-info-strip">
                                    <div class="search-info-cell">
                                        <span class="info-label">Email</span>
                                        <span class="info-value" id="searchLeadEmail">-</span>
                                    </div>
                                    <div class="search-info-cell">
                                        <span class="info-label">Total Calls</span>
                                        <span class="info-value" id="searchLeadCalls">-</span>
                                    </div>
                                    <div class="search-info-cell">
                                        <span class="info-label">Last Updated</span>
                                        <span class="info-value" id="searchLeadLastCall">-</span>
                                    </div>
                                    <div class="search-info-cell">
                                        <span class="info-label">Booked Time</span>
                                        <span class="info-value" id="searchLeadBookedTime">-</span>
                                    </div>
                                    <div class="search-info-cell">
                                        <span class="info-label">Next Call</span>
                                        <span class="info-value" id="searchLeadNextCall">-</span>
                                    </div>
                                </div>

                                <!-- Collapsible Sections -->
                                <div class="search-lead-body">
                                    <div class="search-section" id="searchSectionAICalls">
                                        <button class="search-section-toggle" onclick="toggleSearchSection('searchSectionAICalls')">
                                            <h4> AI Call History <span class="section-count" id="searchAICallsCount">0</span></h4>
                                            <span class="search-section-arrow"></span>
                                        </button>
                                        <div class="search-section-content">
                                            <div id="searchLeadAICallsList" class="search-lead-ai-calls-list">No AI calls recorded</div>
                                        </div>
                                    </div>

                                    <div class="search-section" id="searchSectionSummary">
                                        <button class="search-section-toggle" onclick="toggleSearchSection('searchSectionSummary')">
                                            <h4> AI Summary</h4>
                                            <span class="search-section-arrow"></span>
                                        </button>
                                        <div class="search-section-content">
                                            <div id="searchLeadSummary" class="search-lead-content">No summary available</div>
                                        </div>
                                    </div>

                                    <div class="search-section collapsed" id="searchSectionNotes">
                                        <button class="search-section-toggle" onclick="toggleSearchSection('searchSectionNotes')">
                                            <h4> Notes <span class="section-count" id="searchNotesCount">0</span></h4>
                                            <span class="search-section-arrow"></span>
                                        </button>
                                        <div class="search-section-content">
                                            <div id="searchLeadNotesList" class="search-lead-notes-list">No notes available</div>
                                        </div>
                                    </div>

                                    <div class="search-section collapsed" id="searchSectionAttempts">
                                        <button class="search-section-toggle" onclick="toggleSearchSection('searchSectionAttempts')">
                                            <h4> Manual Attempts <span class="section-count" id="searchAttemptsCount">0</span></h4>
                                            <span class="search-section-arrow"></span>
                                        </button>
                                        <div class="search-section-content">
                                            <div id="searchLeadAttemptsList" class="search-lead-attempts-list">No call attempts logged</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Empty State -->
                        <div id="searchEmptyState" style="display:none;text-align:center;padding:60px;color:rgba(255,255,255,0.4);">
                            <div style="font-size:3rem;margin-bottom:16px;"></div>
                            <p id="searchEmptyText">No lead found</p>
                        </div>
                    </div>

                    <!-- Page: Settings -->
                    <div class="page hidden" id="page-settings">
                        <!-- Profile Card -->
                        <div class="settings-card">
                            <div class="profile-header">
                                <div class="profile-avatar-lg" id="settingsAvatar">
                                    <span id="settingsInitial">U</span>
                                </div>
                                <div class="profile-info">
                                    <h2 id="settingsName">-</h2>
                                    <p id="settingsEmail">-</p>
                                    <div class="profile-actions">
                                        <input type="file" id="settingsPhotoInput" accept="image/*" style="display:none;">
                                        <button class="btn btn-sm btn-secondary" id="settingsUploadBtn">Upload Photo</button>
                                        <button class="btn btn-sm btn-ghost" id="settingsRemoveBtn" style="display:none;">Remove</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Display Name -->
                        <div class="settings-card">
                            <h3 class="settings-title">Display Name</h3>
                            <form id="displayNameForm">
                                <div class="form-group">
                                    <label for="settingsDisplayName">How should we greet you?</label>
                                    <input type="text" id="settingsDisplayName" placeholder="e.g. Sahib">
                                </div>
                                <div class="form-message success" id="displaySuccess"></div>
                                <div class="form-message error" id="displayError"></div>
                                <button type="submit" class="btn btn-primary">Save</button>
                            </form>
                        </div>

                        <!-- Calling Preferences -->
                        <div class="settings-card">
                            <h3 class="settings-title">Calling Preferences</h3>
                            <form id="callingPrefsForm">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="settingsPhone">Your Phone Number <span class="sync-badge"> Synced</span></label>
                                        <input type="tel" id="settingsPhone" placeholder="+1 (555) 123-4567" readonly class="input-synced">
                                    </div>
                                    <div class="form-group">
                                        <label for="settingsCalendar">Calendar Email <span class="sync-badge"> Synced</span></label>
                                        <input type="email" id="settingsCalendar" placeholder="calendar@gmail.com" readonly class="input-synced">
                                    </div>
                                </div>
                                <p class="sync-notice">Phone and email are synced from your account. Contact support to update.</p>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="settingsStart">Available Start</label>
                                        <select id="settingsStart">
                                            <option value="8:00 AM">8:00 AM</option>
                                            <option value="9:00 AM" selected>9:00 AM</option>
                                            <option value="10:00 AM">10:00 AM</option>
                                            <option value="11:00 AM">11:00 AM</option>
                                            <option value="12:00 PM">12:00 PM</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="settingsEnd">Available End</label>
                                        <select id="settingsEnd">
                                            <option value="5:00 PM">5:00 PM</option>
                                            <option value="6:00 PM" selected>6:00 PM</option>
                                            <option value="7:00 PM">7:00 PM</option>
                                            <option value="8:00 PM">8:00 PM</option>
                                            <option value="9:00 PM">9:00 PM</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-message success" id="callingSuccess"></div>
                                <div class="form-message error" id="callingError"></div>
                                <button type="submit" class="btn btn-primary">Save Changes</button>
                            </form>
                        </div>

                        <!-- Change Password -->
                        <div class="settings-card">
                            <h3 class="settings-title">Change Password</h3>
                            <form id="passwordForm">
                                <div class="form-group">
                                    <label for="currentPassword">Current Password</label>
                                    <input type="password" id="currentPassword" placeholder="Enter your current password" required>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="newPassword">New Password</label>
                                        <input type="password" id="newPassword" placeholder="Min. 8 characters" minlength="8" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="confirmNewPassword">Confirm New Password</label>
                                        <input type="password" id="confirmNewPassword" placeholder="Confirm password" minlength="8" required>
                                    </div>
                                </div>
                                <div class="form-message success" id="passwordSuccess"></div>
                                <div class="form-message error" id="passwordError"></div>
                                <button type="submit" class="btn btn-secondary">Update Password</button>
                            </form>
                        </div>

                        <!-- Danger Zone -->
                        <div class="settings-card danger">
                            <h3 class="settings-title" style="color:#ef4444;">Danger Zone</h3>
                            <p class="text-muted" style="margin-bottom:1rem;">Need to pause or cancel your subscription?</p>
                            <button class="btn btn-secondary" onclick="window.location.href='mailto:info@prioai.ca?subject=Account Change Request'">Contact Support</button>
                        </div>
                    </div>

                    <!-- Page: Billing -->
                    <div class="page hidden" id="page-billing">
                        <!-- Current Plan -->
                        <div class="settings-card">
                            <h3 class="settings-title">Current Plan</h3>
                            <div class="billing-plan-card">
                                <div class="billing-plan-header">
                                    <div class="billing-plan-info">
                                        <span class="billing-plan-name" id="billingPlanName">Starter</span>
                                        <span class="billing-status-badge active" id="billingPlanStatus">Active</span>
                                    </div>
                                    <div class="billing-plan-price">
                                        <span class="price-amount" id="billingPlanPrice">$149</span>
                                        <span class="price-period">/month</span>
                                    </div>
                                </div>
                                <div class="billing-plan-details">
                                    <div class="billing-detail">
                                        <span class="detail-label">Call Limit</span>
                                        <span class="detail-value" id="billingCallLimit">1,000 calls/mo</span>
                                    </div>
                                    <div class="billing-detail">
                                        <span class="detail-label">Next Billing</span>
                                        <span class="detail-value" id="billingNextDate">-</span>
                                    </div>
                                </div>
                                <button class="btn btn-secondary btn-sm" id="upgradePlanBtn">Upgrade Plan</button>
                            </div>
                        </div>

                        <!-- Payment Method -->
                        <div class="settings-card">
                            <h3 class="settings-title">Payment Method</h3>
                            <div class="billing-payment-card" id="billingPaymentCard">
                                <div class="payment-icon"></div>
                                <div class="payment-details">
                                    <span class="payment-brand" id="paymentCardBrand">No payment method</span>
                                    <span class="payment-number" id="paymentCardNumber">Add a card to continue</span>
                                </div>
                                <button class="btn btn-secondary btn-sm" id="updatePaymentBtn">Add Card</button>
                            </div>
                        </div>

                        <!-- Usage This Month -->
                        <div class="settings-card">
                            <h3 class="settings-title">Usage This Month</h3>
                            <div class="billing-usage">
                                <div class="usage-stats">
                                    <div class="usage-stat">
                                        <span class="usage-value" id="billingUsageCalls">0</span>
                                        <span class="usage-label">Calls Made</span>
                                    </div>
                                    <div class="usage-stat">
                                        <span class="usage-value" id="billingUsageLimit">1,000</span>
                                        <span class="usage-label">Call Limit</span>
                                    </div>
                                    <div class="usage-stat">
                                        <span class="usage-value" id="billingUsagePercent">0%</span>
                                        <span class="usage-label">Used</span>
                                    </div>
                                </div>
                                <div class="usage-bar">
                                    <div class="usage-fill" id="billingUsageFill" style="width:0%"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Billing History -->
                        <div class="settings-card">
                            <h3 class="settings-title">Billing History</h3>
                            <div class="billing-history" id="billingHistoryList">
                                <p class="text-muted" style="text-align:center;padding:24px;">No billing history yet</p>
                            </div>
                            <button class="btn btn-secondary btn-sm" id="viewAllInvoicesBtn" style="margin-top:12px;">View All Invoices</button>
                        </div>

                        <!-- Actions -->
                        <div class="settings-card">
                            <div class="billing-actions">
                                <button class="btn btn-primary" id="manageBillingBtn">Manage Subscription</button>
                                <button class="btn btn-secondary" id="downloadReceiptBtn">Download Receipt</button>
                            </div>
                            <p id="billingStatus" class="text-muted" style="margin-top:12px;font-size:0.875rem;"></p>
                        </div>
                    </div>

                    <!-- Page: Help -->
                    <div class="page hidden" id="page-help">
                        <div class="settings-card">
                            <h3 class="settings-title"> Help Center</h3>
                            <p class="text-muted" style="margin-bottom:20px;">Everything you need to know about using Prio AI.</p>

                            <!-- Search -->
                            <div class="help-search">
                                <span class="help-search-icon"></span>
                                <input type="text" id="helpSearchInput" placeholder="Search for help topics...">
                            </div>

                            <!-- Quick Links -->
                            <div class="help-quick-links">
                                <div class="help-quick-link" data-topic="getting-started"> Getting Started</div>
                                <div class="help-quick-link" data-topic="prio-leads"> Prio Prospects</div>
                                <div class="help-quick-link" data-topic="shared-leads"> Shared Leads</div>
                                <div class="help-quick-link" data-topic="overview"> Overview</div>
                                <div class="help-quick-link" data-topic="ai-pipeline"> AI Pipeline</div>
                                <div class="help-quick-link" data-topic="unqualified"> Unqualified</div>
                                <div class="help-quick-link" data-topic="importing"> Importing</div>
                            </div>
                        </div>

                        <!-- FAQ Categories -->
                        <div id="helpCategories">
                            <!-- Getting Started -->
                            <div class="help-category" data-category="getting-started">
                                <div class="help-category-header">
                                    <span class="help-category-icon"></span>
                                    <span class="help-category-title">Getting Started</span>
                                    <span class="help-category-arrow"></span>
                                </div>
                                <div class="help-category-content">
                                    <div class="help-item">
                                        <div class="help-item-header">
                                            <span class="help-question">How do I navigate the dashboard?</span>
                                            <span class="help-toggle">+</span>
                                        </div>
                                        <div class="help-answer">
                                            <p>The sidebar on the left has all your main sections:</p>
                                            <ul>
                                                <li><strong>Overview</strong>  Your daily snapshot with today's priorities and missed meetings</li>
                                                <li><strong>Prio</strong>  Priority leads needing immediate attention</li>
                                                <li><strong>Qualified</strong>  All your qualified leads in a searchable table</li>
                                                <li><strong>Booked Today</strong>  Leads the AI booked or got callbacks for today</li>
                                                <li><strong>Shared</strong>  Leads shared with you or that you've shared with others</li>
                                                <li><strong>AI Follow Ups</strong>  Leads being nurtured by AI (Timeline &amp; Follow Up)</li>
                                                <li><strong>Unqualified</strong>  Closed leads (Max Attempts, Wrong Person, DNC, Inconclusive)</li>
                                                <li><strong>Search</strong>  Find any lead by name or phone</li>
                                                <li><strong>Analytics</strong>  AI calling performance data and conversion funnels</li>
                                                <li><strong>Import Leads</strong>  Add new leads individually or via CSV</li>
                                            </ul>
                                        </div>
                                    </div>
                                    <div class="help-item">
                                        <div class="help-item-header">
                                            <span class="help-question">What do the different lead statuses mean?</span>
                                            <span class="help-toggle">+</span>
                                        </div>
                                        <div class="help-answer">
                                            <ul>
                                                <li><strong>Booked</strong>  Meeting scheduled with you</li>
                                                <li><strong>Callback</strong>  Lead wants YOU to call them</li>
                                                <li><strong>Timeline</strong>  Has a future buying timeline</li>
                                                <li><strong>Follow Up</strong>  AI is continuing to nurture</li>
                                                <li><strong>Not Interested</strong>  Declined or not a fit</li>
                                                <li><strong>Max Attempts</strong>  AI reached the maximum call attempts</li>
                                                <li><strong>Wrong Person</strong>  Not the right contact</li>
                                                <li><strong>Inconclusive</strong>  No clear outcome after calls</li>
                                                <li><strong>DNC</strong>  Do Not Call requested</li>
                                            </ul>
                                        </div>
                                    </div>
                                    <div class="help-item">
                                        <div class="help-item-header">
                                            <span class="help-question">How do I check my call usage?</span>
                                            <span class="help-toggle">+</span>
                                        </div>
                                        <div class="help-answer">
                                            <p>Your call usage is shown in the header at the top right. You can also see detailed usage in the <strong>Billing</strong> section.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Overview & Today's Priorities -->
                            <div class="help-category" data-category="overview">
                                <div class="help-category-header">
                                    <span class="help-category-icon"></span>
                                    <span class="help-category-title">Overview &amp; Today's Priorities</span>
                                    <span class="help-category-arrow"></span>
                                </div>
                                <div class="help-category-content">
                                    <div class="help-item">
                                        <div class="help-item-header">
                                            <span class="help-question">What is Today's Priorities?</span>
                                            <span class="help-toggle">+</span>
                                        </div>
                                        <div class="help-answer">
                                            <p>Today's Priorities shows all meetings and callbacks scheduled for today. Cards that have been handled (updated after the meeting time) are greyed out with a <strong>Done</strong> badge so you can focus on what's left.</p>
                                        </div>
                                    </div>
                                    <div class="help-item">
                                        <div class="help-item-header">
                                            <span class="help-question">What are Missed Meetings?</span>
                                            <span class="help-toggle">+</span>
                                        </div>
                                        <div class="help-answer">
                                            <p>Missed Meetings appear below your priorities. These are leads with a scheduled meeting in the past that was <strong>not</strong> updated after the meeting time. If you've already handled a meeting, updating the lead will remove it from the missed list.</p>
                                        </div>
                                    </div>
                                    <div class="help-item">
                                        <div class="help-item-header">
                                            <span class="help-question">What do the pipeline numbers mean?</span>
                                            <span class="help-toggle">+</span>
                                        </div>
                                        <div class="help-answer">
                                            <ul>
                                                <li><strong>Prio Prospects</strong>  Your priority-flagged leads</li>
                                                <li><strong>Scheduled Prospects</strong>  Leads with upcoming callbacks or meetings</li>
                                                <li><strong>Active Leads</strong>  Leads currently being called by AI</li>
                                                <li><strong>AI Pipeline</strong>  Leads on Timeline or Follow Up being nurtured</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- PRIO Leads -->
                            <div class="help-category" data-category="prio-leads">
                                <div class="help-category-header">
                                    <span class="help-category-icon"></span>
                                    <span class="help-category-title">Prio Prospects</span>
                                    <span class="help-category-arrow"></span>
                                </div>
                                <div class="help-category-content">
                                    <div class="help-item">
                                        <div class="help-item-header">
                                            <span class="help-question">What is a PRIO lead?</span>
                                            <span class="help-toggle">+</span>
                                        </div>
                                        <div class="help-answer">
                                            <p>PRIO (Priority) leads are your hottest opportunities. The AI automatically marks leads as PRIO when they book a meeting or request a callback. You can also manually mark any lead as PRIO.</p>
                                        </div>
                                    </div>
                                    <div class="help-item">
                                        <div class="help-item-header">
                                            <span class="help-question">How do I mark a lead as PRIO?</span>
                                            <span class="help-toggle">+</span>
                                        </div>
                                        <div class="help-answer">
                                            <p>Click on any lead to open the detail view, then click the yellow <strong> PRIO</strong> button at the top. You can also click the Prio button directly on any lead card.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Shared Leads -->
                            <div class="help-category" data-category="shared-leads">
                                <div class="help-category-header">
                                    <span class="help-category-icon"></span>
                                    <span class="help-category-title">Shared Leads</span>
                                    <span class="help-category-arrow"></span>
                                </div>
                                <div class="help-category-content">
                                    <div class="help-item">
                                        <div class="help-item-header">
                                            <span class="help-question">How do I share a lead?</span>
                                            <span class="help-toggle">+</span>
                                        </div>
                                        <div class="help-answer">
                                            <p>Click the <strong> Share</strong> button on any lead card, then select the agent you want to share with. The lead will appear in their Shared Leads section. A notification is also sent when you share.</p>
                                        </div>
                                    </div>
                                    <div class="help-item">
                                        <div class="help-item-header">
                                            <span class="help-question">How do I filter my shared leads?</span>
                                            <span class="help-toggle">+</span>
                                        </div>
                                        <div class="help-answer">
                                            <p>Use the dropdown filter at the top of the Shared Leads page:</p>
                                            <ul>
                                                <li><strong>All Shared</strong>  Shows all shared leads</li>
                                                <li><strong>Shared with Me</strong>  Leads others have shared with you</li>
                                                <li><strong>Shared with [Name]</strong>  Leads you've shared with a specific person</li>
                                            </ul>
                                        </div>
                                    </div>
                                    <div class="help-item">
                                        <div class="help-item-header">
                                            <span class="help-question">How do I stop sharing a lead?</span>
                                            <span class="help-toggle">+</span>
                                        </div>
                                        <div class="help-answer">
                                            <p>Open the lead detail view and click the shared status button. You'll see the option to <strong>Stop Sharing</strong>.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Booked Today -->
                            <div class="help-category" data-category="booked-today">
                                <div class="help-category-header">
                                    <span class="help-category-icon"></span>
                                    <span class="help-category-title">Booked Today</span>
                                    <span class="help-category-arrow"></span>
                                </div>
                                <div class="help-category-content">
                                    <div class="help-item">
                                        <div class="help-item-header">
                                            <span class="help-question">What is Booked Today?</span>
                                            <span class="help-toggle">+</span>
                                        </div>
                                        <div class="help-answer">
                                            <p>Booked Today shows leads that the AI called <strong>today</strong> and resulted in either a Booked meeting or a Callback request. Use the tabs at the top to filter by type. A <strong>B</strong> badge means Booked, and a <strong>C</strong> badge means Callback.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- AI Pipeline -->
                            <div class="help-category" data-category="ai-pipeline">
                                <div class="help-category-header">
                                    <span class="help-category-icon"></span>
                                    <span class="help-category-title">AI Pipeline</span>
                                    <span class="help-category-arrow"></span>
                                </div>
                                <div class="help-category-content">
                                    <div class="help-item">
                                        <div class="help-item-header">
                                            <span class="help-question">What is the AI Pipeline?</span>
                                            <span class="help-toggle">+</span>
                                        </div>
                                        <div class="help-answer">
                                            <p>The AI Pipeline (AI Follow Ups) shows leads being automatically nurtured by Sarah (our AI). These are leads with status "Timeline" or "Follow Up" who aren't ready to meet yet but are being kept warm.</p>
                                        </div>
                                    </div>
                                    <div class="help-item">
                                        <div class="help-item-header">
                                            <span class="help-question">How do I send a lead back to the AI?</span>
                                            <span class="help-toggle">+</span>
                                        </div>
                                        <div class="help-answer">
                                            <p>Open the lead detail view and click <strong> Send to AI</strong>. You can also click the Send to AI button directly on any lead card. Add notes first so the AI has context!</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Unqualified Leads -->
                            <div class="help-category" data-category="unqualified">
                                <div class="help-category-header">
                                    <span class="help-category-icon"></span>
                                    <span class="help-category-title">Unqualified Leads</span>
                                    <span class="help-category-arrow"></span>
                                </div>
                                <div class="help-category-content">
                                    <div class="help-item">
                                        <div class="help-item-header">
                                            <span class="help-question">What are Unqualified leads?</span>
                                            <span class="help-toggle">+</span>
                                        </div>
                                        <div class="help-answer">
                                            <p>Unqualified leads are those that the AI has closed out. They fall into four categories: <strong>Max Attempts</strong>, <strong>Wrong Person</strong>, <strong>DNC</strong> (Do Not Call), and <strong>Inconclusive</strong>. Use the tabs to filter by category.</p>
                                        </div>
                                    </div>
                                    <div class="help-item">
                                        <div class="help-item-header">
                                            <span class="help-question">Can I change the call date for unqualified leads?</span>
                                            <span class="help-toggle">+</span>
                                        </div>
                                        <div class="help-answer">
                                            <p>Only <strong>Max Attempts</strong> and <strong>Inconclusive</strong> leads can have their call date changed. The Change Call Date button is disabled for Wrong Person and DNC leads since those should not be called again.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Analytics -->
                            <div class="help-category" data-category="analytics">
                                <div class="help-category-header">
                                    <span class="help-category-icon"></span>
                                    <span class="help-category-title">Analytics</span>
                                    <span class="help-category-arrow"></span>
                                </div>
                                <div class="help-category-content">
                                    <div class="help-item">
                                        <div class="help-item-header">
                                            <span class="help-question">How do I view my analytics?</span>
                                            <span class="help-toggle">+</span>
                                        </div>
                                        <div class="help-answer">
                                            <p>Go to <strong>Analytics</strong> under Tools. You can view data by Day, Week, Month, or All Time. Toggle between Calls Data and Leads Data using the buttons at the top. Use the date navigation arrows to browse different dates.</p>
                                        </div>
                                    </div>
                                    <div class="help-item">
                                        <div class="help-item-header">
                                            <span class="help-question">What does the conversion funnel show?</span>
                                            <span class="help-toggle">+</span>
                                        </div>
                                        <div class="help-answer">
                                            <p>The funnel shows how many AI calls converted at each stage: Calls Made &rarr; Conversations &rarr; Qualified &rarr; Booked/Callback. You can toggle between raw numbers (#) and percentages (%) using the view toggle.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Importing -->
                            <div class="help-category" data-category="importing">
                                <div class="help-category-header">
                                    <span class="help-category-icon"></span>
                                    <span class="help-category-title">Importing Leads</span>
                                    <span class="help-category-arrow"></span>
                                </div>
                                <div class="help-category-content">
                                    <div class="help-item">
                                        <div class="help-item-header">
                                            <span class="help-question">How do I add leads?</span>
                                            <span class="help-toggle">+</span>
                                        </div>
                                        <div class="help-answer">
                                            <p>Go to the <strong>Import Leads</strong> section. You can add a single lead manually or upload a CSV file for bulk import.</p>
                                        </div>
                                    </div>
                                    <div class="help-item">
                                        <div class="help-item-header">
                                            <span class="help-question">What CSV format should I use?</span>
                                            <span class="help-toggle">+</span>
                                        </div>
                                        <div class="help-answer">
                                            <p>Get the Google Sheet template from the Import page, then download it as an .xlsx file. Required columns: First Name, Phone. Optional: Last Name, Email.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Troubleshooting -->
                            <div class="help-category" data-category="troubleshooting">
                                <div class="help-category-header">
                                    <span class="help-category-icon"></span>
                                    <span class="help-category-title">Troubleshooting</span>
                                    <span class="help-category-arrow"></span>
                                </div>
                                <div class="help-category-content">
                                    <div class="help-item">
                                        <div class="help-item-header">
                                            <span class="help-question">My lead isn't showing up?</span>
                                            <span class="help-toggle">+</span>
                                        </div>
                                        <div class="help-answer">
                                            <p>Check your filters! Make sure you're not filtering by a status that excludes them. Use the <strong>Search</strong> tab to find any lead by name or phone.</p>
                                        </div>
                                    </div>
                                    <div class="help-item">
                                        <div class="help-item-header">
                                            <span class="help-question">How do I contact support?</span>
                                            <span class="help-toggle">+</span>
                                        </div>
                                        <div class="help-answer">
                                            <p>Use the <strong>Contact Us</strong> page to send us a message. You can report bugs, request features, ask questions, or share any feedback.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Contact Support -->
                        <div class="settings-card" style="margin-top:24px;">
                            <div class="help-support">
                                <span class="help-support-icon"></span>
                                <div>
                                    <h4>Still need help?</h4>
                                    <p class="text-muted">Our team is here to support you</p>
                                </div>
                            </div>
                            <div class="help-support-actions">
                                <button class="btn btn-primary" onclick="switchPage('feedback')"> Contact Us</button>
                            </div>
                        </div>
                    </div>

                    <!-- Page: Contact Us -->
                    <div class="page hidden" id="page-feedback">
                        <div class="contact-hero">
                            <div class="contact-hero-inner">
                                <div class="contact-hero-text">
                                    <h2>Get in Touch</h2>
                                    <p>Have a question, idea, or issue? We'd love to hear from you.</p>
                                </div>
                            </div>
                        </div>
                        <div class="contact-grid">
                            <div class="contact-card-info">
                                <div class="contact-info-item">
                                    <div class="contact-info-icon"></div>
                                    <div>
                                        <div class="contact-info-label">Email</div>
                                        <a href="mailto:info@prioai.ca" class="contact-info-value">info@prioai.ca</a>
                                    </div>
                                </div>
                                <div class="contact-info-item">
                                    <div class="contact-info-icon"></div>
                                    <div>
                                        <div class="contact-info-label">Response Time</div>
                                        <div class="contact-info-value">Within 24 hours</div>
                                    </div>
                                </div>
                            </div>
                            <div class="contact-card-form">
                                <form id="feedbackForm" class="contact-form">
                                    <div class="contact-form-group">
                                        <label class="contact-form-label">What can we help with?</label>
                                        <div class="contact-category-chips">
                                            <label class="contact-chip"><input type="radio" name="feedbackCat" value="bug"><span>Bug Report</span></label>
                                            <label class="contact-chip"><input type="radio" name="feedbackCat" value="feature"><span>Feature Request</span></label>
                                            <label class="contact-chip"><input type="radio" name="feedbackCat" value="question"><span>Question</span></label>
                                            <label class="contact-chip"><input type="radio" name="feedbackCat" value="improvement"><span>Improvement</span></label>
                                            <label class="contact-chip"><input type="radio" name="feedbackCat" value="other"><span>Other</span></label>
                                        </div>
                                        <input type="hidden" id="feedbackCategory" required>
                                    </div>
                                    <div class="contact-form-group">
                                        <label class="contact-form-label">Your Message</label>
                                        <textarea id="feedbackMessage" class="contact-textarea" rows="5" placeholder="Describe your issue, idea, or question..." required></textarea>
                                    </div>
                                    <button type="submit" class="contact-submit-btn" id="feedbackSubmitBtn">
                                        <span id="feedbackBtnText">Send Message</span>
                                        <span id="feedbackBtnLoading" style="display:none;">Sending...</span>
                                    </button>
                                    <div id="feedbackSuccess" class="contact-success" style="display:none;">
                                        <span style="font-size:2rem;"></span>
                                        <p>Thank you! We'll get back to you shortly.</p>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Page: Lead Gen -->
                    <div class="page hidden" id="page-leadgen">
                        <div class="leadgen-hero">
                            <h2>Lead Generation Service</h2>
                            <p>Let Prio AI source high-quality leads for you. We handle the prospecting so you can focus on closing.</p>
                        </div>
                        <div class="leadgen-pricing">
                            <div class="leadgen-card">
                                <div class="leadgen-card-header">
                                    <h3>Lead Gen Package</h3>
                                    <div class="leadgen-price">$300</div>
                                    <div class="leadgen-price-sub">20 qualified leads</div>
                                </div>
                                <div class="leadgen-card-body">
                                    <ul class="leadgen-breakdown">
                                        <li><span class="li-icon"></span><div><strong>20 Verified Leads</strong>  Contact-verified prospects matched to your ideal customer profile</div></li>
                                        <li><span class="li-icon"></span><div><strong>$15 per Lead</strong>  Transparent flat-rate pricing with no hidden fees</div></li>
                                        <li><span class="li-icon"></span><div><strong>Targeted Sourcing</strong>  Leads are filtered by industry, location, and criteria you define</div></li>
                                        <li><span class="li-icon"></span><div><strong>Direct Import</strong>  Leads are delivered straight into your Prio AI dashboard</div></li>
                                        <li><span class="li-icon"></span><div><strong>AI-Ready</strong>  Each lead is formatted and ready for Sarah to start calling immediately</div></li>
                                        <li><span class="li-icon"></span><div><strong>Delivery in 4872 Hours</strong>  Fast turnaround so your pipeline stays full</div></li>
                                    </ul>
                                    <button class="leadgen-cta" disabled style="opacity:0.4;cursor:not-allowed;background:rgba(255,255,255,0.15);color:rgba(255,255,255,0.5);">Coming Soon</button>
                                    <p class="leadgen-note">This service is launching soon  stay tuned.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Lead Detail Modal -->
    <div class="modal-overlay" id="leadModal">
        <button class="modal-nav-arrow modal-nav-prev" id="modalNavPrev" title="Previous lead"></button>
        <button class="modal-nav-arrow modal-nav-next" id="modalNavNext" title="Next lead"></button>
        <div class="modal lead-modal">
            <div class="lead-modal-header">
                <div class="lead-modal-title">
                    <div class="modal-name-row">
                        <img src="/assets/favicon.png" class="modal-prio-icon" id="modalPrioIcon" style="display:none;">
                        <h2 id="modalLeadName">Lead Name</h2>
                    </div>
                    <div class="lead-modal-actions">
                        <button class="btn-share" id="modalShareBtn" title="Share with another agent">
                             Share
                        </button>
                        <button class="btn-prio-toggle" id="modalPrioBtn" title="Toggle PRIO status">
                             PRIO
                        </button>
                        <button class="btn-send-back" id="modalSendBackBtn">
                             Send to AI
                        </button>
                        <button class="btn-takeover-modal" id="modalTakeOverBtn" style="display:none;">
                             Take Over
                        </button>
                        <button class="btn-dnc" id="modalDNCBtn" title="Mark as Do Not Call">
                             DNC
                        </button>
                    </div>
                </div>
                <button class="modal-close" id="leadModalClose">&times;</button>
            </div>
            <div class="lead-modal-body">
                <div class="lead-info-grid">
                    <div class="lead-info-item">
                        <label> Phone</label>
                        <div class="value" id="modalPhone">-</div>
                    </div>
                    <div class="lead-info-item">
                        <label> Status</label>
                        <div class="value">
                            <div class="custom-status-dropdown" id="statusDropdownWrapper">
                                <button type="button" class="status-dropdown-trigger" id="statusDropdownTrigger" onclick="toggleStatusDropdown()">
                                    <span class="status-dot" id="statusDot"></span>
                                    <span id="statusDropdownLabel">New Lead</span>
                                    <svg class="status-chevron" width="12" height="12" viewBox="0 0 12 12" fill="none"><path d="M3 4.5L6 7.5L9 4.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                                </button>
                                <div class="status-dropdown-menu" id="statusDropdownMenu"></div>
                            </div>
                            <select id="modalStatusSelect" style="display:none;">
                                <option value="Booked">Meeting Booked</option>
                                <option value="Retry">Retrying</option>
                                <option value="Callback Rescheduled">Callback Rescheduled</option>
                                <option value="Meeting in Person">Meeting in Person</option>
                                <option value="Sending Listings">Sending Listings</option>
                                <option value="Listings Sent">Listings Sent</option>
                                <option value="Scheduling Showings">Scheduling Showings</option>
                                <option value="Viewed Properties">Viewed Properties</option>
                                <option value="Offer Placed">Offer Placed</option>
                                <option value="Deal Closed">Deal Closed</option>
                            </select>
                        </div>
                    </div>
                    <div class="lead-info-item">
                        <label> Last Updated</label>
                        <div class="value" id="modalLastCalled">-</div>
                    </div>
                    <div class="lead-info-item">
                        <label> Booked Time</label>
                        <div class="value" id="modalBookedTime">
                            <span id="modalBookedTimeValue">-</span>
                            <button class="btn-schedule" id="modalScheduleBtn" style="display:none;"> Schedule</button>
                        </div>
                    </div>
                </div>

                <div class="lead-section" id="aiSummarySection">
                    <h3 style="display:flex;align-items:center;gap:8px;"> AI Summary <span id="modalAICallDate" class="ai-date-pill" style="white-space:nowrap;"></span><span id="modalAIStatusBadge" style="display:none;"></span></h3>
                    <div class="lead-summary-content" id="modalSummary">No summary available</div>
                </div>

                <div class="lead-section">
                    <h3> Your Notes</h3>
                    <div class="lead-notes-list" id="modalNotesList"></div>
                    <div class="notes-input-container">
                        <textarea id="modalNotesInput" placeholder="Add a note about this lead..."></textarea>
                        <div class="notes-action-row">
                            <button id="voiceInputBtn" class="voice-input-btn" title="Voice to text">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>
                            </button>
                            <button id="polishNotesBtn" class="polish-notes-btn" title="Polish with AI"> Polish & Save</button>
                            <button class="btn btn-primary" id="modalSaveNoteBtn"> Save</button>
                        </div>
                    </div>
                </div>

                <div class="lead-section" id="callAttemptsSection">
                    <h3> Call Attempts <span class="attempts-count" id="modalAttemptsCount">0</span></h3>
                    <div class="lead-attempts-list" id="modalAttemptsList"></div>
                    <button class="btn btn-secondary btn-sm" id="modalLogAttemptBtn" style="width:100%;margin-top:8px;">+ Log Call Attempt</button>
                </div>

                <div class="lead-section">
                    <h3> Transcript</h3>
                    <div class="lead-transcript" id="modalTranscript">No transcript available</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Polish Preview Modal -->
    <div class="polish-preview-modal" id="polishPreviewModal">
        <div class="polish-preview-content">
            <h3> Polished Note Preview</h3>
            <div class="polish-comparison">
                <div class="polish-box">
                    <div class="polish-box-label">Original</div>
                    <div class="polish-box-text" id="polishOriginalText"></div>
                </div>
                <div class="polish-box">
                    <div class="polish-box-label">Polished</div>
                    <div class="polish-box-text" id="polishNewText"></div>
                </div>
            </div>
            <div class="polish-actions">
                <button class="polish-reject" id="polishRejectBtn">Cancel</button>
                <button class="polish-accept" id="polishAcceptBtn">Use Polished</button>
            </div>
        </div>
    </div>
    
    <!-- Share Lead Popup -->
    <div class="share-popup-overlay" id="sharePopupOverlay"></div>
    <div class="share-popup" id="shareLeadPopup">
        <div class="share-popup-header">
            <h4>Share Prospect With</h4>
            <button class="share-popup-close" id="sharePopupClose">&times;</button>
        </div>
        <div class="share-popup-agents" id="shareAgentsList"></div>
        <div class="share-popup-actions">
            <button class="btn-share-cancel" id="sharePopupCancel">Cancel</button>
            <button class="btn-share-confirm" id="sharePopupConfirm" disabled>Share</button>
        </div>
    </div>
    
    <!-- Share Info Popup -->
    <div class="share-popup" id="shareInfoPopup">
        <div class="share-popup-header">
            <h4 id="shareInfoTitle">Shared Prospect</h4>
            <button class="share-popup-close" id="shareInfoClose">&times;</button>
        </div>
        <div class="share-info-content" id="shareInfoContent"></div>
        <div class="share-popup-actions" id="shareInfoActions" style="display:none;">
            <button class="btn-share-cancel" id="stopSharingBtn" style="background:rgba(239,68,68,0.15);color:#ef4444;border-color:rgba(239,68,68,0.3);">Stop Sharing</button>
        </div>
    </div>

    <!-- Send to AI Modal -->
    <div class="send-ai-modal-overlay" id="sendAIModal">
        <div class="send-ai-modal">
            <h3> Send Back to AI</h3>
            <p class="send-ai-subtitle">Why are you sending this lead back?</p>

            <div class="send-ai-section">
                <label class="send-ai-label">REASON</label>
                <div class="send-ai-reasons" id="sendAIReasons">
                    <button class="reason-btn" data-reason="No longer interested"> No longer interested</button>
                    <button class="reason-btn" data-reason="Did not pick up"> Did not pick up</button>
                    <button class="reason-btn" data-reason="Stopped responding"> Stopped responding</button>
                    <button class="reason-btn" data-reason="other"> Other</button>
                </div>
                <textarea id="sendAIOtherReason" class="send-ai-other-input" placeholder="Enter your reason..." style="display:none;"></textarea>
            </div>

            <div class="send-ai-section">
                <label class="send-ai-label">WHEN SHOULD AI CALL BACK?</label>
                <div class="send-ai-timing" id="sendAITiming">
                    <button class="timing-btn" data-months="3">3 months</button>
                    <button class="timing-btn" data-months="6">6 months</button>
                    <button class="timing-btn" data-months="9">9 months</button>
                    <button class="timing-btn" data-months="12">12 months</button>
                    <button class="timing-btn" data-months="custom"> Pick a date</button>
                </div>
                <div class="send-ai-calendar" id="sendAICalendar" style="display:none;">
                    <div class="calendar-header">
                        <button type="button" id="sendAICalPrev"></button>
                        <span class="calendar-month" id="sendAICalMonth"></span>
                        <button type="button" id="sendAICalNext"></button>
                    </div>
                    <div class="calendar-weekdays">
                        <span>Sun</span><span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span>
                    </div>
                    <div class="calendar-days" id="sendAICalDays"></div>
                </div>
                <input type="hidden" id="sendAICustomDate">
            </div>

            <div class="send-ai-section">
                <label class="send-ai-label">PREFERRED TIME OF DAY</label>
                <div class="send-ai-time-pref" id="sendAITimePref">
                    <button class="time-pref-btn" data-time="Morning"> Morning</button>
                    <button class="time-pref-btn active" data-time="Afternoon"> Afternoon</button>
                    <button class="time-pref-btn" data-time="Evening"> Evening</button>
                </div>
            </div>

            <div class="send-ai-actions">
                <button class="send-ai-cancel" id="sendAICancelBtn">Cancel</button>
                <button class="send-ai-confirm" id="sendAIConfirmBtn">Send to AI</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="confirm-modal-overlay" id="confirmModal">
        <div class="confirm-modal">
            <div class="confirm-modal-icon" id="confirmModalIcon"></div>
            <h3 id="confirmModalTitle">Confirm Action</h3>
            <p id="confirmModalMessage">Are you sure you want to proceed?</p>
            <div class="confirm-modal-actions">
                <button class="confirm-modal-cancel" id="confirmModalCancel">Cancel</button>
                <button class="confirm-modal-confirm" id="confirmModalConfirm">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Call Detail Modal -->
    <div class="call-detail-modal" id="callDetailModal">
        <div class="call-detail-content">
            <div class="call-detail-header">
                <h3> Call Details</h3>
                <button class="call-detail-close" onclick="closeCallDetailModal()">&times;</button>
            </div>
            <div class="call-detail-body">
                <div class="call-detail-grid">
                    <div class="call-detail-stat">
                        <div class="call-detail-stat-value" id="callDetailDuration">-</div>
                        <div class="call-detail-stat-label">Duration</div>
                    </div>
                    <div class="call-detail-stat">
                        <div class="call-detail-stat-value" id="callDetailOutcome">-</div>
                        <div class="call-detail-stat-label">Outcome</div>
                    </div>
                    <div class="call-detail-stat">
                        <div class="call-detail-stat-value" id="callDetailDate">-</div>
                        <div class="call-detail-stat-label">Date</div>
                    </div>
                </div>
                <div class="call-detail-section">
                    <h4> Full Transcript</h4>
                    <div class="call-detail-transcript" id="callDetailTranscript">No transcript available</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Schedule Booking Modal -->
    <div class="schedule-modal-overlay" id="scheduleModal">
        <div class="schedule-modal">
            <h3> Schedule Meeting</h3>
            <p id="scheduleLeadName" style="color:rgba(255,255,255,0.6);margin-bottom:16px;font-size:0.875rem;"></p>
            
            <div class="form-group">
                <label>Select Date</label>
                <div class="calendar-picker" id="calendarPicker">
                    <div class="calendar-header">
                        <button id="calendarPrev"></button>
                        <span class="calendar-month" id="calendarMonth"></span>
                        <button id="calendarNext"></button>
                    </div>
                    <div class="calendar-weekdays">
                        <span>Sun</span><span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span>
                    </div>
                    <div class="calendar-days" id="calendarDays"></div>
                </div>
            </div>
            
            <div class="form-group">
                <label>Select Time</label>
                <div style="display:flex;gap:12px;align-items:center;">
                    <select id="scheduleHour" style="flex:1;padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);background:#111;color:#fff;font-size:1rem;">
                        <option value="9">9 AM</option>
                        <option value="10">10 AM</option>
                        <option value="11">11 AM</option>
                        <option value="12">12 PM</option>
                        <option value="13">1 PM</option>
                        <option value="14">2 PM</option>
                        <option value="15">3 PM</option>
                        <option value="16">4 PM</option>
                        <option value="17">5 PM</option>
                        <option value="18">6 PM</option>
                        <option value="19">7 PM</option>
                        <option value="20">8 PM</option>
                    </select>
                    <span style="color:rgba(255,255,255,0.5);">:</span>
                    <select id="scheduleMinute" style="flex:1;padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);background:#111;color:#fff;font-size:1rem;">
                        <option value="0">00</option>
                        <option value="15">15</option>
                        <option value="30">30</option>
                        <option value="45">45</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group">
                <label>Note <span style="color:rgba(255,255,255,0.3);font-weight:400;">(optional  syncs to calendar)</span></label>
                <textarea id="scheduleNote" placeholder="Add a note for this meeting..." style="width:100%;padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);background:#111;color:#fff;font-size:0.875rem;font-family:inherit;resize:vertical;min-height:60px;max-height:120px;"></textarea>
            </div>

            <div class="schedule-modal-actions">
                <button class="btn-cancel" id="scheduleCancelBtn">Cancel</button>
                <button class="btn-save" id="scheduleSaveBtn">Save Booking</button>
            </div>
            <p style="text-align:center;font-size:0.75rem;color:rgba(255,255,255,0.4);margin-top:12px;">
                 Event will be automatically added to Google Calendar
            </p>
        </div>
    </div>

    <!-- Auth Modal -->
    <div class="modal-overlay" id="authModal">
        <div class="modal">
            <button class="modal-close" id="authModalClose">&times;</button>
            <div class="modal-content">
                <div class="modal-header">
                    <img src="/assets/logo_white.png" alt="Prio AI" class="modal-logo logo-dark">
                    <img src="/assets/logo_black.png" alt="Prio AI" class="modal-logo logo-light" style="display:none;">
                    <h2 id="authTitle">Welcome to Prio AI</h2>
                    <p id="authSubtitle">Sign in to your account</p>
                </div>

                <!-- Login Form -->
                <form id="loginForm">
                    <div class="form-group">
                        <label for="loginEmail">Email</label>
                        <input type="email" id="loginEmail" placeholder="you@example.com" required>
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" placeholder="" required>
                    </div>
                    <div class="form-error" id="loginError"></div>
                    <button type="submit" class="btn btn-primary btn-block btn-lg" id="loginSubmit">Sign In</button>
                </form>

                <!-- Signup Form (hidden by default) -->
                <form id="signupForm" class="hidden">
                    <div class="form-group">
                        <label for="signupName">Full Name</label>
                        <input type="text" id="signupName" placeholder="John Smith" required>
                    </div>
                    <div class="form-group">
                        <label for="signupEmail">Email</label>
                        <input type="email" id="signupEmail" placeholder="you@example.com" required>
                    </div>
                    <div class="form-group">
                        <label for="signupPassword">Password</label>
                        <input type="password" id="signupPassword" placeholder="Min. 8 characters" required minlength="8">
                    </div>
                    <div class="form-error" id="signupError"></div>
                    <div class="form-success" id="signupSuccess"></div>
                    <button type="submit" class="btn btn-primary btn-block btn-lg" id="signupSubmit">Create Account</button>
                </form>

                <div class="auth-divider"><span>or</span></div>

                <button class="btn btn-google btn-block" id="googleAuthBtn">
                    <svg viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                    Continue with Google
                </button>

                <div class="auth-footer">
                    <p id="authSwitch">Don't have an account? <a href="#" id="switchToSignup">Sign up</a></p>
                    <p style="margin-top: var(--space-2);"><a href="#" id="forgotPassword">Forgot password?</a></p>
                </div>
            </div>
        </div>
    </div>

<!-- User modal removed - using sidebar profile popup instead -->

    <!-- Image Crop Modal -->
    <div class="crop-modal" id="cropModal">
        <div class="crop-modal-content">
            <div class="crop-modal-header">
                <h3>Crop Profile Picture</h3>
                <button class="crop-modal-close" id="cropModalClose">&times;</button>
            </div>
            <div class="crop-container">
                <img id="cropImage" src="" alt="Crop preview">
            </div>
            <div class="crop-controls">
                <span class="crop-zoom-label">Zoom</span>
                <input type="range" class="crop-zoom-slider" id="cropZoom" min="0.1" max="3" step="0.1" value="1">
            </div>
            <div class="crop-actions">
                <button class="crop-btn crop-btn-cancel" id="cropCancel">Cancel</button>
                <button class="crop-btn crop-btn-confirm" id="cropConfirm">Save Photo</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
    <script>
    // Register Service Worker
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js').then(function(reg) {
            console.log('SW registered, scope:', reg.scope);
        }).catch(function(err) {
            console.log('SW registration failed:', err);
        });
    }

    // Supabase Setup
    var SUPABASE_URL = "https://bflmikgoafdffezrfpgb.supabase.co";
    var SUPABASE_KEY = "sb_publishable_e4DbIJ2T-9QAMtXzYo4o8Q_x135R40k";
    var supabase;
    try {
        if (!window.supabase || !window.supabase.createClient) {
            throw new Error('Supabase SDK failed to load');
        }
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    } catch (e) {
        console.error('Supabase initialization failed:', e);
        window.__showErrorFallback();
    }

    // State
    var currentUser = null;
    var currentPage = 'overview';

    // Elements
    var sidebar = document.getElementById('sidebar');
    var sidebarOverlay = document.getElementById('sidebarOverlay');
    var authModal = document.getElementById('authModal');
    // userModal removed
    var loginForm = document.getElementById('loginForm');
    var signupForm = document.getElementById('signupForm');

    // Toast
    function showToast(message, type) {
        var toast = document.createElement('div');
        toast.className = 'toast ' + (type || '');
        toast.textContent = message;
        document.getElementById('toastContainer').appendChild(toast);
        setTimeout(function() { toast.remove(); }, 4000);
    }

    // Custom Confirmation Modal
    var confirmResolve = null;
    function showConfirmModal(title, message, icon, isDestructive, confirmLabel, cancelLabel) {
        return new Promise(function(resolve) {
            confirmResolve = resolve;
            document.getElementById('confirmModalIcon').textContent = icon || '';
            document.getElementById('confirmModalTitle').textContent = title;
            document.getElementById('confirmModalMessage').textContent = message;
            var confirmBtn = document.getElementById('confirmModalConfirm');
            var cancelBtn = document.getElementById('confirmModalCancel');
            confirmBtn.className = 'confirm-modal-confirm' + (isDestructive === false ? ' success' : '');
            confirmBtn.textContent = confirmLabel || (isDestructive === false ? 'Confirm' : 'Yes, proceed');
            cancelBtn.textContent = cancelLabel || 'Cancel';
            document.getElementById('confirmModal').classList.add('active');
            // Focus on cancel button (safer default)
            setTimeout(function() { cancelBtn.focus(); }, 50);
        });
    }

    document.getElementById('confirmModalCancel').addEventListener('click', function() {
        document.getElementById('confirmModal').classList.remove('active');
        if (confirmResolve) confirmResolve(false);
    });

    document.getElementById('confirmModalConfirm').addEventListener('click', function() {
        document.getElementById('confirmModal').classList.remove('active');
        if (confirmResolve) confirmResolve(true);
    });

    document.getElementById('confirmModal').addEventListener('click', function(e) {
        if (e.target === this) {
            this.classList.remove('active');
            if (confirmResolve) confirmResolve(false);
        }
    });

    // Set dark theme
    (function() {
        document.documentElement.setAttribute('data-theme', 'dark');
        document.querySelectorAll('.logo-dark').forEach(function(el) { el.style.display = 'block'; });
        document.querySelectorAll('.logo-light').forEach(function(el) { el.style.display = 'none'; });
    })();

    // Sidebar Toggle (mobile)
    document.getElementById('menuToggle').addEventListener('click', function() {
        sidebar.classList.add('open');
        sidebarOverlay.classList.add('active');
    });
    
    document.getElementById('sidebarClose').addEventListener('click', closeSidebar);
    sidebarOverlay.addEventListener('click', closeSidebar);
    
    function closeSidebar() {
        sidebar.classList.remove('open');
        sidebarOverlay.classList.remove('active');
    }

    // Sidebar Collapse/Expand (desktop)
    var sidebarCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
    var collapseBtn = document.getElementById('sidebarCollapseBtn');
    var appContainer = document.getElementById('appContainer');

    function updateSidebarState() {
        if (sidebarCollapsed) {
            sidebar.classList.add('collapsed');
            appContainer.classList.add('sidebar-collapsed');
            sidebar.style.width = '';
            document.querySelector('.main-content').style.marginLeft = '';
            collapseBtn.innerHTML = '';
            collapseBtn.title = 'Expand sidebar';
        } else {
            sidebar.classList.remove('collapsed');
            appContainer.classList.remove('sidebar-collapsed');
            var savedWidth = localStorage.getItem('sidebarWidth');
            if (savedWidth) {
                sidebar.style.width = savedWidth + 'px';
                document.querySelector('.main-content').style.marginLeft = savedWidth + 'px';
            } else {
                sidebar.style.width = '';
                document.querySelector('.main-content').style.marginLeft = '';
            }
            collapseBtn.innerHTML = '';
            collapseBtn.title = 'Collapse sidebar';
        }
    }

    // Initialize collapsed state
    updateSidebarState();

    collapseBtn.addEventListener('click', function() {
        sidebarCollapsed = !sidebarCollapsed;
        localStorage.setItem('sidebarCollapsed', sidebarCollapsed);
        updateSidebarState();
    });

    // Sidebar Resize Functionality
    var resizeHandle = document.getElementById('sidebarResizeHandle');
    var isResizing = false;
    var savedSidebarWidth = localStorage.getItem('sidebarWidth');
    if (savedSidebarWidth && !sidebarCollapsed) {
        sidebar.style.width = savedSidebarWidth + 'px';
        document.querySelector('.main-content').style.marginLeft = savedSidebarWidth + 'px';
    }

    resizeHandle.addEventListener('mousedown', function(e) {
        if (sidebarCollapsed) return;
        isResizing = true;
        resizeHandle.classList.add('active');
        document.body.style.cursor = 'ew-resize';
        document.body.style.userSelect = 'none';
        e.preventDefault();
    });

    document.addEventListener('mousemove', function(e) {
        if (!isResizing) return;
        var newWidth = Math.min(Math.max(e.clientX, 180), 400);
        sidebar.style.width = newWidth + 'px';
        document.querySelector('.main-content').style.marginLeft = newWidth + 'px';
    });

    document.addEventListener('mouseup', function() {
        if (isResizing) {
            isResizing = false;
            resizeHandle.classList.remove('active');
            document.body.style.cursor = '';
            document.body.style.userSelect = '';
            var currentWidth = parseInt(sidebar.style.width);
            if (currentWidth) {
                localStorage.setItem('sidebarWidth', currentWidth);
            }
        }
    });

    // Navigation
    document.querySelectorAll('.nav-item[data-page]').forEach(function(item) {
        item.addEventListener('click', function() {
            switchPage(this.dataset.page);
            closeSidebar();
        });
    });

    // Collapsible Nav Sections
    document.querySelectorAll('.nav-section-toggle').forEach(function(toggle) {
        toggle.addEventListener('click', function() {
            var section = this.closest('.nav-section-collapsible');
            if (section) {
                section.classList.toggle('collapsed');
                // Save collapsed state
                var sectionId = section.id;
                var isCollapsed = section.classList.contains('collapsed');
                localStorage.setItem('nav-' + sectionId, isCollapsed);
            }
        });
    });

    // Restore collapsed state from localStorage
    document.querySelectorAll('.nav-section-collapsible').forEach(function(section) {
        var sectionId = section.id;
        var wasCollapsed = localStorage.getItem('nav-' + sectionId) === 'true';
        if (wasCollapsed) {
            section.classList.add('collapsed');
        }
    });

    function switchPage(page) {
        currentPage = page;
        
        // Update nav
        document.querySelectorAll('.nav-item').forEach(function(item) {
            item.classList.toggle('active', item.dataset.page === page);
        });
        
        // Update title
        var titles = {
            overview: 'Overview', prio: 'Prio', prospects: 'Qualified', pipeline: 'AI Follow Ups',
            unqualified: 'Unqualified', shared: 'Shared', analytics: 'Analytics',
            import: 'Import Leads', search: 'Search', settings: 'Settings', billing: 'Billing', help: 'Help',
            feedback: 'Contact Us', leadgen: 'Lead Gen', 'booked-today': 'Booked Today', 'open-leads': 'Open Leads'
        };
        document.getElementById('pageTitle').textContent = titles[page] || page;
        
        // Show page
        document.querySelectorAll('.page').forEach(function(p) { p.classList.add('hidden'); });
        var pageEl = document.getElementById('page-' + page);
        if (pageEl) pageEl.classList.remove('hidden');
        
        // Update hash
        window.location.hash = page;
    }

    // Auth Modal
    function openAuthModal(mode) {
        authModal.classList.add('active');
        if (mode === 'signup') {
            loginForm.classList.add('hidden');
            signupForm.classList.remove('hidden');
            document.getElementById('authTitle').textContent = 'Create Account';
            document.getElementById('authSubtitle').textContent = 'Start converting more leads';
            document.getElementById('authSwitch').innerHTML = 'Already have an account? <a href="#" id="switchToLogin">Sign in</a>';
            document.getElementById('switchToLogin').addEventListener('click', function(e) { e.preventDefault(); openAuthModal('login'); });
        } else {
            signupForm.classList.add('hidden');
            loginForm.classList.remove('hidden');
            document.getElementById('authTitle').textContent = 'Welcome to Prio AI';
            document.getElementById('authSubtitle').textContent = 'Sign in to your account';
            document.getElementById('authSwitch').innerHTML = "Don't have an account? <a href=\"#\" id=\"switchToSignup\">Sign up</a>";
            document.getElementById('switchToSignup').addEventListener('click', function(e) { e.preventDefault(); openAuthModal('signup'); });
        }
    }

    function closeAuthModal() {
        authModal.classList.remove('active');
        loginForm.reset();
        signupForm.reset();
        document.getElementById('loginError').textContent = '';
        document.getElementById('signupError').textContent = '';
        document.getElementById('signupSuccess').textContent = '';
    }

    document.getElementById('loginBtn').addEventListener('click', function() { openAuthModal('login'); });
    document.getElementById('guestLoginBtn').addEventListener('click', function() { window.location.href = '/signup/'; });
    document.getElementById('guestSignInBtn').addEventListener('click', function() { openAuthModal('login'); });
    document.getElementById('authModalClose').addEventListener('click', closeAuthModal);
    authModal.addEventListener('click', function(e) { if (e.target === authModal) closeAuthModal(); });

    // User card click handled by profile popup code below

    // Login
    loginForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        var btn = document.getElementById('loginSubmit');
        var err = document.getElementById('loginError');
        err.textContent = '';
        btn.disabled = true;
        btn.textContent = 'Signing in...';
        
        try {
            var result = await supabase.auth.signInWithPassword({
                email: document.getElementById('loginEmail').value,
                password: document.getElementById('loginPassword').value
            });
            if (result.error) throw result.error;
            closeAuthModal();
            checkAuth();
        } catch (ex) {
            err.textContent = ex.message || 'Login failed';
        }
        
        btn.disabled = false;
        btn.textContent = 'Sign In';
    });

    // Signup
    signupForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        var btn = document.getElementById('signupSubmit');
        var err = document.getElementById('signupError');
        var suc = document.getElementById('signupSuccess');
        err.textContent = '';
        suc.textContent = '';
        btn.disabled = true;
        btn.textContent = 'Creating account...';
        
        try {
            var result = await supabase.auth.signUp({
                email: document.getElementById('signupEmail').value,
                password: document.getElementById('signupPassword').value,
                options: {
                    data: { full_name: document.getElementById('signupName').value },
                    emailRedirectTo: window.location.origin
                }
            });
            if (result.error) throw result.error;
            if (result.data.user && !result.data.session) {
                suc.textContent = ' Check your email to confirm your account';
                btn.textContent = 'Email Sent';
            } else {
                closeAuthModal();
                checkAuth();
            }
        } catch (ex) {
            err.textContent = ex.message || 'Signup failed';
            btn.disabled = false;
            btn.textContent = 'Create Account';
        }
    });

    // Google Auth
    document.getElementById('googleAuthBtn').addEventListener('click', function() {
        supabase.auth.signInWithOAuth({
            provider: 'google',
            options: { redirectTo: window.location.origin }
        });
    });

<!-- Old logout button removed -->
    
    // Sidebar logout
    document.getElementById('sidebarLogout').addEventListener('click', async function() {
        await supabase.auth.signOut();
        currentUser = null;
        document.getElementById('profileMenu').classList.remove('active');
        checkAuth();
        showToast('Signed out', 'success');
    });
    
    // Profile menu toggle
    document.getElementById('userCard').addEventListener('click', function(e) {
        e.stopPropagation();
        document.getElementById('notificationsPopup').classList.remove('active');
        document.getElementById('profileMenu').classList.toggle('active');
    });
    
    // Profile menu items
    document.querySelectorAll('.profile-menu-item[data-page]').forEach(function(item) {
        item.addEventListener('click', function() {
            switchPage(this.dataset.page);
            document.getElementById('profileMenu').classList.remove('active');
        });
    });
    
    // Notifications toggle
    document.getElementById('notificationBtn').addEventListener('click', function(e) {
        e.stopPropagation();
        document.getElementById('profileMenu').classList.remove('active');
        document.getElementById('notificationsPopup').classList.toggle('active');
    });
    
    // Close popups when clicking outside
    document.addEventListener('click', function() {
        document.getElementById('profileMenu').classList.remove('active');
        document.getElementById('notificationsPopup').classList.remove('active');
    });

    // Auth Check (returns promise)
    function checkAuth() {
        return (async function() {
        if (!supabase) {
            window.__showErrorFallback();
            return;
        }
        document.getElementById('loadingState').classList.remove('hidden');
        document.getElementById('guestState').classList.add('hidden');
        document.getElementById('dashboardContent').classList.add('hidden');

        var result;
        try {
            // Race getSession against a 10-second timeout
            result = await Promise.race([
                supabase.auth.getSession(),
                new Promise(function(_, reject) {
                    setTimeout(function() { reject(new Error('Supabase connection timed out')); }, 10000);
                })
            ]);
        } catch (authErr) {
            console.error('Auth check failed:', authErr);
            window.__showErrorFallback();
            return;
        }
        currentUser = result.data.session?.user || null;

        // App successfully connected  cancel the loading timeout
        window.__appMounted = true;
        if (window.__appLoadTimer) clearTimeout(window.__appLoadTimer);

        document.getElementById('loadingState').classList.add('hidden');
        
        if (currentUser) {
            var name = currentUser.user_metadata?.full_name || currentUser.user_metadata?.display_name || currentUser.email.split('@')[0];
            var avatar = currentUser.user_metadata?.profile_picture;
            
            document.getElementById('userName').textContent = name;
            document.getElementById('userEmail').textContent = currentUser.email;
            
            if (avatar) {
                document.getElementById('userAvatar').innerHTML = '<img src="' + avatar + '" alt="">';
            } else {
                document.getElementById('userAvatar').textContent = name.charAt(0).toUpperCase();
            }
            
            document.getElementById('loginBtn').classList.add('hidden');
            document.getElementById('dashboardContent').classList.remove('hidden');

            // Show sidebar and header for logged in users
            document.getElementById('sidebar').style.display = '';
            document.querySelector('.header').style.display = '';

            // Show loading animation for logged in users
            var overlay = document.getElementById('pageLoadingOverlay');
            var appContainer = document.getElementById('appContainer');
            overlay.style.display = 'flex';
            appContainer.style.opacity = '1';
            // Track when loading started - will hide when data actually loads
            window.loadingStartTime = Date.now();
            // Safety fallback - hide loading after max 15 seconds even if data hasn't loaded
            setTimeout(function() {
                if (typeof hidePageLoading === 'function') hidePageLoading();
            }, 15000);
        } else {
            document.getElementById('userName').textContent = 'Guest';
            document.getElementById('userEmail').textContent = 'Not signed in';
            document.getElementById('userAvatar').textContent = 'G';
            document.getElementById('loginBtn').classList.add('hidden');
            document.getElementById('guestState').classList.remove('hidden');
            // Hide sidebar and header for non-logged in users
            document.getElementById('sidebar').style.display = 'none';
            document.querySelector('.header').style.display = 'none';
            // Center the guest state as full-page
            var mainEl = document.querySelector('.main-content');
            if (mainEl) {
                mainEl.style.marginLeft = '0';
                mainEl.style.minHeight = '100vh';
                mainEl.style.display = 'flex';
                mainEl.style.alignItems = 'center';
                mainEl.style.justifyContent = 'center';
            }
            var pageContent = document.querySelector('.page-content');
            if (pageContent) {
                pageContent.style.display = 'flex';
                pageContent.style.alignItems = 'center';
                pageContent.style.justifyContent = 'center';
                pageContent.style.flex = '1';
            }
            // Show app container for non-logged in users
            document.getElementById('appContainer').style.opacity = '1';
        }
        })();
    }

    // Airtable Config (token is now server-side only in Cloudflare env vars)
    var AIRTABLE_BASE = 'applOjDjhH0RqLtBH';
    var AIRTABLE_CLIENTS_TABLE = 'tblMptC862PyL7Znw';
    var AIRTABLE_LEADS_TABLE = 'tblLpN4wceakfNFpq';
    var AIRTABLE_CALLS_TABLE = 'tblvB5OpG0b5mVix3';
    var AIRTABLE_ADMIN_SETTINGS_TABLE = 'tblGD3iwn1nU0gjtx';
    var dynamicCallLimit = null;

    // Airtable API helper - proxies through Pages Function (token handled server-side)
    async function fetchAirtable(path, options = {}) {
        var proxyUrl = '/api/airtable?path=' + encodeURIComponent(path);
        var fetchOptions = {
            method: options.method || 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        };
        if (options.body) {
            fetchOptions.body = typeof options.body === 'string' ? options.body : JSON.stringify(options.body);
        }
        var response = await fetch(proxyUrl, fetchOptions);
        return response.json();
    }
    
    // Fetch call limit from Admin Settings based on client's Monthly Plan
    async function fetchCallLimitFromSettings(planName) {
        try {
            var planKey = 'starter_call_limit';
            if (planName) {
                var normalized = planName.toLowerCase().trim();
                if (normalized === 'professional') planKey = 'professional_call_limit';
                else if (normalized === 'growth') planKey = 'growth_call_limit';
                else if (normalized === 'enterprise') planKey = 'enterprise_call_limit';
                else planKey = 'starter_call_limit';
            }
            var filterFormula = encodeURIComponent('({Setting Key} = "' + planKey + '")');
            var path = AIRTABLE_BASE + '/' + AIRTABLE_ADMIN_SETTINGS_TABLE + '?filterByFormula=' + filterFormula + '&fields[]=Setting+Key&fields[]=Setting+Value';
            var data = await fetchAirtable(path);
            if (data.records && data.records.length > 0) {
                var val = parseInt(data.records[0].fields['Setting Value']);
                if (!isNaN(val) && val > 0) {
                    dynamicCallLimit = val;
                    return val;
                }
            }
        } catch (err) {
            console.error('Failed to fetch call limit from Admin Settings:', err);
        }
        return null;
    }

    var currentUserRecord = null;
    var allLeads = [];
    var allCalls = [];
    var callsLoaded = false;

    // Load calls from Calls table for analytics
    // Client is a lookup field on Calls that pulls from Lead -> Client Email
    async function loadCallsData() {
        if (!currentUserRecord) {
            console.log('No user record, skipping calls load');
            return;
        }

        try {
            var clientName = currentUserRecord.fields['Agent Name'] || '';
            console.log('Loading calls for client name: ' + clientName);

            // Filter by Client lookup field (displays client name from Lead->Client->Agent Name)
            var filterFormula = 'FIND("' + clientName + '", ARRAYJOIN({Client}))';
            var basePath = AIRTABLE_BASE + '/' + AIRTABLE_CALLS_TABLE + '?filterByFormula=' + encodeURIComponent(filterFormula) + '&pageSize=100&fields[]=Timestamp&fields[]=Outcome';

            allCalls = [];
            var offset = null;

            do {
                var path = basePath + (offset ? '&offset=' + offset : '');
                var data = await fetchAirtable(path);
                if (data.records) {
                    allCalls = allCalls.concat(data.records);
                }
                offset = data.offset;
            } while (offset);

            callsLoaded = true;
            console.log('Loaded ' + allCalls.length + ' call records for analytics');
        } catch (err) {
            console.error('Failed to load calls:', err);
        }
    }

    // Update welcome date
    function updateWelcomeDate() {
        var now = new Date();
        var options = { weekday: 'long', month: 'long', day: 'numeric' };
        document.getElementById('welcomeDate').textContent = now.toLocaleDateString('en-US', options);
    }
    updateWelcomeDate();

    // Fetch all fields for now - field filtering can be added once field names are verified
    var LEAD_FIELDS = '';
    
    // Try to load cached data first for instant display
    function loadCachedData() {
        try {
            var cached = sessionStorage.getItem('prio_leads_' + currentUser.email);
            if (cached) {
                var data = JSON.parse(cached);
                if (Date.now() - data.timestamp < 60000) { // Cache valid for 1 minute
                    allLeads = data.leads;
                    updateDashboard();
                    updatePrioList();
                    updateBookedTodayList();
                    return true;
                }
            }
        } catch (e) {}
        return false;
    }
    
    function cacheData() {
        try {
            sessionStorage.setItem('prio_leads_' + currentUser.email, JSON.stringify({
                timestamp: Date.now(),
                leads: allLeads
            }));
        } catch (e) {}
    }

    // Load user data from Airtable
    async function loadUserData() {
        if (!currentUser) return;
        
        // Show cached data immediately if available
        var hasCached = loadCachedData();
        
        // Show loading state only if no cache
        if (!hasCached) {
            document.getElementById('statProspects').textContent = '...';
            document.getElementById('statAppointments').textContent = '...';
            document.getElementById('statCallsToday').textContent = '...';
        }
        
        try {
            var filterFormula = encodeURIComponent('({Email} = "' + currentUser.email + '")');
            var path = AIRTABLE_BASE + '/' + AIRTABLE_CLIENTS_TABLE + '?filterByFormula=' + filterFormula;
            var data = await fetchAirtable(path);
            
            if (data.records && data.records.length > 0) {
                currentUserRecord = data.records[0];

                // Subscription gate: only allow Active status
                var clientStatus = (currentUserRecord.fields['Status'] || '').toLowerCase();
                if (clientStatus !== 'active') {
                    // Hide dashboard, show subscription locked state
                    document.getElementById('dashboardContent').classList.add('hidden');
                    document.getElementById('sidebar').style.display = 'none';
                    document.querySelector('.header').style.display = 'none';
                    var lockedEl = document.getElementById('subscriptionLocked');
                    lockedEl.classList.remove('hidden');
                    // Center the locked state
                    var mainEl = document.querySelector('.main-content');
                    if (mainEl) {
                        mainEl.style.marginLeft = '0';
                        mainEl.style.display = 'flex';
                        mainEl.style.alignItems = 'center';
                        mainEl.style.justifyContent = 'center';
                        mainEl.style.minHeight = '100vh';
                    }
                    // Prefill email in Stripe links
                    var subEmail = currentUser.email || '';
                    if (subEmail) {
                        document.querySelectorAll('.sub-plan-btn').forEach(function(btn) {
                            var href = btn.getAttribute('href');
                            if (href && href.indexOf('buy.stripe.com') !== -1) {
                                btn.setAttribute('href', href + '?prefilled_email=' + encodeURIComponent(subEmail));
                            }
                        });
                    }
                    // Logout handler
                    var subLogout = document.getElementById('subLockedLogout');
                    if (subLogout) {
                        subLogout.addEventListener('click', function(e) {
                            e.preventDefault();
                            supabase.auth.signOut().then(function() { window.location.href = '/login/'; });
                        });
                    }
                    clearAllLoadingStates();
                    return;
                }

                // Fetch dynamic call limit from Admin Settings (non-blocking)
                var clientPlan = currentUserRecord.fields['Monthly Plan'] || 'Starter';
                fetchCallLimitFromSettings(clientPlan).then(function(limit) {
                    if (limit !== null) {
                        // Re-update dashboard and billing with the dynamic limit
                        updateDashboard();
                        populateBilling();
                    }
                });
                loadLeadsData();
            } else {
                document.getElementById('statProspects').textContent = '0';
                document.getElementById('statAppointments').textContent = '0';
                document.getElementById('statCallsToday').textContent = '0';
                document.getElementById('prioList').innerHTML = '<div class="prio-empty">No leads yet. Import some to get started!</div>';
                // No user record - clear all loading states
                clearAllLoadingStates();
            }
        } catch (err) {
            console.error('Failed to load user data:', err);
            if (!hasCached) {
                document.getElementById('statProspects').textContent = '0';
                document.getElementById('statAppointments').textContent = '0';
                document.getElementById('statCallsToday').textContent = '0';
            }
            // Error occurred - clear all loading states
            clearAllLoadingStates();

            // Retry loading user data after a delay
            if (!window.userLoadRetryCount) window.userLoadRetryCount = 0;
            if (window.userLoadRetryCount < 3) {
                window.userLoadRetryCount++;
                console.log('Retrying user data load, attempt ' + window.userLoadRetryCount);
                setTimeout(loadUserData, 2000 * window.userLoadRetryCount);
            }
        }
    }

    // Helper to clear all loading states
    function clearAllLoadingStates() {
        // Clear dashboard loading spinners
        var overviewPage = document.getElementById('page-overview');
        if (overviewPage) {
            overviewPage.classList.remove('dashboard-loading');
        }
        // Clear page loading overlay
        if (typeof hidePageLoading === 'function') hidePageLoading();
    }

    // Load leads data with optimizations
    async function loadLeadsData(isRefresh) {
        if (!currentUserRecord) return;

        try {
            var email = currentUser.email.toLowerCase();
            // Include leads owned by user OR shared with user (use ARRAYJOIN for lookup fields)
            var filterFormula = 'OR(FIND("' + email + '", LOWER(ARRAYJOIN({Client Email}))), FIND("' + email + '", LOWER(ARRAYJOIN({Shared With Email}))))';
            var basePath = AIRTABLE_BASE + '/' + AIRTABLE_LEADS_TABLE + '?filterByFormula=' + encodeURIComponent(filterFormula) + '&pageSize=100';

            // Use temp array to avoid flickering on refresh
            var tempLeads = [];
            var offset = null;
            var isFirstPage = true;

            do {
                var fetchPath = basePath + (offset ? '&offset=' + offset : '');
                var data = await fetchAirtable(fetchPath);

                if (data.records) {
                    // Mark leads that are shared WITH the user (not owned by them)
                    data.records.forEach(function(record) {
                        var clientEmails = record.fields['Client Email'] || [];
                        var clientEmailsLower = (Array.isArray(clientEmails) ? clientEmails : [clientEmails]).map(function(e) { return (e || '').toLowerCase(); });
                        // Shared With Email is a lookup field - can be array or string
                        var sharedWithEmails = record.fields['Shared With Email'] || [];
                        if (!Array.isArray(sharedWithEmails)) sharedWithEmails = [sharedWithEmails];
                        var sharedWithEmailsLower = sharedWithEmails.map(function(e) { return (e || '').toLowerCase(); });

                        // If user's email is not in Client Email but is in Shared With Email, mark as shared
                        if (!clientEmailsLower.includes(email) && sharedWithEmailsLower.includes(email)) {
                            record.isShared = true;
                        }
                    });
                    tempLeads = tempLeads.concat(data.records);
                }
                offset = data.offset;

                // On initial load, render after first page so user sees data fast
                if (!isRefresh && isFirstPage && tempLeads.length > 0) {
                    isFirstPage = false;
                    allLeads = tempLeads.slice(); // Copy current data
                    updateDashboard();
                    updatePrioList();
                }
            } while (offset);

            // Replace allLeads with complete new data
            allLeads = tempLeads;
            updateDashboard();
            updatePrioList();
            updateBookedTodayList();
            cacheData();

            // Mark data as successfully loaded
            window.dataLoadedSuccessfully = true;

            // Handle pending deep link after data loads
            if (pendingLeadDeepLink && allLeads.length > 0) {
                var dl = pendingLeadDeepLink;
                pendingLeadDeepLink = null;
                setTimeout(function() {
                    if (dl.type === 'modal') {
                        openLeadModal(dl.id);
                    } else if (dl.type === 'search') {
                        var lead = allLeads.find(function(l) { return l.id === dl.id; });
                        if (lead) showSearchLeadDetail(lead);
                    }
                }, 100);
            }
        } catch (err) {
            console.error('Failed to load leads:', err);
            // Still clear loading state on error so user isn't stuck
            updateDashboard();

            // Retry loading after a delay if not already retrying too much
            if (!window.loadRetryCount) window.loadRetryCount = 0;
            if (window.loadRetryCount < 3) {
                window.loadRetryCount++;
                console.log('Retrying data load, attempt ' + window.loadRetryCount);
                setTimeout(function() {
                    loadLeadsData(isRefresh);
                }, 2000 * window.loadRetryCount); // Exponential backoff: 2s, 4s, 6s
            }
        }
    }

    function animateValue(el, end) {
        if (!el) return;
        var val = parseInt(el.textContent) || 0;
        if (val === end) { el.textContent = end; return; }
        var start = 0;
        var duration = 600;
        var startTime = null;
        function step(ts) {
            if (!startTime) startTime = ts;
            var progress = Math.min((ts - startTime) / duration, 1);
            var eased = 1 - Math.pow(1 - progress, 3);
            el.textContent = Math.round(eased * end);
            if (progress < 1) requestAnimationFrame(step);
        }
        requestAnimationFrame(step);
    }

    function updateDashboard() {
        updateStats();
        // Remove loading state from dashboard
        var overviewPage = document.getElementById('page-overview');
        if (overviewPage) {
            overviewPage.classList.remove('dashboard-loading');
        }
    }

    // Update stats
    function updateStats() {
        var totalProspects = allLeads.length;
        animateValue(document.getElementById('statProspects'), totalProspects);

        var appointments = allLeads.filter(function(l) {
            var status = l.fields['Status'] || l.fields['Disposition'] || '';
            return status === 'Booked' || status === 'Appointment Booked';
        }).length;
        animateValue(document.getElementById('statAppointments'), appointments);
        
        // Today's date for filtering
        var today = new Date().toDateString();
        var todayISO = new Date().toISOString().split('T')[0];

        // Calls Today - count leads with Last Call Timestamp today
        var callsToday = allLeads.filter(function(l) {
            var lastCall = l.fields['Last Call Timestamp'];
            if (!lastCall) return false;
            return new Date(lastCall).toDateString() === today;
        }).length;
        animateValue(document.getElementById('statCallsToday'), callsToday);

        // AI Qualified Conversations - Outcome = Booked, Timeline, Follow Up, Callback, or Not Interested
        var qualifiedOutcomes = ['booked', 'timeline', 'follow up', 'callback', 'not interested'];
        var conversationsToday = allLeads.filter(function(l) {
            var lastCall = l.fields['Last Call Timestamp'];
            if (!lastCall) return false;
            if (new Date(lastCall).toDateString() !== today) return false;
            var outcome = (l.fields['Outcome'] || l.fields['Disposition'] || l.fields['Status'] || '').toLowerCase();
            return qualifiedOutcomes.includes(outcome);
        }).length;
        var convEl = document.getElementById('statConversationsToday');
        if (convEl) animateValue(convEl, conversationsToday);

        // AI Meetings Scheduled - Outcome = Booked or Callback
        var meetingOutcomes = ['booked', 'callback'];
        var meetingsToday = allLeads.filter(function(l) {
            var lastCall = l.fields['Last Call Timestamp'];
            if (!lastCall) return false;
            if (new Date(lastCall).toDateString() !== today) return false;
            var outcome = (l.fields['Outcome'] || l.fields['Disposition'] || l.fields['Status'] || '').toLowerCase();
            return meetingOutcomes.includes(outcome);
        }).length;
        var meetEl = document.getElementById('statMeetingsToday');
        if (meetEl) animateValue(meetEl, meetingsToday);

        // AI Follow Ups Scheduled - Outcome = Timeline or Follow Up
        var followUpOutcomes = ['timeline', 'follow up'];
        var followUpsToday = allLeads.filter(function(l) {
            var lastCall = l.fields['Last Call Timestamp'];
            if (!lastCall) return false;
            if (new Date(lastCall).toDateString() !== today) return false;
            var outcome = (l.fields['Outcome'] || l.fields['Disposition'] || l.fields['Status'] || '').toLowerCase();
            return followUpOutcomes.includes(outcome);
        }).length;
        var fuEl = document.getElementById('statFollowUpsToday');
        if (fuEl) animateValue(fuEl, followUpsToday);
        
        // Retell Phone & Usage from client record
        if (currentUserRecord && currentUserRecord.fields) {
            var retellPhone = currentUserRecord.fields['Retell Phone'];
            if (retellPhone) {
                document.getElementById('retellPhoneNumber').textContent = retellPhone;
            }
            var callsThisMonth = currentUserRecord.fields['Calls This Month'] || 0;
            var callLimit = dynamicCallLimit || currentUserRecord.fields['Call Limit'] || 1000;
            document.getElementById('usageCalls').textContent = callsThisMonth;
            document.getElementById('usageLimit').textContent = callLimit;
            
            // Update usage progress bar with color gradient
            var usagePercent = callLimit > 0 ? Math.min((callsThisMonth / callLimit) * 100, 100) : 0;
            var usageBar = document.getElementById('usageBarFill');
            usageBar.style.width = usagePercent + '%';
            usageBar.classList.remove('warning', 'danger');

            // Color changes: white (0-50%) -> yellow (50-80%) -> red (80%+)
            if (usagePercent >= 100) {
                usageBar.classList.add('danger');
            } else if (usagePercent >= 80) {
                usageBar.classList.add('danger');
            } else if (usagePercent >= 50) {
                usageBar.classList.add('warning');
            }
            // Default is white (no class)
        }
        
        // PRIO leads (Is Prio = true from Airtable)
        var prioLeads = allLeads.filter(function(l) {
            return l.fields['Is Prio'] === true;
        });
        animateValue(document.getElementById('overviewPrio'), prioLeads.length);
        
        // Scheduled leads (callback or meeting booked)
        var scheduledLeads = allLeads.filter(function(l) {
            var status = l.fields['Status'] || l.fields['Disposition'] || '';
            var hasBookedTime = !!l.fields['Booked Time'];
            var hasCallback = status === 'Callback' || status === 'Callback Requested';
            return hasBookedTime || hasCallback || status === 'Booked' || status === 'Appointment Booked';
        });
        animateValue(document.getElementById('overviewScheduled'), scheduledLeads.length);
        
        // Active leads (currently being called by AI)
        var activeLeads = allLeads.filter(function(l) {
            var status = l.fields['Call Status'] || l.fields['Status'] || '';
            return status === 'Queued' || status === 'In Progress' || status === 'Retry' || status === 'Calling';
        });
        animateValue(document.getElementById('overviewActive'), activeLeads.length);
        
        // AI Pipeline (Timeline & Follow Up - will be called back)
        var pipelineLeads = allLeads.filter(function(l) {
            var status = l.fields['Status'] || l.fields['Disposition'] || '';
            return status === 'Timeline' || status === 'Follow Up';
        });
        animateValue(document.getElementById('overviewPipeline'), pipelineLeads.length);
        
        // Today's priorities (booked time or callback today) + missed meetings (past scheduled with no call logged)
        // Use EST timezone for accurate "today" calculation
        var nowEST = new Date(new Date().toLocaleString('en-US', { timeZone: 'America/New_York' }));
        var today = nowEST.getFullYear() + '-' + String(nowEST.getMonth() + 1).padStart(2, '0') + '-' + String(nowEST.getDate()).padStart(2, '0');
        var todayDate = new Date(today);

        // Today's scheduled calls (exclude AI pipeline leads)
        var todayPriorities = allLeads.filter(function(l) {
            var status = l.fields['Status'] || l.fields['Disposition'] || '';
            // Exclude AI pipeline leads (Timeline/Follow Up)
            if (status === 'Timeline' || status === 'Follow Up') return false;

            var bookedTime = l.fields['Booked Time'] || '';
            var callbackDate = l.fields['Callback Date'] || l.fields['Follow Up Date'] || '';
            return (bookedTime && bookedTime.startsWith(today)) || (callbackDate && callbackDate.startsWith(today));
        }).sort(function(a, b) {
            var timeA = a.fields['Booked Time'] || a.fields['Callback Date'] || '';
            var timeB = b.fields['Booked Time'] || b.fields['Callback Date'] || '';
            return timeA.localeCompare(timeB);
        });

        // Find missed meetings (scheduled in past but not yet handled)
        // Exclude AI pipeline leads (Timeline/Follow Up) - they are handled by AI
        var missedMeetings = allLeads.filter(function(l) {
            var status = l.fields['Status'] || l.fields['Disposition'] || '';
            // Exclude AI pipeline leads - they shouldn't appear as missed meetings
            if (status === 'Timeline' || status === 'Follow Up') return false;

            var bookedTime = l.fields['Booked Time'] || '';
            var callbackDate = l.fields['Callback Date'] || l.fields['Follow Up Date'] || '';
            var scheduledDate = bookedTime || callbackDate;

            if (!scheduledDate) return false;

            var scheduledDateOnly = scheduledDate.split('T')[0];
            var scheduledDateObj = new Date(scheduledDateOnly);

            // Only check past dates (not today)
            if (scheduledDateObj >= todayDate) return false;

            // If the lead was updated AFTER the scheduled date, the meeting was handled
            var updatedAt = l.fields['Updated At'];
            if (updatedAt) {
                var updatedDate = new Date(updatedAt);
                if (updatedDate > scheduledDateObj) return false;
            }

            return true;
        }).sort(function(a, b) {
            // Sort by scheduled date descending (most recent missed first)
            var timeA = a.fields['Booked Time'] || a.fields['Callback Date'] || '';
            var timeB = b.fields['Booked Time'] || b.fields['Callback Date'] || '';
            return timeB.localeCompare(timeA);
        });

        // Update count - only today's meetings in the green badge
        document.getElementById('prioritiesCount').textContent = todayPriorities.length;
        updateTodayPriorities(todayPriorities, missedMeetings);
        
        // Update welcome name - check Supabase metadata first, then Airtable Agent Name
        var name = currentUser?.user_metadata?.full_name ||
                   currentUser?.user_metadata?.display_name ||
                   currentUserRecord?.fields?.['Agent Name'] ||
                   'there';
        document.getElementById('welcomeName').textContent = name.split(' ')[0];
        
        // Set today's date
        document.getElementById('welcomeDate').textContent = new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
        
    }
    
    // Format phone number as +1 (647) 123-4567
    function formatPhoneNumber(phone) {
        if (!phone || phone === '-') return '-';
        var digits = phone.replace(/\D/g, '');
        if (digits.length === 10) {
            return '+1 (' + digits.substring(0,3) + ') ' + digits.substring(3,6) + '-' + digits.substring(6);
        } else if (digits.length === 11 && digits.startsWith('1')) {
            return '+1 (' + digits.substring(1,4) + ') ' + digits.substring(4,7) + '-' + digits.substring(7);
        }
        return phone;
    }

    // Build tel: link for click-to-call
    function phoneLink(rawPhone, formattedPhone) {
        if (!rawPhone || rawPhone === '-') return escapeHtml(formattedPhone);
        var digits = rawPhone.replace(/\D/g, '');
        if (digits.length === 10) digits = '1' + digits;
        return '<a href="tel:+' + digits + '" style="color:inherit;text-decoration:none;" onclick="event.stopPropagation();">' + escapeHtml(formattedPhone) + '</a>';
    }

    // Update today's priorities list with taller cards
    function updateTodayPriorities(priorities, missedMeetings) {
        var list = document.getElementById('todayPriorities');
        missedMeetings = missedMeetings || [];

        if ((!priorities || priorities.length === 0) && missedMeetings.length === 0) {
            list.innerHTML = '<div class="priorities-empty"><p>No meetings or callbacks scheduled for today</p></div>';
            return;
        }

        function renderPriorityCard(lead, index, isMissed) {
            var f = lead.fields;
            var name = ((f['First Name'] || '') + ' ' + (f['Last Name'] || '')).trim() || 'Unknown';
            var phone = f['Phone #'] || f['Phone'] || '-';
            var formattedPhone = formatPhoneNumber(phone);
            var bookedTime = f['Booked Time'];
            var callbackDate = f['Callback Date'] || f['Follow Up Date'];
            var summary = f['Last Call Summary'] || f['Summary'] || '';
            var notesRaw = f['Client Notes'] || f['Notes'] || '';
            var lastUpdatedTimestamp = f['Updated At'];
            var lastUpdated = lastUpdatedTimestamp ? formatTimeAgo(lastUpdatedTimestamp) : '-';
            var lastUpdatedColor = getLastCalledColor(lastUpdatedTimestamp);
            var isPrio = f['Is Prio'] === true;
            var isShared = lead.isShared || (f['Shared With'] && f['Shared With'].length > 0) || (f['Shared With Email'] && (Array.isArray(f['Shared With Email']) ? f['Shared With Email'].length > 0 : f['Shared With Email']));

            // Parse notes
            var notesArray = parseNotesJson(notesRaw);

            // Get last note text
            var lastNoteText = notesArray.length > 0 ? notesArray[notesArray.length - 1].text : 'No notes yet';

            // Check if the meeting is done (last updated time is after the meeting time)
            var meetingDone = false;
            var scheduledDateTime = bookedTime || callbackDate;
            if (!isMissed && scheduledDateTime && lastUpdatedTimestamp) {
                var meetingTime = new Date(scheduledDateTime);
                var updatedTime = new Date(lastUpdatedTimestamp);
                if (updatedTime > meetingTime) {
                    meetingDone = true;
                }
            }

            var timeDisplay = '';
            var dateDisplay = '';
            var hasSchedule = false;
            if (bookedTime) {
                var d = new Date(bookedTime);
                timeDisplay = d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                if (isMissed) {
                    dateDisplay = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                }
            } else if (callbackDate) {
                var d = new Date(callbackDate);
                timeDisplay = d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                if (isMissed) {
                    dateDisplay = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                }
            } else {
                hasSchedule = true;
            }

            var cardClasses = isMissed ? ' missed-meeting' : (meetingDone ? ' meeting-done' : '');
            var timeCol;
            if (hasSchedule) {
                timeCol = '<button class="btn-schedule-card" onclick="event.stopPropagation();quickSchedule(\'' + lead.id + '\')">Schedule</button>';
            } else if (isMissed && dateDisplay) {
                timeCol = '<span class="time-value missed-date">' + dateDisplay + '</span><span class="time-value">' + timeDisplay + '</span>';
            } else {
                timeCol = '<span class="time-value">' + timeDisplay + '</span>';
            }

            var prioIndicator = isPrio ? '<img src="/assets/favicon.png" class="prio-icon" title="Priority Lead">' : '';

            return '<div class="priority-card-lg' + cardClasses + '" data-id="' + lead.id + '">' +
                '<div class="priority-card-lg-left" onclick="openLeadModal(\'' + lead.id + '\')">' +
                    '<div class="priority-card-lg-time-col">' +
                        (meetingDone ? '<span class="meeting-done-badge">Done</span>' : '') +
                        prioIndicator +
                        timeCol +
                    '</div>' +
                    '<div class="priority-card-lg-info">' +
                        '<div class="priority-card-lg-top">' +
                            '<div class="priority-card-lg-name">' + escapeHtml(name) + '</div>' +
                        '</div>' +
                        '<div class="priority-card-lg-phone"> ' + phoneLink(phone, formattedPhone) + '</div>' +
                        '<div class="priority-card-lg-lastcall">Updated ' + lastUpdated + ' <span class="lastcall-dot ' + lastUpdatedColor + '"></span></div>' +
                    '</div>' +
                '</div>' +
                getCardStatusHtml(lead) +
                '<div class="priority-card-lg-summary-col" onclick="openLeadModal(\'' + lead.id + '\')">' +
                    '<div class="col-label">Summary</div>' +
                    '<div class="col-content">' + (summary ? escapeHtml(summary) : '<span style="color:rgba(255,255,255,0.4)">No summary available</span>') + '</div>' +
                '</div>' +
                '<div class="priority-card-lg-notes-col" onclick="openLeadModal(\'' + lead.id + '\')">' +
                    '<div class="col-label">Notes</div>' +
                    '<div class="col-content">' + escapeHtml(lastNoteText) + '</div>' +
                '</div>' +
                '<div class="priority-card-lg-actions">' +
                    '<button class="action-btn action-share' + (isShared ? ' shared' : '') + '" onclick="event.stopPropagation();quickShareLead(\'' + lead.id + '\')"><span class="action-icon">' + (isShared ? '' : '') + '</span><span class="action-label">' + (isShared ? 'Shared' : 'Share') + '</span></button>' +
                    '<button class="action-btn action-ai" onclick="event.stopPropagation();quickSendToAI(\'' + lead.id + '\')"><span class="action-icon"></span><span class="action-label">Send to AI</span></button>' +
                    '<button class="action-btn action-dnc" onclick="event.stopPropagation();quickMarkDNC(\'' + lead.id + '\')"><span class="action-icon"></span><span class="action-label">Do Not Call</span></button>' +
                    '<button class="action-btn action-reschedule" onclick="event.stopPropagation();quickReschedule(\'' + lead.id + '\')"><span class="action-icon"></span><span class="action-label">Reschedule</span></button>' +
                '</div>' +
            '</div>';
        }

        var html = '';

        // Render today's priorities first
        if (priorities && priorities.length > 0) {
            html += priorities.map(function(lead, index) {
                return renderPriorityCard(lead, index, false);
            }).join('');
        }

        // Add red separator and missed meetings if any
        if (missedMeetings.length > 0) {
            html += '<div class="missed-meeting-separator"><span>Missed Meeting <span class="missed-count">' + missedMeetings.length + '</span></span></div>';
            html += '<div class="missed-meeting-info">Please reschedule these meetings or send back to AI to keep your dashboard clean.</div>';
            html += missedMeetings.map(function(lead, index) {
                return renderPriorityCard(lead, index, true);
            }).join('');
        }

        list.innerHTML = html;
    }
    
    // Switch tabs on Priority cards
    function switchPriorityTab(cardId, tab) {
        var card = document.getElementById(cardId);
        if (!card) return;
        var tabsContainer = card.previousElementSibling;
        
        // Update tab buttons
        tabsContainer.querySelectorAll('.priority-card-lg-tab').forEach(function(btn) {
            btn.classList.remove('active');
        });
        tabsContainer.querySelector('.priority-card-lg-tab:' + (tab === 'summary' ? 'first-child' : 'last-child')).classList.add('active');
        
        // Update panels
        card.querySelectorAll('.priority-card-lg-panel').forEach(function(panel) {
            panel.classList.remove('active');
            if (panel.dataset.panel === tab) panel.classList.add('active');
        });
    }
    
    // Toggle priorities view between grid and list
    function setPrioritiesView(view) {
        var container = document.getElementById('todayPriorities');
        var gridBtn = document.getElementById('viewGrid');
        var listBtn = document.getElementById('viewList');
        
        if (view === 'list') {
            container.classList.add('list-view');
            gridBtn.classList.remove('active');
            listBtn.classList.add('active');
        } else {
            container.classList.remove('list-view');
            gridBtn.classList.add('active');
            listBtn.classList.remove('active');
        }
    }

    // Update Prio Prospects list
    function updatePrioList() {
        var prioList = document.getElementById('prioList');

        // Get leads where Is Prio = true, sorted by priority score
        var prioLeads = allLeads.filter(function(l) {
            return l.fields['Is Prio'] === true;
        }).map(function(l) {
            var d = l.fields['Disposition'] || l.fields['Status'] || '';
            var score = 0;
            if (d === 'Booked' || d === 'Appointment Booked') score = 95;
            else if (d === 'Callback' || d === 'Callback Requested') score = 90;
            else if (d === 'Interested') score = 85;
            else if (d === 'Timeline') score = 70;
            else if (d === 'Follow Up') score = 60;
            else score = 50;
            l._score = score;
            return l;
        }).sort(function(a, b) {
            return b._score - a._score;
        });

        document.getElementById('prioCount').textContent = prioLeads.length;

        if (prioLeads.length === 0) {
            prioList.innerHTML = '<div class="prio-empty">No priority leads yet. Import some leads to get started!</div>';
            return;
        }

        prioList.innerHTML = prioLeads.map(function(lead) {
            var f = lead.fields;
            var name = ((f['First Name'] || '') + ' ' + (f['Last Name'] || '')).trim() || 'Unknown';
            var phone = f['Phone #'] || f['Phone'] || '-';
            var formattedPhone = formatPhoneNumber(phone);
            var lastUpdatedTimestamp = f['Updated At'];
            var lastUpdated = lastUpdatedTimestamp ? formatTimeAgo(lastUpdatedTimestamp) : '-';
            var lastUpdatedColor = getLastCalledColor(lastUpdatedTimestamp);
            var bookedTime = f['Booked Time'] || null;
            var callbackDate = f['Callback Date'] || f['Follow Up Date'];
            var summary = f['Last Call Summary'] || f['Summary'] || '';
            var notesRaw = f['Client Notes'] || f['Notes'] || '';
            var isShared = lead.isShared || (f['Shared With'] && f['Shared With'].length > 0) || (f['Shared With Email'] && (Array.isArray(f['Shared With Email']) ? f['Shared With Email'].length > 0 : f['Shared With Email']));

            // Parse notes
            var notesArray = parseNotesJson(notesRaw);
            var lastNoteText = notesArray.length > 0 ? notesArray[notesArray.length - 1].text : 'No notes yet';

            // Get date and time display
            var dateDisplay = '';
            var timeDisplay = '';
            var hasSchedule = false;
            var status = f['Status'] || f['Disposition'] || '';
            if (bookedTime) {
                var d = new Date(bookedTime);
                dateDisplay = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                timeDisplay = d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
            } else if (callbackDate) {
                var d = new Date(callbackDate);
                dateDisplay = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                timeDisplay = d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
            } else {
                hasSchedule = true;
            }

            var timeCol;
            if (hasSchedule) {
                timeCol = '<button class="btn-schedule-card" onclick="event.stopPropagation();quickSchedule(\'' + lead.id + '\')">Schedule</button>';
            } else if (dateDisplay) {
                timeCol = '<span class="date-value">' + dateDisplay + '</span><span class="time-value">' + timeDisplay + '</span>';
            } else {
                timeCol = '<span class="time-value">' + timeDisplay + '</span>';
            }

            // Status for card dropdown
            var cardStatus = status;

            var prioIndicator = '<img src="/assets/favicon.png" class="prio-icon" title="Priority Lead">';

            return '<div class="priority-card-lg" data-id="' + lead.id + '">' +
                '<div class="priority-card-lg-left" onclick="openLeadModal(\'' + lead.id + '\')">' +
                    '<div class="priority-card-lg-time-col">' +
                        prioIndicator +
                        timeCol +
                    '</div>' +
                    '<div class="priority-card-lg-info">' +
                        '<div class="priority-card-lg-top">' +
                            '<div class="priority-card-lg-name">' + escapeHtml(name) + getSharedIconHtml(lead) + '</div>' +
                        '</div>' +
                        '<div class="priority-card-lg-phone"> ' + phoneLink(phone, formattedPhone) + '</div>' +
                        '<div class="priority-card-lg-lastcall">Updated ' + lastUpdated + ' <span class="lastcall-dot ' + lastUpdatedColor + '"></span></div>' +
                    '</div>' +
                '</div>' +
                getCardStatusHtml(lead) +
                '<div class="priority-card-lg-summary-col" onclick="openLeadModal(\'' + lead.id + '\')">' +
                    '<div class="col-label">Summary</div>' +
                    '<div class="col-content">' + (summary ? escapeHtml(summary) : '<span style="color:rgba(255,255,255,0.4)">No summary available</span>') + '</div>' +
                '</div>' +
                '<div class="priority-card-lg-notes-col" onclick="openLeadModal(\'' + lead.id + '\')">' +
                    '<div class="col-label">Notes</div>' +
                    '<div class="col-content">' + escapeHtml(lastNoteText) + '</div>' +
                '</div>' +
                '<div class="priority-card-lg-actions">' +
                    '<button class="action-btn action-share' + (isShared ? ' shared' : '') + '" onclick="event.stopPropagation();quickShareLead(\'' + lead.id + '\')"><span class="action-icon">' + (isShared ? '' : '') + '</span><span class="action-label">' + (isShared ? 'Shared' : 'Share') + '</span></button>' +
                    '<button class="action-btn action-ai" onclick="event.stopPropagation();quickSendToAI(\'' + lead.id + '\')"><span class="action-icon"></span><span class="action-label">Send to AI</span></button>' +
                    '<button class="action-btn action-dnc" onclick="event.stopPropagation();quickMarkDNC(\'' + lead.id + '\')"><span class="action-icon"></span><span class="action-label">Do Not Call</span></button>' +
                    '<button class="action-btn action-unprio" onclick="event.stopPropagation();unprio(\'' + lead.id + '\')"><span class="action-icon"></span><span class="action-label">Unprio</span></button>' +
                '</div>' +
            '</div>';
        }).join('');
    }

    // Get color class based on days since last call
    function getLastCalledColor(timestamp) {
        if (!timestamp) return 'lastcall-red';
        var date = new Date(timestamp);
        var now = new Date();
        var diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));
        
        if (diffDays <= 1) return 'lastcall-green';   // Today or yesterday
        if (diffDays <= 3) return 'lastcall-yellow';  // 2-3 days
        if (diffDays <= 6) return 'lastcall-orange';  // 4-6 days
        return 'lastcall-red';                         // 7+ days
    }
    
    // Parse notes as JSON array with date/time
    function parseNotesJson(notesRaw) {
        if (!notesRaw) return [];
        
        // Try to parse as JSON
        try {
            var parsed = JSON.parse(notesRaw);
            if (Array.isArray(parsed)) return parsed;
            // If it's an object with notes array
            if (parsed.notes && Array.isArray(parsed.notes)) return parsed.notes;
        } catch (e) {
            // Not JSON, treat as plain text note
        }
        
        // Convert plain text to JSON format
        if (typeof notesRaw === 'string' && notesRaw.trim()) {
            return [{ text: notesRaw.trim(), date: new Date().toISOString() }];
        }
        
        return [];
    }
    
    // Format note date for display
    function formatNoteDate(dateStr) {
        if (!dateStr) return '';
        var date = new Date(dateStr);
        return date.toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'}) + ' at ' + 
               date.toLocaleTimeString('en-US', {hour: 'numeric', minute: '2-digit'});
    }

    // Helpers
    function escapeHtml(text) {
        if (!text) return '';
        var div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Format date in friendly format: Feb 9, 7:00 PM
    function formatFriendlyDateTime(dateStr) {
        if (!dateStr) return 'Unknown time';
        var date = new Date(dateStr);
        if (isNaN(date.getTime())) return 'Unknown time';

        var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        var day = date.getDate();

        var hours = date.getHours();
        var ampm = hours >= 12 ? 'PM' : 'AM';
        hours = hours % 12 || 12;
        var minutes = date.getMinutes().toString().padStart(2, '0');

        return months[date.getMonth()] + ' ' + day + ', ' + hours + ':' + minutes + ' ' + ampm;
    }

    // Update card display when lead data changes
    function updateLeadCardDisplay(leadId) {
        var lead = allLeads.find(function(l) { return l.id === leadId; });
        if (!lead) return;

        var f = lead.fields;
        var notesRaw = f['Client Notes'] || '';
        var notesArray = parseNotesJson(notesRaw);
        var lastNoteText = notesArray.length > 0 ? notesArray[notesArray.length - 1].text : 'No notes yet';

        // Get updated timestamp info
        var lastUpdatedTimestamp = f['Updated At'];
        var lastUpdated = lastUpdatedTimestamp ? formatTimeAgo(lastUpdatedTimestamp) : '-';
        var lastUpdatedColor = getLastCalledColor(lastUpdatedTimestamp);

        // Update priority card (large)
        var priorityCard = document.querySelector('.priority-card-lg[data-id="' + leadId + '"]');
        if (priorityCard) {
            var notesCol = priorityCard.querySelector('.priority-card-lg-notes-col .col-content');
            if (notesCol) {
                notesCol.textContent = lastNoteText;
            }
            // Update the "Updated X ago" display
            var lastCallEl = priorityCard.querySelector('.priority-card-lg-lastcall');
            if (lastCallEl) {
                lastCallEl.innerHTML = 'Updated ' + lastUpdated + ' <span class="lastcall-dot ' + lastUpdatedColor + '"></span>';
            }
        }

        // Update prio card (small)
        var prioCard = document.querySelector('.prio-card[data-id="' + leadId + '"]');
        if (prioCard) {
            var notesList = prioCard.querySelector('.prio-card-notes-list');
            if (notesList && notesArray.length > 0) {
                var notesHtml = notesArray.map(function(note) {
                    return '<div class="prio-note-item">' +
                        '<div class="prio-note-text">' + escapeHtml(note.text) + '</div>' +
                        '<div class="prio-note-date">' + formatNoteDate(note.date) + '</div>' +
                    '</div>';
                }).join('');
                notesList.innerHTML = notesHtml;
            } else if (notesList) {
                notesList.innerHTML = '<div style="color:rgba(255,255,255,0.4);font-size:0.8125rem;">No notes yet</div>';
            }
            // Update the "Updated X ago" display
            var lastCallEl = prioCard.querySelector('.prio-card-lastcall');
            if (lastCallEl) {
                lastCallEl.innerHTML = '<span class="lastcall-dot ' + lastUpdatedColor + '"></span>' + lastUpdated;
            }
        }
    }

    function formatTimeAgo(dateStr) {
        if (!dateStr) return '';
        var date = new Date(dateStr);
        var now = new Date();
        var diff = Math.floor((now - date) / 1000);
        
        if (diff < 60) return 'Just now';
        if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
        if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
        return Math.floor(diff / 86400) + 'd ago';
    }

    // Settings - populate profile info
    function updateSettingsProfile() {
        if (!currentUser) return;
        var name = currentUser.user_metadata?.full_name || currentUser.user_metadata?.display_name || currentUser.email.split('@')[0];
        var avatar = currentUser.user_metadata?.profile_picture;
        
        document.getElementById('settingsName').textContent = name;
        document.getElementById('settingsEmail').textContent = currentUser.email;
        document.getElementById('settingsDisplayName').value = currentUser.user_metadata?.display_name || '';
        
        if (avatar) {
            document.getElementById('settingsAvatar').innerHTML = '<img src="' + avatar + '" alt="">';
            document.getElementById('settingsRemoveBtn').style.display = 'inline-flex';
        } else {
            document.getElementById('settingsInitial').textContent = name.charAt(0).toUpperCase();
            document.getElementById('settingsRemoveBtn').style.display = 'none';
        }
        
        // Populate from Airtable client record
        if (currentUserRecord && currentUserRecord.fields) {
            var f = currentUserRecord.fields;
            document.getElementById('settingsPhone').value = f['Phone'] || '';
            document.getElementById('settingsCalendar').value = f['Google Calendar Email'] || '';
            if (f['Available Start']) document.getElementById('settingsStart').value = f['Available Start'];
            if (f['Available End']) document.getElementById('settingsEnd').value = f['Available End'];
        }
    }

    // Display Name form
    document.getElementById('displayNameForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        var btn = this.querySelector('button');
        var suc = document.getElementById('displaySuccess');
        var err = document.getElementById('displayError');
        suc.textContent = ''; err.textContent = '';
        btn.disabled = true; btn.textContent = 'Saving...';
        
        try {
            var displayName = document.getElementById('settingsDisplayName').value.trim();
            var result = await supabase.auth.updateUser({ data: { display_name: displayName } });
            if (result.error) throw result.error;
            suc.textContent = ' Display name updated';
            document.getElementById('userName').textContent = displayName || currentUser.email.split('@')[0];
            document.getElementById('settingsName').textContent = displayName || currentUser.email.split('@')[0];
        } catch (ex) {
            err.textContent = ex.message || 'Failed to save';
        }
        btn.disabled = false; btn.textContent = 'Save';
    });

    // Calling Preferences form
    document.getElementById('callingPrefsForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        var btn = this.querySelector('button');
        var suc = document.getElementById('callingSuccess');
        var err = document.getElementById('callingError');
        suc.textContent = ''; err.textContent = '';
        btn.disabled = true; btn.textContent = 'Saving...';
        
        try {
            if (!currentUserRecord) throw new Error('No client record found');
            var path = AIRTABLE_BASE + '/' + AIRTABLE_CLIENTS_TABLE + '/' + currentUserRecord.id;
            var response = await fetchAirtable(path, {
                method: 'PATCH',
                body: { fields: {
                    'Phone': document.getElementById('settingsPhone').value,
                    'Google Calendar Email': document.getElementById('settingsCalendar').value,
                    'Available Start': document.getElementById('settingsStart').value,
                    'Available End': document.getElementById('settingsEnd').value
                }}
            });
            if (!response.ok) throw new Error('Failed to update');
            suc.textContent = ' Preferences saved';
        } catch (ex) {
            err.textContent = ex.message || 'Failed to save';
        }
        btn.disabled = false; btn.textContent = 'Save Changes';
    });

    // Password form
    document.getElementById('passwordForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        var btn = this.querySelector('button');
        var suc = document.getElementById('passwordSuccess');
        var err = document.getElementById('passwordError');
        suc.textContent = ''; err.textContent = '';
        
        var currentPass = document.getElementById('currentPassword').value;
        var newPass = document.getElementById('newPassword').value;
        var confirmPass = document.getElementById('confirmNewPassword').value;
        
        if (!currentPass) {
            err.textContent = 'Please enter your current password';
            return;
        }
        if (newPass !== confirmPass) {
            err.textContent = 'New passwords do not match';
            return;
        }
        if (newPass.length < 8) {
            err.textContent = 'New password must be at least 8 characters';
            return;
        }
        if (currentPass === newPass) {
            err.textContent = 'New password must be different from current';
            return;
        }
        
        btn.disabled = true; btn.textContent = 'Verifying...';
        
        try {
            // Verify current password
            var verifyResult = await supabase.auth.signInWithPassword({
                email: currentUser.email,
                password: currentPass
            });
            if (verifyResult.error) throw new Error('Current password is incorrect');
            
            btn.textContent = 'Updating...';
            var result = await supabase.auth.updateUser({ password: newPass });
            if (result.error) throw result.error;
            suc.textContent = ' Password updated successfully';
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmNewPassword').value = '';
        } catch (ex) {
            err.textContent = ex.message || 'Failed to update password';
        }
        btn.disabled = false; btn.textContent = 'Update Password';
    });

    // Photo upload with crop
    var cropper = null;
    var cropModal = document.getElementById('cropModal');
    var cropImage = document.getElementById('cropImage');
    var cropZoom = document.getElementById('cropZoom');

    function openCropModal(imageSrc) {
        cropImage.src = imageSrc;
        cropModal.classList.add('show');

        // Initialize cropper after image loads
        cropImage.onload = function() {
            if (cropper) cropper.destroy();
            cropper = new Cropper(cropImage, {
                aspectRatio: 1,
                viewMode: 1,
                dragMode: 'move',
                autoCropArea: 1,
                cropBoxResizable: false,
                cropBoxMovable: false,
                guides: false,
                center: true,
                background: false,
                ready: function() {
                    cropZoom.value = 1;
                }
            });
        };
    }

    function closeCropModal() {
        cropModal.classList.remove('show');
        if (cropper) {
            cropper.destroy();
            cropper = null;
        }
        document.getElementById('settingsPhotoInput').value = '';
    }

    // Zoom slider
    cropZoom.addEventListener('input', function() {
        if (cropper) {
            cropper.zoomTo(parseFloat(this.value));
        }
    });

    // Close modal handlers
    document.getElementById('cropModalClose').addEventListener('click', closeCropModal);
    document.getElementById('cropCancel').addEventListener('click', closeCropModal);
    cropModal.addEventListener('click', function(e) {
        if (e.target === cropModal) closeCropModal();
    });

    // Confirm crop and upload
    document.getElementById('cropConfirm').addEventListener('click', async function() {
        if (!cropper) return;

        var btn = this;
        btn.disabled = true;
        btn.textContent = 'Uploading...';

        try {
            // Get cropped canvas (200x200)
            var canvas = cropper.getCroppedCanvas({
                width: 200,
                height: 200,
                imageSmoothingEnabled: true,
                imageSmoothingQuality: 'high'
            });

            // Convert to blob
            var blob = await new Promise(function(resolve) {
                canvas.toBlob(resolve, 'image/jpeg', 0.9);
            });

            // Upload to Supabase Storage
            var fileName = 'avatars/' + currentUser.id + '_' + Date.now() + '.jpg';
            var { data: uploadData, error: uploadError } = await supabase.storage
                .from('profile-pictures')
                .upload(fileName, blob, {
                    contentType: 'image/jpeg',
                    upsert: true
                });

            if (uploadError) throw uploadError;

            // Get public URL
            var { data: urlData } = supabase.storage
                .from('profile-pictures')
                .getPublicUrl(fileName);

            var publicUrl = urlData.publicUrl;

            // Delete old avatar if exists
            var oldUrl = currentUser.user_metadata?.profile_picture;
            if (oldUrl && oldUrl.includes('profile-pictures')) {
                var oldPath = oldUrl.split('profile-pictures/')[1];
                if (oldPath) {
                    await supabase.storage.from('profile-pictures').remove([oldPath]);
                }
            }

            // Update user metadata with URL
            var result = await supabase.auth.updateUser({ data: { profile_picture: publicUrl } });
            if (result.error) throw result.error;

            // Update UI
            document.getElementById('settingsAvatar').innerHTML = '<img src="' + publicUrl + '" alt="">';
            document.getElementById('userAvatar').innerHTML = '<img src="' + publicUrl + '" alt="">';
            document.getElementById('settingsRemoveBtn').style.display = 'inline-flex';

            closeCropModal();
            showToast('Photo updated', 'success');
        } catch (ex) {
            console.error('Upload error:', ex);
            showToast('Failed to upload photo: ' + (ex.message || 'Unknown error'), 'error');
        }

        btn.disabled = false;
        btn.textContent = 'Save Photo';
    });

    document.getElementById('settingsUploadBtn').addEventListener('click', function() {
        document.getElementById('settingsPhotoInput').click();
    });

    document.getElementById('settingsPhotoInput').addEventListener('change', function() {
        if (!this.files || !this.files[0]) return;
        var file = this.files[0];
        if (file.size > 5 * 1024 * 1024) {
            showToast('Image too large (max 5MB)', 'error');
            return;
        }

        // Read file and open crop modal
        var reader = new FileReader();
        reader.onload = function(e) {
            openCropModal(e.target.result);
        };
        reader.readAsDataURL(file);
    });

    document.getElementById('settingsRemoveBtn').addEventListener('click', async function() {
        try {
            // Delete from storage if it's a Supabase URL
            var oldUrl = currentUser.user_metadata?.profile_picture;
            if (oldUrl && oldUrl.includes('profile-pictures')) {
                var oldPath = oldUrl.split('profile-pictures/')[1];
                if (oldPath) {
                    await supabase.storage.from('profile-pictures').remove([oldPath]);
                }
            }

            var result = await supabase.auth.updateUser({ data: { profile_picture: null } });
            if (result.error) throw result.error;
            var name = currentUser.user_metadata?.display_name || currentUser.email.split('@')[0];
            document.getElementById('settingsAvatar').innerHTML = '<span id="settingsInitial">' + name.charAt(0).toUpperCase() + '</span>';
            document.getElementById('userAvatar').textContent = name.charAt(0).toUpperCase();
            this.style.display = 'none';
            showToast('Photo removed', 'success');
        } catch (ex) {
            showToast('Failed to remove photo', 'error');
        }
    });

    // Init
    checkAuth().then(function() {
        if (currentUser) {
            loadUserData().then(function() {
                updateSettingsProfile();
                populateBilling();
            });
        } else {
            // Check for signup parameter from main website
            var urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('signup') === 'true') {
                // Small delay to ensure modal elements are ready
                setTimeout(function() {
                    openAuthModal('signup');
                }, 100);
                // Clean up URL
                window.history.replaceState({}, '', window.location.pathname);
            }
        }
    }).catch(function(err) {
        console.error('App initialization failed:', err);
        window.__showErrorFallback();
    });

    // Handle hash - support deep links to leads (#lead/recXXX, #search/recXXX)
    var hash = window.location.hash.slice(1);
    var pendingLeadDeepLink = null;
    if (hash.startsWith('lead/')) {
        pendingLeadDeepLink = { type: 'modal', id: hash.split('/')[1] };
        // Don't switch page - the modal opens on top of the current view
    } else if (hash.startsWith('search/')) {
        pendingLeadDeepLink = { type: 'search', id: hash.split('/')[1] };
        switchPage('search');
    } else if (hash && document.getElementById('page-' + hash)) {
        switchPage(hash);
    }

    // Handle browser back/forward for lead URLs
    window.addEventListener('popstate', function(e) {
        var h = window.location.hash.slice(1);
        if (h.startsWith('lead/')) {
            var id = h.split('/')[1];
            if (id && allLeads.length > 0) openLeadModal(id);
        } else if (h.startsWith('search/')) {
            var id = h.split('/')[1];
            switchPage('search');
            if (id && allLeads.length > 0) {
                var lead = allLeads.find(function(l) { return l.id === id; });
                if (lead) showSearchLeadDetail(lead);
            }
        } else {
            // Close any open modal
            if (leadModal.classList.contains('active')) {
                leadModal.classList.remove('active');
                currentLeadId = null;
            }
            if (h && document.getElementById('page-' + h)) {
                switchPage(h);
            }
        }
    });
    
    // === HELP SECTION ===
    // Category accordions
    document.querySelectorAll('.help-category-header').forEach(function(header) {
        header.addEventListener('click', function() {
            this.parentElement.classList.toggle('open');
        });
    });
    
    // Item accordions
    document.querySelectorAll('.help-item-header').forEach(function(header) {
        header.addEventListener('click', function() {
            this.parentElement.classList.toggle('open');
        });
    });
    
    // Quick links
    document.querySelectorAll('.help-quick-link').forEach(function(link) {
        link.addEventListener('click', function() {
            var topic = this.dataset.topic;
            var category = document.querySelector('.help-category[data-category="' + topic + '"]');
            if (category) {
                category.classList.add('open');
                category.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        });
    });
    
    // Help search
    var helpSearchInput = document.getElementById('helpSearchInput');
    if (helpSearchInput) {
        helpSearchInput.addEventListener('input', function() {
            var query = this.value.toLowerCase().trim();
            var categories = document.querySelectorAll('.help-category');
            
            if (!query) {
                categories.forEach(function(cat) { cat.style.display = ''; cat.classList.remove('open'); });
                return;
            }
            
            categories.forEach(function(cat) {
                var text = cat.textContent.toLowerCase();
                if (text.includes(query)) {
                    cat.style.display = '';
                    cat.classList.add('open');
                } else {
                    cat.style.display = 'none';
                }
            });
        });
    }
    
    // === BILLING SECTION ===
    // Populate billing data
    function populateBilling() {
        if (!currentUserRecord) return;
        var f = currentUserRecord.fields;
        
        var plan = f['Monthly Plan'] || 'Starter';
        var rate = parseFloat(f['Monthly Rate']) || 0;
        var callLimit = dynamicCallLimit || parseInt(f['Call Limit']) || 1000;
        var callsUsed = parseInt(f['Calls This Month']) || 0;
        var status = f['Status'] || 'Active';
        
        var planNameEl = document.getElementById('billingPlanName');
        var planPriceEl = document.getElementById('billingPlanPrice');
        var callLimitEl = document.getElementById('billingCallLimit');
        var statusEl = document.getElementById('billingPlanStatus');
        var nextDateEl = document.getElementById('billingNextDate');
        var usageCallsEl = document.getElementById('billingUsageCalls');
        var usageLimitEl = document.getElementById('billingUsageLimit');
        var usagePercentEl = document.getElementById('billingUsagePercent');
        var usageFillEl = document.getElementById('billingUsageFill');
        
        if (planNameEl) planNameEl.textContent = plan;
        if (planPriceEl) planPriceEl.textContent = rate > 0 ? '$' + rate : 'Free';
        if (callLimitEl) callLimitEl.textContent = callLimit.toLocaleString() + ' calls/mo';
        if (statusEl) {
            statusEl.textContent = status;
            statusEl.className = 'billing-status-badge ' + status.toLowerCase();
        }
        if (nextDateEl) nextDateEl.textContent = rate > 0 ? 'Contact support' : 'N/A';
        if (usageCallsEl) usageCallsEl.textContent = callsUsed.toLocaleString();
        if (usageLimitEl) usageLimitEl.textContent = callLimit.toLocaleString();
        
        var usagePercent = callLimit > 0 ? Math.round((callsUsed / callLimit) * 100) : 0;
        if (usagePercentEl) usagePercentEl.textContent = usagePercent + '%';
        if (usageFillEl) {
            usageFillEl.style.width = Math.min(usagePercent, 100) + '%';
            if (usagePercent >= 100) usageFillEl.style.background = 'linear-gradient(90deg,#ef4444,#dc2626)';
            else if (usagePercent >= 80) usageFillEl.style.background = 'linear-gradient(90deg,#f59e0b,#d97706)';
        }
    }
    
    // Billing buttons
    var manageBillingBtn = document.getElementById('manageBillingBtn');
    if (manageBillingBtn) {
        manageBillingBtn.addEventListener('click', function() {
            window.open('mailto:info@prioai.ca?subject=Subscription Inquiry', '_blank');
        });
    }
    var updatePaymentBtn = document.getElementById('updatePaymentBtn');
    if (updatePaymentBtn) {
        updatePaymentBtn.addEventListener('click', function() {
            window.open('mailto:info@prioai.ca?subject=Update Payment Method', '_blank');
        });
    }
    var viewAllInvoicesBtn = document.getElementById('viewAllInvoicesBtn');
    if (viewAllInvoicesBtn) {
        viewAllInvoicesBtn.addEventListener('click', function() {
            window.open('mailto:info@prioai.ca?subject=Invoice Request', '_blank');
        });
    }
    var downloadReceiptBtn = document.getElementById('downloadReceiptBtn');
    if (downloadReceiptBtn) {
        downloadReceiptBtn.addEventListener('click', function() {
            window.open('mailto:info@prioai.ca?subject=Receipt Request', '_blank');
        });
    }
    var upgradePlanBtn = document.getElementById('upgradePlanBtn');
    if (upgradePlanBtn) {
        upgradePlanBtn.addEventListener('click', function() {
            window.location.href = '/pricing/';
        });
    }
    
    // === LEAD DETAIL MODAL ===
    var currentLeadId = null;
    var leadModal = document.getElementById('leadModal');
    
    // Open modal when clicking PRIO card
    document.getElementById('prioList').addEventListener('click', function(e) {
        var card = e.target.closest('.prio-card');
        if (card) {
            var leadId = card.dataset.id;
            openLeadModal(leadId);
        }
    });
    
    function openLeadModal(leadId) {
        var lead = allLeads.find(function(l) { return l.id === leadId; });
        if (!lead) return;
        
        currentLeadId = leadId;
        var f = lead.fields;
        
        // Populate modal
        var name = ((f['First Name'] || '') + ' ' + (f['Last Name'] || '')).trim() || 'Unknown';
        document.getElementById('modalLeadName').textContent = name;
        var modalRawPhone = f['Phone #'] || f['Phone'] || '-';
        var modalFormattedPhone = formatPhoneNumber(modalRawPhone);
        document.getElementById('modalPhone').innerHTML = phoneLink(modalRawPhone, modalFormattedPhone);
        
        var status = f['Status'] || f['Outcome'] || 'New';
        var statusSelect = document.getElementById('modalStatusSelect');
        if (statusSelect) {
            var hasOption = Array.from(statusSelect.options).some(function(opt) { return opt.value === status; });
            if (!hasOption && status !== '-') {
                var newOpt = document.createElement('option');
                newOpt.value = status;
                newOpt.textContent = status;
                statusSelect.appendChild(newOpt);
            }
            statusSelect.value = status;
        }
        syncStatusDropdownDisplay(status);

        var lastUpdated = f['Updated At'];
        document.getElementById('modalLastCalled').textContent = lastUpdated ? formatTimeAgo(lastUpdated) : 'Never';

        // Booked Time with reschedule/delete buttons
        var bookedTime = f['Booked Time'];
        var bookedTimeContainer = document.getElementById('modalBookedTime');
        var bookedTimeValue = document.getElementById('modalBookedTimeValue');
        var scheduleBtn = document.getElementById('modalScheduleBtn');
        if (bookedTime) {
            bookedTimeValue.innerHTML = '<span class="booked-time-display"><span class="booked-time-value">' + formatFriendlyDateTime(bookedTime) + '</span><button class="btn-reschedule" onclick="editBookingFromModal()" title="Reschedule">Reschedule</button><button class="btn-delete-booking" onclick="deleteBookingFromModal()" title="Remove booking"></button></span>';
            scheduleBtn.style.display = 'none';
        } else {
            bookedTimeValue.textContent = '';
            scheduleBtn.style.display = 'inline-flex';
        }

        // Last AI Call Date - badge beside AI Summary heading
        var lastAICall = f['Last Call Timestamp'];
        var aiCallDateEl = document.getElementById('modalAICallDate');
        if (aiCallDateEl) {
            aiCallDateEl.textContent = lastAICall ? formatDateTime(lastAICall) : '';
        }
        // B/C badge for Booked or Callback
        var aiBadgeEl = document.getElementById('modalAIStatusBadge');
        if (aiBadgeEl) {
            var leadStatus = (f['Status'] || f['Outcome'] || '').toLowerCase();
            if (leadStatus.includes('booked')) {
                aiBadgeEl.className = 'ai-status-badge';
                aiBadgeEl.style.display = 'inline-flex';
                aiBadgeEl.style.background = 'rgba(52,211,153,0.15)';
                aiBadgeEl.style.color = '#34D399';
                aiBadgeEl.textContent = 'B';
                aiBadgeEl.title = 'Meeting Booked';
            } else if (leadStatus.includes('callback')) {
                aiBadgeEl.className = 'ai-status-badge';
                aiBadgeEl.style.display = 'inline-flex';
                aiBadgeEl.style.background = 'rgba(249,115,22,0.15)';
                aiBadgeEl.style.color = '#F97316';
                aiBadgeEl.textContent = 'C';
                aiBadgeEl.title = 'Callback Requested';
            } else {
                aiBadgeEl.style.display = 'none';
            }
        }

        document.getElementById('modalSummary').textContent = f['Last Call Summary'] || f['Summary'] || 'No summary available';

        // Share button state
        var shareBtn = document.getElementById('modalShareBtn');
        var sharedWithEmail = f['Shared With Email'];
        if (Array.isArray(sharedWithEmail)) sharedWithEmail = sharedWithEmail[0] || '';
        var isSharedToUser = lead.isShared;

        if (sharedWithEmail || isSharedToUser) {
            if (shareBtn) shareBtn.classList.add('shared');
            if (isSharedToUser) {
                var ownerEmail = f['Client Email'];
                if (Array.isArray(ownerEmail)) ownerEmail = ownerEmail[0] || '';
                var sharedByName = getAgentNameByEmail(ownerEmail) || ownerEmail || 'Unknown';
                if (shareBtn) shareBtn.innerHTML = ' Shared by ' + sharedByName;
            } else {
                var sharedWithName = getAgentNameByEmail(sharedWithEmail) || sharedWithEmail || 'Unknown';
                if (shareBtn) shareBtn.innerHTML = ' Shared with ' + sharedWithName;
            }
        } else {
            if (shareBtn) {
                shareBtn.classList.remove('shared');
                shareBtn.innerHTML = ' Share';
            }
        }
        
        // Notes with edit/delete - using JSON array format
        var notesRaw = f['Client Notes'] || f['Notes'] || '';
        var notesList = document.getElementById('modalNotesList');
        var notesArr = parseNotesJson(notesRaw);
        if (notesArr.length > 0) {
            notesList.innerHTML = notesArr.map(function(note, idx) {
                var dateStr = note.date ? formatNoteDate(note.date) : '';
                return '<div class="lead-note-item" data-note-index="' + idx + '">' +
                    '<div class="note-content">' + escapeHtml(note.text) + '</div>' +
                    (dateStr ? '<div class="note-date">' + dateStr + '</div>' : '') +
                    '<div class="note-actions"><button class="btn-edit-note" onclick="editNote(' + idx + ')" title="Edit"></button><button class="btn-delete-note" onclick="deleteNote(' + idx + ')" title="Delete"></button></div>' +
                '</div>';
            }).join('');
        } else {
            notesList.innerHTML = '<p style="color:rgba(255,255,255,0.4);font-size:0.8125rem;">No notes yet</p>';
        }
        document.getElementById('modalNotesInput').value = '';
        
        // Attempts - parse JSON if available
        var attemptsRaw = f['Client Attempts'] || '[]';
        var attemptsArray = [];
        try {
            if (typeof attemptsRaw === 'string') {
                attemptsArray = JSON.parse(attemptsRaw);
            } else if (Array.isArray(attemptsRaw)) {
                attemptsArray = attemptsRaw;
            }
        } catch (e) {
            attemptsArray = [];
        }
        var attemptsCount = Array.isArray(attemptsArray) ? attemptsArray.length : 0;
        updateCallAttemptsSection(attemptsCount);
        if (attemptsCount > 0) {
            var countEl = document.getElementById('modalAttemptsCount');
            if (countEl) countEl.textContent = attemptsCount;
            var attemptsList = document.getElementById('modalAttemptsList');
            var attemptsHtml = attemptsArray.map(function(attempt, i) {
                var timeStr = attempt.time ? formatFriendlyDateTime(attempt.time) : 'Unknown time';
                return '<div class="lead-attempt-item"><span>Call Attempt #' + (i + 1) + '</span><span style="display:flex;align-items:center;gap:8px;"><span style="color:rgba(255,255,255,0.5);font-size:0.8125rem;">' + timeStr + '</span><button class="btn-delete-attempt" onclick="deleteCallAttempt(' + i + ')" title="Delete"></button></span></div>';
            }).join('');
            if (attemptsList) attemptsList.innerHTML = attemptsHtml;
        }

        // Transcript with colored speakers
        var transcript = f['Transcript (from Calls)'];
        var transcriptEl = document.getElementById('modalTranscript');
        if (transcript && transcript.length) {
            var transcriptText = transcript[0];
            var formattedTranscript = formatTranscript(transcriptText, name);
            transcriptEl.innerHTML = formattedTranscript;
        } else {
            transcriptEl.textContent = 'No transcript available';
        }
        
        // PRIO button state and icon
        var prioBtn = document.getElementById('modalPrioBtn');
        var prioIcon = document.getElementById('modalPrioIcon');
        if (f['Is Prio']) {
            prioBtn.classList.add('active');
            prioBtn.textContent = ' PRIO';
            prioIcon.style.display = 'block';
        } else {
            prioBtn.classList.remove('active');
            prioBtn.textContent = ' Mark PRIO';
            prioIcon.style.display = 'none';
        }

        // Show/hide Send to AI vs Take Over based on lead status
        var sendBackBtn = document.getElementById('modalSendBackBtn');
        var takeOverBtn = document.getElementById('modalTakeOverBtn');
        var isPipelineLead = status === 'Timeline' || status === 'Follow Up';
        if (isPipelineLead) {
            sendBackBtn.style.display = 'none';
            takeOverBtn.style.display = 'inline-block';
        } else {
            sendBackBtn.style.display = 'inline-block';
            takeOverBtn.style.display = 'none';
        }

        leadModal.classList.add('active');

        // Update navigation arrows state
        updateNavArrows();

        // Auto-focus notes textbox after modal animation
        setTimeout(function() {
            var notesInput = document.getElementById('modalNotesInput');
            if (notesInput) {
                notesInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                notesInput.focus();
            }
        }, 300);
    }

    // Check for unsaved notes before closing
    function hasUnsavedNotes() {
        var notesInput = document.getElementById('modalNotesInput');
        return notesInput && notesInput.value.trim().length > 0;
    }

    async function closeLeadModalWithCheck() {
        if (hasUnsavedNotes()) {
            var keepEditing = await showConfirmModal(
                'Unsaved Changes',
                'You have unsaved notes. Are you sure you want to discard them?',
                '',
                false,
                'Keep Editing',
                'Exit'
            );
            if (keepEditing) return;
            // Clear the notes if user chose to exit
            document.getElementById('modalNotesInput').value = '';
        }
        leadModal.classList.remove('active');
        currentLeadId = null;
        // Restore URL to current page hash
        var currentPage = document.querySelector('.page:not(.hidden)');
        if (currentPage) {
            var pageId = currentPage.id.replace('page-', '');
            history.pushState(null, '', '#' + pageId);
        }
    }

    // Close modal
    document.getElementById('leadModalClose').addEventListener('click', function() {
        closeLeadModalWithCheck();
    });
    leadModal.addEventListener('click', function(e) {
        if (e.target === leadModal) {
            closeLeadModalWithCheck();
        }
    });

    // Modal navigation - get current list of visible leads
    function getCurrentLeadsList() {
        // Determine which page we're on and get the appropriate list
        var activePage = document.querySelector('.page:not(.hidden)');
        if (!activePage) return [];

        var pageId = activePage.id;
        var leads = [];

        if (pageId === 'page-overview' || pageId === 'page-prio') {
            // Get leads from prio list
            leads = allLeads.filter(function(l) {
                return l.fields['Is Prio'] === true;
            });
        } else if (pageId === 'page-prospects') {
            // Get all non-pipeline leads
            leads = allLeads.filter(function(l) {
                var status = l.fields['Status'] || l.fields['Disposition'] || '';
                return status !== 'Timeline' && status !== 'Follow Up';
            });
        } else if (pageId === 'page-pipeline') {
            // Get pipeline leads
            leads = allLeads.filter(function(l) {
                var status = l.fields['Status'] || l.fields['Disposition'] || '';
                return status === 'Timeline' || status === 'Follow Up';
            });
        } else if (pageId === 'page-shared') {
            // Get shared leads (either shared with me or I shared it)
            leads = allLeads.filter(function(l) {
                return l.isShared || l.fields['Shared With Email'];
            });
        } else {
            // Default to all leads
            leads = allLeads;
        }

        return leads;
    }

    function navigateModal(direction) {
        if (!currentLeadId) return;

        var leads = getCurrentLeadsList();
        if (leads.length === 0) return;

        var currentIndex = leads.findIndex(function(l) { return l.id === currentLeadId; });
        if (currentIndex === -1) return;

        var newIndex = currentIndex + direction;
        if (newIndex < 0 || newIndex >= leads.length) return;

        // Check for unsaved notes before navigating
        if (hasUnsavedNotes()) {
            showConfirmModal(
                'Unsaved Changes',
                'You have unsaved notes. Are you sure you want to discard them?',
                '',
                false,
                'Keep Editing',
                'Discard'
            ).then(function(keepEditing) {
                if (!keepEditing) {
                    document.getElementById('modalNotesInput').value = '';
                    openLeadModal(leads[newIndex].id);
                }
            });
            return;
        }

        openLeadModal(leads[newIndex].id);
    }

    function updateNavArrows() {
        var leads = getCurrentLeadsList();
        var currentIndex = leads.findIndex(function(l) { return l.id === currentLeadId; });

        var prevBtn = document.getElementById('modalNavPrev');
        var nextBtn = document.getElementById('modalNavNext');

        if (prevBtn) prevBtn.disabled = currentIndex <= 0;
        if (nextBtn) nextBtn.disabled = currentIndex >= leads.length - 1 || currentIndex === -1;
    }

    // Nav arrow click handlers
    document.getElementById('modalNavPrev')?.addEventListener('click', function() {
        navigateModal(-1);
    });
    document.getElementById('modalNavNext')?.addEventListener('click', function() {
        navigateModal(1);
    });

    // Keyboard navigation
    document.addEventListener('keydown', function(e) {
        if (!leadModal.classList.contains('active')) return;

        // Don't navigate if typing in an input
        var activeEl = document.activeElement;
        if (activeEl && (activeEl.tagName === 'INPUT' || activeEl.tagName === 'TEXTAREA' || activeEl.tagName === 'SELECT')) {
            // Allow ESC to blur the input
            if (e.key === 'Escape') {
                activeEl.blur();
            }
            return;
        }

        if (e.key === 'ArrowLeft') {
            e.preventDefault();
            navigateModal(-1);
        } else if (e.key === 'ArrowRight') {
            e.preventDefault();
            navigateModal(1);
        } else if (e.key === 'Escape') {
            e.preventDefault();
            closeLeadModalWithCheck();
        }
    });
    
    // Status dropdown - custom UI
    var statusColors = {
        'Booked': '#34D399', 'Retry': '#F59E0B', 'Callback Rescheduled': '#F97316',
        'Meeting in Person': '#10B981', 'Sending Listings': '#14B8A6', 'Listings Sent': '#0EA5E9',
        'Scheduling Showings': '#06B6D4', 'Viewed Properties': '#A78BFA',
        'Offer Placed': '#8B5CF6', 'Deal Closed': '#22C55E'
    };
    var statusLabels = {
        'Booked': 'Meeting Booked', 'Retry': 'Retrying', 'Callback Rescheduled': 'Callback Rescheduled',
        'Meeting in Person': 'Meeting in Person', 'Sending Listings': 'Sending Listings', 'Listings Sent': 'Listings Sent',
        'Scheduling Showings': 'Scheduling Showings', 'Viewed Properties': 'Viewed Properties',
        'Offer Placed': 'Offer Placed', 'Deal Closed': 'Deal Closed'
    };

    function getStatusColor(status) { return statusColors[status] || '#6B7280'; }
    function getStatusLabel(status) { return statusLabels[status] || status; }

    function buildStatusDropdownMenu() {
        var menu = document.getElementById('statusDropdownMenu');
        if (!menu) return;
        var select = document.getElementById('modalStatusSelect');
        var currentVal = select ? select.value : '';
        menu.innerHTML = '';
        var options = select ? Array.from(select.options) : [];
        options.forEach(function(opt) {
            var btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'status-option' + (opt.value === currentVal ? ' selected' : '');
            btn.innerHTML = '<span class="status-dot" style="background:' + getStatusColor(opt.value) + '"></span>' + escapeHtml(opt.textContent);
            btn.onclick = function() { selectStatus(opt.value); };
            menu.appendChild(btn);
        });
    }

    function syncStatusDropdownDisplay(status) {
        var dot = document.getElementById('statusDot');
        var label = document.getElementById('statusDropdownLabel');
        if (dot) dot.style.background = getStatusColor(status);
        if (label) label.textContent = getStatusLabel(status);
    }

    function toggleStatusDropdown() {
        var trigger = document.getElementById('statusDropdownTrigger');
        var menu = document.getElementById('statusDropdownMenu');
        if (!trigger || !menu) return;
        var isOpen = menu.classList.contains('open');
        if (isOpen) {
            menu.classList.remove('open');
            trigger.classList.remove('open');
        } else {
            buildStatusDropdownMenu();
            menu.classList.add('open');
            trigger.classList.add('open');
        }
    }
    window.toggleStatusDropdown = toggleStatusDropdown;

    async function selectStatus(val) {
        var menu = document.getElementById('statusDropdownMenu');
        var trigger = document.getElementById('statusDropdownTrigger');
        if (menu) menu.classList.remove('open');
        if (trigger) trigger.classList.remove('open');

        var select = document.getElementById('modalStatusSelect');
        if (select) select.value = val;
        syncStatusDropdownDisplay(val);

        if (!currentLeadId) return;
        // Only update locally  status syncs to Airtable only from backend actions
        var lead = allLeads.find(function(l) { return l.id === currentLeadId; });
        if (lead) lead.fields['Status'] = val;
        showToast('Status updated', 'success');
        updatePrioList();
        updateProspectsTable();
    }

    // Close status dropdown when clicking outside
    document.addEventListener('click', function(e) {
        var wrapper = document.getElementById('statusDropdownWrapper');
        if (wrapper && !wrapper.contains(e.target)) {
            var menu = document.getElementById('statusDropdownMenu');
            var trigger = document.getElementById('statusDropdownTrigger');
            if (menu) menu.classList.remove('open');
            if (trigger) trigger.classList.remove('open');
        }
        // Close any open card status menus
        document.querySelectorAll('.card-status-menu.open').forEach(function(m) {
            if (!m.parentElement.contains(e.target)) m.classList.remove('open');
        });
    });

    // Build card status column HTML
    function getCardStatusHtml(lead) {
        var f = lead.fields;
        var status = f['Status'] || f['Disposition'] || f['Outcome'] || 'New';
        var color = getStatusColor(status);
        var label = getStatusLabel(status);
        return '<div class="priority-card-lg-status-col" onclick="if(!event.target.closest(\'.card-status-trigger\')&&!event.target.closest(\'.card-status-menu\'))openLeadModal(\'' + lead.id + '\')">' +
            '<div class="col-label">Status</div>' +
            '<div style="position:relative;width:100%">' +
                '<button type="button" class="card-status-trigger" onclick="event.stopPropagation();toggleCardStatus(this,\'' + lead.id + '\')">' +
                    '<span class="status-dot" style="background:' + color + '"></span>' +
                    '<span class="card-status-label">' + escapeHtml(label) + '</span>' +
                '</button>' +
                '<div class="card-status-menu"></div>' +
            '</div>' +
        '</div>';
    }

    var allStatusOptions = [
        {value:'Booked',label:'Meeting Booked'},{value:'Retry',label:'Retrying'},
        {value:'Callback Rescheduled',label:'Callback Rescheduled'},{value:'Meeting in Person',label:'Meeting in Person'},
        {value:'Sending Listings',label:'Sending Listings'},{value:'Listings Sent',label:'Listings Sent'},
        {value:'Scheduling Showings',label:'Scheduling Showings'},{value:'Viewed Properties',label:'Viewed Properties'},
        {value:'Offer Placed',label:'Offer Placed'},{value:'Deal Closed',label:'Deal Closed'}
    ];

    function toggleCardStatus(triggerEl, leadId) {
        // Use a single portal menu on document.body to avoid overflow/transform clipping
        var portal = document.getElementById('cardStatusPortal');
        if (!portal) {
            portal = document.createElement('div');
            portal.id = 'cardStatusPortal';
            portal.className = 'card-status-menu';
            document.body.appendChild(portal);
        }
        // Close all other inline menus
        document.querySelectorAll('.card-status-menu.open').forEach(function(m) {
            m.classList.remove('open');
        });
        // If clicking same trigger again, just close
        if (portal._currentLead === leadId && portal.classList.contains('open')) {
            portal.classList.remove('open');
            portal._currentLead = null;
            return;
        }
        var lead = allLeads.find(function(l) { return l.id === leadId; });
        var currentStatus = lead ? (lead.fields['Status'] || lead.fields['Disposition'] || 'New') : 'New';
        portal.innerHTML = '<div class="status-popup-grid">' + allStatusOptions.map(function(opt) {
            return '<button type="button" class="status-option' + (opt.value === currentStatus ? ' selected' : '') + '" onclick="selectCardStatus(\'' + leadId + '\',\'' + opt.value + '\',this)">' +
                '<span class="status-dot" style="background:' + getStatusColor(opt.value) + '"></span><span>' + escapeHtml(opt.label) + '</span>' +
            '</button>';
        }).join('') + '</div>';
        portal._currentLead = leadId;
        portal._triggerEl = triggerEl;
        // Position popup centered on trigger
        var rect = triggerEl.getBoundingClientRect();
        var popupW = 360;
        var left = rect.left + (rect.width / 2) - (popupW / 2);
        if (left < 8) left = 8;
        if (left + popupW > window.innerWidth - 8) left = window.innerWidth - popupW - 8;
        var top = rect.bottom + 6;
        if (top + 200 > window.innerHeight) top = rect.top - 210;
        portal.style.top = top + 'px';
        portal.style.left = left + 'px';
        portal.classList.add('open');
    }
    window.toggleCardStatus = toggleCardStatus;

    // Close card status menu when scrolling or clicking outside
    document.addEventListener('scroll', function() {
        var portal = document.getElementById('cardStatusPortal');
        if (portal) { portal.classList.remove('open'); portal._currentLead = null; }
    }, true);
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.card-status-trigger') && !e.target.closest('#cardStatusPortal')) {
            var portal = document.getElementById('cardStatusPortal');
            if (portal) { portal.classList.remove('open'); portal._currentLead = null; }
        }
    });

    function selectCardStatus(leadId, newStatus, btnEl) {
        // Close portal menu
        var portal = document.getElementById('cardStatusPortal');
        if (portal) {
            portal.classList.remove('open');
            // Update trigger display via the stored trigger reference
            var triggerEl = portal._triggerEl;
            if (triggerEl) {
                var wrapper = triggerEl.closest('.priority-card-lg-status-col');
                if (wrapper) {
                    var dot = wrapper.querySelector('.card-status-trigger .status-dot');
                    var label = wrapper.querySelector('.card-status-label');
                    if (dot) dot.style.background = getStatusColor(newStatus);
                    if (label) label.textContent = getStatusLabel(newStatus);
                }
            }
            portal._currentLead = null;
        }
        // Only update locally  status syncs to Airtable only from backend actions
        var lead = allLeads.find(function(l) { return l.id === leadId; });
        if (lead) lead.fields['Status'] = newStatus;
        showToast('Status updated', 'success');
        // If modal is open for this lead, sync the modal dropdown too
        if (currentLeadId === leadId) {
            var modalSelect = document.getElementById('modalStatusSelect');
            if (modalSelect) modalSelect.value = newStatus;
            syncStatusDropdownDisplay(newStatus);
        }
    }
    window.selectCardStatus = selectCardStatus;

    // Save note
    document.getElementById('modalSaveNoteBtn').addEventListener('click', async function() {
        if (!currentLeadId) return;
        var noteText = document.getElementById('modalNotesInput').value.trim();
        if (!noteText) return;

        var btn = this;
        btn.disabled = true;
        btn.textContent = 'Saving...';

        try {
            var lead = allLeads.find(function(l) { return l.id === currentLeadId; });
            var existingNotesRaw = lead.fields['Client Notes'] || '';
            var notesArray = parseNotesJson(existingNotesRaw);
            notesArray.push({ text: noteText, date: new Date().toISOString() });
            var newNotes = JSON.stringify(notesArray);

            await fetchAirtable(AIRTABLE_BASE + '/' + AIRTABLE_LEADS_TABLE + '/' + currentLeadId, {
                method: 'PATCH',
                body: { fields: { 'Client Notes': newNotes } }
            });

            lead.fields['Client Notes'] = newNotes;
            lead.fields['Updated At'] = new Date().toISOString(); // Update timestamp live
            document.getElementById('modalNotesInput').value = '';
            openLeadModal(currentLeadId); // Refresh modal
            updateLeadCardDisplay(currentLeadId); // Update card live
            showToast('Note saved', 'success');
        } catch (err) {
            showToast('Failed to save note', 'error');
        }
        btn.disabled = false;
        btn.textContent = ' Save';
    });

    // === VOICE INPUT ===
    var voiceRecognition = null;
    var isRecording = false;

    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        var SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        voiceRecognition = new SpeechRecognition();
        voiceRecognition.continuous = true;
        voiceRecognition.interimResults = false;
        voiceRecognition.lang = 'en-US';

        voiceRecognition.onresult = function(event) {
            var transcript = '';
            for (var i = event.resultIndex; i < event.results.length; i++) {
                if (event.results[i].isFinal) {
                    transcript += event.results[i][0].transcript;
                }
            }
            if (transcript) {
                var input = document.getElementById('modalNotesInput');
                var currentText = input.value;
                input.value = currentText + (currentText ? ' ' : '') + transcript.trim();
            }
        };

        voiceRecognition.onerror = function(event) {
            console.error('Voice error:', event.error);
            stopVoiceRecording();
            if (event.error === 'not-allowed') {
                showToast('Microphone access denied. Please enable in browser settings.', 'error');
            }
        };

        voiceRecognition.onend = function() {
            if (isRecording) {
                voiceRecognition.start();
            }
        };
    }

    async function startVoiceRecording() {
        if (!voiceRecognition) {
            showToast('Voice input not supported in this browser', 'error');
            return;
        }

        // First request microphone permission explicitly
        try {
            var stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            // Permission granted - stop the stream immediately, we just needed the permission
            stream.getTracks().forEach(function(track) { track.stop(); });
        } catch (permErr) {
            console.error('Microphone permission error:', permErr);
            if (permErr.name === 'NotAllowedError' || permErr.name === 'PermissionDeniedError') {
                showToast('Microphone access denied. Please allow microphone in browser settings.', 'error');
            } else if (permErr.name === 'NotFoundError') {
                showToast('No microphone found. Please connect a microphone.', 'error');
            } else {
                showToast('Failed to access microphone: ' + permErr.message, 'error');
            }
            return;
        }

        var input = document.getElementById('modalNotesInput');
        input.dataset.baseText = input.value;
        document.getElementById('voiceInputBtn').classList.add('recording');
        isRecording = true;
        try {
            voiceRecognition.start();
            showToast('Listening... Speak now', 'success');
        } catch (err) {
            console.error('Voice start error:', err);
            stopVoiceRecording();
            showToast('Failed to start voice input. Please check microphone permissions.', 'error');
        }
    }

    function stopVoiceRecording() {
        isRecording = false;
        document.getElementById('voiceInputBtn').classList.remove('recording');
        if (voiceRecognition) {
            voiceRecognition.stop();
        }
        var input = document.getElementById('modalNotesInput');
        delete input.dataset.baseText;
    }

    document.getElementById('voiceInputBtn').addEventListener('click', async function() {
        if (isRecording) {
            stopVoiceRecording();
        } else {
            await startVoiceRecording();
        }
    });

    // === POLISH NOTES WITH AI ===
    var POLISH_NOTES_ENDPOINT = 'https://n8n.prioai.ca/webhook/clean-notes';
    var polishedText = '';

    document.getElementById('polishNotesBtn').addEventListener('click', async function() {
        if (!currentLeadId) return;
        var noteText = document.getElementById('modalNotesInput').value.trim();
        if (!noteText) {
            showToast('Please enter a note first', 'warning');
            return;
        }
        if (noteText.length < 10) {
            showToast('Note too short to polish', 'warning');
            return;
        }

        var btn = this;
        btn.disabled = true;
        btn.innerHTML = ' Polishing...';

        try {
            // Polish the note
            var response = await fetch(POLISH_NOTES_ENDPOINT, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ notes: noteText })
            });

            if (!response.ok) {
                throw new Error('Polish API error: ' + response.status);
            }

            var data = await response.json();
            if (data.polished || data.cleaned || data.result) {
                var polishedNote = data.polished || data.cleaned || data.result;

                // Auto-save the polished note
                btn.innerHTML = ' Saving...';
                var lead = allLeads.find(function(l) { return l.id === currentLeadId; });
                var existingNotesRaw = lead.fields['Client Notes'] || '';
                var notesArray = parseNotesJson(existingNotesRaw);
                notesArray.push({ text: polishedNote, date: new Date().toISOString() });
                var newNotes = JSON.stringify(notesArray);

                await fetchAirtable(AIRTABLE_BASE + '/' + AIRTABLE_LEADS_TABLE + '/' + currentLeadId, {
                    method: 'PATCH',
                    body: { fields: { 'Client Notes': newNotes } }
                });

                lead.fields['Client Notes'] = newNotes;
                lead.fields['Updated At'] = new Date().toISOString();
                document.getElementById('modalNotesInput').value = '';
                openLeadModal(currentLeadId);
                updateLeadCardDisplay(currentLeadId);
                showToast('Note polished and saved!', 'success');
            } else {
                throw new Error(data.error || 'Failed to polish notes');
            }
        } catch (err) {
            console.error('Polish error:', err);
            showToast('Polish failed: ' + err.message, 'error');
        }
        btn.disabled = false;
        btn.innerHTML = ' Polish & Save';
    });

    // Log call attempt handler
    async function handleLogAttempt(btn) {
        if (!currentLeadId) return;
        btn.disabled = true;
        btn.textContent = 'Logging...';

        try {
            var lead = allLeads.find(function(l) { return l.id === currentLeadId; });
            var attemptsRaw = lead.fields['Client Attempts'] || '[]';
            var attemptsArray = [];
            try {
                attemptsArray = typeof attemptsRaw === 'string' ? JSON.parse(attemptsRaw) : (Array.isArray(attemptsRaw) ? attemptsRaw : []);
            } catch (e) {
                attemptsArray = [];
            }

            // Add new attempt with current timestamp
            attemptsArray.push({ time: new Date().toISOString(), note: '' });

            await fetchAirtable(AIRTABLE_BASE + '/' + AIRTABLE_LEADS_TABLE + '/' + currentLeadId, {
                method: 'PATCH',
                body: { fields: { 'Client Attempts': JSON.stringify(attemptsArray) } }
            });

            lead.fields['Client Attempts'] = JSON.stringify(attemptsArray);
            lead.fields['Updated At'] = new Date().toISOString(); // Update timestamp live
            openLeadModal(currentLeadId);
            updateLeadCardDisplay(currentLeadId); // Update card live
            showToast('Call attempt logged', 'success');
        } catch (err) {
            console.error('Log attempt error:', err);
            showToast('Failed to log call: ' + err.message, 'error');
        }
        btn.disabled = false;
        btn.textContent = '+ Log Call Attempt';
    }

    window.bindLogAttemptBtn = function(btn) {
        btn.addEventListener('click', function() { handleLogAttempt(this); });
    };

    var initialLogBtn = document.getElementById('modalLogAttemptBtn');
    if (initialLogBtn) window.bindLogAttemptBtn(initialLogBtn);
    
    // Unprio from table
    async function unprio(leadId) {
        try {
            await fetchAirtable(AIRTABLE_BASE + '/' + AIRTABLE_LEADS_TABLE + '/' + leadId, {
                method: 'PATCH',
                body: { fields: { 'Is Prio': false } }
            });
            var lead = allLeads.find(function(l) { return l.id === leadId; });
            if (lead) lead.fields['Is Prio'] = false;
            updatePrioList();
            showToast('Removed from PRIO', 'success');
        } catch (err) {
            showToast('Failed to update', 'error');
        }
    }
    
    // Toggle PRIO
    document.getElementById('modalPrioBtn').addEventListener('click', async function() {
        if (!currentLeadId) return;
        var btn = this;
        btn.disabled = true;

        try {
            var lead = allLeads.find(function(l) { return l.id === currentLeadId; });
            var newPrioStatus = !lead.fields['Is Prio'];

            await fetchAirtable(AIRTABLE_BASE + '/' + AIRTABLE_LEADS_TABLE + '/' + currentLeadId, {
                method: 'PATCH',
                body: { fields: { 'Is Prio': newPrioStatus } }
            });

            lead.fields['Is Prio'] = newPrioStatus;
            openLeadModal(currentLeadId);
            updatePrioList();
            showToast(newPrioStatus ? 'Marked as PRIO' : 'Removed from PRIO', 'success');
        } catch (err) {
            showToast('Failed to update', 'error');
        }
        btn.disabled = false;
    });

    // Send Back to AI - Open modal
    var sendAILeadId = null;
    var sendAISelectedReason = null;
    var sendAISelectedMonths = null;
    var sendAISelectedTime = 'Afternoon';

    document.getElementById('modalSendBackBtn').addEventListener('click', function() {
        if (!currentLeadId) return;
        sendAILeadId = currentLeadId;
        sendAISelectedReason = null;
        sendAISelectedMonths = null;
        sendAISelectedTime = 'Afternoon';

        // Reset modal state
        document.querySelectorAll('#sendAIReasons .reason-btn').forEach(function(btn) { btn.classList.remove('active'); });
        document.querySelectorAll('#sendAITiming .timing-btn').forEach(function(btn) { btn.classList.remove('active'); });
        document.querySelectorAll('#sendAITimePref .time-pref-btn').forEach(function(btn) { btn.classList.remove('active'); });
        document.querySelector('#sendAITimePref .time-pref-btn[data-time="Afternoon"]').classList.add('active');
        document.getElementById('sendAIOtherReason').style.display = 'none';
        document.getElementById('sendAIOtherReason').value = '';
        document.getElementById('sendAICalendar').style.display = 'none';
        document.getElementById('sendAICustomDate').value = '';
        document.getElementById('sendAIConfirmBtn').disabled = true;

        document.getElementById('sendAIModal').classList.add('active');
    });

    // Take Over button in modal
    document.getElementById('modalTakeOverBtn').addEventListener('click', function() {
        if (!currentLeadId) return;
        takeOverLead(currentLeadId);
    });

    // Reason buttons
    document.querySelectorAll('#sendAIReasons .reason-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            document.querySelectorAll('#sendAIReasons .reason-btn').forEach(function(b) { b.classList.remove('active'); });
            this.classList.add('active');
            sendAISelectedReason = this.dataset.reason;

            var otherInput = document.getElementById('sendAIOtherReason');
            if (sendAISelectedReason === 'other') {
                otherInput.style.display = 'block';
                otherInput.focus();
            } else {
                otherInput.style.display = 'none';
            }
            updateSendAIConfirmState();
        });
    });

    // Timing buttons
    // Calendar state
    var calendarDate = new Date();
    var selectedCalendarDate = null;

    function renderSendAICalendar() {
        var year = calendarDate.getFullYear();
        var month = calendarDate.getMonth();
        var today = new Date();
        today.setHours(0,0,0,0);

        var monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                          'July', 'August', 'September', 'October', 'November', 'December'];
        document.getElementById('sendAICalMonth').textContent = monthNames[month] + ' ' + year;

        var firstDay = new Date(year, month, 1).getDay();
        var daysInMonth = new Date(year, month + 1, 0).getDate();

        var daysHtml = '';
        // Empty cells for days before first
        for (var i = 0; i < firstDay; i++) {
            daysHtml += '<span class="calendar-day empty"></span>';
        }
        // Days of month
        for (var d = 1; d <= daysInMonth; d++) {
            var dateObj = new Date(year, month, d);
            dateObj.setHours(0,0,0,0);
            var dateStr = year + '-' + String(month + 1).padStart(2, '0') + '-' + String(d).padStart(2, '0');
            var isPast = dateObj.getTime() <= today.getTime(); // Block today and past dates - first selectable is tomorrow
            var isSelected = selectedCalendarDate === dateStr;
            var classes = 'calendar-day';
            if (isPast) classes += ' past';
            if (isSelected) classes += ' selected';
            daysHtml += '<span class="' + classes + '" data-date="' + dateStr + '"' + (isPast ? '' : '') + '>' + d + '</span>';
        }
        document.getElementById('sendAICalDays').innerHTML = daysHtml;

        // Add click handlers
        document.querySelectorAll('#sendAICalDays .calendar-day:not(.empty):not(.past)').forEach(function(day) {
            day.addEventListener('click', function() {
                selectedCalendarDate = this.dataset.date;
                document.getElementById('sendAICustomDate').value = selectedCalendarDate;
                renderSendAICalendar();
                updateSendAIConfirmState();
            });
        });
    }

    // Calendar navigation
    document.getElementById('sendAICalPrev').addEventListener('click', function() {
        calendarDate.setMonth(calendarDate.getMonth() - 1);
        renderSendAICalendar();
    });
    document.getElementById('sendAICalNext').addEventListener('click', function() {
        calendarDate.setMonth(calendarDate.getMonth() + 1);
        renderSendAICalendar();
    });

    document.querySelectorAll('#sendAITiming .timing-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            document.querySelectorAll('#sendAITiming .timing-btn').forEach(function(b) { b.classList.remove('active'); });
            this.classList.add('active');
            sendAISelectedMonths = this.dataset.months;

            var calendar = document.getElementById('sendAICalendar');
            if (sendAISelectedMonths === 'custom') {
                calendar.style.display = 'block';
                calendarDate = new Date();
                selectedCalendarDate = null;
                document.getElementById('sendAICustomDate').value = '';
                renderSendAICalendar();
            } else {
                calendar.style.display = 'none';
            }
            updateSendAIConfirmState();
        });
    });

    // Time preference buttons
    document.querySelectorAll('#sendAITimePref .time-pref-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            document.querySelectorAll('#sendAITimePref .time-pref-btn').forEach(function(b) { b.classList.remove('active'); });
            this.classList.add('active');
            sendAISelectedTime = this.dataset.time;
        });
    });

    function updateSendAIConfirmState() {
        var reasonValid = sendAISelectedReason && (sendAISelectedReason !== 'other' || document.getElementById('sendAIOtherReason').value.trim());
        var timingValid = sendAISelectedMonths && (sendAISelectedMonths !== 'custom' || document.getElementById('sendAICustomDate').value);
        document.getElementById('sendAIConfirmBtn').disabled = !(reasonValid && timingValid);
    }

    document.getElementById('sendAIOtherReason').addEventListener('input', updateSendAIConfirmState);
    document.getElementById('sendAICustomDate').addEventListener('change', updateSendAIConfirmState);

    // Cancel button
    document.getElementById('sendAICancelBtn').addEventListener('click', function() {
        document.getElementById('sendAIModal').classList.remove('active');
    });

    // Confirm Send to AI
    document.getElementById('sendAIConfirmBtn').addEventListener('click', async function() {
        if (!sendAILeadId) return;

        var btn = this;
        btn.disabled = true;
        btn.textContent = 'Sending...';

        try {
            // Calculate callback date
            var callbackDate;
            if (sendAISelectedMonths === 'custom') {
                callbackDate = document.getElementById('sendAICustomDate').value;
            } else {
                var months = parseInt(sendAISelectedMonths);
                var date = new Date();
                date.setMonth(date.getMonth() + months);
                callbackDate = date.toISOString().split('T')[0];
            }

            // Get reason text
            var reasonText = sendAISelectedReason === 'other'
                ? document.getElementById('sendAIOtherReason').value.trim()
                : sendAISelectedReason;

            // Format callback date as friendly date with year
            var callbackDateObj = new Date(callbackDate + 'T12:00:00');
            var months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            var day = callbackDateObj.getDate();
            var suffix = ['th', 'st', 'nd', 'rd'][(day % 100 > 10 && day % 100 < 14) ? 0 : (day % 10 < 4 ? day % 10 : 0)];
            var friendlyDate = months[callbackDateObj.getMonth()] + ' ' + day + suffix + ', ' + callbackDateObj.getFullYear();

            // Build note with new format: "Sent back to AI - Reason: [reason] | Callback Scheduled: [date] in the [time]"
            var noteText = 'Sent back to AI - Reason: ' + reasonText + ' | Callback Scheduled: ' + friendlyDate + ' in the ' + sendAISelectedTime;

            // Calculate Next Call Date based on time of day
            var timeHour = 9; // Default Morning
            if (sendAISelectedTime === 'Afternoon') timeHour = 13;
            else if (sendAISelectedTime === 'Evening') timeHour = 17;

            var nextCallDate = new Date(callbackDate + 'T00:00:00');
            nextCallDate.setHours(timeHour, 0, 0, 0);
            var nextCallDateISO = nextCallDate.toISOString();

            // Get existing notes as JSON array and add new note
            var lead = allLeads.find(function(l) { return l.id === sendAILeadId; });
            var existingNotesRaw = lead?.fields['Client Notes'] || '';
            var notesArray = parseNotesJson(existingNotesRaw);
            notesArray.push({ text: noteText, date: new Date().toISOString() });
            var newNotes = JSON.stringify(notesArray);

            // Update lead with Client Notes, Status, Last Outcome, and Next Call Date
            await fetchAirtable(AIRTABLE_BASE + '/' + AIRTABLE_LEADS_TABLE + '/' + sendAILeadId, {
                method: 'PATCH',
                body: {
                    fields: {
                        'Client Notes': newNotes,
                        'Status': 'Follow Up',
                        'Last Outcome': 'Follow Up',
                        'Next Call Date': nextCallDateISO
                    }
                }
            });

            // Update local lead data (keep in allLeads so it shows in Pipeline)
            if (lead) {
                lead.fields['Client Notes'] = newNotes;
                lead.fields['Status'] = 'Follow Up';
                lead.fields['Last Outcome'] = 'Follow Up';
                lead.fields['Next Call Date'] = nextCallDateISO;
                lead.fields['Is Prio'] = false; // Remove from Prio when sent to AI
            }

            document.getElementById('sendAIModal').classList.remove('active');
            document.getElementById('leadModal').classList.remove('active');
            currentLeadId = null;
            showToast('Lead sent back to AI for follow-up', 'success');

            // Refresh all views immediately
            updateDashboard();
            updatePrioListFiltered();
            updateProspectsTable();
            updatePipelineList();
            updateUnqualifiedList();
            updateOpenLeadsList();
        } catch (err) {
            showToast('Failed: ' + err.message, 'error');
        }
        btn.disabled = false;
        btn.textContent = 'Send to AI';
    });

    // Do Not Call from modal
    document.getElementById('modalDNCBtn')?.addEventListener('click', async function() {
        if (!currentLeadId) return;

        var confirmed = await showConfirmModal(
            'Mark as Do Not Call?',
            'This lead will be marked as DNC and removed from all call queues. This action cannot be undone.',
            '',
            true
        );
        if (!confirmed) return;

        var btn = this;
        btn.disabled = true;

        try {
            // Update Status to DNC, Last Outcome to DNC, and set Is Prio to false
            await fetchAirtable(AIRTABLE_BASE + '/' + AIRTABLE_LEADS_TABLE + '/' + currentLeadId, {
                method: 'PATCH',
                body: { fields: { 'Status': 'DNC', 'Last Outcome': 'DNC', 'Is Prio': false } }
            });

            // Remove from local data and update UI immediately
            allLeads = allLeads.filter(function(l) { return l.id !== currentLeadId; });

            showToast('Lead marked as Do Not Call', 'success');
            document.getElementById('leadModal').classList.remove('active');

            // Update all lists to remove the lead from display immediately
            updateDashboard();
            updatePrioList();
            updateProspectsTable();
            updatePipelineList();
            updateSharedLeadsList();
            updateUnqualifiedList();
            updateOpenLeadsList();
            updateBookedTodayList();
        } catch (err) {
            showToast('Failed to update: ' + err.message, 'error');
        }
        btn.disabled = false;
    });

    // Overflow menu toggle for prospects actions
    function toggleProspectsOverflow(btn) {
        var menu = btn.nextElementSibling;
        var isOpen = menu.classList.contains('open');
        closeAllOverflowMenus();
        if (!isOpen) {
            menu.classList.add('open');
        }
    }
    function closeAllOverflowMenus() {
        document.querySelectorAll('.action-overflow-menu.open').forEach(function(m) {
            m.classList.remove('open');
        });
    }
    document.addEventListener('click', function() {
        closeAllOverflowMenus();
    });

    // Quick action functions for priority cards
    async function quickShareLead(leadId) {
        currentLeadId = leadId;
        var lead = allLeads.find(function(l) { return l.id === leadId; });
        if (!lead) return;

        var sharedWithEmail = lead.fields['Shared With Email'];
        if (Array.isArray(sharedWithEmail)) sharedWithEmail = sharedWithEmail[0] || '';

        if (lead.isShared || sharedWithEmail) {
            openShareInfoPopup(lead);
        } else {
            openSharePopup(leadId);
        }
    }

    function quickSendToAI(leadId) {
        // Open the Send to AI modal
        sendAILeadId = leadId;
        sendAISelectedReason = null;
        sendAISelectedMonths = null;
        sendAISelectedTime = 'Afternoon';

        // Reset modal state
        document.querySelectorAll('#sendAIReasons .reason-btn').forEach(function(btn) { btn.classList.remove('active'); });
        document.querySelectorAll('#sendAITiming .timing-btn').forEach(function(btn) { btn.classList.remove('active'); });
        document.querySelectorAll('#sendAITimePref .time-pref-btn').forEach(function(btn) { btn.classList.remove('active'); });
        document.querySelector('#sendAITimePref .time-pref-btn[data-time="Afternoon"]').classList.add('active');
        document.getElementById('sendAIOtherReason').style.display = 'none';
        document.getElementById('sendAIOtherReason').value = '';
        document.getElementById('sendAICalendar').style.display = 'none';
        document.getElementById('sendAICustomDate').value = '';
        document.getElementById('sendAIConfirmBtn').disabled = true;

        document.getElementById('sendAIModal').classList.add('active');
    }

    async function quickMarkDNC(leadId) {
        var confirmed = await showConfirmModal(
            'Mark as Do Not Call?',
            'This lead will be removed from all call queues. This action cannot be undone.',
            '',
            true
        );
        if (!confirmed) return;

        try {
            // Update Status to DNC, Last Outcome to DNC, and set Is Prio to false
            await fetchAirtable(AIRTABLE_BASE + '/' + AIRTABLE_LEADS_TABLE + '/' + leadId, {
                method: 'PATCH',
                body: { fields: { 'Status': 'DNC', 'Last Outcome': 'DNC', 'Is Prio': false } }
            });

            // Remove from local data and update UI immediately
            allLeads = allLeads.filter(function(l) { return l.id !== leadId; });

            showToast('Marked as DNC', 'success');

            // Update all lists to remove the lead from display immediately
            updateDashboard();
            updatePrioList();
            updateProspectsTable();
            updatePipelineList();
            updateSharedLeadsList();
            updateUnqualifiedList();
            updateOpenLeadsList();
            updateBookedTodayList();
        } catch (err) {
            showToast('Failed: ' + err.message, 'error');
        }
    }

    function quickReschedule(leadId) {
        currentLeadId = leadId;
        var lead = allLeads.find(function(l) { return l.id === leadId; });
        if (lead) {
            openScheduleModal(lead.id, lead.fields, 'unqualified');
        }
    }

    // Format transcript with colored speakers
    function formatTranscript(text, prospectName) {
        if (!text) return 'No transcript available';
        var lines = text.split('\n');
        var firstName = prospectName ? prospectName.split(' ')[0] : 'Lead';
        return lines.map(function(line) {
            var trimmed = line.trim();
            if (!trimmed) return '';
            var lowerLine = trimmed.toLowerCase();

            // Agent/AI lines - show as "Prio AI" in white
            if (lowerLine.startsWith('agent:') || lowerLine.startsWith('prio ai:') || lowerLine.startsWith('prio:') || lowerLine.startsWith('ai:') || lowerLine.startsWith('sarah:')) {
                var colonIdx = trimmed.indexOf(':');
                return '<div class="lead-transcript-line"><span class="speaker-ai">Prio AI:</span>' + escapeHtml(trimmed.slice(colonIdx + 1)) + '</div>';
            }
            // User lines - show as lead name in green
            if (lowerLine.startsWith('user:')) {
                var colonIdx = trimmed.indexOf(':');
                return '<div class="lead-transcript-line"><span class="speaker-prospect">' + escapeHtml(firstName) + ':</span>' + escapeHtml(trimmed.slice(colonIdx + 1)) + '</div>';
            }
            // Other speaker lines
            if (trimmed.includes(':')) {
                var colonIdx = trimmed.indexOf(':');
                var speaker = trimmed.slice(0, colonIdx);
                var content = trimmed.slice(colonIdx + 1);
                // Check if it's a name-like speaker (no spaces before colon means it's a name)
                if (speaker.indexOf(' ') === -1 || speaker.length < 20) {
                    return '<div class="lead-transcript-line"><span class="speaker-prospect">' + escapeHtml(firstName) + ':</span>' + escapeHtml(content) + '</div>';
                }
            }
            return '<div class="lead-transcript-line">' + escapeHtml(trimmed) + '</div>';
        }).filter(function(l) { return l; }).join('');
    }
    
    // === SHARE FUNCTIONALITY ===
    var currentShareLeadId = null;
    var shareableAgents = [];
    var allActiveAgents = [];
    
    // Fetch all active agents
    async function fetchAllActiveAgents() {
        try {
            var response = await fetchAirtable(AIRTABLE_BASE + '/' + AIRTABLE_CLIENTS_TABLE + '?filterByFormula={Status}="Active"');
            allActiveAgents = response.records.map(function(r) {
                return { id: r.id, name: r.fields['Agent Name'] || 'Unknown', email: r.fields['Email'] || '' };
            });
        } catch (err) {
            console.error('Error fetching agents:', err);
        }
        return allActiveAgents;
    }
    
    // Fetch agents current user can share with
    async function fetchShareableAgents() {
        shareableAgents = [];
        try {
            var canShareWith = currentUserRecord?.fields['Can Share With'] || '';
            if (!canShareWith.trim()) return shareableAgents;
            
            var allowedEmails = canShareWith.split(',').map(function(e) { return e.trim().toLowerCase(); }).filter(function(e) { return e; });
            if (allowedEmails.length === 0) return shareableAgents;
            
            if (allActiveAgents.length === 0) await fetchAllActiveAgents();
            
            shareableAgents = allActiveAgents.filter(function(a) {
                return a.email && currentUser && a.email.toLowerCase() !== currentUser.email.toLowerCase() && allowedEmails.includes(a.email.toLowerCase());
            });
        } catch (err) {
            console.error('Error fetching shareable agents:', err);
        }
        return shareableAgents;
    }
    
    function getAgentNameByEmail(email) {
        if (Array.isArray(email)) email = email[0] || '';
        if (!email) return 'Unknown';
        var agent = allActiveAgents.find(function(a) { return a.email && a.email.toLowerCase() === email.toLowerCase(); });
        if (agent) return agent.name;
        return email.split('@')[0];
    }

    // Helper: generate shared badge HTML for lead cards
    function getSharedBadgeHtml(lead) {
        var f = lead.fields;
        var sharedWithEmail = f['Shared With Email'];
        if (Array.isArray(sharedWithEmail)) sharedWithEmail = sharedWithEmail[0] || '';
        var isSharedToMe = lead.isShared;
        var isShared = isSharedToMe || sharedWithEmail;
        if (!isShared) return '';
        var displayName = '';
        if (isSharedToMe) {
            var ownerEmail = f['Client Email'];
            if (Array.isArray(ownerEmail)) ownerEmail = ownerEmail[0] || '';
            displayName = getAgentNameByEmail(ownerEmail);
        } else if (sharedWithEmail) {
            displayName = getAgentNameByEmail(sharedWithEmail);
        }
        var label = isSharedToMe ? 'From ' + displayName : 'w/ ' + displayName;
        return ' <span class="shared-badge" title="' + (isSharedToMe ? 'Shared by ' : 'Shared with ') + escapeHtml(displayName) + '"> ' + escapeHtml(label) + '</span>';
    }

    // Card-only: just chain icon (no name)
    function getSharedIconHtml(lead) {
        var f = lead.fields;
        var sharedWithEmail = f['Shared With Email'];
        if (Array.isArray(sharedWithEmail)) sharedWithEmail = sharedWithEmail[0] || '';
        var isSharedToMe = lead.isShared;
        var isShared = isSharedToMe || sharedWithEmail;
        if (!isShared) return '';
        var displayName = '';
        if (isSharedToMe) {
            var ownerEmail = f['Client Email'];
            if (Array.isArray(ownerEmail)) ownerEmail = ownerEmail[0] || '';
            displayName = getAgentNameByEmail(ownerEmail);
        } else if (sharedWithEmail) {
            displayName = getAgentNameByEmail(sharedWithEmail);
        }
        return ' <span class="shared-icon-only" title="' + (isSharedToMe ? 'Shared by ' : 'Shared with ') + escapeHtml(displayName) + '"></span>';
    }
    
    // Share button click
    document.getElementById('modalShareBtn').addEventListener('click', async function() {
        if (!currentLeadId) return;
        var lead = allLeads.find(function(l) { return l.id === currentLeadId; });
        if (!lead) return;
        
        var sharedWithEmail = lead.fields['Shared With Email'];
        if (Array.isArray(sharedWithEmail)) sharedWithEmail = sharedWithEmail[0] || '';
        
        if (lead.isShared || sharedWithEmail) {
            // Show info popup
            openShareInfoPopup(lead);
        } else {
            // Show share popup
            openSharePopup(currentLeadId);
        }
    });
    
    async function openSharePopup(leadId) {
        currentShareLeadId = leadId;
        var popup = document.getElementById('shareLeadPopup');
        var overlay = document.getElementById('sharePopupOverlay');
        var agentsList = document.getElementById('shareAgentsList');
        var confirmBtn = document.getElementById('sharePopupConfirm');
        
        var agents = await fetchShareableAgents();
        
        if (agents.length === 0) {
            agentsList.innerHTML = '<p style="color:rgba(255,255,255,0.5);text-align:center;padding:12px;">You don\'t have permission to share prospects with other agents.</p>';
            confirmBtn.disabled = true;
        } else {
            agentsList.innerHTML = agents.map(function(agent) {
                return '<label class="share-agent-option" data-email="' + agent.email + '">' +
                    '<input type="radio" name="shareAgent" value="' + agent.id + '" data-email="' + agent.email + '">' +
                    '<span class="share-agent-radio"></span>' +
                    '<span class="share-agent-name">' + agent.name + '</span>' +
                '</label>';
            }).join('');
            
            agentsList.querySelectorAll('.share-agent-option').forEach(function(opt) {
                opt.addEventListener('click', function() {
                    agentsList.querySelectorAll('.share-agent-option').forEach(function(o) { o.classList.remove('selected'); });
                    this.classList.add('selected');
                    this.querySelector('input').checked = true;
                    confirmBtn.disabled = false;
                });
            });
            confirmBtn.disabled = true;
        }
        
        overlay.classList.add('active');
        popup.classList.add('active');
    }
    
    function openShareInfoPopup(lead) {
        var popup = document.getElementById('shareInfoPopup');
        var overlay = document.getElementById('sharePopupOverlay');
        var content = document.getElementById('shareInfoContent');
        var title = document.getElementById('shareInfoTitle');
        var actionsDiv = document.getElementById('shareInfoActions');

        var sharedWithEmail = lead.fields['Shared With Email'];
        if (Array.isArray(sharedWithEmail)) sharedWithEmail = sharedWithEmail[0] || '';

        currentShareLeadId = lead.id;

        if (lead.isShared) {
            // Lead was shared WITH the current user
            title.textContent = 'Shared With You';
            var ownerEmail = lead.fields['Client Email'];
            if (Array.isArray(ownerEmail)) ownerEmail = ownerEmail[0] || '';
            content.innerHTML = '<div class="share-info-label">Shared By</div><div class="share-info-name">' + getAgentNameByEmail(ownerEmail) + '</div>';
            actionsDiv.style.display = 'none'; // Can't stop sharing if it was shared with you
        } else {
            // Current user shared this lead
            title.textContent = 'You Shared This';
            content.innerHTML = '<div class="share-info-label">Shared With</div><div class="share-info-name">' + getAgentNameByEmail(sharedWithEmail) + '</div>';
            actionsDiv.style.display = 'flex'; // Show Stop Sharing button
        }

        overlay.classList.add('active');
        popup.classList.add('active');
    }
    
    function closeSharePopup() {
        document.getElementById('shareLeadPopup').classList.remove('active');
        document.getElementById('shareInfoPopup').classList.remove('active');
        document.getElementById('sharePopupOverlay').classList.remove('active');
        currentShareLeadId = null;
    }
    
    document.getElementById('sharePopupClose').addEventListener('click', closeSharePopup);
    document.getElementById('sharePopupCancel').addEventListener('click', closeSharePopup);
    document.getElementById('shareInfoClose').addEventListener('click', closeSharePopup);
    document.getElementById('sharePopupOverlay').addEventListener('click', closeSharePopup);

    // Stop Sharing handler
    document.getElementById('stopSharingBtn').addEventListener('click', async function() {
        if (!currentShareLeadId) return;

        var btn = this;
        btn.disabled = true;
        btn.textContent = 'Stopping...';

        // Save the lead ID before closeSharePopup sets it to null
        var leadIdToUpdate = currentShareLeadId;

        try {
            // Clear the Shared With linked record field (Shared With Email is a lookup, read-only)
            await fetchAirtable(AIRTABLE_BASE + '/' + AIRTABLE_LEADS_TABLE + '/' + leadIdToUpdate, {
                method: 'PATCH',
                body: { fields: { 'Shared With': null } }
            });

            // Update local data - clear both the linked field and its lookup
            var lead = allLeads.find(function(l) { return l.id === leadIdToUpdate; });
            if (lead) {
                lead.fields['Shared With'] = null;
                lead.fields['Shared With Email'] = null;
            }

            showToast('Sharing stopped', 'success');
            closeSharePopup();

            // Update the modal share button
            var shareBtn = document.getElementById('modalShareBtn');
            if (shareBtn) {
                shareBtn.classList.remove('shared');
                shareBtn.innerHTML = ' Share';
            }

            // Update card display - remove share icon
            var cardEl = document.querySelector('.prio-card[data-id="' + leadIdToUpdate + '"]');
            if (cardEl) {
                var sharedIcon = cardEl.querySelector('.shared-icon-only') || cardEl.querySelector('.shared-badge') || cardEl.querySelector('.shared-icon');
                if (sharedIcon) sharedIcon.remove();
                var shareActionBtn = cardEl.querySelector('.action-share');
                if (shareActionBtn) {
                    shareActionBtn.classList.remove('shared');
                    shareActionBtn.innerHTML = '<span class="action-icon"></span><span class="action-label">Share</span>';
                }
            }

            // Update priority card
            var priorityCard = document.querySelector('.priority-card-lg[data-id="' + leadIdToUpdate + '"]');
            if (priorityCard) {
                var prioSharedIcon = priorityCard.querySelector('.shared-icon-only') || priorityCard.querySelector('.shared-badge') || priorityCard.querySelector('.shared-icon');
                if (prioSharedIcon) prioSharedIcon.remove();
                // Update quick action share button to show Share
                var shareActionBtn = priorityCard.querySelector('.action-share');
                if (shareActionBtn) {
                    shareActionBtn.classList.remove('shared');
                    shareActionBtn.innerHTML = '<span class="action-icon"></span><span class="action-label">Share</span>';
                }
            }

            // Update modal share button
            var modalShareBtnUnshare = document.getElementById('modalShareBtn');
            if (modalShareBtnUnshare) {
                modalShareBtnUnshare.classList.remove('shared');
                modalShareBtnUnshare.innerHTML = ' Share';
            }
        } catch (err) {
            showToast('Failed to stop sharing', 'error');
        }
        btn.disabled = false;
        btn.textContent = 'Stop Sharing';
    });

    document.getElementById('sharePopupConfirm').addEventListener('click', async function() {
        if (!currentShareLeadId) return;
        var selectedAgent = document.querySelector('input[name="shareAgent"]:checked');
        if (!selectedAgent) return;

        var selectedAgentId = selectedAgent.value;
        var selectedAgentEmail = selectedAgent.dataset.email;

        var btn = this;
        btn.disabled = true;
        btn.textContent = 'Sharing...';

        // Save the lead ID before closeSharePopup sets it to null
        var leadIdToUpdate = currentShareLeadId;

        try {
            // Update the Shared With linked record field (Shared With Email is a lookup that auto-populates)
            await fetchAirtable(AIRTABLE_BASE + '/' + AIRTABLE_LEADS_TABLE + '/' + leadIdToUpdate, {
                method: 'PATCH',
                body: { fields: { 'Shared With': [selectedAgentId] } }
            });

            var lead = allLeads.find(function(l) { return l.id === leadIdToUpdate; });
            if (lead) {
                lead.fields['Shared With'] = [selectedAgentId];
                lead.fields['Shared With Email'] = [selectedAgentEmail]; // Update lookup locally for display

                // Trigger webhook for lead shared
                try {
                    var leadName = ((lead.fields['First Name'] || '') + ' ' + (lead.fields['Last Name'] || '')).trim() || 'Unknown';
                    var leadNumber = lead.fields['Phone #'] || lead.fields['Phone'] || '';
                    var summary = lead.fields['Last Call Summary'] || lead.fields['Summary'] || '';
                    var nextCallDate = lead.fields['Next Call Date'] || lead.fields['Booked Time'] || lead.fields['Callback Date'] || '';

                    fetch('https://n8n.prioai.ca/webhook/lead-shared', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            leadName: leadName,
                            leadNumber: leadNumber,
                            summary: summary,
                            nextCallDate: nextCallDate,
                            sharedWith: selectedAgentEmail,
                            sharedBy: currentUser?.email || ''
                        })
                    }).catch(function(e) { console.log('Webhook error:', e); });
                } catch (webhookErr) {
                    console.log('Webhook error:', webhookErr);
                }
            }

            showToast('Prospect shared successfully!', 'success');
            closeSharePopup();

            // Get the name of the agent shared with
            var sharedWithName = getAgentNameByEmail(selectedAgentEmail) || selectedAgentEmail;

            // Update the modal share button immediately
            var shareBtn = document.getElementById('modalShareBtn');
            if (shareBtn) {
                shareBtn.classList.add('shared');
                shareBtn.innerHTML = ' Shared with ' + sharedWithName;
            }

            // Update card display immediately - find card and update share icon
            var cardEl = document.querySelector('.prio-card[data-id="' + leadIdToUpdate + '"]');
            if (cardEl) {
                var nameEl = cardEl.querySelector('.prio-card-name');
                if (nameEl && !nameEl.querySelector('.shared-icon-only')) {
                    nameEl.innerHTML = nameEl.innerHTML + ' <span class="shared-icon-only" title="Shared with ' + escapeHtml(sharedWithName) + '"></span>';
                }
                // Update quick action share button on small card if present
                var cardShareBtn = cardEl.querySelector('.action-share');
                if (cardShareBtn) {
                    cardShareBtn.classList.add('shared');
                    cardShareBtn.innerHTML = '<span class="action-icon"></span><span class="action-label">Shared</span>';
                }
            }

            // Also update priority card if present
            var priorityCard = document.querySelector('.priority-card-lg[data-id="' + leadIdToUpdate + '"]');
            if (priorityCard) {
                var prioNameEl = priorityCard.querySelector('.priority-card-lg-name');
                if (prioNameEl && !prioNameEl.querySelector('.shared-icon-only')) {
                    prioNameEl.innerHTML = prioNameEl.innerHTML + ' <span class="shared-icon-only" title="Shared with ' + escapeHtml(sharedWithName) + '"></span>';
                }
                // Update quick action share button to show Shared
                var shareActionBtn = priorityCard.querySelector('.action-share');
                if (shareActionBtn) {
                    shareActionBtn.classList.add('shared');
                    shareActionBtn.innerHTML = '<span class="action-icon"></span><span class="action-label">Shared</span>';
                }
            }

            // Update modal share button display
            var modalShareBtnEl = document.getElementById('modalShareBtn');
            if (modalShareBtnEl) {
                modalShareBtnEl.classList.add('shared');
                modalShareBtnEl.innerHTML = ' Shared with ' + (getAgentNameByEmail(selectedAgentEmail) || selectedAgentEmail);
            }
        } catch (err) {
            showToast('Failed to share prospect', 'error');
        }
        btn.disabled = false;
        btn.textContent = 'Share';
    });
    
    // === SCHEDULE BOOKING FUNCTIONALITY ===
    var scheduleLeadId = null;
    var scheduleLeadData = null;
    var scheduleSource = null;
    var selectedDate = null;
    var scheduleCalMonth = new Date();
    
    // Schedule button click
    document.getElementById('modalScheduleBtn').addEventListener('click', function() {
        if (!currentLeadId) return;
        var lead = allLeads.find(function(l) { return l.id === currentLeadId; });
        if (lead) openScheduleModal(lead.id, lead.fields);
    });
    
    function openScheduleModal(leadId, leadData, source) {
        scheduleLeadId = leadId;
        scheduleLeadData = leadData;
        scheduleSource = source || null;
        var leadName = ((leadData['First Name'] || '') + ' ' + (leadData['Last Name'] || '')).trim() || 'Lead';
        document.getElementById('scheduleLeadName').textContent = 'Scheduling for: ' + leadName;

        // Create selectedDate - default to next day if past 7pm EST
        var now = new Date();
        var estNow = new Date(now.toLocaleString('en-US', { timeZone: 'America/New_York' }));
        var estHour = estNow.getHours();
        if (estHour >= 19) {
            // Past 7pm EST - default to tomorrow
            var tomorrow = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
            selectedDate = tomorrow;
            scheduleCalMonth = new Date(tomorrow.getFullYear(), tomorrow.getMonth(), 1);
        } else {
            selectedDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            scheduleCalMonth = new Date(now.getFullYear(), now.getMonth(), 1);
        }

        renderCalendar();
        updateTimeDropdowns();
        document.getElementById('scheduleNote').value = '';
        document.getElementById('scheduleModal').classList.add('active');
    }

    // Quick schedule from card button
    function quickSchedule(leadId) {
        var lead = allLeads.find(function(l) { return l.id === leadId; });
        if (lead) {
            openScheduleModal(lead.id, lead.fields);
        }
    }
    window.quickSchedule = quickSchedule;

    function updateTimeDropdowns() {
        var hourSelect = document.getElementById('scheduleHour');
        var minuteSelect = document.getElementById('scheduleMinute');
        var now = new Date();
        var isToday = selectedDate && selectedDate.toDateString() === now.toDateString();

        // Calculate earliest available time (current time + 15 min rounded to nearest 15)
        var earliestHour = 9;
        var earliestMinute = 0;

        if (isToday) {
            var currentMinutes = now.getHours() * 60 + now.getMinutes() + 15;
            currentMinutes = Math.ceil(currentMinutes / 15) * 15;
            earliestHour = Math.floor(currentMinutes / 60);
            earliestMinute = currentMinutes % 60;
            if (earliestMinute >= 60) {
                earliestHour++;
                earliestMinute = 0;
            }
        }

        // Populate hour dropdown (9 AM to 8 PM) - grey out past hours
        var hourOptions = '';
        var firstAvailableHour = null;
        for (var h = 9; h <= 20; h++) {
            var displayHour = h > 12 ? h - 12 : (h === 0 ? 12 : h);
            var ampm = h >= 12 ? 'PM' : 'AM';
            var isPast = isToday && h < earliestHour;
            if (!isPast && firstAvailableHour === null) firstAvailableHour = h;
            hourOptions += '<option value="' + h + '"' + (isPast ? ' disabled style="color:#666"' : '') + '>' + displayHour + ' ' + ampm + '</option>';
        }
        hourSelect.innerHTML = hourOptions;

        // Select first available hour
        hourSelect.value = firstAvailableHour || 9;

        // Update minute dropdown
        updateMinuteDropdown();
    }

    function updateMinuteDropdown() {
        var hourSelect = document.getElementById('scheduleHour');
        var minuteSelect = document.getElementById('scheduleMinute');
        var selectedHour = parseInt(hourSelect.value);
        var now = new Date();
        var isToday = selectedDate && selectedDate.toDateString() === now.toDateString();

        // Calculate earliest available minute for this hour
        var earliestMinute = 0;
        if (isToday) {
            if (selectedHour === now.getHours()) {
                var currentMinutes = now.getMinutes() + 15;
                earliestMinute = Math.ceil(currentMinutes / 15) * 15;
                if (earliestMinute >= 60) earliestMinute = 60; // All minutes in this hour are past
            } else if (selectedHour < now.getHours()) {
                earliestMinute = 60; // All minutes are past
            }
        }

        // Populate minute dropdown - grey out past minutes
        var minuteOptions = '';
        var minutes = [0, 15, 30, 45];
        var firstAvailableMinute = null;
        minutes.forEach(function(m) {
            var isPast = isToday && m < earliestMinute;
            if (!isPast && firstAvailableMinute === null) firstAvailableMinute = m;
            minuteOptions += '<option value="' + m + '"' + (isPast ? ' disabled style="color:#666"' : '') + '>' + (m < 10 ? '0' : '') + m + '</option>';
        });

        minuteSelect.innerHTML = minuteOptions;
        if (firstAvailableMinute !== null) {
            minuteSelect.value = firstAvailableMinute;
        }
    }

    // Update minutes when hour changes
    document.getElementById('scheduleHour').addEventListener('change', updateMinuteDropdown);
    
    function renderCalendar() {
        var year = scheduleCalMonth.getFullYear();
        var month = scheduleCalMonth.getMonth();
        var today = new Date();
        today.setHours(0, 0, 0, 0);
        
        var monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
        document.getElementById('calendarMonth').textContent = monthNames[month] + ' ' + year;
        
        var firstDay = new Date(year, month, 1).getDay();
        var daysInMonth = new Date(year, month + 1, 0).getDate();
        var daysInPrevMonth = new Date(year, month, 0).getDate();
        
        var daysHtml = '';
        
        for (var i = firstDay - 1; i >= 0; i--) {
            var day = daysInPrevMonth - i;
            daysHtml += '<button class="calendar-day other-month disabled">' + day + '</button>';
        }
        
        for (var d = 1; d <= daysInMonth; d++) {
            var date = new Date(year, month, d);
            var isPast = date < today;
            var isToday = date.getTime() === today.getTime();
            var isSelected = selectedDate && date.getTime() === selectedDate.getTime();
            
            var classes = 'calendar-day';
            if (isPast) classes += ' disabled';
            if (isToday) classes += ' today';
            if (isSelected) classes += ' selected';
            
            daysHtml += '<button class="' + classes + '" data-date="' + date.toISOString().split('T')[0] + '"' + (isPast ? ' disabled' : '') + '>' + d + '</button>';
        }
        
        var totalCells = firstDay + daysInMonth;
        var remaining = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
        for (var n = 1; n <= remaining; n++) {
            daysHtml += '<button class="calendar-day other-month disabled">' + n + '</button>';
        }
        
        document.getElementById('calendarDays').innerHTML = daysHtml;
        
        document.querySelectorAll('.calendar-day:not(.disabled)').forEach(function(btn) {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.calendar-day').forEach(function(d) { d.classList.remove('selected'); });
                this.classList.add('selected');
                var parts = this.dataset.date.split('-');
                selectedDate = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                updateTimeDropdowns();
            });
        });
    }
    
    document.getElementById('calendarPrev').addEventListener('click', function() {
        scheduleCalMonth.setMonth(scheduleCalMonth.getMonth() - 1);
        renderCalendar();
    });

    document.getElementById('calendarNext').addEventListener('click', function() {
        scheduleCalMonth.setMonth(scheduleCalMonth.getMonth() + 1);
        renderCalendar();
    });
    
    document.getElementById('scheduleCancelBtn').addEventListener('click', function() {
        document.getElementById('scheduleModal').classList.remove('active');
        scheduleLeadId = null;
        scheduleLeadData = null;
        scheduleSource = null;
    });
    
    document.getElementById('scheduleSaveBtn').addEventListener('click', async function() {
        if (!scheduleLeadId || !selectedDate) return;

        var btn = this;
        btn.disabled = true;
        btn.textContent = 'Saving...';

        try {
            var hour = parseInt(document.getElementById('scheduleHour').value);
            var minute = parseInt(document.getElementById('scheduleMinute').value);

            var bookedDateTime = new Date(selectedDate);
            bookedDateTime.setHours(hour, minute, 0, 0);

            if (scheduleSource === 'unqualified') {
                // From unqualified: set Follow Up status and Next Call Date
                await fetchAirtable(AIRTABLE_BASE + '/' + AIRTABLE_LEADS_TABLE + '/' + scheduleLeadId, {
                    method: 'PATCH',
                    body: { fields: { 'Next Call Date': bookedDateTime.toISOString(), 'Status': 'Follow Up' } }
                });

                var lead = allLeads.find(function(l) { return l.id === scheduleLeadId; });
                if (lead) {
                    lead.fields['Next Call Date'] = bookedDateTime.toISOString();
                    lead.fields['Status'] = 'Follow Up';
                }

                document.getElementById('scheduleModal').classList.remove('active');
                if (currentLeadId === scheduleLeadId) openLeadModal(currentLeadId);
                updateUnqualifiedList();
                updatePipelineList();
                updatePrioList();
                updateDashboard();
                updateProspectsTable();
                showToast('Lead moved to AI Follow Ups with next call scheduled!', 'success');
            } else {
                // Default: book meeting
                await fetchAirtable(AIRTABLE_BASE + '/' + AIRTABLE_LEADS_TABLE + '/' + scheduleLeadId, {
                    method: 'PATCH',
                    body: { fields: { 'Booked Time': bookedDateTime.toISOString(), 'Status': 'Booked' } }
                });

                var lead = allLeads.find(function(l) { return l.id === scheduleLeadId; });
                if (lead) {
                    lead.fields['Booked Time'] = bookedDateTime.toISOString();
                    lead.fields['Status'] = 'Booked';
                }

                // Sync to Google Calendar via n8n webhook
                var leadName = ((scheduleLeadData['First Name'] || '') + ' ' + (scheduleLeadData['Last Name'] || '')).trim() || 'Lead';
                var phone = scheduleLeadData['Phone #'] || scheduleLeadData['Phone'] || '';
                var email = scheduleLeadData['Email'] || '';
                var scheduleNoteText = (document.getElementById('scheduleNote').value || '').trim();
                var calendarSyncSuccess = false;
                try {
                    var calResponse = await fetch('https://n8n.prioai.ca/webhook/calendar-sync', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            leadId: scheduleLeadId,
                            leadName: leadName,
                            phone: phone,
                            email: email,
                            bookedTime: bookedDateTime.toISOString(),
                            note: scheduleNoteText,
                            agentEmail: currentUser?.email || '',
                            agentName: currentUser?.name || ''
                        })
                    });
                    calendarSyncSuccess = calResponse.ok;
                    if (!calResponse.ok) {
                        console.error('Calendar sync failed:', calResponse.status, calResponse.statusText);
                    }
                } catch (calErr) {
                    console.error('Calendar sync error:', calErr);
                }

                document.getElementById('scheduleModal').classList.remove('active');
                if (currentLeadId === scheduleLeadId) openLeadModal(currentLeadId);
                updatePrioList();
                updateDashboard();
                updateProspectsTable();
                if (calendarSyncSuccess) {
                    showToast('Meeting scheduled and synced to calendar!', 'success');
                } else {
                    showToast('Meeting scheduled! (Calendar sync failed - please add manually)', 'warning');
                }
            }
        } catch (err) {
            showToast('Failed to schedule meeting', 'error');
        }
        btn.disabled = false;
        btn.textContent = 'Save Booking';
    });
    
    // Delete booking
    async function deleteBookingFromModal() {
        if (!currentLeadId) return;

        var confirmed = await showConfirmModal(
            'Remove Booking?',
            'The scheduled meeting will be removed from this lead.',
            '',
            true
        );
        if (!confirmed) return;

        try {
            await fetchAirtable(AIRTABLE_BASE + '/' + AIRTABLE_LEADS_TABLE + '/' + currentLeadId, {
                method: 'PATCH',
                body: { fields: { 'Booked Time': null } }
            });

            var lead = allLeads.find(function(l) { return l.id === currentLeadId; });
            if (lead) lead.fields['Booked Time'] = null;

            openLeadModal(currentLeadId);
            updatePrioList();
            updateDashboard(); // Refresh today's priorities
            updateProspectsTable(); // Refresh prospects list
            showToast('Booking removed', 'success');
        } catch (err) {
            showToast('Failed to remove booking', 'error');
        }
    }
    // Make available globally for onclick
    window.deleteBookingFromModal = deleteBookingFromModal;

    // Edit booking - opens schedule modal with existing time
    function editBookingFromModal() {
        if (!currentLeadId) return;
        var lead = allLeads.find(function(l) { return l.id === currentLeadId; });
        if (!lead) return;

        var f = lead.fields;
        var leadName = ((f['First Name'] || '') + ' ' + (f['Last Name'] || '')).trim() || 'Unknown';
        document.getElementById('scheduleLeadName').textContent = 'Scheduling for: ' + leadName;
        scheduleLeadId = currentLeadId;
        scheduleLeadData = f;

        // Default to next valid date (today, or tomorrow if past 7pm EST) - same as openScheduleModal
        var now = new Date();
        var estNow = new Date(now.toLocaleString('en-US', { timeZone: 'America/New_York' }));
        var estHour = estNow.getHours();
        if (estHour >= 19) {
            var tomorrow = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
            selectedDate = tomorrow;
            scheduleCalMonth = new Date(tomorrow.getFullYear(), tomorrow.getMonth(), 1);
        } else {
            selectedDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            scheduleCalMonth = new Date(now.getFullYear(), now.getMonth(), 1);
        }

        renderCalendar();
        updateTimeDropdowns();

        document.getElementById('scheduleNote').value = '';
        document.getElementById('scheduleModal').classList.add('active');
    }
    window.editBookingFromModal = editBookingFromModal;

    // Toggle collapsible section
    function toggleCollapsibleSection(sectionId) {
        var section = document.getElementById(sectionId);
        if (section) section.classList.toggle('expanded');
    }
    window.toggleCollapsibleSection = toggleCollapsibleSection;

    // Update call attempts section to be collapsible when empty
    function updateCallAttemptsSection(attemptsCount) {
        var section = document.getElementById('callAttemptsSection');
        if (!section) return;
        if (attemptsCount === 0) {
            section.className = 'lead-section collapsible-empty';
            section.innerHTML = '<div class="collapsible-header" onclick="toggleCollapsibleSection(\'callAttemptsSection\')">' +
                '<h3> Call Attempts <span class="attempts-count">0</span></h3>' +
                '<svg class="collapsible-chevron" width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M6 4l4 4-4 4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>' +
                '</div>' +
                '<div class="collapsible-body">' +
                '<div class="lead-attempts-list" id="modalAttemptsList"><p style="color:rgba(255,255,255,0.4);font-size:0.8125rem;">No call attempts logged yet</p></div>' +
                '<button class="btn btn-secondary btn-sm" id="modalLogAttemptBtn" style="width:100%;margin-top:8px;">+ Log Call Attempt</button>' +
                '</div>';
            // Re-bind the log attempt button
            var btn = document.getElementById('modalLogAttemptBtn');
            if (btn && window.bindLogAttemptBtn) window.bindLogAttemptBtn(btn);
        } else {
            section.className = 'lead-section';
            // Ensure normal layout with h3, list, and button
            var h3 = section.querySelector('h3');
            if (!h3 || section.querySelector('.collapsible-header')) {
                section.innerHTML = '<h3> Call Attempts <span class="attempts-count" id="modalAttemptsCount">' + attemptsCount + '</span></h3>' +
                    '<div class="lead-attempts-list" id="modalAttemptsList"></div>' +
                    '<button class="btn btn-secondary btn-sm" id="modalLogAttemptBtn" style="width:100%;margin-top:8px;">+ Log Call Attempt</button>';
                var btn = document.getElementById('modalLogAttemptBtn');
                if (btn && window.bindLogAttemptBtn) window.bindLogAttemptBtn(btn);
            }
        }
    }

    // Delete call attempt
    async function deleteCallAttempt(index) {
        if (!currentLeadId) return;

        var confirmed = await showConfirmModal(
            'Delete Call Attempt?',
            'This call attempt record will be permanently removed.',
            '',
            true
        );
        if (!confirmed) return;

        try {
            var lead = allLeads.find(function(l) { return l.id === currentLeadId; });
            var attemptsRaw = lead.fields['Client Attempts'] || '[]';
            var attemptsArray = [];
            try {
                attemptsArray = typeof attemptsRaw === 'string' ? JSON.parse(attemptsRaw) : (Array.isArray(attemptsRaw) ? attemptsRaw : []);
            } catch (e) {
                attemptsArray = [];
            }

            // Remove the attempt at the given index
            attemptsArray.splice(index, 1);

            await fetchAirtable(AIRTABLE_BASE + '/' + AIRTABLE_LEADS_TABLE + '/' + currentLeadId, {
                method: 'PATCH',
                body: { fields: { 'Client Attempts': JSON.stringify(attemptsArray) } }
            });

            lead.fields['Client Attempts'] = JSON.stringify(attemptsArray);
            openLeadModal(currentLeadId);
            showToast('Call attempt deleted', 'success');
        } catch (err) {
            showToast('Failed to delete call attempt', 'error');
        }
    }
    window.deleteCallAttempt = deleteCallAttempt;

    // Edit note
    function editNote(index) {
        if (!currentLeadId) return;
        var lead = allLeads.find(function(l) { return l.id === currentLeadId; });
        var notesRaw = lead.fields['Client Notes'] || '';
        var notesArr = parseNotesJson(notesRaw);

        if (index >= notesArr.length) return;

        var note = notesArr[index];
        var noteItem = document.querySelector('.lead-note-item[data-note-index="' + index + '"]');
        if (!noteItem) return;

        // Store original HTML for cancel
        var originalHtml = noteItem.innerHTML;

        // Replace with inline edit form
        noteItem.innerHTML = '<textarea class="note-edit-input">' + escapeHtml(note.text) + '</textarea>' +
            '<div class="note-edit-actions">' +
                '<button class="btn-note-cancel" onclick="cancelNoteEdit(' + index + ')">Cancel</button>' +
                '<button class="btn-note-save" onclick="saveNoteEdit(' + index + ')">Save</button>' +
            '</div>';

        // Store original HTML for cancel
        noteItem.dataset.originalHtml = originalHtml;

        // Focus the textarea
        var textarea = noteItem.querySelector('.note-edit-input');
        if (textarea) {
            textarea.focus();
            textarea.setSelectionRange(textarea.value.length, textarea.value.length);
        }
    }
    window.editNote = editNote;

    function cancelNoteEdit(index) {
        var noteItem = document.querySelector('.lead-note-item[data-note-index="' + index + '"]');
        if (!noteItem || !noteItem.dataset.originalHtml) return;
        noteItem.innerHTML = noteItem.dataset.originalHtml;
        delete noteItem.dataset.originalHtml;
    }
    window.cancelNoteEdit = cancelNoteEdit;

    async function saveNoteEdit(index) {
        if (!currentLeadId) return;
        var lead = allLeads.find(function(l) { return l.id === currentLeadId; });
        var notesRaw = lead.fields['Client Notes'] || '';
        var notesArr = parseNotesJson(notesRaw);

        if (index >= notesArr.length) return;

        var noteItem = document.querySelector('.lead-note-item[data-note-index="' + index + '"]');
        if (!noteItem) return;

        var textarea = noteItem.querySelector('.note-edit-input');
        if (!textarea) return;

        var newText = textarea.value.trim();
        if (!newText) {
            showToast('Note cannot be empty', 'error');
            return;
        }

        if (newText === notesArr[index].text) {
            cancelNoteEdit(index);
            return;
        }

        // Update the note text, keeping the original timestamp
        notesArr[index].text = newText;

        try {
            var newNotes = JSON.stringify(notesArr);
            await fetchAirtable(AIRTABLE_BASE + '/' + AIRTABLE_LEADS_TABLE + '/' + currentLeadId, {
                method: 'PATCH',
                body: { fields: { 'Client Notes': newNotes } }
            });
            lead.fields['Client Notes'] = newNotes;
            openLeadModal(currentLeadId);
            updateLeadCardDisplay(currentLeadId); // Update card live
            showToast('Note updated', 'success');
        } catch (err) {
            showToast('Failed to update note', 'error');
        }
    }
    window.saveNoteEdit = saveNoteEdit;

    // Delete note
    async function deleteNote(index) {
        if (!currentLeadId) return;

        var confirmed = await showConfirmModal(
            'Delete Note?',
            'This note will be permanently removed.',
            '',
            true
        );
        if (!confirmed) return;

        var lead = allLeads.find(function(l) { return l.id === currentLeadId; });
        var notesRaw = lead.fields['Client Notes'] || '';
        var notesArr = parseNotesJson(notesRaw);

        if (index >= notesArr.length) return;

        notesArr.splice(index, 1);

        try {
            var newNotes = JSON.stringify(notesArr);
            await fetchAirtable(AIRTABLE_BASE + '/' + AIRTABLE_LEADS_TABLE + '/' + currentLeadId, {
                method: 'PATCH',
                body: { fields: { 'Client Notes': newNotes } }
            });
            lead.fields['Client Notes'] = newNotes;
            openLeadModal(currentLeadId);
            updateLeadCardDisplay(currentLeadId); // Update card live
            showToast('Note deleted', 'success');
        } catch (err) {
            showToast('Failed to delete note', 'error');
        }
    }
    window.deleteNote = deleteNote;

    // ===== PROSPECTS TAB =====
    var prospectsSort = { field: 'bookedTime', direction: 'desc' };

    function updateProspectsTable() {
        var prospectsList = document.getElementById('prospectsList');
        if (!prospectsList) return;

        // Get Booked/Callback leads (excluding PRIO)
        var searchVal = (document.getElementById('prospectsSearch')?.value || '').toLowerCase();
        var statusFilter = document.getElementById('prospectsStatus')?.value || 'all';
        var ownershipFilter = document.getElementById('prospectsOwnership')?.value || 'all';
        var timeframeFilter = document.getElementById('prospectsTimeframe')?.value || 'all';

        var prospects = allLeads.filter(function(l) {
            var f = l.fields;
            var status = f['Status'] || f['Disposition'] || '';

            // Only Booked or Callback, and NOT in PRIO
            if (f['Is Prio'] === true) return false;
            if (status !== 'Booked' && status !== 'Appointment Booked' && status !== 'Callback' && status !== 'Callback Requested') return false;

            // Status filter
            if (statusFilter !== 'all') {
                if (statusFilter === 'Booked' && !status.includes('Booked')) return false;
                else if (statusFilter === 'Callback' && !status.includes('Callback')) return false;
                else if (statusFilter !== 'Booked' && statusFilter !== 'Callback' && status !== statusFilter) return false;
            }

            // Search filter
            if (searchVal) {
                var name = ((f['First Name'] || '') + ' ' + (f['Last Name'] || '')).toLowerCase();
                var phone = (f['Phone #'] || f['Phone'] || '').toLowerCase();
                if (!name.includes(searchVal) && !phone.includes(searchVal)) return false;
            }

            // Ownership filter
            if (ownershipFilter !== 'all') {
                var isOwned = isLeadOwnedByUser(l);
                var hasSharedWith = f['Shared With'] && f['Shared With'].length > 0;
                var hasSharedWithEmail = f['Shared With Email'] && (Array.isArray(f['Shared With Email']) ? f['Shared With Email'].length > 0 : f['Shared With Email']);
                var isSharedByMe = !l.isShared && (hasSharedWith || hasSharedWithEmail);
                var isSharedWithMe = l.isShared === true;

                if (ownershipFilter === 'mine' && !isOwned) return false;
                if (ownershipFilter === 'shared-by' && !isSharedByMe) return false;
                if (ownershipFilter === 'not-shared' && (isSharedByMe || isSharedWithMe)) return false;
                if (ownershipFilter === 'shared-with' && !isSharedWithMe) return false;
            }

            // Timeframe filter
            if (timeframeFilter !== 'all') {
                var lastCall = f['Last Call Timestamp'] || f['Client Last Call Timestamp'];
                if (!lastCall) return false;
                var daysDiff = getDaysDiff(new Date(lastCall));
                if (timeframeFilter === 'today' && daysDiff > 0) return false;
                if (timeframeFilter === '7days' && daysDiff > 7) return false;
                if (timeframeFilter === '30days' && daysDiff > 30) return false;
                if (timeframeFilter === '90days' && daysDiff > 90) return false;
            }

            return true;
        });

        // Sort based on dropdown and direction
        var sortBy = document.getElementById('prospectsSort').value;
        var dir = prospectsSortAsc ? 1 : -1;
        prospects.sort(function(a, b) {
            var fa = a.fields, fb = b.fields;
            var result;
            switch (sortBy) {
                case 'name':
                    var nameA = ((fa['First Name'] || '') + ' ' + (fa['Last Name'] || '')).toLowerCase();
                    var nameB = ((fb['First Name'] || '') + ' ' + (fb['Last Name'] || '')).toLowerCase();
                    result = nameA.localeCompare(nameB);
                    break;
                case 'lastUpdated':
                    var updA = new Date(fa['Updated At'] || 0).getTime();
                    var updB = new Date(fb['Updated At'] || 0).getTime();
                    result = updA - updB;
                    break;
                case 'bookedTime':
                default:
                    var timeA = new Date(fa['Booked Time'] || fa['Callback Date'] || 0).getTime();
                    var timeB = new Date(fb['Booked Time'] || fb['Callback Date'] || 0).getTime();
                    result = timeA - timeB;
                    break;
            }
            return result * dir;
        });

        // Update count badge
        var prospectsCountEl = document.getElementById('prospectsCount');
        if (prospectsCountEl) prospectsCountEl.textContent = prospects.length;

        if (prospects.length === 0) {
            prospectsList.innerHTML = '<div class="prospects-empty">No prospects found</div>';
            return;
        }

        prospectsList.innerHTML = prospects.map(function(lead) {
            var f = lead.fields;
            var name = ((f['First Name'] || '') + ' ' + (f['Last Name'] || '')).trim() || 'Unknown';
            var phone = f['Phone #'] || f['Phone'] || '-';
            var formattedPhone = formatPhoneNumber(phone);
            var lastUpdatedTimestamp = f['Updated At'];
            var lastUpdated = lastUpdatedTimestamp ? formatTimeAgo(lastUpdatedTimestamp) : '-';
            var lastUpdatedColor = getLastCalledColor(lastUpdatedTimestamp);
            var bookedTime = f['Booked Time'] || null;
            var callbackDate = f['Callback Date'] || f['Follow Up Date'];
            var summary = f['Last Call Summary'] || f['Summary'] || '';
            var notesRaw = f['Client Notes'] || f['Notes'] || '';
            var isShared = lead.isShared || (f['Shared With'] && f['Shared With'].length > 0) || (f['Shared With Email'] && (Array.isArray(f['Shared With Email']) ? f['Shared With Email'].length > 0 : f['Shared With Email']));
            var isPrio = f['Is Prio'] === true;
            var status = f['Status'] || f['Disposition'] || '';

            // Parse notes
            var notesArray = parseNotesJson(notesRaw);
            var lastNoteText = notesArray.length > 0 ? notesArray[notesArray.length - 1].text : 'No notes yet';

            // Get date and time display
            var dateDisplay = '';
            var timeDisplay = '';
            var hasSchedule = false;
            if (bookedTime) {
                var d = new Date(bookedTime);
                dateDisplay = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                timeDisplay = d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
            } else if (callbackDate) {
                var d = new Date(callbackDate);
                dateDisplay = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                timeDisplay = d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
            } else {
                hasSchedule = true;
            }

            var timeCol;
            if (hasSchedule) {
                timeCol = '<button class="btn-schedule-card" onclick="event.stopPropagation();quickSchedule(\'' + lead.id + '\')">Schedule</button>';
            } else if (dateDisplay) {
                timeCol = '<span class="date-value">' + dateDisplay + '</span><span class="time-value">' + timeDisplay + '</span>';
            } else {
                timeCol = '<span class="time-value">' + timeDisplay + '</span>';
            }

            // Status for card dropdown
            var cardStatus = status;

            var prioIndicator = isPrio ? '<img src="/assets/favicon.png" class="prio-icon" title="Priority Lead">' : '';

            return '<div class="priority-card-lg" data-id="' + lead.id + '">' +
                '<div class="priority-card-lg-left" onclick="openLeadModal(\'' + lead.id + '\')">' +
                    '<div class="priority-card-lg-time-col">' +
                        prioIndicator +
                        timeCol +
                    '</div>' +
                    '<div class="priority-card-lg-info">' +
                        '<div class="priority-card-lg-top">' +
                            '<div class="priority-card-lg-name">' + escapeHtml(name) + getSharedIconHtml(lead) + '</div>' +
                        '</div>' +
                        '<div class="priority-card-lg-phone"> ' + phoneLink(phone, formattedPhone) + '</div>' +
                        '<div class="priority-card-lg-lastcall">Updated ' + lastUpdated + ' <span class="lastcall-dot ' + lastUpdatedColor + '"></span></div>' +
                    '</div>' +
                '</div>' +
                getCardStatusHtml(lead) +
                '<div class="priority-card-lg-summary-col" onclick="openLeadModal(\'' + lead.id + '\')">' +
                    '<div class="col-label">Summary</div>' +
                    '<div class="col-content">' + (summary ? escapeHtml(summary) : '<span style="color:rgba(255,255,255,0.4)">No summary available</span>') + '</div>' +
                '</div>' +
                '<div class="priority-card-lg-notes-col" onclick="openLeadModal(\'' + lead.id + '\')">' +
                    '<div class="col-label">Notes</div>' +
                    '<div class="col-content">' + escapeHtml(lastNoteText) + '</div>' +
                '</div>' +
                '<div class="priority-card-lg-actions">' +
                    '<button class="action-btn action-share' + (isShared ? ' shared' : '') + '" onclick="event.stopPropagation();quickShareLead(\'' + lead.id + '\')"><span class="action-icon">' + (isShared ? '' : '') + '</span><span class="action-label">' + (isShared ? 'Shared' : 'Share') + '</span></button>' +
                    '<button class="action-btn action-ai" onclick="event.stopPropagation();quickSendToAI(\'' + lead.id + '\')"><span class="action-icon"></span><span class="action-label">Send to AI</span></button>' +
                    '<button class="action-btn action-dnc" onclick="event.stopPropagation();quickMarkDNC(\'' + lead.id + '\')"><span class="action-icon"></span><span class="action-label">Do Not Call</span></button>' +
                    '<button class="action-btn action-reschedule" onclick="event.stopPropagation();quickReschedule(\'' + lead.id + '\')"><span class="action-icon"></span><span class="action-label">Reschedule</span></button>' +
                '</div>' +
            '</div>';
        }).join('');
    }

    // ===== PIPELINE TAB =====
    function updatePipelineList() {
        var pipelineList = document.getElementById('pipelineList');
        if (!pipelineList) return;

        var searchVal = (document.getElementById('pipelineSearch')?.value || '').toLowerCase();
        var statusFilter = document.getElementById('pipelineStatus')?.value || 'all';
        var timeframeFilter = document.getElementById('pipelineTimeframe')?.value || 'all';
        var sortBy = document.getElementById('pipelineSort')?.value || 'nextCall';

        // Get Timeline and Follow Up leads
        var pipelineLeads = allLeads.filter(function(l) {
            var f = l.fields;
            var status = f['Status'] || f['Disposition'] || '';

            if (status !== 'Timeline' && status !== 'Follow Up') return false;

            // Status filter
            if (statusFilter !== 'all' && status !== statusFilter) return false;

            // Search filter
            if (searchVal) {
                var name = ((f['First Name'] || '') + ' ' + (f['Last Name'] || '')).toLowerCase();
                var phone = (f['Phone #'] || f['Phone'] || '').toLowerCase();
                if (!name.includes(searchVal) && !phone.includes(searchVal)) return false;
            }

            // Timeframe filter (for Next Call Date)
            if (timeframeFilter !== 'all' && f['Next Call Date']) {
                var nextCall = new Date(f['Next Call Date']);
                var now = new Date();
                var daysDiff = Math.ceil((nextCall - now) / (1000 * 60 * 60 * 24));
                if (timeframeFilter === '7days' && daysDiff > 7) return false;
                if (timeframeFilter === '30days' && daysDiff > 30) return false;
                if (timeframeFilter === '90days' && daysDiff > 90) return false;
            }

            return true;
        });

        // Sort based on dropdown and direction
        var dir = pipelineSortAsc ? 1 : -1;
        pipelineLeads.sort(function(a, b) {
            var fa = a.fields, fb = b.fields;
            var result;
            switch (sortBy) {
                case 'name':
                    var nameA = ((fa['First Name'] || '') + ' ' + (fa['Last Name'] || '')).toLowerCase();
                    var nameB = ((fb['First Name'] || '') + ' ' + (fb['Last Name'] || '')).toLowerCase();
                    result = nameA.localeCompare(nameB);
                    break;
                case 'lastUpdated':
                    var updA = new Date(fa['Updated At'] || 0).getTime();
                    var updB = new Date(fb['Updated At'] || 0).getTime();
                    result = updA - updB;
                    break;
                case 'nextCall':
                default:
                    var aDate = new Date(fa['Next Call Date'] || '9999-12-31').getTime();
                    var bDate = new Date(fb['Next Call Date'] || '9999-12-31').getTime();
                    result = aDate - bDate;
                    break;
            }
            return result * dir;
        });

        // Update count badge
        var pipelineCountEl = document.getElementById('pipelineCount');
        if (pipelineCountEl) pipelineCountEl.textContent = pipelineLeads.length;

        if (pipelineLeads.length === 0) {
            pipelineList.innerHTML = '<div class="pipeline-empty">No leads in AI pipeline</div>';
            return;
        }

        pipelineList.innerHTML = pipelineLeads.map(function(lead) {
            var f = lead.fields;
            var name = ((f['First Name'] || '') + ' ' + (f['Last Name'] || '')).trim() || 'Unknown';
            var phone = f['Phone #'] || f['Phone'] || '-';
            var formattedPhone = formatPhoneNumber(phone);
            var lastUpdatedTimestamp = f['Updated At'];
            var lastUpdated = lastUpdatedTimestamp ? formatTimeAgo(lastUpdatedTimestamp) : '-';
            var lastUpdatedColor = getLastCalledColor(lastUpdatedTimestamp);
            var summary = f['Last Call Summary'] || f['Summary'] || '';
            var isShared = lead.isShared || (f['Shared With'] && f['Shared With'].length > 0) || (f['Shared With Email'] && (Array.isArray(f['Shared With Email']) ? f['Shared With Email'].length > 0 : f['Shared With Email']));

            // Next Call Date display
            var dateDisplay = '';
            var timeDisplay = '';
            var nextCallDate = f['Next Call Date'];
            if (nextCallDate) {
                var d = new Date(nextCallDate);
                dateDisplay = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                timeDisplay = d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
            } else {
                dateDisplay = 'Not';
                timeDisplay = 'scheduled';
            }

            var timeCol = '<span class="date-value">' + dateDisplay + '</span><span class="time-value">' + timeDisplay + '</span>';

            return '<div class="priority-card-lg" data-id="' + lead.id + '">' +
                '<div class="priority-card-lg-left" onclick="openLeadModal(\'' + lead.id + '\')">' +
                    '<div class="priority-card-lg-time-col">' +
                        timeCol +
                    '</div>' +
                    '<div class="priority-card-lg-info">' +
                        '<div class="priority-card-lg-top">' +
                            '<div class="priority-card-lg-name">' + escapeHtml(name) + getSharedIconHtml(lead) + '</div>' +
                        '</div>' +
                        '<div class="priority-card-lg-phone"> ' + phoneLink(phone, formattedPhone) + '</div>' +
                        '<div class="priority-card-lg-lastcall">Updated ' + lastUpdated + ' <span class="lastcall-dot ' + lastUpdatedColor + '"></span></div>' +
                    '</div>' +
                '</div>' +
                getCardStatusHtml(lead) +
                '<div class="priority-card-lg-summary-col" onclick="openLeadModal(\'' + lead.id + '\')">' +
                    '<div class="col-label">Summary</div>' +
                    '<div class="col-content">' + (summary ? escapeHtml(summary) : '<span style="color:rgba(255,255,255,0.4)">No summary available</span>') + '</div>' +
                '</div>' +
                '<div class="priority-card-lg-actions" style="display:flex;align-items:center;justify-content:center;padding:16px">' +
                    '<button class="btn-takeover" onclick="event.stopPropagation();takeOverLead(\'' + lead.id + '\')"> Take Over</button>' +
                '</div>' +
            '</div>';
        }).join('');
    }

    // ===== UNQUALIFIED LEADS TAB =====
    var unqualifiedOutcomeFilter = 'all';
    var unqualifiedSortAsc = false;

    function setUnqualifiedView(view) {
        var list = document.getElementById('unqualifiedList');
        var listBtn = document.getElementById('unqualifiedViewList');
        var gridBtn = document.getElementById('unqualifiedViewGrid');
        if (view === 'list') {
            list?.classList.add('list-view');
            listBtn?.classList.add('active');
            gridBtn?.classList.remove('active');
        } else {
            list?.classList.remove('list-view');
            listBtn?.classList.remove('active');
            gridBtn?.classList.add('active');
        }
    }

    function toggleUnqualifiedSortDir() {
        unqualifiedSortAsc = !unqualifiedSortAsc;
        var btn = document.getElementById('unqualifiedSortDir');
        if (btn) btn.textContent = unqualifiedSortAsc ? '' : '';
        updateUnqualifiedList();
    }

    function updateUnqualifiedList() {
        var unqualifiedList = document.getElementById('unqualifiedList');
        if (!unqualifiedList) return;

        var searchVal = (document.getElementById('unqualifiedSearch')?.value || '').toLowerCase();
        var ownershipFilter = document.getElementById('unqualifiedOwnership')?.value || 'all';
        var timeframeFilter = document.getElementById('unqualifiedTimeframe')?.value || 'all';
        var sortBy = document.getElementById('unqualifiedSort')?.value || 'lastUpdated';

        // Filter leads: Status = Closed or DNC, Last Outcome = Max Attempts, Wrong Person, DNC, or Inconclusive
        var unqualifiedLeads = allLeads.filter(function(l) {
            var f = l.fields;
            var status = f['Status'] || f['Disposition'] || '';
            var statusLower = status.toLowerCase();
            var lastOutcome = f['Last Outcome'] || '';
            var lastOutcomeLower = lastOutcome.toLowerCase();

            // Only include leads with Status = Closed or DNC
            if (statusLower !== 'closed' && statusLower !== 'dnc') return false;

            // Only include leads with Last Outcome = Max Attempts, Wrong Person, DNC, or Inconclusive
            var validOutcomes = ['max attempts', 'wrong person', 'dnc', 'inconclusive'];
            if (!validOutcomes.includes(lastOutcomeLower)) return false;

            // Filter by Last Outcome tab
            if (unqualifiedOutcomeFilter !== 'all') {
                if (lastOutcome !== unqualifiedOutcomeFilter) return false;
            }

            // Ownership filter
            if (ownershipFilter !== 'all') {
                var isOwned = isLeadOwnedByUser(l);
                var hasSharedWith = f['Shared With'] && f['Shared With'].length > 0;
                var hasSharedWithEmail = f['Shared With Email'] && (Array.isArray(f['Shared With Email']) ? f['Shared With Email'].length > 0 : f['Shared With Email']);
                var isSharedByMe = !l.isShared && (hasSharedWith || hasSharedWithEmail);
                var isSharedWithMe = l.isShared === true;
                if (ownershipFilter === 'mine' && !isOwned) return false;
                if (ownershipFilter === 'shared-by' && !isSharedByMe) return false;
                if (ownershipFilter === 'not-shared' && (isSharedByMe || isSharedWithMe)) return false;
                if (ownershipFilter === 'shared-with' && !isSharedWithMe) return false;
            }

            // Search filter
            if (searchVal) {
                var name = ((f['First Name'] || '') + ' ' + (f['Last Name'] || '')).toLowerCase();
                var phone = (f['Phone #'] || f['Phone'] || '').toLowerCase();
                if (!name.includes(searchVal) && !phone.includes(searchVal)) return false;
            }

            // Timeframe filter
            if (timeframeFilter !== 'all') {
                var lastUpdated = f['Updated At'] ? new Date(f['Updated At']) : null;
                if (!lastUpdated) return timeframeFilter === 'all';
                var now = new Date();
                var daysDiff = Math.floor((now - lastUpdated) / (1000 * 60 * 60 * 24));
                if (timeframeFilter === 'today' && daysDiff > 0) return false;
                if (timeframeFilter === '7days' && daysDiff > 7) return false;
                if (timeframeFilter === '30days' && daysDiff > 30) return false;
                if (timeframeFilter === '90days' && daysDiff > 90) return false;
            }

            return true;
        });

        // Sort based on dropdown and direction
        var dir = unqualifiedSortAsc ? 1 : -1;
        unqualifiedLeads.sort(function(a, b) {
            var fa = a.fields, fb = b.fields;
            var result;
            switch (sortBy) {
                case 'name':
                    var nameA = ((fa['First Name'] || '') + ' ' + (fa['Last Name'] || '')).toLowerCase();
                    var nameB = ((fb['First Name'] || '') + ' ' + (fb['Last Name'] || '')).toLowerCase();
                    result = nameA.localeCompare(nameB);
                    break;
                case 'nextCall':
                    var aDate = new Date(fa['Next Call Date'] || '9999-12-31').getTime();
                    var bDate = new Date(fb['Next Call Date'] || '9999-12-31').getTime();
                    result = aDate - bDate;
                    break;
                case 'lastUpdated':
                default:
                    var updA = new Date(fa['Updated At'] || 0).getTime();
                    var updB = new Date(fb['Updated At'] || 0).getTime();
                    result = updB - updA; // Most recent first by default
                    break;
            }
            return result * dir;
        });

        // Update count badge
        var unqualifiedCountEl = document.getElementById('unqualifiedCount');
        if (unqualifiedCountEl) unqualifiedCountEl.textContent = unqualifiedLeads.length;

        if (unqualifiedLeads.length === 0) {
            unqualifiedList.innerHTML = '<div class="pipeline-empty">No unqualified leads found</div>';
            return;
        }

        unqualifiedList.innerHTML = unqualifiedLeads.map(function(lead) {
            var f = lead.fields;
            var name = ((f['First Name'] || '') + ' ' + (f['Last Name'] || '')).trim() || 'Unknown';
            var phone = f['Phone #'] || f['Phone'] || '-';
            var formattedPhone = formatPhoneNumber(phone);
            var lastUpdatedTimestamp = f['Updated At'];
            var lastUpdated = lastUpdatedTimestamp ? formatTimeAgo(lastUpdatedTimestamp) : '-';
            var lastUpdatedColor = getLastCalledColor(lastUpdatedTimestamp);
            var summary = f['Last Call Summary'] || f['Summary'] || '';
            var notesRaw = f['Client Notes'] || f['Notes'] || '';
            var isShared = lead.isShared || (f['Shared With'] && f['Shared With'].length > 0) || (f['Shared With Email'] && (Array.isArray(f['Shared With Email']) ? f['Shared With Email'].length > 0 : f['Shared With Email']));
            var isPrio = f['Is Prio'] === true;
            var status = f['Status'] || f['Disposition'] || 'Unknown';
            var lastOutcome = f['Last Outcome'] || '';
            var lastOutcomeLower = lastOutcome.toLowerCase();
            // Disable Change Call Date for Wrong Person and DNC outcomes (only Max Attempts and Inconclusive can change)
            var canChangeCallDate = lastOutcomeLower !== 'wrong person' && lastOutcomeLower !== 'dnc';

            // Parse notes
            var notesArray = parseNotesJson(notesRaw);
            var lastNoteText = notesArray.length > 0 ? notesArray[notesArray.length - 1].text : 'No notes yet';

            // Next Call Date display
            var dateDisplay = '';
            var timeDisplay = '';
            var nextCallDate = f['Next Call Date'];
            if (nextCallDate) {
                var d = new Date(nextCallDate);
                dateDisplay = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                timeDisplay = d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
            } else {
                dateDisplay = 'No next';
                timeDisplay = 'call';
            }

            var timeCol = '<span class="date-value">' + dateDisplay + '</span><span class="time-value">' + timeDisplay + '</span>';

            var prioIndicator = isPrio ? '<img src="/assets/favicon.png" class="prio-icon" title="Priority Lead">' : '';

            return '<div class="priority-card-lg" data-id="' + lead.id + '">' +
                '<div class="priority-card-lg-left" onclick="openLeadModal(\'' + lead.id + '\')">' +
                    '<div class="priority-card-lg-time-col">' +
                        prioIndicator +
                        timeCol +
                    '</div>' +
                    '<div class="priority-card-lg-info">' +
                        '<div class="priority-card-lg-top">' +
                            '<div class="priority-card-lg-name">' + escapeHtml(name) + getSharedIconHtml(lead) + '</div>' +
                        '</div>' +
                        '<div class="priority-card-lg-phone"> ' + phoneLink(phone, formattedPhone) + '</div>' +
                        '<div class="priority-card-lg-lastcall">Updated ' + lastUpdated + ' <span class="lastcall-dot ' + lastUpdatedColor + '"></span></div>' +
                    '</div>' +
                '</div>' +
                getCardStatusHtml(lead) +
                '<div class="priority-card-lg-summary-col unqualified-summary-wide" onclick="openLeadModal(\'' + lead.id + '\')">' +
                    '<div class="col-label">Summary</div>' +
                    '<div class="col-content">' + (summary ? escapeHtml(summary) : '<span style="color:rgba(255,255,255,0.4)">No summary available</span>') + '</div>' +
                '</div>' +
                '<div class="priority-card-lg-actions">' +
                    '<button class="action-btn action-reschedule' + (canChangeCallDate ? '' : ' disabled') + '"' + (canChangeCallDate ? ' onclick="event.stopPropagation();quickReschedule(\'' + lead.id + '\')"' : ' disabled') + '><span class="action-icon"></span><span class="action-label">Change Call Date</span></button>' +
                    '<button class="action-btn action-takeover" onclick="event.stopPropagation();takeOverLead(\'' + lead.id + '\')"><span class="action-icon"></span><span class="action-label">Take Over</span></button>' +
                '</div>' +
            '</div>';
        }).join('');
    }

    // Unqualified Leads tab switching (filters by Last Outcome)
    document.querySelectorAll('.unqualified-tab').forEach(function(tab) {
        tab.addEventListener('click', function() {
            document.querySelectorAll('.unqualified-tab').forEach(function(t) { t.classList.remove('active'); });
            this.classList.add('active');
            unqualifiedOutcomeFilter = this.dataset.outcome;
            updateUnqualifiedList();
        });
    });

    // Unqualified Leads filter listeners
    document.getElementById('unqualifiedSearch')?.addEventListener('input', debounce(function() {
        updateUnqualifiedList();
    }, 300));
    document.getElementById('unqualifiedOwnership')?.addEventListener('change', updateUnqualifiedList);
    document.getElementById('unqualifiedTimeframe')?.addEventListener('change', updateUnqualifiedList);
    document.getElementById('unqualifiedSort')?.addEventListener('change', updateUnqualifiedList);

    // ===== OPEN LEADS TAB =====
    var openLeadsStatusFilter = 'all';
    var openLeadsSortAsc = false;

    function setOpenLeadsView(view) {
        var list = document.getElementById('openLeadsList');
        var listBtn = document.getElementById('openLeadsViewList');
        var gridBtn = document.getElementById('openLeadsViewGrid');
        if (view === 'list') {
            list?.classList.add('list-view');
            listBtn?.classList.add('active');
            gridBtn?.classList.remove('active');
        } else {
            list?.classList.remove('list-view');
            listBtn?.classList.remove('active');
            gridBtn?.classList.add('active');
        }
    }

    function toggleOpenLeadsSortDir() {
        openLeadsSortAsc = !openLeadsSortAsc;
        var btn = document.getElementById('openLeadsSortDir');
        if (btn) btn.textContent = openLeadsSortAsc ? '' : '';
        updateOpenLeadsList();
    }

    function updateOpenLeadsList() {
        var openLeadsList = document.getElementById('openLeadsList');
        if (!openLeadsList) return;

        var searchVal = (document.getElementById('openLeadsSearch')?.value || '').toLowerCase();
        var ownershipFilter = document.getElementById('openLeadsOwnership')?.value || 'all';
        var timeframeFilter = document.getElementById('openLeadsTimeframe')?.value || 'all';
        var sortBy = document.getElementById('openLeadsSort')?.value || 'lastUpdated';

        // Filter leads: Status = New or Retry
        var openLeads = allLeads.filter(function(l) {
            var f = l.fields;
            var status = f['Status'] || f['Disposition'] || '';
            var statusLower = status.toLowerCase();

            // Only include leads with Status = New or Retry
            if (statusLower !== 'new' && statusLower !== 'retry') return false;

            // Filter by Status tab
            if (openLeadsStatusFilter !== 'all') {
                if (status !== openLeadsStatusFilter) return false;
            }

            // Ownership filter
            if (ownershipFilter !== 'all') {
                var isOwned = isLeadOwnedByUser(l);
                var hasSharedWith = f['Shared With'] && f['Shared With'].length > 0;
                var hasSharedWithEmail = f['Shared With Email'] && (Array.isArray(f['Shared With Email']) ? f['Shared With Email'].length > 0 : f['Shared With Email']);
                var isSharedByMe = !l.isShared && (hasSharedWith || hasSharedWithEmail);
                var isSharedWithMe = l.isShared === true;
                if (ownershipFilter === 'mine' && !isOwned) return false;
                if (ownershipFilter === 'shared-by' && !isSharedByMe) return false;
                if (ownershipFilter === 'not-shared' && (isSharedByMe || isSharedWithMe)) return false;
                if (ownershipFilter === 'shared-with' && !isSharedWithMe) return false;
            }

            // Search filter
            if (searchVal) {
                var name = ((f['First Name'] || '') + ' ' + (f['Last Name'] || '')).toLowerCase();
                var phone = (f['Phone #'] || f['Phone'] || '').toLowerCase();
                if (!name.includes(searchVal) && !phone.includes(searchVal)) return false;
            }

            // Timeframe filter
            if (timeframeFilter !== 'all') {
                var lastUpdated = f['Updated At'] ? new Date(f['Updated At']) : null;
                if (!lastUpdated) return timeframeFilter === 'all';
                var now = new Date();
                var daysDiff = Math.floor((now - lastUpdated) / (1000 * 60 * 60 * 24));
                if (timeframeFilter === 'today' && daysDiff > 0) return false;
                if (timeframeFilter === '7days' && daysDiff > 7) return false;
                if (timeframeFilter === '30days' && daysDiff > 30) return false;
                if (timeframeFilter === '90days' && daysDiff > 90) return false;
            }

            return true;
        });

        // Sort based on dropdown and direction
        var dir = openLeadsSortAsc ? 1 : -1;
        openLeads.sort(function(a, b) {
            var fa = a.fields, fb = b.fields;
            var result;
            switch (sortBy) {
                case 'name':
                    var nameA = ((fa['First Name'] || '') + ' ' + (fa['Last Name'] || '')).toLowerCase();
                    var nameB = ((fb['First Name'] || '') + ' ' + (fb['Last Name'] || '')).toLowerCase();
                    result = nameA.localeCompare(nameB);
                    break;
                case 'nextCall':
                    var aDate = new Date(fa['Next Call Date'] || '9999-12-31').getTime();
                    var bDate = new Date(fb['Next Call Date'] || '9999-12-31').getTime();
                    result = aDate - bDate;
                    break;
                case 'lastUpdated':
                default:
                    var updA = new Date(fa['Updated At'] || 0).getTime();
                    var updB = new Date(fb['Updated At'] || 0).getTime();
                    result = updB - updA; // Most recent first by default
                    break;
            }
            return result * dir;
        });

        // Update count badge
        var openLeadsCountEl = document.getElementById('openLeadsCount');
        if (openLeadsCountEl) openLeadsCountEl.textContent = openLeads.length;

        if (openLeads.length === 0) {
            openLeadsList.innerHTML = '<div class="pipeline-empty">No open leads found</div>';
            return;
        }

        openLeadsList.innerHTML = openLeads.map(function(lead) {
            var f = lead.fields;
            var name = ((f['First Name'] || '') + ' ' + (f['Last Name'] || '')).trim() || 'Unknown';
            var phone = f['Phone #'] || f['Phone'] || '-';
            var formattedPhone = formatPhoneNumber(phone);
            var lastUpdatedTimestamp = f['Updated At'];
            var lastUpdated = lastUpdatedTimestamp ? formatTimeAgo(lastUpdatedTimestamp) : '-';
            var lastUpdatedColor = getLastCalledColor(lastUpdatedTimestamp);
            var summary = f['Last Call Summary'] || f['Summary'] || '';
            var notesRaw = f['Client Notes'] || f['Notes'] || '';
            var isShared = lead.isShared || (f['Shared With'] && f['Shared With'].length > 0) || (f['Shared With Email'] && (Array.isArray(f['Shared With Email']) ? f['Shared With Email'].length > 0 : f['Shared With Email']));
            var isPrio = f['Is Prio'] === true;
            var status = f['Status'] || f['Disposition'] || 'Unknown';

            // Parse notes
            var notesArray = parseNotesJson(notesRaw);
            var lastNoteText = notesArray.length > 0 ? notesArray[notesArray.length - 1].text : 'No notes yet';

            // Next Call Date display
            var dateDisplay = '';
            var timeDisplay = '';
            var nextCallDate = f['Next Call Date'];
            if (nextCallDate) {
                var d = new Date(nextCallDate);
                dateDisplay = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                timeDisplay = d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
            } else {
                dateDisplay = 'No next';
                timeDisplay = 'call';
            }

            var timeCol = '<span class="date-value">' + dateDisplay + '</span><span class="time-value">' + timeDisplay + '</span>';

            var prioIndicator = isPrio ? '<img src="/assets/favicon.png" class="prio-icon" title="Priority Lead">' : '';

            return '<div class="priority-card-lg" data-id="' + lead.id + '">' +
                '<div class="priority-card-lg-left" onclick="openLeadModal(\'' + lead.id + '\')">' +
                    '<div class="priority-card-lg-time-col">' +
                        prioIndicator +
                        timeCol +
                    '</div>' +
                    '<div class="priority-card-lg-info">' +
                        '<div class="priority-card-lg-top">' +
                            '<div class="priority-card-lg-name">' + escapeHtml(name) + getSharedIconHtml(lead) + '</div>' +
                        '</div>' +
                        '<div class="priority-card-lg-phone"> ' + phoneLink(phone, formattedPhone) + '</div>' +
                        '<div class="priority-card-lg-lastcall">Updated ' + lastUpdated + ' <span class="lastcall-dot ' + lastUpdatedColor + '"></span></div>' +
                    '</div>' +
                '</div>' +
                getCardStatusHtml(lead) +
                '<div class="priority-card-lg-summary-col" onclick="openLeadModal(\'' + lead.id + '\')">' +
                    '<div class="col-label">Summary</div>' +
                    '<div class="col-content">' + (summary ? escapeHtml(summary) : '<span style="color:rgba(255,255,255,0.4)">No summary available</span>') + '</div>' +
                '</div>' +
                '<div class="priority-card-lg-notes-col" onclick="openLeadModal(\'' + lead.id + '\')">' +
                    '<div class="col-label">Notes</div>' +
                    '<div class="col-content">' + escapeHtml(lastNoteText) + '</div>' +
                '</div>' +
                '<div class="priority-card-lg-actions">' +
                    '<button class="action-btn action-share' + (isShared ? ' shared' : '') + '" onclick="event.stopPropagation();quickShareLead(\'' + lead.id + '\')"><span class="action-icon">' + (isShared ? '' : '') + '</span><span class="action-label">' + (isShared ? 'Shared' : 'Share') + '</span></button>' +
                    '<button class="action-btn action-reschedule" onclick="event.stopPropagation();quickReschedule(\'' + lead.id + '\')"><span class="action-icon"></span><span class="action-label">Change Call Date</span></button>' +
                    '<button class="action-btn action-dnc" onclick="event.stopPropagation();quickMarkDNC(\'' + lead.id + '\')"><span class="action-icon"></span><span class="action-label">Do Not Call</span></button>' +
                    '<button class="action-btn action-prio" onclick="event.stopPropagation();markAsPrio(\'' + lead.id + '\')"><span class="action-icon"></span><span class="action-label">Prio</span></button>' +
                '</div>' +
            '</div>';
        }).join('');
    }

    // Open Leads tab switching
    document.querySelectorAll('#page-open-leads .unqualified-tab').forEach(function(tab) {
        tab.addEventListener('click', function() {
            document.querySelectorAll('#page-open-leads .unqualified-tab').forEach(function(t) { t.classList.remove('active'); });
            this.classList.add('active');
            openLeadsStatusFilter = this.dataset.openStatus;
            updateOpenLeadsList();
        });
    });

    // Open Leads filter listeners
    document.getElementById('openLeadsSearch')?.addEventListener('input', debounce(function() {
        updateOpenLeadsList();
    }, 300));
    document.getElementById('openLeadsOwnership')?.addEventListener('change', updateOpenLeadsList);
    document.getElementById('openLeadsTimeframe')?.addEventListener('change', updateOpenLeadsList);
    document.getElementById('openLeadsSort')?.addEventListener('change', updateOpenLeadsList);

    // ============ BOOKED TODAY PAGE ============
    var bookedTodayTypeFilter = 'all';
    var bookedTodaySortAsc = false;

    function setBookedTodayView(view) {
        var list = document.getElementById('bookedTodayList');
        if (!list) return;
        if (view === 'grid') {
            list.classList.remove('list-view');
            list.classList.add('grid-view');
            document.getElementById('bookedTodayViewList')?.classList.remove('active');
            document.getElementById('bookedTodayViewGrid')?.classList.add('active');
        } else {
            list.classList.remove('grid-view');
            list.classList.add('list-view');
            document.getElementById('bookedTodayViewGrid')?.classList.remove('active');
            document.getElementById('bookedTodayViewList')?.classList.add('active');
        }
    }

    function toggleBookedTodaySortDir() {
        bookedTodaySortAsc = !bookedTodaySortAsc;
        var btn = document.getElementById('bookedTodaySortDir');
        if (btn) btn.textContent = bookedTodaySortAsc ? '' : '';
        updateBookedTodayList();
    }

    function updateBookedTodayList() {
        var bookedTodayListEl = document.getElementById('bookedTodayList');
        if (!bookedTodayListEl) return;

        var searchVal = (document.getElementById('bookedTodaySearch')?.value || '').toLowerCase();
        var sortBy = document.getElementById('bookedTodaySort')?.value || 'callTime';

        // Get today's date in EST
        var nowEST = new Date(new Date().toLocaleString('en-US', { timeZone: 'America/New_York' }));
        var todayEST = nowEST.getFullYear() + '-' + String(nowEST.getMonth() + 1).padStart(2, '0') + '-' + String(nowEST.getDate()).padStart(2, '0');

        // Filter leads: AI called today AND resulted in Booked or Callback
        var bookedTodayLeads = allLeads.filter(function(l) {
            var f = l.fields;
            var lastCallTimestamp = f['Last Call Timestamp'];
            if (!lastCallTimestamp) return false;

            // Check if AI called today (in EST)
            var callDate = new Date(lastCallTimestamp);
            var callDateEST = new Date(callDate.toLocaleString('en-US', { timeZone: 'America/New_York' }));
            var callDateStr = callDateEST.getFullYear() + '-' + String(callDateEST.getMonth() + 1).padStart(2, '0') + '-' + String(callDateEST.getDate()).padStart(2, '0');
            if (callDateStr !== todayEST) return false;

            // Check if outcome was Booked or Callback
            var status = f['Status'] || f['Disposition'] || '';
            var outcome = f['Outcome'] || '';
            var statusLower = status.toLowerCase();
            var outcomeLower = outcome.toLowerCase();
            var isBooked = statusLower === 'booked' || outcomeLower === 'booked';
            var isCallback = statusLower === 'callback' || outcomeLower === 'callback';

            if (!isBooked && !isCallback) return false;

            // Filter by type tab
            if (bookedTodayTypeFilter !== 'all') {
                if (bookedTodayTypeFilter === 'Booked' && !isBooked) return false;
                if (bookedTodayTypeFilter === 'Callback' && !isCallback) return false;
            }

            // Search filter
            if (searchVal) {
                var name = ((f['First Name'] || '') + ' ' + (f['Last Name'] || '')).toLowerCase();
                var phone = (f['Phone #'] || f['Phone'] || '').toLowerCase();
                if (!name.includes(searchVal) && !phone.includes(searchVal)) return false;
            }

            return true;
        });

        // Sort based on dropdown and direction
        var dir = bookedTodaySortAsc ? 1 : -1;
        bookedTodayLeads.sort(function(a, b) {
            var fa = a.fields, fb = b.fields;
            var result;
            switch (sortBy) {
                case 'name':
                    var nameA = ((fa['First Name'] || '') + ' ' + (fa['Last Name'] || '')).toLowerCase();
                    var nameB = ((fb['First Name'] || '') + ' ' + (fb['Last Name'] || '')).toLowerCase();
                    result = nameA.localeCompare(nameB);
                    break;
                case 'bookedTime':
                    var aDate = new Date(fa['Booked Time'] || fa['Callback Date'] || '9999-12-31').getTime();
                    var bDate = new Date(fb['Booked Time'] || fb['Callback Date'] || '9999-12-31').getTime();
                    result = aDate - bDate;
                    break;
                case 'callTime':
                default:
                    var callA = new Date(fa['Last Call Timestamp'] || 0).getTime();
                    var callB = new Date(fb['Last Call Timestamp'] || 0).getTime();
                    result = callB - callA; // Most recent first by default
                    break;
            }
            return result * dir;
        });

        // Update count badge
        var bookedTodayCountEl = document.getElementById('bookedTodayCount');
        if (bookedTodayCountEl) bookedTodayCountEl.textContent = bookedTodayLeads.length;

        if (bookedTodayLeads.length === 0) {
            bookedTodayListEl.innerHTML = '<div class="pipeline-empty">No AI-booked leads from today yet</div>';
            return;
        }

        bookedTodayListEl.innerHTML = bookedTodayLeads.map(function(lead) {
            var f = lead.fields;
            var name = ((f['First Name'] || '') + ' ' + (f['Last Name'] || '')).trim() || 'Unknown';
            var phone = f['Phone #'] || f['Phone'] || '-';
            var formattedPhone = formatPhoneNumber(phone);
            var lastCallTimestamp = f['Last Call Timestamp'];
            var callTimeDisplay = lastCallTimestamp ? new Date(lastCallTimestamp).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', timeZone: 'America/New_York' }) : '-';
            var summary = f['Last Call Summary'] || f['Summary'] || '';
            var notesRaw = f['Client Notes'] || f['Notes'] || '';
            var isShared = lead.isShared || (f['Shared With'] && f['Shared With'].length > 0);
            var isPrio = f['Is Prio'] === true;
            var status = f['Status'] || f['Disposition'] || 'Unknown';
            var outcome = f['Outcome'] || status;

            // Parse notes
            var notesArray = parseNotesJson(notesRaw);
            var lastNoteText = notesArray.length > 0 ? notesArray[notesArray.length - 1].text : 'No notes yet';

            // Booked/Callback time display
            var dateDisplay = '';
            var timeDisplay = '';
            var bookedTime = f['Booked Time'] || f['Callback Date'];
            if (bookedTime) {
                var d = new Date(bookedTime);
                dateDisplay = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', timeZone: 'America/New_York' });
                timeDisplay = d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', timeZone: 'America/New_York' });
            } else {
                dateDisplay = 'Pending';
                timeDisplay = 'setup';
            }

            var timeCol = '<span class="date-value">' + dateDisplay + '</span><span class="time-value">' + timeDisplay + '</span>';

            var statusLower = status.toLowerCase();
            var outcomeLower = outcome.toLowerCase();

            var prioIndicator = isPrio ? '<img src="/assets/favicon.png" class="prio-icon" title="Priority Lead">' : '';

            return '<div class="priority-card-lg" data-id="' + lead.id + '">' +
                '<div class="priority-card-lg-left" onclick="openLeadModal(\'' + lead.id + '\')">' +
                    '<div class="priority-card-lg-time-col">' +
                        prioIndicator +
                        timeCol +
                    '</div>' +
                    '<div class="priority-card-lg-info">' +
                        '<div class="priority-card-lg-top">' +
                            '<div class="priority-card-lg-name">' + escapeHtml(name) + getSharedIconHtml(lead) + '</div>' +
                        '</div>' +
                        '<div class="priority-card-lg-phone"> ' + phoneLink(phone, formattedPhone) + '</div>' +
                        '<div class="priority-card-lg-lastcall">Called at ' + callTimeDisplay + ' EST</div>' +
                    '</div>' +
                '</div>' +
                getCardStatusHtml(lead) +
                '<div class="priority-card-lg-summary-col" onclick="openLeadModal(\'' + lead.id + '\')">' +
                    '<div class="col-label">Summary</div>' +
                    '<div class="col-content">' + (summary ? escapeHtml(summary) : '<span style="color:rgba(255,255,255,0.4)">No summary available</span>') + '</div>' +
                '</div>' +
                '<div class="priority-card-lg-notes-col" onclick="openLeadModal(\'' + lead.id + '\')">' +
                    '<div class="col-label">Notes</div>' +
                    '<div class="col-content">' + escapeHtml(lastNoteText) + '</div>' +
                '</div>' +
                '<div class="priority-card-lg-actions">' +
                    '<button class="action-btn action-share' + (isShared ? ' shared' : '') + '" onclick="event.stopPropagation();quickShareLead(\'' + lead.id + '\')"><span class="action-icon">' + (isShared ? '' : '') + '</span><span class="action-label">' + (isShared ? 'Shared' : 'Share') + '</span></button>' +
                    '<button class="action-btn action-reschedule" onclick="event.stopPropagation();quickReschedule(\'' + lead.id + '\')"><span class="action-icon"></span><span class="action-label">Reschedule</span></button>' +
                    '<button class="action-btn action-dnc" onclick="event.stopPropagation();quickMarkDNC(\'' + lead.id + '\')"><span class="action-icon"></span><span class="action-label">Do Not Call</span></button>' +
                    '<button class="action-btn action-prio" onclick="event.stopPropagation();markAsPrio(\'' + lead.id + '\')"><span class="action-icon"></span><span class="action-label">Prio</span></button>' +
                '</div>' +
            '</div>';
        }).join('');
    }

    // Booked Today tab switching
    document.querySelectorAll('#page-booked-today .unqualified-tab').forEach(function(tab) {
        tab.addEventListener('click', function() {
            document.querySelectorAll('#page-booked-today .unqualified-tab').forEach(function(t) { t.classList.remove('active'); });
            this.classList.add('active');
            bookedTodayTypeFilter = this.dataset.bookedType;
            updateBookedTodayList();
        });
    });

    // Booked Today filter listeners
    document.getElementById('bookedTodaySearch')?.addEventListener('input', debounce(function() {
        updateBookedTodayList();
    }, 300));
    document.getElementById('bookedTodaySort')?.addEventListener('change', updateBookedTodayList);

    // Helper: Check if lead is owned by current user
    function isLeadOwnedByUser(lead) {
        if (!currentUser) return false;
        var clientEmails = lead.fields['Client Email'] || [];
        if (typeof clientEmails === 'string') clientEmails = [clientEmails];
        return clientEmails.some(function(e) {
            return e.toLowerCase() === currentUser.email.toLowerCase();
        });
    }
    
    // Helper: Get days difference
    function getDaysDiff(date) {
        var now = new Date();
        return Math.floor((now - date) / (1000 * 60 * 60 * 24));
    }
    
    // Helper: Get last updated timestamp
    function getMostRecentLastCalled(fields) {
        return fields['Updated At'] ? new Date(fields['Updated At']) : null;
    }
    
    // Helper: Format date/time
    function formatDateTime(dateVal) {
        if (!dateVal) return '-';
        var date = new Date(dateVal);
        return date.toLocaleDateString('en-CA', {
            month: 'short',
            day: 'numeric',
            hour: 'numeric',
            minute: '2-digit'
        });
    }

    // Helper: Format date/time as friendly (Feb 9, 7:00 PM)
    function formatFriendlyDateTime(dateVal) {
        if (!dateVal) return '-';
        var date = new Date(dateVal);
        var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        var day = date.getDate();
        var hours = date.getHours();
        var minutes = date.getMinutes().toString().padStart(2, '0');
        var ampm = hours >= 12 ? 'PM' : 'AM';
        var hour12 = hours % 12 || 12;
        return months[date.getMonth()] + ' ' + day + ', ' + hour12 + ':' + minutes + ' ' + ampm;
    }
    
    // Helper: Format phone
    function formatPhone(phone) {
        if (!phone) return '-';
        var cleaned = phone.toString().replace(/\D/g, '');
        if (cleaned.length === 11 && cleaned[0] === '1') cleaned = cleaned.slice(1);
        if (cleaned.length === 10) {
            return '(' + cleaned.slice(0,3) + ') ' + cleaned.slice(3,6) + '-' + cleaned.slice(6);
        }
        return phone;
    }
    
    // Helper: Get status class
    function getStatusClass(status) {
        if (!status) return '';
        var s = status.toLowerCase();
        if (s.includes('booked')) return 'booked';
        if (s.includes('callback')) return 'callback';
        if (s.includes('timeline')) return 'timeline';
        if (s.includes('follow')) return 'follow-up';
        if (s.includes('interested') && !s.includes('not')) return 'interested';
        if (s.includes('not interested')) return 'not-interested';
        return '';
    }
    
    // Mark as PRIO from table
    async function markAsPrio(leadId) {
        try {
            await fetchAirtable(AIRTABLE_BASE + '/' + AIRTABLE_LEADS_TABLE + '/' + leadId, {
                method: 'PATCH',
                body: { fields: { 'Is Prio': true } }
            });
            var lead = allLeads.find(function(l) { return l.id === leadId; });
            if (lead) lead.fields['Is Prio'] = true;
            updatePrioList();
            updateProspectsTable();
            showToast('Marked as PRIO', 'success');
        } catch (err) {
            showToast('Failed to update', 'error');
        }
    }
    
    // Open lead modal by ID
    function openLeadModal(leadId) {
        var lead = allLeads.find(function(l) { return l.id === leadId; });
        if (!lead) return;

        currentLeadId = leadId;
        // Update URL with lead ID for deep linking
        history.pushState({ leadId: leadId }, '', '#lead/' + leadId);
        var f = lead.fields;

        // Populate modal
        document.getElementById('modalLeadName').textContent = ((f['First Name'] || '') + ' ' + (f['Last Name'] || '')).trim() || 'Unknown';
        var modalRawPhone = f['Phone #'] || f['Phone'] || '-';
        document.getElementById('modalPhone').innerHTML = phoneLink(modalRawPhone, formatPhone(modalRawPhone));
        
        var status = f['Status'] || f['Disposition'] || '-';
        var statusSelect = document.getElementById('modalStatusSelect');
        if (statusSelect) {
            // Check if current status exists as an option, if not add it
            var hasOption = Array.from(statusSelect.options).some(function(opt) { return opt.value === status; });
            if (!hasOption && status !== '-') {
                var newOpt = document.createElement('option');
                newOpt.value = status;
                newOpt.textContent = status;
                statusSelect.appendChild(newOpt);
            }
            statusSelect.value = status;
        }
        syncStatusDropdownDisplay(status);

        document.getElementById('modalLastCalled').textContent = formatDateTime(getMostRecentLastCalled(f));

        // Booked Time with reschedule/delete buttons
        var bookedTime = f['Booked Time'];
        var bookedTimeValue = document.getElementById('modalBookedTimeValue');
        var scheduleBtn = document.getElementById('modalScheduleBtn');
        if (bookedTime) {
            bookedTimeValue.innerHTML = '<span class="booked-time-display"><span class="booked-time-value">' + formatFriendlyDateTime(bookedTime) + '</span><button class="btn-reschedule" onclick="editBookingFromModal()" title="Reschedule">Reschedule</button><button class="btn-delete-booking" onclick="deleteBookingFromModal()" title="Remove booking"></button></span>';
            if (scheduleBtn) scheduleBtn.style.display = 'none';
        } else {
            bookedTimeValue.textContent = '';
            if (scheduleBtn) scheduleBtn.style.display = 'inline-flex';
        }

        // Last AI Call Date - shown as badge beside AI Summary heading
        var lastAICall = f['Last Call Timestamp'];
        var aiCallDateEl = document.getElementById('modalAICallDate');
        if (aiCallDateEl) {
            aiCallDateEl.textContent = lastAICall ? formatDateTime(lastAICall) : '';
        }
        // B/C badge for Booked or Callback
        var aiBadgeEl = document.getElementById('modalAIStatusBadge');
        if (aiBadgeEl) {
            var leadStatus = (f['Status'] || f['Disposition'] || '').toLowerCase();
            if (leadStatus.includes('booked')) {
                aiBadgeEl.className = 'ai-status-badge';
                aiBadgeEl.style.display = 'inline-flex';
                aiBadgeEl.style.background = 'rgba(52,211,153,0.15)';
                aiBadgeEl.style.color = '#34D399';
                aiBadgeEl.textContent = 'B';
                aiBadgeEl.title = 'Meeting Booked';
            } else if (leadStatus.includes('callback')) {
                aiBadgeEl.className = 'ai-status-badge';
                aiBadgeEl.style.display = 'inline-flex';
                aiBadgeEl.style.background = 'rgba(249,115,22,0.15)';
                aiBadgeEl.style.color = '#F97316';
                aiBadgeEl.textContent = 'C';
                aiBadgeEl.title = 'Callback Requested';
            } else {
                aiBadgeEl.style.display = 'none';
            }
        }

        document.getElementById('modalSummary').textContent = f['Last Call Summary'] || 'No summary available';
        
        // Notes with edit/delete
        var notesRaw = f['Client Notes'] || '';
        var notes = parseNotesJson(notesRaw);
        var notesList = document.getElementById('modalNotesList');
        if (notes.length > 0) {
            notesList.innerHTML = notes.map(function(note, idx) {
                var dateStr = note.date ? formatNoteDate(note.date) : '';
                return '<div class="lead-note-item" data-note-index="' + idx + '">' +
                    '<div class="note-content">' + escapeHtml(note.text) + '</div>' +
                    (dateStr ? '<div class="note-date">' + dateStr + '</div>' : '') +
                    '<div class="note-actions"><button class="btn-edit-note" onclick="editNote(' + idx + ')" title="Edit"></button><button class="btn-delete-note" onclick="deleteNote(' + idx + ')" title="Delete"></button></div>' +
                '</div>';
            }).join('');
        } else {
            notesList.innerHTML = '<div style="color:rgba(255,255,255,0.4)">No notes yet</div>';
        }
        document.getElementById('modalNotesInput').value = '';
        
        // Attempts - parse JSON if available
        var attemptsRaw = f['Client Attempts'] || '[]';
        var attemptsArray = [];
        try {
            if (typeof attemptsRaw === 'string') {
                attemptsArray = JSON.parse(attemptsRaw);
            } else if (Array.isArray(attemptsRaw)) {
                attemptsArray = attemptsRaw;
            } else if (typeof attemptsRaw === 'number') {
                attemptsArray = [];
            }
        } catch (e) {
            attemptsArray = [];
        }
        var attemptsCount = Array.isArray(attemptsArray) ? attemptsArray.length : 0;
        updateCallAttemptsSection(attemptsCount);
        if (attemptsCount > 0) {
            var countEl = document.getElementById('modalAttemptsCount');
            if (countEl) countEl.textContent = attemptsCount;
            var attemptsList = document.getElementById('modalAttemptsList');
            var attemptsHtml = attemptsArray.map(function(attempt, i) {
                var timeStr = attempt.time ? formatFriendlyDateTime(attempt.time) : 'Unknown time';
                return '<div class="lead-attempt-item"><span>Call Attempt #' + (i + 1) + '</span><span style="display:flex;align-items:center;gap:8px;"><span style="color:rgba(255,255,255,0.5);font-size:0.8125rem;">' + timeStr + '</span><button class="btn-delete-attempt" onclick="deleteCallAttempt(' + i + ')" title="Delete"></button></span></div>';
            }).join('');
            if (attemptsList) attemptsList.innerHTML = attemptsHtml;
        }

        // Transcript with colored speakers
        var transcript = f['Transcript (from Calls)'];
        var transcriptEl = document.getElementById('modalTranscript');
        var leadName = ((f['First Name'] || '') + ' ' + (f['Last Name'] || '')).trim() || 'Unknown';
        if (transcript && transcript.length) {
            var transcriptText = Array.isArray(transcript) ? transcript[0] : transcript;
            transcriptEl.innerHTML = formatTranscript(transcriptText, leadName);
        } else {
            transcriptEl.textContent = 'No transcript available';
        }
        
        // PRIO button state and icon
        var prioBtn = document.getElementById('modalPrioBtn');
        var prioIcon = document.getElementById('modalPrioIcon');
        if (f['Is Prio']) {
            prioBtn.classList.add('active');
            prioBtn.textContent = ' PRIO';
            if (prioIcon) prioIcon.style.display = 'block';
        } else {
            prioBtn.classList.remove('active');
            prioBtn.textContent = ' PRIO';
            if (prioIcon) prioIcon.style.display = 'none';
        }

        // Share button state
        var shareBtn = document.getElementById('modalShareBtn');
        var sharedWithEmail = f['Shared With Email'];
        if (Array.isArray(sharedWithEmail)) sharedWithEmail = sharedWithEmail[0] || '';
        var isSharedToUser = lead.isShared;

        if (sharedWithEmail || isSharedToUser) {
            if (isSharedToUser) {
                var ownerEmail = f['Client Email'];
                if (Array.isArray(ownerEmail)) ownerEmail = ownerEmail[0] || '';
                var sharedByName = getAgentNameByEmail(ownerEmail) || ownerEmail || 'Unknown';
                if (shareBtn) {
                    shareBtn.classList.add('shared');
                    shareBtn.innerHTML = ' Shared by ' + sharedByName;
                }
            } else {
                var sharedWithName = getAgentNameByEmail(sharedWithEmail) || sharedWithEmail || 'Unknown';
                if (shareBtn) {
                    shareBtn.classList.add('shared');
                    shareBtn.innerHTML = ' Shared with ' + sharedWithName;
                }
            }
        } else {
            if (shareBtn) {
                shareBtn.classList.remove('shared');
                shareBtn.innerHTML = ' Share';
            }
        }

        // Show/hide Send to AI vs Take Over based on lead status
        var sendBackBtn = document.getElementById('modalSendBackBtn');
        var takeOverBtn = document.getElementById('modalTakeOverBtn');
        var isPipelineLead = status === 'Timeline' || status === 'Follow Up';
        if (isPipelineLead) {
            if (sendBackBtn) sendBackBtn.style.display = 'none';
            if (takeOverBtn) takeOverBtn.style.display = 'inline-block';
        } else {
            if (sendBackBtn) sendBackBtn.style.display = 'inline-block';
            if (takeOverBtn) takeOverBtn.style.display = 'none';
        }

        // Show modal
        document.getElementById('leadModal').classList.add('active');
    }

    // Note: Modal close handlers are defined earlier with closeLeadModalWithCheck() for unsaved notes protection

    // ===== LINKS HANDLING =====
    function renderLinksList(links) {
        var list = document.getElementById('modalLinksList');
        var countEl = document.getElementById('modalLinksCount');
        if (!list) return;

        if (!Array.isArray(links) || links.length === 0) {
            list.innerHTML = '<div class="attachments-empty">No links yet</div>';
            if (countEl) countEl.textContent = '0';
            return;
        }

        if (countEl) countEl.textContent = links.length;

        list.innerHTML = links.map(function(link, idx) {
            var icon = '';
            if (link.url) {
                var urlLower = link.url.toLowerCase();
                if (urlLower.includes('zillow') || urlLower.includes('redfin') || urlLower.includes('realtor') || urlLower.includes('mls')) icon = '';
                else if (urlLower.includes('docs.google') || urlLower.includes('drive.google')) icon = '';
                else if (urlLower.includes('dropbox')) icon = '';
                else if (urlLower.includes('.pdf')) icon = '';
            }
            return '<div class="lead-attachment-item">' +
                '<span class="attachment-icon">' + icon + '</span>' +
                '<div class="attachment-info">' +
                    '<div class="attachment-title">' + escapeHtml(link.title || 'Untitled') + '</div>' +
                    '<div class="attachment-url">' + escapeHtml(link.url || '') + '</div>' +
                '</div>' +
                '<div class="attachment-actions">' +
                    '<a href="' + escapeHtml(link.url || '#') + '" target="_blank" rel="noopener" class="btn-attachment-open">Open</a>' +
                    '<button class="btn-attachment-delete" onclick="deleteLink(' + idx + ')" title="Delete"></button>' +
                '</div>' +
            '</div>';
        }).join('');
    }

    function getLinksFromLead() {
        if (!currentLeadId) return [];
        var lead = allLeads.find(function(l) { return l.id === currentLeadId; });
        if (!lead) return [];
        var linksRaw = lead.fields['Links'] || '[]';
        try {
            if (typeof linksRaw === 'string') {
                return JSON.parse(linksRaw);
            } else if (Array.isArray(linksRaw)) {
                return linksRaw;
            }
        } catch (e) {}
        return [];
    }

    async function addLink() {
        if (!currentLeadId) return;
        var titleInput = document.getElementById('linkTitleInput');
        var urlInput = document.getElementById('linkUrlInput');
        var title = (titleInput.value || '').trim();
        var url = (urlInput.value || '').trim();

        if (!url) {
            alert('Please enter a URL');
            return;
        }

        // Validate URL
        try {
            new URL(url);
        } catch (e) {
            alert('Please enter a valid URL (e.g., https://...)');
            return;
        }

        var links = getLinksFromLead();
        links.push({
            title: title || url,
            url: url,
            addedAt: new Date().toISOString()
        });

        try {
            await fetchAirtable(AIRTABLE_BASE + '/' + AIRTABLE_LEADS_TABLE + '/' + currentLeadId, {
                method: 'PATCH',
                body: { fields: { 'Links': JSON.stringify(links) } }
            });

            // Update local data
            var lead = allLeads.find(function(l) { return l.id === currentLeadId; });
            if (lead) lead.fields['Links'] = JSON.stringify(links);

            // Re-render
            renderLinksList(links);

            // Clear inputs
            titleInput.value = '';
            urlInput.value = '';
        } catch (err) {
            console.error('Failed to save link:', err);
            alert('Failed to save link. Please try again.');
        }
    }

    async function deleteLink(index) {
        if (!currentLeadId) return;
        if (!confirm('Delete this link?')) return;

        var links = getLinksFromLead();
        links.splice(index, 1);

        try {
            await fetchAirtable(AIRTABLE_BASE + '/' + AIRTABLE_LEADS_TABLE + '/' + currentLeadId, {
                method: 'PATCH',
                body: { fields: { 'Links': JSON.stringify(links) } }
            });

            // Update local data
            var lead = allLeads.find(function(l) { return l.id === currentLeadId; });
            if (lead) lead.fields['Links'] = JSON.stringify(links);

            // Re-render
            renderLinksList(links);
        } catch (err) {
            console.error('Failed to delete link:', err);
            alert('Failed to delete link. Please try again.');
        }
    }

    // ===== ATTACHMENTS HANDLING (Airtable file attachments) =====
    function renderAttachmentsList(attachments) {
        var list = document.getElementById('modalAttachmentsList');
        var countEl = document.getElementById('modalAttachmentsCount');
        if (!list) return;

        if (!Array.isArray(attachments) || attachments.length === 0) {
            list.innerHTML = '<div class="attachments-empty">No attachments yet</div>';
            if (countEl) countEl.textContent = '0';
            return;
        }

        if (countEl) countEl.textContent = attachments.length;

        list.innerHTML = attachments.map(function(att) {
            var filename = att.filename || 'Attachment';
            var icon = '';
            var filenameLower = filename.toLowerCase();
            if (filenameLower.endsWith('.pdf')) icon = '';
            else if (filenameLower.endsWith('.doc') || filenameLower.endsWith('.docx')) icon = '';
            else if (filenameLower.endsWith('.xls') || filenameLower.endsWith('.xlsx')) icon = '';
            else if (filenameLower.endsWith('.jpg') || filenameLower.endsWith('.jpeg') || filenameLower.endsWith('.png') || filenameLower.endsWith('.gif')) icon = '';

            return '<div class="lead-attachment-item">' +
                '<span class="attachment-icon">' + icon + '</span>' +
                '<div class="attachment-info">' +
                    '<div class="attachment-title">' + escapeHtml(filename) + '</div>' +
                    '<div class="attachment-url">' + (att.size ? formatFileSize(att.size) : '') + '</div>' +
                '</div>' +
                '<div class="attachment-actions">' +
                    '<a href="' + escapeHtml(att.url || '#') + '" target="_blank" rel="noopener" class="btn-attachment-open">Download</a>' +
                '</div>' +
            '</div>';
        }).join('');
    }

    function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    // Add link button listener
    document.getElementById('addLinkBtn')?.addEventListener('click', addLink);

    // Allow Enter key to add link when in URL field
    document.getElementById('linkUrlInput')?.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            addLink();
        }
    });

    // ===== FILTER EVENT LISTENERS =====
    // Prio filters
    document.getElementById('prioSearch')?.addEventListener('input', debounce(updatePrioListFiltered, 300));
    document.getElementById('prioStatus')?.addEventListener('change', updatePrioListFiltered);
    document.getElementById('prioOwnership')?.addEventListener('change', updatePrioListFiltered);
    document.getElementById('prioTimeframe')?.addEventListener('change', updatePrioListFiltered);
    document.getElementById('prioSort')?.addEventListener('change', updatePrioListFiltered);

    // Prospects filters
    document.getElementById('prospectsSearch')?.addEventListener('input', debounce(updateProspectsTable, 300));
    document.getElementById('prospectsStatus')?.addEventListener('change', updateProspectsTable);
    document.getElementById('prospectsOwnership')?.addEventListener('change', updateProspectsTable);
    document.getElementById('prospectsTimeframe')?.addEventListener('change', updateProspectsTable);
    document.getElementById('prospectsSort')?.addEventListener('change', updateProspectsTable);

    // Shared leads filters
    document.getElementById('sharedSearch')?.addEventListener('input', debounce(updateSharedLeadsList, 300));
    document.getElementById('sharedDirection')?.addEventListener('change', updateSharedLeadsList);
    document.getElementById('sharedStatus')?.addEventListener('change', updateSharedLeadsList);
    document.getElementById('sharedTimeframe')?.addEventListener('change', updateSharedLeadsList);
    document.getElementById('sharedSort')?.addEventListener('change', updateSharedLeadsList);

    // View toggle functions
    function setPrioView(view) {
        var container = document.getElementById('prioList');
        var listBtn = document.getElementById('prioViewList');
        var gridBtn = document.getElementById('prioViewGrid');
        if (view === 'list') {
            container.classList.add('list-view');
            listBtn.classList.add('active');
            gridBtn.classList.remove('active');
        } else {
            container.classList.remove('list-view');
            listBtn.classList.remove('active');
            gridBtn.classList.add('active');
        }
    }
    window.setPrioView = setPrioView;

    function setProspectsView(view) {
        var container = document.getElementById('prospectsList');
        var listBtn = document.getElementById('prospectsViewList');
        var gridBtn = document.getElementById('prospectsViewGrid');
        if (view === 'list') {
            container.classList.add('list-view');
            listBtn.classList.add('active');
            gridBtn.classList.remove('active');
        } else {
            container.classList.remove('list-view');
            listBtn.classList.remove('active');
            gridBtn.classList.add('active');
        }
    }
    window.setProspectsView = setProspectsView;

    function setPipelineView(view) {
        var container = document.getElementById('pipelineList');
        var listBtn = document.getElementById('pipelineViewList');
        var gridBtn = document.getElementById('pipelineViewGrid');
        if (view === 'list') {
            container.classList.add('list-view');
            listBtn.classList.add('active');
            gridBtn.classList.remove('active');
        } else {
            container.classList.remove('list-view');
            listBtn.classList.remove('active');
            gridBtn.classList.add('active');
        }
    }
    window.setPipelineView = setPipelineView;

    function setSharedView(view) {
        var container = document.getElementById('sharedList');
        var listBtn = document.getElementById('sharedViewList');
        var gridBtn = document.getElementById('sharedViewGrid');
        if (view === 'list') {
            container.classList.add('list-view');
            listBtn.classList.add('active');
            gridBtn.classList.remove('active');
        } else {
            container.classList.remove('list-view');
            listBtn.classList.remove('active');
            gridBtn.classList.add('active');
        }
    }
    window.setSharedView = setSharedView;

    // Font size toggle (S/M/L)
    var fontSizes = ['sm', 'md', 'lg'];
    var fontSizeLabels = { sm: 'S', md: 'M', lg: 'L' };
    var currentFontSize = localStorage.getItem('prioFontSize') || 'sm';

    function applyFontSize(size) {
        currentFontSize = size;
        localStorage.setItem('prioFontSize', size);
        var main = document.querySelector('.main-content') || document.body;
        main.classList.remove('font-size-sm', 'font-size-md', 'font-size-lg');
        if (size !== 'sm') main.classList.add('font-size-' + size);
        document.querySelectorAll('.font-size-toggle').forEach(function(btn) {
            btn.classList.remove('size-sm', 'size-md', 'size-lg');
            btn.classList.add('size-' + size);
            var label = btn.querySelector('.size-label');
            if (label) label.textContent = fontSizeLabels[size];
        });
    }

    function cycleFontSize() {
        var idx = fontSizes.indexOf(currentFontSize);
        var next = fontSizes[(idx + 1) % fontSizes.length];
        applyFontSize(next);
    }
    window.cycleFontSize = cycleFontSize;

    // Apply saved font size on load
    applyFontSize(currentFontSize);

    // Sort direction state
    var prioSortAsc = false;
    var prospectsSortAsc = false;
    var pipelineSortAsc = true; // Default ascending for next call
    var sharedSortAsc = false;

    function togglePrioSortDir() {
        prioSortAsc = !prioSortAsc;
        var btn = document.getElementById('prioSortDir');
        if (btn) {
            btn.textContent = prioSortAsc ? '' : '';
            btn.classList.toggle('asc', prioSortAsc);
        }
        updatePrioListFiltered();
    }
    window.togglePrioSortDir = togglePrioSortDir;

    function toggleProspectsSortDir() {
        prospectsSortAsc = !prospectsSortAsc;
        var btn = document.getElementById('prospectsSortDir');
        if (btn) {
            btn.textContent = prospectsSortAsc ? '' : '';
            btn.classList.toggle('asc', prospectsSortAsc);
        }
        updateProspectsTable();
    }
    window.toggleProspectsSortDir = toggleProspectsSortDir;

    function togglePipelineSortDir() {
        pipelineSortAsc = !pipelineSortAsc;
        var btn = document.getElementById('pipelineSortDir');
        if (btn) {
            btn.textContent = pipelineSortAsc ? '' : '';
            btn.classList.toggle('asc', pipelineSortAsc);
        }
        updatePipelineList();
    }
    window.togglePipelineSortDir = togglePipelineSortDir;

    function toggleSharedSortDir() {
        sharedSortAsc = !sharedSortAsc;
        var btn = document.getElementById('sharedSortDir');
        if (btn) {
            btn.textContent = sharedSortAsc ? '' : '';
            btn.classList.toggle('asc', sharedSortAsc);
        }
        updateSharedLeadsList();
    }
    window.toggleSharedSortDir = toggleSharedSortDir;

    // Take over lead - change status to Callback and refresh
    async function takeOverLead(leadId) {
        var lead = allLeads.find(function(l) { return l.id === leadId; });
        if (!lead) return;

        var name = ((lead.fields['First Name'] || '') + ' ' + (lead.fields['Last Name'] || '')).trim() || 'This lead';

        try {
            // Update status to Callback
            var updatedLead = await fetchAirtable(AIRTABLE_BASE + '/' + AIRTABLE_LEADS_TABLE + '/' + leadId, {
                method: 'PATCH',
                body: {
                    fields: {
                        'Status': 'Callback',
                        'Last Outcome': 'Callback'
                    }
                }
            });

            // Update local data
            var idx = allLeads.findIndex(function(l) { return l.id === leadId; });
            if (idx !== -1) {
                allLeads[idx].fields['Status'] = 'Callback';
                allLeads[idx].fields['Last Outcome'] = 'Callback';
            }

            // Show success message
            showToast(name + ' has been moved to Prospects');

            // Refresh lists immediately
            updatePipelineList();
            updateProspectsTable();
            updateUnqualifiedList();
            updateOpenLeadsList();

            // Close modal if open
            if (currentLeadId === leadId) {
                document.getElementById('leadModal').classList.remove('active');
                currentLeadId = null;
            }

        } catch (error) {
            console.error('Error taking over lead:', error);
            showToast('Failed to take over lead. Please try again.', 'error');
        }
    }
    window.takeOverLead = takeOverLead;

    // Pipeline filters
    document.getElementById('pipelineSearch')?.addEventListener('input', debounce(updatePipelineList, 300));
    document.getElementById('pipelineStatus')?.addEventListener('change', updatePipelineList);
    document.getElementById('pipelineTimeframe')?.addEventListener('change', updatePipelineList);
    document.getElementById('pipelineSort')?.addEventListener('change', updatePipelineList);
    
    // Debounce helper
    function debounce(func, wait) {
        var timeout;
        return function() {
            var context = this, args = arguments;
            clearTimeout(timeout);
            timeout = setTimeout(function() {
                func.apply(context, args);
            }, wait);
        };
    }
    
    // Filtered Prio list update
    function updatePrioListFiltered() {
        var prioList = document.getElementById('prioList');

        var searchVal = (document.getElementById('prioSearch')?.value || '').toLowerCase();
        var statusFilter = document.getElementById('prioStatus')?.value || 'all';
        var ownershipFilter = document.getElementById('prioOwnership')?.value || 'all';
        var timeframeFilter = document.getElementById('prioTimeframe')?.value || 'all';
        var sortBy = document.getElementById('prioSort')?.value || 'priority';

        var prioLeads = allLeads.filter(function(l) {
            var f = l.fields;
            if (f['Is Prio'] !== true) return false;

            // Search filter
            if (searchVal) {
                var name = ((f['First Name'] || '') + ' ' + (f['Last Name'] || '')).toLowerCase();
                var phone = (f['Phone #'] || f['Phone'] || '').toLowerCase();
                if (!name.includes(searchVal) && !phone.includes(searchVal)) return false;
            }

            // Status filter
            if (statusFilter !== 'all') {
                var leadStatus = f['Status'] || f['Disposition'] || f['Outcome'] || '';
                if (leadStatus !== statusFilter) return false;
            }

            // Ownership filter
            if (ownershipFilter !== 'all') {
                var isOwned = isLeadOwnedByUser(l);
                var hasSharedWith = f['Shared With'] && f['Shared With'].length > 0;
                var hasSharedWithEmail = f['Shared With Email'] && (Array.isArray(f['Shared With Email']) ? f['Shared With Email'].length > 0 : f['Shared With Email']);
                var isSharedByMe = !l.isShared && (hasSharedWith || hasSharedWithEmail);
                var isSharedWithMe = l.isShared === true;

                if (ownershipFilter === 'mine' && !isOwned) return false;
                if (ownershipFilter === 'shared-by' && !isSharedByMe) return false;
                if (ownershipFilter === 'not-shared' && (isSharedByMe || isSharedWithMe)) return false;
                if (ownershipFilter === 'shared-with' && !isSharedWithMe) return false;
            }

            // Timeframe filter
            if (timeframeFilter !== 'all') {
                var lastCall = f['Last Call Timestamp'] || f['Client Last Call Timestamp'];
                if (!lastCall) return false;
                var daysDiff = getDaysDiff(new Date(lastCall));
                if (timeframeFilter === 'today' && daysDiff > 0) return false;
                if (timeframeFilter === '7days' && daysDiff > 7) return false;
                if (timeframeFilter === '30days' && daysDiff > 30) return false;
                if (timeframeFilter === '90days' && daysDiff > 90) return false;
            }

            return true;
        });

        // Sort based on selection and direction
        var dir = prioSortAsc ? 1 : -1;
        prioLeads.sort(function(a, b) {
            var fa = a.fields, fb = b.fields;
            var result;
            switch (sortBy) {
                case 'name':
                    var nameA = ((fa['First Name'] || '') + ' ' + (fa['Last Name'] || '')).toLowerCase();
                    var nameB = ((fb['First Name'] || '') + ' ' + (fb['Last Name'] || '')).toLowerCase();
                    result = nameA.localeCompare(nameB);
                    break;
                case 'meetingTime':
                    var timeA = new Date(fa['Booked Time'] || fa['Callback Date'] || 0).getTime();
                    var timeB = new Date(fb['Booked Time'] || fb['Callback Date'] || 0).getTime();
                    result = timeA - timeB;
                    break;
                case 'lastUpdated':
                    var updA = new Date(fa['Updated At'] || 0).getTime();
                    var updB = new Date(fb['Updated At'] || 0).getTime();
                    result = updA - updB;
                    break;
                case 'priority':
                default:
                    var getScore = function(d) {
                        if (d === 'Booked' || d === 'Appointment Booked') return 95;
                        if (d === 'Callback' || d === 'Callback Requested') return 90;
                        if (d === 'Interested') return 85;
                        if (d === 'Timeline') return 70;
                        if (d === 'Follow Up') return 60;
                        return 50;
                    };
                    result = getScore(fa['Status'] || fa['Disposition'] || '') - getScore(fb['Status'] || fb['Disposition'] || '');
                    break;
            }
            return result * dir;
        });

        document.getElementById('prioCount').textContent = prioLeads.length;

        if (prioLeads.length === 0) {
            prioList.innerHTML = '<div class="prio-empty">No priority leads match your filters</div>';
            return;
        }

        // Use same card rendering as updatePrioList
        prioList.innerHTML = prioLeads.map(function(lead) {
            var f = lead.fields;
            var name = ((f['First Name'] || '') + ' ' + (f['Last Name'] || '')).trim() || 'Unknown';
            var phone = f['Phone #'] || f['Phone'] || '-';
            var formattedPhone = formatPhoneNumber(phone);
            var lastUpdatedTimestamp = f['Updated At'];
            var lastUpdated = lastUpdatedTimestamp ? formatTimeAgo(lastUpdatedTimestamp) : '-';
            var lastUpdatedColor = getLastCalledColor(lastUpdatedTimestamp);
            var bookedTime = f['Booked Time'] || null;
            var callbackDate = f['Callback Date'] || f['Follow Up Date'];
            var summary = f['Last Call Summary'] || f['Summary'] || '';
            var notesRaw = f['Client Notes'] || f['Notes'] || '';
            var isShared = lead.isShared || (f['Shared With'] && f['Shared With'].length > 0) || (f['Shared With Email'] && (Array.isArray(f['Shared With Email']) ? f['Shared With Email'].length > 0 : f['Shared With Email']));
            var status = f['Status'] || f['Disposition'] || '';

            var notesArray = parseNotesJson(notesRaw);
            var lastNoteText = notesArray.length > 0 ? notesArray[notesArray.length - 1].text : 'No notes yet';

            var dateDisplay = '';
            var timeDisplay = '';
            var hasSchedule = false;
            if (bookedTime) {
                var d = new Date(bookedTime);
                dateDisplay = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                timeDisplay = d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
            } else if (callbackDate) {
                var d = new Date(callbackDate);
                dateDisplay = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                timeDisplay = d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
            } else {
                hasSchedule = true;
            }

            var timeCol;
            if (hasSchedule) {
                timeCol = '<button class="btn-schedule-card" onclick="event.stopPropagation();quickSchedule(\'' + lead.id + '\')">Schedule</button>';
            } else if (dateDisplay) {
                timeCol = '<span class="date-value">' + dateDisplay + '</span><span class="time-value">' + timeDisplay + '</span>';
            } else {
                timeCol = '<span class="time-value">' + timeDisplay + '</span>';
            }

            var prioIndicator = '<img src="/assets/favicon.png" class="prio-icon" title="Priority Lead">';

            return '<div class="priority-card-lg" data-id="' + lead.id + '">' +
                '<div class="priority-card-lg-left" onclick="openLeadModal(\'' + lead.id + '\')">' +
                    '<div class="priority-card-lg-time-col">' +
                        prioIndicator +
                        timeCol +
                    '</div>' +
                    '<div class="priority-card-lg-info">' +
                        '<div class="priority-card-lg-top">' +
                            '<div class="priority-card-lg-name">' + escapeHtml(name) + getSharedIconHtml(lead) + '</div>' +
                        '</div>' +
                        '<div class="priority-card-lg-phone"> ' + phoneLink(phone, formattedPhone) + '</div>' +
                        '<div class="priority-card-lg-lastcall">Updated ' + lastUpdated + ' <span class="lastcall-dot ' + lastUpdatedColor + '"></span></div>' +
                    '</div>' +
                '</div>' +
                getCardStatusHtml(lead) +
                '<div class="priority-card-lg-summary-col" onclick="openLeadModal(\'' + lead.id + '\')">' +
                    '<div class="col-label">Summary</div>' +
                    '<div class="col-content">' + (summary ? escapeHtml(summary) : '<span style="color:rgba(255,255,255,0.4)">No summary available</span>') + '</div>' +
                '</div>' +
                '<div class="priority-card-lg-notes-col" onclick="openLeadModal(\'' + lead.id + '\')">' +
                    '<div class="col-label">Notes</div>' +
                    '<div class="col-content">' + escapeHtml(lastNoteText) + '</div>' +
                '</div>' +
                '<div class="priority-card-lg-actions">' +
                    '<button class="action-btn action-share' + (isShared ? ' shared' : '') + '" onclick="event.stopPropagation();quickShareLead(\'' + lead.id + '\')"><span class="action-icon">' + (isShared ? '' : '') + '</span><span class="action-label">' + (isShared ? 'Shared' : 'Share') + '</span></button>' +
                    '<button class="action-btn action-ai" onclick="event.stopPropagation();quickSendToAI(\'' + lead.id + '\')"><span class="action-icon"></span><span class="action-label">Send to AI</span></button>' +
                    '<button class="action-btn action-dnc" onclick="event.stopPropagation();quickMarkDNC(\'' + lead.id + '\')"><span class="action-icon"></span><span class="action-label">Do Not Call</span></button>' +
                    '<button class="action-btn action-unprio" onclick="event.stopPropagation();unprio(\'' + lead.id + '\')"><span class="action-icon"></span><span class="action-label">Unprio</span></button>' +
                '</div>' +
            '</div>';
        }).join('');
    }

    // Update Shared Leads list
    function updateSharedLeadsList() {
        var sharedListEl = document.getElementById('sharedList');
        var directionDropdown = document.getElementById('sharedDirection');

        var searchVal = (document.getElementById('sharedSearch')?.value || '').toLowerCase();
        var directionFilter = directionDropdown?.value || 'all';
        var statusFilter = document.getElementById('sharedStatus')?.value || 'all';
        var timeframeFilter = document.getElementById('sharedTimeframe')?.value || 'all';
        var sortBy = document.getElementById('sharedSort')?.value || 'priority';

        // First, collect all unique agents that I've shared leads with (for dynamic dropdown)
        var sharedWithAgents = {};
        allLeads.forEach(function(l) {
            var f = l.fields;
            // Only leads I own that I've shared with others (not leads shared with me)
            if (!l.isShared && f['Shared With Email']) {
                var emails = Array.isArray(f['Shared With Email']) ? f['Shared With Email'] : [f['Shared With Email']];
                emails.forEach(function(email) {
                    if (email && !sharedWithAgents[email]) {
                        var agentName = getAgentNameByEmail(email);
                        sharedWithAgents[email] = agentName;
                    }
                });
            }
        });

        // Update dropdown options dynamically
        if (directionDropdown) {
            var currentValue = directionDropdown.value;
            var optionsHtml = '<option value="all">All Shared</option>';
            optionsHtml += '<option value="with-me">Shared with Me</option>';

            // Add "Shared with [Name]" options for each agent
            Object.keys(sharedWithAgents).sort(function(a, b) {
                return sharedWithAgents[a].localeCompare(sharedWithAgents[b]);
            }).forEach(function(email) {
                var name = sharedWithAgents[email];
                optionsHtml += '<option value="shared-to:' + email + '">Shared with ' + escapeHtml(name) + '</option>';
            });

            directionDropdown.innerHTML = optionsHtml;
            // Restore previous value if it still exists
            if (directionDropdown.querySelector('option[value="' + currentValue + '"]')) {
                directionDropdown.value = currentValue;
                directionFilter = currentValue;
            }
        }

        // Filter to only shared leads (Shared With or isShared)
        var sharedLeads = allLeads.filter(function(l) {
            var f = l.fields;

            // Must be a shared lead (either shared with me via isShared flag, or I shared it via Shared With field)
            var hasSharedWith = f['Shared With'] && f['Shared With'].length > 0;
            var hasSharedWithEmail = f['Shared With Email'] && (Array.isArray(f['Shared With Email']) ? f['Shared With Email'].length > 0 : f['Shared With Email']);
            if (!l.isShared && !hasSharedWith && !hasSharedWithEmail) return false;

            // Direction filter
            if (directionFilter !== 'all') {
                if (directionFilter === 'with-me') {
                    // Only leads shared WITH me
                    if (!l.isShared) return false;
                } else if (directionFilter.startsWith('shared-to:')) {
                    // Only leads I shared TO a specific agent
                    var targetEmail = directionFilter.replace('shared-to:', '').toLowerCase();
                    if (l.isShared) return false; // Exclude leads shared with me
                    var sharedEmails = f['Shared With Email'];
                    if (!sharedEmails) return false;
                    var emailList = Array.isArray(sharedEmails) ? sharedEmails : [sharedEmails];
                    var hasTarget = emailList.some(function(e) { return e && e.toLowerCase() === targetEmail; });
                    if (!hasTarget) return false;
                }
            }

            // Search filter
            if (searchVal) {
                var name = ((f['First Name'] || '') + ' ' + (f['Last Name'] || '')).toLowerCase();
                var phone = (f['Phone #'] || f['Phone'] || '').toLowerCase();
                if (!name.includes(searchVal) && !phone.includes(searchVal)) return false;
            }

            // Status filter
            if (statusFilter !== 'all') {
                var status = f['Status'] || f['Disposition'] || '';
                if (statusFilter === 'Booked') {
                    if (!status.includes('Booked')) return false;
                } else if (statusFilter === 'Callback') {
                    if (!status.includes('Callback')) return false;
                } else {
                    if (status !== statusFilter) return false;
                }
            }

            // Timeframe filter
            if (timeframeFilter !== 'all') {
                var lastCall = f['Last Call Timestamp'] || f['Client Last Call Timestamp'] || f['Updated At'];
                if (!lastCall) return false;
                var daysDiff = getDaysDiff(new Date(lastCall));
                if (timeframeFilter === 'today' && daysDiff > 0) return false;
                if (timeframeFilter === '7days' && daysDiff > 7) return false;
                if (timeframeFilter === '30days' && daysDiff > 30) return false;
                if (timeframeFilter === '90days' && daysDiff > 90) return false;
            }

            return true;
        });

        // Sort based on selection and direction
        var dir = sharedSortAsc ? 1 : -1;
        sharedLeads.sort(function(a, b) {
            var fa = a.fields, fb = b.fields;
            var result;
            switch (sortBy) {
                case 'name':
                    var nameA = ((fa['First Name'] || '') + ' ' + (fa['Last Name'] || '')).toLowerCase();
                    var nameB = ((fb['First Name'] || '') + ' ' + (fb['Last Name'] || '')).toLowerCase();
                    result = nameA.localeCompare(nameB);
                    break;
                case 'meetingTime':
                    var timeA = new Date(fa['Booked Time'] || fa['Callback Date'] || 0).getTime();
                    var timeB = new Date(fb['Booked Time'] || fb['Callback Date'] || 0).getTime();
                    result = timeA - timeB;
                    break;
                case 'lastUpdated':
                    var updA = new Date(fa['Updated At'] || 0).getTime();
                    var updB = new Date(fb['Updated At'] || 0).getTime();
                    result = updA - updB;
                    break;
                case 'priority':
                default:
                    var getScore = function(d) {
                        if (d === 'Booked' || d === 'Appointment Booked') return 95;
                        if (d === 'Callback' || d === 'Callback Requested') return 90;
                        if (d === 'Interested') return 85;
                        if (d === 'Timeline') return 70;
                        if (d === 'Follow Up') return 60;
                        return 50;
                    };
                    result = getScore(fa['Status'] || fa['Disposition'] || '') - getScore(fb['Status'] || fb['Disposition'] || '');
                    break;
            }
            return result * dir;
        });

        document.getElementById('sharedCount').textContent = sharedLeads.length;

        if (sharedLeads.length === 0) {
            sharedListEl.innerHTML = '<div class="shared-empty">No shared leads match your filters</div>';
            return;
        }

        // Render cards using same layout as Prio Prospects
        sharedListEl.innerHTML = sharedLeads.map(function(lead) {
            var f = lead.fields;
            var name = ((f['First Name'] || '') + ' ' + (f['Last Name'] || '')).trim() || 'Unknown';
            var phone = f['Phone #'] || f['Phone'] || '-';
            var formattedPhone = formatPhoneNumber(phone);
            var lastUpdatedTimestamp = f['Updated At'];
            var lastUpdated = lastUpdatedTimestamp ? formatTimeAgo(lastUpdatedTimestamp) : '-';
            var lastUpdatedColor = getLastCalledColor(lastUpdatedTimestamp);
            var bookedTime = f['Booked Time'] || null;
            var callbackDate = f['Callback Date'] || f['Follow Up Date'];
            var summary = f['Last Call Summary'] || f['Summary'] || '';
            var notesRaw = f['Client Notes'] || f['Notes'] || '';
            var status = f['Status'] || f['Disposition'] || '';
            var isPrio = f['Is Prio'] === true;

            var notesArray = parseNotesJson(notesRaw);
            var lastNoteText = notesArray.length > 0 ? notesArray[notesArray.length - 1].text : 'No notes yet';

            var dateDisplay = '';
            var timeDisplay = '';
            var hasSchedule = false;
            if (bookedTime) {
                var d = new Date(bookedTime);
                dateDisplay = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                timeDisplay = d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
            } else if (callbackDate) {
                var d = new Date(callbackDate);
                dateDisplay = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                timeDisplay = d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
            } else {
                hasSchedule = true;
            }

            var timeCol;
            if (hasSchedule) {
                timeCol = '<button class="btn-schedule-card" onclick="event.stopPropagation();quickSchedule(\'' + lead.id + '\')">Schedule</button>';
            } else if (dateDisplay) {
                timeCol = '<span class="date-value">' + dateDisplay + '</span><span class="time-value">' + timeDisplay + '</span>';
            } else {
                timeCol = '<span class="time-value">' + timeDisplay + '</span>';
            }

            var prioIndicator = isPrio ? '<img src="/assets/favicon.png" class="prio-icon" title="Priority Lead">' : '<span class="prio-icon-placeholder"></span>';

            return '<div class="priority-card-lg" data-id="' + lead.id + '">' +
                '<div class="priority-card-lg-left" onclick="openLeadModal(\'' + lead.id + '\')">' +
                    '<div class="priority-card-lg-time-col">' +
                        prioIndicator +
                        timeCol +
                    '</div>' +
                    '<div class="priority-card-lg-info">' +
                        '<div class="priority-card-lg-top">' +
                            '<div class="priority-card-lg-name">' + escapeHtml(name) + getSharedIconHtml(lead) + '</div>' +
                        '</div>' +
                        '<div class="priority-card-lg-phone"> ' + phoneLink(phone, formattedPhone) + '</div>' +
                        '<div class="priority-card-lg-lastcall">Updated ' + lastUpdated + ' <span class="lastcall-dot ' + lastUpdatedColor + '"></span></div>' +
                    '</div>' +
                '</div>' +
                getCardStatusHtml(lead) +
                '<div class="priority-card-lg-summary-col" onclick="openLeadModal(\'' + lead.id + '\')">' +
                    '<div class="col-label">Summary</div>' +
                    '<div class="col-content">' + (summary ? escapeHtml(summary) : '<span style="color:rgba(255,255,255,0.4)">No summary available</span>') + '</div>' +
                '</div>' +
                '<div class="priority-card-lg-notes-col" onclick="openLeadModal(\'' + lead.id + '\')">' +
                    '<div class="col-label">Notes</div>' +
                    '<div class="col-content">' + escapeHtml(lastNoteText) + '</div>' +
                '</div>' +
                '<div class="priority-card-lg-actions">' +
                    '<button class="action-btn action-share shared" onclick="event.stopPropagation();quickShareLead(\'' + lead.id + '\')"><span class="action-icon"></span><span class="action-label">Shared</span></button>' +
                    '<button class="action-btn action-ai" onclick="event.stopPropagation();quickSendToAI(\'' + lead.id + '\')"><span class="action-icon"></span><span class="action-label">Send to AI</span></button>' +
                    '<button class="action-btn action-dnc" onclick="event.stopPropagation();quickMarkDNC(\'' + lead.id + '\')"><span class="action-icon"></span><span class="action-label">Do Not Call</span></button>' +
                    (isPrio ? '<button class="action-btn action-unprio" onclick="event.stopPropagation();unprio(\'' + lead.id + '\')"><span class="action-icon"></span><span class="action-label">Unprio</span></button>' : '<button class="action-btn action-prio" onclick="event.stopPropagation();prio(\'' + lead.id + '\')"><span class="action-icon"></span><span class="action-label">Prio</span></button>') +
                '</div>' +
            '</div>';
        }).join('');
    }

    // Update all tabs when data loads
    var originalLoadLeadsData = loadLeadsData;
    loadLeadsData = async function() {
        try {
            await originalLoadLeadsData();
            updateProspectsTable();
            updatePipelineList();
            updateSharedLeadsList();
            updateUnqualifiedList();
            updateOpenLeadsList();
        } finally {
            // Data has loaded (or failed) - hide loading overlay either way
            dataLoaded = true;
            hidePageLoading();
        }
    };
    
    // Full page loading - hide when data is loaded (with minimum display time)
    var pageLoadingComplete = false;
    var MIN_LOADING_TIME = 1500; // Minimum 1.5 seconds for smooth UX

    function hidePageLoading() {
        if (pageLoadingComplete) return;

        var elapsed = Date.now() - (window.loadingStartTime || 0);
        var remaining = Math.max(0, MIN_LOADING_TIME - elapsed);

        // Wait for minimum time, then fade out
        setTimeout(function() {
            if (pageLoadingComplete) return;
            pageLoadingComplete = true;
            var overlay = document.getElementById('pageLoadingOverlay');
            var appContainer = document.getElementById('appContainer');
            if (overlay) overlay.classList.add('fade-out');
            if (appContainer) appContainer.style.opacity = '1';
            setTimeout(function() {
                if (overlay) overlay.style.display = 'none';
            }, 500);
        }, remaining);
    }

    // Mark data as loaded flag
    var dataLoaded = false;
    
    // ===== ANALYTICS PAGE =====
    var analyticsPeriod = 'daily';
    var analyticsDate = new Date();
    var analyticsLoading = false;
    var analyticsDataLoaded = { daily: false, weekly: false, monthly: false, all: false };
    var analyticsShowPercents = false; // Toggle state for numbers vs percentages
    var analyticsDataSource = 'calls'; // Toggle state for calls vs leads data

    // Toggle between numbers and percentages
    function updateAnalyticsToggleDisplay() {
        document.querySelectorAll('.analytics-toggleable').forEach(function(el) {
            el.textContent = analyticsShowPercents ? el.dataset.pct : el.dataset.count;
        });
    }

    document.getElementById('viewNumbers')?.addEventListener('click', function() {
        if (!this.classList.contains('active')) {
            document.getElementById('viewPercents')?.classList.remove('active');
            this.classList.add('active');
            analyticsShowPercents = false;
            updateAnalyticsToggleDisplay();
        }
    });

    document.getElementById('viewPercents')?.addEventListener('click', function() {
        if (!this.classList.contains('active')) {
            document.getElementById('viewNumbers')?.classList.remove('active');
            this.classList.add('active');
            analyticsShowPercents = true;
            updateAnalyticsToggleDisplay();
        }
    });

    // Toggle between Calls Data and Leads Data
    document.getElementById('viewCallsData')?.addEventListener('click', function() {
        if (!this.classList.contains('active')) {
            document.getElementById('viewLeadsData')?.classList.remove('active');
            this.classList.add('active');
            analyticsDataSource = 'calls';
            updateAnalyticsDisplay();
        }
    });

    document.getElementById('viewLeadsData')?.addEventListener('click', function() {
        if (!this.classList.contains('active')) {
            document.getElementById('viewCallsData')?.classList.remove('active');
            this.classList.add('active');
            analyticsDataSource = 'leads';
            updateAnalyticsDisplay();
        }
    });

    // Get current date in EST timezone
    function getESTDate(date) {
        var d = date || new Date();
        return new Date(d.toLocaleString('en-US', { timeZone: 'America/New_York' }));
    }

    // Get today in EST
    function getTodayEST() {
        return getESTDate(new Date());
    }

    // Convert any date to EST for comparison
    function toESTDateString(date) {
        if (!date) return '';
        var d = new Date(date);
        return d.toLocaleDateString('en-US', { timeZone: 'America/New_York' });
    }

    // Helper to get Monday of the week for a given date
    function getWeekStart(date) {
        var d = new Date(date);
        var day = d.getDay();
        var diff = d.getDate() - day + (day === 0 ? -6 : 1); // Adjust for Sunday
        return new Date(d.setDate(diff));
    }

    // Helper to get Sunday of the week for a given date
    function getWeekEnd(date) {
        var start = getWeekStart(date);
        var end = new Date(start);
        end.setDate(end.getDate() + 6);
        return end;
    }

    // Update date display
    function updateAnalyticsDateDisplay() {
        var todayEST = getTodayEST();
        var selectedEST = getESTDate(analyticsDate);
        var dateDisplay = document.getElementById('analyticsDateDisplay');
        var nextBtn = document.getElementById('analyticsNextDay');
        var prevBtn = document.getElementById('analyticsPrevDay');
        var todayBtn = document.getElementById('analyticsTodayBtn');
        var dateNav = document.querySelector('.analytics-date-nav');

        var dayLabel, fullDate, periodLabel;
        var isAtCurrent = false;

        if (analyticsPeriod === 'daily') {
            var isToday = selectedEST.toDateString() === todayEST.toDateString();
            var yesterday = new Date(todayEST); yesterday.setDate(yesterday.getDate() - 1);
            var isYesterday = selectedEST.toDateString() === yesterday.toDateString();

            dayLabel = isToday ? 'Today' : isYesterday ? 'Yesterday' : selectedEST.toLocaleDateString('en-US', { weekday: 'long' });
            fullDate = selectedEST.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
            periodLabel = dayLabel;
            isAtCurrent = isToday;
        } else if (analyticsPeriod === 'weekly') {
            var weekStart = getWeekStart(selectedEST);
            var weekEnd = getWeekEnd(selectedEST);
            var currentWeekStart = getWeekStart(todayEST);

            // Cap week end at today if it's the current week
            if (weekEnd > todayEST) weekEnd = todayEST;

            var isThisWeek = weekStart.toDateString() === currentWeekStart.toDateString();
            dayLabel = isThisWeek ? 'This Week' : 'Week of ' + weekStart.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            fullDate = weekStart.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ' - ' + weekEnd.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            periodLabel = dayLabel;
            isAtCurrent = isThisWeek;
        } else if (analyticsPeriod === 'monthly') {
            var selectedMonth = selectedEST.getMonth();
            var selectedYear = selectedEST.getFullYear();
            var currentMonth = todayEST.getMonth();
            var currentYear = todayEST.getFullYear();

            var isThisMonth = selectedMonth === currentMonth && selectedYear === currentYear;
            dayLabel = isThisMonth ? 'This Month' : selectedEST.toLocaleDateString('en-US', { month: 'long' });
            fullDate = selectedEST.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            periodLabel = dayLabel;
            isAtCurrent = isThisMonth;
        } else {
            // All time
            dayLabel = 'All Time';
            fullDate = 'Since Inception';
            periodLabel = 'All Time';
            isAtCurrent = true;
        }

        if (dateDisplay) {
            dateDisplay.querySelector('.date-day').textContent = dayLabel;
            dateDisplay.querySelector('.date-full').textContent = fullDate;
        }

        var funnelPeriod = document.getElementById('analyticsFunnelPeriod');
        if (funnelPeriod) funnelPeriod.textContent = periodLabel;

        // Handle navigation buttons based on period
        if (analyticsPeriod === 'all') {
            // Grey out all navigation for all-time
            if (nextBtn) { nextBtn.style.opacity = '0.3'; nextBtn.style.pointerEvents = 'none'; }
            if (prevBtn) { prevBtn.style.opacity = '0.3'; prevBtn.style.pointerEvents = 'none'; }
            if (todayBtn) { todayBtn.style.opacity = '0.3'; todayBtn.style.pointerEvents = 'none'; }
            if (dateDisplay) { dateDisplay.style.opacity = '0.5'; dateDisplay.style.pointerEvents = 'none'; }
        } else {
            // Enable navigation
            if (prevBtn) { prevBtn.style.opacity = '1'; prevBtn.style.pointerEvents = 'auto'; }
            if (dateDisplay) { dateDisplay.style.opacity = '1'; dateDisplay.style.pointerEvents = 'auto'; }
            if (todayBtn) { todayBtn.style.opacity = '1'; todayBtn.style.pointerEvents = 'auto'; }

            // Disable next if at current period
            if (nextBtn) {
                if (isAtCurrent) {
                    nextBtn.style.opacity = '0.3';
                    nextBtn.style.pointerEvents = 'none';
                } else {
                    nextBtn.style.opacity = '1';
                    nextBtn.style.pointerEvents = 'auto';
                }
            }
        }

        // Set max date on date picker to today
        var picker = document.getElementById('analyticsDatePicker');
        if (picker) {
            var todayStr = todayEST.toISOString().split('T')[0];
            picker.max = todayStr;
        }
    }

    // Show loading state for analytics
    function showAnalyticsLoading() {
        analyticsLoading = true;
        var container = document.getElementById('page-analytics');
        if (!container) return;

        // Add loading overlay
        var existingOverlay = container.querySelector('.analytics-loading-overlay');
        if (!existingOverlay) {
            var overlay = document.createElement('div');
            overlay.className = 'analytics-loading-overlay';
            overlay.innerHTML = '<div class="analytics-loading-spinner"></div><p>Loading analytics...</p>';
            overlay.style.cssText = 'position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:10;border-radius:16px;';
            container.style.position = 'relative';
            container.appendChild(overlay);
        }
    }

    // Hide loading state
    function hideAnalyticsLoading() {
        analyticsLoading = false;
        var container = document.getElementById('page-analytics');
        if (!container) return;
        var overlay = container.querySelector('.analytics-loading-overlay');
        if (overlay) overlay.remove();
    }

    // Date navigation - moves by day/week/month based on period
    document.getElementById('analyticsPrevDay')?.addEventListener('click', function() {
        if (analyticsPeriod === 'all') return; // No navigation for all-time

        if (analyticsPeriod === 'daily') {
            analyticsDate.setDate(analyticsDate.getDate() - 1);
        } else if (analyticsPeriod === 'weekly') {
            analyticsDate.setDate(analyticsDate.getDate() - 7);
        } else if (analyticsPeriod === 'monthly') {
            analyticsDate.setMonth(analyticsDate.getMonth() - 1);
        }
        updateAnalyticsDateDisplay();
        updateAnalyticsDisplay();
    });

    document.getElementById('analyticsNextDay')?.addEventListener('click', function() {
        if (analyticsPeriod === 'all') return; // No navigation for all-time

        var todayEST = getTodayEST();
        var selectedEST = getESTDate(analyticsDate);

        if (analyticsPeriod === 'daily') {
            if (selectedEST.toDateString() !== todayEST.toDateString()) {
                analyticsDate.setDate(analyticsDate.getDate() + 1);
                if (getESTDate(analyticsDate) > todayEST) {
                    analyticsDate = new Date();
                }
            }
        } else if (analyticsPeriod === 'weekly') {
            var currentWeekStart = getWeekStart(todayEST);
            var selectedWeekStart = getWeekStart(selectedEST);
            if (selectedWeekStart < currentWeekStart) {
                analyticsDate.setDate(analyticsDate.getDate() + 7);
                // Don't go past current week
                if (getWeekStart(getESTDate(analyticsDate)) > currentWeekStart) {
                    analyticsDate = new Date();
                }
            }
        } else if (analyticsPeriod === 'monthly') {
            var currentMonth = todayEST.getMonth();
            var currentYear = todayEST.getFullYear();
            var selectedMonth = selectedEST.getMonth();
            var selectedYear = selectedEST.getFullYear();
            if (selectedYear < currentYear || (selectedYear === currentYear && selectedMonth < currentMonth)) {
                analyticsDate.setMonth(analyticsDate.getMonth() + 1);
            }
        }
        updateAnalyticsDateDisplay();
        updateAnalyticsDisplay();
    });

    document.getElementById('analyticsTodayBtn')?.addEventListener('click', function() {
        if (analyticsPeriod === 'all') return; // No navigation for all-time
        analyticsDate = new Date();
        updateAnalyticsDateDisplay();
        updateAnalyticsDisplay();
    });

    // Custom date picker logic
    var pickerMonth = new Date(); // Track which month is shown in calendar
    var customPicker = document.getElementById('customDatePicker');

    function showCustomPicker() {
        if (analyticsPeriod === 'all') return;

        // Hide all picker views first
        document.getElementById('pickerCalendar').style.display = 'none';
        document.getElementById('pickerWeekly').style.display = 'none';
        document.getElementById('pickerMonthly').style.display = 'none';

        if (analyticsPeriod === 'daily') {
            pickerMonth = new Date(analyticsDate);
            renderAnalyticsPicker();
            document.getElementById('pickerCalendar').style.display = 'block';
        } else if (analyticsPeriod === 'weekly') {
            renderWeeklyDropdown();
            document.getElementById('pickerWeekly').style.display = 'block';
        } else if (analyticsPeriod === 'monthly') {
            renderMonthlyDropdown();
            document.getElementById('pickerMonthly').style.display = 'block';
        }

        customPicker.classList.add('show');
    }

    function hideCustomPicker() {
        customPicker.classList.remove('show');
    }

    function renderAnalyticsPicker() {
        var todayEST = getTodayEST();
        var year = pickerMonth.getFullYear();
        var month = pickerMonth.getMonth();

        document.getElementById('pickerMonthLabel').textContent =
            pickerMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

        var firstDay = new Date(year, month, 1);
        var lastDay = new Date(year, month + 1, 0);
        var startDay = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1; // Monday start

        var daysHtml = '';

        // Previous month days
        var prevMonth = new Date(year, month, 0);
        for (var i = startDay - 1; i >= 0; i--) {
            var d = prevMonth.getDate() - i;
            daysHtml += '<button class="picker-day other-month" disabled>' + d + '</button>';
        }

        // Current month days
        var selectedDateStr = analyticsDate.toDateString();
        var todayStr = todayEST.toDateString();

        for (var d = 1; d <= lastDay.getDate(); d++) {
            var date = new Date(year, month, d);
            var dateStr = date.toDateString();
            var isFuture = date > todayEST;
            var isToday = dateStr === todayStr;
            var isSelected = dateStr === selectedDateStr;

            var classes = 'picker-day';
            if (isToday) classes += ' today';
            if (isSelected) classes += ' selected';

            daysHtml += '<button class="' + classes + '"' +
                (isFuture ? ' disabled' : '') +
                ' data-date="' + date.toISOString() + '">' + d + '</button>';
        }

        // Next month days
        var totalCells = Math.ceil((startDay + lastDay.getDate()) / 7) * 7;
        var remaining = totalCells - startDay - lastDay.getDate();
        for (var d = 1; d <= remaining; d++) {
            daysHtml += '<button class="picker-day other-month" disabled>' + d + '</button>';
        }

        document.getElementById('pickerDays').innerHTML = daysHtml;

        // Add click handlers to day buttons
        document.querySelectorAll('#pickerDays .picker-day:not(:disabled)').forEach(function(btn) {
            btn.addEventListener('click', function() {
                analyticsDate = new Date(this.dataset.date);
                hideCustomPicker();
                updateAnalyticsDateDisplay();
                updateAnalyticsDisplay();
            });
        });
    }

    function renderWeeklyDropdown() {
        var todayEST = getTodayEST();
        var currentWeekStart = getWeekStart(todayEST);
        var selectedWeekStart = getWeekStart(analyticsDate);
        var weeks = [];

        // Generate last 12 weeks
        for (var i = 0; i < 12; i++) {
            var weekStart = new Date(currentWeekStart);
            weekStart.setDate(weekStart.getDate() - (i * 7));
            var weekEnd = new Date(weekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);
            if (weekEnd > todayEST) weekEnd = todayEST;

            var isCurrent = i === 0;
            var isSelected = weekStart.toDateString() === selectedWeekStart.toDateString();

            weeks.push({
                start: weekStart,
                end: weekEnd,
                label: isCurrent ? 'This Week' : 'Week of ' + weekStart.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
                sublabel: weekStart.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ' - ' + weekEnd.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }),
                isCurrent: isCurrent,
                isSelected: isSelected
            });
        }

        var html = weeks.map(function(w) {
            var classes = 'picker-dropdown-item';
            if (w.isSelected) classes += ' selected';
            if (w.isCurrent) classes += ' current';
            return '<button class="' + classes + '" data-date="' + w.start.toISOString() + '">' +
                '<div style="font-weight:500">' + w.label + '</div>' +
                '<div style="font-size:0.75rem;color:rgba(255,255,255,0.5);margin-top:2px">' + w.sublabel + '</div>' +
                '</button>';
        }).join('');

        document.getElementById('weeklyList').innerHTML = html;

        document.querySelectorAll('#weeklyList .picker-dropdown-item').forEach(function(btn) {
            btn.addEventListener('click', function() {
                analyticsDate = new Date(this.dataset.date);
                hideCustomPicker();
                updateAnalyticsDateDisplay();
                updateAnalyticsDisplay();
            });
        });
    }

    function renderMonthlyDropdown() {
        var todayEST = getTodayEST();
        var currentMonth = todayEST.getMonth();
        var currentYear = todayEST.getFullYear();
        var selectedMonth = analyticsDate.getMonth();
        var selectedYear = analyticsDate.getFullYear();
        var months = [];

        // Generate last 12 months
        for (var i = 0; i < 12; i++) {
            var d = new Date(currentYear, currentMonth - i, 1);
            var isCurrent = i === 0;
            var isSelected = d.getMonth() === selectedMonth && d.getFullYear() === selectedYear;

            months.push({
                date: d,
                label: isCurrent ? 'This Month' : d.toLocaleDateString('en-US', { month: 'long' }),
                sublabel: d.toLocaleDateString('en-US', { month: 'long', year: 'numeric' }),
                isCurrent: isCurrent,
                isSelected: isSelected
            });
        }

        var html = months.map(function(m) {
            var classes = 'picker-dropdown-item';
            if (m.isSelected) classes += ' selected';
            if (m.isCurrent) classes += ' current';
            return '<button class="' + classes + '" data-date="' + m.date.toISOString() + '">' +
                '<div style="font-weight:500">' + m.label + '</div>' +
                '<div style="font-size:0.75rem;color:rgba(255,255,255,0.5);margin-top:2px">' + m.sublabel + '</div>' +
                '</button>';
        }).join('');

        document.getElementById('monthlyList').innerHTML = html;

        document.querySelectorAll('#monthlyList .picker-dropdown-item').forEach(function(btn) {
            btn.addEventListener('click', function() {
                analyticsDate = new Date(this.dataset.date);
                hideCustomPicker();
                updateAnalyticsDateDisplay();
                updateAnalyticsDisplay();
            });
        });
    }

    // Calendar navigation
    document.getElementById('pickerPrevMonth')?.addEventListener('click', function() {
        pickerMonth.setMonth(pickerMonth.getMonth() - 1);
        renderAnalyticsPicker();
    });

    document.getElementById('pickerNextMonth')?.addEventListener('click', function() {
        var todayEST = getTodayEST();
        var nextMonth = new Date(pickerMonth);
        nextMonth.setMonth(nextMonth.getMonth() + 1);
        if (nextMonth.getFullYear() < todayEST.getFullYear() ||
            (nextMonth.getFullYear() === todayEST.getFullYear() && nextMonth.getMonth() <= todayEST.getMonth())) {
            pickerMonth = nextMonth;
            renderAnalyticsPicker();
        }
    });

    // Toggle picker on date display click
    document.getElementById('analyticsDateDisplay')?.addEventListener('click', function() {
        if (customPicker.classList.contains('show')) {
            hideCustomPicker();
        } else {
            showCustomPicker();
        }
    });

    // Close picker on outside click
    document.addEventListener('click', function(e) {
        if (!e.target.closest('#customDatePicker') && !e.target.closest('#analyticsDateDisplay')) {
            hideCustomPicker();
        }
    });

    // Period tab clicks - load on demand
    document.querySelectorAll('.analytics-period-tab').forEach(function(tab) {
        tab.addEventListener('click', function() {
            document.querySelectorAll('.analytics-period-tab').forEach(function(t) { t.classList.remove('active'); });
            this.classList.add('active');
            var newPeriod = this.dataset.period;

            // Show loading if switching to a period that hasn't been loaded
            if (newPeriod !== 'daily' && !analyticsDataLoaded[newPeriod]) {
                showAnalyticsLoading();
            }

            analyticsPeriod = newPeriod;
            updateAnalyticsDateDisplay();

            // Simulate loading delay for non-daily views (they process more data)
            if (newPeriod !== 'daily' && !analyticsDataLoaded[newPeriod]) {
                setTimeout(function() {
                    updateAnalyticsDisplay();
                    analyticsDataLoaded[newPeriod] = true;
                    hideAnalyticsLoading();
                }, 300);
            } else {
                updateAnalyticsDisplay();
            }
        });
    });

    // Initialize date display
    updateAnalyticsDateDisplay();

    async function updateAnalyticsDisplay() {
        // Load calls data if not loaded yet (for calls mode)
        if (analyticsDataSource === 'calls' && !callsLoaded && currentUserRecord) {
            showAnalyticsLoading();
            await loadCallsData();
            hideAnalyticsLoading();
        }

        // Outcome counts
        var statusCounts = {
            booked: 0,
            callback: 0,
            followUp: 0,
            timeline: 0,
            notInterested: 0,
            inconclusive: 0,
            noAnswer: 0,
            voicemail: 0,
            maxAttempts: 0,
            wrongPerson: 0,
            dnc: 0
        };
        var totalCount = 0;
        var conversations = 0;
        var qualified = 0;

        var todayEST = getTodayEST();
        var selectedDateStr = toESTDateString(analyticsDate);

        if (analyticsDataSource === 'calls') {
            // Process calls data
            allCalls.forEach(function(call) {
                var f = call.fields;
                var outcome = (f['Outcome'] || '').toLowerCase().trim();
                var timestamp = f['Timestamp'];

                // Filter by period/date using EST timezone
                if (analyticsPeriod !== 'all') {
                    if (!timestamp) return;

                    var callDateEST = toESTDateString(timestamp);

                    if (analyticsPeriod === 'daily') {
                        if (callDateEST !== selectedDateStr) return;
                    } else if (analyticsPeriod === 'weekly') {
                        var selectedEST = getESTDate(analyticsDate);
                        var weekStart = getWeekStart(selectedEST);
                        var weekEnd = getWeekEnd(selectedEST);
                        weekEnd.setHours(23, 59, 59, 999);
                        var callDate = new Date(timestamp);
                        if (callDate < weekStart || callDate > weekEnd) return;
                    } else if (analyticsPeriod === 'monthly') {
                        var selectedEST = getESTDate(analyticsDate);
                        var monthStart = new Date(selectedEST.getFullYear(), selectedEST.getMonth(), 1);
                        var monthEnd = new Date(selectedEST.getFullYear(), selectedEST.getMonth() + 1, 0, 23, 59, 59, 999);
                        var callDate = new Date(timestamp);
                        if (callDate < monthStart || callDate > monthEnd) return;
                    }
                }

                totalCount++;

                // Categorize by outcome
                if (outcome === 'booked') {
                    statusCounts.booked++;
                    conversations++;
                    qualified++;
                } else if (outcome === 'callback') {
                    statusCounts.callback++;
                    conversations++;
                    qualified++;
                } else if (outcome === 'follow up') {
                    statusCounts.followUp++;
                    conversations++;
                    qualified++;
                } else if (outcome === 'timeline') {
                    statusCounts.timeline++;
                    conversations++;
                    qualified++;
                } else if (outcome === 'not interested') {
                    statusCounts.notInterested++;
                    conversations++;
                } else if (outcome === 'inconclusive') {
                    statusCounts.inconclusive++;
                    conversations++;
                } else if (outcome === 'no answer') {
                    statusCounts.noAnswer++;
                } else if (outcome === 'voicemail') {
                    statusCounts.voicemail++;
                } else if (outcome === 'max attempts') {
                    statusCounts.maxAttempts++;
                } else if (outcome === 'wrong person') {
                    statusCounts.wrongPerson++;
                    conversations++;
                } else if (outcome === 'dnc') {
                    statusCounts.dnc++;
                    conversations++;
                }
            });
        } else {
            // Process leads data
            allLeads.forEach(function(lead) {
                var f = lead.fields;
                var status = (f['Status'] || f['Disposition'] || '').toLowerCase().trim();
                var lastUpdated = f['Updated At'];

                // Filter by period/date using EST timezone (based on last updated)
                if (analyticsPeriod !== 'all') {
                    if (!lastUpdated) return;

                    var leadDateEST = toESTDateString(lastUpdated);

                    if (analyticsPeriod === 'daily') {
                        if (leadDateEST !== selectedDateStr) return;
                    } else if (analyticsPeriod === 'weekly') {
                        var selectedEST = getESTDate(analyticsDate);
                        var weekStart = getWeekStart(selectedEST);
                        var weekEnd = getWeekEnd(selectedEST);
                        weekEnd.setHours(23, 59, 59, 999);
                        var leadDate = new Date(lastUpdated);
                        if (leadDate < weekStart || leadDate > weekEnd) return;
                    } else if (analyticsPeriod === 'monthly') {
                        var selectedEST = getESTDate(analyticsDate);
                        var monthStart = new Date(selectedEST.getFullYear(), selectedEST.getMonth(), 1);
                        var monthEnd = new Date(selectedEST.getFullYear(), selectedEST.getMonth() + 1, 0, 23, 59, 59, 999);
                        var leadDate = new Date(lastUpdated);
                        if (leadDate < monthStart || leadDate > monthEnd) return;
                    }
                }

                totalCount++;

                // Categorize by status
                if (status === 'booked') {
                    statusCounts.booked++;
                    conversations++;
                    qualified++;
                } else if (status === 'callback') {
                    statusCounts.callback++;
                    conversations++;
                    qualified++;
                } else if (status === 'follow up') {
                    statusCounts.followUp++;
                    conversations++;
                    qualified++;
                } else if (status === 'timeline') {
                    statusCounts.timeline++;
                    conversations++;
                    qualified++;
                } else if (status === 'not interested') {
                    statusCounts.notInterested++;
                    conversations++;
                } else if (status === 'inconclusive') {
                    statusCounts.inconclusive++;
                    conversations++;
                } else if (status === 'no answer') {
                    statusCounts.noAnswer++;
                } else if (status === 'voicemail') {
                    statusCounts.voicemail++;
                } else if (status === 'max attempts') {
                    statusCounts.maxAttempts++;
                } else if (status === 'wrong person') {
                    statusCounts.wrongPerson++;
                    conversations++;
                } else if (status === 'dnc') {
                    statusCounts.dnc++;
                }
            });
        }

        // Update UI
        var el = function(id) { return document.getElementById(id); };
        if (el('analyticsTotalCalls')) el('analyticsTotalCalls').textContent = totalCount;
        if (el('analyticsConversations')) el('analyticsConversations').textContent = conversations;
        if (el('analyticsActivePipeline')) el('analyticsActivePipeline').textContent = statusCounts.timeline + statusCounts.followUp;

        // Combined booked count (Booked + Callback)
        var totalBooked = statusCounts.booked + statusCounts.callback;
        if (el('analyticsBooked')) el('analyticsBooked').textContent = totalBooked;

        // Percentage formatter
        var pctFormat = function(count) { return totalCount > 0 ? ((count / totalCount) * 100).toFixed(1) + '%' : '0%'; };

        // Helper to set toggleable element data
        var setToggleable = function(id, count, pct) {
            var elem = el(id);
            if (elem) {
                elem.dataset.count = count;
                elem.dataset.pct = pct;
            }
        };

        // Update qualified outcomes with data attributes
        setToggleable('analyticsBookedStat', statusCounts.booked, pctFormat(statusCounts.booked));
        setToggleable('analyticsCallbackCount', statusCounts.callback, pctFormat(statusCounts.callback));
        setToggleable('analyticsTimelineCount', statusCounts.timeline, pctFormat(statusCounts.timeline));
        setToggleable('analyticsFollowUp', statusCounts.followUp, pctFormat(statusCounts.followUp));

        // Update other outcomes with data attributes
        setToggleable('analyticsNotInterested', statusCounts.notInterested, pctFormat(statusCounts.notInterested));
        setToggleable('analyticsInconclusive', statusCounts.inconclusive, pctFormat(statusCounts.inconclusive));
        setToggleable('analyticsNoAnswer', statusCounts.noAnswer, pctFormat(statusCounts.noAnswer));
        setToggleable('analyticsVoicemail', statusCounts.voicemail, pctFormat(statusCounts.voicemail));
        setToggleable('analyticsMaxAttempts', statusCounts.maxAttempts, pctFormat(statusCounts.maxAttempts));
        setToggleable('analyticsWrongPerson', statusCounts.wrongPerson, pctFormat(statusCounts.wrongPerson));
        setToggleable('analyticsDNC', statusCounts.dnc, pctFormat(statusCounts.dnc));

        // Apply toggle display
        updateAnalyticsToggleDisplay();

        // Update conversion funnel
        if (el('funnelCalls')) el('funnelCalls').textContent = totalCount;
        if (el('funnelConversations')) el('funnelConversations').textContent = conversations;
        if (el('funnelQualified')) el('funnelQualified').textContent = qualified;
        if (el('funnelBooked')) el('funnelBooked').textContent = totalBooked;

        // Update funnel bar widths - proportional to total (no minimum)
        var convPct = totalCount > 0 ? (conversations / totalCount) * 100 : 0;
        var qualPct = totalCount > 0 ? (qualified / totalCount) * 100 : 0;
        var bookedPct = totalCount > 0 ? (totalBooked / totalCount) * 100 : 0;
        if (el('funnelConvBar')) el('funnelConvBar').style.width = convPct + '%';
        if (el('funnelQualBar')) el('funnelQualBar').style.width = qualPct + '%';
        if (el('funnelBookedBar')) el('funnelBookedBar').style.width = bookedPct + '%';

        // Add percentages to funnel labels
        var convPctDisplay = totalCount > 0 ? (convPct).toFixed(1) + '%' : '0%';
        var qualPctDisplay = totalCount > 0 ? (qualPct).toFixed(1) + '%' : '0%';
        var bookedPctDisplay = totalCount > 0 ? (bookedPct).toFixed(1) + '%' : '0%';
        if (el('funnelConvPct')) el('funnelConvPct').textContent = convPctDisplay;
        if (el('funnelQualPct')) el('funnelQualPct').textContent = qualPctDisplay;
        if (el('funnelBookedPct')) el('funnelBookedPct').textContent = bookedPctDisplay;

        // Update outcome stat bars
        var maxQualified = Math.max(statusCounts.booked, statusCounts.callback, statusCounts.timeline, statusCounts.followUp, 1);
        if (el('bookedBar')) el('bookedBar').style.width = (statusCounts.booked / maxQualified * 100) + '%';
        if (el('callbackBar')) el('callbackBar').style.width = (statusCounts.callback / maxQualified * 100) + '%';
        if (el('timelineBar')) el('timelineBar').style.width = (statusCounts.timeline / maxQualified * 100) + '%';
        if (el('followupBar')) el('followupBar').style.width = (statusCounts.followUp / maxQualified * 100) + '%';
    }
    
    // ===== IMPORT PAGE =====
    // Tab switching
    document.querySelectorAll('.import-tab').forEach(function(tab) {
        tab.addEventListener('click', function() {
            document.querySelectorAll('.import-tab').forEach(function(t) { t.classList.remove('active'); });
            document.querySelectorAll('.import-panel').forEach(function(p) { p.classList.remove('active'); });
            this.classList.add('active');
            var target = this.dataset.import === 'single' ? 'importSinglePanel' : 'importBulkPanel';
            document.getElementById(target)?.classList.add('active');
        });
    });
    
    // Single lead form
    document.getElementById('submitSingleLeadBtn')?.addEventListener('click', async function() {
        var btn = this;
        var firstName = document.getElementById('singleLeadFirstName')?.value.trim();
        var lastName = document.getElementById('singleLeadLastName')?.value.trim();
        var phone = document.getElementById('singleLeadPhone')?.value.trim();
        var interest = document.getElementById('singleLeadInterest')?.value;
        var email = document.getElementById('singleLeadEmail')?.value.trim();
        var maxAttemptsInput = document.getElementById('singleLeadMaxAttempts');
        var maxAttempts = parseInt(maxAttemptsInput?.value, 10) || 5;
        var context = document.getElementById('singleLeadContext')?.value.trim();

        // Validate max attempts is between 1-10
        if (maxAttempts < 1) maxAttempts = 1;
        if (maxAttempts > 10) maxAttempts = 10;

        var statusEl = document.getElementById('singleLeadStatus');

        if (!firstName || !phone || !interest) {
            if (statusEl) statusEl.innerHTML = '<p style="color:#ef4444">Please fill in required fields</p>';
            return;
        }

        btn.disabled = true;
        btn.textContent = 'Adding...';
        if (statusEl) statusEl.innerHTML = '<p style="color:rgb(52,211,153)">Adding lead...</p>';

        try {
            // Build lead data
            var agentName = currentUserRecord?.fields?.['Agent Name'] || 'our team';
            var defaultContext = 'You reached out to ' + agentName + ' a while ago regarding your interest in buying or selling a property. Are you still in the market?';

            var leadData = {
                'First Name': firstName,
                'Last Name': lastName,
                'Phone #': phone,
                interest: interest,
                email: email,
                maxAttempts: maxAttempts,
                context: context || defaultContext
            };

            // Add optional Next Call Date
            var selectedDate = document.getElementById('singleLeadCallDate')?.value;
            if (selectedDate) {
                var timeHour = 9; // Morning default
                var selectedTime = singleLeadSelectedTime || 'Afternoon';
                if (selectedTime === 'Afternoon') timeHour = 13;
                else if (selectedTime === 'Evening') timeHour = 17;
                var nextCallDt = new Date(selectedDate + 'T00:00:00');
                nextCallDt.setHours(timeHour, 0, 0, 0);
                leadData['Next Call Date'] = nextCallDt.toISOString();
            }

            // Send to n8n webhook
            var response = await fetch('https://n8n.prioai.ca/webhook/lead-file-upload', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    email: currentUser?.email,
                    agentName: agentName,
                    type: 'single',
                    leads: [leadData]
                })
            });

            if (!response.ok) {
                throw new Error('Server returned ' + response.status);
            }

            if (statusEl) statusEl.innerHTML = '<p style="color:#22c55e"> Lead added successfully! It will appear shortly.</p>';

            // Clear form
            document.getElementById('singleLeadFirstName').value = '';
            document.getElementById('singleLeadLastName').value = '';
            document.getElementById('singleLeadPhone').value = '';
            document.getElementById('singleLeadInterest').value = '';
            document.getElementById('singleLeadEmail').value = '';
            document.getElementById('singleLeadMaxAttempts').value = '5';
            document.getElementById('singleLeadContext').value = '';
            document.getElementById('singleLeadCallDate').value = '';
            singleLeadCalDate = new Date();
            singleLeadSelectedDate = null;
            singleLeadSelectedTime = 'Afternoon';
            document.getElementById('singleLeadCalendar').style.display = 'none';
            document.getElementById('singleLeadTimeWrapper').style.display = 'none';
            var calToggle = document.getElementById('singleLeadCalToggle');
            calToggle.innerHTML = ' Pick a date';
            calToggle.style.color = 'rgba(255,255,255,0.5)';
            document.querySelectorAll('#singleLeadTimePref .time-pref-btn').forEach(function(b) { b.classList.remove('active'); });
            document.querySelector('#singleLeadTimePref .time-pref-btn[data-time="Afternoon"]').classList.add('active');
        } catch (err) {
            if (statusEl) statusEl.innerHTML = '<p style="color:#ef4444">Failed to add lead: ' + err.message + '</p>';
        }

        btn.disabled = false;
        btn.textContent = ' Add Lead';
    });

    // Single Lead Calendar for Next Call Date
    var singleLeadCalDate = new Date();
    var singleLeadSelectedDate = null;
    var singleLeadSelectedTime = 'Afternoon';

    function renderSingleLeadCalendar() {
        var year = singleLeadCalDate.getFullYear();
        var month = singleLeadCalDate.getMonth();
        var today = new Date();
        today.setHours(0,0,0,0);
        var monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                          'July', 'August', 'September', 'October', 'November', 'December'];
        document.getElementById('singleLeadCalMonth').textContent = monthNames[month] + ' ' + year;
        var firstDay = new Date(year, month, 1).getDay();
        var daysInMonth = new Date(year, month + 1, 0).getDate();
        var daysHtml = '';
        for (var i = 0; i < firstDay; i++) {
            daysHtml += '<span class="calendar-day empty"></span>';
        }
        for (var d = 1; d <= daysInMonth; d++) {
            var dateObj = new Date(year, month, d);
            dateObj.setHours(0,0,0,0);
            var dateStr = year + '-' + String(month + 1).padStart(2, '0') + '-' + String(d).padStart(2, '0');
            var isPast = dateObj.getTime() <= today.getTime();
            var isSelected = singleLeadSelectedDate === dateStr;
            var classes = 'calendar-day';
            if (isPast) classes += ' past';
            if (isSelected) classes += ' selected';
            daysHtml += '<span class="' + classes + '" data-date="' + dateStr + '">' + d + '</span>';
        }
        document.getElementById('singleLeadCalDays').innerHTML = daysHtml;
        document.querySelectorAll('#singleLeadCalDays .calendar-day:not(.empty):not(.past)').forEach(function(day) {
            day.addEventListener('click', function() {
                singleLeadSelectedDate = this.dataset.date;
                document.getElementById('singleLeadCallDate').value = singleLeadSelectedDate;
                renderSingleLeadCalendar();
                // Update toggle button to show selected date
                var parts = singleLeadSelectedDate.split('-');
                var dateObj = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                var monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                var toggle = document.getElementById('singleLeadCalToggle');
                toggle.innerHTML = ' ' + monthNames[dateObj.getMonth()] + ' ' + dateObj.getDate() + ', ' + dateObj.getFullYear();
                toggle.style.color = '#fff';
                // Show time preference
                document.getElementById('singleLeadTimeWrapper').style.display = 'block';
            });
        });
    }

    document.getElementById('singleLeadCalToggle')?.addEventListener('click', function() {
        var cal = document.getElementById('singleLeadCalendar');
        if (cal.style.display === 'none') {
            cal.style.display = 'block';
            singleLeadCalDate = new Date();
            renderSingleLeadCalendar();
        } else {
            cal.style.display = 'none';
        }
    });

    document.getElementById('singleLeadCalPrev')?.addEventListener('click', function() {
        singleLeadCalDate.setMonth(singleLeadCalDate.getMonth() - 1);
        renderSingleLeadCalendar();
    });
    document.getElementById('singleLeadCalNext')?.addEventListener('click', function() {
        singleLeadCalDate.setMonth(singleLeadCalDate.getMonth() + 1);
        renderSingleLeadCalendar();
    });

    document.querySelectorAll('#singleLeadTimePref .time-pref-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            document.querySelectorAll('#singleLeadTimePref .time-pref-btn').forEach(function(b) { b.classList.remove('active'); });
            this.classList.add('active');
            singleLeadSelectedTime = this.dataset.time;
        });
    });

    // File upload
    var uploadZone = document.getElementById('fileUploadZone');
    var fileInput = document.getElementById('leadFileInput');
    
    uploadZone?.addEventListener('click', function() { fileInput?.click(); });
    uploadZone?.addEventListener('dragover', function(e) { e.preventDefault(); this.classList.add('dragover'); });
    uploadZone?.addEventListener('dragleave', function() { this.classList.remove('dragover'); });
    uploadZone?.addEventListener('drop', function(e) {
        e.preventDefault();
        this.classList.remove('dragover');
        if (e.dataTransfer.files.length) handleFileUpload(e.dataTransfer.files[0]);
    });
    fileInput?.addEventListener('change', function() {
        if (this.files.length) handleFileUpload(this.files[0]);
    });
    
    async function handleFileUpload(file) {
        var statusEl = document.getElementById('uploadStatus');
        if (!statusEl) return;
        
        statusEl.innerHTML = '<p style="color:rgb(52,211,153)"> Uploading ' + file.name + '...</p>';
        
        try {
            var reader = new FileReader();
            reader.onload = async function(e) {
                var base64 = e.target.result.split(',')[1];
                await fetch('https://n8n.prioai.ca/webhook/lead-file-upload', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: currentUser?.email,
                        agentName: currentUserRecord?.fields?.['Agent Name'] || '',
                        fileName: file.name,
                        fileType: file.type,
                        fileData: base64
                    })
                });
                statusEl.innerHTML = '<p style="color:#22c55e"> File uploaded successfully! Leads will be processed shortly.</p>';
            };
            reader.readAsDataURL(file);
        } catch (err) {
            statusEl.innerHTML = '<p style="color:#ef4444">Failed to upload: ' + err.message + '</p>';
        }
    }
    
    // Template link opens Google Sheet copy page directly (no JS needed)
    
    // ===== SEARCH PAGE =====
    var searchedLead = null;
    
    document.getElementById('globalSearchBtn')?.addEventListener('click', performSearch);
    document.getElementById('globalSearchInput')?.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') performSearch();
    });
    
    function performSearch() {
        var query = document.getElementById('globalSearchInput')?.value.trim().toLowerCase();
        if (!query) return;
        
        var results = allLeads.filter(function(l) {
            var f = l.fields;
            var name = ((f['First Name'] || '') + ' ' + (f['Last Name'] || '')).toLowerCase();
            var phone = (f['Phone #'] || f['Phone'] || '').replace(/\D/g, '');
            var phoneLast4 = phone.slice(-4);
            return name.includes(query) || phoneLast4 === query || phone.includes(query);
        });
        
        document.getElementById('searchMultipleResults').style.display = 'none';
        document.getElementById('searchLeadDetail').style.display = 'none';
        document.getElementById('searchEmptyState').style.display = 'none';
        
        if (results.length === 0) {
            document.getElementById('searchEmptyState').style.display = 'block';
            document.getElementById('searchEmptyText').textContent = 'No lead found matching "' + query + '"';
        } else if (results.length === 1) {
            showSearchLeadDetail(results[0]);
        } else {
            // Multiple results
            document.getElementById('searchMultipleResults').style.display = 'block';
            document.getElementById('searchResultsList').innerHTML = results.slice(0, 10).map(function(lead) {
                var f = lead.fields;
                var name = ((f['First Name'] || '') + ' ' + (f['Last Name'] || '')).trim() || 'Unknown';
                var phone = formatPhone(f['Phone #'] || f['Phone'] || '-');
                var status = f['Status'] || f['Disposition'] || '-';
                var nextCallDate = f['Next Call Date'];
                var nextCallDisplay = nextCallDate ? formatDateTime(nextCallDate) : '';
                return '<div class="search-result-item" onclick="showSearchLeadDetail(allLeads.find(function(l){return l.id===\'' + lead.id + '\'}))">' +
                    '<div><div style="font-weight:600">' + escapeHtml(name) + '</div><div style="color:rgba(255,255,255,0.5);font-family:monospace">' + escapeHtml(phone) + '</div>' +
                    (nextCallDisplay ? '<div class="search-result-next-call">Next Call: ' + escapeHtml(nextCallDisplay) + '</div>' : '') +
                    '</div>' +
                    '<span class="status-badge ' + getStatusClass(status) + '">' + escapeHtml(status) + '</span>' +
                '</div>';
            }).join('');
        }
    }
    
    function toggleSearchSection(id) {
        var el = document.getElementById(id);
        if (el) el.classList.toggle('collapsed');
    }
    window.toggleSearchSection = toggleSearchSection;

    function showSearchLeadDetail(lead) {
        if (!lead) return;
        searchedLead = lead;
        var f = lead.fields;

        document.getElementById('searchMultipleResults').style.display = 'none';
        document.getElementById('searchLeadDetail').style.display = 'block';

        // Update URL with lead ID for deep linking
        history.pushState({ leadId: lead.id, page: 'search' }, '', '#search/' + lead.id);

        var firstName = f['First Name'] || '';
        var lastName = f['Last Name'] || '';
        var fullName = (firstName + ' ' + lastName).trim() || 'Unknown';
        document.getElementById('searchLeadName').textContent = fullName;
        var initials = ((firstName.charAt(0) || '') + (lastName.charAt(0) || '')).toUpperCase() || '?';
        document.getElementById('searchLeadAvatar').textContent = initials;
        var searchRawPhone = f['Phone #'] || f['Phone'] || '-';
        document.getElementById('searchLeadPhoneDisplay').innerHTML = phoneLink(searchRawPhone, formatPhone(searchRawPhone));

        var status = f['Status'] || f['Disposition'] || '-';
        var statusBadge = document.getElementById('searchLeadStatusBadge');
        statusBadge.textContent = status;
        statusBadge.className = 'status-badge ' + getStatusClass(status);

        var lastOutcome = f['Last Outcome'] || '';
        var outcomeBadge = document.getElementById('searchLeadOutcomeBadge');
        if (lastOutcome && lastOutcome.toLowerCase() !== status.toLowerCase()) {
            outcomeBadge.textContent = lastOutcome;
            outcomeBadge.className = 'status-badge ' + getStatusClass(lastOutcome);
            outcomeBadge.style.display = '';
        } else {
            outcomeBadge.style.display = 'none';
        }

        document.getElementById('searchLeadEmail').textContent = f['Email'] || '-';
        document.getElementById('searchLeadCalls').textContent = f['Attempts'] || '0';
        document.getElementById('searchLeadLastCall').textContent = f['Updated At'] ? formatDateTime(f['Updated At']) : '-';
        document.getElementById('searchLeadBookedTime').textContent = f['Booked Time'] ? formatDateTime(f['Booked Time']) : '-';
        document.getElementById('searchLeadNextCall').textContent = f['Next Call Date'] ? formatDateTime(f['Next Call Date']) : '-';

        // Notes History (read-only)
        var notesRaw = f['Client Notes'] || '';
        var notes = parseNotesJson(notesRaw);
        var notesListEl = document.getElementById('searchLeadNotesList');
        document.getElementById('searchNotesCount').textContent = notes.length;
        if (notes.length > 0) {
            notesListEl.innerHTML = notes.map(function(n) {
                var dateStr = n.date ? formatNoteDate(n.date) : '';
                return '<div class="search-note-item">' +
                    (dateStr ? '<div class="search-note-date">' + dateStr + '</div>' : '') +
                    '<div class="search-note-text">' + escapeHtml(n.text) + '</div>' +
                '</div>';
            }).join('');
            // Auto-expand notes if they exist
            document.getElementById('searchSectionNotes').classList.remove('collapsed');
        } else {
            notesListEl.innerHTML = '<p style="color:rgba(255,255,255,0.4);font-size:0.8125rem;">No notes available</p>';
            document.getElementById('searchSectionNotes').classList.add('collapsed');
        }

        // Manual Call Attempts (read-only)
        var attemptsRaw = f['Call Attempts'] || '';
        var attemptsArray = [];
        try {
            if (typeof attemptsRaw === 'string' && attemptsRaw) {
                attemptsArray = JSON.parse(attemptsRaw);
            } else if (Array.isArray(attemptsRaw)) {
                attemptsArray = attemptsRaw;
            }
        } catch (e) {
            attemptsArray = [];
        }
        var attemptsListEl = document.getElementById('searchLeadAttemptsList');
        document.getElementById('searchAttemptsCount').textContent = attemptsArray.length;
        if (attemptsArray.length > 0) {
            attemptsListEl.innerHTML = attemptsArray.map(function(attempt, i) {
                var timeStr = attempt.time ? formatFriendlyDateTime(attempt.time) : 'Unknown time';
                return '<div class="search-attempt-item">' +
                    '<div class="search-attempt-time">Call #' + (i + 1) + ' - ' + timeStr + '</div>' +
                '</div>';
            }).join('');
        } else {
            attemptsListEl.innerHTML = '<p style="color:rgba(255,255,255,0.4);font-size:0.8125rem;">No manual call attempts logged</p>';
        }

        // AI Call History - fetch directly from Calls table for this lead
        var aiCallsListEl = document.getElementById('searchLeadAICallsList');
        window.searchCallsData = [];
        aiCallsListEl.innerHTML = '<p style="color:rgba(255,255,255,0.4);font-size:0.8125rem;">Loading call history...</p>';
        document.getElementById('searchAICallsCount').textContent = '...';

        // Fetch calls async so the rest of the UI renders immediately
        (async function() {
            try {
                var leadId = lead.id;
                var callsFilter = 'FIND("' + leadId + '", ARRAYJOIN({Lead}))';
                var callsPath = AIRTABLE_BASE + '/' + AIRTABLE_CALLS_TABLE +
                    '?filterByFormula=' + encodeURIComponent(callsFilter) +
                    '&sort[0][field]=Timestamp&sort[0][direction]=desc&pageSize=100';

                var callRecords = [];
                var callOffset = null;
                do {
                    var fetchPath = callsPath + (callOffset ? '&offset=' + callOffset : '');
                    var callData = await fetchAirtable(fetchPath);
                    if (callData.records) callRecords = callRecords.concat(callData.records);
                    callOffset = callData.offset;
                } while (callOffset);

                window.searchCallsData = [];
                var aiCallsHtml = '';

                if (callRecords.length > 0) {
                    callRecords.forEach(function(record, i) {
                        var cf = record.fields;
                        var callNum = callRecords.length - i;
                        var transcript = cf['Transcript'] || '';
                        var timestamp = cf['Timestamp'] || null;
                        var outcome = cf['Outcome'] || 'Completed';
                        var duration = cf['Duration (Seconds)'] || cf['Duration'] || null;
                        var outcomeClass = (outcome || '').toLowerCase().replace(/\s+/g, '-');
                        var timeStr = timestamp ? formatFriendlyDateTime(timestamp) : '';
                        var durationStr = '';
                        if (duration) {
                            var secs = parseInt(duration, 10);
                            var mins = Math.floor(secs / 60);
                            var remainSecs = secs % 60;
                            durationStr = mins > 0 ? mins + 'm ' + remainSecs + 's' : secs + 's';
                        }

                        window.searchCallsData.push({
                            callNum: callNum,
                            timestamp: timestamp,
                            outcome: outcome,
                            duration: duration,
                            transcript: transcript
                        });

                        aiCallsHtml += '<div class="search-ai-call-item">' +
                            '<div class="search-ai-call-header">' +
                                '<span class="search-ai-call-title">AI Call #' + callNum + '</span>' +
                                '<span class="search-ai-call-outcome ' + outcomeClass + '">' + escapeHtml(outcome) + '</span>' +
                            '</div>' +
                            '<div class="search-ai-call-meta">' +
                                (timeStr ? '<span>' + timeStr + '</span>' : '') +
                                (durationStr ? '<span>' + durationStr + '</span>' : '') +
                            '</div>' +
                            (transcript ? '<div class="search-ai-call-preview">' + escapeHtml(transcript.substring(0, 150)) + (transcript.length > 150 ? '...' : '') + '</div>' : '') +
                            '<div class="search-ai-call-footer">' +
                                '<button class="search-ai-view-btn" onclick="openCallDetailModal(' + i + ')">View Full Details </button>' +
                            '</div>' +
                        '</div>';
                    });
                }

                document.getElementById('searchAICallsCount').textContent = callRecords.length;

                if (aiCallsHtml) {
                    aiCallsListEl.innerHTML = aiCallsHtml;
                } else {
                    aiCallsListEl.innerHTML = '<p style="color:rgba(255,255,255,0.4);font-size:0.8125rem;">No AI calls recorded</p>';
                }
            } catch (err) {
                console.error('Failed to load call history:', err);
                aiCallsListEl.innerHTML = '<p style="color:rgba(255,255,255,0.4);font-size:0.8125rem;">Failed to load call history</p>';
                document.getElementById('searchAICallsCount').textContent = '0';
            }
        })();

        // Summary
        var summaryRaw = f['Last Call Summary'] || '';
        var summary = Array.isArray(summaryRaw) ? summaryRaw.join('\n') : String(summaryRaw || 'No summary available');
        document.getElementById('searchLeadSummary').textContent = summary;

        // Update action button states
        var isShared = lead.isShared || (f['Shared With'] && f['Shared With'].length > 0) || (f['Shared With Email'] && (Array.isArray(f['Shared With Email']) ? f['Shared With Email'].length > 0 : f['Shared With Email']));
        var shareBtn = document.getElementById('searchShareBtn');
        if (isShared) {
            shareBtn.textContent = ' Shared';
            shareBtn.classList.add('shared');
        } else {
            shareBtn.textContent = ' Share';
            shareBtn.classList.remove('shared');
        }

        // Show Take Over only for pipeline leads (Timeline/Follow Up)
        // Show Send Back to AI for prospects/prio leads (Booked/Callback)
        var takeOverBtn = document.getElementById('searchTakeOverBtn');
        var isPipelineLead = status === 'Timeline' || status === 'Follow Up';
        var isProspectLead = status === 'Booked' || status === 'Appointment Booked' || status === 'Callback' || status === 'Callback Requested';

        if (isPipelineLead) {
            takeOverBtn.textContent = ' Take Over';
            takeOverBtn.onclick = takeOverFromSearch;
            takeOverBtn.style.display = 'inline-block';
        } else if (isProspectLead) {
            takeOverBtn.textContent = ' Send Back to AI';
            takeOverBtn.onclick = sendBackToAIFromSearch;
            takeOverBtn.style.display = 'inline-block';
        } else {
            // For other statuses like Do Not Call, hide the button
            takeOverBtn.style.display = 'none';
        }
    }

    // Search page action functions
    function shareFromSearch() {
        if (!searchedLead) return;
        quickShareLead(searchedLead.id);
    }
    window.shareFromSearch = shareFromSearch;

    async function takeOverFromSearch() {
        if (!searchedLead) return;
        var name = ((searchedLead.fields['First Name'] || '') + ' ' + (searchedLead.fields['Last Name'] || '')).trim() || 'This lead';

        try {
            await fetchAirtable(AIRTABLE_BASE + '/' + AIRTABLE_LEADS_TABLE + '/' + searchedLead.id, {
                method: 'PATCH',
                body: {
                    fields: {
                        'Status': 'Callback',
                        'Last Outcome': 'Callback'
                    }
                }
            });

            // Update local data
            searchedLead.fields['Status'] = 'Callback';
            searchedLead.fields['Last Outcome'] = 'Callback';
            var idx = allLeads.findIndex(function(l) { return l.id === searchedLead.id; });
            if (idx !== -1) {
                allLeads[idx].fields['Status'] = 'Callback';
                allLeads[idx].fields['Last Outcome'] = 'Callback';
            }

            showToast(name + ' has been taken over', 'success');
            showSearchLeadDetail(searchedLead); // Refresh display
            updatePipelineList();
            updateProspectsTable();
            updateUnqualifiedList();
            updateOpenLeadsList();
        } catch (err) {
            console.error('Error taking over lead:', err);
            showToast('Failed to take over lead', 'error');
        }
    }
    window.takeOverFromSearch = takeOverFromSearch;

    // Send prospect back to AI from search page
    function sendBackToAIFromSearch() {
        if (!searchedLead) return;
        openSendAIModal(searchedLead.id, searchedLead.fields);
    }
    window.sendBackToAIFromSearch = sendBackToAIFromSearch;

    async function dncFromSearch() {
        if (!searchedLead) return;
        var name = ((searchedLead.fields['First Name'] || '') + ' ' + (searchedLead.fields['Last Name'] || '')).trim() || 'This lead';

        var confirmed = await showConfirmModal(
            'Mark as Do Not Call',
            'Are you sure you want to mark ' + name + ' as Do Not Call? This will stop all AI outreach.',
            '',
            true
        );
        if (!confirmed) return;

        try {
            await fetchAirtable(AIRTABLE_BASE + '/' + AIRTABLE_LEADS_TABLE + '/' + searchedLead.id, {
                method: 'PATCH',
                body: {
                    fields: {
                        'Status': 'Do Not Call',
                        'Last Outcome': 'Do Not Call'
                    }
                }
            });

            // Update local data
            searchedLead.fields['Status'] = 'Do Not Call';
            searchedLead.fields['Last Outcome'] = 'Do Not Call';
            var idx = allLeads.findIndex(function(l) { return l.id === searchedLead.id; });
            if (idx !== -1) {
                allLeads[idx].fields['Status'] = 'Do Not Call';
                allLeads[idx].fields['Last Outcome'] = 'Do Not Call';
            }

            showToast(name + ' marked as Do Not Call', 'success');
            showSearchLeadDetail(searchedLead); // Refresh display
            updatePipelineList();
            updateProspectsTable();
            updatePrioListFiltered();
            updateUnqualifiedList();
            updateOpenLeadsList();
        } catch (err) {
            console.error('Error marking DNC:', err);
            showToast('Failed to mark as Do Not Call', 'error');
        }
    }
    window.dncFromSearch = dncFromSearch;

    // Call detail modal functions
    function openCallDetailModal(callIndex) {
        var callData = window.searchCallsData && window.searchCallsData[callIndex];
        if (!callData) return;

        var modal = document.getElementById('callDetailModal');

        // Format duration
        var durationText = '-';
        if (callData.duration) {
            var secs = parseInt(callData.duration, 10);
            var mins = Math.floor(secs / 60);
            var remainingSecs = secs % 60;
            if (mins > 0) {
                durationText = mins + 'm ' + remainingSecs + 's';
            } else {
                durationText = secs + 's';
            }
        }

        // Format date
        var dateText = '-';
        if (callData.timestamp) {
            var d = new Date(callData.timestamp);
            dateText = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        document.getElementById('callDetailDuration').textContent = durationText;
        document.getElementById('callDetailOutcome').textContent = callData.outcome || '-';
        document.getElementById('callDetailDate').textContent = dateText;
        document.getElementById('callDetailTranscript').textContent = callData.transcript || 'No transcript available for this call.';

        modal.classList.add('active');
    }
    window.openCallDetailModal = openCallDetailModal;

    function closeCallDetailModal() {
        document.getElementById('callDetailModal').classList.remove('active');
    }
    window.closeCallDetailModal = closeCallDetailModal;

    // Close call detail modal when clicking outside
    document.getElementById('callDetailModal')?.addEventListener('click', function(e) {
        if (e.target === this) closeCallDetailModal();
    });

    // Update analytics when data loads
    var originalLoadLeadsData2 = loadLeadsData;
    loadLeadsData = async function() {
        await originalLoadLeadsData2();
        updateAnalyticsDisplay();
    };

    // One-time page refresh after 30 seconds (only on first visit per session)
    var initialRefreshDone = sessionStorage.getItem('prio_initial_refresh');
    if (!initialRefreshDone) {
        sessionStorage.setItem('prio_initial_refresh', 'true');
        setTimeout(function() {
            window.location.reload();
        }, 30000);
    }

    // Contact Us category chip listeners
    document.querySelectorAll('.contact-chip input[name="feedbackCat"]').forEach(function(radio) {
        radio.addEventListener('change', function() {
            document.getElementById('feedbackCategory').value = this.value;
        });
    });

    // Feedback form submission
    document.getElementById('feedbackForm')?.addEventListener('submit', async function(e) {
        e.preventDefault();

        var category = document.getElementById('feedbackCategory').value;
        var message = document.getElementById('feedbackMessage').value;
        var submitBtn = document.getElementById('feedbackSubmitBtn');
        var btnText = document.getElementById('feedbackBtnText');
        var btnLoading = document.getElementById('feedbackBtnLoading');
        var successDiv = document.getElementById('feedbackSuccess');

        if (!category || !message.trim()) {
            alert('Please fill in all fields');
            return;
        }

        // Show loading state
        submitBtn.disabled = true;
        btnText.style.display = 'none';
        btnLoading.style.display = 'inline';

        try {
            var response = await fetch('https://n8n.prioai.ca/webhook/feedback', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    category: category,
                    message: message,
                    email: currentUser?.email || 'anonymous',
                    name: currentUser?.displayName || currentUserRecord?.fields?.['Agent Name'] || 'Unknown',
                    timestamp: new Date().toISOString(),
                    source: 'dashboard'
                })
            });

            if (response.ok) {
                // Show success message
                document.getElementById('feedbackForm').style.display = 'none';
                successDiv.style.display = 'block';

                // Reset form after delay
                setTimeout(function() {
                    document.getElementById('feedbackCategory').value = '';
                    document.getElementById('feedbackMessage').value = '';
                    document.querySelectorAll('.contact-chip input[name="feedbackCat"]').forEach(function(r) { r.checked = false; });
                    document.getElementById('feedbackForm').style.display = 'block';
                    successDiv.style.display = 'none';
                }, 3000);
            } else {
                throw new Error('Failed to send feedback');
            }
        } catch (err) {
            console.error('Feedback error:', err);
            alert('Failed to send feedback. Please try again.');
        } finally {
            submitBtn.disabled = false;
            btnText.style.display = 'inline';
            btnLoading.style.display = 'none';
        }
    });
    </script>
</body>
</html>
