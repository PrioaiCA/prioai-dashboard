<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Prio AI Dashboard - Manage your leads and grow your business.">
    <title>Dashboard | Prio AI</title>
    <link rel="icon" type="image/png" href="/assets/favicon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Outfit:wght@600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/assets/styles.css">
    <style>
        /* Critical inline styles for immediate rendering */
        .stats-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:1rem;margin-bottom:2rem}
        @media(min-width:768px){.stats-grid{grid-template-columns:repeat(4,1fr)}}
        .stat-card{background:#111;border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:1.25rem;display:flex;align-items:center;gap:1rem}
        .stat-card.accent{background:rgba(52,211,153,0.1);border-color:rgb(52,211,153)}
        .stat-icon{font-size:1.5rem}
        .stat-value{font-size:1.5rem;font-weight:700;line-height:1}
        .stat-label{font-size:0.75rem;color:rgba(255,255,255,0.6);text-transform:uppercase}
        .quick-actions{display:grid;grid-template-columns:repeat(2,1fr);gap:0.75rem;margin-bottom:2rem}
        @media(min-width:768px){.quick-actions{grid-template-columns:repeat(4,1fr)}}
        .quick-action{display:flex;flex-direction:column;align-items:center;gap:0.5rem;padding:1.25rem;background:#111;border:1px solid rgba(255,255,255,0.1);border-radius:12px;color:#fff;cursor:pointer}
        .quick-action:hover{border-color:rgb(52,211,153);background:rgba(52,211,153,0.1)}
        .quick-action-icon{font-size:1.5rem}
        .quick-action-text{font-size:0.875rem;font-weight:500}
        .overview-header{margin-bottom:2.5rem;padding-bottom:1.5rem;border-bottom:1px solid rgba(255,255,255,0.08)}
        .overview-header-row{display:flex;justify-content:space-between;align-items:flex-start;gap:1.5rem;margin-bottom:1.5rem;padding-bottom:1.5rem;border-bottom:1px solid rgba(255,255,255,0.08);flex-wrap:wrap}
        .overview-header-left{flex:1;min-width:280px}
        .overview-header-right{display:flex;gap:0.75rem;flex-wrap:wrap}
        .header-stat-badge{background:#111;border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:0.75rem 1rem;min-width:85px;min-height:70px;text-align:center;display:flex;flex-direction:column;align-items:center;justify-content:center;overflow:hidden}
        .header-stat-badge.usage-badge{min-width:180px;min-height:70px;padding:0.5rem 1.25rem}
        .header-stat-badge.accent{background:rgba(52,211,153,0.1);border-color:rgba(52,211,153,0.3)}
        .header-stat-badge .badge-emoji{font-size:0.75rem;margin-bottom:1px;line-height:1}
        .header-stat-badge .badge-value{font-size:1.25rem;font-weight:700;margin-bottom:1px;line-height:1.2}
        .header-stat-badge .badge-label{font-size:0.6875rem;color:rgba(255,255,255,0.5);text-transform:uppercase;letter-spacing:0.5px;line-height:1}
        .section-label{font-size:0.8125rem;font-weight:600;color:rgba(255,255,255,0.5);text-transform:uppercase;letter-spacing:0.5px;margin:1.5rem 0 0.75rem 0}
        .usage-bar-mini{width:100%;height:6px;background:rgba(255,255,255,0.1);border-radius:3px;margin-top:8px;overflow:hidden}
        .usage-bar-mini .usage-bar-fill{height:100%;border-radius:3px;transition:width 0.3s ease,background 0.3s ease;background:linear-gradient(90deg,#fff,#fff)}
        .usage-bar-mini .usage-bar-fill.warning{background:linear-gradient(90deg,#f59e0b,#eab308)}
        .usage-bar-mini .usage-bar-fill.danger{background:linear-gradient(90deg,#ef4444,#dc2626)}
        .overview-welcome{font-size:2rem;font-weight:700;margin-bottom:0.75rem}
        .overview-header-meta{display:flex;align-items:center;gap:12px;font-size:0.9375rem;color:rgba(255,255,255,0.5)}
        .usage-card .stat-content{flex:1}
        .usage-bar{height:6px;background:rgba(255,255,255,0.1);border-radius:3px;margin-top:10px;overflow:hidden}
        .usage-bar-fill{height:100%;background:rgb(52,211,153);border-radius:3px;transition:width 0.3s ease,background 0.3s ease}
        .usage-bar-fill.warning{background:#f59e0b}
        .usage-bar-fill.danger{background:#ef4444}
        .header-meta-item{display:flex;align-items:center;gap:6px}
        .header-meta-divider{opacity:0.3}
        .meta-label{color:rgba(255,255,255,0.4)}
        .meta-value{color:rgb(52,211,153);font-family:monospace;font-weight:500}
        .analytics-section{margin-top:2rem;margin-bottom:2rem}
        .analytics-header{margin-bottom:1rem}
        .analytics-header h3{font-size:1.125rem;font-weight:600}
        .analytics-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:1rem}
        @media(max-width:768px){.analytics-grid{grid-template-columns:1fr}}
        .analytics-card{background:#111;border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:1rem}
        .analytics-row{display:flex;justify-content:space-between;align-items:center;padding:0.625rem 0;border-bottom:1px solid rgba(255,255,255,0.05)}
        .analytics-row:last-child{border-bottom:none}
        .analytics-label{font-size:0.875rem;color:rgba(255,255,255,0.7)}
        .analytics-value{font-size:1.25rem;font-weight:700}
        .analytics-value.success{color:rgb(52,211,153)}
        .analytics-value.warning{color:#f59e0b}
        .analytics-value.muted{color:rgba(255,255,255,0.4)}
        .priorities-section{margin-top:2rem}
        .priorities-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem}
        .priorities-header h3{font-size:1.25rem;font-weight:600;display:flex;align-items:center;gap:10px}
        .priorities-count{background:rgb(52,211,153);color:#000;font-size:0.875rem;font-weight:700;padding:4px 12px;border-radius:20px}
        .priorities-view-toggle{display:flex;gap:4px}
        .view-toggle-btn{width:32px;height:32px;border:1px solid rgba(255,255,255,0.15);background:#111;color:rgba(255,255,255,0.5);border-radius:6px;cursor:pointer;font-size:1rem;transition:all 0.15s}
        .view-toggle-btn:hover{border-color:rgba(255,255,255,0.3);color:rgba(255,255,255,0.8)}
        .view-toggle-btn.active{background:rgb(52,211,153);border-color:rgb(52,211,153);color:#000}
        .priorities-cards{display:grid;grid-template-columns:1fr;gap:1rem}
        .priority-card-lg{background:#111;border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:0;cursor:pointer;transition:all 0.15s;display:flex;flex-direction:row;min-height:100px;overflow:hidden}
        .priority-card-lg:hover{border-color:rgb(52,211,153);transform:translateY(-2px)}
        .priority-card-lg-left{flex:0 0 320px;display:flex;flex-direction:row;border-right:1px solid rgba(255,255,255,0.08)}
        .priority-card-lg-time-col{flex:0 0 85px;background:rgba(52,211,153,0.1);display:flex;flex-direction:column;align-items:center;justify-content:center;padding:12px}
        .priority-card-lg-time-col .time-value{font-size:1rem;font-weight:700;color:rgb(52,211,153);white-space:nowrap;min-width:70px;text-align:center}
        .priority-card-lg-info{flex:1;padding:14px;display:flex;flex-direction:column;justify-content:center}
        .priority-card-lg-top{display:flex;align-items:center;gap:10px;margin-bottom:6px}
        .priority-card-lg-name{font-size:1rem;font-weight:600}
        .priority-card-lg-badge{font-size:0.6875rem;padding:3px 8px;border-radius:4px;font-weight:600;text-transform:uppercase}
        .priority-card-lg-badge.booked{background:rgba(52,211,153,0.15);color:rgb(52,211,153)}
        .priority-card-lg-badge.callback{background:rgba(245,158,11,0.15);color:#f59e0b}
        .priority-card-lg-phone{font-size:0.875rem;color:rgba(255,255,255,0.7);margin-bottom:4px;font-family:monospace}
        .priority-card-lg-lastcall{font-size:0.8125rem;color:rgba(255,255,255,0.5);display:flex;align-items:center;gap:6px}
        .priority-card-lg-lastcall .lastcall-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0}
        .priority-card-lg-summary-col{flex:1;padding:14px 18px;border-right:1px solid rgba(255,255,255,0.08);display:flex;flex-direction:column}
        .priority-card-lg-summary-col .col-label{font-size:0.8125rem;text-transform:uppercase;color:rgba(255,255,255,0.5);margin-bottom:8px;font-weight:600}
        .priority-card-lg-summary-col .col-content{font-size:1rem;line-height:1.6;color:rgba(255,255,255,0.85);flex:1;overflow:hidden}
        .priority-card-lg-notes-col{flex:1;padding:14px 18px;display:flex;flex-direction:column}
        .priority-card-lg-notes-col .col-label{font-size:0.8125rem;text-transform:uppercase;color:rgba(255,255,255,0.5);margin-bottom:8px;font-weight:600}
        .priority-card-lg-notes-col .col-content{font-size:1rem;line-height:1.5;color:rgba(255,255,255,0.8);flex:1;overflow:hidden}
        @media(max-width:900px){.priority-card-lg{flex-direction:column}.priority-card-lg-left{flex:none;border-right:none;border-bottom:1px solid rgba(255,255,255,0.08)}.priority-card-lg-summary-col{border-right:none;border-bottom:1px solid rgba(255,255,255,0.08)}.priority-card-lg-notes-col{flex:none}}
        .missed-meeting-separator{display:flex;align-items:center;gap:16px;margin:24px 0 8px 0;padding:0 8px}
        .missed-meeting-separator::before,.missed-meeting-separator::after{content:'';flex:1;height:2px;background:linear-gradient(90deg,transparent,#ef4444,transparent)}
        .missed-meeting-separator span{font-size:0.8125rem;font-weight:600;color:#ef4444;text-transform:uppercase;letter-spacing:0.5px;white-space:nowrap;display:flex;align-items:center;gap:8px}
        .missed-meeting-separator .missed-count{background:#ef4444;color:#fff !important;font-size:0.75rem;padding:2px 8px;border-radius:10px;font-weight:700}
        .missed-meeting-info{font-size:0.8125rem;color:rgba(255,255,255,0.5);text-align:center;margin-bottom:16px;padding:8px 16px;background:rgba(239,68,68,0.08);border-radius:8px}
        .priority-card-lg.missed-meeting{border-color:rgba(239,68,68,0.4);background:rgba(239,68,68,0.05)}
        .priority-card-lg.missed-meeting:hover{border-color:#ef4444}
        .priority-card-lg.missed-meeting .priority-card-lg-time-col{background:rgba(239,68,68,0.15)}
        .priority-card-lg.missed-meeting .priority-card-lg-time-col .time-value{color:#ef4444}
        .priority-card-lg.missed-meeting .missed-date{font-size:0.75rem;font-weight:500;opacity:0.8;margin-bottom:2px}
        .prio-indicator{display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;background:linear-gradient(135deg,#8B5CF6,#7C3AED);color:white;font-size:0.75rem;font-weight:700;border-radius:6px;margin-right:8px;flex-shrink:0}
        .prio-icon{width:20px;height:20px;position:absolute;top:6px;left:6px;border-radius:4px}
        .priority-card-lg-time-col{position:relative}
        .priority-card-lg-actions{display:grid;grid-template-columns:1fr 1fr;gap:8px;padding:12px;border-left:1px solid rgba(255,255,255,0.08);min-width:180px}
        .action-btn{padding:12px 8px;border:1px solid rgba(255,255,255,0.15);background:#111;border-radius:10px;cursor:pointer;font-size:0.75rem;transition:all 0.15s;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;color:rgba(255,255,255,0.7)}
        .action-btn .action-icon{font-size:1.125rem}
        .action-btn .action-label{font-size:0.6875rem;font-weight:500;white-space:nowrap}
        .action-btn:hover{transform:translateY(-2px);border-color:rgba(255,255,255,0.3);color:#fff}
        .action-btn.action-share:hover{background:rgba(59,130,246,0.2);border-color:#3B82F6}
        .action-btn.action-share.shared{background:rgba(52,211,153,0.15);border-color:rgba(52,211,153,0.3);color:rgb(52,211,153)}
        .action-btn.action-share.shared:hover{background:rgba(52,211,153,0.25);border-color:rgb(52,211,153)}
        .action-btn.action-ai:hover{background:rgba(52,211,153,0.2);border-color:rgb(52,211,153)}
        .action-btn.action-dnc:hover{background:rgba(239,68,68,0.2);border-color:#ef4444}
        .action-btn.action-reschedule:hover{background:rgba(245,158,11,0.2);border-color:#f59e0b}
        .priorities-cards:not(.list-view){display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:1rem}
        .priorities-cards:not(.list-view) .priority-card-lg{flex-direction:column;min-height:200px}
        .priorities-cards:not(.list-view) .priority-card-lg-left{flex:none;border-right:none;border-bottom:1px solid rgba(255,255,255,0.08)}
        .priorities-cards:not(.list-view) .priority-card-lg-time-col{flex:0 0 60px}
        .priorities-cards:not(.list-view) .priority-card-lg-summary-col,.priorities-cards:not(.list-view) .priority-card-lg-notes-col{flex:none;border-right:none;border-bottom:1px solid rgba(255,255,255,0.08)}
        .priorities-cards:not(.list-view) .priority-card-lg-actions{grid-template-columns:repeat(4,1fr);border-left:none;border-top:1px solid rgba(255,255,255,0.08);min-width:auto}
        .priorities-cards:not(.list-view) .missed-meeting-separator,.priorities-cards:not(.list-view) .missed-meeting-info{grid-column:1/-1}
        .section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem}
        .section-header h3{font-size:1.125rem;font-weight:600}
        .prio-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:1.5rem;flex-wrap:wrap;gap:1rem}
        .prio-filters{display:flex;gap:0.5rem;margin-bottom:1.25rem;flex-wrap:wrap}
        .prio-filter{padding:0.5rem 1rem;font-size:0.875rem;font-weight:500;color:rgba(255,255,255,0.7);background:#111;border:1px solid rgba(255,255,255,0.1);border-radius:8px;cursor:pointer}
        .prio-filter.active{background:rgb(52,211,153);border-color:rgb(52,211,153);color:#000}
        .prio-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:1rem;padding:0}
        .prio-card{background:#111;border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:0;cursor:pointer;transition:all 0.15s;display:flex;flex-direction:column;min-height:280px}
        .prio-card:hover{border-color:rgb(52,211,153);transform:translateY(-2px)}
        .prio-card-header{padding:16px 20px;border-bottom:1px solid rgba(255,255,255,0.08)}
        .prio-card-name{font-size:1rem;font-weight:600;margin-bottom:4px;display:flex;align-items:center;gap:8px}
        .prio-card-name .shared-icon{color:#3B82F6;font-size:0.875rem}
        .prio-card-meta{display:flex;gap:16px;font-size:0.8125rem;color:rgba(255,255,255,0.6)}
        .prio-card-phone{font-family:monospace}
        .prio-card-lastcall{display:flex;align-items:center;gap:6px}
        .prio-card-lastcall .lastcall-dot{width:8px;height:8px;border-radius:50%}
        .lastcall-green{background:#22c55e}
        .lastcall-yellow{background:#eab308}
        .lastcall-orange{background:#f97316}
        .lastcall-red{background:#ef4444}
        .prio-card-booked{margin-top:8px;font-size:0.8125rem}
        .prio-card-booked .booked-time{color:rgb(52,211,153);font-weight:600}
        .prio-card-booked .btn-schedule{font-size:0.75rem;padding:6px 12px;background:rgb(52,211,153);color:#000;border:none;border-radius:6px;cursor:pointer;font-weight:600}
        .prio-card-tabs{display:flex;border-bottom:1px solid rgba(255,255,255,0.08)}
        .prio-card-tab{flex:1;padding:10px 16px;font-size:0.75rem;font-weight:600;text-transform:uppercase;letter-spacing:0.05em;color:rgba(255,255,255,0.5);background:transparent;border:none;cursor:pointer;transition:all 0.15s;text-align:center}
        .prio-card-tab:first-child{border-right:1px solid rgba(255,255,255,0.08)}
        .prio-card-tab.active{color:rgb(52,211,153);background:rgba(52,211,153,0.05)}
        .prio-card-tab:hover:not(.active){color:rgba(255,255,255,0.8)}
        .prio-card-content{flex:1;padding:16px 20px;overflow:hidden;display:flex;flex-direction:column}
        .prio-card-panel{display:none;flex:1;overflow-y:auto}
        .prio-card-panel.active{display:block}
        .prio-card-summary{font-size:0.8125rem;line-height:1.6;color:rgba(255,255,255,0.7)}
        .prio-card-notes-list{display:flex;flex-direction:column;gap:8px}
        .prio-note-item{background:rgba(255,255,255,0.05);border-radius:6px;padding:10px 12px}
        .prio-note-text{font-size:0.8125rem;line-height:1.5;color:rgba(255,255,255,0.8)}
        .prio-note-date{font-size:0.6875rem;color:rgba(255,255,255,0.4);margin-top:6px}
        .prio-card-footer{padding:12px 20px;border-top:1px solid rgba(255,255,255,0.08);display:flex;justify-content:space-between;align-items:center;gap:8px}
        .prio-card-footer .btn-share{padding:6px 12px;background:rgba(59,130,246,0.15);border:1px solid rgba(59,130,246,0.3);color:#3B82F6;border-radius:6px;cursor:pointer;font-size:0.75rem;font-weight:600;transition:all 0.15s;display:flex;align-items:center;gap:6px}
        .prio-card-footer .btn-share:hover{background:#3B82F6;color:#fff}
        .prio-card-footer .btn-unprio{font-size:0.75rem;padding:6px 12px;background:rgba(239,68,68,0.15);color:#ef4444;border:1px solid rgba(239,68,68,0.3);border-radius:6px;cursor:pointer;font-weight:600;transition:all 0.15s}
        .prio-card-footer .btn-unprio:hover{background:#ef4444;color:#fff}
        @media(max-width:600px){.prio-list{grid-template-columns:1fr}.prio-card{min-height:260px}}
        
        /* Section count badge */
        .section-count{display:inline-flex;align-items:center;justify-content:center;min-width:24px;height:24px;padding:0 8px;background:rgb(52,211,153);color:#000;border-radius:12px;font-size:0.75rem;font-weight:700;margin-left:8px}
        .prio-stat-value{font-size:1.5rem;font-weight:700;color:rgb(52,211,153)}
        
        /* Lead Detail Modal */
        .lead-modal{max-width:900px;width:95%;max-height:90vh;overflow:hidden;display:flex;flex-direction:column;background:linear-gradient(180deg,#0f0f0f 0%,#0a0a0a 100%);border:1px solid rgba(255,255,255,0.08);box-shadow:0 25px 50px -12px rgba(0,0,0,0.8)}
        .lead-modal-header{display:flex;justify-content:space-between;align-items:flex-start;padding:24px 28px;border-bottom:1px solid rgba(255,255,255,0.08);background:rgba(255,255,255,0.02)}
        .modal-name-row{display:flex;align-items:center;gap:12px;margin-bottom:12px}
        .modal-prio-icon{width:28px;height:28px;border-radius:6px}
        .lead-modal-title h2{font-size:1.75rem;font-weight:700;margin:0}
        .lead-modal-actions{display:flex;gap:10px;flex-wrap:wrap}
        .btn-prio-toggle{padding:10px 16px;font-size:0.875rem;font-weight:600;background:rgba(245,158,11,0.15);color:#f59e0b;border:1px solid rgba(245,158,11,0.3);border-radius:8px;cursor:pointer;transition:all 0.2s}
        .btn-prio-toggle.active{background:#f59e0b;color:#000}
        .btn-prio-toggle:hover{background:rgba(245,158,11,0.25)}
        .btn-send-back{padding:10px 16px;font-size:0.875rem;font-weight:600;background:rgba(52,211,153,0.15);color:rgb(52,211,153);border:1px solid rgba(52,211,153,0.3);border-radius:8px;cursor:pointer;transition:all 0.2s}
        .btn-send-back:hover{background:rgba(52,211,153,0.25)}
        .btn-dnc{padding:10px 16px;font-size:0.875rem;font-weight:600;background:rgba(239,68,68,0.15);color:#ef4444;border:1px solid rgba(239,68,68,0.3);border-radius:8px;cursor:pointer;transition:all 0.2s}
        .btn-dnc:hover{background:rgba(239,68,68,0.25)}
        .notes-input-container{position:relative}
        .notes-action-row{display:flex;gap:10px;margin-top:12px;justify-content:center;align-items:center}
        .voice-input-btn{width:48px;height:48px;border-radius:12px;background:#1a1a1a;border:1px solid rgba(255,255,255,0.15);color:rgba(255,255,255,0.7);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.2s}
        .voice-input-btn:hover{background:rgba(52,211,153,0.15);border-color:rgb(52,211,153);color:rgb(52,211,153)}
        .voice-input-btn.recording{background:rgba(239,68,68,0.2);border-color:#ef4444;color:#ef4444;animation:pulse-recording 1.5s infinite}
        .voice-input-btn svg{width:22px;height:22px}
        @keyframes pulse-recording{0%,100%{opacity:1}50%{opacity:0.5}}
        .polish-notes-btn{padding:12px 20px;border-radius:12px;background:linear-gradient(135deg,#8B5CF6,#7C3AED);border:none;color:white;font-size:0.9375rem;font-weight:600;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;gap:8px}
        .polish-notes-btn:hover{opacity:0.9;transform:translateY(-1px)}
        .polish-notes-btn:disabled{opacity:0.5;cursor:not-allowed;transform:none}
        .notes-action-row .btn{padding:12px 20px;font-size:0.9375rem;border-radius:12px}
        .polish-preview-modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:1200;opacity:0;visibility:hidden;transition:all 0.2s}
        .polish-preview-modal.active{opacity:1;visibility:visible}
        .polish-preview-content{background:#111;border:1px solid rgba(255,255,255,0.1);border-radius:16px;padding:24px;max-width:600px;width:90%;max-height:80vh;overflow-y:auto}
        .polish-preview-content h3{margin-bottom:16px;display:flex;align-items:center;gap:8px;font-size:1.125rem}
        .polish-comparison{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px}
        .polish-box{background:#0a0a0a;border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:14px}
        .polish-box-label{font-size:0.75rem;color:rgba(255,255,255,0.5);margin-bottom:8px;font-weight:600;text-transform:uppercase}
        .polish-box-text{font-size:0.875rem;line-height:1.6;white-space:pre-wrap;color:rgba(255,255,255,0.85)}
        .polish-actions{display:flex;gap:12px}
        .polish-actions button{flex:1;padding:12px;border-radius:10px;font-weight:600;cursor:pointer;transition:all 0.2s;font-size:0.875rem}
        .polish-accept{background:rgb(52,211,153);border:none;color:#000}
        .polish-accept:hover{background:rgb(45,190,135)}
        .polish-reject{background:#1a1a1a;border:1px solid rgba(255,255,255,0.15);color:rgba(255,255,255,0.8)}
        .polish-reject:hover{border-color:rgba(255,255,255,0.3)}
        .send-ai-modal-overlay,.confirm-modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.85);display:flex;align-items:center;justify-content:center;z-index:1100;opacity:0;visibility:hidden;transition:all 0.2s}
        .send-ai-modal-overlay.active,.confirm-modal-overlay.active{opacity:1;visibility:visible}
        .confirm-modal{background:linear-gradient(180deg,#111 0%,#0a0a0a 100%);border:1px solid rgba(255,255,255,0.1);border-radius:16px;padding:28px;max-width:380px;width:90%;text-align:center}
        .confirm-modal-icon{font-size:2.5rem;margin-bottom:16px}
        .confirm-modal h3{font-size:1.125rem;font-weight:600;margin-bottom:12px}
        .confirm-modal p{color:rgba(255,255,255,0.6);font-size:0.9375rem;margin-bottom:24px;line-height:1.5}
        .confirm-modal-actions{display:flex;gap:12px}
        .confirm-modal-cancel{flex:1;padding:12px 20px;background:#1a1a1a;border:1px solid rgba(255,255,255,0.15);border-radius:10px;color:#fff;font-size:0.9375rem;font-weight:500;cursor:pointer;transition:all 0.15s}
        .confirm-modal-cancel:hover{background:#222;border-color:rgba(255,255,255,0.25)}
        .confirm-modal-confirm{flex:1;padding:12px 20px;background:#ef4444;border:none;border-radius:10px;color:#fff;font-size:0.9375rem;font-weight:600;cursor:pointer;transition:all 0.15s}
        .confirm-modal-confirm:hover{background:#dc2626}
        .confirm-modal-confirm.success{background:rgb(52,211,153)}
        .confirm-modal-confirm.success:hover{background:rgb(45,185,135)}
        .send-ai-modal{background:linear-gradient(180deg,#111 0%,#0a0a0a 100%);border:1px solid rgba(255,255,255,0.1);border-radius:20px;padding:28px;max-width:480px;width:90%;max-height:90vh;overflow-y:auto}
        .send-ai-modal h3{font-size:1.25rem;font-weight:600;margin-bottom:8px;display:flex;align-items:center;gap:10px}
        .send-ai-subtitle{color:rgba(255,255,255,0.6);font-size:0.9375rem;margin-bottom:24px}
        .send-ai-section{margin-bottom:24px}
        .send-ai-label{display:block;font-size:0.75rem;font-weight:600;color:rgba(255,255,255,0.5);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:12px}
        .send-ai-reasons{display:flex;flex-direction:column;gap:10px}
        .reason-btn{padding:14px 18px;background:#1a1a1a;border:1px solid rgba(255,255,255,0.1);border-radius:12px;color:rgba(255,255,255,0.9);font-size:0.9375rem;text-align:left;cursor:pointer;transition:all 0.15s;display:flex;align-items:center;gap:10px}
        .reason-btn:hover{border-color:rgba(255,255,255,0.25);background:#222}
        .reason-btn.active{border-color:rgb(52,211,153);background:rgba(52,211,153,0.1)}
        .send-ai-other-input{width:100%;margin-top:10px;padding:14px;background:#1a1a1a;border:1px solid rgba(255,255,255,0.1);border-radius:12px;color:#fff;font-size:0.9375rem;resize:none;min-height:80px}
        .send-ai-timing{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
        .timing-btn{padding:12px 16px;background:#1a1a1a;border:1px solid rgba(255,255,255,0.1);border-radius:10px;color:rgba(255,255,255,0.9);font-size:0.875rem;cursor:pointer;transition:all 0.15s}
        .timing-btn:hover{border-color:rgba(255,255,255,0.25);background:#222}
        .timing-btn.active{border-color:rgb(52,211,153);background:rgba(52,211,153,0.1)}
        .timing-btn:nth-child(5){grid-column:span 2}
        .send-ai-date-input{width:100%;margin-top:10px;padding:14px;background:#1a1a1a;border:1px solid rgba(255,255,255,0.1);border-radius:12px;color:#fff;font-size:0.9375rem}
        .send-ai-time-pref{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
        .time-pref-btn{padding:12px 16px;background:#1a1a1a;border:1px solid rgba(255,255,255,0.1);border-radius:10px;color:rgba(255,255,255,0.9);font-size:0.875rem;cursor:pointer;transition:all 0.15s}
        .time-pref-btn:hover{border-color:rgba(255,255,255,0.25);background:#222}
        .time-pref-btn.active{border-color:rgb(52,211,153);background:rgba(52,211,153,0.1)}
        .send-ai-actions{display:flex;gap:12px;margin-top:28px}
        .send-ai-cancel{flex:1;padding:14px;background:#1a1a1a;border:1px solid rgba(255,255,255,0.15);border-radius:12px;color:rgba(255,255,255,0.8);font-size:0.9375rem;font-weight:600;cursor:pointer;transition:all 0.15s}
        .send-ai-cancel:hover{border-color:rgba(255,255,255,0.3)}
        .send-ai-confirm{flex:1.5;padding:14px;background:rgb(52,211,153);border:none;border-radius:12px;color:#000;font-size:0.9375rem;font-weight:600;cursor:pointer;transition:all 0.15s}
        .send-ai-confirm:hover{background:rgb(45,190,135)}
        .send-ai-confirm:disabled{opacity:0.5;cursor:not-allowed}
        @media(max-width:600px){.polish-comparison{grid-template-columns:1fr}}
        .lead-modal-body{padding:24px;overflow-y:auto;flex:1}
        .lead-info-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:16px;margin-bottom:24px}
        .lead-info-item{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);border-radius:12px;padding:16px}
        .lead-info-item label{display:block;font-size:0.8125rem;color:rgba(255,255,255,0.5);margin-bottom:8px}
        .lead-info-item .value{font-size:1.125rem;font-weight:600}
        .send-ai-calendar{margin-top:16px;background:#1a1a1a;border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:16px}
        .lead-section{margin-bottom:20px;padding:18px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.06);border-radius:14px}
        .lead-section h3{font-size:0.875rem;font-weight:600;margin-bottom:14px;display:flex;align-items:center;gap:8px;color:rgba(255,255,255,0.9)}
        .lead-summary-content{font-size:0.875rem;line-height:1.6;color:rgba(255,255,255,0.8);white-space:pre-wrap}
        .lead-notes-list{max-height:150px;overflow-y:auto;margin-bottom:12px}
        .lead-note-item{padding:10px 12px;background:rgba(255,255,255,0.05);border-radius:6px;margin-bottom:8px;font-size:0.8125rem;position:relative}
        .lead-note-item:last-child{margin-bottom:0}
        .lead-note-item .note-content{margin-bottom:4px}
        .lead-note-item .note-date{font-size:0.75rem;color:rgba(255,255,255,0.4)}
        .lead-note-item .note-actions{position:absolute;bottom:8px;right:8px;display:flex;gap:4px;opacity:0;transition:opacity 0.15s}
        .lead-note-item:hover .note-actions{opacity:1}
        .lead-note-item .note-edit-input{width:100%;min-height:60px;padding:8px;background:#0a0a0a;border:1px solid rgba(52,211,153,0.5);border-radius:6px;color:#fff;font-size:0.8125rem;resize:vertical;margin-bottom:8px}
        .lead-note-item .note-edit-actions{display:flex;gap:8px;justify-content:flex-end}
        .lead-note-item .note-edit-actions button{padding:6px 12px;border-radius:6px;font-size:0.75rem;font-weight:600;cursor:pointer}
        .lead-note-item .btn-note-save{background:rgb(52,211,153);border:none;color:#000}
        .lead-note-item .btn-note-cancel{background:#333;border:1px solid rgba(255,255,255,0.2);color:#fff}
        .lead-note-date{font-size:0.6875rem;color:rgba(255,255,255,0.4);margin-top:4px}
        #modalNotesInput{width:100%;min-height:80px;padding:12px;background:#0a0a0a;border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:#fff;font-size:0.875rem;resize:vertical;margin-bottom:8px}
        .lead-notes-actions{display:flex;justify-content:flex-end}
        .attempts-count{background:rgba(255,255,255,0.1);padding:2px 8px;border-radius:10px;font-size:0.75rem;font-weight:500}
        .lead-attempts-list{max-height:120px;overflow-y:auto}
        .lead-attempt-item{padding:8px 12px;background:rgba(255,255,255,0.05);border-radius:6px;margin-bottom:6px;font-size:0.8125rem;display:flex;justify-content:space-between}
        .lead-transcript{font-size:0.8125rem;line-height:1.7;color:rgba(255,255,255,0.7);max-height:200px;overflow-y:auto;white-space:pre-wrap}
        .lead-transcript .speaker-ai{color:#fff;font-weight:600}
        .lead-transcript .speaker-prospect{color:rgb(52,211,153);font-weight:600}
        .lead-transcript-line{margin-bottom:8px}
        
        /* Share Button */
        .btn-share{padding:10px 16px;font-size:0.875rem;font-weight:600;background:rgba(59,130,246,0.15);color:#3b82f6;border:1px solid rgba(59,130,246,0.3);border-radius:8px;cursor:pointer;transition:all 0.2s;display:inline-flex;align-items:center;gap:6px}
        .btn-share:hover{background:rgba(59,130,246,0.25)}
        .btn-share.shared{background:rgba(52,211,153,0.15);color:rgb(52,211,153);border-color:rgba(52,211,153,0.3)}
        
        /* Schedule Button */
        .btn-schedule{padding:6px 12px;font-size:0.75rem;font-weight:600;background:rgba(52,211,153,0.15);color:rgb(52,211,153);border:1px solid rgba(52,211,153,0.3);border-radius:6px;cursor:pointer;transition:all 0.2s;display:inline-flex;align-items:center;gap:4px}
        .btn-schedule:hover{background:rgba(52,211,153,0.25)}
        
        /* Booked Time Display */
        .booked-time-display{display:flex;align-items:center;gap:8px}
        .booked-time-value{font-weight:500}
        .btn-delete-booking,.btn-delete-attempt,.btn-delete-note{background:none;border:none;color:rgba(239,68,68,0.7);cursor:pointer;font-size:0.875rem;padding:2px 6px;border-radius:4px;transition:all 0.15s}
        .btn-delete-booking:hover,.btn-delete-attempt:hover,.btn-delete-note:hover{color:#ef4444;background:rgba(239,68,68,0.1)}
        .btn-edit-booking{background:none;border:none;color:rgba(59,130,246,0.7);cursor:pointer;font-size:0.875rem;padding:2px 6px;border-radius:4px;transition:all 0.15s}
        .btn-edit-booking:hover{color:#3b82f6;background:rgba(59,130,246,0.1)}
        .btn-edit-note{background:none;border:none;color:rgba(59,130,246,0.7);cursor:pointer;font-size:0.875rem;padding:2px 6px;border-radius:4px;transition:all 0.15s}
        .btn-edit-note:hover{color:#3b82f6;background:rgba(59,130,246,0.1)}
        
        /* Share Popup */
        .share-popup-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);z-index:1999;display:none}
        .share-popup-overlay.active{display:block}
        .share-popup{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#1a1a1a;border:1px solid rgba(255,255,255,0.1);border-radius:16px;padding:24px;min-width:320px;max-width:380px;box-shadow:0 16px 48px rgba(0,0,0,0.5);z-index:2000;display:none}
        .share-popup.active{display:block}
        .share-popup-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
        .share-popup-header h4{font-size:1.125rem;font-weight:600}
        .share-popup-close{background:none;border:none;color:rgba(255,255,255,0.5);cursor:pointer;font-size:1.5rem;padding:0;line-height:1}
        .share-popup-close:hover{color:#fff}
        .share-popup-agents{display:flex;flex-direction:column;gap:8px;margin-bottom:16px;max-height:280px;overflow-y:auto}
        .share-agent-option{display:flex;align-items:center;gap:10px;padding:12px 14px;background:#111;border:1px solid rgba(255,255,255,0.1);border-radius:10px;cursor:pointer;transition:all 0.2s}
        .share-agent-option:hover{border-color:rgb(52,211,153);background:rgba(52,211,153,0.05)}
        .share-agent-option.selected{border-color:rgb(52,211,153);background:rgba(52,211,153,0.1)}
        .share-agent-option input{display:none}
        .share-agent-radio{width:18px;height:18px;border:2px solid rgba(255,255,255,0.2);border-radius:50%;display:flex;align-items:center;justify-content:center;transition:all 0.2s;flex-shrink:0}
        .share-agent-option.selected .share-agent-radio{border-color:rgb(52,211,153)}
        .share-agent-option.selected .share-agent-radio::after{content:'';width:10px;height:10px;background:rgb(52,211,153);border-radius:50%}
        .share-agent-name{font-weight:500;font-size:0.9375rem}
        .share-popup-actions{display:flex;gap:10px}
        .share-popup-actions button{flex:1;padding:12px;border-radius:10px;font-size:0.875rem;font-weight:500;cursor:pointer;transition:all 0.2s}
        .btn-share-confirm{background:rgb(52,211,153);border:none;color:#000}
        .btn-share-confirm:hover{opacity:0.9}
        .btn-share-confirm:disabled{opacity:0.5;cursor:not-allowed}
        .btn-share-cancel{background:#222;border:1px solid rgba(255,255,255,0.1);color:#fff}
        .btn-share-cancel:hover{background:#2a2a2a}
        .share-info-content{padding:4px 0}
        .share-info-label{font-size:0.75rem;color:rgba(255,255,255,0.5);margin-bottom:4px;text-transform:uppercase;letter-spacing:0.5px}
        .share-info-name{font-size:0.9375rem;font-weight:500;color:#fff;padding:8px 12px;background:#111;border-radius:8px;margin-bottom:12px}
        
        /* Schedule Modal */
        .schedule-modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:1100;opacity:0;visibility:hidden;transition:all 0.2s}
        .schedule-modal-overlay.active{opacity:1;visibility:visible}
        .schedule-modal{background:#1a1a1a;border:1px solid rgba(255,255,255,0.1);border-radius:16px;padding:24px;max-width:420px;width:90%;max-height:90vh;overflow-y:auto}
        .schedule-modal h3{margin-bottom:8px;font-size:1.25rem}
        .schedule-modal .form-group{margin-bottom:16px}
        .schedule-modal label{display:block;margin-bottom:8px;font-size:0.875rem;color:rgba(255,255,255,0.7);font-weight:500}
        .schedule-modal-actions{display:flex;gap:12px;margin-top:20px}
        .schedule-modal-actions button{flex:1;padding:12px;border-radius:8px;font-weight:500;cursor:pointer;transition:all 0.2s}
        .schedule-modal .btn-cancel{background:#222;border:1px solid rgba(255,255,255,0.1);color:#fff}
        .schedule-modal .btn-save{background:rgb(52,211,153);border:none;color:#000}
        .schedule-modal .btn-save:hover{opacity:0.9}
        
        /* Calendar Picker */
        .calendar-picker{background:#111;border-radius:12px;padding:16px;border:1px solid rgba(255,255,255,0.1)}
        .calendar-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
        .calendar-header button{background:none;border:none;color:#fff;cursor:pointer;padding:8px;border-radius:6px;font-size:1.25rem}
        .calendar-header button:hover{background:rgba(255,255,255,0.1)}
        .calendar-month{font-weight:600;font-size:1rem}
        .calendar-weekdays{display:grid;grid-template-columns:repeat(7,1fr);text-align:center;margin-bottom:8px}
        .calendar-weekdays span{font-size:0.75rem;color:rgba(255,255,255,0.5);font-weight:500;padding:8px 0}
        .calendar-days{display:grid;grid-template-columns:repeat(7,1fr);gap:4px}
        .calendar-day{aspect-ratio:1;display:flex;align-items:center;justify-content:center;border-radius:8px;cursor:pointer;font-size:0.875rem;transition:all 0.15s;border:none;background:none;color:#fff}
        .calendar-day:hover:not(.disabled):not(.selected){background:rgba(255,255,255,0.1)}
        .calendar-day.selected{background:rgb(52,211,153);color:#000;font-weight:600}
        .calendar-day.today:not(.selected){border:2px solid rgb(52,211,153)}
        .calendar-day.disabled{color:rgba(255,255,255,0.3);cursor:not-allowed}
        .calendar-day.other-month{opacity:0.3}
        .calendar-day.past{color:rgba(255,255,255,0.3);cursor:not-allowed}
        .calendar-day.empty{cursor:default}
        @media(max-width:640px){.lead-info-grid{grid-template-columns:1fr}}
        .spinner{width:32px;height:32px;border:3px solid rgba(255,255,255,0.1);border-top-color:rgb(52,211,153);border-radius:50%;animation:spin 0.8s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
        .overview-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:1rem;margin-bottom:2rem}
        @media(min-width:768px){.overview-grid{grid-template-columns:repeat(4,1fr)}}
        .overview-card{background:#111;border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:1.25rem;cursor:pointer;transition:all 0.15s}
        .overview-card:hover{border-color:rgb(52,211,153);transform:translateY(-2px)}
        .overview-card.highlight{background:rgba(52,211,153,0.1);border-color:rgb(52,211,153)}
        .overview-card-header{display:flex;align-items:center;gap:0.5rem;margin-bottom:0.75rem}
        .overview-card-header h4{font-size:0.875rem;font-weight:600;color:rgba(255,255,255,0.8)}
        .overview-card-icon{font-size:1rem}
        .overview-card-value{font-size:2rem;font-weight:700;margin-bottom:0.25rem}
        .overview-card-desc{font-size:0.75rem;color:rgba(255,255,255,0.5)}
        .meetings-list{display:flex;flex-direction:column;gap:0.5rem}
        .meetings-empty{text-align:center;padding:2rem;color:rgba(255,255,255,0.5);background:#111;border-radius:12px}
        .welcome-meta{display:flex;gap:16px;align-items:center;flex-wrap:wrap}
        .welcome-phone,.welcome-usage{background:#111;padding:8px 14px;border-radius:8px;font-size:0.8125rem;display:flex;align-items:center;gap:8px}
        .phone-label,.usage-label{color:rgba(255,255,255,0.5)}
        .phone-value{color:rgb(52,211,153);font-weight:600;font-family:monospace}
        .usage-value{font-weight:600}
        .priorities-list{display:flex;flex-direction:column;gap:10px}
        .priorities-empty{text-align:center;padding:40px;color:rgba(255,255,255,0.4);background:#111;border-radius:12px}
        .priority-card{background:#111;border:1px solid rgba(255,255,255,0.1);border-radius:10px;padding:16px 20px;display:grid;grid-template-columns:auto 1fr auto auto;gap:16px;align-items:center;cursor:pointer;transition:all 0.15s}
        .priority-card:hover{border-color:rgb(52,211,153);background:#151515}
        .priority-time{background:rgba(52,211,153,0.15);color:rgb(52,211,153);padding:8px 12px;border-radius:8px;font-weight:600;font-size:0.875rem;text-align:center;min-width:80px}
        .priority-info{min-width:0}
        .priority-name{font-weight:600;margin-bottom:2px}
        .priority-details{font-size:0.8125rem;color:rgba(255,255,255,0.5)}
        .priority-type{font-size:0.6875rem;padding:4px 10px;border-radius:4px;font-weight:600;text-transform:uppercase}
        .priority-type.booked{background:rgba(52,211,153,0.15);color:rgb(52,211,153)}
        .priority-type.callback{background:rgba(245,158,11,0.15);color:#f59e0b}
        .priority-arrow{color:rgba(255,255,255,0.3);font-size:1.25rem}
        .meeting-card{background:#111;border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:1rem;display:flex;align-items:center;gap:1rem}
        .meeting-time{background:rgba(52,211,153,0.15);color:rgb(52,211,153);padding:0.5rem 0.75rem;border-radius:8px;font-weight:600;font-size:0.875rem}
        .meeting-info{flex:1}
        .meeting-name{font-weight:600;margin-bottom:0.25rem}
        .meeting-details{font-size:0.875rem;color:rgba(255,255,255,0.6)}
        .prio-empty{text-align:center;padding:3rem;color:rgba(255,255,255,0.5)}
        
        /* Profile Menu */
        .profile-menu{position:absolute;bottom:100%;left:0;right:0;background:#151515;border:1px solid rgba(255,255,255,0.1);border-radius:12px;margin:0 0.5rem 0.5rem;padding:0.5rem;opacity:0;visibility:hidden;transform:translateY(10px);transition:all 0.2s}
        .profile-menu.active{opacity:1;visibility:visible;transform:translateY(0)}
        .profile-menu-item{display:flex;align-items:center;gap:0.75rem;padding:0.75rem 1rem;border-radius:8px;cursor:pointer;font-size:0.875rem;color:rgba(255,255,255,0.8);transition:all 0.15s}
        .profile-menu-item:hover{background:rgba(255,255,255,0.05)}
        .profile-menu-item.logout{color:#ef4444}
        .profile-menu-item.logout:hover{background:rgba(239,68,68,0.1)}
        .profile-menu-divider{height:1px;background:rgba(255,255,255,0.1);margin:0.5rem 0}
        
        /* Notifications Popup */
        .notifications-popup{position:absolute;bottom:100%;left:0;width:280px;background:#151515;border:1px solid rgba(255,255,255,0.1);border-radius:12px;margin-bottom:0.5rem;opacity:0;visibility:hidden;transform:translateY(10px);transition:all 0.2s;z-index:1000}
        .notifications-popup.active{opacity:1;visibility:visible;transform:translateY(0)}
        .notifications-header{padding:1rem;border-bottom:1px solid rgba(255,255,255,0.1);font-weight:600;font-size:0.875rem}
        .notifications-empty{padding:2rem;text-align:center;color:rgba(255,255,255,0.5);font-size:0.875rem}
        
        .sidebar-footer{position:relative}
        
        /* Settings Page */
        .settings-card{background:#111;border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:1.5rem;margin-bottom:1rem}
        .settings-card.danger{border-color:rgba(239,68,68,0.3)}
        .settings-title{font-size:1rem;font-weight:600;margin-bottom:1rem}
        .profile-header{display:flex;align-items:center;gap:1.5rem;flex-wrap:wrap}
        .profile-avatar-lg{width:80px;height:80px;border-radius:50%;background:rgb(52,211,153);display:flex;align-items:center;justify-content:center;font-size:2rem;font-weight:600;color:#000;overflow:hidden;flex-shrink:0}
        .profile-avatar-lg img{width:100%;height:100%;object-fit:cover}
        .profile-info h2{font-size:1.25rem;margin-bottom:0.25rem}
        .profile-info p{color:rgba(255,255,255,0.6);font-size:0.875rem;margin-bottom:0.75rem}
        .profile-actions{display:flex;gap:0.5rem}
        .form-row{display:grid;grid-template-columns:1fr;gap:1rem;margin-bottom:1rem}
        @media(min-width:640px){.form-row{grid-template-columns:repeat(2,1fr)}}
        .form-group{margin-bottom:1rem}
        .form-group:last-child{margin-bottom:0}
        .form-group label{display:block;font-size:0.875rem;font-weight:500;color:rgba(255,255,255,0.7);margin-bottom:0.5rem}
        .form-group input,.form-group select{width:100%;padding:0.75rem 1rem;background:#1a1a1a;border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:#fff;font-size:0.9375rem}
        .form-group input:focus,.form-group select:focus{outline:none;border-color:rgb(52,211,153)}
        .form-group input::placeholder{color:rgba(255,255,255,0.4)}
        .form-message{font-size:0.875rem;padding:0.75rem;border-radius:8px;margin-bottom:1rem;display:none}
        .form-message:not(:empty){display:block}
        .form-message.success{background:rgba(52,211,153,0.1);color:rgb(52,211,153);border:1px solid rgba(52,211,153,0.3)}
        .form-message.error{background:rgba(239,68,68,0.1);color:#ef4444;border:1px solid rgba(239,68,68,0.3)}
        
        /* Synced Input Styles */
        .sync-badge{font-size:0.625rem;background:rgba(52,211,153,0.15);color:rgb(52,211,153);padding:2px 6px;border-radius:4px;margin-left:8px}
        .input-synced{background:#0a0a0a !important;color:rgba(255,255,255,0.5) !important;cursor:not-allowed}
        .sync-notice{font-size:0.75rem;color:rgba(255,255,255,0.4);margin:8px 0 16px;padding:10px 12px;background:rgba(52,211,153,0.05);border-radius:6px;border-left:3px solid rgb(52,211,153)}
        
        /* Billing Styles */
        .billing-plan-card{background:#0a0a0a;border-radius:10px;padding:20px}
        .billing-plan-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:12px}
        .billing-plan-info{display:flex;align-items:center;gap:12px}
        .billing-plan-name{font-size:1.25rem;font-weight:600;color:rgb(52,211,153)}
        .billing-status-badge{padding:4px 10px;border-radius:6px;font-size:0.75rem;font-weight:500}
        .billing-status-badge.active{background:rgba(52,211,153,0.15);color:rgb(52,211,153)}
        .billing-status-badge.paused{background:rgba(245,158,11,0.15);color:#f59e0b}
        .billing-plan-price{display:flex;align-items:baseline;gap:2px}
        .price-amount{font-size:1.5rem;font-weight:700}
        .price-period{font-size:0.875rem;color:rgba(255,255,255,0.5)}
        .billing-plan-details{display:flex;gap:24px;margin-bottom:16px;flex-wrap:wrap}
        .billing-detail{display:flex;flex-direction:column;gap:4px}
        .detail-label{font-size:0.75rem;color:rgba(255,255,255,0.4)}
        .detail-value{font-size:0.9rem;font-weight:500}
        .billing-payment-card{display:flex;align-items:center;gap:16px;background:#0a0a0a;border-radius:10px;padding:16px 20px}
        .payment-icon{font-size:1.5rem}
        .payment-details{flex:1}
        .payment-brand{font-weight:600;font-size:0.9rem;display:block}
        .payment-number{font-size:0.8rem;color:rgba(255,255,255,0.5)}
        .billing-usage{background:#0a0a0a;border-radius:10px;padding:20px}
        .usage-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:12px;text-align:center}
        .usage-value{font-size:1.5rem;font-weight:700;display:block}
        .usage-label{font-size:0.75rem;color:rgba(255,255,255,0.4)}
        .usage-bar{height:8px;background:#1a1a1a;border-radius:4px;overflow:hidden}
        .usage-fill{height:100%;background:linear-gradient(90deg,rgb(52,211,153),#8B5CF6);border-radius:4px;transition:width 0.3s}
        .billing-history{max-height:200px;overflow-y:auto}
        .billing-actions{display:flex;gap:12px;flex-wrap:wrap}
        
        /* Help Styles */
        .help-search{position:relative;margin-bottom:20px}
        .help-search input{width:100%;padding:12px 16px 12px 44px;background:#0a0a0a;border:1px solid rgba(255,255,255,0.1);border-radius:10px;color:#fff;font-size:0.9375rem}
        .help-search input:focus{outline:none;border-color:rgb(52,211,153)}
        .help-search-icon{position:absolute;left:16px;top:50%;transform:translateY(-50%);opacity:0.5}
        .help-quick-links{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;margin-bottom:24px}
        .help-quick-link{padding:12px;background:#0a0a0a;border:1px solid rgba(255,255,255,0.1);border-radius:8px;text-align:center;font-size:0.8125rem;cursor:pointer;transition:all 0.2s}
        .help-quick-link:hover{border-color:rgb(52,211,153);background:rgba(52,211,153,0.05)}
        .help-category{background:#111;border:1px solid rgba(255,255,255,0.1);border-radius:10px;margin-bottom:12px;overflow:hidden}
        .help-category-header{display:flex;align-items:center;gap:12px;padding:16px;cursor:pointer;transition:background 0.2s}
        .help-category-header:hover{background:rgba(255,255,255,0.03)}
        .help-category-icon{font-size:1.25rem}
        .help-category-title{flex:1;font-weight:600}
        .help-category-arrow{color:rgba(255,255,255,0.4);transition:transform 0.2s}
        .help-category.open .help-category-arrow{transform:rotate(180deg)}
        .help-category-content{display:none;border-top:1px solid rgba(255,255,255,0.1)}
        .help-category.open .help-category-content{display:block}
        .help-item{border-bottom:1px solid rgba(255,255,255,0.05)}
        .help-item:last-child{border-bottom:none}
        .help-item-header{display:flex;align-items:center;gap:12px;padding:14px 16px;cursor:pointer}
        .help-item-header:hover{background:rgba(52,211,153,0.03)}
        .help-question{flex:1;font-size:0.9rem}
        .help-toggle{color:rgb(52,211,153);font-size:1.25rem}
        .help-item.open .help-toggle{transform:rotate(45deg)}
        .help-answer{display:none;padding:0 16px 16px;color:rgba(255,255,255,0.7);font-size:0.875rem;line-height:1.6}
        .help-item.open .help-answer{display:block}
        .help-answer ul{margin:8px 0 8px 20px}
        .help-answer li{margin-bottom:6px}
        .help-support{display:flex;align-items:center;gap:16px;margin-bottom:16px}
        .help-support-icon{font-size:2rem}
        .help-support h4{margin-bottom:4px}
        .help-support-actions{display:flex;gap:12px;flex-wrap:wrap}
        
        @media(max-width:640px){
            .usage-stats{grid-template-columns:1fr}
            .billing-plan-details{flex-direction:column;gap:12px}
            .billing-actions{flex-direction:column}
            .billing-actions .btn{width:100%}
            .help-support-actions{flex-direction:column}
            .help-support-actions .btn{width:100%}
        }
        
        /* Filters Bar */
        .filters-bar{display:flex;gap:1rem;margin-bottom:1.5rem;flex-wrap:wrap;align-items:center}
        .search-box{position:relative;flex:1;min-width:200px;max-width:300px}
        .search-box input{width:100%;padding:10px 16px 10px 40px;background:#111;border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:#fff;font-size:0.875rem}
        .search-box input:focus{outline:none;border-color:rgb(52,211,153)}
        .search-box .search-icon{position:absolute;left:12px;top:50%;transform:translateY(-50%);opacity:0.5}
        .filter-group{display:flex;gap:0.5rem;flex-wrap:wrap}
        .filter-select{padding:10px 16px;background:#111;border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:#fff;font-size:0.875rem;min-width:140px;cursor:pointer}
        .filter-select:focus{outline:none;border-color:rgb(52,211,153)}
        
        /* Data Table */
        .table-container{background:#111;border:1px solid rgba(255,255,255,0.1);border-radius:12px;overflow:hidden}
        .data-table{width:100%;border-collapse:collapse}
        .data-table th{text-align:left;padding:12px 16px;font-size:0.75rem;text-transform:uppercase;letter-spacing:0.05em;color:rgba(255,255,255,0.5);background:#0a0a0a;border-bottom:1px solid rgba(255,255,255,0.1);font-weight:600}
        .data-table th.sortable{cursor:pointer}
        .data-table th.sortable:hover{color:rgb(52,211,153)}
        .data-table th.sorted-asc::after{content:" ";color:rgb(52,211,153)}
        .data-table th.sorted-desc::after{content:" ";color:rgb(52,211,153)}
        .data-table td{padding:14px 16px;border-bottom:1px solid rgba(255,255,255,0.05);font-size:0.875rem;vertical-align:middle}
        .data-table tr:hover td{background:rgba(255,255,255,0.02)}
        .data-table tr:last-child td{border-bottom:none}
        .data-table .empty-state{text-align:center;padding:40px;color:rgba(255,255,255,0.4)}
        
        /* Status Badges */
        .status-badge{display:inline-block;padding:4px 10px;border-radius:6px;font-size:0.75rem;font-weight:600}
        .status-badge.booked,.status-badge.meeting-booked{background:rgba(52,211,153,0.15);color:rgb(52,211,153)}
        .status-badge.callback{background:rgba(59,130,246,0.15);color:#3B82F6}
        .status-badge.timeline{background:rgba(245,158,11,0.15);color:#f59e0b}
        .status-badge.follow-up{background:rgba(139,92,246,0.15);color:#8B5CF6}
        .status-badge.interested{background:rgba(52,211,153,0.1);color:rgb(52,211,153)}
        .status-badge.not-interested{background:rgba(239,68,68,0.1);color:#ef4444}
        
        /* Prospects Header */
        .prospects-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:1.5rem;flex-wrap:wrap;gap:1rem}
        .prospects-header-text h2{font-size:1.5rem;font-weight:700;margin-bottom:0.5rem}
        .prospects-header-text p{color:rgba(255,255,255,0.5);font-size:0.9rem}
        
        /* Pipeline Styles */
        .pipeline-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:1.5rem;flex-wrap:wrap;gap:1rem}
        .pipeline-header-text h2{font-size:1.5rem;font-weight:700;margin-bottom:0.5rem}
        .pipeline-header-text p{color:rgba(255,255,255,0.5);font-size:0.9rem}
        .pipeline-stats{display:flex;gap:1.5rem}
        .pipeline-stat{text-align:center}
        .pipeline-stat-value{display:block;font-size:1.75rem;font-weight:700;color:rgb(52,211,153)}
        .pipeline-stat-label{font-size:0.75rem;color:rgba(255,255,255,0.5);text-transform:uppercase}
        .pipeline-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:1rem}
        .pipeline-empty{text-align:center;padding:40px;color:rgba(255,255,255,0.4);background:#111;border-radius:12px}
        
        /* Pipeline Card */
        .pipeline-card{background:#111;border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:20px;cursor:pointer;transition:all 0.15s}
        .pipeline-card:hover{border-color:rgb(52,211,153);transform:translateY(-2px)}
        .pipeline-card-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px}
        .pipeline-card-name{font-size:1rem;font-weight:600}
        .pipeline-card-phone{font-size:0.8125rem;color:rgba(255,255,255,0.5);font-family:monospace}
        .pipeline-card-status{margin-bottom:12px}
        .pipeline-card-nextcall{display:flex;align-items:center;gap:8px;font-size:0.875rem;color:rgba(255,255,255,0.7)}
        .pipeline-card-nextcall .date{color:rgb(52,211,153);font-weight:600}
        .pipeline-card-summary{font-size:0.8125rem;line-height:1.5;color:rgba(255,255,255,0.6);margin-top:12px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
        
        /* Table Actions */
        .table-actions{display:flex;gap:6px}
        .table-action-btn{padding:6px 10px;border-radius:6px;border:none;cursor:pointer;font-size:0.75rem;font-weight:500;transition:all 0.15s}
        .table-action-btn.view{background:rgba(52,211,153,0.15);color:rgb(52,211,153)}
        .table-action-btn.view:hover{background:rgb(52,211,153);color:#000}
        .table-action-btn.prio{background:rgba(245,158,11,0.15);color:#f59e0b}
        .table-action-btn.prio:hover{background:#f59e0b;color:#000}
        .table-action-btn.share{background:rgba(59,130,246,0.15);color:#3B82F6}
        .table-action-btn.share:hover{background:#3B82F6;color:#fff}
        
        /* Sharing indicator */
        .sharing-indicator{display:flex;align-items:center;gap:4px;font-size:0.8125rem}
        .sharing-indicator.shared{color:#3B82F6}
        .sharing-indicator.not-shared{color:rgba(255,255,255,0.3)}
        
        /* Summary cell */
        .summary-cell{max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-size:0.8125rem;color:rgba(255,255,255,0.7)}
        .notes-cell{max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-size:0.8125rem;color:rgba(255,255,255,0.6)}
        
        /* Prio empty state */
        .prio-empty{text-align:center;padding:40px;color:rgba(255,255,255,0.4);background:#111;border-radius:12px;grid-column:1/-1}
        
        /* Page Loading State */
        .page-loading{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:60px 20px;background:#111;border-radius:12px;grid-column:1/-1}
        .page-loading .spinner{width:40px;height:40px;border:3px solid rgba(255,255,255,0.1);border-top-color:rgb(52,211,153);border-radius:50%;animation:spin 0.8s linear infinite}
        .page-loading p{margin-top:16px;color:rgba(255,255,255,0.5);font-size:0.875rem}
        @keyframes spin{to{transform:rotate(360deg)}}
        
        /* Analytics Page */
        .analytics-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:24px;flex-wrap:wrap;gap:16px}
        .analytics-header h2{font-size:1.5rem;font-weight:700;margin-bottom:4px}
        .analytics-period-tabs{display:flex;gap:4px;background:#111;padding:4px;border-radius:8px}
        .analytics-period-tab{background:none;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:0.875rem;color:rgba(255,255,255,0.6);transition:all 0.2s}
        .analytics-period-tab:hover{color:#fff}
        .analytics-period-tab.active{background:rgb(52,211,153);color:#000}
        .analytics-date-picker{margin-bottom:24px}
        .date-picker-input{background:#111;border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:12px 16px;color:#fff;font-size:0.9375rem}
        .analytics-key-metrics{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:32px}
        @media(max-width:768px){.analytics-key-metrics{grid-template-columns:1fr}}
        .analytics-metric-card{background:#111;border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:24px;text-align:center}
        .analytics-metric-card.accent{background:rgba(52,211,153,0.1);border-color:rgb(52,211,153)}
        .analytics-metric-card.success{background:rgba(34,197,94,0.1);border-color:#22c55e}
        .metric-value{font-size:2.5rem;font-weight:700;margin-bottom:4px}
        .analytics-metric-card.accent .metric-value{color:rgb(52,211,153)}
        .analytics-metric-card.success .metric-value{color:#22c55e}
        .metric-label{font-size:0.75rem;text-transform:uppercase;color:rgba(255,255,255,0.5)}
        .analytics-section{margin-bottom:32px}
        .analytics-section-title{font-size:0.75rem;text-transform:uppercase;letter-spacing:0.05em;color:rgba(255,255,255,0.5);margin-bottom:16px}
        .analytics-breakdown-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
        @media(max-width:768px){.analytics-breakdown-grid{grid-template-columns:repeat(2,1fr)}}
        .breakdown-card{border-radius:8px;padding:20px;text-align:center}
        .breakdown-card.booked{background:#14532d}
        .breakdown-card.callback{background:#172554}
        .breakdown-card.interested{background:rgba(59,130,246,0.15)}
        .breakdown-card.timeline{background:#451a03}
        .breakdown-value{font-size:1.75rem;font-weight:700}
        .breakdown-card.booked .breakdown-value,.breakdown-card.booked .breakdown-label{color:#22c55e}
        .breakdown-card.callback .breakdown-value,.breakdown-card.callback .breakdown-label{color:#3B82F6}
        .breakdown-card.interested .breakdown-value,.breakdown-card.interested .breakdown-label{color:#3B82F6}
        .breakdown-card.timeline .breakdown-value,.breakdown-card.timeline .breakdown-label{color:#f59e0b}
        .breakdown-label{font-size:0.75rem;margin-top:4px}
        .analytics-outcomes-grid{display:flex;flex-wrap:wrap;gap:8px}
        .outcome-pill{background:#1a1a1a;border:1px solid rgba(255,255,255,0.1);border-radius:20px;padding:8px 16px;font-size:0.875rem;color:rgba(255,255,255,0.7)}
        .outcome-count{font-weight:600;margin-right:4px}
        .analytics-table-container.booked-table{background:#14532d;border-color:#166534}
        .analytics-table-container.booked-table th{background:#166534;color:#22c55e}
        
        /* Import Page */
        .import-header{margin-bottom:24px}
        .import-header h2{font-size:1.5rem;font-weight:700;margin-bottom:4px}
        .import-tabs{display:flex;gap:8px;margin-bottom:24px}
        .import-tab{background:#111;border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:12px 24px;font-size:0.9375rem;color:rgba(255,255,255,0.7);cursor:pointer;transition:all 0.2s}
        .import-tab:hover{border-color:rgb(52,211,153)}
        .import-tab.active{background:rgb(52,211,153);border-color:rgb(52,211,153);color:#000}
        .import-panel{display:none}
        .import-panel.active{display:block}
        .import-form-card{background:#111;border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:24px;max-width:600px}
        .form-row{display:grid;grid-template-columns:repeat(2,1fr);gap:16px}
        @media(max-width:600px){.form-row{grid-template-columns:1fr}}
        .form-group{margin-bottom:16px}
        .form-group label{display:block;font-size:0.875rem;margin-bottom:6px;color:rgba(255,255,255,0.8)}
        .form-group .required{color:#ef4444}
        .form-input{width:100%;background:#0a0a0a;border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:12px 16px;color:#fff;font-size:0.9375rem}
        .form-input:focus{outline:none;border-color:rgb(52,211,153)}
        .form-hint{font-size:0.75rem;color:rgba(255,255,255,0.4);margin-top:4px}
        .btn-block{width:100%;justify-content:center}
        .template-download{background:#111;border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:20px;display:flex;justify-content:space-between;align-items:center;gap:16px;margin-bottom:24px;flex-wrap:wrap}
        .template-info h4{margin-bottom:4px}
        .template-info p{font-size:0.875rem;color:rgba(255,255,255,0.5)}
        .file-upload-zone{border:2px dashed rgba(255,255,255,0.2);border-radius:12px;padding:48px;text-align:center;cursor:pointer;transition:all 0.2s}
        .file-upload-zone:hover{border-color:rgb(52,211,153);background:rgba(52,211,153,0.05)}
        .file-upload-zone.dragover{border-color:rgb(52,211,153);background:rgba(52,211,153,0.1)}
        .file-upload-zone input{display:none}
        .file-upload-icon{font-size:3rem;margin-bottom:16px}
        .file-upload-supported{font-size:0.875rem;color:rgba(255,255,255,0.4);margin-top:8px}
        
        /* Search Page */
        .search-header{margin-bottom:24px}
        .search-header h2{font-size:1.5rem;font-weight:700;margin-bottom:4px}
        .search-box-large{display:flex;gap:12px;max-width:500px;margin-bottom:32px}
        .search-input-large{flex:1;background:#111;border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:14px 18px;color:#fff;font-size:1rem}
        .search-input-large:focus{outline:none;border-color:rgb(52,211,153)}
        .search-results-list{display:flex;flex-direction:column;gap:8px;margin-bottom:24px}
        .search-result-item{display:flex;justify-content:space-between;align-items:center;padding:16px;background:#111;border:1px solid rgba(255,255,255,0.1);border-radius:8px;cursor:pointer;transition:all 0.2s}
        .search-result-item:hover{border-color:rgb(52,211,153);background:rgba(52,211,153,0.05)}
        .search-lead-card{background:#111;border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:24px}
        .search-lead-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:20px;flex-wrap:wrap;gap:12px}
        .search-lead-header h3{font-size:1.5rem;margin-bottom:4px}
        .search-lead-info-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:24px;padding:16px;background:#0a0a0a;border-radius:8px}
        @media(max-width:768px){.search-lead-info-grid{grid-template-columns:repeat(2,1fr)}}
        .info-item .info-label{display:block;font-size:0.75rem;color:rgba(255,255,255,0.4);margin-bottom:2px}
        .info-item .info-value{font-weight:500}
        .search-lead-section{margin-bottom:24px}
        .search-lead-section h4{font-size:0.875rem;color:rgba(255,255,255,0.5);margin-bottom:8px}
        .search-lead-content{background:#0a0a0a;padding:16px;border-radius:8px;font-size:0.9375rem;line-height:1.6;white-space:pre-wrap}
        .search-lead-content.transcript{max-height:300px;overflow-y:auto}

        /* Collapsible Sidebar */
        .sidebar-collapse-btn{display:none;width:28px;height:28px;border-radius:6px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);color:rgba(255,255,255,0.6);cursor:pointer;align-items:center;justify-content:center;transition:all 0.2s;font-size:1rem;flex-shrink:0}
        .sidebar-collapse-btn:hover{background:rgba(255,255,255,0.1);color:#fff;border-color:rgba(255,255,255,0.2)}
        @media(min-width:1024px){.sidebar-collapse-btn{display:flex}}
        .sidebar.collapsed{width:64px;min-width:64px}
        .sidebar.collapsed .sidebar-logo{display:none !important}
        .sidebar.collapsed .sidebar-logo-mini{display:block !important;width:32px;height:32px;border-radius:6px;margin:0 auto}
        .sidebar.collapsed .nav-item span:not(.nav-item-icon){display:none}
        .sidebar.collapsed .nav-section-title{display:none}
        .sidebar.collapsed .nav-item{justify-content:center;padding:10px 8px}
        .sidebar.collapsed .nav-item-icon{width:32px;height:32px;font-size:20px;display:flex;align-items:center;justify-content:center}
        .sidebar.collapsed .user-info{display:none}
        .sidebar.collapsed .user-avatar{width:32px;height:32px;min-width:32px;min-height:32px;font-size:14px;flex-shrink:0}
        .sidebar.collapsed .user-card{justify-content:center;padding:8px}
        .sidebar.collapsed .notification-btn{display:none}
        .sidebar.collapsed .profile-menu{left:64px;bottom:50px;width:180px}
        .sidebar.collapsed .notifications-popup{left:64px}
        .sidebar.collapsed .sidebar-header{justify-content:center;padding:12px 10px;position:relative}
        .sidebar.collapsed .sidebar-collapse-btn{position:absolute;right:-12px;top:50%;transform:translateY(-50%);z-index:10;width:24px;height:24px;border-radius:50%;background:#1a1a1a;border:1px solid rgba(255,255,255,0.15);font-size:0.75rem}
        .sidebar.collapsed .sidebar-footer-row{justify-content:center}
        .app-container.sidebar-collapsed .main-content{margin-left:64px}
        @media(max-width:1023px){.app-container.sidebar-collapsed .main-content{margin-left:0}}

        /* Sidebar Resize Handle */
        .sidebar-resize-handle{position:absolute;top:0;right:-4px;width:8px;height:100%;cursor:ew-resize;z-index:100;background:transparent}
        .sidebar-resize-handle:hover,.sidebar-resize-handle.active{background:rgba(52,211,153,0.3)}
        .sidebar.collapsed .sidebar-resize-handle{display:none}
    </style>
</head>
<body>
    <!-- Full Page Loading Overlay -->
    <div id="pageLoadingOverlay" style="position:fixed;top:0;left:0;right:0;bottom:0;background:#000;z-index:9999;display:none;align-items:center;justify-content:center;transition:opacity 0.5s ease;">
        <video autoplay muted playsinline style="max-width:300px;max-height:300px;" id="loadingVideo">
            <source src="/assets/loading.mp4" type="video/mp4">
        </video>
    </div>
    <style>
        #pageLoadingOverlay.fade-out{opacity:0;pointer-events:none}
    </style>
    
    <div class="app-container" style="opacity:0;transition:opacity 0.5s ease;" id="appContainer">
        <!-- Sidebar Overlay (mobile) -->
        <div class="sidebar-overlay" id="sidebarOverlay"></div>

        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-resize-handle" id="sidebarResizeHandle"></div>
            <div class="sidebar-header">
                <img src="/assets/logo_white.png" alt="Prio AI" class="sidebar-logo logo-dark">
                <img src="/assets/logo_black.png" alt="Prio AI" class="sidebar-logo logo-light" style="display:none;">
                <img src="/assets/favicon.png" alt="Prio AI" class="sidebar-logo-mini" style="display:none;">
                <button class="sidebar-collapse-btn" id="sidebarCollapseBtn" title="Collapse sidebar"></button>
                <button class="sidebar-close" id="sidebarClose">&times;</button>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-item active" data-page="overview">
                        <span class="nav-item-icon"></span>
                        <span>Overview</span>
                    </div>
                    <div class="nav-item" data-page="prio">
                        <span class="nav-item-icon"></span>
                        <span>Prio Prospects</span>
                    </div>
                    <div class="nav-item" data-page="prospects">
                        <span class="nav-item-icon"></span>
                        <span>Prospects</span>
                    </div>
                    <div class="nav-item" data-page="pipeline">
                        <span class="nav-item-icon"></span>
                        <span>AI Pipeline</span>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Tools</div>
                    <div class="nav-item" data-page="import">
                        <span class="nav-item-icon"></span>
                        <span>Import Leads</span>
                    </div>
                    <div class="nav-item" data-page="search">
                        <span class="nav-item-icon"></span>
                        <span>Search</span>
                    </div>
                    <div class="nav-item" data-page="analytics">
                        <span class="nav-item-icon"></span>
                        <span>Analytics</span>
                    </div>
                </div>

<!-- Account section moved to profile popup -->
            </nav>

            <div class="sidebar-footer">
                <!-- Profile Menu (slides up) -->
                <div class="profile-menu" id="profileMenu">
                    <div class="profile-menu-item" data-page="settings">
                        <span></span> Settings
                    </div>
                    <div class="profile-menu-item" data-page="billing">
                        <span></span> Billing
                    </div>
                    <div class="profile-menu-item" data-page="help">
                        <span></span> Help
                    </div>
                    <div class="profile-menu-divider"></div>
                    <div class="profile-menu-item logout" id="sidebarLogout">
                        <span></span> Sign Out
                    </div>
                </div>
                
                <!-- Notifications Popup -->
                <div class="notifications-popup" id="notificationsPopup">
                    <div class="notifications-header">
                        <span>Notifications</span>
                    </div>
                    <div class="notifications-empty">
                        No new notifications
                    </div>
                </div>
                
                <div class="sidebar-footer-row">
                    <div class="user-card" id="userCard">
                        <div class="user-avatar" id="userAvatar">U</div>
                        <div class="user-info">
                            <div class="user-name" id="userName">Guest</div>
                            <div class="user-email" id="userEmail">Not signed in</div>
                        </div>
                    </div>
                    <button class="notification-btn" id="notificationBtn" title="Notifications">
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                            <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                        </svg>
                        <span class="notification-badge" id="notificationBadge" style="display:none;">0</span>
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="header">
                <div class="header-left">
                    <button class="menu-toggle" id="menuToggle">
                        <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none">
                            <line x1="3" y1="12" x2="21" y2="12"></line>
                            <line x1="3" y1="6" x2="21" y2="6"></line>
                            <line x1="3" y1="18" x2="21" y2="18"></line>
                        </svg>
                    </button>
                    <h1 class="header-title" id="pageTitle">Overview</h1>
                </div>
                <div class="header-right">
                    <button class="header-btn" id="themeToggle" title="Toggle theme">
                        <svg class="sun-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                        <svg class="moon-icon" viewBox="0 0 24 24" style="display:none;"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                    </button>
                    <button class="btn btn-primary btn-sm" id="loginBtn">Sign In</button>
                </div>
            </header>

            <div class="page-content">
                <!-- Loading State -->
                <div class="loading" id="loadingState">
                    <div class="spinner"></div>
                    <p class="text-muted">Loading...</p>
                </div>

                <!-- Guest State -->
                <div id="guestState" class="hidden">
                    <div class="card" style="max-width: 500px; margin: 0 auto; text-align: center;">
                        <h2 style="margin-bottom: var(--space-4);">Welcome to Prio AI</h2>
                        <p style="color: var(--text-secondary); margin-bottom: var(--space-6);">Sign in to access your dashboard and start converting more leads.</p>
                        <div style="display:flex;flex-direction:column;gap:12px;align-items:center;">
                            <button class="btn btn-primary btn-lg" id="guestLoginBtn" style="width:100%;max-width:200px;">Get Started</button>
                            <button class="btn btn-secondary btn-lg" id="guestSignInBtn" style="width:100%;max-width:200px;">Sign In</button>
                        </div>
                    </div>
                </div>

                <!-- Dashboard Content -->
                <div id="dashboardContent" class="hidden">
                    <!-- Page: Overview -->
                    <div class="page" id="page-overview">
                        <!-- Welcome Header with Compact Stats -->
                        <div class="overview-header-row">
                            <div class="overview-header-left">
                                <h1 class="overview-welcome">Welcome back, <span id="welcomeName">there</span> </h1>
                                <div class="overview-header-meta">
                                    <span class="header-meta-item" id="welcomeDate"></span>
                                    <span class="header-meta-divider"></span>
                                    <span class="header-meta-item" id="welcomePhone"><span class="meta-label">AI:</span> <span class="meta-value" id="retellPhoneNumber">-</span></span>
                                </div>
                            </div>
                            <div class="overview-header-right">
                                <div class="header-stat-badge usage-badge" id="usageCard">
                                    <span class="badge-emoji"></span>
                                    <div class="badge-value"><span id="usageCalls">0</span>/<span id="usageLimit">0</span></div>
                                    <div class="badge-label">Usage</div>
                                    <div class="usage-bar-mini"><div class="usage-bar-fill" id="usageBarFill"></div></div>
                                </div>
                                <div class="header-stat-badge">
                                    <span class="badge-emoji"></span>
                                    <div class="badge-value" id="statProspects">-</div>
                                    <div class="badge-label">Leads</div>
                                </div>
                                <div class="header-stat-badge accent">
                                    <span class="badge-emoji"></span>
                                    <div class="badge-value" id="statAppointments">-</div>
                                    <div class="badge-label">Booked</div>
                                </div>
                            </div>
                        </div>

                        <!-- Row 1: Pipeline Overview -->
                        <div class="section-label">Pipeline Overview</div>
                        <div class="overview-grid">
                            <div class="overview-card" onclick="switchPage('prio')">
                                <div class="overview-card-header">
                                    <span class="overview-card-icon"></span>
                                    <h4>Prio Prospects</h4>
                                </div>
                                <div class="overview-card-value" id="overviewPrio">0</div>
                                <div class="overview-card-desc">Priority leads to focus on</div>
                            </div>
                            <div class="overview-card" onclick="switchPage('prospects')">
                                <div class="overview-card-header">
                                    <span class="overview-card-icon"></span>
                                    <h4>Prospects</h4>
                                </div>
                                <div class="overview-card-value" id="overviewScheduled">0</div>
                                <div class="overview-card-desc">Callbacks & meetings booked</div>
                            </div>
                            <div class="overview-card" style="cursor:default">
                                <div class="overview-card-header">
                                    <span class="overview-card-icon"></span>
                                    <h4>Active Leads</h4>
                                </div>
                                <div class="overview-card-value" id="overviewActive">0</div>
                                <div class="overview-card-desc">Being called by AI</div>
                            </div>
                            <div class="overview-card" onclick="switchPage('pipeline')">
                                <div class="overview-card-header">
                                    <span class="overview-card-icon"></span>
                                    <h4>AI Pipeline</h4>
                                </div>
                                <div class="overview-card-value" id="overviewPipeline">0</div>
                                <div class="overview-card-desc">Timeline & follow-ups</div>
                            </div>
                        </div>

                        <!-- Row 2: Today's Activity -->
                        <div class="section-label">Today's Numbers</div>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-icon"></div>
                                <div class="stat-content">
                                    <div class="stat-value" id="statCallsToday">0</div>
                                    <div class="stat-label">AI Calls</div>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon"></div>
                                <div class="stat-content">
                                    <div class="stat-value" id="statConversationsToday">0</div>
                                    <div class="stat-label">AI Qualified Conversations</div>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon"></div>
                                <div class="stat-content">
                                    <div class="stat-value" id="statMeetingsToday">0</div>
                                    <div class="stat-label">AI Meetings Scheduled</div>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon"></div>
                                <div class="stat-content">
                                    <div class="stat-value" id="statFollowUpsToday">0</div>
                                    <div class="stat-label">AI Follow Ups Scheduled</div>
                                </div>
                            </div>
                        </div>

                        <!-- View Analytics Button -->
                        <div style="text-align:center;margin:1.5rem 0;">
                            <button class="btn btn-secondary" onclick="switchPage('analytics')" style="padding:12px 24px;">
                                 View All Analytics
                            </button>
                        </div>

                        <!-- Today's Priorities Section -->
                        <div class="priorities-section">
                            <div class="priorities-header">
                                <h3> Today's Priorities <span class="priorities-count" id="prioritiesCount">0</span></h3>
                                <div class="priorities-view-toggle">
                                    <button class="view-toggle-btn" id="viewGrid" onclick="setPrioritiesView('grid')" title="Grid view"></button>
                                    <button class="view-toggle-btn active" id="viewList" onclick="setPrioritiesView('list')" title="List view"></button>
                                </div>
                            </div>
                            <div class="priorities-cards list-view" id="todayPriorities">
                                <div class="priorities-empty">
                                    <p>No meetings or callbacks scheduled for today</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Page: PRIO -->
                    <div class="page hidden" id="page-prio">
                        <!-- Prio Header -->
                        <div class="prio-header">
                            <div class="prio-header-text">
                                <h2> Prio Prospects</h2>
                                <p>Your priority leads ranked by engagement. Focus here first.</p>
                            </div>
                            <div class="prio-header-stats">
                                <div class="prio-stat">
                                    <span class="prio-stat-value" id="prioCount">0</span>
                                    <span class="prio-stat-label">Priority Leads</span>
                                </div>
                            </div>
                        </div>

                        <!-- Prio Filters -->
                        <div class="filters-bar">
                            <div class="search-box">
                                <span class="search-icon"></span>
                                <input type="text" id="prioSearch" placeholder="Search by name or phone...">
                            </div>
                            <div class="filter-group">
                                <select id="prioOwnership" class="filter-select">
                                    <option value="all">All Leads</option>
                                    <option value="mine">My Prospects</option>
                                    <option value="shared-by">Shared By Me</option>
                                    <option value="not-shared">Not Shared</option>
                                    <option value="shared-with">Shared With Me</option>
                                </select>
                                <select id="prioTimeframe" class="filter-select">
                                    <option value="all">All Time</option>
                                    <option value="today">Today</option>
                                    <option value="7days">Last 7 Days</option>
                                    <option value="30days">Last 30 Days</option>
                                    <option value="90days">Last 90 Days</option>
                                </select>
                            </div>
                        </div>

                        <!-- Prio Cards -->
                        <div class="prio-list" id="prioList">
                            <div class="page-loading"><div class="spinner"></div><p>Loading priority leads...</p></div>
                        </div>
                    </div>

                    <!-- Page: Prospects -->
                    <div class="page hidden" id="page-prospects">
                        <!-- Prospects Header -->
                        <div class="prospects-header">
                            <div class="prospects-header-text">
                                <h2> Prospects</h2>
                                <p>Booked meetings and callback requests.</p>
                            </div>
                            <div class="prospects-header-actions">
                                <button class="btn btn-secondary btn-sm" id="columnsBtn"> Columns</button>
                            </div>
                        </div>

                        <!-- Prospects Filters -->
                        <div class="filters-bar">
                            <div class="search-box">
                                <span class="search-icon"></span>
                                <input type="text" id="prospectsSearch" placeholder="Search by name or phone...">
                            </div>
                            <div class="filter-group">
                                <select id="prospectsStatus" class="filter-select">
                                    <option value="all">All Status</option>
                                    <option value="Booked">Booked</option>
                                    <option value="Callback">Callback</option>
                                </select>
                                <select id="prospectsOwnership" class="filter-select">
                                    <option value="all">All Leads</option>
                                    <option value="mine">My Prospects</option>
                                    <option value="shared-by">Shared By Me</option>
                                    <option value="not-shared">Not Shared</option>
                                    <option value="shared-with">Shared With Me</option>
                                </select>
                                <select id="prospectsTimeframe" class="filter-select">
                                    <option value="all">All Time</option>
                                    <option value="today">Today</option>
                                    <option value="7days">Last 7 Days</option>
                                    <option value="30days">Last 30 Days</option>
                                    <option value="90days">Last 90 Days</option>
                                </select>
                            </div>
                        </div>

                        <!-- Prospects Table -->
                        <div class="table-container">
                            <table class="data-table" id="prospectsTable">
                                <thead>
                                    <tr>
                                        <th class="sortable" data-sort="firstName">Name</th>
                                        <th>Phone</th>
                                        <th class="sortable" data-sort="status">Status</th>
                                        <th class="sortable" data-sort="lastCalled">Last Updated</th>
                                        <th class="sortable" data-sort="bookedTime">Booked Time</th>
                                        <th>Summary</th>
                                        <th>Notes</th>
                                        <th>Sharing</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="prospectsTableBody">
                                    <tr><td colspan="9" class="empty-state"><div class="spinner" style="margin:0 auto"></div><p style="margin-top:12px">Loading prospects...</p></td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Page: Pipeline -->
                    <div class="page hidden" id="page-pipeline">
                        <!-- Pipeline Header -->
                        <div class="pipeline-header">
                            <div class="pipeline-header-text">
                                <h2> AI Pipeline</h2>
                                <p>Leads being followed up by AI. Timeline and scheduled follow-ups.</p>
                            </div>
                            <div class="pipeline-stats">
                                <div class="pipeline-stat">
                                    <span class="pipeline-stat-value" id="pipelineTimeline">0</span>
                                    <span class="pipeline-stat-label">Timeline</span>
                                </div>
                                <div class="pipeline-stat">
                                    <span class="pipeline-stat-value" id="pipelineFollowUp">0</span>
                                    <span class="pipeline-stat-label">Follow Up</span>
                                </div>
                            </div>
                        </div>

                        <!-- Pipeline Filters -->
                        <div class="filters-bar">
                            <div class="search-box">
                                <span class="search-icon"></span>
                                <input type="text" id="pipelineSearch" placeholder="Search by name or phone...">
                            </div>
                            <div class="filter-group">
                                <select id="pipelineStatus" class="filter-select">
                                    <option value="all">All Status</option>
                                    <option value="Timeline">Timeline</option>
                                    <option value="Follow Up">Follow Up</option>
                                </select>
                                <select id="pipelineTimeframe" class="filter-select">
                                    <option value="all">All Time</option>
                                    <option value="7days">Next 7 Days</option>
                                    <option value="30days">Next 30 Days</option>
                                    <option value="90days">Next 90 Days</option>
                                </select>
                            </div>
                        </div>

                        <!-- Pipeline Cards -->
                        <div class="pipeline-list" id="pipelineList">
                            <div class="page-loading"><div class="spinner"></div><p>Loading AI pipeline...</p></div>
                        </div>
                    </div>

                    <!-- Page: Analytics -->
                    <div class="page hidden" id="page-analytics">
                        <div class="analytics-header">
                            <div>
                                <h2> Performance Summary</h2>
                                <p style="color:rgba(255,255,255,0.5);">Track your AI calling performance</p>
                            </div>
                            <div class="analytics-period-tabs">
                                <button class="analytics-period-tab active" data-period="daily">Daily</button>
                                <button class="analytics-period-tab" data-period="weekly">Weekly</button>
                                <button class="analytics-period-tab" data-period="monthly">Monthly</button>
                                <button class="analytics-period-tab" data-period="all">All Time</button>
                            </div>
                        </div>
                        
                        <!-- Date Picker -->
                        <div class="analytics-date-picker" id="analyticsDateRow">
                            <input type="date" id="analyticsDatePicker" class="date-picker-input">
                        </div>
                        
                        <!-- Key Metrics -->
                        <div class="analytics-key-metrics">
                            <div class="analytics-metric-card accent">
                                <div class="metric-value" id="analyticsTotalCalls">0</div>
                                <div class="metric-label">Total Calls</div>
                            </div>
                            <div class="analytics-metric-card success">
                                <div class="metric-value" id="analyticsConversations">0</div>
                                <div class="metric-label">Conversations</div>
                            </div>
                            <div class="analytics-metric-card">
                                <div class="metric-value" id="analyticsActivePipeline">0</div>
                                <div class="metric-label">Active Pipeline</div>
                            </div>
                        </div>
                        
                        <!-- Qualified Breakdown -->
                        <div class="analytics-section">
                            <h3 class="analytics-section-title">Qualified Breakdown</h3>
                            <div class="analytics-breakdown-grid">
                                <div class="breakdown-card booked">
                                    <div class="breakdown-value" id="analyticsBooked">0</div>
                                    <div class="breakdown-label">Booked</div>
                                </div>
                                <div class="breakdown-card callback">
                                    <div class="breakdown-value" id="analyticsCallbackCount">0</div>
                                    <div class="breakdown-label">Callback</div>
                                </div>
                                <div class="breakdown-card interested">
                                    <div class="breakdown-value" id="analyticsInterested">0</div>
                                    <div class="breakdown-label">Interested</div>
                                </div>
                                <div class="breakdown-card timeline">
                                    <div class="breakdown-value" id="analyticsTimelineCount">0</div>
                                    <div class="breakdown-label">Timeline</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Other Outcomes -->
                        <div class="analytics-section">
                            <h3 class="analytics-section-title">Other Outcomes</h3>
                            <div class="analytics-outcomes-grid" id="analyticsOutcomes">
                                <div class="outcome-pill"><span class="outcome-count" id="analyticsVoicemail">0</span> Voicemail</div>
                                <div class="outcome-pill"><span class="outcome-count" id="analyticsNoAnswer">0</span> No Answer</div>
                                <div class="outcome-pill"><span class="outcome-count" id="analyticsNotInterested">0</span> Not Interested</div>
                                <div class="outcome-pill"><span class="outcome-count" id="analyticsDNC">0</span> DNC</div>
                                <div class="outcome-pill"><span class="outcome-count" id="analyticsWrongNumber">0</span> Wrong Number</div>
                            </div>
                        </div>
                        
                        <!-- Booked Leads Table -->
                        <div class="analytics-section" id="analyticsBookedSection">
                            <h3 class="analytics-section-title" style="color:rgb(52,211,153)"> Booked Appointments</h3>
                            <div class="table-container analytics-table-container booked-table">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Phone</th>
                                            <th>Summary</th>
                                            <th>Meeting Time</th>
                                        </tr>
                                    </thead>
                                    <tbody id="analyticsBookedTable"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Page: Import -->
                    <div class="page hidden" id="page-import">
                        <div class="import-header">
                            <h2> Import Leads</h2>
                            <p style="color:rgba(255,255,255,0.5);">Add new leads to your account</p>
                        </div>
                        
                        <!-- Import Method Tabs -->
                        <div class="import-tabs">
                            <button class="import-tab active" data-import="single"> Single Lead</button>
                            <button class="import-tab" data-import="bulk"> Bulk Upload</button>
                        </div>
                        
                        <!-- Single Lead Form -->
                        <div class="import-panel active" id="importSinglePanel">
                            <div class="import-form-card">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>First Name <span class="required">*</span></label>
                                        <input type="text" id="singleLeadFirstName" placeholder="John" class="form-input">
                                    </div>
                                    <div class="form-group">
                                        <label>Last Name</label>
                                        <input type="text" id="singleLeadLastName" placeholder="Smith" class="form-input">
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label>Phone Number <span class="required">*</span></label>
                                    <input type="tel" id="singleLeadPhone" placeholder="(416) 555-1234" class="form-input">
                                    <p class="form-hint">10 digits (e.g., 416-555-1234)</p>
                                </div>
                                
                                <div class="form-group">
                                    <label>Interest <span class="required">*</span></label>
                                    <select id="singleLeadInterest" class="form-input">
                                        <option value="">Select interest...</option>
                                        <option value="Buy">Buying</option>
                                        <option value="Sell">Selling</option>
                                        <option value="Both">Both (Buying & Selling)</option>
                                    </select>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Email</label>
                                        <input type="email" id="singleLeadEmail" placeholder="john@example.com" class="form-input">
                                    </div>
                                    <div class="form-group">
                                        <label>Max Call Attempts</label>
                                        <select id="singleLeadMaxAttempts" class="form-input">
                                            <option value="">Default (5)</option>
                                            <option value="1">1</option>
                                            <option value="2">2</option>
                                            <option value="3">3</option>
                                            <option value="5">5</option>
                                            <option value="10">10</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div id="singleLeadStatus"></div>
                                
                                <button class="btn btn-primary btn-block" id="submitSingleLeadBtn">
                                     Add Lead
                                </button>
                            </div>
                        </div>
                        
                        <!-- Bulk Upload -->
                        <div class="import-panel" id="importBulkPanel">
                            <div class="template-download">
                                <div class="template-info">
                                    <h4> Download Template First</h4>
                                    <p>CSV with: First Name, Last Name, Phone, Interest</p>
                                </div>
                                <button class="btn btn-secondary" id="downloadTemplateBtn">Download Template</button>
                            </div>
                            
                            <div class="file-upload-zone" id="fileUploadZone">
                                <input type="file" id="leadFileInput" accept=".csv,.xlsx,.xls">
                                <div class="file-upload-icon"></div>
                                <p><strong>Click to upload</strong> or drag and drop</p>
                                <p class="file-upload-supported">CSV, XLSX, or XLS (max 10MB)</p>
                            </div>
                            
                            <div id="uploadStatus"></div>
                        </div>
                    </div>

                    <!-- Page: Search -->
                    <div class="page hidden" id="page-search">
                        <div class="search-header">
                            <h2> Search Lead</h2>
                            <p style="color:rgba(255,255,255,0.5);">Search by name or last 4 digits of phone number</p>
                        </div>
                        
                        <div class="search-box-large">
                            <input type="text" id="globalSearchInput" placeholder="Enter name or last 4 digits of phone..." class="search-input-large">
                            <button class="btn btn-primary" id="globalSearchBtn">Search</button>
                        </div>
                        
                        <!-- Multiple Results -->
                        <div id="searchMultipleResults" style="display:none;">
                            <h4 style="margin-bottom:12px;color:rgba(255,255,255,0.6);">Multiple leads found - click to view:</h4>
                            <div id="searchResultsList" class="search-results-list"></div>
                        </div>
                        
                        <!-- Single Result Detail -->
                        <div id="searchLeadDetail" style="display:none;">
                            <div class="search-lead-card">
                                <div class="search-lead-header">
                                    <div>
                                        <h3 id="searchLeadName">-</h3>
                                        <p id="searchLeadPhoneDisplay" style="color:rgba(255,255,255,0.6);font-family:monospace;">-</p>
                                    </div>
                                    <span id="searchLeadStatusBadge" class="status-badge">-</span>
                                </div>
                                
                                <div class="search-lead-info-grid">
                                    <div class="info-item">
                                        <span class="info-label">Email</span>
                                        <span class="info-value" id="searchLeadEmail">-</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Total Calls</span>
                                        <span class="info-value" id="searchLeadCalls">-</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Last Updated</span>
                                        <span class="info-value" id="searchLeadLastCall">-</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Booked Time</span>
                                        <span class="info-value" id="searchLeadBookedTime">-</span>
                                    </div>
                                </div>
                                
                                <div class="search-lead-section">
                                    <h4> Client Notes</h4>
                                    <textarea id="searchLeadNotesInput" class="form-input" rows="4" placeholder="Add notes about this lead..."></textarea>
                                    <div style="display:flex;justify-content:flex-end;margin-top:8px;">
                                        <button class="btn btn-primary btn-sm" id="searchLeadSaveNotes">Save Notes</button>
                                    </div>
                                </div>
                                
                                <div class="search-lead-section">
                                    <h4> AI Summary</h4>
                                    <div id="searchLeadSummary" class="search-lead-content">No summary available</div>
                                </div>
                                
                                <div class="search-lead-section">
                                    <h4> Latest Transcript</h4>
                                    <div id="searchLeadTranscript" class="search-lead-content transcript">No transcript available</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Empty State -->
                        <div id="searchEmptyState" style="display:none;text-align:center;padding:60px;color:rgba(255,255,255,0.4);">
                            <div style="font-size:3rem;margin-bottom:16px;"></div>
                            <p id="searchEmptyText">No lead found</p>
                        </div>
                    </div>

                    <!-- Page: Settings -->
                    <div class="page hidden" id="page-settings">
                        <!-- Profile Card -->
                        <div class="settings-card">
                            <div class="profile-header">
                                <div class="profile-avatar-lg" id="settingsAvatar">
                                    <span id="settingsInitial">U</span>
                                </div>
                                <div class="profile-info">
                                    <h2 id="settingsName">-</h2>
                                    <p id="settingsEmail">-</p>
                                    <div class="profile-actions">
                                        <input type="file" id="settingsPhotoInput" accept="image/*" style="display:none;">
                                        <button class="btn btn-sm btn-secondary" id="settingsUploadBtn">Upload Photo</button>
                                        <button class="btn btn-sm btn-ghost" id="settingsRemoveBtn" style="display:none;">Remove</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Display Name -->
                        <div class="settings-card">
                            <h3 class="settings-title">Display Name</h3>
                            <form id="displayNameForm">
                                <div class="form-group">
                                    <label for="settingsDisplayName">How should we greet you?</label>
                                    <input type="text" id="settingsDisplayName" placeholder="e.g. Sahib">
                                </div>
                                <div class="form-message success" id="displaySuccess"></div>
                                <div class="form-message error" id="displayError"></div>
                                <button type="submit" class="btn btn-primary">Save</button>
                            </form>
                        </div>

                        <!-- Calling Preferences -->
                        <div class="settings-card">
                            <h3 class="settings-title">Calling Preferences</h3>
                            <form id="callingPrefsForm">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="settingsPhone">Your Phone Number <span class="sync-badge"> Synced</span></label>
                                        <input type="tel" id="settingsPhone" placeholder="+1 (555) 123-4567" readonly class="input-synced">
                                    </div>
                                    <div class="form-group">
                                        <label for="settingsCalendar">Calendar Email <span class="sync-badge"> Synced</span></label>
                                        <input type="email" id="settingsCalendar" placeholder="calendar@gmail.com" readonly class="input-synced">
                                    </div>
                                </div>
                                <p class="sync-notice">Phone and email are synced from your account. Contact support to update.</p>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="settingsStart">Available Start</label>
                                        <select id="settingsStart">
                                            <option value="8:00 AM">8:00 AM</option>
                                            <option value="9:00 AM" selected>9:00 AM</option>
                                            <option value="10:00 AM">10:00 AM</option>
                                            <option value="11:00 AM">11:00 AM</option>
                                            <option value="12:00 PM">12:00 PM</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="settingsEnd">Available End</label>
                                        <select id="settingsEnd">
                                            <option value="5:00 PM">5:00 PM</option>
                                            <option value="6:00 PM" selected>6:00 PM</option>
                                            <option value="7:00 PM">7:00 PM</option>
                                            <option value="8:00 PM">8:00 PM</option>
                                            <option value="9:00 PM">9:00 PM</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-message success" id="callingSuccess"></div>
                                <div class="form-message error" id="callingError"></div>
                                <button type="submit" class="btn btn-primary">Save Changes</button>
                            </form>
                        </div>

                        <!-- Change Password -->
                        <div class="settings-card">
                            <h3 class="settings-title">Change Password</h3>
                            <form id="passwordForm">
                                <div class="form-group">
                                    <label for="currentPassword">Current Password</label>
                                    <input type="password" id="currentPassword" placeholder="Enter your current password" required>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="newPassword">New Password</label>
                                        <input type="password" id="newPassword" placeholder="Min. 8 characters" minlength="8" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="confirmNewPassword">Confirm New Password</label>
                                        <input type="password" id="confirmNewPassword" placeholder="Confirm password" minlength="8" required>
                                    </div>
                                </div>
                                <div class="form-message success" id="passwordSuccess"></div>
                                <div class="form-message error" id="passwordError"></div>
                                <button type="submit" class="btn btn-secondary">Update Password</button>
                            </form>
                        </div>

                        <!-- Danger Zone -->
                        <div class="settings-card danger">
                            <h3 class="settings-title" style="color:#ef4444;">Danger Zone</h3>
                            <p class="text-muted" style="margin-bottom:1rem;">Need to pause or cancel your subscription?</p>
                            <button class="btn btn-secondary" onclick="window.location.href='mailto:info@prioai.ca?subject=Account Change Request'">Contact Support</button>
                        </div>
                    </div>

                    <!-- Page: Billing -->
                    <div class="page hidden" id="page-billing">
                        <!-- Current Plan -->
                        <div class="settings-card">
                            <h3 class="settings-title">Current Plan</h3>
                            <div class="billing-plan-card">
                                <div class="billing-plan-header">
                                    <div class="billing-plan-info">
                                        <span class="billing-plan-name" id="billingPlanName">Starter</span>
                                        <span class="billing-status-badge active" id="billingPlanStatus">Active</span>
                                    </div>
                                    <div class="billing-plan-price">
                                        <span class="price-amount" id="billingPlanPrice">$149</span>
                                        <span class="price-period">/month</span>
                                    </div>
                                </div>
                                <div class="billing-plan-details">
                                    <div class="billing-detail">
                                        <span class="detail-label">Call Limit</span>
                                        <span class="detail-value" id="billingCallLimit">1,000 calls/mo</span>
                                    </div>
                                    <div class="billing-detail">
                                        <span class="detail-label">Next Billing</span>
                                        <span class="detail-value" id="billingNextDate">-</span>
                                    </div>
                                </div>
                                <button class="btn btn-secondary btn-sm" id="upgradePlanBtn">Upgrade Plan</button>
                            </div>
                        </div>

                        <!-- Payment Method -->
                        <div class="settings-card">
                            <h3 class="settings-title">Payment Method</h3>
                            <div class="billing-payment-card" id="billingPaymentCard">
                                <div class="payment-icon"></div>
                                <div class="payment-details">
                                    <span class="payment-brand" id="paymentCardBrand">No payment method</span>
                                    <span class="payment-number" id="paymentCardNumber">Add a card to continue</span>
                                </div>
                                <button class="btn btn-secondary btn-sm" id="updatePaymentBtn">Add Card</button>
                            </div>
                        </div>

                        <!-- Usage This Month -->
                        <div class="settings-card">
                            <h3 class="settings-title">Usage This Month</h3>
                            <div class="billing-usage">
                                <div class="usage-stats">
                                    <div class="usage-stat">
                                        <span class="usage-value" id="billingUsageCalls">0</span>
                                        <span class="usage-label">Calls Made</span>
                                    </div>
                                    <div class="usage-stat">
                                        <span class="usage-value" id="billingUsageLimit">1,000</span>
                                        <span class="usage-label">Call Limit</span>
                                    </div>
                                    <div class="usage-stat">
                                        <span class="usage-value" id="billingUsagePercent">0%</span>
                                        <span class="usage-label">Used</span>
                                    </div>
                                </div>
                                <div class="usage-bar">
                                    <div class="usage-fill" id="billingUsageFill" style="width:0%"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Billing History -->
                        <div class="settings-card">
                            <h3 class="settings-title">Billing History</h3>
                            <div class="billing-history" id="billingHistoryList">
                                <p class="text-muted" style="text-align:center;padding:24px;">No billing history yet</p>
                            </div>
                            <button class="btn btn-secondary btn-sm" id="viewAllInvoicesBtn" style="margin-top:12px;">View All Invoices</button>
                        </div>

                        <!-- Actions -->
                        <div class="settings-card">
                            <div class="billing-actions">
                                <button class="btn btn-primary" id="manageBillingBtn">Manage Subscription</button>
                                <button class="btn btn-secondary" id="downloadReceiptBtn">Download Receipt</button>
                            </div>
                            <p id="billingStatus" class="text-muted" style="margin-top:12px;font-size:0.875rem;"></p>
                        </div>
                    </div>

                    <!-- Page: Help -->
                    <div class="page hidden" id="page-help">
                        <div class="settings-card">
                            <h3 class="settings-title"> Help Center</h3>
                            <p class="text-muted" style="margin-bottom:20px;">Everything you need to know about using Prio AI.</p>
                            
                            <!-- Search -->
                            <div class="help-search">
                                <span class="help-search-icon"></span>
                                <input type="text" id="helpSearchInput" placeholder="Search for help topics...">
                            </div>
                            
                            <!-- Quick Links -->
                            <div class="help-quick-links">
                                <div class="help-quick-link" data-topic="getting-started"> Getting Started</div>
                                <div class="help-quick-link" data-topic="prio-leads"> Prio Prospects</div>
                                <div class="help-quick-link" data-topic="ai-pipeline"> AI Pipeline</div>
                                <div class="help-quick-link" data-topic="importing"> Importing</div>
                            </div>
                        </div>
                        
                        <!-- FAQ Categories -->
                        <div id="helpCategories">
                            <!-- Getting Started -->
                            <div class="help-category" data-category="getting-started">
                                <div class="help-category-header">
                                    <span class="help-category-icon"></span>
                                    <span class="help-category-title">Getting Started</span>
                                    <span class="help-category-arrow"></span>
                                </div>
                                <div class="help-category-content">
                                    <div class="help-item">
                                        <div class="help-item-header">
                                            <span class="help-question">How do I navigate the dashboard?</span>
                                            <span class="help-toggle">+</span>
                                        </div>
                                        <div class="help-answer">
                                            <p>The sidebar on the left has all your main sections:</p>
                                            <ul>
                                                <li><strong>Overview</strong>  Your daily snapshot and quick actions</li>
                                                <li><strong>PRIO</strong>  Priority leads needing immediate attention</li>
                                                <li><strong>Prospects</strong>  All your leads in one searchable table</li>
                                                <li><strong>Pipeline</strong>  Leads being nurtured by AI</li>
                                                <li><strong>Import</strong>  Add new leads</li>
                                            </ul>
                                        </div>
                                    </div>
                                    <div class="help-item">
                                        <div class="help-item-header">
                                            <span class="help-question">What do the different lead statuses mean?</span>
                                            <span class="help-toggle">+</span>
                                        </div>
                                        <div class="help-answer">
                                            <ul>
                                                <li><strong>Booked</strong>  Meeting scheduled with you</li>
                                                <li><strong>Callback</strong>  Lead wants YOU to call them</li>
                                                <li><strong>Timeline</strong>  Has a future buying timeline</li>
                                                <li><strong>Follow Up</strong>  AI is continuing to nurture</li>
                                                <li><strong>Not Interested</strong>  Declined or not a fit</li>
                                                <li><strong>DNC</strong>  Do Not Call requested</li>
                                            </ul>
                                        </div>
                                    </div>
                                    <div class="help-item">
                                        <div class="help-item-header">
                                            <span class="help-question">How do I check my call usage?</span>
                                            <span class="help-toggle">+</span>
                                        </div>
                                        <div class="help-answer">
                                            <p>Your call usage is shown in the header at the top right. You can also see detailed usage in the <strong>Billing</strong> section.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- PRIO Leads -->
                            <div class="help-category" data-category="prio-leads">
                                <div class="help-category-header">
                                    <span class="help-category-icon"></span>
                                    <span class="help-category-title">Prio Prospects</span>
                                    <span class="help-category-arrow"></span>
                                </div>
                                <div class="help-category-content">
                                    <div class="help-item">
                                        <div class="help-item-header">
                                            <span class="help-question">What is a PRIO lead?</span>
                                            <span class="help-toggle">+</span>
                                        </div>
                                        <div class="help-answer">
                                            <p>PRIO (Priority) leads are your hottest opportunities. The AI automatically marks leads as PRIO when they book a meeting or request a callback. You can also manually mark any lead as PRIO.</p>
                                        </div>
                                    </div>
                                    <div class="help-item">
                                        <div class="help-item-header">
                                            <span class="help-question">How do I mark a lead as PRIO?</span>
                                            <span class="help-toggle">+</span>
                                        </div>
                                        <div class="help-answer">
                                            <p>Click on any lead to open the detail view, then click the yellow <strong> PRIO</strong> button at the top.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- AI Pipeline -->
                            <div class="help-category" data-category="ai-pipeline">
                                <div class="help-category-header">
                                    <span class="help-category-icon"></span>
                                    <span class="help-category-title">AI Pipeline</span>
                                    <span class="help-category-arrow"></span>
                                </div>
                                <div class="help-category-content">
                                    <div class="help-item">
                                        <div class="help-item-header">
                                            <span class="help-question">What is the AI Pipeline?</span>
                                            <span class="help-toggle">+</span>
                                        </div>
                                        <div class="help-answer">
                                            <p>The AI Pipeline shows leads being automatically nurtured by Sarah (our AI). These are leads with status "Timeline" or "Follow Up" who aren't ready to meet yet but are being kept warm.</p>
                                        </div>
                                    </div>
                                    <div class="help-item">
                                        <div class="help-item-header">
                                            <span class="help-question">How do I send a lead back to the AI?</span>
                                            <span class="help-toggle">+</span>
                                        </div>
                                        <div class="help-answer">
                                            <p>Open the lead detail view and click <strong> Send Back to AI</strong>. Add notes first so the AI has context!</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Importing -->
                            <div class="help-category" data-category="importing">
                                <div class="help-category-header">
                                    <span class="help-category-icon"></span>
                                    <span class="help-category-title">Importing Leads</span>
                                    <span class="help-category-arrow"></span>
                                </div>
                                <div class="help-category-content">
                                    <div class="help-item">
                                        <div class="help-item-header">
                                            <span class="help-question">How do I add leads?</span>
                                            <span class="help-toggle">+</span>
                                        </div>
                                        <div class="help-answer">
                                            <p>Go to the <strong>Import</strong> section. You can add a single lead manually or upload a CSV file for bulk import.</p>
                                        </div>
                                    </div>
                                    <div class="help-item">
                                        <div class="help-item-header">
                                            <span class="help-question">What CSV format should I use?</span>
                                            <span class="help-toggle">+</span>
                                        </div>
                                        <div class="help-answer">
                                            <p>Download our template from the Import page. Required columns: First Name, Phone. Optional: Last Name, Email.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Troubleshooting -->
                            <div class="help-category" data-category="troubleshooting">
                                <div class="help-category-header">
                                    <span class="help-category-icon"></span>
                                    <span class="help-category-title">Troubleshooting</span>
                                    <span class="help-category-arrow"></span>
                                </div>
                                <div class="help-category-content">
                                    <div class="help-item">
                                        <div class="help-item-header">
                                            <span class="help-question">My lead isn't showing up?</span>
                                            <span class="help-toggle">+</span>
                                        </div>
                                        <div class="help-answer">
                                            <p>Check your filters! Make sure you're not filtering by a status that excludes them. Use the Search tab to find any lead by name or phone.</p>
                                        </div>
                                    </div>
                                    <div class="help-item">
                                        <div class="help-item-header">
                                            <span class="help-question">How do I contact support?</span>
                                            <span class="help-toggle">+</span>
                                        </div>
                                        <div class="help-answer">
                                            <p>Email us at <a href="mailto:info@prioai.ca" style="color:rgb(52,211,153);">info@prioai.ca</a>  we typically respond within 24 hours.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Contact Support -->
                        <div class="settings-card" style="margin-top:24px;">
                            <div class="help-support">
                                <span class="help-support-icon"></span>
                                <div>
                                    <h4>Still need help?</h4>
                                    <p class="text-muted">Our team is here to support you</p>
                                </div>
                            </div>
                            <div class="help-support-actions">
                                <a href="mailto:info@prioai.ca?subject=Support Request" class="btn btn-primary"> Email Support</a>
                                <button class="btn btn-secondary" onclick="switchPage('feedback')"> Send Feedback</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Lead Detail Modal -->
    <div class="modal-overlay" id="leadModal">
        <div class="modal lead-modal">
            <div class="lead-modal-header">
                <div class="lead-modal-title">
                    <div class="modal-name-row">
                        <img src="/assets/favicon.png" class="modal-prio-icon" id="modalPrioIcon" style="display:none;">
                        <h2 id="modalLeadName">Lead Name</h2>
                    </div>
                    <div class="lead-modal-actions">
                        <button class="btn-share" id="modalShareBtn" title="Share with another agent">
                             Share
                        </button>
                        <button class="btn-prio-toggle" id="modalPrioBtn" title="Toggle PRIO status">
                             PRIO
                        </button>
                        <button class="btn-send-back" id="modalSendBackBtn">
                             Send to AI
                        </button>
                        <button class="btn-dnc" id="modalDNCBtn" title="Mark as Do Not Call">
                             DNC
                        </button>
                    </div>
                </div>
                <button class="modal-close" id="leadModalClose">&times;</button>
            </div>
            <div class="lead-modal-body">
                <div class="lead-info-grid">
                    <div class="lead-info-item">
                        <label> Phone</label>
                        <div class="value" id="modalPhone">-</div>
                    </div>
                    <div class="lead-info-item">
                        <label> Status</label>
                        <div class="value"><span id="modalStatus" class="status-badge">-</span></div>
                    </div>
                    <div class="lead-info-item">
                        <label> Last Updated</label>
                        <div class="value" id="modalLastCalled">-</div>
                    </div>
                    <div class="lead-info-item">
                        <label> Booked Time</label>
                        <div class="value" id="modalBookedTime">
                            <span id="modalBookedTimeValue">-</span>
                            <button class="btn-schedule" id="modalScheduleBtn" style="display:none;"> Schedule</button>
                        </div>
                    </div>
                    <div class="lead-info-item" id="modalSharedInfo" style="display:none;">
                        <label id="modalSharedLabel"> Shared With</label>
                        <div class="value" id="modalSharedValue">-</div>
                    </div>
                </div>

                <div class="lead-section">
                    <h3> AI Summary</h3>
                    <div class="lead-summary-content" id="modalSummary">No summary available</div>
                </div>

                <div class="lead-section">
                    <h3> Your Notes</h3>
                    <div class="lead-notes-list" id="modalNotesList"></div>
                    <div class="notes-input-container">
                        <textarea id="modalNotesInput" placeholder="Add a note about this lead..."></textarea>
                        <div class="notes-action-row">
                            <button id="voiceInputBtn" class="voice-input-btn" title="Voice to text">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>
                            </button>
                            <button id="polishNotesBtn" class="polish-notes-btn" title="Polish with AI"> Polish & Save</button>
                            <button class="btn btn-primary" id="modalSaveNoteBtn"> Save</button>
                        </div>
                    </div>
                </div>

                <div class="lead-section">
                    <h3> Call Attempts <span class="attempts-count" id="modalAttemptsCount">0</span></h3>
                    <div class="lead-attempts-list" id="modalAttemptsList"></div>
                    <button class="btn btn-secondary btn-sm" id="modalLogAttemptBtn" style="width:100%;margin-top:8px;">+ Log Call Attempt</button>
                </div>

                <div class="lead-section">
                    <h3> Transcript</h3>
                    <div class="lead-transcript" id="modalTranscript">No transcript available</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Polish Preview Modal -->
    <div class="polish-preview-modal" id="polishPreviewModal">
        <div class="polish-preview-content">
            <h3> Polished Note Preview</h3>
            <div class="polish-comparison">
                <div class="polish-box">
                    <div class="polish-box-label">Original</div>
                    <div class="polish-box-text" id="polishOriginalText"></div>
                </div>
                <div class="polish-box">
                    <div class="polish-box-label">Polished</div>
                    <div class="polish-box-text" id="polishNewText"></div>
                </div>
            </div>
            <div class="polish-actions">
                <button class="polish-reject" id="polishRejectBtn">Cancel</button>
                <button class="polish-accept" id="polishAcceptBtn">Use Polished</button>
            </div>
        </div>
    </div>
    
    <!-- Share Lead Popup -->
    <div class="share-popup-overlay" id="sharePopupOverlay"></div>
    <div class="share-popup" id="shareLeadPopup">
        <div class="share-popup-header">
            <h4>Share Prospect With</h4>
            <button class="share-popup-close" id="sharePopupClose">&times;</button>
        </div>
        <div class="share-popup-agents" id="shareAgentsList"></div>
        <div class="share-popup-actions">
            <button class="btn-share-cancel" id="sharePopupCancel">Cancel</button>
            <button class="btn-share-confirm" id="sharePopupConfirm" disabled>Share</button>
        </div>
    </div>
    
    <!-- Share Info Popup -->
    <div class="share-popup" id="shareInfoPopup">
        <div class="share-popup-header">
            <h4 id="shareInfoTitle">Shared Prospect</h4>
            <button class="share-popup-close" id="shareInfoClose">&times;</button>
        </div>
        <div class="share-info-content" id="shareInfoContent"></div>
        <div class="share-popup-actions" id="shareInfoActions" style="display:none;">
            <button class="btn-share-cancel" id="stopSharingBtn" style="background:rgba(239,68,68,0.15);color:#ef4444;border-color:rgba(239,68,68,0.3);">Stop Sharing</button>
        </div>
    </div>

    <!-- Send to AI Modal -->
    <div class="send-ai-modal-overlay" id="sendAIModal">
        <div class="send-ai-modal">
            <h3> Send Back to AI</h3>
            <p class="send-ai-subtitle">Why are you sending this lead back?</p>

            <div class="send-ai-section">
                <label class="send-ai-label">REASON</label>
                <div class="send-ai-reasons" id="sendAIReasons">
                    <button class="reason-btn" data-reason="No longer interested"> No longer interested</button>
                    <button class="reason-btn" data-reason="Did not pick up"> Did not pick up</button>
                    <button class="reason-btn" data-reason="Stopped responding"> Stopped responding</button>
                    <button class="reason-btn" data-reason="other"> Other</button>
                </div>
                <textarea id="sendAIOtherReason" class="send-ai-other-input" placeholder="Enter your reason..." style="display:none;"></textarea>
            </div>

            <div class="send-ai-section">
                <label class="send-ai-label">WHEN SHOULD AI CALL BACK?</label>
                <div class="send-ai-timing" id="sendAITiming">
                    <button class="timing-btn" data-months="3">3 months</button>
                    <button class="timing-btn" data-months="6">6 months</button>
                    <button class="timing-btn" data-months="9">9 months</button>
                    <button class="timing-btn" data-months="12">12 months</button>
                    <button class="timing-btn" data-months="custom"> Pick a date</button>
                </div>
                <div class="send-ai-calendar" id="sendAICalendar" style="display:none;">
                    <div class="calendar-header">
                        <button type="button" id="sendAICalPrev"></button>
                        <span class="calendar-month" id="sendAICalMonth"></span>
                        <button type="button" id="sendAICalNext"></button>
                    </div>
                    <div class="calendar-weekdays">
                        <span>Sun</span><span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span>
                    </div>
                    <div class="calendar-days" id="sendAICalDays"></div>
                </div>
                <input type="hidden" id="sendAICustomDate">
            </div>

            <div class="send-ai-section">
                <label class="send-ai-label">PREFERRED TIME OF DAY</label>
                <div class="send-ai-time-pref" id="sendAITimePref">
                    <button class="time-pref-btn" data-time="Morning"> Morning</button>
                    <button class="time-pref-btn active" data-time="Afternoon"> Afternoon</button>
                    <button class="time-pref-btn" data-time="Evening"> Evening</button>
                </div>
            </div>

            <div class="send-ai-actions">
                <button class="send-ai-cancel" id="sendAICancelBtn">Cancel</button>
                <button class="send-ai-confirm" id="sendAIConfirmBtn">Send to AI</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="confirm-modal-overlay" id="confirmModal">
        <div class="confirm-modal">
            <div class="confirm-modal-icon" id="confirmModalIcon"></div>
            <h3 id="confirmModalTitle">Confirm Action</h3>
            <p id="confirmModalMessage">Are you sure you want to proceed?</p>
            <div class="confirm-modal-actions">
                <button class="confirm-modal-cancel" id="confirmModalCancel">Cancel</button>
                <button class="confirm-modal-confirm" id="confirmModalConfirm">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Schedule Booking Modal -->
    <div class="schedule-modal-overlay" id="scheduleModal">
        <div class="schedule-modal">
            <h3> Schedule Meeting</h3>
            <p id="scheduleLeadName" style="color:rgba(255,255,255,0.6);margin-bottom:16px;font-size:0.875rem;"></p>
            
            <div class="form-group">
                <label>Select Date</label>
                <div class="calendar-picker" id="calendarPicker">
                    <div class="calendar-header">
                        <button id="calendarPrev"></button>
                        <span class="calendar-month" id="calendarMonth"></span>
                        <button id="calendarNext"></button>
                    </div>
                    <div class="calendar-weekdays">
                        <span>Sun</span><span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span>
                    </div>
                    <div class="calendar-days" id="calendarDays"></div>
                </div>
            </div>
            
            <div class="form-group">
                <label>Select Time</label>
                <div style="display:flex;gap:12px;align-items:center;">
                    <select id="scheduleHour" style="flex:1;padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);background:#111;color:#fff;font-size:1rem;">
                        <option value="9">9 AM</option>
                        <option value="10">10 AM</option>
                        <option value="11">11 AM</option>
                        <option value="12">12 PM</option>
                        <option value="13">1 PM</option>
                        <option value="14">2 PM</option>
                        <option value="15">3 PM</option>
                        <option value="16">4 PM</option>
                        <option value="17">5 PM</option>
                        <option value="18">6 PM</option>
                        <option value="19">7 PM</option>
                        <option value="20">8 PM</option>
                    </select>
                    <span style="color:rgba(255,255,255,0.5);">:</span>
                    <select id="scheduleMinute" style="flex:1;padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);background:#111;color:#fff;font-size:1rem;">
                        <option value="0">00</option>
                        <option value="15">15</option>
                        <option value="30">30</option>
                        <option value="45">45</option>
                    </select>
                </div>
            </div>
            
            <div class="schedule-modal-actions">
                <button class="btn-cancel" id="scheduleCancelBtn">Cancel</button>
                <button class="btn-save" id="scheduleSaveBtn">Save Booking</button>
            </div>
            <p style="text-align:center;font-size:0.75rem;color:rgba(255,255,255,0.4);margin-top:12px;">
                 Event will be automatically added to Google Calendar
            </p>
        </div>
    </div>

    <!-- Auth Modal -->
    <div class="modal-overlay" id="authModal">
        <div class="modal">
            <button class="modal-close" id="authModalClose">&times;</button>
            <div class="modal-content">
                <div class="modal-header">
                    <img src="/assets/logo_white.png" alt="Prio AI" class="modal-logo logo-dark">
                    <img src="/assets/logo_black.png" alt="Prio AI" class="modal-logo logo-light" style="display:none;">
                    <h2 id="authTitle">Welcome to Prio AI</h2>
                    <p id="authSubtitle">Sign in to your account</p>
                </div>

                <!-- Login Form -->
                <form id="loginForm">
                    <div class="form-group">
                        <label for="loginEmail">Email</label>
                        <input type="email" id="loginEmail" placeholder="you@example.com" required>
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" placeholder="" required>
                    </div>
                    <div class="form-error" id="loginError"></div>
                    <button type="submit" class="btn btn-primary btn-block btn-lg" id="loginSubmit">Sign In</button>
                </form>

                <!-- Signup Form (hidden by default) -->
                <form id="signupForm" class="hidden">
                    <div class="form-group">
                        <label for="signupName">Full Name</label>
                        <input type="text" id="signupName" placeholder="John Smith" required>
                    </div>
                    <div class="form-group">
                        <label for="signupEmail">Email</label>
                        <input type="email" id="signupEmail" placeholder="you@example.com" required>
                    </div>
                    <div class="form-group">
                        <label for="signupPassword">Password</label>
                        <input type="password" id="signupPassword" placeholder="Min. 8 characters" required minlength="8">
                    </div>
                    <div class="form-error" id="signupError"></div>
                    <div class="form-success" id="signupSuccess"></div>
                    <button type="submit" class="btn btn-primary btn-block btn-lg" id="signupSubmit">Create Account</button>
                </form>

                <div class="auth-divider"><span>or</span></div>

                <button class="btn btn-google btn-block" id="googleAuthBtn">
                    <svg viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                    Continue with Google
                </button>

                <div class="auth-footer">
                    <p id="authSwitch">Don't have an account? <a href="#" id="switchToSignup">Sign up</a></p>
                    <p style="margin-top: var(--space-2);"><a href="#" id="forgotPassword">Forgot password?</a></p>
                </div>
            </div>
        </div>
    </div>

<!-- User modal removed - using sidebar profile popup instead -->

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
    // Supabase Setup
    var SUPABASE_URL = "https://bflmikgoafdffezrfpgb.supabase.co";
    var SUPABASE_KEY = "sb_publishable_e4DbIJ2T-9QAMtXzYo4o8Q_x135R40k";
    var supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // State
    var currentUser = null;
    var currentPage = 'overview';

    // Elements
    var sidebar = document.getElementById('sidebar');
    var sidebarOverlay = document.getElementById('sidebarOverlay');
    var authModal = document.getElementById('authModal');
    // userModal removed
    var loginForm = document.getElementById('loginForm');
    var signupForm = document.getElementById('signupForm');

    // Toast
    function showToast(message, type) {
        var toast = document.createElement('div');
        toast.className = 'toast ' + (type || '');
        toast.textContent = message;
        document.getElementById('toastContainer').appendChild(toast);
        setTimeout(function() { toast.remove(); }, 4000);
    }

    // Custom Confirmation Modal
    var confirmResolve = null;
    function showConfirmModal(title, message, icon, isDestructive) {
        return new Promise(function(resolve) {
            confirmResolve = resolve;
            document.getElementById('confirmModalIcon').textContent = icon || '';
            document.getElementById('confirmModalTitle').textContent = title;
            document.getElementById('confirmModalMessage').textContent = message;
            var confirmBtn = document.getElementById('confirmModalConfirm');
            confirmBtn.className = 'confirm-modal-confirm' + (isDestructive === false ? ' success' : '');
            confirmBtn.textContent = isDestructive === false ? 'Confirm' : 'Yes, proceed';
            document.getElementById('confirmModal').classList.add('active');
        });
    }

    document.getElementById('confirmModalCancel').addEventListener('click', function() {
        document.getElementById('confirmModal').classList.remove('active');
        if (confirmResolve) confirmResolve(false);
    });

    document.getElementById('confirmModalConfirm').addEventListener('click', function() {
        document.getElementById('confirmModal').classList.remove('active');
        if (confirmResolve) confirmResolve(true);
    });

    document.getElementById('confirmModal').addEventListener('click', function(e) {
        if (e.target === this) {
            this.classList.remove('active');
            if (confirmResolve) confirmResolve(false);
        }
    });

    // Theme
    (function() {
        var html = document.documentElement;
        var saved = localStorage.getItem('theme') || 'dark';
        html.setAttribute('data-theme', saved);
        updateThemeIcons();
        
        document.getElementById('themeToggle').addEventListener('click', function() {
            var next = html.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', next);
            localStorage.setItem('theme', next);
            updateThemeIcons();
        });
        
        function updateThemeIcons() {
            var isDark = html.getAttribute('data-theme') === 'dark';
            document.querySelectorAll('.sun-icon').forEach(function(el) { el.style.display = isDark ? 'block' : 'none'; });
            document.querySelectorAll('.moon-icon').forEach(function(el) { el.style.display = isDark ? 'none' : 'block'; });
            document.querySelectorAll('.logo-dark').forEach(function(el) { el.style.display = isDark ? 'block' : 'none'; });
            document.querySelectorAll('.logo-light').forEach(function(el) { el.style.display = isDark ? 'none' : 'block'; });
        }
    })();

    // Sidebar Toggle (mobile)
    document.getElementById('menuToggle').addEventListener('click', function() {
        sidebar.classList.add('open');
        sidebarOverlay.classList.add('active');
    });
    
    document.getElementById('sidebarClose').addEventListener('click', closeSidebar);
    sidebarOverlay.addEventListener('click', closeSidebar);
    
    function closeSidebar() {
        sidebar.classList.remove('open');
        sidebarOverlay.classList.remove('active');
    }

    // Sidebar Collapse/Expand (desktop)
    var sidebarCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
    var collapseBtn = document.getElementById('sidebarCollapseBtn');
    var appContainer = document.getElementById('appContainer');

    function updateSidebarState() {
        if (sidebarCollapsed) {
            sidebar.classList.add('collapsed');
            appContainer.classList.add('sidebar-collapsed');
            sidebar.style.width = '';
            document.querySelector('.main-content').style.marginLeft = '';
            collapseBtn.innerHTML = '';
            collapseBtn.title = 'Expand sidebar';
        } else {
            sidebar.classList.remove('collapsed');
            appContainer.classList.remove('sidebar-collapsed');
            var savedWidth = localStorage.getItem('sidebarWidth');
            if (savedWidth) {
                sidebar.style.width = savedWidth + 'px';
                document.querySelector('.main-content').style.marginLeft = savedWidth + 'px';
            } else {
                sidebar.style.width = '';
                document.querySelector('.main-content').style.marginLeft = '';
            }
            collapseBtn.innerHTML = '';
            collapseBtn.title = 'Collapse sidebar';
        }
    }

    // Initialize collapsed state
    updateSidebarState();

    collapseBtn.addEventListener('click', function() {
        sidebarCollapsed = !sidebarCollapsed;
        localStorage.setItem('sidebarCollapsed', sidebarCollapsed);
        updateSidebarState();
    });

    // Sidebar Resize Functionality
    var resizeHandle = document.getElementById('sidebarResizeHandle');
    var isResizing = false;
    var savedSidebarWidth = localStorage.getItem('sidebarWidth');
    if (savedSidebarWidth && !sidebarCollapsed) {
        sidebar.style.width = savedSidebarWidth + 'px';
        document.querySelector('.main-content').style.marginLeft = savedSidebarWidth + 'px';
    }

    resizeHandle.addEventListener('mousedown', function(e) {
        if (sidebarCollapsed) return;
        isResizing = true;
        resizeHandle.classList.add('active');
        document.body.style.cursor = 'ew-resize';
        document.body.style.userSelect = 'none';
        e.preventDefault();
    });

    document.addEventListener('mousemove', function(e) {
        if (!isResizing) return;
        var newWidth = Math.min(Math.max(e.clientX, 180), 400);
        sidebar.style.width = newWidth + 'px';
        document.querySelector('.main-content').style.marginLeft = newWidth + 'px';
    });

    document.addEventListener('mouseup', function() {
        if (isResizing) {
            isResizing = false;
            resizeHandle.classList.remove('active');
            document.body.style.cursor = '';
            document.body.style.userSelect = '';
            var currentWidth = parseInt(sidebar.style.width);
            if (currentWidth) {
                localStorage.setItem('sidebarWidth', currentWidth);
            }
        }
    });

    // Navigation
    document.querySelectorAll('.nav-item[data-page]').forEach(function(item) {
        item.addEventListener('click', function() {
            switchPage(this.dataset.page);
            closeSidebar();
        });
    });

    function switchPage(page) {
        currentPage = page;
        
        // Update nav
        document.querySelectorAll('.nav-item').forEach(function(item) {
            item.classList.toggle('active', item.dataset.page === page);
        });
        
        // Update title
        var titles = {
            overview: 'Overview', prio: 'PRIO', prospects: 'Prospects', pipeline: 'AI Pipeline',
            analytics: 'Analytics', import: 'Import Leads', search: 'Search',
            settings: 'Settings', billing: 'Billing', help: 'Help'
        };
        document.getElementById('pageTitle').textContent = titles[page] || page;
        
        // Show page
        document.querySelectorAll('.page').forEach(function(p) { p.classList.add('hidden'); });
        var pageEl = document.getElementById('page-' + page);
        if (pageEl) pageEl.classList.remove('hidden');
        
        // Update hash
        window.location.hash = page;
    }

    // Auth Modal
    function openAuthModal(mode) {
        authModal.classList.add('active');
        if (mode === 'signup') {
            loginForm.classList.add('hidden');
            signupForm.classList.remove('hidden');
            document.getElementById('authTitle').textContent = 'Create Account';
            document.getElementById('authSubtitle').textContent = 'Start converting more leads';
            document.getElementById('authSwitch').innerHTML = 'Already have an account? <a href="#" id="switchToLogin">Sign in</a>';
            document.getElementById('switchToLogin').addEventListener('click', function(e) { e.preventDefault(); openAuthModal('login'); });
        } else {
            signupForm.classList.add('hidden');
            loginForm.classList.remove('hidden');
            document.getElementById('authTitle').textContent = 'Welcome to Prio AI';
            document.getElementById('authSubtitle').textContent = 'Sign in to your account';
            document.getElementById('authSwitch').innerHTML = "Don't have an account? <a href=\"#\" id=\"switchToSignup\">Sign up</a>";
            document.getElementById('switchToSignup').addEventListener('click', function(e) { e.preventDefault(); openAuthModal('signup'); });
        }
    }

    function closeAuthModal() {
        authModal.classList.remove('active');
        loginForm.reset();
        signupForm.reset();
        document.getElementById('loginError').textContent = '';
        document.getElementById('signupError').textContent = '';
        document.getElementById('signupSuccess').textContent = '';
    }

    document.getElementById('loginBtn').addEventListener('click', function() { openAuthModal('login'); });
    document.getElementById('guestLoginBtn').addEventListener('click', function() { openAuthModal('signup'); });
    document.getElementById('guestSignInBtn').addEventListener('click', function() { openAuthModal('login'); });
    document.getElementById('authModalClose').addEventListener('click', closeAuthModal);
    authModal.addEventListener('click', function(e) { if (e.target === authModal) closeAuthModal(); });

    // User card click handled by profile popup code below

    // Login
    loginForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        var btn = document.getElementById('loginSubmit');
        var err = document.getElementById('loginError');
        err.textContent = '';
        btn.disabled = true;
        btn.textContent = 'Signing in...';
        
        try {
            var result = await supabase.auth.signInWithPassword({
                email: document.getElementById('loginEmail').value,
                password: document.getElementById('loginPassword').value
            });
            if (result.error) throw result.error;
            closeAuthModal();
            checkAuth();
        } catch (ex) {
            err.textContent = ex.message || 'Login failed';
        }
        
        btn.disabled = false;
        btn.textContent = 'Sign In';
    });

    // Signup
    signupForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        var btn = document.getElementById('signupSubmit');
        var err = document.getElementById('signupError');
        var suc = document.getElementById('signupSuccess');
        err.textContent = '';
        suc.textContent = '';
        btn.disabled = true;
        btn.textContent = 'Creating account...';
        
        try {
            var result = await supabase.auth.signUp({
                email: document.getElementById('signupEmail').value,
                password: document.getElementById('signupPassword').value,
                options: {
                    data: { full_name: document.getElementById('signupName').value },
                    emailRedirectTo: window.location.origin
                }
            });
            if (result.error) throw result.error;
            if (result.data.user && !result.data.session) {
                suc.textContent = ' Check your email to confirm your account';
                btn.textContent = 'Email Sent';
            } else {
                closeAuthModal();
                checkAuth();
            }
        } catch (ex) {
            err.textContent = ex.message || 'Signup failed';
            btn.disabled = false;
            btn.textContent = 'Create Account';
        }
    });

    // Google Auth
    document.getElementById('googleAuthBtn').addEventListener('click', function() {
        supabase.auth.signInWithOAuth({
            provider: 'google',
            options: { redirectTo: window.location.origin }
        });
    });

<!-- Old logout button removed -->
    
    // Sidebar logout
    document.getElementById('sidebarLogout').addEventListener('click', async function() {
        await supabase.auth.signOut();
        currentUser = null;
        document.getElementById('profileMenu').classList.remove('active');
        checkAuth();
        showToast('Signed out', 'success');
    });
    
    // Profile menu toggle
    document.getElementById('userCard').addEventListener('click', function(e) {
        e.stopPropagation();
        document.getElementById('notificationsPopup').classList.remove('active');
        document.getElementById('profileMenu').classList.toggle('active');
    });
    
    // Profile menu items
    document.querySelectorAll('.profile-menu-item[data-page]').forEach(function(item) {
        item.addEventListener('click', function() {
            switchPage(this.dataset.page);
            document.getElementById('profileMenu').classList.remove('active');
        });
    });
    
    // Notifications toggle
    document.getElementById('notificationBtn').addEventListener('click', function(e) {
        e.stopPropagation();
        document.getElementById('profileMenu').classList.remove('active');
        document.getElementById('notificationsPopup').classList.toggle('active');
    });
    
    // Close popups when clicking outside
    document.addEventListener('click', function() {
        document.getElementById('profileMenu').classList.remove('active');
        document.getElementById('notificationsPopup').classList.remove('active');
    });

    // Auth Check (returns promise)
    function checkAuth() {
        return (async function() {
        document.getElementById('loadingState').classList.remove('hidden');
        document.getElementById('guestState').classList.add('hidden');
        document.getElementById('dashboardContent').classList.add('hidden');
        
        var result = await supabase.auth.getSession();
        currentUser = result.data.session?.user || null;
        
        document.getElementById('loadingState').classList.add('hidden');
        
        if (currentUser) {
            var name = currentUser.user_metadata?.full_name || currentUser.user_metadata?.display_name || currentUser.email.split('@')[0];
            var avatar = currentUser.user_metadata?.profile_picture;
            
            document.getElementById('userName').textContent = name;
            document.getElementById('userEmail').textContent = currentUser.email;
            
            if (avatar) {
                document.getElementById('userAvatar').innerHTML = '<img src="' + avatar + '" alt="">';
            } else {
                document.getElementById('userAvatar').textContent = name.charAt(0).toUpperCase();
            }
            
            document.getElementById('loginBtn').classList.add('hidden');
            document.getElementById('dashboardContent').classList.remove('hidden');
            
            // Show loading animation for logged in users
            var overlay = document.getElementById('pageLoadingOverlay');
            var appContainer = document.getElementById('appContainer');
            overlay.style.display = 'flex';
            appContainer.style.opacity = '1';
            setTimeout(function() {
                overlay.classList.add('fade-out');
                setTimeout(function() { overlay.style.display = 'none'; }, 500);
            }, 8000);
        } else {
            document.getElementById('userName').textContent = 'Guest';
            document.getElementById('userEmail').textContent = 'Not signed in';
            document.getElementById('userAvatar').textContent = 'G';
            document.getElementById('loginBtn').classList.remove('hidden');
            document.getElementById('guestState').classList.remove('hidden');
            // Show app container for non-logged in users
            document.getElementById('appContainer').style.opacity = '1';
        }
        })();
    }

    // Airtable Config (token is now server-side only in Cloudflare env vars)
    var AIRTABLE_BASE = 'applOjDjhH0RqLtBH';
    var AIRTABLE_CLIENTS_TABLE = 'tblMptC862PyL7Znw';
    var AIRTABLE_LEADS_TABLE = 'tblLpN4wceakfNFpq';

    // Airtable API helper - proxies through Pages Function (token handled server-side)
    async function fetchAirtable(path, options = {}) {
        var proxyUrl = '/api/airtable?path=' + encodeURIComponent(path);
        var fetchOptions = {
            method: options.method || 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        };
        if (options.body) {
            fetchOptions.body = typeof options.body === 'string' ? options.body : JSON.stringify(options.body);
        }
        var response = await fetch(proxyUrl, fetchOptions);
        return response.json();
    }
    
    var currentUserRecord = null;
    var allLeads = [];

    // Update welcome date
    function updateWelcomeDate() {
        var now = new Date();
        var options = { weekday: 'long', month: 'long', day: 'numeric' };
        document.getElementById('welcomeDate').textContent = now.toLocaleDateString('en-US', options);
    }
    updateWelcomeDate();

    // Fetch all fields for now - field filtering can be added once field names are verified
    var LEAD_FIELDS = '';
    
    // Try to load cached data first for instant display
    function loadCachedData() {
        try {
            var cached = sessionStorage.getItem('prio_leads_' + currentUser.email);
            if (cached) {
                var data = JSON.parse(cached);
                if (Date.now() - data.timestamp < 60000) { // Cache valid for 1 minute
                    allLeads = data.leads;
                    updateDashboard();
                    updatePrioList();
                    return true;
                }
            }
        } catch (e) {}
        return false;
    }
    
    function cacheData() {
        try {
            sessionStorage.setItem('prio_leads_' + currentUser.email, JSON.stringify({
                timestamp: Date.now(),
                leads: allLeads
            }));
        } catch (e) {}
    }

    // Load user data from Airtable
    async function loadUserData() {
        if (!currentUser) return;
        
        // Show cached data immediately if available
        var hasCached = loadCachedData();
        
        // Show loading state only if no cache
        if (!hasCached) {
            document.getElementById('statProspects').textContent = '...';
            document.getElementById('statAppointments').textContent = '...';
            document.getElementById('statCallsToday').textContent = '...';
        }
        
        try {
            var filterFormula = encodeURIComponent('({Email} = "' + currentUser.email + '")');
            var path = AIRTABLE_BASE + '/' + AIRTABLE_CLIENTS_TABLE + '?filterByFormula=' + filterFormula;
            var data = await fetchAirtable(path);
            
            if (data.records && data.records.length > 0) {
                currentUserRecord = data.records[0];
                loadLeadsData();
            } else {
                document.getElementById('statProspects').textContent = '0';
                document.getElementById('statAppointments').textContent = '0';
                document.getElementById('statCallsToday').textContent = '0';
                document.getElementById('prioList').innerHTML = '<div class="prio-empty">No leads yet. Import some to get started!</div>';
            }
        } catch (err) {
            console.error('Failed to load user data:', err);
            if (!hasCached) {
                document.getElementById('statProspects').textContent = '0';
                document.getElementById('statAppointments').textContent = '0';
                document.getElementById('statCallsToday').textContent = '0';
            }
        }
    }

    // Load leads data with optimizations
    async function loadLeadsData(isRefresh) {
        if (!currentUserRecord) return;

        try {
            var email = currentUser.email.toLowerCase();
            var filterFormula = 'FIND("' + email + '", LOWER(ARRAYJOIN({Client Email})))';
            var basePath = AIRTABLE_BASE + '/' + AIRTABLE_LEADS_TABLE + '?filterByFormula=' + encodeURIComponent(filterFormula) + '&pageSize=100';

            // Use temp array to avoid flickering on refresh
            var tempLeads = [];
            var offset = null;
            var isFirstPage = true;

            do {
                var fetchPath = basePath + (offset ? '&offset=' + offset : '');
                var data = await fetchAirtable(fetchPath);

                if (data.records) {
                    tempLeads = tempLeads.concat(data.records);
                }
                offset = data.offset;

                // On initial load, render after first page so user sees data fast
                if (!isRefresh && isFirstPage && tempLeads.length > 0) {
                    isFirstPage = false;
                    allLeads = tempLeads.slice(); // Copy current data
                    updateDashboard();
                    updatePrioList();
                }
            } while (offset);

            // Replace allLeads with complete new data
            allLeads = tempLeads;
            updateDashboard();
            updatePrioList();
            cacheData();
        } catch (err) {
            console.error('Failed to load leads:', err);
        }
    }

    function updateDashboard() {
        updateStats();
    }

    // Update stats
    function updateStats() {
        var totalProspects = allLeads.length;
        document.getElementById('statProspects').textContent = totalProspects;
        
        var appointments = allLeads.filter(function(l) { 
            var status = l.fields['Status'] || l.fields['Disposition'] || '';
            return status === 'Booked' || status === 'Appointment Booked';
        }).length;
        document.getElementById('statAppointments').textContent = appointments;
        
        // Today's date for filtering
        var today = new Date().toDateString();
        var todayISO = new Date().toISOString().split('T')[0];

        // Calls Today - count leads with Last Call Timestamp today
        var callsToday = allLeads.filter(function(l) {
            var lastCall = l.fields['Last Call Timestamp'];
            if (!lastCall) return false;
            return new Date(lastCall).toDateString() === today;
        }).length;
        document.getElementById('statCallsToday').textContent = callsToday;

        // AI Qualified Conversations - Outcome = Booked, Timeline, Follow Up, Callback, or Not Interested
        var qualifiedOutcomes = ['booked', 'timeline', 'follow up', 'callback', 'not interested'];
        var conversationsToday = allLeads.filter(function(l) {
            var lastCall = l.fields['Last Call Timestamp'];
            if (!lastCall) return false;
            if (new Date(lastCall).toDateString() !== today) return false;
            var outcome = (l.fields['Outcome'] || l.fields['Disposition'] || l.fields['Status'] || '').toLowerCase();
            return qualifiedOutcomes.includes(outcome);
        }).length;
        var convEl = document.getElementById('statConversationsToday');
        if (convEl) convEl.textContent = conversationsToday;

        // AI Meetings Scheduled - Outcome = Booked or Callback
        var meetingOutcomes = ['booked', 'callback'];
        var meetingsToday = allLeads.filter(function(l) {
            var lastCall = l.fields['Last Call Timestamp'];
            if (!lastCall) return false;
            if (new Date(lastCall).toDateString() !== today) return false;
            var outcome = (l.fields['Outcome'] || l.fields['Disposition'] || l.fields['Status'] || '').toLowerCase();
            return meetingOutcomes.includes(outcome);
        }).length;
        var meetEl = document.getElementById('statMeetingsToday');
        if (meetEl) meetEl.textContent = meetingsToday;

        // AI Follow Ups Scheduled - Outcome = Timeline or Follow Up
        var followUpOutcomes = ['timeline', 'follow up'];
        var followUpsToday = allLeads.filter(function(l) {
            var lastCall = l.fields['Last Call Timestamp'];
            if (!lastCall) return false;
            if (new Date(lastCall).toDateString() !== today) return false;
            var outcome = (l.fields['Outcome'] || l.fields['Disposition'] || l.fields['Status'] || '').toLowerCase();
            return followUpOutcomes.includes(outcome);
        }).length;
        var fuEl = document.getElementById('statFollowUpsToday');
        if (fuEl) fuEl.textContent = followUpsToday;
        
        // Retell Phone & Usage from client record
        if (currentUserRecord && currentUserRecord.fields) {
            var retellPhone = currentUserRecord.fields['Retell Phone'];
            if (retellPhone) {
                document.getElementById('retellPhoneNumber').textContent = retellPhone;
            }
            var callsThisMonth = currentUserRecord.fields['Calls This Month'] || 0;
            var callLimit = currentUserRecord.fields['Call Limit'] || (currentUserRecord.fields['Monthly Plan'] === 'Professional' ? 3000 : 1000);
            document.getElementById('usageCalls').textContent = callsThisMonth;
            document.getElementById('usageLimit').textContent = callLimit;
            
            // Update usage progress bar with color gradient
            var usagePercent = callLimit > 0 ? Math.min((callsThisMonth / callLimit) * 100, 100) : 0;
            var usageBar = document.getElementById('usageBarFill');
            usageBar.style.width = usagePercent + '%';
            usageBar.classList.remove('warning', 'danger');

            // Color changes: white (0-50%) -> yellow (50-80%) -> red (80%+)
            if (usagePercent >= 100) {
                usageBar.classList.add('danger');
            } else if (usagePercent >= 80) {
                usageBar.classList.add('danger');
            } else if (usagePercent >= 50) {
                usageBar.classList.add('warning');
            }
            // Default is white (no class)
        }
        
        // PRIO leads (Is Prio = true from Airtable)
        var prioLeads = allLeads.filter(function(l) {
            return l.fields['Is Prio'] === true;
        });
        document.getElementById('overviewPrio').textContent = prioLeads.length;
        
        // Scheduled leads (callback or meeting booked)
        var scheduledLeads = allLeads.filter(function(l) {
            var status = l.fields['Status'] || l.fields['Disposition'] || '';
            var hasBookedTime = !!l.fields['Booked Time'];
            var hasCallback = status === 'Callback' || status === 'Callback Requested';
            return hasBookedTime || hasCallback || status === 'Booked' || status === 'Appointment Booked';
        });
        document.getElementById('overviewScheduled').textContent = scheduledLeads.length;
        
        // Active leads (currently being called by AI)
        var activeLeads = allLeads.filter(function(l) {
            var status = l.fields['Call Status'] || l.fields['Status'] || '';
            return status === 'Queued' || status === 'In Progress' || status === 'Retry' || status === 'Calling';
        });
        document.getElementById('overviewActive').textContent = activeLeads.length;
        
        // AI Pipeline (Timeline & Follow Up - will be called back)
        var pipelineLeads = allLeads.filter(function(l) {
            var status = l.fields['Status'] || l.fields['Disposition'] || '';
            return status === 'Timeline' || status === 'Follow Up';
        });
        document.getElementById('overviewPipeline').textContent = pipelineLeads.length;
        
        // Today's priorities (booked time or callback today) + missed meetings (past scheduled with no call logged)
        var today = new Date().toISOString().split('T')[0];
        var todayDate = new Date(today);

        // Today's scheduled calls
        var todayPriorities = allLeads.filter(function(l) {
            var bookedTime = l.fields['Booked Time'] || '';
            var callbackDate = l.fields['Callback Date'] || l.fields['Follow Up Date'] || '';
            return (bookedTime && bookedTime.startsWith(today)) || (callbackDate && callbackDate.startsWith(today));
        }).sort(function(a, b) {
            var timeA = a.fields['Booked Time'] || a.fields['Callback Date'] || '';
            var timeB = b.fields['Booked Time'] || b.fields['Callback Date'] || '';
            return timeA.localeCompare(timeB);
        });

        // Find missed meetings (scheduled in past but no call logged on that day)
        var missedMeetings = allLeads.filter(function(l) {
            var bookedTime = l.fields['Booked Time'] || '';
            var callbackDate = l.fields['Callback Date'] || l.fields['Follow Up Date'] || '';
            var scheduledDate = bookedTime || callbackDate;

            if (!scheduledDate) return false;

            var scheduledDateOnly = scheduledDate.split('T')[0];
            var scheduledDateObj = new Date(scheduledDateOnly);

            // Only check past dates (not today)
            if (scheduledDateObj >= todayDate) return false;

            // Check if a call was logged on or after the scheduled date
            var lastCallTimestamp = l.fields['Last Call Timestamp'];
            if (!lastCallTimestamp) return true; // No call logged = missed

            // Handle both string dates and numeric timestamps
            var lastCallDate;
            if (typeof lastCallTimestamp === 'string') {
                lastCallDate = new Date(lastCallTimestamp.split('T')[0]);
            } else {
                lastCallDate = new Date(lastCallTimestamp);
                lastCallDate = new Date(lastCallDate.toISOString().split('T')[0]);
            }

            // If last call was before the scheduled date, it's missed
            return lastCallDate < scheduledDateObj;
        }).sort(function(a, b) {
            // Sort by scheduled date descending (most recent missed first)
            var timeA = a.fields['Booked Time'] || a.fields['Callback Date'] || '';
            var timeB = b.fields['Booked Time'] || b.fields['Callback Date'] || '';
            return timeB.localeCompare(timeA);
        });

        // Update count - only today's meetings in the green badge
        document.getElementById('prioritiesCount').textContent = todayPriorities.length;
        updateTodayPriorities(todayPriorities, missedMeetings);
        
        // Update welcome name - check Supabase metadata first, then Airtable Agent Name
        var name = currentUser?.user_metadata?.full_name ||
                   currentUser?.user_metadata?.display_name ||
                   currentUserRecord?.fields?.['Agent Name'] ||
                   'there';
        document.getElementById('welcomeName').textContent = name.split(' ')[0];
        
        // Set today's date
        document.getElementById('welcomeDate').textContent = new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
        
    }
    
    // Format phone number as +1 (647) 123-4567
    function formatPhoneNumber(phone) {
        if (!phone || phone === '-') return '-';
        var digits = phone.replace(/\D/g, '');
        if (digits.length === 10) {
            return '+1 (' + digits.substring(0,3) + ') ' + digits.substring(3,6) + '-' + digits.substring(6);
        } else if (digits.length === 11 && digits.startsWith('1')) {
            return '+1 (' + digits.substring(1,4) + ') ' + digits.substring(4,7) + '-' + digits.substring(7);
        }
        return phone;
    }

    // Update today's priorities list with taller cards
    function updateTodayPriorities(priorities, missedMeetings) {
        var list = document.getElementById('todayPriorities');
        missedMeetings = missedMeetings || [];

        if ((!priorities || priorities.length === 0) && missedMeetings.length === 0) {
            list.innerHTML = '<div class="priorities-empty"><p>No meetings or callbacks scheduled for today</p></div>';
            return;
        }

        function renderPriorityCard(lead, index, isMissed) {
            var f = lead.fields;
            var name = ((f['First Name'] || '') + ' ' + (f['Last Name'] || '')).trim() || 'Unknown';
            var phone = f['Phone #'] || f['Phone'] || '-';
            var formattedPhone = formatPhoneNumber(phone);
            var bookedTime = f['Booked Time'];
            var callbackDate = f['Callback Date'] || f['Follow Up Date'];
            var summary = f['Last Call Summary'] || f['Summary'] || '';
            var notesRaw = f['Client Notes'] || f['Notes'] || '';
            var lastUpdatedTimestamp = f['Updated At'];
            var lastUpdated = lastUpdatedTimestamp ? formatTimeAgo(lastUpdatedTimestamp) : '-';
            var lastUpdatedColor = getLastCalledColor(lastUpdatedTimestamp);
            var isPrio = f['Is Prio'] === true;
            var isShared = lead.isShared || f['Shared With'] || f['Shared With Email'];

            // Parse notes
            var notesArray = parseNotesJson(notesRaw);

            // Get last note text
            var lastNoteText = notesArray.length > 0 ? notesArray[notesArray.length - 1].text : 'No notes yet';

            var timeDisplay = '-';
            var dateDisplay = '';
            if (bookedTime) {
                var d = new Date(bookedTime);
                timeDisplay = d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                if (isMissed) {
                    dateDisplay = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                }
            } else if (callbackDate) {
                var d = new Date(callbackDate);
                timeDisplay = d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                if (isMissed) {
                    dateDisplay = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                }
            }

            var missedClass = isMissed ? ' missed-meeting' : '';
            var timeCol = isMissed && dateDisplay
                ? '<span class="time-value missed-date">' + dateDisplay + '</span><span class="time-value">' + timeDisplay + '</span>'
                : '<span class="time-value">' + timeDisplay + '</span>';

            var prioIndicator = isPrio ? '<img src="/assets/favicon.png" class="prio-icon" title="Priority Lead">' : '';

            return '<div class="priority-card-lg' + missedClass + '" data-id="' + lead.id + '">' +
                '<div class="priority-card-lg-left" onclick="openLeadModal(\'' + lead.id + '\')">' +
                    '<div class="priority-card-lg-time-col">' +
                        prioIndicator +
                        timeCol +
                    '</div>' +
                    '<div class="priority-card-lg-info">' +
                        '<div class="priority-card-lg-top">' +
                            '<div class="priority-card-lg-name">' + escapeHtml(name) + '</div>' +
                        '</div>' +
                        '<div class="priority-card-lg-phone"> ' + escapeHtml(formattedPhone) + '</div>' +
                        '<div class="priority-card-lg-lastcall">Updated ' + lastUpdated + ' <span class="lastcall-dot ' + lastUpdatedColor + '"></span></div>' +
                    '</div>' +
                '</div>' +
                '<div class="priority-card-lg-summary-col" onclick="openLeadModal(\'' + lead.id + '\')">' +
                    '<div class="col-label">Summary</div>' +
                    '<div class="col-content">' + (summary ? escapeHtml(summary) : '<span style="color:rgba(255,255,255,0.4)">No summary available</span>') + '</div>' +
                '</div>' +
                '<div class="priority-card-lg-notes-col" onclick="openLeadModal(\'' + lead.id + '\')">' +
                    '<div class="col-label">Notes</div>' +
                    '<div class="col-content">' + escapeHtml(lastNoteText) + '</div>' +
                '</div>' +
                '<div class="priority-card-lg-actions">' +
                    '<button class="action-btn action-share' + (isShared ? ' shared' : '') + '" onclick="event.stopPropagation();quickShareLead(\'' + lead.id + '\')"><span class="action-icon">' + (isShared ? '' : '') + '</span><span class="action-label">' + (isShared ? 'Shared' : 'Share') + '</span></button>' +
                    '<button class="action-btn action-ai" onclick="event.stopPropagation();quickSendToAI(\'' + lead.id + '\')"><span class="action-icon"></span><span class="action-label">Send to AI</span></button>' +
                    '<button class="action-btn action-dnc" onclick="event.stopPropagation();quickMarkDNC(\'' + lead.id + '\')"><span class="action-icon"></span><span class="action-label">Do Not Call</span></button>' +
                    '<button class="action-btn action-reschedule" onclick="event.stopPropagation();quickReschedule(\'' + lead.id + '\')"><span class="action-icon"></span><span class="action-label">Reschedule</span></button>' +
                '</div>' +
            '</div>';
        }

        var html = '';

        // Render today's priorities first
        if (priorities && priorities.length > 0) {
            html += priorities.map(function(lead, index) {
                return renderPriorityCard(lead, index, false);
            }).join('');
        }

        // Add red separator and missed meetings if any
        if (missedMeetings.length > 0) {
            html += '<div class="missed-meeting-separator"><span>Missed Meeting <span class="missed-count">' + missedMeetings.length + '</span></span></div>';
            html += '<div class="missed-meeting-info">Please reschedule these meetings or send back to AI to keep your dashboard clean.</div>';
            html += missedMeetings.map(function(lead, index) {
                return renderPriorityCard(lead, index, true);
            }).join('');
        }

        list.innerHTML = html;
    }
    
    // Switch tabs on Priority cards
    function switchPriorityTab(cardId, tab) {
        var card = document.getElementById(cardId);
        if (!card) return;
        var tabsContainer = card.previousElementSibling;
        
        // Update tab buttons
        tabsContainer.querySelectorAll('.priority-card-lg-tab').forEach(function(btn) {
            btn.classList.remove('active');
        });
        tabsContainer.querySelector('.priority-card-lg-tab:' + (tab === 'summary' ? 'first-child' : 'last-child')).classList.add('active');
        
        // Update panels
        card.querySelectorAll('.priority-card-lg-panel').forEach(function(panel) {
            panel.classList.remove('active');
            if (panel.dataset.panel === tab) panel.classList.add('active');
        });
    }
    
    // Toggle priorities view between grid and list
    function setPrioritiesView(view) {
        var container = document.getElementById('todayPriorities');
        var gridBtn = document.getElementById('viewGrid');
        var listBtn = document.getElementById('viewList');
        
        if (view === 'list') {
            container.classList.add('list-view');
            gridBtn.classList.remove('active');
            listBtn.classList.add('active');
        } else {
            container.classList.remove('list-view');
            gridBtn.classList.add('active');
            listBtn.classList.remove('active');
        }
    }

    // Update Prio Prospects list
    function updatePrioList() {
        var prioList = document.getElementById('prioList');
        
        // Get leads where Is Prio = true, sorted by priority score
        var prioLeads = allLeads.filter(function(l) {
            return l.fields['Is Prio'] === true;
        }).map(function(l) {
            var d = l.fields['Disposition'] || l.fields['Status'] || '';
            var score = 0;
            if (d === 'Booked' || d === 'Appointment Booked') score = 95;
            else if (d === 'Callback' || d === 'Callback Requested') score = 90;
            else if (d === 'Interested') score = 85;
            else if (d === 'Timeline') score = 70;
            else if (d === 'Follow Up') score = 60;
            else score = 50;
            l._score = score;
            return l;
        }).sort(function(a, b) {
            return b._score - a._score;
        });
        
        document.getElementById('prioCount').textContent = prioLeads.length;
        
        if (prioLeads.length === 0) {
            prioList.innerHTML = '<div class="prio-empty">No priority leads yet. Import some leads to get started!</div>';
            return;
        }
        
        prioList.innerHTML = prioLeads.map(function(lead, index) {
            var f = lead.fields;
            var firstName = f['First Name'] || '';
            var lastName = f['Last Name'] || '';
            var name = (firstName + ' ' + lastName).trim() || 'Unknown';
            var phone = f['Phone #'] || f['Phone'] || '-';
            var lastUpdatedTimestamp = f['Updated At'];
            var lastUpdated = lastUpdatedTimestamp ? formatTimeAgo(lastUpdatedTimestamp) : '-';
            var lastUpdatedColor = getLastCalledColor(lastUpdatedTimestamp);
            var bookedTime = f['Booked Time'] || null;
            var summary = f['Last Call Summary'] || f['Summary'] || '';
            var notesRaw = f['Client Notes'] || f['Notes'] || '';
            var isShared = f['Shared With'] || f['Shared With Email'];
            
            // Parse notes as JSON array or create from string
            var notesArray = parseNotesJson(notesRaw);
            
            // Format booked time as friendly date
            var bookedDisplay = '';
            if (bookedTime) {
                bookedDisplay = formatFriendlyDateTime(bookedTime);
            }
            
            // Build notes HTML
            var notesHtml = '';
            if (notesArray.length > 0) {
                notesHtml = notesArray.map(function(note) {
                    return '<div class="prio-note-item">' +
                        '<div class="prio-note-text">' + escapeHtml(note.text) + '</div>' +
                        '<div class="prio-note-date">' + formatNoteDate(note.date) + '</div>' +
                    '</div>';
                }).join('');
            } else {
                notesHtml = '<div style="color:rgba(255,255,255,0.4);font-size:0.8125rem;">No notes yet</div>';
            }
            
            var cardId = 'prio-card-' + index;
            
            return '<div class="prio-card" data-id="' + lead.id + '">' +
                '<div class="prio-card-header">' +
                    '<div class="prio-card-name">' + escapeHtml(name) + (isShared ? ' <span class="shared-icon" title="Shared lead"></span>' : '') + '</div>' +
                    '<div class="prio-card-meta">' +
                        '<span class="prio-card-phone"> ' + escapeHtml(phone) + '</span>' +
                        '<span class="prio-card-lastcall"><span class="lastcall-dot ' + lastUpdatedColor + '"></span>' + lastUpdated + '</span>' +
                    '</div>' +
                    (bookedTime ? '<div class="prio-card-booked"><span class="booked-time"> ' + bookedDisplay + '</span></div>' : 
                        '<div class="prio-card-booked"><button class="btn-schedule" onclick="event.stopPropagation()">Schedule</button></div>') +
                '</div>' +
                '<div class="prio-card-tabs">' +
                    '<button class="prio-card-tab active" onclick="event.stopPropagation();switchPrioTab(\'' + cardId + '\',\'summary\')">Summary</button>' +
                    '<button class="prio-card-tab" onclick="event.stopPropagation();switchPrioTab(\'' + cardId + '\',\'notes\')">Notes</button>' +
                '</div>' +
                '<div class="prio-card-content" id="' + cardId + '">' +
                    '<div class="prio-card-panel active" data-panel="summary">' +
                        '<div class="prio-card-summary">' + (summary ? escapeHtml(summary) : '<span style="color:rgba(255,255,255,0.4)">No summary available</span>') + '</div>' +
                    '</div>' +
                    '<div class="prio-card-panel" data-panel="notes">' +
                        '<div class="prio-card-notes-list">' + notesHtml + '</div>' +
                    '</div>' +
                '</div>' +
                '<div class="prio-card-footer">' +
                    '<button class="btn-share" onclick="event.stopPropagation()" title="Share lead">+ Share</button>' +
                    '<button class="btn-unprio" onclick="event.stopPropagation();unprio(\'' + lead.id + '\')">Unprio</button>' +
                '</div>' +
            '</div>';
        }).join('');
    }
    
    // Switch tabs on Prio Prospect cards
    function switchPrioTab(cardId, tab) {
        var card = document.getElementById(cardId);
        if (!card) return;
        var tabsContainer = card.previousElementSibling;
        
        // Update tab buttons
        tabsContainer.querySelectorAll('.prio-card-tab').forEach(function(btn) {
            btn.classList.remove('active');
        });
        tabsContainer.querySelector('.prio-card-tab:' + (tab === 'summary' ? 'first-child' : 'last-child')).classList.add('active');
        
        // Update panels
        card.querySelectorAll('.prio-card-panel').forEach(function(panel) {
            panel.classList.remove('active');
            if (panel.dataset.panel === tab) panel.classList.add('active');
        });
    }
    
    // Get color class based on days since last call
    function getLastCalledColor(timestamp) {
        if (!timestamp) return 'lastcall-red';
        var date = new Date(timestamp);
        var now = new Date();
        var diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));
        
        if (diffDays <= 1) return 'lastcall-green';   // Today or yesterday
        if (diffDays <= 3) return 'lastcall-yellow';  // 2-3 days
        if (diffDays <= 6) return 'lastcall-orange';  // 4-6 days
        return 'lastcall-red';                         // 7+ days
    }
    
    // Parse notes as JSON array with date/time
    function parseNotesJson(notesRaw) {
        if (!notesRaw) return [];
        
        // Try to parse as JSON
        try {
            var parsed = JSON.parse(notesRaw);
            if (Array.isArray(parsed)) return parsed;
            // If it's an object with notes array
            if (parsed.notes && Array.isArray(parsed.notes)) return parsed.notes;
        } catch (e) {
            // Not JSON, treat as plain text note
        }
        
        // Convert plain text to JSON format
        if (typeof notesRaw === 'string' && notesRaw.trim()) {
            return [{ text: notesRaw.trim(), date: new Date().toISOString() }];
        }
        
        return [];
    }
    
    // Format note date for display
    function formatNoteDate(dateStr) {
        if (!dateStr) return '';
        var date = new Date(dateStr);
        return date.toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'}) + ' at ' + 
               date.toLocaleTimeString('en-US', {hour: 'numeric', minute: '2-digit'});
    }

    // Helpers
    function escapeHtml(text) {
        if (!text) return '';
        var div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Format date in friendly format: February 1st, 2026, 1:08:32 PM
    function formatFriendlyDateTime(dateStr) {
        if (!dateStr) return 'Unknown time';
        var date = new Date(dateStr);
        if (isNaN(date.getTime())) return 'Unknown time';

        var months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
        var day = date.getDate();
        var suffix = 'th';
        if (day === 1 || day === 21 || day === 31) suffix = 'st';
        else if (day === 2 || day === 22) suffix = 'nd';
        else if (day === 3 || day === 23) suffix = 'rd';

        var hours = date.getHours();
        var ampm = hours >= 12 ? 'PM' : 'AM';
        hours = hours % 12 || 12;
        var minutes = date.getMinutes().toString().padStart(2, '0');
        var seconds = date.getSeconds().toString().padStart(2, '0');

        return months[date.getMonth()] + ' ' + day + suffix + ', ' + date.getFullYear() + ', ' + hours + ':' + minutes + ':' + seconds + ' ' + ampm;
    }

    // Update card display when lead data changes
    function updateLeadCardDisplay(leadId) {
        var lead = allLeads.find(function(l) { return l.id === leadId; });
        if (!lead) return;

        var f = lead.fields;
        var notesRaw = f['Client Notes'] || '';
        var notesArray = parseNotesJson(notesRaw);
        var lastNoteText = notesArray.length > 0 ? notesArray[notesArray.length - 1].text : 'No notes yet';

        // Update priority card (large)
        var priorityCard = document.querySelector('.priority-card-lg[data-id="' + leadId + '"]');
        if (priorityCard) {
            var notesCol = priorityCard.querySelector('.priority-card-lg-notes-col .col-content');
            if (notesCol) {
                notesCol.textContent = lastNoteText;
            }
        }

        // Update prio card (small)
        var prioCard = document.querySelector('.prio-card[data-id="' + leadId + '"]');
        if (prioCard) {
            var notesList = prioCard.querySelector('.prio-card-notes-list');
            if (notesList && notesArray.length > 0) {
                var notesHtml = notesArray.map(function(note) {
                    return '<div class="prio-note-item">' +
                        '<div class="prio-note-text">' + escapeHtml(note.text) + '</div>' +
                        '<div class="prio-note-date">' + formatNoteDate(note.date) + '</div>' +
                    '</div>';
                }).join('');
                notesList.innerHTML = notesHtml;
            } else if (notesList) {
                notesList.innerHTML = '<div style="color:rgba(255,255,255,0.4);font-size:0.8125rem;">No notes yet</div>';
            }
        }
    }

    function formatTimeAgo(dateStr) {
        if (!dateStr) return '';
        var date = new Date(dateStr);
        var now = new Date();
        var diff = Math.floor((now - date) / 1000);
        
        if (diff < 60) return 'Just now';
        if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
        if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
        return Math.floor(diff / 86400) + 'd ago';
    }

    // Settings - populate profile info
    function updateSettingsProfile() {
        if (!currentUser) return;
        var name = currentUser.user_metadata?.full_name || currentUser.user_metadata?.display_name || currentUser.email.split('@')[0];
        var avatar = currentUser.user_metadata?.profile_picture;
        
        document.getElementById('settingsName').textContent = name;
        document.getElementById('settingsEmail').textContent = currentUser.email;
        document.getElementById('settingsDisplayName').value = currentUser.user_metadata?.display_name || '';
        
        if (avatar) {
            document.getElementById('settingsAvatar').innerHTML = '<img src="' + avatar + '" alt="">';
            document.getElementById('settingsRemoveBtn').style.display = 'inline-flex';
        } else {
            document.getElementById('settingsInitial').textContent = name.charAt(0).toUpperCase();
            document.getElementById('settingsRemoveBtn').style.display = 'none';
        }
        
        // Populate from Airtable client record
        if (currentUserRecord && currentUserRecord.fields) {
            var f = currentUserRecord.fields;
            document.getElementById('settingsPhone').value = f['Phone'] || '';
            document.getElementById('settingsCalendar').value = f['Google Calendar Email'] || '';
            if (f['Available Start']) document.getElementById('settingsStart').value = f['Available Start'];
            if (f['Available End']) document.getElementById('settingsEnd').value = f['Available End'];
        }
    }

    // Display Name form
    document.getElementById('displayNameForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        var btn = this.querySelector('button');
        var suc = document.getElementById('displaySuccess');
        var err = document.getElementById('displayError');
        suc.textContent = ''; err.textContent = '';
        btn.disabled = true; btn.textContent = 'Saving...';
        
        try {
            var displayName = document.getElementById('settingsDisplayName').value.trim();
            var result = await supabase.auth.updateUser({ data: { display_name: displayName } });
            if (result.error) throw result.error;
            suc.textContent = ' Display name updated';
            document.getElementById('userName').textContent = displayName || currentUser.email.split('@')[0];
            document.getElementById('settingsName').textContent = displayName || currentUser.email.split('@')[0];
        } catch (ex) {
            err.textContent = ex.message || 'Failed to save';
        }
        btn.disabled = false; btn.textContent = 'Save';
    });

    // Calling Preferences form
    document.getElementById('callingPrefsForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        var btn = this.querySelector('button');
        var suc = document.getElementById('callingSuccess');
        var err = document.getElementById('callingError');
        suc.textContent = ''; err.textContent = '';
        btn.disabled = true; btn.textContent = 'Saving...';
        
        try {
            if (!currentUserRecord) throw new Error('No client record found');
            var path = AIRTABLE_BASE + '/' + AIRTABLE_CLIENTS_TABLE + '/' + currentUserRecord.id;
            var response = await fetchAirtable(path, {
                method: 'PATCH',
                body: { fields: {
                    'Phone': document.getElementById('settingsPhone').value,
                    'Google Calendar Email': document.getElementById('settingsCalendar').value,
                    'Available Start': document.getElementById('settingsStart').value,
                    'Available End': document.getElementById('settingsEnd').value
                }}
            });
            if (!response.ok) throw new Error('Failed to update');
            suc.textContent = ' Preferences saved';
        } catch (ex) {
            err.textContent = ex.message || 'Failed to save';
        }
        btn.disabled = false; btn.textContent = 'Save Changes';
    });

    // Password form
    document.getElementById('passwordForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        var btn = this.querySelector('button');
        var suc = document.getElementById('passwordSuccess');
        var err = document.getElementById('passwordError');
        suc.textContent = ''; err.textContent = '';
        
        var currentPass = document.getElementById('currentPassword').value;
        var newPass = document.getElementById('newPassword').value;
        var confirmPass = document.getElementById('confirmNewPassword').value;
        
        if (!currentPass) {
            err.textContent = 'Please enter your current password';
            return;
        }
        if (newPass !== confirmPass) {
            err.textContent = 'New passwords do not match';
            return;
        }
        if (newPass.length < 8) {
            err.textContent = 'New password must be at least 8 characters';
            return;
        }
        if (currentPass === newPass) {
            err.textContent = 'New password must be different from current';
            return;
        }
        
        btn.disabled = true; btn.textContent = 'Verifying...';
        
        try {
            // Verify current password
            var verifyResult = await supabase.auth.signInWithPassword({
                email: currentUser.email,
                password: currentPass
            });
            if (verifyResult.error) throw new Error('Current password is incorrect');
            
            btn.textContent = 'Updating...';
            var result = await supabase.auth.updateUser({ password: newPass });
            if (result.error) throw result.error;
            suc.textContent = ' Password updated successfully';
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmNewPassword').value = '';
        } catch (ex) {
            err.textContent = ex.message || 'Failed to update password';
        }
        btn.disabled = false; btn.textContent = 'Update Password';
    });

    // Photo upload
    document.getElementById('settingsUploadBtn').addEventListener('click', function() {
        document.getElementById('settingsPhotoInput').click();
    });
    
    document.getElementById('settingsPhotoInput').addEventListener('change', async function() {
        if (!this.files || !this.files[0]) return;
        var file = this.files[0];
        if (file.size > 5 * 1024 * 1024) { showToast('Image too large (max 5MB)', 'error'); return; }
        
        // Simple base64 upload for now
        var reader = new FileReader();
        reader.onload = async function(e) {
            try {
                // Resize to 200x200
                var img = new Image();
                img.onload = async function() {
                    var canvas = document.createElement('canvas');
                    canvas.width = 200; canvas.height = 200;
                    var ctx = canvas.getContext('2d');
                    var size = Math.min(img.width, img.height);
                    var x = (img.width - size) / 2;
                    var y = (img.height - size) / 2;
                    ctx.drawImage(img, x, y, size, size, 0, 0, 200, 200);
                    var resized = canvas.toDataURL('image/jpeg', 0.85);
                    
                    var result = await supabase.auth.updateUser({ data: { profile_picture: resized } });
                    if (result.error) throw result.error;
                    
                    document.getElementById('settingsAvatar').innerHTML = '<img src="' + resized + '" alt="">';
                    document.getElementById('userAvatar').innerHTML = '<img src="' + resized + '" alt="">';
                    document.getElementById('settingsRemoveBtn').style.display = 'inline-flex';
                    showToast('Photo updated', 'success');
                };
                img.src = e.target.result;
            } catch (ex) {
                showToast('Failed to upload photo', 'error');
            }
        };
        reader.readAsDataURL(file);
    });
    
    document.getElementById('settingsRemoveBtn').addEventListener('click', async function() {
        try {
            var result = await supabase.auth.updateUser({ data: { profile_picture: null } });
            if (result.error) throw result.error;
            var name = currentUser.user_metadata?.display_name || currentUser.email.split('@')[0];
            document.getElementById('settingsAvatar').innerHTML = '<span id="settingsInitial">' + name.charAt(0).toUpperCase() + '</span>';
            document.getElementById('userAvatar').textContent = name.charAt(0).toUpperCase();
            this.style.display = 'none';
            showToast('Photo removed', 'success');
        } catch (ex) {
            showToast('Failed to remove photo', 'error');
        }
    });

    // Init
    checkAuth().then(function() {
        if (currentUser) {
            loadUserData().then(function() {
                updateSettingsProfile();
                populateBilling();
            });
        }
    });
    
    // Handle hash
    var hash = window.location.hash.slice(1);
    if (hash && document.getElementById('page-' + hash)) {
        switchPage(hash);
    }
    
    // === HELP SECTION ===
    // Category accordions
    document.querySelectorAll('.help-category-header').forEach(function(header) {
        header.addEventListener('click', function() {
            this.parentElement.classList.toggle('open');
        });
    });
    
    // Item accordions
    document.querySelectorAll('.help-item-header').forEach(function(header) {
        header.addEventListener('click', function() {
            this.parentElement.classList.toggle('open');
        });
    });
    
    // Quick links
    document.querySelectorAll('.help-quick-link').forEach(function(link) {
        link.addEventListener('click', function() {
            var topic = this.dataset.topic;
            var category = document.querySelector('.help-category[data-category="' + topic + '"]');
            if (category) {
                category.classList.add('open');
                category.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        });
    });
    
    // Help search
    var helpSearchInput = document.getElementById('helpSearchInput');
    if (helpSearchInput) {
        helpSearchInput.addEventListener('input', function() {
            var query = this.value.toLowerCase().trim();
            var categories = document.querySelectorAll('.help-category');
            
            if (!query) {
                categories.forEach(function(cat) { cat.style.display = ''; cat.classList.remove('open'); });
                return;
            }
            
            categories.forEach(function(cat) {
                var text = cat.textContent.toLowerCase();
                if (text.includes(query)) {
                    cat.style.display = '';
                    cat.classList.add('open');
                } else {
                    cat.style.display = 'none';
                }
            });
        });
    }
    
    // === BILLING SECTION ===
    // Populate billing data
    function populateBilling() {
        if (!currentUserRecord) return;
        var f = currentUserRecord.fields;
        
        var plan = f['Monthly Plan'] || 'Starter';
        var rate = parseFloat(f['Monthly Rate']) || 0;
        var callLimit = parseInt(f['Call Limit']) || (plan === 'Professional' ? 3000 : 1000);
        var callsUsed = parseInt(f['Calls This Month']) || 0;
        var status = f['Status'] || 'Active';
        
        var planNameEl = document.getElementById('billingPlanName');
        var planPriceEl = document.getElementById('billingPlanPrice');
        var callLimitEl = document.getElementById('billingCallLimit');
        var statusEl = document.getElementById('billingPlanStatus');
        var nextDateEl = document.getElementById('billingNextDate');
        var usageCallsEl = document.getElementById('billingUsageCalls');
        var usageLimitEl = document.getElementById('billingUsageLimit');
        var usagePercentEl = document.getElementById('billingUsagePercent');
        var usageFillEl = document.getElementById('billingUsageFill');
        
        if (planNameEl) planNameEl.textContent = plan;
        if (planPriceEl) planPriceEl.textContent = rate > 0 ? '$' + rate : 'Free';
        if (callLimitEl) callLimitEl.textContent = callLimit.toLocaleString() + ' calls/mo';
        if (statusEl) {
            statusEl.textContent = status;
            statusEl.className = 'billing-status-badge ' + status.toLowerCase();
        }
        if (nextDateEl) nextDateEl.textContent = rate > 0 ? 'Contact support' : 'N/A';
        if (usageCallsEl) usageCallsEl.textContent = callsUsed.toLocaleString();
        if (usageLimitEl) usageLimitEl.textContent = callLimit.toLocaleString();
        
        var usagePercent = callLimit > 0 ? Math.round((callsUsed / callLimit) * 100) : 0;
        if (usagePercentEl) usagePercentEl.textContent = usagePercent + '%';
        if (usageFillEl) {
            usageFillEl.style.width = Math.min(usagePercent, 100) + '%';
            if (usagePercent >= 100) usageFillEl.style.background = 'linear-gradient(90deg,#ef4444,#dc2626)';
            else if (usagePercent >= 80) usageFillEl.style.background = 'linear-gradient(90deg,#f59e0b,#d97706)';
        }
    }
    
    // Billing buttons
    var manageBillingBtn = document.getElementById('manageBillingBtn');
    if (manageBillingBtn) {
        manageBillingBtn.addEventListener('click', function() {
            window.open('mailto:info@prioai.ca?subject=Subscription Inquiry', '_blank');
        });
    }
    var updatePaymentBtn = document.getElementById('updatePaymentBtn');
    if (updatePaymentBtn) {
        updatePaymentBtn.addEventListener('click', function() {
            window.open('mailto:info@prioai.ca?subject=Update Payment Method', '_blank');
        });
    }
    var viewAllInvoicesBtn = document.getElementById('viewAllInvoicesBtn');
    if (viewAllInvoicesBtn) {
        viewAllInvoicesBtn.addEventListener('click', function() {
            window.open('mailto:info@prioai.ca?subject=Invoice Request', '_blank');
        });
    }
    var downloadReceiptBtn = document.getElementById('downloadReceiptBtn');
    if (downloadReceiptBtn) {
        downloadReceiptBtn.addEventListener('click', function() {
            window.open('mailto:info@prioai.ca?subject=Receipt Request', '_blank');
        });
    }
    var upgradePlanBtn = document.getElementById('upgradePlanBtn');
    if (upgradePlanBtn) {
        upgradePlanBtn.addEventListener('click', function() {
            window.location.href = 'https://prioai.ca/pricing';
        });
    }
    
    // === LEAD DETAIL MODAL ===
    var currentLeadId = null;
    var leadModal = document.getElementById('leadModal');
    
    // Open modal when clicking PRIO card
    document.getElementById('prioList').addEventListener('click', function(e) {
        var card = e.target.closest('.prio-card');
        if (card) {
            var leadId = card.dataset.id;
            openLeadModal(leadId);
        }
    });
    
    function openLeadModal(leadId) {
        var lead = allLeads.find(function(l) { return l.id === leadId; });
        if (!lead) return;
        
        currentLeadId = leadId;
        var f = lead.fields;
        
        // Populate modal
        var name = ((f['First Name'] || '') + ' ' + (f['Last Name'] || '')).trim() || 'Unknown';
        document.getElementById('modalLeadName').textContent = name;
        document.getElementById('modalPhone').textContent = f['Phone #'] || f['Phone'] || '-';
        
        var status = f['Status'] || f['Outcome'] || 'New';
        var statusEl = document.getElementById('modalStatus');
        statusEl.textContent = status;
        statusEl.className = 'status-badge status-' + status.toLowerCase().replace(/\s+/g, '-');
        
        var lastUpdated = f['Updated At'];
        document.getElementById('modalLastCalled').textContent = lastUpdated ? formatTimeAgo(lastUpdated) : 'Never';
        
        // Booked Time with edit/delete buttons
        var bookedTime = f['Booked Time'];
        var bookedTimeContainer = document.getElementById('modalBookedTime');
        var bookedTimeValue = document.getElementById('modalBookedTimeValue');
        var scheduleBtn = document.getElementById('modalScheduleBtn');
        if (bookedTime) {
            bookedTimeValue.innerHTML = '<span class="booked-time-display"><span class="booked-time-value">' + formatFriendlyDateTime(bookedTime) + '</span><button class="btn-edit-booking" onclick="editBookingFromModal()" title="Edit booking"></button><button class="btn-delete-booking" onclick="deleteBookingFromModal()" title="Remove booking"></button></span>';
            scheduleBtn.style.display = 'none';
        } else {
            bookedTimeValue.textContent = '-';
            scheduleBtn.style.display = 'inline-flex';
        }
        
        document.getElementById('modalSummary').textContent = f['Last Call Summary'] || f['Summary'] || 'No summary available';
        
        // Share button state and shared info display
        var shareBtn = document.getElementById('modalShareBtn');
        var sharedWithEmail = f['Shared With Email'];
        if (Array.isArray(sharedWithEmail)) sharedWithEmail = sharedWithEmail[0] || '';
        var isSharedToUser = lead.isShared;
        var sharedInfoDiv = document.getElementById('modalSharedInfo');
        var sharedLabel = document.getElementById('modalSharedLabel');
        var sharedValue = document.getElementById('modalSharedValue');

        if (sharedWithEmail || isSharedToUser) {
            shareBtn.classList.add('shared');
            shareBtn.innerHTML = ' ' + (isSharedToUser ? 'Shared with you' : 'Shared');

            // Show shared info in modal
            sharedInfoDiv.style.display = 'block';
            if (isSharedToUser) {
                sharedLabel.textContent = ' Shared By';
                var ownerEmail = f['Client Email'];
                if (Array.isArray(ownerEmail)) ownerEmail = ownerEmail[0] || '';
                sharedValue.textContent = getAgentNameByEmail(ownerEmail) || ownerEmail || 'Unknown';
            } else {
                sharedLabel.textContent = ' Shared With';
                sharedValue.textContent = getAgentNameByEmail(sharedWithEmail) || sharedWithEmail || 'Unknown';
            }
        } else {
            shareBtn.classList.remove('shared');
            shareBtn.innerHTML = ' Share';
            sharedInfoDiv.style.display = 'none';
        }
        
        // Notes with edit/delete - using JSON array format
        var notesRaw = f['Client Notes'] || f['Notes'] || '';
        var notesList = document.getElementById('modalNotesList');
        var notesArr = parseNotesJson(notesRaw);
        if (notesArr.length > 0) {
            notesList.innerHTML = notesArr.map(function(note, idx) {
                var dateStr = note.date ? formatNoteDate(note.date) : '';
                return '<div class="lead-note-item" data-note-index="' + idx + '">' +
                    '<div class="note-content">' + escapeHtml(note.text) + '</div>' +
                    (dateStr ? '<div class="note-date">' + dateStr + '</div>' : '') +
                    '<div class="note-actions"><button class="btn-edit-note" onclick="editNote(' + idx + ')" title="Edit"></button><button class="btn-delete-note" onclick="deleteNote(' + idx + ')" title="Delete"></button></div>' +
                '</div>';
            }).join('');
        } else {
            notesList.innerHTML = '<p style="color:rgba(255,255,255,0.4);font-size:0.8125rem;">No notes yet</p>';
        }
        document.getElementById('modalNotesInput').value = '';
        
        // Attempts - parse JSON if available
        var attemptsRaw = f['Client Attempts'] || '[]';
        var attemptsArray = [];
        try {
            if (typeof attemptsRaw === 'string') {
                attemptsArray = JSON.parse(attemptsRaw);
            } else if (Array.isArray(attemptsRaw)) {
                attemptsArray = attemptsRaw;
            }
        } catch (e) {
            attemptsArray = [];
        }
        var attemptsCount = Array.isArray(attemptsArray) ? attemptsArray.length : 0;
        document.getElementById('modalAttemptsCount').textContent = attemptsCount;
        var attemptsList = document.getElementById('modalAttemptsList');
        if (attemptsCount > 0) {
            var attemptsHtml = attemptsArray.map(function(attempt, i) {
                var timeStr = attempt.time ? formatFriendlyDateTime(attempt.time) : 'Unknown time';
                return '<div class="lead-attempt-item"><span>Call Attempt #' + (i + 1) + '</span><span style="display:flex;align-items:center;gap:8px;"><span style="color:rgba(255,255,255,0.5);font-size:0.8125rem;">' + timeStr + '</span><button class="btn-delete-attempt" onclick="deleteCallAttempt(' + i + ')" title="Delete"></button></span></div>';
            }).join('');
            attemptsList.innerHTML = attemptsHtml;
        } else {
            attemptsList.innerHTML = '<p style="color:rgba(255,255,255,0.4);font-size:0.8125rem;">No call attempts logged yet</p>';
        }
        
        // Transcript with colored speakers
        var transcript = f['Transcript (from Calls)'];
        var transcriptEl = document.getElementById('modalTranscript');
        if (transcript && transcript.length) {
            var transcriptText = transcript[0];
            var formattedTranscript = formatTranscript(transcriptText, name);
            transcriptEl.innerHTML = formattedTranscript;
        } else {
            transcriptEl.textContent = 'No transcript available';
        }
        
        // PRIO button state and icon
        var prioBtn = document.getElementById('modalPrioBtn');
        var prioIcon = document.getElementById('modalPrioIcon');
        if (f['Is Prio']) {
            prioBtn.classList.add('active');
            prioBtn.textContent = ' PRIO';
            prioIcon.style.display = 'block';
        } else {
            prioBtn.classList.remove('active');
            prioBtn.textContent = ' Mark PRIO';
            prioIcon.style.display = 'none';
        }

        leadModal.classList.add('active');
    }
    
    // Close modal
    document.getElementById('leadModalClose').addEventListener('click', function() {
        leadModal.classList.remove('active');
        currentLeadId = null;
    });
    leadModal.addEventListener('click', function(e) {
        if (e.target === leadModal) {
            leadModal.classList.remove('active');
            currentLeadId = null;
        }
    });
    
    // Save note
    document.getElementById('modalSaveNoteBtn').addEventListener('click', async function() {
        if (!currentLeadId) return;
        var noteText = document.getElementById('modalNotesInput').value.trim();
        if (!noteText) return;

        var btn = this;
        btn.disabled = true;
        btn.textContent = 'Saving...';

        try {
            var lead = allLeads.find(function(l) { return l.id === currentLeadId; });
            var existingNotesRaw = lead.fields['Client Notes'] || '';
            var notesArray = parseNotesJson(existingNotesRaw);
            notesArray.push({ text: noteText, date: new Date().toISOString() });
            var newNotes = JSON.stringify(notesArray);

            await fetchAirtable(AIRTABLE_BASE + '/' + AIRTABLE_LEADS_TABLE + '/' + currentLeadId, {
                method: 'PATCH',
                body: { fields: { 'Client Notes': newNotes } }
            });

            lead.fields['Client Notes'] = newNotes;
            document.getElementById('modalNotesInput').value = '';
            openLeadModal(currentLeadId); // Refresh modal
            updateLeadCardDisplay(currentLeadId); // Update card live
            showToast('Note saved', 'success');
        } catch (err) {
            showToast('Failed to save note', 'error');
        }
        btn.disabled = false;
        btn.textContent = ' Save';
    });

    // === VOICE INPUT ===
    var voiceRecognition = null;
    var isRecording = false;

    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        var SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        voiceRecognition = new SpeechRecognition();
        voiceRecognition.continuous = true;
        voiceRecognition.interimResults = false;
        voiceRecognition.lang = 'en-US';

        voiceRecognition.onresult = function(event) {
            var transcript = '';
            for (var i = event.resultIndex; i < event.results.length; i++) {
                if (event.results[i].isFinal) {
                    transcript += event.results[i][0].transcript;
                }
            }
            if (transcript) {
                var input = document.getElementById('modalNotesInput');
                var currentText = input.value;
                input.value = currentText + (currentText ? ' ' : '') + transcript.trim();
            }
        };

        voiceRecognition.onerror = function(event) {
            console.error('Voice error:', event.error);
            stopVoiceRecording();
            if (event.error === 'not-allowed') {
                showToast('Microphone access denied. Please enable in browser settings.', 'error');
            }
        };

        voiceRecognition.onend = function() {
            if (isRecording) {
                voiceRecognition.start();
            }
        };
    }

    async function startVoiceRecording() {
        if (!voiceRecognition) {
            showToast('Voice input not supported in this browser', 'error');
            return;
        }

        // First request microphone permission explicitly
        try {
            var stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            // Permission granted - stop the stream immediately, we just needed the permission
            stream.getTracks().forEach(function(track) { track.stop(); });
        } catch (permErr) {
            console.error('Microphone permission error:', permErr);
            if (permErr.name === 'NotAllowedError' || permErr.name === 'PermissionDeniedError') {
                showToast('Microphone access denied. Please allow microphone in browser settings.', 'error');
            } else if (permErr.name === 'NotFoundError') {
                showToast('No microphone found. Please connect a microphone.', 'error');
            } else {
                showToast('Failed to access microphone: ' + permErr.message, 'error');
            }
            return;
        }

        var input = document.getElementById('modalNotesInput');
        input.dataset.baseText = input.value;
        document.getElementById('voiceInputBtn').classList.add('recording');
        isRecording = true;
        try {
            voiceRecognition.start();
            showToast('Listening... Speak now', 'success');
        } catch (err) {
            console.error('Voice start error:', err);
            stopVoiceRecording();
            showToast('Failed to start voice input. Please check microphone permissions.', 'error');
        }
    }

    function stopVoiceRecording() {
        isRecording = false;
        document.getElementById('voiceInputBtn').classList.remove('recording');
        if (voiceRecognition) {
            voiceRecognition.stop();
        }
        var input = document.getElementById('modalNotesInput');
        delete input.dataset.baseText;
    }

    document.getElementById('voiceInputBtn').addEventListener('click', async function() {
        if (isRecording) {
            stopVoiceRecording();
        } else {
            await startVoiceRecording();
        }
    });

    // === POLISH NOTES WITH AI ===
    var POLISH_NOTES_ENDPOINT = 'https://n8n.prioai.ca/webhook/clean-notes';
    var polishedText = '';

    document.getElementById('polishNotesBtn').addEventListener('click', async function() {
        var noteText = document.getElementById('modalNotesInput').value.trim();
        if (!noteText) {
            showToast('Please enter a note first', 'warning');
            return;
        }
        if (noteText.length < 10) {
            showToast('Note too short to polish', 'warning');
            return;
        }

        var btn = this;
        btn.disabled = true;
        btn.innerHTML = ' Polishing...';

        try {
            var response = await fetch(POLISH_NOTES_ENDPOINT, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ notes: noteText })
            });

            if (!response.ok) {
                throw new Error('Polish API error: ' + response.status);
            }

            var data = await response.json();
            if (data.polished || data.cleaned || data.result) {
                polishedText = data.polished || data.cleaned || data.result;
                document.getElementById('polishOriginalText').textContent = noteText;
                document.getElementById('polishNewText').textContent = polishedText;
                document.getElementById('polishPreviewModal').classList.add('active');
            } else {
                throw new Error(data.error || 'Failed to polish notes');
            }
        } catch (err) {
            console.error('Polish error:', err);
            showToast('Polish failed: ' + err.message, 'error');
        }
        btn.disabled = false;
        btn.innerHTML = ' Polish';
    });

    document.getElementById('polishAcceptBtn').addEventListener('click', function() {
        document.getElementById('modalNotesInput').value = polishedText;
        document.getElementById('polishPreviewModal').classList.remove('active');
        showToast('Polished note applied!', 'success');
    });

    document.getElementById('polishRejectBtn').addEventListener('click', function() {
        document.getElementById('polishPreviewModal').classList.remove('active');
    });

    // Log call attempt
    document.getElementById('modalLogAttemptBtn').addEventListener('click', async function() {
        if (!currentLeadId) return;
        var btn = this;
        btn.disabled = true;
        btn.textContent = 'Logging...';

        try {
            var lead = allLeads.find(function(l) { return l.id === currentLeadId; });
            var attemptsRaw = lead.fields['Client Attempts'] || '[]';
            var attemptsArray = [];
            try {
                attemptsArray = typeof attemptsRaw === 'string' ? JSON.parse(attemptsRaw) : (Array.isArray(attemptsRaw) ? attemptsRaw : []);
            } catch (e) {
                attemptsArray = [];
            }

            // Add new attempt with current timestamp
            attemptsArray.push({ time: new Date().toISOString(), note: '' });

            await fetchAirtable(AIRTABLE_BASE + '/' + AIRTABLE_LEADS_TABLE + '/' + currentLeadId, {
                method: 'PATCH',
                body: { fields: { 'Client Attempts': JSON.stringify(attemptsArray) } }
            });

            lead.fields['Client Attempts'] = JSON.stringify(attemptsArray);
            openLeadModal(currentLeadId);
            showToast('Call attempt logged', 'success');
        } catch (err) {
            console.error('Log attempt error:', err);
            showToast('Failed to log call: ' + err.message, 'error');
        }
        btn.disabled = false;
        btn.textContent = '+ Log Call Attempt';
    });
    
    // Unprio from table
    async function unprio(leadId) {
        try {
            await fetchAirtable(AIRTABLE_BASE + '/' + AIRTABLE_LEADS_TABLE + '/' + leadId, {
                method: 'PATCH',
                body: { fields: { 'Is Prio': false } }
            });
            var lead = allLeads.find(function(l) { return l.id === leadId; });
            if (lead) lead.fields['Is Prio'] = false;
            updatePrioList();
            showToast('Removed from PRIO', 'success');
        } catch (err) {
            showToast('Failed to update', 'error');
        }
    }
    
    // Toggle PRIO
    document.getElementById('modalPrioBtn').addEventListener('click', async function() {
        if (!currentLeadId) return;
        var btn = this;
        btn.disabled = true;

        try {
            var lead = allLeads.find(function(l) { return l.id === currentLeadId; });
            var newPrioStatus = !lead.fields['Is Prio'];

            await fetchAirtable(AIRTABLE_BASE + '/' + AIRTABLE_LEADS_TABLE + '/' + currentLeadId, {
                method: 'PATCH',
                body: { fields: { 'Is Prio': newPrioStatus } }
            });

            lead.fields['Is Prio'] = newPrioStatus;
            openLeadModal(currentLeadId);
            updatePrioList();
            showToast(newPrioStatus ? 'Marked as PRIO' : 'Removed from PRIO', 'success');
        } catch (err) {
            showToast('Failed to update', 'error');
        }
        btn.disabled = false;
    });

    // Send Back to AI - Open modal
    var sendAILeadId = null;
    var sendAISelectedReason = null;
    var sendAISelectedMonths = null;
    var sendAISelectedTime = 'Afternoon';

    document.getElementById('modalSendBackBtn').addEventListener('click', function() {
        if (!currentLeadId) return;
        sendAILeadId = currentLeadId;
        sendAISelectedReason = null;
        sendAISelectedMonths = null;
        sendAISelectedTime = 'Afternoon';

        // Reset modal state
        document.querySelectorAll('#sendAIReasons .reason-btn').forEach(function(btn) { btn.classList.remove('active'); });
        document.querySelectorAll('#sendAITiming .timing-btn').forEach(function(btn) { btn.classList.remove('active'); });
        document.querySelectorAll('#sendAITimePref .time-pref-btn').forEach(function(btn) { btn.classList.remove('active'); });
        document.querySelector('#sendAITimePref .time-pref-btn[data-time="Afternoon"]').classList.add('active');
        document.getElementById('sendAIOtherReason').style.display = 'none';
        document.getElementById('sendAIOtherReason').value = '';
        document.getElementById('sendAICalendar').style.display = 'none';
        document.getElementById('sendAICustomDate').value = '';
        document.getElementById('sendAIConfirmBtn').disabled = true;

        document.getElementById('sendAIModal').classList.add('active');
    });

    // Reason buttons
    document.querySelectorAll('#sendAIReasons .reason-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            document.querySelectorAll('#sendAIReasons .reason-btn').forEach(function(b) { b.classList.remove('active'); });
            this.classList.add('active');
            sendAISelectedReason = this.dataset.reason;

            var otherInput = document.getElementById('sendAIOtherReason');
            if (sendAISelectedReason === 'other') {
                otherInput.style.display = 'block';
                otherInput.focus();
            } else {
                otherInput.style.display = 'none';
            }
            updateSendAIConfirmState();
        });
    });

    // Timing buttons
    // Calendar state
    var calendarDate = new Date();
    var selectedCalendarDate = null;

    function renderSendAICalendar() {
        var year = calendarDate.getFullYear();
        var month = calendarDate.getMonth();
        var today = new Date();
        today.setHours(0,0,0,0);

        var monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                          'July', 'August', 'September', 'October', 'November', 'December'];
        document.getElementById('sendAICalMonth').textContent = monthNames[month] + ' ' + year;

        var firstDay = new Date(year, month, 1).getDay();
        var daysInMonth = new Date(year, month + 1, 0).getDate();

        var daysHtml = '';
        // Empty cells for days before first
        for (var i = 0; i < firstDay; i++) {
            daysHtml += '<span class="calendar-day empty"></span>';
        }
        // Days of month
        for (var d = 1; d <= daysInMonth; d++) {
            var dateObj = new Date(year, month, d);
            dateObj.setHours(0,0,0,0);
            var dateStr = year + '-' + String(month + 1).padStart(2, '0') + '-' + String(d).padStart(2, '0');
            var isPast = dateObj.getTime() <= today.getTime(); // Block today and past dates - first selectable is tomorrow
            var isSelected = selectedCalendarDate === dateStr;
            var classes = 'calendar-day';
            if (isPast) classes += ' past';
            if (isSelected) classes += ' selected';
            daysHtml += '<span class="' + classes + '" data-date="' + dateStr + '"' + (isPast ? '' : '') + '>' + d + '</span>';
        }
        document.getElementById('sendAICalDays').innerHTML = daysHtml;

        // Add click handlers
        document.querySelectorAll('#sendAICalDays .calendar-day:not(.empty):not(.past)').forEach(function(day) {
            day.addEventListener('click', function() {
                selectedCalendarDate = this.dataset.date;
                document.getElementById('sendAICustomDate').value = selectedCalendarDate;
                renderSendAICalendar();
                updateSendAIConfirmState();
            });
        });
    }

    // Calendar navigation
    document.getElementById('sendAICalPrev').addEventListener('click', function() {
        calendarDate.setMonth(calendarDate.getMonth() - 1);
        renderSendAICalendar();
    });
    document.getElementById('sendAICalNext').addEventListener('click', function() {
        calendarDate.setMonth(calendarDate.getMonth() + 1);
        renderSendAICalendar();
    });

    document.querySelectorAll('#sendAITiming .timing-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            document.querySelectorAll('#sendAITiming .timing-btn').forEach(function(b) { b.classList.remove('active'); });
            this.classList.add('active');
            sendAISelectedMonths = this.dataset.months;

            var calendar = document.getElementById('sendAICalendar');
            if (sendAISelectedMonths === 'custom') {
                calendar.style.display = 'block';
                calendarDate = new Date();
                selectedCalendarDate = null;
                document.getElementById('sendAICustomDate').value = '';
                renderSendAICalendar();
            } else {
                calendar.style.display = 'none';
            }
            updateSendAIConfirmState();
        });
    });

    // Time preference buttons
    document.querySelectorAll('#sendAITimePref .time-pref-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            document.querySelectorAll('#sendAITimePref .time-pref-btn').forEach(function(b) { b.classList.remove('active'); });
            this.classList.add('active');
            sendAISelectedTime = this.dataset.time;
        });
    });

    function updateSendAIConfirmState() {
        var reasonValid = sendAISelectedReason && (sendAISelectedReason !== 'other' || document.getElementById('sendAIOtherReason').value.trim());
        var timingValid = sendAISelectedMonths && (sendAISelectedMonths !== 'custom' || document.getElementById('sendAICustomDate').value);
        document.getElementById('sendAIConfirmBtn').disabled = !(reasonValid && timingValid);
    }

    document.getElementById('sendAIOtherReason').addEventListener('input', updateSendAIConfirmState);
    document.getElementById('sendAICustomDate').addEventListener('change', updateSendAIConfirmState);

    // Cancel button
    document.getElementById('sendAICancelBtn').addEventListener('click', function() {
        document.getElementById('sendAIModal').classList.remove('active');
    });

    // Confirm Send to AI
    document.getElementById('sendAIConfirmBtn').addEventListener('click', async function() {
        if (!sendAILeadId) return;

        var btn = this;
        btn.disabled = true;
        btn.textContent = 'Sending...';

        try {
            // Calculate callback date
            var callbackDate;
            if (sendAISelectedMonths === 'custom') {
                callbackDate = document.getElementById('sendAICustomDate').value;
            } else {
                var months = parseInt(sendAISelectedMonths);
                var date = new Date();
                date.setMonth(date.getMonth() + months);
                callbackDate = date.toISOString().split('T')[0];
            }

            // Get reason text
            var reasonText = sendAISelectedReason === 'other'
                ? document.getElementById('sendAIOtherReason').value.trim()
                : sendAISelectedReason;

            // Format callback date as friendly date with year
            var callbackDateObj = new Date(callbackDate + 'T12:00:00');
            var months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            var day = callbackDateObj.getDate();
            var suffix = ['th', 'st', 'nd', 'rd'][(day % 100 > 10 && day % 100 < 14) ? 0 : (day % 10 < 4 ? day % 10 : 0)];
            var friendlyDate = months[callbackDateObj.getMonth()] + ' ' + day + suffix + ', ' + callbackDateObj.getFullYear();

            // Build note with new format: "Sent back to AI - Reason: [reason] | Callback Scheduled: [date] in the [time]"
            var noteText = 'Sent back to AI - Reason: ' + reasonText + ' | Callback Scheduled: ' + friendlyDate + ' in the ' + sendAISelectedTime;

            // Calculate Next Call Date based on time of day
            var timeHour = 9; // Default Morning
            if (sendAISelectedTime === 'Afternoon') timeHour = 13;
            else if (sendAISelectedTime === 'Evening') timeHour = 17;

            var nextCallDate = new Date(callbackDate + 'T00:00:00');
            nextCallDate.setHours(timeHour, 0, 0, 0);
            var nextCallDateISO = nextCallDate.toISOString();

            // Get existing notes as JSON array and add new note
            var lead = allLeads.find(function(l) { return l.id === sendAILeadId; });
            var existingNotesRaw = lead?.fields['Client Notes'] || '';
            var notesArray = parseNotesJson(existingNotesRaw);
            notesArray.push({ text: noteText, date: new Date().toISOString() });
            var newNotes = JSON.stringify(notesArray);

            // Update lead with Client Notes, Status, Last Outcome, and Next Call Date
            await fetchAirtable(AIRTABLE_BASE + '/' + AIRTABLE_LEADS_TABLE + '/' + sendAILeadId, {
                method: 'PATCH',
                body: {
                    fields: {
                        'Client Notes': newNotes,
                        'Status': 'Follow Up',
                        'Last Outcome': 'Follow Up',
                        'Next Call Date': nextCallDateISO
                    }
                }
            });

            // Remove lead from local data (it's being sent back to AI)
            allLeads = allLeads.filter(function(l) { return l.id !== sendAILeadId; });

            document.getElementById('sendAIModal').classList.remove('active');
            document.getElementById('leadModal').classList.remove('active');
            showToast('Lead sent back to AI for follow-up', 'success');

            // Refresh dashboard views
            updateDashboard();
            updatePrioList();
        } catch (err) {
            showToast('Failed: ' + err.message, 'error');
        }
        btn.disabled = false;
        btn.textContent = 'Send to AI';
    });

    // Do Not Call from modal
    document.getElementById('modalDNCBtn')?.addEventListener('click', async function() {
        if (!currentLeadId) return;

        var confirmed = await showConfirmModal(
            'Mark as Do Not Call?',
            'This lead will be marked as DNC and removed from all call queues. This action cannot be undone.',
            '',
            true
        );
        if (!confirmed) return;

        var btn = this;
        btn.disabled = true;

        try {
            // Update Status to DNC, Last Outcome to DNC, and set Is Prio to false
            await fetchAirtable(AIRTABLE_BASE + '/' + AIRTABLE_LEADS_TABLE + '/' + currentLeadId, {
                method: 'PATCH',
                body: { fields: { 'Status': 'DNC', 'Last Outcome': 'DNC', 'Is Prio': false } }
            });

            // Remove from local data and update UI immediately
            allLeads = allLeads.filter(function(l) { return l.id !== currentLeadId; });

            showToast('Lead marked as Do Not Call', 'success');
            document.getElementById('leadModal').classList.remove('active');
            updateDashboard();
            updatePrioList();
        } catch (err) {
            showToast('Failed to update: ' + err.message, 'error');
        }
        btn.disabled = false;
    });

    // Quick action functions for priority cards
    async function quickShareLead(leadId) {
        currentLeadId = leadId;
        var lead = allLeads.find(function(l) { return l.id === leadId; });
        if (!lead) return;

        var sharedWithEmail = lead.fields['Shared With Email'];
        if (Array.isArray(sharedWithEmail)) sharedWithEmail = sharedWithEmail[0] || '';

        if (lead.isShared || sharedWithEmail) {
            openShareInfoPopup(lead);
        } else {
            openSharePopup(leadId);
        }
    }

    function quickSendToAI(leadId) {
        // Open the Send to AI modal
        sendAILeadId = leadId;
        sendAISelectedReason = null;
        sendAISelectedMonths = null;
        sendAISelectedTime = 'Afternoon';

        // Reset modal state
        document.querySelectorAll('#sendAIReasons .reason-btn').forEach(function(btn) { btn.classList.remove('active'); });
        document.querySelectorAll('#sendAITiming .timing-btn').forEach(function(btn) { btn.classList.remove('active'); });
        document.querySelectorAll('#sendAITimePref .time-pref-btn').forEach(function(btn) { btn.classList.remove('active'); });
        document.querySelector('#sendAITimePref .time-pref-btn[data-time="Afternoon"]').classList.add('active');
        document.getElementById('sendAIOtherReason').style.display = 'none';
        document.getElementById('sendAIOtherReason').value = '';
        document.getElementById('sendAICalendar').style.display = 'none';
        document.getElementById('sendAICustomDate').value = '';
        document.getElementById('sendAIConfirmBtn').disabled = true;

        document.getElementById('sendAIModal').classList.add('active');
    }

    async function quickMarkDNC(leadId) {
        var confirmed = await showConfirmModal(
            'Mark as Do Not Call?',
            'This lead will be removed from all call queues. This action cannot be undone.',
            '',
            true
        );
        if (!confirmed) return;

        try {
            // Update Status to DNC, Last Outcome to DNC, and set Is Prio to false
            await fetchAirtable(AIRTABLE_BASE + '/' + AIRTABLE_LEADS_TABLE + '/' + leadId, {
                method: 'PATCH',
                body: { fields: { 'Status': 'DNC', 'Last Outcome': 'DNC', 'Is Prio': false } }
            });

            // Remove from local data and update UI immediately
            allLeads = allLeads.filter(function(l) { return l.id !== leadId; });

            showToast('Marked as DNC', 'success');
            updateDashboard();
            updatePrioList();
        } catch (err) {
            showToast('Failed: ' + err.message, 'error');
        }
    }

    function quickReschedule(leadId) {
        currentLeadId = leadId;
        var lead = allLeads.find(function(l) { return l.id === leadId; });
        if (lead) {
            scheduleLeadId = leadId;
            scheduleLeadData = lead.fields;
            var name = ((lead.fields['First Name'] || '') + ' ' + (lead.fields['Last Name'] || '')).trim() || 'Lead';
            document.getElementById('scheduleLeadName').textContent = 'Scheduling for: ' + name;
            calendarMonth = new Date();
            selectedDate = null;
            renderCalendar();
            document.getElementById('scheduleModal').classList.add('active');
        }
    }

    // Format transcript with colored speakers
    function formatTranscript(text, prospectName) {
        if (!text) return 'No transcript available';
        var lines = text.split('\n');
        var firstName = prospectName ? prospectName.split(' ')[0] : 'Lead';
        return lines.map(function(line) {
            var trimmed = line.trim();
            if (!trimmed) return '';
            var lowerLine = trimmed.toLowerCase();

            // Agent/AI lines - show as "Prio AI" in white
            if (lowerLine.startsWith('agent:') || lowerLine.startsWith('prio ai:') || lowerLine.startsWith('prio:') || lowerLine.startsWith('ai:') || lowerLine.startsWith('sarah:')) {
                var colonIdx = trimmed.indexOf(':');
                return '<div class="lead-transcript-line"><span class="speaker-ai">Prio AI:</span>' + escapeHtml(trimmed.slice(colonIdx + 1)) + '</div>';
            }
            // User lines - show as lead name in green
            if (lowerLine.startsWith('user:')) {
                var colonIdx = trimmed.indexOf(':');
                return '<div class="lead-transcript-line"><span class="speaker-prospect">' + escapeHtml(firstName) + ':</span>' + escapeHtml(trimmed.slice(colonIdx + 1)) + '</div>';
            }
            // Other speaker lines
            if (trimmed.includes(':')) {
                var colonIdx = trimmed.indexOf(':');
                var speaker = trimmed.slice(0, colonIdx);
                var content = trimmed.slice(colonIdx + 1);
                // Check if it's a name-like speaker (no spaces before colon means it's a name)
                if (speaker.indexOf(' ') === -1 || speaker.length < 20) {
                    return '<div class="lead-transcript-line"><span class="speaker-prospect">' + escapeHtml(firstName) + ':</span>' + escapeHtml(content) + '</div>';
                }
            }
            return '<div class="lead-transcript-line">' + escapeHtml(trimmed) + '</div>';
        }).filter(function(l) { return l; }).join('');
    }
    
    // === SHARE FUNCTIONALITY ===
    var currentShareLeadId = null;
    var shareableAgents = [];
    var allActiveAgents = [];
    
    // Fetch all active agents
    async function fetchAllActiveAgents() {
        try {
            var response = await fetchAirtable(AIRTABLE_BASE + '/' + AIRTABLE_CLIENTS_TABLE + '?filterByFormula={Status}="Active"');
            allActiveAgents = response.records.map(function(r) {
                return { id: r.id, name: r.fields['Agent Name'] || 'Unknown', email: r.fields['Email'] || '' };
            });
        } catch (err) {
            console.error('Error fetching agents:', err);
        }
        return allActiveAgents;
    }
    
    // Fetch agents current user can share with
    async function fetchShareableAgents() {
        shareableAgents = [];
        try {
            var canShareWith = currentUserRecord?.fields['Can Share With'] || '';
            if (!canShareWith.trim()) return shareableAgents;
            
            var allowedEmails = canShareWith.split(',').map(function(e) { return e.trim().toLowerCase(); }).filter(function(e) { return e; });
            if (allowedEmails.length === 0) return shareableAgents;
            
            if (allActiveAgents.length === 0) await fetchAllActiveAgents();
            
            shareableAgents = allActiveAgents.filter(function(a) {
                return a.email && currentUser && a.email.toLowerCase() !== currentUser.email.toLowerCase() && allowedEmails.includes(a.email.toLowerCase());
            });
        } catch (err) {
            console.error('Error fetching shareable agents:', err);
        }
        return shareableAgents;
    }
    
    function getAgentNameByEmail(email) {
        if (Array.isArray(email)) email = email[0] || '';
        if (!email) return 'Unknown';
        var agent = allActiveAgents.find(function(a) { return a.email && a.email.toLowerCase() === email.toLowerCase(); });
        if (agent) return agent.name;
        return email.split('@')[0];
    }
    
    // Share button click
    document.getElementById('modalShareBtn').addEventListener('click', async function() {
        if (!currentLeadId) return;
        var lead = allLeads.find(function(l) { return l.id === currentLeadId; });
        if (!lead) return;
        
        var sharedWithEmail = lead.fields['Shared With Email'];
        if (Array.isArray(sharedWithEmail)) sharedWithEmail = sharedWithEmail[0] || '';
        
        if (lead.isShared || sharedWithEmail) {
            // Show info popup
            openShareInfoPopup(lead);
        } else {
            // Show share popup
            openSharePopup(currentLeadId);
        }
    });
    
    async function openSharePopup(leadId) {
        currentShareLeadId = leadId;
        var popup = document.getElementById('shareLeadPopup');
        var overlay = document.getElementById('sharePopupOverlay');
        var agentsList = document.getElementById('shareAgentsList');
        var confirmBtn = document.getElementById('sharePopupConfirm');
        
        var agents = await fetchShareableAgents();
        
        if (agents.length === 0) {
            agentsList.innerHTML = '<p style="color:rgba(255,255,255,0.5);text-align:center;padding:12px;">You don\'t have permission to share prospects with other agents.</p>';
            confirmBtn.disabled = true;
        } else {
            agentsList.innerHTML = agents.map(function(agent) {
                return '<label class="share-agent-option" data-email="' + agent.email + '">' +
                    '<input type="radio" name="shareAgent" value="' + agent.id + '" data-email="' + agent.email + '">' +
                    '<span class="share-agent-radio"></span>' +
                    '<span class="share-agent-name">' + agent.name + '</span>' +
                '</label>';
            }).join('');
            
            agentsList.querySelectorAll('.share-agent-option').forEach(function(opt) {
                opt.addEventListener('click', function() {
                    agentsList.querySelectorAll('.share-agent-option').forEach(function(o) { o.classList.remove('selected'); });
                    this.classList.add('selected');
                    this.querySelector('input').checked = true;
                    confirmBtn.disabled = false;
                });
            });
            confirmBtn.disabled = true;
        }
        
        overlay.classList.add('active');
        popup.classList.add('active');
    }
    
    function openShareInfoPopup(lead) {
        var popup = document.getElementById('shareInfoPopup');
        var overlay = document.getElementById('sharePopupOverlay');
        var content = document.getElementById('shareInfoContent');
        var title = document.getElementById('shareInfoTitle');
        var actionsDiv = document.getElementById('shareInfoActions');

        var sharedWithEmail = lead.fields['Shared With Email'];
        if (Array.isArray(sharedWithEmail)) sharedWithEmail = sharedWithEmail[0] || '';

        currentShareLeadId = lead.id;

        if (lead.isShared) {
            // Lead was shared WITH the current user
            title.textContent = 'Shared With You';
            var ownerEmail = lead.fields['Client Email'];
            if (Array.isArray(ownerEmail)) ownerEmail = ownerEmail[0] || '';
            content.innerHTML = '<div class="share-info-label">Shared By</div><div class="share-info-name">' + getAgentNameByEmail(ownerEmail) + '</div>';
            actionsDiv.style.display = 'none'; // Can't stop sharing if it was shared with you
        } else {
            // Current user shared this lead
            title.textContent = 'You Shared This';
            content.innerHTML = '<div class="share-info-label">Shared With</div><div class="share-info-name">' + getAgentNameByEmail(sharedWithEmail) + '</div>';
            actionsDiv.style.display = 'flex'; // Show Stop Sharing button
        }

        overlay.classList.add('active');
        popup.classList.add('active');
    }
    
    function closeSharePopup() {
        document.getElementById('shareLeadPopup').classList.remove('active');
        document.getElementById('shareInfoPopup').classList.remove('active');
        document.getElementById('sharePopupOverlay').classList.remove('active');
        currentShareLeadId = null;
    }
    
    document.getElementById('sharePopupClose').addEventListener('click', closeSharePopup);
    document.getElementById('sharePopupCancel').addEventListener('click', closeSharePopup);
    document.getElementById('shareInfoClose').addEventListener('click', closeSharePopup);
    document.getElementById('sharePopupOverlay').addEventListener('click', closeSharePopup);

    // Stop Sharing handler
    document.getElementById('stopSharingBtn').addEventListener('click', async function() {
        if (!currentShareLeadId) return;

        var btn = this;
        btn.disabled = true;
        btn.textContent = 'Stopping...';

        // Save the lead ID before closeSharePopup sets it to null
        var leadIdToUpdate = currentShareLeadId;

        try {
            // Clear the Shared With field
            await fetchAirtable(AIRTABLE_BASE + '/' + AIRTABLE_LEADS_TABLE + '/' + leadIdToUpdate, {
                method: 'PATCH',
                body: { fields: { 'Shared With': null } }
            });

            // Update local data
            var lead = allLeads.find(function(l) { return l.id === leadIdToUpdate; });
            if (lead) {
                lead.fields['Shared With Email'] = null;
                lead.fields['Shared With'] = null;
            }

            showToast('Sharing stopped', 'success');
            closeSharePopup();

            // Update the modal share button
            var shareBtn = document.getElementById('modalShareBtn');
            if (shareBtn) {
                shareBtn.classList.remove('shared');
                shareBtn.innerHTML = ' Share';
            }

            // Update card display - remove share icon
            var cardEl = document.querySelector('.prio-card[data-id="' + leadIdToUpdate + '"]');
            if (cardEl) {
                var sharedIcon = cardEl.querySelector('.shared-icon');
                if (sharedIcon) sharedIcon.remove();
                var shareActionBtn = cardEl.querySelector('.action-share');
                if (shareActionBtn) {
                    shareActionBtn.classList.remove('shared');
                    shareActionBtn.innerHTML = '<span class="action-icon"></span><span class="action-label">Share</span>';
                }
            }

            // Update priority card
            var priorityCard = document.querySelector('.priority-card-lg[data-id="' + leadIdToUpdate + '"]');
            if (priorityCard) {
                var prioSharedIcon = priorityCard.querySelector('.shared-icon');
                if (prioSharedIcon) prioSharedIcon.remove();
                // Update quick action share button to show Share
                var shareActionBtn = priorityCard.querySelector('.action-share');
                if (shareActionBtn) {
                    shareActionBtn.classList.remove('shared');
                    shareActionBtn.innerHTML = '<span class="action-icon"></span><span class="action-label">Share</span>';
                }
            }

            // Update modal shared info display
            var sharedInfoDiv = document.getElementById('modalSharedInfo');
            if (sharedInfoDiv) sharedInfoDiv.style.display = 'none';
        } catch (err) {
            showToast('Failed to stop sharing', 'error');
        }
        btn.disabled = false;
        btn.textContent = 'Stop Sharing';
    });

    document.getElementById('sharePopupConfirm').addEventListener('click', async function() {
        if (!currentShareLeadId) return;
        var selectedAgent = document.querySelector('input[name="shareAgent"]:checked');
        if (!selectedAgent) return;

        var selectedAgentId = selectedAgent.value;
        var selectedAgentEmail = selectedAgent.dataset.email;

        var btn = this;
        btn.disabled = true;
        btn.textContent = 'Sharing...';

        // Save the lead ID before closeSharePopup sets it to null
        var leadIdToUpdate = currentShareLeadId;

        try {
            await fetchAirtable(AIRTABLE_BASE + '/' + AIRTABLE_LEADS_TABLE + '/' + leadIdToUpdate, {
                method: 'PATCH',
                body: { fields: { 'Shared With': [selectedAgentId] } }
            });

            var lead = allLeads.find(function(l) { return l.id === leadIdToUpdate; });
            if (lead) {
                lead.fields['Shared With Email'] = selectedAgentEmail;
                lead.fields['Shared With'] = [selectedAgentId];
            }

            showToast('Prospect shared successfully!', 'success');
            closeSharePopup();

            // Update the modal share button immediately
            var shareBtn = document.getElementById('modalShareBtn');
            if (shareBtn) {
                shareBtn.classList.add('shared');
                shareBtn.innerHTML = ' Shared';
            }

            // Update card display immediately - find card and update share icon
            var cardEl = document.querySelector('.prio-card[data-id="' + leadIdToUpdate + '"]');
            if (cardEl) {
                var nameEl = cardEl.querySelector('.prio-card-name');
                if (nameEl && !nameEl.querySelector('.shared-icon')) {
                    nameEl.innerHTML = nameEl.innerHTML + ' <span class="shared-icon" title="Shared lead"></span>';
                }
                // Update quick action share button on small card if present
                var cardShareBtn = cardEl.querySelector('.action-share');
                if (cardShareBtn) {
                    cardShareBtn.classList.add('shared');
                    cardShareBtn.innerHTML = '<span class="action-icon"></span><span class="action-label">Shared</span>';
                }
            }

            // Also update priority card if present
            var priorityCard = document.querySelector('.priority-card-lg[data-id="' + leadIdToUpdate + '"]');
            if (priorityCard) {
                var prioNameEl = priorityCard.querySelector('.priority-card-lg-name');
                if (prioNameEl && !prioNameEl.querySelector('.shared-icon')) {
                    prioNameEl.innerHTML = prioNameEl.innerHTML + ' <span class="shared-icon" title="Shared lead"></span>';
                }
                // Update quick action share button to show Shared
                var shareActionBtn = priorityCard.querySelector('.action-share');
                if (shareActionBtn) {
                    shareActionBtn.classList.add('shared');
                    shareActionBtn.innerHTML = '<span class="action-icon"></span><span class="action-label">Shared</span>';
                }
            }

            // Update modal shared info display
            var sharedInfoDiv = document.getElementById('modalSharedInfo');
            var sharedLabel = document.getElementById('modalSharedLabel');
            var sharedValue = document.getElementById('modalSharedValue');
            if (sharedInfoDiv) {
                sharedInfoDiv.style.display = 'block';
                sharedLabel.textContent = ' Shared With';
                sharedValue.textContent = getAgentNameByEmail(selectedAgentEmail) || selectedAgentEmail;
            }
        } catch (err) {
            showToast('Failed to share prospect', 'error');
        }
        btn.disabled = false;
        btn.textContent = 'Share';
    });
    
    // === SCHEDULE BOOKING FUNCTIONALITY ===
    var scheduleLeadId = null;
    var scheduleLeadData = null;
    var selectedDate = null;
    var calendarMonth = new Date();
    
    // Schedule button click
    document.getElementById('modalScheduleBtn').addEventListener('click', function() {
        if (!currentLeadId) return;
        var lead = allLeads.find(function(l) { return l.id === currentLeadId; });
        if (lead) openScheduleModal(lead.id, lead.fields);
    });
    
    function openScheduleModal(leadId, leadData) {
        scheduleLeadId = leadId;
        scheduleLeadData = leadData;
        var leadName = ((leadData['First Name'] || '') + ' ' + (leadData['Last Name'] || '')).trim() || 'Lead';
        document.getElementById('scheduleLeadName').textContent = 'Scheduling for: ' + leadName;

        var today = new Date();
        today.setHours(0, 0, 0, 0);
        selectedDate = today;
        calendarMonth = new Date();

        renderCalendar();
        updateTimeDropdowns();
        document.getElementById('scheduleModal').classList.add('active');
    }

    function updateTimeDropdowns() {
        var hourSelect = document.getElementById('scheduleHour');
        var minuteSelect = document.getElementById('scheduleMinute');
        var now = new Date();
        var isToday = selectedDate && selectedDate.toDateString() === now.toDateString();

        // Calculate earliest available time (current time + 15 min rounded to nearest 15)
        var earliestHour = 9;
        var earliestMinute = 0;

        if (isToday) {
            var currentMinutes = now.getHours() * 60 + now.getMinutes() + 15;
            currentMinutes = Math.ceil(currentMinutes / 15) * 15;
            earliestHour = Math.floor(currentMinutes / 60);
            earliestMinute = currentMinutes % 60;
            if (earliestMinute >= 60) {
                earliestHour++;
                earliestMinute = 0;
            }
        }

        // Populate hour dropdown (9 AM to 8 PM) - grey out past hours
        var hourOptions = '';
        var firstAvailableHour = null;
        for (var h = 9; h <= 20; h++) {
            var displayHour = h > 12 ? h - 12 : (h === 0 ? 12 : h);
            var ampm = h >= 12 ? 'PM' : 'AM';
            var isPast = isToday && h < earliestHour;
            if (!isPast && firstAvailableHour === null) firstAvailableHour = h;
            hourOptions += '<option value="' + h + '"' + (isPast ? ' disabled style="color:#666"' : '') + '>' + displayHour + ' ' + ampm + '</option>';
        }
        hourSelect.innerHTML = hourOptions;

        // Select first available hour
        hourSelect.value = firstAvailableHour || 9;

        // Update minute dropdown
        updateMinuteDropdown();
    }

    function updateMinuteDropdown() {
        var hourSelect = document.getElementById('scheduleHour');
        var minuteSelect = document.getElementById('scheduleMinute');
        var selectedHour = parseInt(hourSelect.value);
        var now = new Date();
        var isToday = selectedDate && selectedDate.toDateString() === now.toDateString();

        // Calculate earliest available minute for this hour
        var earliestMinute = 0;
        if (isToday) {
            if (selectedHour === now.getHours()) {
                var currentMinutes = now.getMinutes() + 15;
                earliestMinute = Math.ceil(currentMinutes / 15) * 15;
                if (earliestMinute >= 60) earliestMinute = 60; // All minutes in this hour are past
            } else if (selectedHour < now.getHours()) {
                earliestMinute = 60; // All minutes are past
            }
        }

        // Populate minute dropdown - grey out past minutes
        var minuteOptions = '';
        var minutes = [0, 15, 30, 45];
        var firstAvailableMinute = null;
        minutes.forEach(function(m) {
            var isPast = isToday && m < earliestMinute;
            if (!isPast && firstAvailableMinute === null) firstAvailableMinute = m;
            minuteOptions += '<option value="' + m + '"' + (isPast ? ' disabled style="color:#666"' : '') + '>' + (m < 10 ? '0' : '') + m + '</option>';
        });

        minuteSelect.innerHTML = minuteOptions;
        if (firstAvailableMinute !== null) {
            minuteSelect.value = firstAvailableMinute;
        }
    }

    // Update minutes when hour changes
    document.getElementById('scheduleHour').addEventListener('change', updateMinuteDropdown);
    
    function renderCalendar() {
        var year = calendarMonth.getFullYear();
        var month = calendarMonth.getMonth();
        var today = new Date();
        today.setHours(0, 0, 0, 0);
        
        var monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
        document.getElementById('calendarMonth').textContent = monthNames[month] + ' ' + year;
        
        var firstDay = new Date(year, month, 1).getDay();
        var daysInMonth = new Date(year, month + 1, 0).getDate();
        var daysInPrevMonth = new Date(year, month, 0).getDate();
        
        var daysHtml = '';
        
        for (var i = firstDay - 1; i >= 0; i--) {
            var day = daysInPrevMonth - i;
            daysHtml += '<button class="calendar-day other-month disabled">' + day + '</button>';
        }
        
        for (var d = 1; d <= daysInMonth; d++) {
            var date = new Date(year, month, d);
            var isPast = date < today;
            var isToday = date.getTime() === today.getTime();
            var isSelected = selectedDate && date.getTime() === selectedDate.getTime();
            
            var classes = 'calendar-day';
            if (isPast) classes += ' disabled';
            if (isToday) classes += ' today';
            if (isSelected) classes += ' selected';
            
            daysHtml += '<button class="' + classes + '" data-date="' + date.toISOString().split('T')[0] + '"' + (isPast ? ' disabled' : '') + '>' + d + '</button>';
        }
        
        var totalCells = firstDay + daysInMonth;
        var remaining = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
        for (var n = 1; n <= remaining; n++) {
            daysHtml += '<button class="calendar-day other-month disabled">' + n + '</button>';
        }
        
        document.getElementById('calendarDays').innerHTML = daysHtml;
        
        document.querySelectorAll('.calendar-day:not(.disabled)').forEach(function(btn) {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.calendar-day').forEach(function(d) { d.classList.remove('selected'); });
                this.classList.add('selected');
                var parts = this.dataset.date.split('-');
                selectedDate = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                updateTimeDropdowns();
            });
        });
    }
    
    document.getElementById('calendarPrev').addEventListener('click', function() {
        calendarMonth.setMonth(calendarMonth.getMonth() - 1);
        renderCalendar();
    });
    
    document.getElementById('calendarNext').addEventListener('click', function() {
        calendarMonth.setMonth(calendarMonth.getMonth() + 1);
        renderCalendar();
    });
    
    document.getElementById('scheduleCancelBtn').addEventListener('click', function() {
        document.getElementById('scheduleModal').classList.remove('active');
        scheduleLeadId = null;
        scheduleLeadData = null;
    });
    
    document.getElementById('scheduleSaveBtn').addEventListener('click', async function() {
        if (!scheduleLeadId || !selectedDate) return;
        
        var btn = this;
        btn.disabled = true;
        btn.textContent = 'Saving...';
        
        try {
            var hour = parseInt(document.getElementById('scheduleHour').value);
            var minute = parseInt(document.getElementById('scheduleMinute').value);
            
            var bookedDateTime = new Date(selectedDate);
            bookedDateTime.setHours(hour, minute, 0, 0);
            
            await fetchAirtable(AIRTABLE_BASE + '/' + AIRTABLE_LEADS_TABLE + '/' + scheduleLeadId, {
                method: 'PATCH',
                body: { fields: { 'Booked Time': bookedDateTime.toISOString(), 'Status': 'Booked' } }
            });
            
            var lead = allLeads.find(function(l) { return l.id === scheduleLeadId; });
            if (lead) {
                lead.fields['Booked Time'] = bookedDateTime.toISOString();
                lead.fields['Status'] = 'Booked';
            }

            // Sync to Google Calendar via n8n webhook
            var leadName = ((scheduleLeadData['First Name'] || '') + ' ' + (scheduleLeadData['Last Name'] || '')).trim() || 'Lead';
            var phone = scheduleLeadData['Phone #'] || scheduleLeadData['Phone'] || '';
            var email = scheduleLeadData['Email'] || '';
            try {
                await fetch('https://n8n.prioai.ca/webhook/calendar-sync', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        leadId: scheduleLeadId,
                        leadName: leadName,
                        phone: phone,
                        email: email,
                        bookedTime: bookedDateTime.toISOString(),
                        agentEmail: currentUser?.email || '',
                        agentName: currentUser?.name || ''
                    })
                });
            } catch (calErr) {
                console.error('Calendar sync error:', calErr);
            }
            
            document.getElementById('scheduleModal').classList.remove('active');
            if (currentLeadId === scheduleLeadId) openLeadModal(currentLeadId);
            updatePrioList();
            showToast('Meeting scheduled!', 'success');
        } catch (err) {
            showToast('Failed to schedule meeting', 'error');
        }
        btn.disabled = false;
        btn.textContent = 'Save Booking';
    });
    
    // Delete booking
    async function deleteBookingFromModal() {
        if (!currentLeadId) return;

        var confirmed = await showConfirmModal(
            'Remove Booking?',
            'The scheduled meeting will be removed from this lead.',
            '',
            true
        );
        if (!confirmed) return;

        try {
            await fetchAirtable(AIRTABLE_BASE + '/' + AIRTABLE_LEADS_TABLE + '/' + currentLeadId, {
                method: 'PATCH',
                body: { fields: { 'Booked Time': null } }
            });

            var lead = allLeads.find(function(l) { return l.id === currentLeadId; });
            if (lead) lead.fields['Booked Time'] = null;

            openLeadModal(currentLeadId);
            updatePrioList();
            showToast('Booking removed', 'success');
        } catch (err) {
            showToast('Failed to remove booking', 'error');
        }
    }
    // Make available globally for onclick
    window.deleteBookingFromModal = deleteBookingFromModal;

    // Edit booking - opens schedule modal with existing time
    function editBookingFromModal() {
        if (!currentLeadId) return;
        var lead = allLeads.find(function(l) { return l.id === currentLeadId; });
        if (!lead) return;

        var f = lead.fields;
        var leadName = ((f['First Name'] || '') + ' ' + (f['Last Name'] || '')).trim() || 'Unknown';
        document.getElementById('scheduleLeadName').textContent = 'Scheduling for: ' + leadName;
        scheduleLeadId = currentLeadId;
        scheduleLeadData = f;

        // Pre-fill with existing booked time
        var existingTime = f['Booked Time'] ? new Date(f['Booked Time']) : new Date();
        calendarMonth = new Date(existingTime.getFullYear(), existingTime.getMonth(), 1);
        selectedDate = new Date(existingTime);
        selectedDate.setHours(0, 0, 0, 0);

        // Set hour and minute dropdowns
        var hour = existingTime.getHours();
        var minute = existingTime.getMinutes();
        document.getElementById('scheduleHour').value = hour;
        var minuteSelect = document.getElementById('scheduleMinute');
        // Find closest minute option
        var minuteOptions = [0, 15, 30, 45];
        var closestMinute = minuteOptions.reduce(function(prev, curr) {
            return Math.abs(curr - minute) < Math.abs(prev - minute) ? curr : prev;
        });
        minuteSelect.value = closestMinute;

        renderCalendar();
        document.getElementById('scheduleModal').classList.add('active');
    }
    window.editBookingFromModal = editBookingFromModal;

    // Delete call attempt
    async function deleteCallAttempt(index) {
        if (!currentLeadId) return;

        var confirmed = await showConfirmModal(
            'Delete Call Attempt?',
            'This call attempt record will be permanently removed.',
            '',
            true
        );
        if (!confirmed) return;

        try {
            var lead = allLeads.find(function(l) { return l.id === currentLeadId; });
            var attemptsRaw = lead.fields['Client Attempts'] || '[]';
            var attemptsArray = [];
            try {
                attemptsArray = typeof attemptsRaw === 'string' ? JSON.parse(attemptsRaw) : (Array.isArray(attemptsRaw) ? attemptsRaw : []);
            } catch (e) {
                attemptsArray = [];
            }

            // Remove the attempt at the given index
            attemptsArray.splice(index, 1);

            await fetchAirtable(AIRTABLE_BASE + '/' + AIRTABLE_LEADS_TABLE + '/' + currentLeadId, {
                method: 'PATCH',
                body: { fields: { 'Client Attempts': JSON.stringify(attemptsArray) } }
            });

            lead.fields['Client Attempts'] = JSON.stringify(attemptsArray);
            openLeadModal(currentLeadId);
            showToast('Call attempt deleted', 'success');
        } catch (err) {
            showToast('Failed to delete call attempt', 'error');
        }
    }
    window.deleteCallAttempt = deleteCallAttempt;

    // Edit note
    function editNote(index) {
        if (!currentLeadId) return;
        var lead = allLeads.find(function(l) { return l.id === currentLeadId; });
        var notesRaw = lead.fields['Client Notes'] || '';
        var notesArr = parseNotesJson(notesRaw);

        if (index >= notesArr.length) return;

        var note = notesArr[index];
        var noteItem = document.querySelector('.lead-note-item[data-note-index="' + index + '"]');
        if (!noteItem) return;

        // Store original HTML for cancel
        var originalHtml = noteItem.innerHTML;

        // Replace with inline edit form
        noteItem.innerHTML = '<textarea class="note-edit-input">' + escapeHtml(note.text) + '</textarea>' +
            '<div class="note-edit-actions">' +
                '<button class="btn-note-cancel" onclick="cancelNoteEdit(' + index + ')">Cancel</button>' +
                '<button class="btn-note-save" onclick="saveNoteEdit(' + index + ')">Save</button>' +
            '</div>';

        // Store original HTML for cancel
        noteItem.dataset.originalHtml = originalHtml;

        // Focus the textarea
        var textarea = noteItem.querySelector('.note-edit-input');
        if (textarea) {
            textarea.focus();
            textarea.setSelectionRange(textarea.value.length, textarea.value.length);
        }
    }
    window.editNote = editNote;

    function cancelNoteEdit(index) {
        var noteItem = document.querySelector('.lead-note-item[data-note-index="' + index + '"]');
        if (!noteItem || !noteItem.dataset.originalHtml) return;
        noteItem.innerHTML = noteItem.dataset.originalHtml;
        delete noteItem.dataset.originalHtml;
    }
    window.cancelNoteEdit = cancelNoteEdit;

    async function saveNoteEdit(index) {
        if (!currentLeadId) return;
        var lead = allLeads.find(function(l) { return l.id === currentLeadId; });
        var notesRaw = lead.fields['Client Notes'] || '';
        var notesArr = parseNotesJson(notesRaw);

        if (index >= notesArr.length) return;

        var noteItem = document.querySelector('.lead-note-item[data-note-index="' + index + '"]');
        if (!noteItem) return;

        var textarea = noteItem.querySelector('.note-edit-input');
        if (!textarea) return;

        var newText = textarea.value.trim();
        if (!newText) {
            showToast('Note cannot be empty', 'error');
            return;
        }

        if (newText === notesArr[index].text) {
            cancelNoteEdit(index);
            return;
        }

        // Update the note text, keeping the original timestamp
        notesArr[index].text = newText;

        try {
            var newNotes = JSON.stringify(notesArr);
            await fetchAirtable(AIRTABLE_BASE + '/' + AIRTABLE_LEADS_TABLE + '/' + currentLeadId, {
                method: 'PATCH',
                body: { fields: { 'Client Notes': newNotes } }
            });
            lead.fields['Client Notes'] = newNotes;
            openLeadModal(currentLeadId);
            updateLeadCardDisplay(currentLeadId); // Update card live
            showToast('Note updated', 'success');
        } catch (err) {
            showToast('Failed to update note', 'error');
        }
    }
    window.saveNoteEdit = saveNoteEdit;

    // Delete note
    async function deleteNote(index) {
        if (!currentLeadId) return;

        var confirmed = await showConfirmModal(
            'Delete Note?',
            'This note will be permanently removed.',
            '',
            true
        );
        if (!confirmed) return;

        var lead = allLeads.find(function(l) { return l.id === currentLeadId; });
        var notesRaw = lead.fields['Client Notes'] || '';
        var notesArr = parseNotesJson(notesRaw);

        if (index >= notesArr.length) return;

        notesArr.splice(index, 1);

        try {
            var newNotes = JSON.stringify(notesArr);
            await fetchAirtable(AIRTABLE_BASE + '/' + AIRTABLE_LEADS_TABLE + '/' + currentLeadId, {
                method: 'PATCH',
                body: { fields: { 'Client Notes': newNotes } }
            });
            lead.fields['Client Notes'] = newNotes;
            openLeadModal(currentLeadId);
            updateLeadCardDisplay(currentLeadId); // Update card live
            showToast('Note deleted', 'success');
        } catch (err) {
            showToast('Failed to delete note', 'error');
        }
    }
    window.deleteNote = deleteNote;

    // ===== PROSPECTS TAB =====
    var prospectsSort = { field: 'bookedTime', direction: 'desc' };
    
    function updateProspectsTable() {
        var tbody = document.getElementById('prospectsTableBody');
        if (!tbody) return;
        
        // Get Booked/Callback leads (excluding PRIO)
        var searchVal = (document.getElementById('prospectsSearch')?.value || '').toLowerCase();
        var statusFilter = document.getElementById('prospectsStatus')?.value || 'all';
        var ownershipFilter = document.getElementById('prospectsOwnership')?.value || 'all';
        var timeframeFilter = document.getElementById('prospectsTimeframe')?.value || 'all';
        
        var prospects = allLeads.filter(function(l) {
            var f = l.fields;
            var status = f['Status'] || f['Disposition'] || '';
            
            // Only Booked or Callback, and NOT in PRIO
            if (f['Is Prio'] === true) return false;
            if (status !== 'Booked' && status !== 'Appointment Booked' && status !== 'Callback' && status !== 'Callback Requested') return false;
            
            // Status filter
            if (statusFilter !== 'all') {
                if (statusFilter === 'Booked' && !status.includes('Booked')) return false;
                if (statusFilter === 'Callback' && !status.includes('Callback')) return false;
            }
            
            // Search filter
            if (searchVal) {
                var name = ((f['First Name'] || '') + ' ' + (f['Last Name'] || '')).toLowerCase();
                var phone = (f['Phone #'] || f['Phone'] || '').toLowerCase();
                if (!name.includes(searchVal) && !phone.includes(searchVal)) return false;
            }
            
            // Ownership filter
            if (ownershipFilter !== 'all') {
                var isOwned = isLeadOwnedByUser(l);
                var isSharedByMe = !l.isShared && f['Shared With Email'];
                var isSharedWithMe = l.isShared === true;
                
                if (ownershipFilter === 'mine' && !isOwned) return false;
                if (ownershipFilter === 'shared-by' && !isSharedByMe) return false;
                if (ownershipFilter === 'not-shared' && (isSharedByMe || isSharedWithMe)) return false;
                if (ownershipFilter === 'shared-with' && !isSharedWithMe) return false;
            }
            
            // Timeframe filter
            if (timeframeFilter !== 'all') {
                var lastCall = f['Last Call Timestamp'] || f['Client Last Call Timestamp'];
                if (!lastCall) return false;
                var daysDiff = getDaysDiff(new Date(lastCall));
                if (timeframeFilter === 'today' && daysDiff > 0) return false;
                if (timeframeFilter === '7days' && daysDiff > 7) return false;
                if (timeframeFilter === '30days' && daysDiff > 30) return false;
                if (timeframeFilter === '90days' && daysDiff > 90) return false;
            }
            
            return true;
        });
        
        // Sort
        prospects.sort(function(a, b) {
            var aVal, bVal;
            var fa = a.fields, fb = b.fields;
            
            switch (prospectsSort.field) {
                case 'firstName':
                    aVal = (fa['First Name'] || '').toLowerCase();
                    bVal = (fb['First Name'] || '').toLowerCase();
                    break;
                case 'status':
                    aVal = fa['Status'] || fa['Disposition'] || '';
                    bVal = fb['Status'] || fb['Disposition'] || '';
                    break;
                case 'lastCalled':
                    aVal = new Date(getMostRecentLastCalled(fa) || 0).getTime();
                    bVal = new Date(getMostRecentLastCalled(fb) || 0).getTime();
                    break;
                case 'bookedTime':
                default:
                    aVal = new Date(fa['Booked Time'] || 0).getTime();
                    bVal = new Date(fb['Booked Time'] || 0).getTime();
            }
            
            if (prospectsSort.direction === 'asc') {
                return aVal > bVal ? 1 : -1;
            } else {
                return aVal < bVal ? 1 : -1;
            }
        });
        
        if (prospects.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" class="empty-state">No prospects found</td></tr>';
            return;
        }
        
        tbody.innerHTML = prospects.map(function(lead) {
            var f = lead.fields;
            var name = ((f['First Name'] || '') + ' ' + (f['Last Name'] || '')).trim() || 'Unknown';
            var phone = formatPhone(f['Phone #'] || f['Phone'] || '-');
            var status = f['Status'] || f['Disposition'] || '-';
            var statusClass = getStatusClass(status);
            var lastCalled = formatDateTime(getMostRecentLastCalled(f));
            var bookedTime = f['Booked Time'] ? formatDateTime(f['Booked Time']) : '-';
            var summaryRaw = f['Last Call Summary'] || '';
            var summary = Array.isArray(summaryRaw) ? summaryRaw.join(' ') : String(summaryRaw || '');
            var notesRaw = f['Client Notes'] || '';
            var notes = parseNotesJson(notesRaw);
            var lastNoteRaw = notes.length > 0 ? notes[notes.length - 1].text : '';
            var lastNote = String(lastNoteRaw || '');
            var isShared = f['Shared With'] || f['Shared With Email'];
            
            return '<tr onclick="openLeadModal(\'' + lead.id + '\')" style="cursor:pointer">' +
                '<td><strong>' + escapeHtml(name) + '</strong></td>' +
                '<td style="font-family:monospace">' + escapeHtml(phone) + '</td>' +
                '<td><span class="status-badge ' + statusClass + '">' + escapeHtml(status) + '</span></td>' +
                '<td>' + lastCalled + '</td>' +
                '<td>' + bookedTime + '</td>' +
                '<td class="summary-cell" title="' + escapeHtml(summary) + '">' + escapeHtml(summary.substring(0, 60)) + (summary.length > 60 ? '...' : '') + '</td>' +
                '<td class="notes-cell" title="' + escapeHtml(lastNote) + '">' + escapeHtml(lastNote.substring(0, 40)) + (lastNote.length > 40 ? '...' : '') + '</td>' +
                '<td><span class="sharing-indicator ' + (isShared ? 'shared' : 'not-shared') + '">' + (isShared ? '' : '-') + '</span></td>' +
                '<td class="table-actions">' +
                    '<button class="table-action-btn view" onclick="event.stopPropagation();openLeadModal(\'' + lead.id + '\')">View</button>' +
                    '<button class="table-action-btn prio" onclick="event.stopPropagation();markAsPrio(\'' + lead.id + '\')"></button>' +
                '</td>' +
            '</tr>';
        }).join('');
    }
    
    // ===== PIPELINE TAB =====
    function updatePipelineList() {
        var pipelineList = document.getElementById('pipelineList');
        if (!pipelineList) return;
        
        var searchVal = (document.getElementById('pipelineSearch')?.value || '').toLowerCase();
        var statusFilter = document.getElementById('pipelineStatus')?.value || 'all';
        var timeframeFilter = document.getElementById('pipelineTimeframe')?.value || 'all';
        
        // Get Timeline and Follow Up leads
        var pipelineLeads = allLeads.filter(function(l) {
            var f = l.fields;
            var status = f['Status'] || f['Disposition'] || '';
            
            if (status !== 'Timeline' && status !== 'Follow Up') return false;
            
            // Status filter
            if (statusFilter !== 'all' && status !== statusFilter) return false;
            
            // Search filter
            if (searchVal) {
                var name = ((f['First Name'] || '') + ' ' + (f['Last Name'] || '')).toLowerCase();
                var phone = (f['Phone #'] || f['Phone'] || '').toLowerCase();
                if (!name.includes(searchVal) && !phone.includes(searchVal)) return false;
            }
            
            // Timeframe filter (for Next Call Date)
            if (timeframeFilter !== 'all' && f['Next Call Date']) {
                var nextCall = new Date(f['Next Call Date']);
                var now = new Date();
                var daysDiff = Math.ceil((nextCall - now) / (1000 * 60 * 60 * 24));
                if (timeframeFilter === '7days' && daysDiff > 7) return false;
                if (timeframeFilter === '30days' && daysDiff > 30) return false;
                if (timeframeFilter === '90days' && daysDiff > 90) return false;
            }
            
            return true;
        });
        
        // Sort by Next Call Date
        pipelineLeads.sort(function(a, b) {
            var aDate = new Date(a.fields['Next Call Date'] || '9999-12-31');
            var bDate = new Date(b.fields['Next Call Date'] || '9999-12-31');
            return aDate - bDate;
        });
        
        // Update stats
        var timelineCount = allLeads.filter(function(l) { return (l.fields['Status'] || l.fields['Disposition']) === 'Timeline'; }).length;
        var followUpCount = allLeads.filter(function(l) { return (l.fields['Status'] || l.fields['Disposition']) === 'Follow Up'; }).length;
        document.getElementById('pipelineTimeline').textContent = timelineCount;
        document.getElementById('pipelineFollowUp').textContent = followUpCount;
        
        if (pipelineLeads.length === 0) {
            pipelineList.innerHTML = '<div class="pipeline-empty">No leads in AI pipeline</div>';
            return;
        }
        
        pipelineList.innerHTML = pipelineLeads.map(function(lead) {
            var f = lead.fields;
            var name = ((f['First Name'] || '') + ' ' + (f['Last Name'] || '')).trim() || 'Unknown';
            var phone = formatPhone(f['Phone #'] || f['Phone'] || '-');
            var status = f['Status'] || f['Disposition'] || '-';
            var statusClass = status === 'Timeline' ? 'timeline' : 'follow-up';
            var nextCall = f['Next Call Date'] ? formatDateTime(f['Next Call Date']) : 'Not scheduled';
            var summary = f['Last Call Summary'] || 'No summary';
            
            return '<div class="pipeline-card" onclick="openLeadModal(\'' + lead.id + '\')">' +
                '<div class="pipeline-card-header">' +
                    '<div class="pipeline-card-name">' + escapeHtml(name) + '</div>' +
                    '<div class="pipeline-card-phone">' + escapeHtml(phone) + '</div>' +
                '</div>' +
                '<div class="pipeline-card-status"><span class="status-badge ' + statusClass + '">' + escapeHtml(status) + '</span></div>' +
                '<div class="pipeline-card-nextcall"> Next call: <span class="date">' + nextCall + '</span></div>' +
                '<div class="pipeline-card-summary">' + escapeHtml(summary) + '</div>' +
            '</div>';
        }).join('');
    }
    
    // Helper: Check if lead is owned by current user
    function isLeadOwnedByUser(lead) {
        if (!currentUser) return false;
        var clientEmails = lead.fields['Client Email'] || [];
        if (typeof clientEmails === 'string') clientEmails = [clientEmails];
        return clientEmails.some(function(e) {
            return e.toLowerCase() === currentUser.email.toLowerCase();
        });
    }
    
    // Helper: Get days difference
    function getDaysDiff(date) {
        var now = new Date();
        return Math.floor((now - date) / (1000 * 60 * 60 * 24));
    }
    
    // Helper: Get last updated timestamp
    function getMostRecentLastCalled(fields) {
        return fields['Updated At'] ? new Date(fields['Updated At']) : null;
    }
    
    // Helper: Format date/time
    function formatDateTime(dateVal) {
        if (!dateVal) return '-';
        var date = new Date(dateVal);
        return date.toLocaleDateString('en-CA', {
            month: 'short',
            day: 'numeric',
            hour: 'numeric',
            minute: '2-digit'
        });
    }

    // Helper: Format date/time as friendly (February 1st, 11:00 AM)
    function formatFriendlyDateTime(dateVal) {
        if (!dateVal) return '-';
        var date = new Date(dateVal);
        var months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
        var day = date.getDate();
        var suffix = ['th', 'st', 'nd', 'rd'][(day % 100 > 10 && day % 100 < 14) ? 0 : (day % 10 < 4 ? day % 10 : 0)];
        var hours = date.getHours();
        var minutes = date.getMinutes().toString().padStart(2, '0');
        var seconds = date.getSeconds().toString().padStart(2, '0');
        var ampm = hours >= 12 ? 'PM' : 'AM';
        var hour12 = hours % 12 || 12;
        return months[date.getMonth()] + ' ' + day + suffix + ', ' + date.getFullYear() + ', ' + hour12 + ':' + minutes + ':' + seconds + ' ' + ampm;
    }
    
    // Helper: Format phone
    function formatPhone(phone) {
        if (!phone) return '-';
        var cleaned = phone.toString().replace(/\D/g, '');
        if (cleaned.length === 11 && cleaned[0] === '1') cleaned = cleaned.slice(1);
        if (cleaned.length === 10) {
            return '(' + cleaned.slice(0,3) + ') ' + cleaned.slice(3,6) + '-' + cleaned.slice(6);
        }
        return phone;
    }
    
    // Helper: Get status class
    function getStatusClass(status) {
        if (!status) return '';
        var s = status.toLowerCase();
        if (s.includes('booked')) return 'booked';
        if (s.includes('callback')) return 'callback';
        if (s.includes('timeline')) return 'timeline';
        if (s.includes('follow')) return 'follow-up';
        if (s.includes('interested') && !s.includes('not')) return 'interested';
        if (s.includes('not interested')) return 'not-interested';
        return '';
    }
    
    // Mark as PRIO from table
    async function markAsPrio(leadId) {
        try {
            await fetchAirtable(AIRTABLE_BASE + '/' + AIRTABLE_LEADS_TABLE + '/' + leadId, {
                method: 'PATCH',
                body: { fields: { 'Is Prio': true } }
            });
            var lead = allLeads.find(function(l) { return l.id === leadId; });
            if (lead) lead.fields['Is Prio'] = true;
            updatePrioList();
            updateProspectsTable();
            showToast('Marked as PRIO', 'success');
        } catch (err) {
            showToast('Failed to update', 'error');
        }
    }
    
    // Open lead modal by ID
    function openLeadModal(leadId) {
        var lead = allLeads.find(function(l) { return l.id === leadId; });
        if (!lead) return;
        
        currentLeadId = leadId;
        var f = lead.fields;
        
        // Populate modal
        document.getElementById('modalLeadName').textContent = ((f['First Name'] || '') + ' ' + (f['Last Name'] || '')).trim() || 'Unknown';
        document.getElementById('modalPhone').textContent = formatPhone(f['Phone #'] || f['Phone'] || '-');
        
        var status = f['Status'] || f['Disposition'] || '-';
        var statusEl = document.getElementById('modalStatus');
        statusEl.textContent = status;
        statusEl.className = 'status-badge ' + getStatusClass(status);
        
        document.getElementById('modalLastCalled').textContent = formatDateTime(getMostRecentLastCalled(f));

        // Booked Time with edit/delete buttons
        var bookedTime = f['Booked Time'];
        var bookedTimeValue = document.getElementById('modalBookedTimeValue');
        var scheduleBtn = document.getElementById('modalScheduleBtn');
        if (bookedTime) {
            bookedTimeValue.innerHTML = '<span class="booked-time-display"><span class="booked-time-value">' + formatFriendlyDateTime(bookedTime) + '</span><button class="btn-edit-booking" onclick="editBookingFromModal()" title="Edit booking"></button><button class="btn-delete-booking" onclick="deleteBookingFromModal()" title="Remove booking"></button></span>';
            if (scheduleBtn) scheduleBtn.style.display = 'none';
        } else {
            bookedTimeValue.textContent = '-';
            if (scheduleBtn) scheduleBtn.style.display = 'inline-flex';
        }

        document.getElementById('modalSummary').textContent = f['Last Call Summary'] || 'No summary available';
        
        // Notes with edit/delete
        var notesRaw = f['Client Notes'] || '';
        var notes = parseNotesJson(notesRaw);
        var notesList = document.getElementById('modalNotesList');
        if (notes.length > 0) {
            notesList.innerHTML = notes.map(function(note, idx) {
                var dateStr = note.date ? formatNoteDate(note.date) : '';
                return '<div class="lead-note-item" data-note-index="' + idx + '">' +
                    '<div class="note-content">' + escapeHtml(note.text) + '</div>' +
                    (dateStr ? '<div class="note-date">' + dateStr + '</div>' : '') +
                    '<div class="note-actions"><button class="btn-edit-note" onclick="editNote(' + idx + ')" title="Edit"></button><button class="btn-delete-note" onclick="deleteNote(' + idx + ')" title="Delete"></button></div>' +
                '</div>';
            }).join('');
        } else {
            notesList.innerHTML = '<div style="color:rgba(255,255,255,0.4)">No notes yet</div>';
        }
        document.getElementById('modalNotesInput').value = '';
        
        // Attempts - parse JSON if available
        var attemptsRaw = f['Client Attempts'] || '[]';
        var attemptsArray = [];
        try {
            if (typeof attemptsRaw === 'string') {
                attemptsArray = JSON.parse(attemptsRaw);
            } else if (Array.isArray(attemptsRaw)) {
                attemptsArray = attemptsRaw;
            } else if (typeof attemptsRaw === 'number') {
                attemptsArray = [];
            }
        } catch (e) {
            attemptsArray = [];
        }
        var attemptsCount = Array.isArray(attemptsArray) ? attemptsArray.length : 0;
        document.getElementById('modalAttemptsCount').textContent = attemptsCount;
        var attemptsList = document.getElementById('modalAttemptsList');
        if (attemptsCount > 0) {
            var attemptsHtml = attemptsArray.map(function(attempt, i) {
                var timeStr = attempt.time ? formatFriendlyDateTime(attempt.time) : 'Unknown time';
                return '<div class="lead-attempt-item"><span>Call Attempt #' + (i + 1) + '</span><span style="display:flex;align-items:center;gap:8px;"><span style="color:rgba(255,255,255,0.5);font-size:0.8125rem;">' + timeStr + '</span><button class="btn-delete-attempt" onclick="deleteCallAttempt(' + i + ')" title="Delete"></button></span></div>';
            }).join('');
            attemptsList.innerHTML = attemptsHtml;
        } else {
            attemptsList.innerHTML = '<p style="color:rgba(255,255,255,0.4);font-size:0.8125rem;">No call attempts logged yet</p>';
        }

        // Transcript with colored speakers
        var transcript = f['Transcript (from Calls)'];
        var transcriptEl = document.getElementById('modalTranscript');
        var leadName = ((f['First Name'] || '') + ' ' + (f['Last Name'] || '')).trim() || 'Unknown';
        if (transcript && transcript.length) {
            var transcriptText = Array.isArray(transcript) ? transcript[0] : transcript;
            transcriptEl.innerHTML = formatTranscript(transcriptText, leadName);
        } else {
            transcriptEl.textContent = 'No transcript available';
        }
        
        // PRIO button state and icon
        var prioBtn = document.getElementById('modalPrioBtn');
        var prioIcon = document.getElementById('modalPrioIcon');
        if (f['Is Prio']) {
            prioBtn.classList.add('active');
            prioBtn.textContent = ' PRIO';
            if (prioIcon) prioIcon.style.display = 'block';
        } else {
            prioBtn.classList.remove('active');
            prioBtn.textContent = ' PRIO';
            if (prioIcon) prioIcon.style.display = 'none';
        }

        // Share button state and shared info display
        var shareBtn = document.getElementById('modalShareBtn');
        var sharedWithEmail = f['Shared With Email'];
        if (Array.isArray(sharedWithEmail)) sharedWithEmail = sharedWithEmail[0] || '';
        var isSharedToUser = lead.isShared;
        var sharedInfoDiv = document.getElementById('modalSharedInfo');
        var sharedLabel = document.getElementById('modalSharedLabel');
        var sharedValue = document.getElementById('modalSharedValue');

        if (sharedWithEmail || isSharedToUser) {
            if (shareBtn) {
                shareBtn.classList.add('shared');
                shareBtn.innerHTML = ' ' + (isSharedToUser ? 'Shared with you' : 'Shared');
            }
            if (sharedInfoDiv) {
                sharedInfoDiv.style.display = 'block';
                if (isSharedToUser) {
                    sharedLabel.textContent = ' Shared By';
                    var ownerEmail = f['Client Email'];
                    if (Array.isArray(ownerEmail)) ownerEmail = ownerEmail[0] || '';
                    sharedValue.textContent = getAgentNameByEmail(ownerEmail) || ownerEmail || 'Unknown';
                } else {
                    sharedLabel.textContent = ' Shared With';
                    sharedValue.textContent = getAgentNameByEmail(sharedWithEmail) || sharedWithEmail || 'Unknown';
                }
            }
        } else {
            if (shareBtn) {
                shareBtn.classList.remove('shared');
                shareBtn.innerHTML = ' Share';
            }
            if (sharedInfoDiv) sharedInfoDiv.style.display = 'none';
        }

        // Show modal
        document.getElementById('leadModal').classList.add('active');
    }
    
    // Close modal
    document.getElementById('leadModalClose').addEventListener('click', function() {
        document.getElementById('leadModal').classList.remove('active');
        currentLeadId = null;
    });
    document.getElementById('leadModal').addEventListener('click', function(e) {
        if (e.target === this) {
            this.classList.remove('active');
            currentLeadId = null;
        }
    });
    
    // ===== FILTER EVENT LISTENERS =====
    // Prio filters
    document.getElementById('prioSearch')?.addEventListener('input', debounce(updatePrioListFiltered, 300));
    document.getElementById('prioOwnership')?.addEventListener('change', updatePrioListFiltered);
    document.getElementById('prioTimeframe')?.addEventListener('change', updatePrioListFiltered);
    
    // Prospects filters
    document.getElementById('prospectsSearch')?.addEventListener('input', debounce(updateProspectsTable, 300));
    document.getElementById('prospectsStatus')?.addEventListener('change', updateProspectsTable);
    document.getElementById('prospectsOwnership')?.addEventListener('change', updateProspectsTable);
    document.getElementById('prospectsTimeframe')?.addEventListener('change', updateProspectsTable);
    
    // Pipeline filters
    document.getElementById('pipelineSearch')?.addEventListener('input', debounce(updatePipelineList, 300));
    document.getElementById('pipelineStatus')?.addEventListener('change', updatePipelineList);
    document.getElementById('pipelineTimeframe')?.addEventListener('change', updatePipelineList);
    
    // Debounce helper
    function debounce(func, wait) {
        var timeout;
        return function() {
            var context = this, args = arguments;
            clearTimeout(timeout);
            timeout = setTimeout(function() {
                func.apply(context, args);
            }, wait);
        };
    }
    
    // Filtered Prio list update
    function updatePrioListFiltered() {
        var prioList = document.getElementById('prioList');
        
        var searchVal = (document.getElementById('prioSearch')?.value || '').toLowerCase();
        var ownershipFilter = document.getElementById('prioOwnership')?.value || 'all';
        var timeframeFilter = document.getElementById('prioTimeframe')?.value || 'all';
        
        var prioLeads = allLeads.filter(function(l) {
            var f = l.fields;
            if (f['Is Prio'] !== true) return false;
            
            // Search filter
            if (searchVal) {
                var name = ((f['First Name'] || '') + ' ' + (f['Last Name'] || '')).toLowerCase();
                var phone = (f['Phone #'] || f['Phone'] || '').toLowerCase();
                if (!name.includes(searchVal) && !phone.includes(searchVal)) return false;
            }
            
            // Ownership filter
            if (ownershipFilter !== 'all') {
                var isOwned = isLeadOwnedByUser(l);
                var isSharedByMe = !l.isShared && f['Shared With Email'];
                var isSharedWithMe = l.isShared === true;
                
                if (ownershipFilter === 'mine' && !isOwned) return false;
                if (ownershipFilter === 'shared-by' && !isSharedByMe) return false;
                if (ownershipFilter === 'not-shared' && (isSharedByMe || isSharedWithMe)) return false;
                if (ownershipFilter === 'shared-with' && !isSharedWithMe) return false;
            }
            
            // Timeframe filter
            if (timeframeFilter !== 'all') {
                var lastCall = f['Last Call Timestamp'] || f['Client Last Call Timestamp'];
                if (!lastCall) return false;
                var daysDiff = getDaysDiff(new Date(lastCall));
                if (timeframeFilter === 'today' && daysDiff > 0) return false;
                if (timeframeFilter === '7days' && daysDiff > 7) return false;
                if (timeframeFilter === '30days' && daysDiff > 30) return false;
                if (timeframeFilter === '90days' && daysDiff > 90) return false;
            }
            
            return true;
        });
        
        // Sort by priority score
        prioLeads = prioLeads.map(function(l) {
            var d = l.fields['Disposition'] || l.fields['Status'] || '';
            var score = 0;
            if (d === 'Booked' || d === 'Appointment Booked') score = 95;
            else if (d === 'Callback' || d === 'Callback Requested') score = 90;
            else if (d === 'Interested') score = 85;
            else if (d === 'Timeline') score = 70;
            else if (d === 'Follow Up') score = 60;
            else score = 50;
            l._score = score;
            return l;
        }).sort(function(a, b) {
            return b._score - a._score;
        });
        
        document.getElementById('prioCount').textContent = prioLeads.length;
        
        if (prioLeads.length === 0) {
            prioList.innerHTML = '<div class="prio-empty">No priority leads match your filters</div>';
            return;
        }
        
        // Render cards (reuse existing card rendering logic)
        prioList.innerHTML = prioLeads.map(function(lead, index) {
            var f = lead.fields;
            var firstName = f['First Name'] || '';
            var lastName = f['Last Name'] || '';
            var name = (firstName + ' ' + lastName).trim() || 'Unknown';
            var phone = f['Phone #'] || f['Phone'] || '-';
            var lastUpdatedTimestamp = f['Updated At'];
            var lastUpdated = lastUpdatedTimestamp ? formatTimeAgo(lastUpdatedTimestamp) : '-';
            var lastUpdatedColor = getLastCalledColor(lastUpdatedTimestamp);
            var bookedTime = f['Booked Time'] || null;
            var summary = f['Last Call Summary'] || f['Summary'] || '';
            var notesRaw = f['Client Notes'] || f['Notes'] || '';
            var isShared = f['Shared With'] || f['Shared With Email'];
            
            var notesArray = parseNotesJson(notesRaw);
            
            var bookedDisplay = '';
            if (bookedTime) {
                bookedDisplay = formatFriendlyDateTime(bookedTime);
            }

            var notesHtml = '';
            if (notesArray.length > 0) {
                notesHtml = notesArray.map(function(note) {
                    return '<div class="prio-note-item">' +
                        '<div class="prio-note-text">' + escapeHtml(note.text) + '</div>' +
                        '<div class="prio-note-date">' + formatNoteDate(note.date || note.time) + '</div>' +
                    '</div>';
                }).join('');
            } else {
                notesHtml = '<div style="color:rgba(255,255,255,0.4);font-size:0.8125rem;">No notes yet</div>';
            }
            
            var cardId = 'prio-card-' + index;
            
            return '<div class="prio-card" data-id="' + lead.id + '" onclick="openLeadModal(\'' + lead.id + '\')">' +
                '<div class="prio-card-header">' +
                    '<div class="prio-card-name">' + escapeHtml(name) + (isShared ? ' <span class="shared-icon" title="Shared lead"></span>' : '') + '</div>' +
                    '<div class="prio-card-meta">' +
                        '<span class="prio-card-phone"> ' + escapeHtml(phone) + '</span>' +
                        '<span class="prio-card-lastcall"><span class="lastcall-dot ' + lastUpdatedColor + '"></span>' + lastUpdated + '</span>' +
                    '</div>' +
                    (bookedTime ? '<div class="prio-card-booked"><span class="booked-time"> ' + bookedDisplay + '</span></div>' : '') +
                '</div>' +
                '<div class="prio-card-tabs">' +
                    '<button class="prio-card-tab active" onclick="event.stopPropagation();switchPrioTab(\'' + cardId + '\',\'summary\')">Summary</button>' +
                    '<button class="prio-card-tab" onclick="event.stopPropagation();switchPrioTab(\'' + cardId + '\',\'notes\')">Notes</button>' +
                '</div>' +
                '<div class="prio-card-content" id="' + cardId + '">' +
                    '<div class="prio-card-panel active" data-panel="summary">' +
                        '<div class="prio-card-summary">' + (summary ? escapeHtml(summary) : '<span style="color:rgba(255,255,255,0.4)">No summary available</span>') + '</div>' +
                    '</div>' +
                    '<div class="prio-card-panel" data-panel="notes">' +
                        '<div class="prio-card-notes-list">' + notesHtml + '</div>' +
                    '</div>' +
                '</div>' +
                '<div class="prio-card-footer">' +
                    '<button class="btn-share" onclick="event.stopPropagation()" title="Share lead">+ Share</button>' +
                    '<button class="btn-unprio" onclick="event.stopPropagation();unprio(\'' + lead.id + '\')">Unprio</button>' +
                '</div>' +
            '</div>';
        }).join('');
    }
    
    // Update all tabs when data loads
    var originalLoadLeadsData = loadLeadsData;
    loadLeadsData = async function() {
        await originalLoadLeadsData();
        updateProspectsTable();
        updatePipelineList();
    };
    
    // Full page loading - show for 10 seconds then reveal
    var pageLoadingComplete = false;
    function hidePageLoading() {
        if (pageLoadingComplete) return;
        pageLoadingComplete = true;
        var overlay = document.getElementById('pageLoadingOverlay');
        var appContainer = document.getElementById('appContainer');
        if (overlay) overlay.classList.add('fade-out');
        if (appContainer) appContainer.style.opacity = '1';
        setTimeout(function() {
            if (overlay) overlay.style.display = 'none';
        }, 500);
    }
    
    // Loading animation is now triggered in checkAuth after login
    
    // ===== ANALYTICS PAGE =====
    var analyticsPeriod = 'daily';
    var analyticsDate = new Date();
    
    // Period tab clicks
    document.querySelectorAll('.analytics-period-tab').forEach(function(tab) {
        tab.addEventListener('click', function() {
            document.querySelectorAll('.analytics-period-tab').forEach(function(t) { t.classList.remove('active'); });
            this.classList.add('active');
            analyticsPeriod = this.dataset.period;
            updateAnalyticsDisplay();
        });
    });
    
    // Date picker change
    document.getElementById('analyticsDatePicker')?.addEventListener('change', function() {
        analyticsDate = new Date(this.value);
        updateAnalyticsDisplay();
    });
    
    function updateAnalyticsDisplay() {
        var statusCounts = { booked: 0, callback: 0, interested: 0, timeline: 0, followUp: 0, notInterested: 0, voicemail: 0, noAnswer: 0, dnc: 0, wrongNumber: 0 };
        var totalCalls = 0;
        var conversations = 0;
        var bookedLeads = [];
        
        allLeads.forEach(function(l) {
            var f = l.fields;
            var status = (f['Status'] || f['Disposition'] || '').toLowerCase();
            var lastCall = f['Last Call Timestamp'];
            
            // Filter by period/date
            if (analyticsPeriod !== 'all' && lastCall) {
                var callDate = new Date(lastCall);
                var now = new Date();
                if (analyticsPeriod === 'daily') {
                    var selectedDate = analyticsDate.toDateString();
                    if (callDate.toDateString() !== selectedDate) return;
                } else if (analyticsPeriod === 'weekly') {
                    var weekAgo = new Date(now); weekAgo.setDate(weekAgo.getDate() - 7);
                    if (callDate < weekAgo) return;
                } else if (analyticsPeriod === 'monthly') {
                    var monthAgo = new Date(now); monthAgo.setMonth(monthAgo.getMonth() - 1);
                    if (callDate < monthAgo) return;
                }
            }
            
            totalCalls++;
            
            if (status === 'booked' || status === 'appointment booked') {
                statusCounts.booked++;
                conversations++;
                bookedLeads.push(l);
            }
            else if (status === 'callback' || status === 'callback requested') { statusCounts.callback++; conversations++; }
            else if (status === 'interested') { statusCounts.interested++; conversations++; }
            else if (status === 'timeline') { statusCounts.timeline++; conversations++; }
            else if (status === 'follow up' || status === 'followup') { statusCounts.followUp++; }
            else if (status === 'not interested' || status === 'notinterested') statusCounts.notInterested++;
            else if (status === 'voicemail') statusCounts.voicemail++;
            else if (status === 'no answer' || status === 'noanswer') statusCounts.noAnswer++;
            else if (status === 'dnc' || status === 'do not call') statusCounts.dnc++;
            else if (status === 'wrong number' || status === 'wrongnumber') statusCounts.wrongNumber++;
        });
        
        // Update UI
        var el = function(id) { return document.getElementById(id); };
        if (el('analyticsTotalCalls')) el('analyticsTotalCalls').textContent = totalCalls;
        if (el('analyticsConversations')) el('analyticsConversations').textContent = conversations;
        if (el('analyticsActivePipeline')) el('analyticsActivePipeline').textContent = statusCounts.timeline + statusCounts.followUp;
        if (el('analyticsBooked')) el('analyticsBooked').textContent = statusCounts.booked;
        if (el('analyticsCallbackCount')) el('analyticsCallbackCount').textContent = statusCounts.callback;
        if (el('analyticsInterested')) el('analyticsInterested').textContent = statusCounts.interested;
        if (el('analyticsTimelineCount')) el('analyticsTimelineCount').textContent = statusCounts.timeline;
        if (el('analyticsVoicemail')) el('analyticsVoicemail').textContent = statusCounts.voicemail;
        if (el('analyticsNoAnswer')) el('analyticsNoAnswer').textContent = statusCounts.noAnswer;
        if (el('analyticsNotInterested')) el('analyticsNotInterested').textContent = statusCounts.notInterested;
        if (el('analyticsDNC')) el('analyticsDNC').textContent = statusCounts.dnc;
        if (el('analyticsWrongNumber')) el('analyticsWrongNumber').textContent = statusCounts.wrongNumber;
        
        // Booked table
        var bookedTable = el('analyticsBookedTable');
        if (bookedTable) {
            if (bookedLeads.length === 0) {
                bookedTable.innerHTML = '<tr><td colspan="4" style="text-align:center;padding:24px;color:rgba(255,255,255,0.4)">No booked appointments</td></tr>';
            } else {
                bookedTable.innerHTML = bookedLeads.map(function(lead) {
                    var f = lead.fields;
                    var name = ((f['First Name'] || '') + ' ' + (f['Last Name'] || '')).trim() || 'Unknown';
                    var phone = formatPhone(f['Phone #'] || f['Phone'] || '-');
                    var summaryRaw = f['Last Call Summary'] || '';
                    var summary = Array.isArray(summaryRaw) ? summaryRaw.join(' ') : String(summaryRaw || '');
                    var bookedTime = f['Booked Time'] ? formatDateTime(f['Booked Time']) : '-';
                    return '<tr onclick="openLeadModal(\'' + lead.id + '\')" style="cursor:pointer">' +
                        '<td>' + escapeHtml(name) + '</td>' +
                        '<td style="font-family:monospace">' + escapeHtml(phone) + '</td>' +
                        '<td style="max-width:250px;overflow:hidden;text-overflow:ellipsis">' + escapeHtml(summary.substring(0,80)) + '</td>' +
                        '<td style="color:#22c55e">' + bookedTime + '</td>' +
                    '</tr>';
                }).join('');
            }
        }
    }
    
    // ===== IMPORT PAGE =====
    // Tab switching
    document.querySelectorAll('.import-tab').forEach(function(tab) {
        tab.addEventListener('click', function() {
            document.querySelectorAll('.import-tab').forEach(function(t) { t.classList.remove('active'); });
            document.querySelectorAll('.import-panel').forEach(function(p) { p.classList.remove('active'); });
            this.classList.add('active');
            var target = this.dataset.import === 'single' ? 'importSinglePanel' : 'importBulkPanel';
            document.getElementById(target)?.classList.add('active');
        });
    });
    
    // Single lead form
    document.getElementById('submitSingleLeadBtn')?.addEventListener('click', async function() {
        var btn = this;
        var firstName = document.getElementById('singleLeadFirstName')?.value.trim();
        var lastName = document.getElementById('singleLeadLastName')?.value.trim();
        var phone = document.getElementById('singleLeadPhone')?.value.trim();
        var interest = document.getElementById('singleLeadInterest')?.value;
        var email = document.getElementById('singleLeadEmail')?.value.trim();
        var maxAttempts = document.getElementById('singleLeadMaxAttempts')?.value;
        
        var statusEl = document.getElementById('singleLeadStatus');
        
        if (!firstName || !phone || !interest) {
            if (statusEl) statusEl.innerHTML = '<p style="color:#ef4444">Please fill in required fields</p>';
            return;
        }
        
        btn.disabled = true;
        btn.textContent = 'Adding...';
        if (statusEl) statusEl.innerHTML = '<p style="color:rgb(52,211,153)">Adding lead...</p>';
        
        try {
            // Send to n8n webhook
            await fetch('https://n8n.prioai.ca/webhook/lead-file-upload', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    email: currentUser?.email,
                    agentName: currentUserRecord?.fields?.['Agent Name'] || '',
                    leads: [{
                        firstName: firstName,
                        lastName: lastName,
                        phone: phone,
                        interest: interest,
                        email: email,
                        maxAttempts: maxAttempts || 5
                    }]
                })
            });
            
            if (statusEl) statusEl.innerHTML = '<p style="color:#22c55e"> Lead added successfully!</p>';
            
            // Clear form
            document.getElementById('singleLeadFirstName').value = '';
            document.getElementById('singleLeadLastName').value = '';
            document.getElementById('singleLeadPhone').value = '';
            document.getElementById('singleLeadInterest').value = '';
            document.getElementById('singleLeadEmail').value = '';
        } catch (err) {
            if (statusEl) statusEl.innerHTML = '<p style="color:#ef4444">Failed to add lead: ' + err.message + '</p>';
        }
        
        btn.disabled = false;
        btn.textContent = ' Add Lead';
    });
    
    // File upload
    var uploadZone = document.getElementById('fileUploadZone');
    var fileInput = document.getElementById('leadFileInput');
    
    uploadZone?.addEventListener('click', function() { fileInput?.click(); });
    uploadZone?.addEventListener('dragover', function(e) { e.preventDefault(); this.classList.add('dragover'); });
    uploadZone?.addEventListener('dragleave', function() { this.classList.remove('dragover'); });
    uploadZone?.addEventListener('drop', function(e) {
        e.preventDefault();
        this.classList.remove('dragover');
        if (e.dataTransfer.files.length) handleFileUpload(e.dataTransfer.files[0]);
    });
    fileInput?.addEventListener('change', function() {
        if (this.files.length) handleFileUpload(this.files[0]);
    });
    
    async function handleFileUpload(file) {
        var statusEl = document.getElementById('uploadStatus');
        if (!statusEl) return;
        
        statusEl.innerHTML = '<p style="color:rgb(52,211,153)"> Uploading ' + file.name + '...</p>';
        
        try {
            var reader = new FileReader();
            reader.onload = async function(e) {
                var base64 = e.target.result.split(',')[1];
                await fetch('https://n8n.prioai.ca/webhook/lead-file-upload', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: currentUser?.email,
                        agentName: currentUserRecord?.fields?.['Agent Name'] || '',
                        fileName: file.name,
                        fileType: file.type,
                        fileData: base64
                    })
                });
                statusEl.innerHTML = '<p style="color:#22c55e"> File uploaded successfully! Leads will be processed shortly.</p>';
            };
            reader.readAsDataURL(file);
        } catch (err) {
            statusEl.innerHTML = '<p style="color:#ef4444">Failed to upload: ' + err.message + '</p>';
        }
    }
    
    // Download template
    document.getElementById('downloadTemplateBtn')?.addEventListener('click', function() {
        var csv = 'First Name,Last Name,Phone,Interest,Email\nJohn,Smith,4165551234,Buy,john@example.com\nJane,Doe,6475559876,Sell,';
        var blob = new Blob([csv], { type: 'text/csv' });
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        a.download = 'prio-leads-template.csv';
        a.click();
    });
    
    // ===== SEARCH PAGE =====
    var searchedLead = null;
    
    document.getElementById('globalSearchBtn')?.addEventListener('click', performSearch);
    document.getElementById('globalSearchInput')?.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') performSearch();
    });
    
    function performSearch() {
        var query = document.getElementById('globalSearchInput')?.value.trim().toLowerCase();
        if (!query) return;
        
        var results = allLeads.filter(function(l) {
            var f = l.fields;
            var name = ((f['First Name'] || '') + ' ' + (f['Last Name'] || '')).toLowerCase();
            var phone = (f['Phone #'] || f['Phone'] || '').replace(/\D/g, '');
            var phoneLast4 = phone.slice(-4);
            return name.includes(query) || phoneLast4 === query || phone.includes(query);
        });
        
        document.getElementById('searchMultipleResults').style.display = 'none';
        document.getElementById('searchLeadDetail').style.display = 'none';
        document.getElementById('searchEmptyState').style.display = 'none';
        
        if (results.length === 0) {
            document.getElementById('searchEmptyState').style.display = 'block';
            document.getElementById('searchEmptyText').textContent = 'No lead found matching "' + query + '"';
        } else if (results.length === 1) {
            showSearchLeadDetail(results[0]);
        } else {
            // Multiple results
            document.getElementById('searchMultipleResults').style.display = 'block';
            document.getElementById('searchResultsList').innerHTML = results.slice(0, 10).map(function(lead) {
                var f = lead.fields;
                var name = ((f['First Name'] || '') + ' ' + (f['Last Name'] || '')).trim() || 'Unknown';
                var phone = formatPhone(f['Phone #'] || f['Phone'] || '-');
                var status = f['Status'] || f['Disposition'] || '-';
                return '<div class="search-result-item" onclick="showSearchLeadDetail(allLeads.find(function(l){return l.id===\'' + lead.id + '\'}))">' +
                    '<div><div style="font-weight:600">' + escapeHtml(name) + '</div><div style="color:rgba(255,255,255,0.5);font-family:monospace">' + escapeHtml(phone) + '</div></div>' +
                    '<span class="status-badge ' + getStatusClass(status) + '">' + escapeHtml(status) + '</span>' +
                '</div>';
            }).join('');
        }
    }
    
    function showSearchLeadDetail(lead) {
        if (!lead) return;
        searchedLead = lead;
        var f = lead.fields;
        
        document.getElementById('searchMultipleResults').style.display = 'none';
        document.getElementById('searchLeadDetail').style.display = 'block';
        
        document.getElementById('searchLeadName').textContent = ((f['First Name'] || '') + ' ' + (f['Last Name'] || '')).trim() || 'Unknown';
        document.getElementById('searchLeadPhoneDisplay').textContent = formatPhone(f['Phone #'] || f['Phone'] || '-');
        
        var status = f['Status'] || f['Disposition'] || '-';
        var statusBadge = document.getElementById('searchLeadStatusBadge');
        statusBadge.textContent = status;
        statusBadge.className = 'status-badge ' + getStatusClass(status);
        
        document.getElementById('searchLeadEmail').textContent = f['Email'] || '-';
        document.getElementById('searchLeadCalls').textContent = f['Attempts'] || '0';
        document.getElementById('searchLeadLastCall').textContent = f['Updated At'] ? formatDateTime(f['Updated At']) : '-';
        document.getElementById('searchLeadBookedTime').textContent = f['Booked Time'] ? formatDateTime(f['Booked Time']) : '-';
        
        // Notes
        var notesRaw = f['Client Notes'] || '';
        var notes = parseNotesJson(notesRaw);
        document.getElementById('searchLeadNotesInput').value = notes.map(function(n) { return n.text; }).join('\n');
        
        // Summary
        var summaryRaw = f['Last Call Summary'] || '';
        var summary = Array.isArray(summaryRaw) ? summaryRaw.join('\n') : String(summaryRaw || 'No summary available');
        document.getElementById('searchLeadSummary').textContent = summary;
        
        // Transcript
        var transcriptRaw = f['Transcript (from Calls)'] || '';
        var transcript = Array.isArray(transcriptRaw) ? transcriptRaw.join('\n\n---\n\n') : String(transcriptRaw || 'No transcript available');
        document.getElementById('searchLeadTranscript').textContent = transcript;
    }
    
    // Save notes from search
    document.getElementById('searchLeadSaveNotes')?.addEventListener('click', async function() {
        if (!searchedLead) return;
        var btn = this;
        var notesText = document.getElementById('searchLeadNotesInput')?.value.trim();
        if (!notesText) return;

        btn.disabled = true;
        btn.textContent = 'Saving...';

        try {
            // Append to existing notes as JSON array
            var existingNotesRaw = searchedLead.fields['Client Notes'] || '';
            var notesArray = parseNotesJson(existingNotesRaw);
            notesArray.push({ text: notesText, date: new Date().toISOString() });
            var newNotes = JSON.stringify(notesArray);

            await fetchAirtable(AIRTABLE_BASE + '/' + AIRTABLE_LEADS_TABLE + '/' + searchedLead.id, {
                method: 'PATCH',
                body: { fields: { 'Client Notes': newNotes } }
            });
            searchedLead.fields['Client Notes'] = newNotes;
            document.getElementById('searchLeadNotesInput').value = '';
            showToast('Notes saved', 'success');
        } catch (err) {
            showToast('Failed to save notes', 'error');
        }

        btn.disabled = false;
        btn.textContent = 'Save Notes';
    });
    
    // Update analytics when data loads
    var originalLoadLeadsData2 = loadLeadsData;
    loadLeadsData = async function() {
        await originalLoadLeadsData2();
        updateAnalyticsDisplay();
    };
    </script>
</body>
</html>
