<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Prio AI Dashboard - Manage your leads and grow your business.">
    <title>Dashboard | Prio AI</title>
    <link rel="icon" type="image/png" href="/assets/favicon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Outfit:wght@600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/assets/styles.css">
    <style>
        /* Critical inline styles for immediate rendering */
        .stats-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:1rem;margin-bottom:2rem}
        @media(min-width:768px){.stats-grid{grid-template-columns:repeat(4,1fr)}}
        .stat-card{background:#111;border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:1.25rem;display:flex;align-items:center;gap:1rem}
        .stat-card.accent{background:rgba(52,211,153,0.1);border-color:rgb(52,211,153)}
        .stat-icon{font-size:1.5rem}
        .stat-value{font-size:1.5rem;font-weight:700;line-height:1}
        .stat-label{font-size:0.75rem;color:rgba(255,255,255,0.6);text-transform:uppercase}
        .quick-actions{display:grid;grid-template-columns:repeat(2,1fr);gap:0.75rem;margin-bottom:2rem}
        @media(min-width:768px){.quick-actions{grid-template-columns:repeat(4,1fr)}}
        .quick-action{display:flex;flex-direction:column;align-items:center;gap:0.5rem;padding:1.25rem;background:#111;border:1px solid rgba(255,255,255,0.1);border-radius:12px;color:#fff;cursor:pointer}
        .quick-action:hover{border-color:rgb(52,211,153);background:rgba(52,211,153,0.1)}
        .quick-action-icon{font-size:1.5rem}
        .quick-action-text{font-size:0.875rem;font-weight:500}
        .welcome-banner{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:2rem;flex-wrap:wrap;gap:1rem}
        .welcome-text h2{font-size:1.5rem;margin-bottom:0.5rem}
        .welcome-text p{color:rgba(255,255,255,0.7)}
        .welcome-date{font-size:0.875rem;color:rgba(255,255,255,0.5);background:#111;padding:0.5rem 1rem;border-radius:8px}
        .section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem}
        .section-header h3{font-size:1.125rem;font-weight:600}
        .prio-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:1.5rem;flex-wrap:wrap;gap:1rem}
        .prio-filters{display:flex;gap:0.5rem;margin-bottom:1.25rem;flex-wrap:wrap}
        .prio-filter{padding:0.5rem 1rem;font-size:0.875rem;font-weight:500;color:rgba(255,255,255,0.7);background:#111;border:1px solid rgba(255,255,255,0.1);border-radius:8px;cursor:pointer}
        .prio-filter.active{background:rgb(52,211,153);border-color:rgb(52,211,153);color:#000}
        .prio-list{display:flex;flex-direction:column;gap:0.75rem}
        .prio-card{background:#111;border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:1.25rem;display:flex;align-items:center;gap:1rem}
        .spinner{width:32px;height:32px;border:3px solid rgba(255,255,255,0.1);border-top-color:rgb(52,211,153);border-radius:50%;animation:spin 0.8s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
        .overview-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:1rem;margin-bottom:2rem}
        @media(min-width:768px){.overview-grid{grid-template-columns:repeat(4,1fr)}}
        .overview-card{background:#111;border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:1.25rem;cursor:pointer;transition:all 0.15s}
        .overview-card:hover{border-color:rgb(52,211,153);transform:translateY(-2px)}
        .overview-card.highlight{background:rgba(52,211,153,0.1);border-color:rgb(52,211,153)}
        .overview-card-header{display:flex;align-items:center;gap:0.5rem;margin-bottom:0.75rem}
        .overview-card-header h4{font-size:0.875rem;font-weight:600;color:rgba(255,255,255,0.8)}
        .overview-card-icon{font-size:1rem}
        .overview-card-value{font-size:2rem;font-weight:700;margin-bottom:0.25rem}
        .overview-card-desc{font-size:0.75rem;color:rgba(255,255,255,0.5)}
        .meetings-list{display:flex;flex-direction:column;gap:0.5rem}
        .meetings-empty{text-align:center;padding:2rem;color:rgba(255,255,255,0.5);background:#111;border-radius:12px}
        .meeting-card{background:#111;border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:1rem;display:flex;align-items:center;gap:1rem}
        .meeting-time{background:rgba(52,211,153,0.15);color:rgb(52,211,153);padding:0.5rem 0.75rem;border-radius:8px;font-weight:600;font-size:0.875rem}
        .meeting-info{flex:1}
        .meeting-name{font-weight:600;margin-bottom:0.25rem}
        .meeting-details{font-size:0.875rem;color:rgba(255,255,255,0.6)}
        .prio-empty{text-align:center;padding:3rem;color:rgba(255,255,255,0.5)}
        
        /* Profile Menu */
        .profile-menu{position:absolute;bottom:100%;left:0;right:0;background:#151515;border:1px solid rgba(255,255,255,0.1);border-radius:12px;margin:0 0.5rem 0.5rem;padding:0.5rem;opacity:0;visibility:hidden;transform:translateY(10px);transition:all 0.2s}
        .profile-menu.active{opacity:1;visibility:visible;transform:translateY(0)}
        .profile-menu-item{display:flex;align-items:center;gap:0.75rem;padding:0.75rem 1rem;border-radius:8px;cursor:pointer;font-size:0.875rem;color:rgba(255,255,255,0.8);transition:all 0.15s}
        .profile-menu-item:hover{background:rgba(255,255,255,0.05)}
        .profile-menu-item.logout{color:#ef4444}
        .profile-menu-item.logout:hover{background:rgba(239,68,68,0.1)}
        .profile-menu-divider{height:1px;background:rgba(255,255,255,0.1);margin:0.5rem 0}
        
        /* Notifications Popup */
        .notifications-popup{position:absolute;bottom:100%;right:0;width:280px;background:#151515;border:1px solid rgba(255,255,255,0.1);border-radius:12px;margin-bottom:0.5rem;opacity:0;visibility:hidden;transform:translateY(10px);transition:all 0.2s}
        .notifications-popup.active{opacity:1;visibility:visible;transform:translateY(0)}
        .notifications-header{padding:1rem;border-bottom:1px solid rgba(255,255,255,0.1);font-weight:600;font-size:0.875rem}
        .notifications-empty{padding:2rem;text-align:center;color:rgba(255,255,255,0.5);font-size:0.875rem}
        
        .sidebar-footer{position:relative}
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar Overlay (mobile) -->
        <div class="sidebar-overlay" id="sidebarOverlay"></div>

        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <img src="/assets/logo_white.png" alt="Prio AI" class="sidebar-logo logo-dark">
                <img src="/assets/logo_black.png" alt="Prio AI" class="sidebar-logo logo-light" style="display:none;">
                <button class="sidebar-close" id="sidebarClose">&times;</button>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-item active" data-page="overview">
                        <span class="nav-item-icon">üìä</span>
                        <span>Overview</span>
                    </div>
                    <div class="nav-item" data-page="prio">
                        <span class="nav-item-icon">‚ö°</span>
                        <span>PRIO</span>
                    </div>
                    <div class="nav-item" data-page="prospects">
                        <span class="nav-item-icon">üìã</span>
                        <span>Prospects</span>
                    </div>
                    <div class="nav-item" data-page="pipeline">
                        <span class="nav-item-icon">ü§ñ</span>
                        <span>AI Pipeline</span>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Tools</div>
                    <div class="nav-item" data-page="import">
                        <span class="nav-item-icon">üì•</span>
                        <span>Import Leads</span>
                    </div>
                    <div class="nav-item" data-page="search">
                        <span class="nav-item-icon">üîç</span>
                        <span>Search</span>
                    </div>
                    <div class="nav-item" data-page="analytics">
                        <span class="nav-item-icon">üìà</span>
                        <span>Analytics</span>
                    </div>
                </div>

<!-- Account section moved to profile popup -->
            </nav>

            <div class="sidebar-footer">
                <!-- Profile Menu (slides up) -->
                <div class="profile-menu" id="profileMenu">
                    <div class="profile-menu-item" data-page="settings">
                        <span>‚öôÔ∏è</span> Settings
                    </div>
                    <div class="profile-menu-item" data-page="billing">
                        <span>üí≥</span> Billing
                    </div>
                    <div class="profile-menu-item" data-page="help">
                        <span>‚ùì</span> Help
                    </div>
                    <div class="profile-menu-divider"></div>
                    <div class="profile-menu-item logout" id="sidebarLogout">
                        <span>üö™</span> Sign Out
                    </div>
                </div>
                
                <!-- Notifications Popup -->
                <div class="notifications-popup" id="notificationsPopup">
                    <div class="notifications-header">
                        <span>Notifications</span>
                    </div>
                    <div class="notifications-empty">
                        No new notifications
                    </div>
                </div>
                
                <div class="sidebar-footer-row">
                    <div class="user-card" id="userCard">
                        <div class="user-avatar" id="userAvatar">U</div>
                        <div class="user-info">
                            <div class="user-name" id="userName">Guest</div>
                            <div class="user-email" id="userEmail">Not signed in</div>
                        </div>
                    </div>
                    <button class="notification-btn" id="notificationBtn" title="Notifications">
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                            <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                        </svg>
                        <span class="notification-badge" id="notificationBadge" style="display:none;">0</span>
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="header">
                <div class="header-left">
                    <button class="menu-toggle" id="menuToggle">
                        <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none">
                            <line x1="3" y1="12" x2="21" y2="12"></line>
                            <line x1="3" y1="6" x2="21" y2="6"></line>
                            <line x1="3" y1="18" x2="21" y2="18"></line>
                        </svg>
                    </button>
                    <h1 class="header-title" id="pageTitle">Overview</h1>
                </div>
                <div class="header-right">
                    <button class="header-btn" id="themeToggle" title="Toggle theme">
                        <svg class="sun-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                        <svg class="moon-icon" viewBox="0 0 24 24" style="display:none;"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                    </button>
                    <button class="btn btn-primary btn-sm" id="loginBtn">Sign In</button>
                </div>
            </header>

            <div class="page-content">
                <!-- Loading State -->
                <div class="loading" id="loadingState">
                    <div class="spinner"></div>
                    <p class="text-muted">Loading...</p>
                </div>

                <!-- Guest State -->
                <div id="guestState" class="hidden">
                    <div class="card" style="max-width: 500px; margin: 0 auto; text-align: center;">
                        <h2 style="margin-bottom: var(--space-4);">Welcome to Prio AI</h2>
                        <p style="color: var(--text-secondary); margin-bottom: var(--space-6);">Sign in to access your dashboard and start converting more leads.</p>
                        <button class="btn btn-primary btn-lg" id="guestLoginBtn">Get Started</button>
                    </div>
                </div>

                <!-- Dashboard Content -->
                <div id="dashboardContent" class="hidden">
                    <!-- Page: Overview -->
                    <div class="page" id="page-overview">
                        <!-- Welcome Banner -->
                        <div class="welcome-banner">
                            <div class="welcome-text">
                                <h2>Welcome back, <span id="welcomeName">there</span> üëã</h2>
                                <p>Here's what's happening with your leads today.</p>
                            </div>
                            <div class="welcome-date" id="welcomeDate"></div>
                        </div>

                        <!-- Stats Grid -->
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-icon">üìã</div>
                                <div class="stat-content">
                                    <div class="stat-value" id="statProspects">-</div>
                                    <div class="stat-label">Total Prospects</div>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon">üìû</div>
                                <div class="stat-content">
                                    <div class="stat-value" id="statCalls">-</div>
                                    <div class="stat-label">Calls Made</div>
                                </div>
                            </div>
                            <div class="stat-card accent">
                                <div class="stat-icon">üìÖ</div>
                                <div class="stat-content">
                                    <div class="stat-value" id="statAppointments">-</div>
                                    <div class="stat-label">Appointments Booked</div>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon">üìà</div>
                                <div class="stat-content">
                                    <div class="stat-value" id="statConversion">-</div>
                                    <div class="stat-label">Conversion Rate</div>
                                </div>
                            </div>
                        </div>

                        <!-- Overview Cards -->
                        <div class="overview-grid">
                            <div class="overview-card" onclick="switchPage('prio')">
                                <div class="overview-card-header">
                                    <span class="overview-card-icon">‚ö°</span>
                                    <h4>PRIO Leads</h4>
                                </div>
                                <div class="overview-card-value" id="overviewPrio">0</div>
                                <div class="overview-card-desc">Priority leads to focus on</div>
                            </div>
                            <div class="overview-card" onclick="switchPage('prospects')">
                                <div class="overview-card-header">
                                    <span class="overview-card-icon">üìã</span>
                                    <h4>Prospects</h4>
                                </div>
                                <div class="overview-card-value" id="overviewProspects">0</div>
                                <div class="overview-card-desc">Total leads in your database</div>
                            </div>
                            <div class="overview-card" onclick="switchPage('pipeline')">
                                <div class="overview-card-header">
                                    <span class="overview-card-icon">ü§ñ</span>
                                    <h4>AI Pipeline</h4>
                                </div>
                                <div class="overview-card-value" id="overviewPipeline">0</div>
                                <div class="overview-card-desc">Leads being called by AI</div>
                            </div>
                            <div class="overview-card highlight" onclick="switchPage('meetings')">
                                <div class="overview-card-header">
                                    <span class="overview-card-icon">üìÖ</span>
                                    <h4>Today's Meetings</h4>
                                </div>
                                <div class="overview-card-value" id="overviewMeetings">0</div>
                                <div class="overview-card-desc">Callbacks scheduled for today</div>
                            </div>
                        </div>

                        <!-- Today's Meetings List -->
                        <div class="section-header">
                            <h3>Today's Callbacks</h3>
                        </div>
                        <div class="meetings-list" id="todayMeetings">
                            <div class="meetings-empty">
                                <p>No callbacks scheduled for today</p>
                            </div>
                        </div>
                    </div>

                    <!-- Page: PRIO -->
                    <div class="page hidden" id="page-prio">
                        <!-- PRIO Header -->
                        <div class="prio-header">
                            <div class="prio-header-text">
                                <h2>‚ö° PRIO Leads</h2>
                                <p>Your priority leads ranked by engagement. Focus here first.</p>
                            </div>
                            <div class="prio-header-stats">
                                <div class="prio-stat">
                                    <span class="prio-stat-value" id="prioCount">0</span>
                                    <span class="prio-stat-label">Priority Leads</span>
                                </div>
                            </div>
                        </div>

                        <!-- PRIO List -->
                        <div class="prio-list" id="prioList">
                            <div class="prio-empty">No priority leads yet</div>
                        </div>
                    </div>

                    <!-- Page: Prospects -->
                    <div class="page hidden" id="page-prospects">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Prospects</h3>
                                <button class="btn btn-primary btn-sm">+ Add Lead</button>
                            </div>
                            <p class="text-muted">Your prospects will appear here.</p>
                        </div>
                    </div>

                    <!-- Page: Pipeline -->
                    <div class="page hidden" id="page-pipeline">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">AI Pipeline</h3>
                            </div>
                            <p class="text-muted">Your AI calling pipeline will appear here.</p>
                        </div>
                    </div>

                    <!-- Page: Analytics -->
                    <div class="page hidden" id="page-analytics">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Analytics</h3>
                            </div>
                            <p class="text-muted">Your analytics and reports will appear here.</p>
                        </div>
                    </div>

                    <!-- Page: Import -->
                    <div class="page hidden" id="page-import">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Import Leads</h3>
                            </div>
                            <p class="text-muted">Upload CSV or Excel files to import leads.</p>
                        </div>
                    </div>

                    <!-- Page: Search -->
                    <div class="page hidden" id="page-search">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Search</h3>
                            </div>
                            <p class="text-muted">Search across all your leads.</p>
                        </div>
                    </div>

                    <!-- Page: Settings -->
                    <div class="page hidden" id="page-settings">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Settings</h3>
                            </div>
                            <p class="text-muted">Manage your account settings.</p>
                        </div>
                    </div>

                    <!-- Page: Billing -->
                    <div class="page hidden" id="page-billing">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Billing</h3>
                            </div>
                            <p class="text-muted">Manage your subscription and payment methods.</p>
                        </div>
                    </div>

                    <!-- Page: Help -->
                    <div class="page hidden" id="page-help">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Help & Support</h3>
                            </div>
                            <p class="text-muted">Get help with using Prio AI.</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Auth Modal -->
    <div class="modal-overlay" id="authModal">
        <div class="modal">
            <button class="modal-close" id="authModalClose">&times;</button>
            <div class="modal-content">
                <div class="modal-header">
                    <img src="/assets/logo_white.png" alt="Prio AI" class="modal-logo logo-dark">
                    <img src="/assets/logo_black.png" alt="Prio AI" class="modal-logo logo-light" style="display:none;">
                    <h2 id="authTitle">Welcome to Prio AI</h2>
                    <p id="authSubtitle">Sign in to your account</p>
                </div>

                <!-- Login Form -->
                <form id="loginForm">
                    <div class="form-group">
                        <label for="loginEmail">Email</label>
                        <input type="email" id="loginEmail" placeholder="you@example.com" required>
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                    </div>
                    <div class="form-error" id="loginError"></div>
                    <button type="submit" class="btn btn-primary btn-block btn-lg" id="loginSubmit">Sign In</button>
                </form>

                <!-- Signup Form (hidden by default) -->
                <form id="signupForm" class="hidden">
                    <div class="form-group">
                        <label for="signupName">Full Name</label>
                        <input type="text" id="signupName" placeholder="John Smith" required>
                    </div>
                    <div class="form-group">
                        <label for="signupEmail">Email</label>
                        <input type="email" id="signupEmail" placeholder="you@example.com" required>
                    </div>
                    <div class="form-group">
                        <label for="signupPassword">Password</label>
                        <input type="password" id="signupPassword" placeholder="Min. 8 characters" required minlength="8">
                    </div>
                    <div class="form-error" id="signupError"></div>
                    <div class="form-success" id="signupSuccess"></div>
                    <button type="submit" class="btn btn-primary btn-block btn-lg" id="signupSubmit">Create Account</button>
                </form>

                <div class="auth-divider"><span>or</span></div>

                <button class="btn btn-google btn-block" id="googleAuthBtn">
                    <svg viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                    Continue with Google
                </button>

                <div class="auth-footer">
                    <p id="authSwitch">Don't have an account? <a href="#" id="switchToSignup">Sign up</a></p>
                    <p style="margin-top: var(--space-2);"><a href="#" id="forgotPassword">Forgot password?</a></p>
                </div>
            </div>
        </div>
    </div>

    <!-- User Menu Modal -->
    <div class="modal-overlay" id="userModal">
        <div class="modal" style="max-width: 320px;">
            <button class="modal-close" id="userModalClose">&times;</button>
            <div class="modal-content">
                <div style="text-align: center; margin-bottom: var(--space-5);">
                    <div class="user-avatar" id="userModalAvatar" style="width: 64px; height: 64px; font-size: var(--text-xl); margin: 0 auto var(--space-3);">U</div>
                    <div style="font-weight: 600;" id="userModalName">User</div>
                    <div style="font-size: var(--text-sm); color: var(--text-secondary);" id="userModalEmail">user@example.com</div>
                </div>
                <button class="btn btn-secondary btn-block" style="margin-bottom: var(--space-2);" onclick="switchPage('settings')">Settings</button>
                <button class="btn btn-secondary btn-block" style="margin-bottom: var(--space-2);" onclick="switchPage('billing')">Billing</button>
                <button class="btn btn-secondary btn-block" id="logoutBtn" style="color: #ef4444;">Sign Out</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
    // Supabase Setup
    var SUPABASE_URL = "https://bflmikgoafdffezrfpgb.supabase.co";
    var SUPABASE_KEY = "sb_publishable_e4DbIJ2T-9QAMtXzYo4o8Q_x135R40k";
    var supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // State
    var currentUser = null;
    var currentPage = 'overview';

    // Elements
    var sidebar = document.getElementById('sidebar');
    var sidebarOverlay = document.getElementById('sidebarOverlay');
    var authModal = document.getElementById('authModal');
    var userModal = document.getElementById('userModal');
    var loginForm = document.getElementById('loginForm');
    var signupForm = document.getElementById('signupForm');

    // Toast
    function showToast(message, type) {
        var toast = document.createElement('div');
        toast.className = 'toast ' + (type || '');
        toast.textContent = message;
        document.getElementById('toastContainer').appendChild(toast);
        setTimeout(function() { toast.remove(); }, 4000);
    }

    // Theme
    (function() {
        var html = document.documentElement;
        var saved = localStorage.getItem('theme') || 'dark';
        html.setAttribute('data-theme', saved);
        updateThemeIcons();
        
        document.getElementById('themeToggle').addEventListener('click', function() {
            var next = html.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', next);
            localStorage.setItem('theme', next);
            updateThemeIcons();
        });
        
        function updateThemeIcons() {
            var isDark = html.getAttribute('data-theme') === 'dark';
            document.querySelectorAll('.sun-icon').forEach(function(el) { el.style.display = isDark ? 'block' : 'none'; });
            document.querySelectorAll('.moon-icon').forEach(function(el) { el.style.display = isDark ? 'none' : 'block'; });
            document.querySelectorAll('.logo-dark').forEach(function(el) { el.style.display = isDark ? 'block' : 'none'; });
            document.querySelectorAll('.logo-light').forEach(function(el) { el.style.display = isDark ? 'none' : 'block'; });
        }
    })();

    // Sidebar Toggle (mobile)
    document.getElementById('menuToggle').addEventListener('click', function() {
        sidebar.classList.add('open');
        sidebarOverlay.classList.add('active');
    });
    
    document.getElementById('sidebarClose').addEventListener('click', closeSidebar);
    sidebarOverlay.addEventListener('click', closeSidebar);
    
    function closeSidebar() {
        sidebar.classList.remove('open');
        sidebarOverlay.classList.remove('active');
    }

    // Navigation
    document.querySelectorAll('.nav-item[data-page]').forEach(function(item) {
        item.addEventListener('click', function() {
            switchPage(this.dataset.page);
            closeSidebar();
        });
    });

    function switchPage(page) {
        currentPage = page;
        
        // Update nav
        document.querySelectorAll('.nav-item').forEach(function(item) {
            item.classList.toggle('active', item.dataset.page === page);
        });
        
        // Update title
        var titles = {
            overview: 'Overview', prio: 'PRIO', prospects: 'Prospects', pipeline: 'AI Pipeline',
            analytics: 'Analytics', import: 'Import Leads', search: 'Search',
            settings: 'Settings', billing: 'Billing', help: 'Help'
        };
        document.getElementById('pageTitle').textContent = titles[page] || page;
        
        // Show page
        document.querySelectorAll('.page').forEach(function(p) { p.classList.add('hidden'); });
        var pageEl = document.getElementById('page-' + page);
        if (pageEl) pageEl.classList.remove('hidden');
        
        // Close user modal if open
        userModal.classList.remove('active');
        
        // Update hash
        window.location.hash = page;
    }

    // Auth Modal
    function openAuthModal(mode) {
        authModal.classList.add('active');
        if (mode === 'signup') {
            loginForm.classList.add('hidden');
            signupForm.classList.remove('hidden');
            document.getElementById('authTitle').textContent = 'Create Account';
            document.getElementById('authSubtitle').textContent = 'Start converting more leads';
            document.getElementById('authSwitch').innerHTML = 'Already have an account? <a href="#" id="switchToLogin">Sign in</a>';
            document.getElementById('switchToLogin').addEventListener('click', function(e) { e.preventDefault(); openAuthModal('login'); });
        } else {
            signupForm.classList.add('hidden');
            loginForm.classList.remove('hidden');
            document.getElementById('authTitle').textContent = 'Welcome to Prio AI';
            document.getElementById('authSubtitle').textContent = 'Sign in to your account';
            document.getElementById('authSwitch').innerHTML = "Don't have an account? <a href=\"#\" id=\"switchToSignup\">Sign up</a>";
            document.getElementById('switchToSignup').addEventListener('click', function(e) { e.preventDefault(); openAuthModal('signup'); });
        }
    }

    function closeAuthModal() {
        authModal.classList.remove('active');
        loginForm.reset();
        signupForm.reset();
        document.getElementById('loginError').textContent = '';
        document.getElementById('signupError').textContent = '';
        document.getElementById('signupSuccess').textContent = '';
    }

    document.getElementById('loginBtn').addEventListener('click', function() { openAuthModal('login'); });
    document.getElementById('guestLoginBtn').addEventListener('click', function() { openAuthModal('signup'); });
    document.getElementById('authModalClose').addEventListener('click', closeAuthModal);
    authModal.addEventListener('click', function(e) { if (e.target === authModal) closeAuthModal(); });

    // User Modal
    document.getElementById('userCard').addEventListener('click', function() {
        if (currentUser) {
            userModal.classList.add('active');
        } else {
            openAuthModal('login');
        }
    });
    document.getElementById('userModalClose').addEventListener('click', function() { userModal.classList.remove('active'); });
    userModal.addEventListener('click', function(e) { if (e.target === userModal) userModal.classList.remove('active'); });

    // Login
    loginForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        var btn = document.getElementById('loginSubmit');
        var err = document.getElementById('loginError');
        err.textContent = '';
        btn.disabled = true;
        btn.textContent = 'Signing in...';
        
        try {
            var result = await supabase.auth.signInWithPassword({
                email: document.getElementById('loginEmail').value,
                password: document.getElementById('loginPassword').value
            });
            if (result.error) throw result.error;
            closeAuthModal();
            checkAuth();
        } catch (ex) {
            err.textContent = ex.message || 'Login failed';
        }
        
        btn.disabled = false;
        btn.textContent = 'Sign In';
    });

    // Signup
    signupForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        var btn = document.getElementById('signupSubmit');
        var err = document.getElementById('signupError');
        var suc = document.getElementById('signupSuccess');
        err.textContent = '';
        suc.textContent = '';
        btn.disabled = true;
        btn.textContent = 'Creating account...';
        
        try {
            var result = await supabase.auth.signUp({
                email: document.getElementById('signupEmail').value,
                password: document.getElementById('signupPassword').value,
                options: {
                    data: { full_name: document.getElementById('signupName').value },
                    emailRedirectTo: window.location.origin
                }
            });
            if (result.error) throw result.error;
            if (result.data.user && !result.data.session) {
                suc.textContent = '‚úì Check your email to confirm your account';
                btn.textContent = 'Email Sent';
            } else {
                closeAuthModal();
                checkAuth();
            }
        } catch (ex) {
            err.textContent = ex.message || 'Signup failed';
            btn.disabled = false;
            btn.textContent = 'Create Account';
        }
    });

    // Google Auth
    document.getElementById('googleAuthBtn').addEventListener('click', function() {
        supabase.auth.signInWithOAuth({
            provider: 'google',
            options: { redirectTo: window.location.origin }
        });
    });

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', async function() {
        await supabase.auth.signOut();
        currentUser = null;
        userModal.classList.remove('active');
        checkAuth();
        showToast('Signed out', 'success');
    });
    
    // Sidebar logout
    document.getElementById('sidebarLogout').addEventListener('click', async function() {
        await supabase.auth.signOut();
        currentUser = null;
        document.getElementById('profileMenu').classList.remove('active');
        checkAuth();
        showToast('Signed out', 'success');
    });
    
    // Profile menu toggle
    document.getElementById('userCard').addEventListener('click', function(e) {
        e.stopPropagation();
        document.getElementById('notificationsPopup').classList.remove('active');
        document.getElementById('profileMenu').classList.toggle('active');
    });
    
    // Profile menu items
    document.querySelectorAll('.profile-menu-item[data-page]').forEach(function(item) {
        item.addEventListener('click', function() {
            switchPage(this.dataset.page);
            document.getElementById('profileMenu').classList.remove('active');
        });
    });
    
    // Notifications toggle
    document.getElementById('notificationBtn').addEventListener('click', function(e) {
        e.stopPropagation();
        document.getElementById('profileMenu').classList.remove('active');
        document.getElementById('notificationsPopup').classList.toggle('active');
    });
    
    // Close popups when clicking outside
    document.addEventListener('click', function() {
        document.getElementById('profileMenu').classList.remove('active');
        document.getElementById('notificationsPopup').classList.remove('active');
    });

    // Auth Check (returns promise)
    function checkAuth() {
        return (async function() {
        document.getElementById('loadingState').classList.remove('hidden');
        document.getElementById('guestState').classList.add('hidden');
        document.getElementById('dashboardContent').classList.add('hidden');
        
        var result = await supabase.auth.getSession();
        currentUser = result.data.session?.user || null;
        
        document.getElementById('loadingState').classList.add('hidden');
        
        if (currentUser) {
            var name = currentUser.user_metadata?.full_name || currentUser.user_metadata?.display_name || currentUser.email.split('@')[0];
            var avatar = currentUser.user_metadata?.profile_picture;
            
            document.getElementById('userName').textContent = name;
            document.getElementById('userEmail').textContent = currentUser.email;
            document.getElementById('userModalName').textContent = name;
            document.getElementById('userModalEmail').textContent = currentUser.email;
            
            if (avatar) {
                document.getElementById('userAvatar').innerHTML = '<img src="' + avatar + '" alt="">';
                document.getElementById('userModalAvatar').innerHTML = '<img src="' + avatar + '" alt="">';
            } else {
                document.getElementById('userAvatar').textContent = name.charAt(0).toUpperCase();
                document.getElementById('userModalAvatar').textContent = name.charAt(0).toUpperCase();
            }
            
            document.getElementById('loginBtn').classList.add('hidden');
            document.getElementById('dashboardContent').classList.remove('hidden');
        } else {
            document.getElementById('userName').textContent = 'Guest';
            document.getElementById('userEmail').textContent = 'Not signed in';
            document.getElementById('userAvatar').textContent = 'G';
            document.getElementById('loginBtn').classList.remove('hidden');
            document.getElementById('guestState').classList.remove('hidden');
        }
        })();
    }

    // Airtable Config
    var _a = ['cGF0N0c3SURnT2lSNnJiTFEuM2E5ZGIyMmM1MTcwYjkwMzA1Yjc1MDRhNjNlNjkzM2JkNTQwMTFiMDI4YWMzODRmM2QyOWU5YWQ3YmNkYzBjMw=='];
    var AIRTABLE_TOKEN = atob(_a[0]);
    var AIRTABLE_BASE = 'applOjDjhH0RqLtBH';
    var AIRTABLE_CLIENTS_TABLE = 'tblMptC862PyL7Znw';
    var AIRTABLE_LEADS_TABLE = 'tblLpN4wceakfNFpq';
    
    var currentUserRecord = null;
    var allLeads = [];

    // Update welcome date
    function updateWelcomeDate() {
        var now = new Date();
        var options = { weekday: 'long', month: 'long', day: 'numeric' };
        document.getElementById('welcomeDate').textContent = now.toLocaleDateString('en-US', options);
    }
    updateWelcomeDate();

    // Load user data from Airtable
    async function loadUserData() {
        if (!currentUser) return;
        
        // Show loading state
        document.getElementById('statProspects').textContent = '...';
        document.getElementById('statCalls').textContent = '...';
        document.getElementById('statAppointments').textContent = '...';
        document.getElementById('statConversion').textContent = '...';
        
        try {
            var filterFormula = encodeURIComponent('({Email} = "' + currentUser.email + '")');
            var response = await fetch('https://api.airtable.com/v0/' + AIRTABLE_BASE + '/' + AIRTABLE_CLIENTS_TABLE + '?filterByFormula=' + filterFormula, {
                headers: { 'Authorization': 'Bearer ' + AIRTABLE_TOKEN }
            });
            var data = await response.json();
            
            console.log('Client data:', data);
            
            if (data.records && data.records.length > 0) {
                currentUserRecord = data.records[0];
                loadLeadsData();
            } else {
                // No client record found - show zeros
                document.getElementById('statProspects').textContent = '0';
                document.getElementById('statCalls').textContent = '0';
                document.getElementById('statAppointments').textContent = '0';
                document.getElementById('statConversion').textContent = '0%';
                document.getElementById('prioList').innerHTML = '<div class="prio-empty" style="text-align:center;padding:3rem;color:rgba(255,255,255,0.5);"><p>No leads yet. Import some to get started!</p></div>';
            }
        } catch (err) {
            console.error('Failed to load user data:', err);
            document.getElementById('statProspects').textContent = '0';
            document.getElementById('statCalls').textContent = '0';
            document.getElementById('statAppointments').textContent = '0';
            document.getElementById('statConversion').textContent = '0%';
        }
    }

    // Load leads data
    async function loadLeadsData() {
        if (!currentUserRecord) return;
        
        try {
            var clientRecordId = currentUserRecord.id;
            var email = currentUser.email.toLowerCase();
            var filterFormula = 'FIND("' + email + '", LOWER(ARRAYJOIN({Client Email})))';
            var url = 'https://api.airtable.com/v0/' + AIRTABLE_BASE + '/' + AIRTABLE_LEADS_TABLE + '?filterByFormula=' + encodeURIComponent(filterFormula) + '&pageSize=100';
            
            allLeads = [];
            var offset = null;
            
            do {
                var fetchUrl = url + (offset ? '&offset=' + offset : '');
                var response = await fetch(fetchUrl, { headers: { 'Authorization': 'Bearer ' + AIRTABLE_TOKEN } });
                var data = await response.json();
                
                if (data.records) {
                    allLeads = allLeads.concat(data.records);
                }
                offset = data.offset;
            } while (offset);
            
            updateStats();
            updatePrioList();
        } catch (err) {
            console.error('Failed to load leads:', err);
        }
    }

    // Update stats
    function updateStats() {
        var totalProspects = allLeads.length;
        document.getElementById('statProspects').textContent = totalProspects;
        document.getElementById('overviewProspects').textContent = totalProspects;
        
        var callsMade = allLeads.filter(function(l) { return l.fields['Call Count'] > 0; }).length;
        document.getElementById('statCalls').textContent = callsMade;
        
        var appointments = allLeads.filter(function(l) { 
            return l.fields['Disposition'] === 'Appointment Booked' || l.fields['Booking Status'] === 'Booked';
        }).length;
        document.getElementById('statAppointments').textContent = appointments;
        
        var convRate = totalProspects > 0 ? Math.round((appointments / totalProspects) * 100) : 0;
        document.getElementById('statConversion').textContent = convRate + '%';
        
        // PRIO leads (engaged leads)
        var prioLeads = allLeads.filter(function(l) {
            var d = l.fields['Disposition'] || '';
            return d === 'Interested' || d === 'Callback Requested' || d === 'Appointment Booked' || (l.fields['Call Count'] || 0) > 0;
        });
        document.getElementById('overviewPrio').textContent = prioLeads.length;
        
        // AI Pipeline (leads in queue)
        var pipelineLeads = allLeads.filter(function(l) {
            var status = l.fields['Call Status'] || l.fields['Status'] || '';
            return status === 'Queued' || status === 'In Progress' || status === 'Retry';
        });
        document.getElementById('overviewPipeline').textContent = pipelineLeads.length;
        
        // Today's meetings (callbacks scheduled for today)
        var today = new Date().toISOString().split('T')[0];
        var todayMeetings = allLeads.filter(function(l) {
            var callbackDate = l.fields['Callback Date'] || l.fields['Follow Up Date'] || '';
            return callbackDate && callbackDate.startsWith(today);
        });
        document.getElementById('overviewMeetings').textContent = todayMeetings.length;
        updateTodayMeetings(todayMeetings);
        
        // Update welcome name
        var name = currentUser?.user_metadata?.full_name || currentUser?.user_metadata?.display_name || 'there';
        document.getElementById('welcomeName').textContent = name.split(' ')[0];
    }
    
    // Update today's meetings list
    function updateTodayMeetings(meetings) {
        var list = document.getElementById('todayMeetings');
        if (meetings.length === 0) {
            list.innerHTML = '<div class="meetings-empty"><p>No callbacks scheduled for today</p></div>';
            return;
        }
        
        list.innerHTML = meetings.map(function(lead) {
            var f = lead.fields;
            var name = f['Full Name'] || (f['First Name'] + ' ' + (f['Last Name'] || ''));
            var phone = f['Phone'] || '-';
            var time = f['Callback Time'] || 'TBD';
            
            return '<div class="meeting-card">' +
                '<div class="meeting-time">' + escapeHtml(time) + '</div>' +
                '<div class="meeting-info">' +
                    '<div class="meeting-name">' + escapeHtml(name) + '</div>' +
                    '<div class="meeting-details">' + escapeHtml(phone) + '</div>' +
                '</div>' +
                '<button class="btn btn-sm btn-primary" onclick="alert(\'Call feature coming soon\')">Call</button>' +
            '</div>';
        }).join('');
    }

    // Update PRIO list
    function updatePrioList() {
        var prioList = document.getElementById('prioList');
        
        // Get all engaged leads sorted by score
        var prioLeads = allLeads.filter(function(l) {
            var d = l.fields['Disposition'] || '';
            return d === 'Interested' || d === 'Callback Requested' || d === 'Appointment Booked' || (l.fields['Call Count'] || 0) > 0;
        }).map(function(l) {
            var d = l.fields['Disposition'] || '';
            var score = 0;
            if (d === 'Appointment Booked') score = 95;
            else if (d === 'Interested') score = 85;
            else if (d === 'Callback Requested') score = 75;
            else if ((l.fields['Call Count'] || 0) > 2) score = 50;
            else if ((l.fields['Call Count'] || 0) > 0) score = 30;
            l._score = score;
            return l;
        }).sort(function(a, b) {
            return b._score - a._score;
        });
        
        document.getElementById('prioCount').textContent = prioLeads.length;
        
        if (prioLeads.length === 0) {
            prioList.innerHTML = '<div class="prio-empty">No priority leads yet. Import some leads to get started!</div>';
            return;
        }
        
        prioList.innerHTML = prioLeads.map(function(lead, index) {
            var f = lead.fields;
            var name = f['Full Name'] || (f['First Name'] || '') + ' ' + (f['Last Name'] || '');
            var phone = f['Phone'] || '-';
            var disposition = f['Disposition'] || 'New';
            var lastCall = f['Last Call Timestamp'] ? formatTimeAgo(f['Last Call Timestamp']) : 'Not called';
            
            return '<div class="prio-card" data-id="' + lead.id + '">' +
                '<div class="prio-rank">' + (index + 1) + '</div>' +
                '<div class="prio-info">' +
                    '<div class="prio-name">' + escapeHtml(name.trim()) + '</div>' +
                    '<div class="prio-details">' + escapeHtml(phone) + ' ‚Ä¢ ' + escapeHtml(disposition) + ' ‚Ä¢ ' + lastCall + '</div>' +
                '</div>' +
                '<div class="prio-score">' +
                    '<div class="prio-score-value">' + lead._score + '</div>' +
                    '<div class="prio-score-label">Score</div>' +
                '</div>' +
            '</div>';
        }).join('');
    }

    // Helpers
    function escapeHtml(text) {
        if (!text) return '';
        var div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function formatTimeAgo(dateStr) {
        if (!dateStr) return '';
        var date = new Date(dateStr);
        var now = new Date();
        var diff = Math.floor((now - date) / 1000);
        
        if (diff < 60) return 'Just now';
        if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
        if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
        if (diff < 604800) return Math.floor(diff / 86400) + 'd ago';
        return date.toLocaleDateString();
    }

    // Init
    checkAuth().then(function() {
        if (currentUser) {
            loadUserData();
        }
    });
    
    // Handle hash
    var hash = window.location.hash.slice(1);
    if (hash && document.getElementById('page-' + hash)) {
        switchPage(hash);
    }
    </script>
</body>
</html>
